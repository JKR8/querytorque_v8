    "source": {
      "type": "object",
      "description": "Source discriminator for different input types",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["4w_worker", "plan_scanner", "expert_session"],
          "description": "Type of optimization source"
        },
        "scanner_config": {
          "type": "object",
          "description": "Scanner configuration if source type is plan_scanner",
          "additionalProperties": {
            "type": "string"
          }
        }
      }
    }{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://querytorque.io/schemas/blackboard_entry.json",
  "title": "Optimization Outcome",
  "description": "Raw optimization outcome captured from Product Pipeline Phase 7. Note: This is distinct from ScannerObservation (PostgreSQL plan-space observations)."}]}}]
  "type": "object",
  "required": ["schema_version", "base", "opt", "outcome"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "2.0"
    },
    "base": {
      "type": "object",
      "description": "Identity and context",
      "required": ["query_id", "dialect", "timestamp", "run_id"],
      "properties": {
        "query_id": {
          "type": "string",
          "pattern": "^q[0-9]{1,3}[a-z]?$",
          "description": "Normalized query identifier (e.g., q88, q23a)"
        },
        "dialect": {
          "type": "string",
          "enum": ["duckdb", "postgresql"],
          "description": "SQL dialect/engine used"
        },
        "fingerprint": {
          "type": "string",
          "description": "Structural fingerprint of the SQL pattern"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of the optimization attempt"
        },
        "run_id": {
          "type": "string",
          "description": "Identifier for the batch/run"
        }
      }
    },
    "opt": {
      "type": "object",
      "description": "Optimization context",
      "required": ["worker_id", "strategy", "iteration"],
      "properties": {
        "worker_id": {
          "type": "integer",
          "minimum": 1,
          "description": "Worker that produced this outcome"
        },
        "strategy": {
          "type": "string",
          "description": "Optimization strategy assigned to this worker"
        },
        "examples_used": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Gold examples provided to the worker"
        },
        "iteration": {
          "type": "integer",
          "minimum": 0,
          "description": "0=initial, 1=snipe, 2=final"
        }
      }
    },
    "outcome": {
      "type": "object",
      "description": "Measured results",
      "required": ["status", "speedup", "validation_confidence"],
      "properties": {
        "status": {
          "type": "string",
          "enum": ["WIN", "IMPROVED", "NEUTRAL", "REGRESSION", "ERROR", "FAIL"],
          "description": "Categorized optimization outcome"
        },
        "speedup": {
          "type": "number",
          "minimum": 0,
          "description": "Speedup ratio (optimized_time / original_time)"
        },
        "speedup_type": {
          "type": "string",
          "enum": ["measured", "vs_timeout_ceiling", "both_timeout"],
          "description": "Type of speedup measurement"
        },
        "validation_confidence": {
          "type": "string",
          "enum": ["high", "row_count_only", "zero_row_unverified"],
          "description": "Confidence level in validation"
        },
        "original_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Original query execution time in milliseconds"
        },
        "optimized_ms": {
          "type": "number",
          "minimum": 0,
          "description": "Optimized query execution time in milliseconds"
        }
      }
    },
    "transforms": {
      "type": "object",
      "description": "Transformations applied",
      "properties": {
        "primary": {
          "type": "string",
          "description": "Primary transform that achieved the speedup"
        },
        "all": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "decorrelate",
              "early_filter",
              "pushdown",
              "date_cte_isolate",
              "dimension_cte_isolate",
              "prefetch_fact_join",
              "multi_dimension_prefetch",
              "multi_date_range_cte",
              "single_pass_aggregation",
              "or_to_union",
              "intersect_to_exists",
              "materialize_cte",
              "union_cte_split"
            ]
          },
          "description": "All transforms detected in the rewrite"
        }
      }
    },
    "principles": {
      "type": "object",
      "description": "Knowledge extraction (populated by Layer 2)",
      "properties": {
        "what_worked": {
          "type": "string",
          "maxLength": 500,
          "description": "Human-readable description of what worked"
        },
        "why_it_worked": {
          "type": "string",
          "maxLength": 500,
          "description": "Explanation of the mechanism"
        },
        "principle_id": {
          "type": "string",
          "description": "Reference to engine gap or pattern"
        }
      }
    },
    "config": {
      "type": "object",
      "description": "Engine-specific configuration (PG only)",
      "properties": {
        "set_local": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "SET LOCAL configuration parameters"
        },
        "plan_flags": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Planner flags (e.g., enable_nestloop=off)"
        }
      }
    },
    "error": {
      "type": "object",
      "description": "Error information (if failed)",
      "properties": {
        "category": {
          "type": ["string", "null"],
          "enum": ["syntax", "semantic", "timeout", "execution", null],
          "description": "Categorized error type"
        },
        "messages": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Error messages"
        }
      }
    },
    "reasons": {
      "type": "object",
      "description": "Reasoning trace",
      "properties": {
        "reasoning_chain": {
          "type": "string",
          "description": "Worker response text"
        },
        "evidence": {
          "type": "string",
          "description": "Supporting evidence (e.g., EXPLAIN output)"
        }
      }
    },
    "provenance": {
      "type": "object",
      "description": "Metadata about how this was generated",
      "properties": {
        "model": {
          "type": "string",
          "description": "LLM model used"
        },
        "provider": {
          "type": "string",
          "description": "LLM provider"
        },
        "git_sha": {
          "type": "string",
          "description": "Git commit SHA"
        },
        "reviewed": {
          "type": "boolean",
          "description": "Whether this entry has been human-reviewed"
        }
      }
    }
  }
}
