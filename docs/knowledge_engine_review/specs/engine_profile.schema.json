{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://querytorque.io/schemas/engine_profile.json",
  "title": "Engine Profile",
  "description": "Curated knowledge about optimizer strengths, gaps, and tuning for a specific engine",
  "type": "object",
  "required": ["schema_version", "engine", "version_tested", "strengths", "gaps"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "2.0"
    },
    "engine": {
      "type": "string",
      "enum": ["duckdb", "postgresql"],
      "description": "Database engine"
    },
    "version_tested": {
      "type": "string",
      "description": "Version(s) where this profile was validated"
    },
    "profile_type": {
      "type": "string",
      "const": "engine_profile"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "When this profile was last updated"
    },
    "briefing_note": {
      "type": "string",
      "description": "High-level guidance for analysts"
    },
    "strengths": {
      "type": "array",
      "description": "Optimizer capabilities - do NOT fight these",
      "items": {
        "type": "object",
        "required": ["id", "summary", "field_note"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[A-Z_]+$",
            "description": "Unique identifier for this strength"
          },
          "summary": {
            "type": "string",
            "description": "Brief description of the optimizer capability"
          },
          "field_note": {
            "type": "string",
            "description": "Practical guidance for analysts"
          },
          "source_patterns": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "References to patterns that validate this strength"
          }
        }
      }
    },
    "gaps": {
      "type": "array",
      "description": "Optimizer weaknesses - opportunities for exploitation",
      "items": {
        "type": "object",
        "required": ["id", "priority", "what", "why", "opportunity"],
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[A-Z_]+$",
            "description": "Unique identifier for this gap"
          },
          "priority": {
            "type": "string",
            "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW"],
            "description": "How important it is to address this gap"
          },
          "what": {
            "type": "string",
            "description": "Description of the optimizer limitation"
          },
          "why": {
            "type": "string",
            "description": "Technical explanation of why this happens"
          },
          "opportunity": {
            "type": "string",
            "description": "How to exploit this gap for performance"
          },
          "what_worked": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Verified wins exploiting this gap"
          },
          "what_didnt_work": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Attempts that failed or regressed"
          },
          "field_notes": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Practical guidance and caveats"
          },
          "source_patterns": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "References to patterns that exploit this gap"
          },
          "source_findings": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "References to findings that support this gap"
          }
        }
      }
    },
    "tuning_intel": {
      "type": "object",
      "description": "Engine-specific tuning guidance",
      "required": ["available"],
      "properties": {
        "available": {
          "type": "boolean",
          "description": "Whether this engine supports runtime tuning"
        },
        "mechanism": {
          "type": ["string", "null"],
          "enum": ["set_local", "pragma", "config", null],
          "description": "How tuning is applied"
        },
        "briefing_note": {
          "type": "string",
          "description": "Overview of tuning approach"
        },
        "rules": {
          "type": "array",
          "description": "Specific tuning rules",
          "items": {
            "type": "object",
            "required": ["id", "trigger", "config", "evidence"],
            "properties": {
              "id": {
                "type": "string",
                "description": "Rule identifier"
              },
              "trigger": {
                "type": "string",
                "description": "When to apply this tuning"
              },
              "config": {
                "type": "string",
                "description": "Configuration to apply"
              },
              "evidence": {
                "type": "string",
                "description": "Supporting evidence"
              },
              "risk": {
                "type": "string",
                "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
                "description": "Risk level of applying this tuning"
              }
            }
          }
        },
        "key_findings": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Summary findings from tuning experiments"
        }
      }
    },
    "scale_sensitivity_warning": {
      "type": "string",
      "description": "Warnings about scale-dependent behavior"
    },
    "metadata": {
      "type": "object",
      "description": "Version and provenance",
      "properties": {
        "version": {
          "type": "string",
          "description": "Profile version"
        },
        "source_runs": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Runs that contributed to this profile"
        },
        "auto_generated": {
          "type": "boolean",
          "description": "Whether this was auto-generated from findings"
        },
        "human_reviewed": {
          "type": "boolean",
          "description": "Whether this has been human-reviewed"
        }
      }
    }
  }
}
