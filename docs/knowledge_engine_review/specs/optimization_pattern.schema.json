{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://querytorque.io/schemas/optimization_pattern.json",
  "title": "Optimization Pattern",
  "description": "Distilled pattern extracted from multiple findings",
  "type": "object",
  "required": ["schema_version", "id", "name", "classification", "technique", "stats", "status"],
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "2.0"
    },
    "id": {
      "type": "string",
      "pattern": "^PATTERN-[A-Z]+-[0-9]+$",
      "description": "Unique pattern identifier (e.g., PATTERN-DATE-CTE-001)"
    },
    "name": {
      "type": "string",
      "description": "Human-readable pattern name"
    },
    "classification": {
      "type": "object",
      "description": "Multi-dimensional classification",
      "required": ["mechanism", "impact_tier", "risk", "exploit_type"],
      "properties": {
        "mechanism": {
          "type": "string",
          "enum": [
            "predicate_pushdown",
            "join_reorder",
            "scan_consolidation",
            "decorrelation",
            "materialization",
            "set_operation_rewrite",
            "aggregation_rewrite",
            "subquery_flattening"
          ],
          "description": "Core optimization mechanism"
        },
        "impact_tier": {
          "type": "string",
          "enum": ["low", "medium", "high", "breakthrough"],
          "description": "Typical magnitude of improvement"
        },
        "pattern": {
          "type": "string",
          "enum": [
            "star_schema_prefetch",
            "dimension_isolation",
            "fact_table_consolidation",
            "temporal_join_rewrite",
            "correlated_subquery_elimination",
            "union_decomposition",
            "cte_materialization"
          ],
          "description": "Structural pattern category"
        },
        "risk": {
          "type": "string",
          "enum": ["safe", "moderate", "aggressive", "exploratory"],
          "description": "Risk of regression"
        },
        "exploit_type": {
          "type": "string",
          "enum": [
            "gap_exploit",
            "strength_avoid",
            "neutral_rewrite"
          ],
          "description": "How this optimization relates to engine behavior"
        }
      }
    },
    "technique": {
      "type": "object",
      "description": "The optimization technique",
      "required": ["description"],
      "properties": {
        "description": {
          "type": "string",
          "description": "What this pattern does"
        },
        "sql_template": {
          "type": "string",
          "description": "Generic SQL template showing the pattern"
        },
        "before_example": {
          "type": "string",
          "description": "Example SQL before applying the pattern"
        },
        "after_example": {
          "type": "string",
          "description": "Example SQL after applying the pattern"
        }
      }
    },
    "stats": {
      "type": "object",
      "description": "Effectiveness statistics",
      "required": ["n_observations", "n_wins", "success_rate"],
      "properties": {
        "n_observations": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of observations"
        },
        "n_wins": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of successful applications"
        },
        "success_rate": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Win rate (0.0 to 1.0)"
        },
        "avg_speedup": {
          "type": "number",
          "minimum": 0,
          "description": "Average speedup across wins"
        },
        "speedup_range": {
          "type": "array",
          "minItems": 2,
          "maxItems": 2,
          "items": {
            "type": "number",
            "minimum": 0
          },
          "description": "[min, max] speedup observed"
        },
        "n_queries": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of distinct queries where observed"
        }
      }
    },
    "applicability": {
      "type": "object",
      "description": "When this pattern applies",
      "properties": {
        "query_archetypes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Query types where this applies"
        },
        "required_features": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "SQL features that must be present"
        },
        "sql_patterns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Regex/sqlglot patterns to detect applicability"
        },
        "engines": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["duckdb", "postgresql"]
          },
          "description": "Engines where this pattern is valid"
        }
      }
    },
    "counter_indications": {
      "type": "array",
      "description": "When NOT to apply this pattern",
      "items": {
        "type": "object",
        "required": ["pattern", "reason"],
        "properties": {
          "pattern": {
            "type": "string",
            "description": "Anti-pattern or condition"
          },
          "reason": {
            "type": "string",
            "description": "Why this pattern shouldn't be used"
          },
          "observed_regression": {
            "type": "number",
            "minimum": 0,
            "description": "Typical regression factor when misapplied"
          },
          "example_queries": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Queries that regressed from misapplication"
          }
        }
      }
    },
    "related_patterns": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Related patterns that may be combined"
    },
    "contradictory_patterns": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Patterns that should not be combined"
    },
    "source_findings": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Findings that contributed to this pattern"
    },
    "example_queries": {
      "type": "object",
      "description": "Query examples",
      "properties": {
        "positive": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Queries where this pattern worked"
        },
        "negative": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Queries where this pattern failed"
        }
      }
    },
    "mechanism": {
      "type": "string",
      "description": "Technical explanation of why this works"
    },
    "last_validated": {
      "type": "string",
      "format": "date",
      "description": "When this pattern was last validated"
    },
    "status": {
      "type": "string",
      "enum": ["candidate", "promoted", "deprecated"],
      "description": "Current status in the promotion lifecycle"
    },
    "version": {
      "type": "integer",
      "minimum": 1,
      "description": "Pattern version (incremented on updates)"
    }
  }
}
