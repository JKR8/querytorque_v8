{
  "id": "DECORRELATE_MUST_FILTER_FIRST",
  "severity": "MEDIUM",
  "description": "When decorrelating a subquery into a JOIN, the replacement JOIN must include a selective filter. A decorrelation that produces an unfiltered cross-product is worse than the original correlated subquery.",
  "observed_failures": [
    {
      "query": "multiple",
      "problem": "Correlated subquery was converted to JOIN without carrying over the original WHERE filters, producing a much larger intermediate result than the correlated version.",
      "type": "UNFILTERED_DECORRELATION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "DECORRELATE_PRESERVES_FILTERS",
      "description": "When converting a correlated subquery to a JOIN + GROUP BY CTE, all WHERE conditions from the original subquery must be preserved in the CTE or JOIN condition. The replacement must not produce more rows than the original correlated subquery."
    }
  ],
  "prompt_instruction": "When decorrelating a correlated subquery into a JOIN, ensure all original WHERE filters are preserved in the replacement CTE or JOIN condition. A decorrelation without selective filters creates a cross-product that is larger than the original per-row correlated execution. The replacement CTE must filter to at most the same cardinality as the original subquery."
}
