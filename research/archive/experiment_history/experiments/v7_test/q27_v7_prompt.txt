Optimize this SQL query for performance.

## Algorithm

1. **FIND BOTTLENECK**: Look at the largest row sources below
2. **REDUCE EARLY**: For each bottleneck, ask "can we filter this earlier?"
   - Push dimension filters INTO CTEs/subqueries before GROUP BY
   - Convert correlated subqueries to window functions or CTEs
   - Join small filtered tables early to reduce rows before aggregation
3. **VERIFY**: Result must return identical data

Principle: The earlier you reduce rows, the faster everything downstream runs.

## Example

WRONG - filters 1M rows AFTER aggregating all 100M:
```sql
WITH sales_agg AS (
    SELECT store_id, SUM(amount) as total
    FROM sales
    GROUP BY store_id  -- aggregates ALL 100M rows
)
SELECT * FROM sales_agg
WHERE store_id IN (SELECT store_id FROM stores WHERE region = 'West')  -- filters AFTER
```

RIGHT - filters to 1M rows BEFORE aggregating:
```sql
WITH sales_agg AS (
    SELECT s.store_id, SUM(amount) as total
    FROM sales
    JOIN stores s ON sales.store_id = s.store_id
    WHERE s.region = 'West'  -- filter BEFORE GROUP BY
    GROUP BY s.store_id  -- aggregates only 1M West rows
)
SELECT * FROM sales_agg
```

The RIGHT version is 100x faster because it aggregates 100x fewer rows.

## Bottlenecks

- SEQ_SCAN (store_sales): 83.9% cost, 550,426 rows <-- BOTTLENECK
- SEQ_SCAN (customer_demographics): 6.9% cost, 27,440 rows
- HASH_JOIN: 4.3% cost, 7,682 rows

## Table Scans (with selectivity)

- store_sales: 550,426 rows (NO FILTER) <-- BOTTLENECK
- customer_demographics: 1.9M -> 27,440 rows (FILTERED by cd_gender='F', cd_marital_status='D', cd_education_status='Secondary') <-- HIGH SELECTIVITY, JOIN EARLY
- date_dim: 73K -> 365 rows (FILTERED by d_year=1999)
- store: 402 rows (FILTERED by s_state IN 6 states)
- item: 204K rows (dynamic filter)

## SQL

```sql
select i_item_id,
        s_state, grouping(s_state) g_state,
        avg(ss_quantity) agg1,
        avg(ss_list_price) agg2,
        avg(ss_coupon_amt) agg3,
        avg(ss_sales_price) agg4
 from store_sales, customer_demographics, date_dim, store, item
 where ss_sold_date_sk = d_date_sk and
       ss_item_sk = i_item_sk and
       ss_store_sk = s_store_sk and
       ss_cdemo_sk = cd_demo_sk and
       cd_gender = 'F' and
       cd_marital_status = 'D' and
       cd_education_status = 'Secondary' and
       d_year = 1999 and
       s_state in ('MO','AL', 'MI', 'TN', 'LA', 'SC')
 group by rollup (i_item_id, s_state)
 order by i_item_id
         ,s_state
 LIMIT 100;
```

## Output

Return:
1. The optimized SQL query
2. One sentence explaining what you changed and why
