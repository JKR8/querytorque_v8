## query_dag
Nodes:
  [subquery_1] type=subquery tables=['store_sales']
  [subquery_2] type=subquery tables=['store_sales']
  [subquery_3] type=subquery tables=['store_sales']
  [subquery_4] type=subquery tables=['store_sales']
  [subquery_5] type=subquery tables=['store_sales']
  [subquery_6] type=subquery tables=['store_sales']
  [subquery_7] type=subquery tables=['store_sales']
  [subquery_8] type=subquery tables=['store_sales']
  [subquery_9] type=subquery tables=['store_sales']
  [subquery_10] type=subquery tables=['store_sales']
  [subquery_11] type=subquery tables=['store_sales']
  [subquery_12] type=subquery tables=['store_sales']
  [subquery_13] type=subquery tables=['store_sales']
  [subquery_14] type=subquery tables=['store_sales']
  [subquery_15] type=subquery tables=['store_sales']
  [main_query] type=main_query tables=['reason']

Edges:

## node_sql
### subquery_1
```sql
SELECT
  COUNT(*)
FROM store_sales
WHERE
  ss_quantity BETWEEN 1 AND 20
```

### subquery_2
```sql
SELECT
  AVG(ss_ext_sales_price)
FROM store_sales
WHERE
  ss_quantity BETWEEN 1 AND 20
```

### subquery_3
```sql
SELECT
  AVG(ss_net_profit)
FROM store_sales
WHERE
  ss_quantity BETWEEN 1 AND 20
```

### subquery_4
```sql
SELECT
  COUNT(*)
FROM store_sales
WHERE
  ss_quantity BETWEEN 21 AND 40
```

### subquery_5
```sql
SELECT
  AVG(ss_ext_sales_price)
FROM store_sales
WHERE
  ss_quantity BETWEEN 21 AND 40
```

### subquery_6
```sql
SELECT
  AVG(ss_net_profit)
FROM store_sales
WHERE
  ss_quantity BETWEEN 21 AND 40
```

### subquery_7
```sql
SELECT
  COUNT(*)
FROM store_sales
WHERE
  ss_quantity BETWEEN 41 AND 60
```

### subquery_8
```sql
SELECT
  AVG(ss_ext_sales_price)
FROM store_sales
WHERE
  ss_quantity BETWEEN 41 AND 60
```

### subquery_9
```sql
SELECT
  AVG(ss_net_profit)
FROM store_sales
WHERE
  ss_quantity BETWEEN 41 AND 60
```

### subquery_10
```sql
SELECT
  COUNT(*)
FROM store_sales
WHERE
  ss_quantity BETWEEN 61 AND 80
```

### subquery_11
```sql
SELECT
  AVG(ss_ext_sales_price)
FROM store_sales
WHERE
  ss_quantity BETWEEN 61 AND 80
```

### subquery_12
```sql
SELECT
  AVG(ss_net_profit)
FROM store_sales
WHERE
  ss_quantity BETWEEN 61 AND 80
```

### subquery_13
```sql
SELECT
  COUNT(*)
FROM store_sales
WHERE
  ss_quantity BETWEEN 81 AND 100
```

### subquery_14
```sql
SELECT
  AVG(ss_ext_sales_price)
FROM store_sales
WHERE
  ss_quantity BETWEEN 81 AND 100
```

### subquery_15
```sql
SELECT
  AVG(ss_net_profit)
FROM store_sales
WHERE
  ss_quantity BETWEEN 81 AND 100
```

### main_query
```sql
/* start query 9 in stream 0 using template query9.tpl */
SELECT
  CASE
    WHEN (
      SELECT
        COUNT(*)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 1 AND 20
    ) > 2972190
    THEN (
      SELECT
        AVG(ss_ext_sales_price)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 1 AND 20
    )
    ELSE (
      SELECT
        AVG(ss_net_profit)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 1 AND 20
    )
  END AS bucket1,
  CASE
    WHEN (
      SELECT
        COUNT(*)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 21 AND 40
    ) > 4505785
    THEN (
      SELECT
        AVG(ss_ext_sales_price)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 21 AND 40
    )
    ELSE (
      SELECT
        AVG(ss_net_profit)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 21 AND 40
    )
  END AS bucket2,
  CASE
    WHEN (
      SELECT
        COUNT(*)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 41 AND 60
    ) > 1575726
    THEN (
      SELECT
        AVG(ss_ext_sales_price)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 41 AND 60
    )
    ELSE (
      SELECT
        AVG(ss_net_profit)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 41 AND 60
    )
  END AS bucket3,
  CASE
    WHEN (
      SELECT
        COUNT(*)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 61 AND 80
    ) > 3188917
    THEN (
      SELECT
        AVG(ss_ext_sales_price)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 61 AND 80
    )
    ELSE (
      SELECT
        AVG(ss_net_profit)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 61 AND 80
    )
  END AS bucket4,
  CASE
    WHEN (
      SELECT
        COUNT(*)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 81 AND 100
    ) > 3525216
    THEN (
      SELECT
        AVG(ss_ext_sales_price)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 81 AND 100
    )
    ELSE (
      SELECT
        AVG(ss_net_profit)
      FROM store_sales
      WHERE
        ss_quantity BETWEEN 81 AND 100
    )
  END AS bucket5
FROM reason
WHERE
  r_reason_sk = 1
```

## execution_plan
Operators by cost:
- SEQ_SCAN(store_sales): 26.0% cost, 549,054 rows
- SEQ_SCAN(store_sales): 25.3% cost, 550,248 rows
- SEQ_SCAN(store_sales): 15.4% cost, 549,318 rows
- SEQ_SCAN(store_sales): 3.2% cost, 550,248 rows
- SEQ_SCAN(store_sales): 2.5% cost, 549,318 rows

Scans:
- store_sales x15: 34,537,284 → 550,408 rows (filtered)
- reason x1: 55 → 1 rows (filtered)

## optimization_hints
## Detected Optimization Opportunities

1. **QT-OPT-007** - Materialize Repeated Subquery
  Trigger: Same subquery pattern appears multiple times in query
  Rewrite: Extract to CTE with MATERIALIZED hint, reference by name
   Matched: Repeated subquery pattern

