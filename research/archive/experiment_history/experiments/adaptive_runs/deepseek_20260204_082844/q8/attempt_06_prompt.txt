## Example: Date CTE Isolation (DATE_CTE_ISOLATE)
Verified speedup: 1.5-2.5x

### Input:
[main_query]:
SELECT a.ca_state state, count(*) cnt
FROM customer_address a, customer c, store_sales s, date_dim d, item i
WHERE a.ca_address_sk = c.c_current_addr_sk
  AND c.c_customer_sk = s.ss_customer_sk
  AND s.ss_sold_date_sk = d.d_date_sk
  AND s.ss_item_sk = i.i_item_sk
  AND d.d_month_seq = (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2000 AND d_moy = 1)
  AND i.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM item j WHERE j.i_category = i.i_category)
GROUP BY a.ca_state HAVING count(*) >= 10
ORDER BY cnt, a.ca_state LIMIT 100

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "target_month": "SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2000 AND d_moy = 1",
        "category_avg_price": "SELECT i_category, AVG(i_current_price) * 1.2 AS avg_threshold FROM item GROUP BY i_category",
        "filtered_dates": "SELECT d_date_sk FROM date_dim JOIN target_month ON d_month_seq = target_month.d_month_seq",
        "filtered_sales": "SELECT ss_customer_sk, ss_item_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk",
        "main_query": "SELECT a.ca_state AS state, COUNT(*) AS cnt FROM customer_address a JOIN customer c ON a.ca_address_sk = c.c_current_addr_sk JOIN filtered_sales s ON c.c_customer_sk = s.ss_customer_sk JOIN item i ON s.ss_item_sk = i.i_item_sk JOIN category_avg_price cap ON i.i_category = cap.i_category WHERE i.i_current_price > cap.avg_threshold GROUP BY a.ca_state HAVING COUNT(*) >= 10 ORDER BY cnt, a.ca_state LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same grouping and aggregation"
      ],
      "expected_speedup": "2.0x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Extract date month_seq subquery into CTE. Extract category average into separate CTE with GROUP BY. Join instead of correlated subquery. This allows each CTE to be scanned once.


---

## Example: OR to UNION ALL (OR_TO_UNION)
Verified speedup: 2.98x

### Input:
[main_query]:
SELECT ca_zip, sum(cs_sales_price)
FROM catalog_sales, customer, customer_address, date_dim
WHERE cs_bill_customer_sk = c_customer_sk
  AND c_current_addr_sk = ca_address_sk
  AND (substr(ca_zip,1,5) IN ('85669', '86197', ...)
       OR ca_state IN ('CA','WA','GA')
       OR cs_sales_price > 500)
  AND cs_sold_date_sk = d_date_sk
  AND d_qoy = 1 AND d_year = 2001
GROUP BY ca_zip ORDER BY ca_zip LIMIT 100

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001",
        "filtered_sales": "SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE substr(ca_zip,1,5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('CA','WA','GA') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE cs_sales_price > 500",
        "main_query": "SELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same rows after aggregation"
      ],
      "expected_speedup": "2.98x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Each OR branch becomes a separate query with focused predicates. Date filter is extracted as CTE and joined into each branch.


---

## Example: Filter Pushdown (PUSHDOWN)
Verified speedup: 2.44x

### Input:
[inv]:
SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, cov
FROM (SELECT ... FROM inventory JOIN date_dim WHERE d_year = 1998 GROUP BY ...) foo
WHERE stdev/mean > 1

[main_query]:
SELECT ... FROM inv inv1, inv inv2
WHERE inv1.d_moy = 1 AND inv2.d_moy = 2 ...

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "pushdown",
      "nodes": {
        "inv": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 1998 AND d_moy IN (1, 2) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) foo WHERE mean != 0 AND stdev/mean > 1"
      },
      "invariants_kept": [
        "inv output columns unchanged",
        "main_query unmodified"
      ],
      "expected_speedup": "2.44x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Push d_moy IN (1, 2) from outer query into the CTE's WHERE clause. This filters inventory rows BEFORE aggregation.


---

You are a SQL optimizer. Output atomic rewrite sets in JSON.

RULES:
- Only use transforms from the allowlist
- Preserve node contracts (output columns, grain, predicates)
- Coordinate multi-node changes in rewrite_sets
- No formatting-only changes
- No column renames unless required

ALLOWED TRANSFORMS: pushdown, decorrelate, or_to_union, in_to_exists, projection_prune, early_filter, semantic_rewrite

OUTPUT FORMAT:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "transform_name",
      "nodes": {
        "node_id": "new SQL..."
      },
      "invariants_kept": ["list of preserved semantics"],
      "expected_speedup": "2x",
      "risk": "low"
    }
  ],
  "explanation": "what was changed and why"
}
```

## Target Nodes
  [filtered_dates] 
  [zip_candidates] 

## Subgraph Slice
[filtered_dates] type=cte
```sql
SELECT d_date_sk FROM date_dim WHERE d_qoy = 2 AND d_year = 1998
```

[filtered_sales] type=cte
```sql
SELECT ss_store_sk, ss_net_profit FROM store_sales AS ss JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk
```

[main_query] type=main
```sql
WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 2 AND d_year = 1998), zip_candidates AS (SELECT DISTINCT SUBSTRING(ca_zip, 1, 5) AS ca_zip FROM customer_address WHERE SUBSTRING(ca_zip, 1, 5) IN ('47602', '16704', '35863', '28577', '83910', '36201', '58412', '48162', '28055', '41419', '80332', '38607', '77817', '24891', '16226', '18410', '21231', '59345', '13918', '51089', '20317', '17167', '54585', '67881', '78366', '47770', '18360', '51717', '73108', '14440', '21800', '89338', '45859', '65501', '34948', '25973', '73219', '25333', '17291', '10374', '18829', '60736', '82620', '41351', '52094', '19326', '25214', '54207', '40936', '21814', '79077', '25178', '75742', '77454', '30621', '89193', '27369', '41232', '48567', '83041', '71948', '37119', '68341', '14073', '16891', '62878', '49130', '19833', '24286', '27700', '40979', '50412', '81504', '94835', '84844', '71954', '39503', '57649', '18434', '24987', '12350', '86379', '27413', '44529', '98569', '16515', '27287', '24255', '21094', '16005', '56436', '91110', '68293', '56455', '54558', '10298', '83647', '32754', '27052', '51766', '19444', '13869', '45645', '94791', '57631', '20712', '37788', '41807', '46507', '21727', '71836', '81070', '50632', '88086', '63991', '20244', '31655', '51782', '29818', '63792', '68605', '94898', '36430', '57025', '20601', '82080', '33869', '22728', '35834', '29086', '92645', '98584', '98072', '11652', '78093', '57553', '43830', '71144', '53565', '18700', '90209', '71256', '38353', '54364', '28571', '96560', '57839', '56355', '50679', '45266', '84680', '34306', '34972', '48530', '30106', '15371', '92380', '84247', '92292', '68852', '13338', '34594', '82602', '70073', '98069', '85066', '47289', '11686', '98862', '26217', '47529', '63294', '51793', '35926', '24227', '14196', '24594', '32489', '99060', '49472', '43432', '49211', '14312', '88137', '47369', '56877', '20534', '81755', '15794', '12318', '21060', '73134', '41255', '63073', '81003', '73873', '66057', '51184', '51195', '45676', '92696', '70450', '90669', '98338', '25264', '38919', '59226', '58581', '60298', '17895', '19489', '52301', '80846', '95464', '68770', '51634', '19988', '18367', '18421', '11618', '67975', '25494', '41352', '95430', '15734', '62585', '97173', '33773', '10425', '75675', '53535', '17879', '41967', '12197', '67998', '79658', '59130', '72592', '14851', '43933', '68101', '50636', '25717', '71286', '24660', '58058', '72991', '95042', '15543', '33122', '69280', '11912', '59386', '27642', '65177', '17672', '33467', '64592', '36335', '54010', '18767', '63193', '42361', '49254', '33113', '33159', '36479', '59080', '11855', '81963', '31016', '49140', '29392', '41836', '32958', '53163', '13844', '73146', '23952', '65148', '93498', '14530', '46131', '58454', '13376', '13378', '83986', '12320', '17193', '59852', '46081', '98533', '52389', '13086', '68843', '31013', '13261', '60560', '13443', '45533', '83583', '11489', '58218', '19753', '22911', '25115', '86709', '27156', '32669', '13123', '51933', '39214', '41331', '66943', '14155', '69998', '49101', '70070', '35076', '14242', '73021', '59494', '15782', '29752', '37914', '74686', '83086', '34473', '15751', '81084', '49230', '91894', '60624', '17819', '28810', '63180', '56224', '39459', '55233', '75752', '43639', '55349', '86057', '62361', '50788', '31830', '58062', '18218', '85761', '60083', '45484', '21204', '90229', '70041', '41162', '35390', '16364', '39500', '68908', '26689', '52868', '81335', '40146', '11340', '61527', '61794', '71997', '30415', '59004', '29450', '58117', '69952', '33562', '83833', '27385', '61860', '96435', '48333', '23065', '32961', '84919', '61997', '99132', '22815', '56600', '68730', '48017', '95694', '32919', '88217', '27116', '28239', '58032', '18884', '16791', '21343', '97462', '18569', '75660', '15475')), preferred_customer_zips AS (SELECT SUBSTRING(ca_zip, 1, 5) AS ca_zip FROM customer_address AS ca JOIN customer AS c ON ca.ca_address_sk = c.c_current_addr_sk WHERE c.c_preferred_cust_flag = 'Y' GROUP BY SUBSTRING(ca_zip, 1, 5) HAVING COUNT(*) > 10), final_zips AS (SELECT zc.ca_zip FROM zip_candidates AS zc JOIN preferred_customer_zips AS pcz ON zc.ca_zip = pcz.ca_zip), filtered_sales AS (SELECT ss_store_sk, ss_net_profit FROM store_sales AS ss JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk) SELECT s.s_store_name, SUM(fs.ss_net_profit) FROM filtered_sales AS fs JOIN store AS s ON fs.ss_store_sk = s.s_store_sk JOIN final_zips AS fz ON SUBSTRING(s.s_zip, 1, 2) = SUBSTRING(fz.ca_zip, 1, 2) GROUP BY s.s_store_name ORDER BY s.s_store_name LIMIT 100
```

[zip_candidates] type=cte
```sql
SELECT DISTINCT SUBSTRING(ca_zip, 1, 5) AS ca_zip FROM customer_address WHERE SUBSTRING(ca_zip, 1, 5) IN ('47602', '16704', '35863', '28577', '83910', '36201', '58412', '48162', '28055', '41419', '80332', '38607', '77817', '24891', '16226', '18410', '21231', '59345', '13918', '51089', '20317', '17167', '54585', '67881', '78366', '47770', '18360', '51717', '73108', '14440', '21800', '89338', '45859', '65501', '34948', '25973', '73219', '25333', '17291', '10374', '18829', '60736', '82620', '41351', '52094', '19326', '25214', '54207', '40936', '21814', '79077', '25178', '75742', '77454', '30621', '89193', '27369', '41232', '48567', '83041', '71948', '37119', '68341', '14073', '16891', '62878', '49130', '19833', '24286', '27700', '40979', '50412', '81504', '94835', '84844', '71954', '39503', '57649', '18434', '24987', '12350', '86379', '27413', '44529', '98569', '16515', '27287', '24255', '21094', '16005', '56436', '91110', '68293', '56455', '54558', '10298', '83647', '32754', '27052', '51766', '19444', '13869', '45645', '94791', '57631', '20712', '37788', '41807', '46507', '21727', '71836', '81070', '50632', '88086', '63991', '20244', '31655', '51782', '29818', '63792', '68605', '94898', '36430', '57025', '20601', '82080', '33869', '22728', '35834', '29086', '92645', '98584', '98072', '11652', '78093', '57553', '43830', '71144', '53565', '18700', '90209', '71256', '38353', '54364', '28571', '96560', '57839', '56355', '50679', '45266', '84680', '34306', '34972', '48530', '30106', '15371', '92380', '84247', '92292', '68852', '13338', '34594', '82602', '70073', '98069', '85066', '47289', '11686', '98862', '26217', '47529', '63294', '51793', '35926', '24227', '14196', '24594', '32489', '99060', '49472', '43432', '49211', '14312', '88137', '47369', '56877', '20534', '81755', '15794', '12318', '21060', '73134', '41255', '63073', '81003', '73873', '66057', '51184', '51195', '45676', '92696', '70450', '90669', '98338', '25264', '38919', '59226', '58581', '60298', '17895', '19489', '52301', '80846', '95464', '68770', '51634', '19988', '18367', '18421', '11618', '67975', '25494', '41352', '95430', '15734', '62585', '97173', '33773', '10425', '75675', '53535', '17879', '41967', '12197', '67998', '79658', '59130', '72592', '14851', '43933', '68101', '50636', '25717', '71286', '24660', '58058', '72991', '95042', '15543', '33122', '69280', '11912', '59386', '27642', '65177', '17672', '33467', '64592', '36335', '54010', '18767', '63193', '42361', '49254', '33113', '33159', '36479', '59080', '11855', '81963', '31016', '49140', '29392', '41836', '32958', '53163', '13844', '73146', '23952', '65148', '93498', '14530', '46131', '58454', '13376', '13378', '83986', '12320', '17193', '59852', '46081', '98533', '52389', '13086', '68843', '31013', '13261', '60560', '13443', '45533', '83583', '11489', '58218', '19753', '22911', '25115', '86709', '27156', '32669', '13123', '51933', '39214', '41331', '66943', '14155', '69998', '49101', '70070', '35076', '14242', '73021', '59494', '15782', '29752', '37914', '74686', '83086', '34473', '15751', '81084', '49230', '91894', '60624', '17819', '28810', '63180', '56224', '39459', '55233', '75752', '43639', '55349', '86057', '62361', '50788', '31830', '58062', '18218', '85761', '60083', '45484', '21204', '90229', '70041', '41162', '35390', '16364', '39500', '68908', '26689', '52868', '81335', '40146', '11340', '61527', '61794', '71997', '30415', '59004', '29450', '58117', '69952', '33562', '83833', '27385', '61860', '96435', '48333', '23065', '32961', '84919', '61997', '99132', '22815', '56600', '68730', '48017', '95694', '32919', '88217', '27116', '28239', '58032', '18884', '16791', '21343', '97462', '18569', '75660', '15475')
```

[final_zips] type=cte
```sql
SELECT zc.ca_zip FROM zip_candidates AS zc JOIN preferred_customer_zips AS pcz ON zc.ca_zip = pcz.ca_zip
```


## Node Contracts
[filtered_dates]:
  output_columns: ['d_date_sk']
  required_predicates: ['d_qoy = 2', 'd_year = 1998']
[filtered_sales]:
  output_columns: ['ss_store_sk', 'ss_net_profit']
[main_query]:
  output_columns: ['s_store_name', 'SUM(fs.ss_net_profit)']
  grain: ['s_store_name']
  required_predicates: ['d_qoy = 2', 'd_year = 1998']
[zip_candidates]:
  output_columns: ['ca_zip']
[final_zips]:
  output_columns: ['ca_zip']

## Downstream Usage
[filtered_dates]: downstream_refs=['ss_net_profit', 'd_year', 'ss_store_sk', 'ca_zip', 'd_qoy', 'd_date_sk']
[filtered_sales]: downstream_refs=['ss_net_profit', 'd_year', 'ss_store_sk', 'ca_zip', 'd_qoy', 'd_date_sk']
[zip_candidates]: downstream_refs=['ss_net_profit', 'd_year', 'ss_store_sk', 'ca_zip', 'd_qoy', 'd_date_sk']
[final_zips]: downstream_refs=['ss_net_profit', 'd_year', 'ss_store_sk', 'ca_zip', 'd_qoy', 'd_date_sk']

## Cost Attribution
No cost data.

## Detected Opportunities
## Node-Specific Opportunities
PUSHDOWN: [main_query] filters on [preferred_customer_zips] after GROUP BY
  Fix: Push filter into CTE before aggregation
  Expected: 2x speedup (verified Q93: 2.71x)

Now output your rewrite_sets:

## Execution Plan
```
┌───────────────────────────┐
│           TOP_N           │
│    ────────────────────   │
│          Top: 100         │
│                           │
│         Order By:         │
│     s.s_store_name ASC    │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         PROJECTION        │
│    ────────────────────   │
│__internal_decompress_strin│
│           g(#0)           │
│             #1            │
│                           │
│         ~402 rows         │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│       HASH_GROUP_BY       │
│    ────────────────────   │
│         Groups: #0        │
│    Aggregates: sum(#1)    │
│                           │
│         ~402 rows         │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         PROJECTION        │
│    ────────────────────   │
│        s_store_name       │
│       ss_net_profit       │
│                           │
│      ~3,904,191 rows      │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         PROJECTION        │
│    ────────────────────   │
│             #0            │
│__internal_compress_string_│
│        ubigint(#1)        │
│             #2            │
│                           │
│      ~3,904,191 rows      │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│         HASH_JOIN         │
│    ────────────────────   │
│      Join Type: INNER     │
│                           │
│        Conditions:        ├────────────────────────────────────────────────────────────────────────┐
│ "substring"(s_zip, 1, 2) =│                                                                        │
│  "substring"(ca_zip, 1, 2)│                                                                        │
│                           │                                                                        │
│      ~3,904,191 rows      │                                                                        │
└─────────────┬─────────────┘                                                                        │
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         HASH_JOIN         │                                                          │         PROJECTION        │
│    ────────────────────   │                                                          │    ────────────────────   │
│      Join Type: INNER     │                                                          │           ca_zip          │
│                           │                                                          │                           │
│        Conditions:        ├───────────────────────────────────────────┐              │                           │
│  ss_store_sk = s_store_sk │                                           │              │                           │
│                           │                                           │              │                           │
│        ~23,048 rows       │                                           │              │        ~16,770 rows       │
└─────────────┬─────────────┘                                           │              └─────────────┬─────────────┘
┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         PROJECTION        │                             │         SEQ_SCAN          ││         HASH_JOIN         │
│    ────────────────────   │                             │    ────────────────────   ││    ────────────────────   │
│        ss_store_sk        │                             │        Table: store       ││      Join Type: INNER     │
│       ss_net_profit       │                             │   Type: Sequential Scan   ││                           │
│                           │                             │                           ││        Conditions:        │
│                           │                             │        Projections:       ││      ca_zip = ca_zip      │
│                           │                             │         s_store_sk        ││                           │
│                           │                             │           s_zip           ││                           ├──────────────┐
│                           │                             │        s_store_name       ││                           │              │
│                           │                             │                           ││                           │              │
│                           │                             │          Filters:         ││                           │              │
│                           │                             │      s_store_sk<=400      ││                           │              │
│                           │                             │                           ││                           │              │
│        ~23,048 rows       │                             │         ~402 rows         ││        ~16,770 rows       │              │
└─────────────┬─────────────┘                             └───────────────────────────┘└─────────────┬─────────────┘              │
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         HASH_JOIN         │                                                          │       HASH_GROUP_BY       ││         PROJECTION        │
│    ────────────────────   │                                                          │    ────────────────────   ││    ────────────────────   │
│      Join Type: INNER     │                                                          │         Groups: #0        ││             #0            │
│                           │                                                          │                           ││                           │
│        Conditions:        ├──────────────┐                                           │                           ││                           │
│ss_sold_date_sk = d_date_sk│              │                                           │                           ││                           │
│                           │              │                                           │                           ││                           │
│        ~23,048 rows       │              │                                           │       ~200,000 rows       ││        ~76,724 rows       │
└─────────────┬─────────────┘              │                                           └─────────────┬─────────────┘└─────────────┬─────────────┘
┌─────────────┴─────────────┐┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         SEQ_SCAN          ││           FILTER          │                             │         PROJECTION        ││           FILTER          │
│    ────────────────────   ││    ────────────────────   │                             │    ────────────────────   ││    ────────────────────   │
│     Table: store_sales    ││ (d_date_sk BETWEEN 2450816│                             │           ca_zip          ││    (count_star() > 10)    │
│   Type: Sequential Scan   ││        AND 2452642)       │                             │                           ││                           │
│                           ││                           │                             │                           ││                           │
│        Projections:       ││                           │                             │                           ││                           │
│      ss_sold_date_sk      ││                           │                             │                           ││                           │
│        ss_store_sk        ││                           │                             │                           ││                           │
│       ss_net_profit       ││                           │                             │                           ││                           │
│                           ││                           │                             │                           ││                           │
│      ~2,878,107 rows      ││         ~585 rows         │                             │       ~200,000 rows       ││        ~76,724 rows       │
└───────────────────────────┘└─────────────┬─────────────┘                             └─────────────┬─────────────┘└─────────────┬─────────────┘
                             ┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
                             │         SEQ_SCAN          │                             │         PROJECTION        ││       HASH_GROUP_BY       │
                             │    ────────────────────   │                             │    ────────────────────   ││    ────────────────────   │
                             │      Table: date_dim      │                             │           ca_zip          ││         Groups: #0        │
                             │   Type: Sequential Scan   │                             │                           ││                           │
                             │                           │                             │                           ││        Aggregates:        │
                             │        Projections:       │                             │                           ││        count_star()       │
                             │         d_date_sk         │                             │                           ││                           │
                             │                           │                             │                           ││                           │
                             │          Filters:         │                             │                           ││                           │
                             │          d_qoy=2          │                             │                           ││                           │
                             │        d_year=1998        │                             │                           ││                           │
                             │                           │                             │                           ││                           │
                             │         ~585 rows         │                             │       ~200,000 rows       ││       ~383,620 rows       │
                             └───────────────────────────┘                             └─────────────┬─────────────┘└─────────────┬─────────────┘
                                                                                       ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
                                                                                       │         SEQ_SCAN          ││         PROJECTION        │
                                                                                       │    ────────────────────   ││    ────────────────────   │
                                                                                       │           Table:          ││ "substring"(ca_zip, 1, 5) │
                                                                                       │      customer_address     ││                           │
                                                                                       │                           ││                           │
                                                                                       │   Type: Sequential Scan   ││                           │
                                                                                       │    Projections: ca_zip    ││                           │
                                                                                       │                           ││                           │
                                                                                       │          Filters:         ││                           │
                                                                                       │ ("substring"(ca_zip, 1, 5)││                           │
                                                                                       │   IN ('47602', '16704',   ││                           │
                                                                                       │ '35863', '28577', '83910',││                           │
                                                                                       │  '36201', '58412', '48162'││                           │
                                                                                       │ , '28055', '41419', '80332││                           │
                                                                                       │   ', '38607', '77817',    ││                           │
                                                                                       │ '24891', '16226', '18410',││                           │
                                                                                       │  '21231', '59345', '13918'││                           │
                                                                                       │ , '51089', '20317', '17167││                           │
                                                                                       │   ', '54585', '67881',    ││                           │
                                                                                       │ '78366', '47770', '18360',││                           │
                                                                                       │  '51717', '73108', '14440'││                           │
                                                                                       │ , '21800', '89338', '45859││                           │
                                                                                       │   ', '65501', '34948',    ││                           │
                                                                                       │ '25973', '73219', '25333',││                           │
                                                                                       │  '17291', '10374', '18829'││                           │
                                                                                       │ , '60736', '82620', '41351││                           │
                                                                                       │   ', '52094', '19326',    ││                           │
                                                                                       │ '25214', '54207', '40936',││                           │
                                                                                       │  '21814', '79077', '25178'││                           │
                                                                                       │ , '75742', '77454', '30621││                           │
                                                                                       │   ', '89193', '27369',    ││                           │
                                                                                       │ '41232', '48567', '83041',││                           │
                                                                                       │  '71948', '37119', '68341'││                           │
                                                                                       │ , '14073', '16891', '62878││                           │
                                                                                       │   ', '49130', '19833',    ││                           │
                                                                                       │ '24286', '27700', '40979',││                           │
                                                                                       │  '50412', '81504', '94835'││                           │
                                                                                       │ , '84844', '71954', '39503││                           │
                                                                                       │   ', '57649', '18434',    ││                           │
                                                                                       │ '24987', '12350', '86379',││                           │
                                                                                       │  '27413', '44529', '98569'││                           │
                                                                                       │ , '16515', '27287', '24255││                           │
                                                                                       │   ', '21094', '16005',    ││                           │
                                                                                       │ '56436', '91110', '68293',││                           │
                                                                                       │  '56455', '54558', '10298'││                           │
                                                                                       │ , '83647', '32754', '27052││                           │
                                                                                       │   ', '51766', '19444',    ││                           │
                                                                                       │ '13869', '45645', '94791',││                           │
                                                                                       │  '57631', '20712', '37788'││                           │
                                                                                       │ , '41807', '46507', '21727││                           │
                                                                                       │   ', '71836', '81070',    ││                           │
                                                                                       │ '50632', '88086', '63991',││                           │
                                                                                       │  '20244', '31655', '51782'││                           │
                                                                                       │ , '29818', '63792', '68605││                           │
                                                                                       │   ', '94898', '36430',    ││                           │
                                                                                       │ '57025', '20601', '82080',││                           │
                                                                                       │  '33869', '22728', '35834'││                           │
                                                                                       │ , '29086', '92645', '98584││                           │
                                                                                       │   ', '98072', '11652',    ││                           │
                                                                                       │ '78093', '57553', '43830',││                           │
                                                                                       │  '71144', '53565', '18700'││                           │
                                                                                       │ , '90209', '71256', '38353││                           │
                                                                                       │   ', '54364', '28571',    ││                           │
                                                                                       │ '96560', '57839', '56355',││                           │
                                                                                       │  '50679', '45266', '84680'││                           │
                                                                                       │ , '34306', '34972', '48530││                           │
                                                                                       │   ', '30106', '15371',    ││                           │
                                                                                       │ '92380', '84247', '92292',││                           │
                                                                                       │  '68852', '13338', '34594'││                           │
                                                                                       │ , '82602', '70073', '98069││                           │
                                                                                       │   ', '85066', '47289',    ││                           │
                                                                                       │ '11686', '98862', '26217',││                           │
                                                                                       │  '47529', '63294', '51793'││                           │
                                                                                       │ , '35926', '24227', '14196││                           │
                                                                                       │   ', '24594', '32489',    ││                           │
                                                                                       │ '99060', '49472', '43432',││                           │
                                                                                       │  '49211', '14312', '88137'││                           │
                                                                                       │ , '47369', '56877', '20534││                           │
                                                                                       │   ', '81755', '15794',    ││                           │
                                                                                       │ '12318', '21060', '73134',││                           │
                                                                                       │  '41255', '63073', '81003'││                           │
                                                                                       │ , '73873', '66057', '51184││                           │
                                                                                       │   ', '51195', '45676',    ││                           │
                                                                                       │ '92696', '70450', '90669',││                           │
                                                                                       │  '98338', '25264', '38919'││                           │
                                                                                       │ , '59226', '58581', '60298││                           │
                                                                                       │   ', '17895', '19489',    ││                           │
                                                                                       │ '52301', '80846', '95464',││                           │
                                                                                       │  '68770', '51634', '19988'││                           │
                                                                                       │ , '18367', '18421', '11618││                           │
                                                                                       │   ', '67975', '25494',    ││                           │
                                                                                       │ '41352', '95430', '15734',││                           │
                                                                                       │  '62585', '97173', '33773'││                           │
                                                                                       │ , '10425', '75675', '53535││                           │
                                                                                       │   ', '17879', '41967',    ││                           │
                                                                                       │ '12197', '67998', '79658',││                           │
                                                                                       │  '59130', '72592', '14851'││                           │
                                                                                       │ , '43933', '68101', '50636││                           │
                                                                                       │   ', '25717', '71286',    ││                           │
                                                                                       │ '24660', '58058', '72991',││                           │
                                                                                       │  '95042', '15543', '33122'││                           │
                                                                                       │ , '69280', '11912', '59386││                           │
                                                                                       │   ', '27642', '65177',    ││                           │
                                                                                       │ '17672', '33467', '64592',││                           │
                                                                                       │  '36335', '54010', '18767'││                           │
                                                                                       │ , '63193', '42361', '49254││                           │
                                                                                       │   ', '33113', '33159',    ││                           │
                                                                                       │ '36479', '59080', '11855',││                           │
                                                                                       │  '81963', '31016', '49140'││                           │
                                                                                       │ , '29392', '41836', '32958││                           │
                                                                                       │   ', '53163', '13844',    ││                           │
                                                                                       │ '73146', '23952', '65148',││                           │
                                                                                       │  '93498', '14530', '46131'││                           │
                                                                                       │ , '58454', '13376', '13378││                           │
                                                                                       │   ', '83986', '12320',    ││                           │
                                                                                       │ '17193', '59852', '46081',││                           │
                                                                                       │  '98533', '52389', '13086'││                           │
                                                                                       │ , '68843', '31013', '13261││                           │
                                                                                       │   ', '60560', '13443',    ││                           │
                                                                                       │ '45533', '83583', '11489',││                           │
                                                                                       │  '58218', '19753', '22911'││                           │
                                                                                       │ , '25115', '86709', '27156││                           │
                                                                                       │   ', '32669', '13123',    ││                           │
                                                                                       │ '51933', '39214', '41331',││                           │
                                                                                       │  '66943', '14155', '69998'││                           │
                                                                                       │ , '49101', '70070', '35076││                           │
                                                                                       │   ', '14242', '73021',    ││                           │
                                                                                       │ '59494', '15782', '29752',││                           │
                                                                                       │  '37914', '74686', '83086'││                           │
                                                                                       │ , '34473', '15751', '81084││                           │
                                                                                       │   ', '49230', '91894',    ││                           │
                                                                                       │ '60624', '17819', '28810',││                           │
                                                                                       │  '63180', '56224', '39459'││                           │
                                                                                       │ , '55233', '75752', '43639││                           │
                                                                                       │   ', '55349', '86057',    ││                           │
                                                                                       │ '62361', '50788', '31830',││                           │
                                                                                       │  '58062', '18218', '85761'││                           │
                                                                                       │ , '60083', '45484', '21204││                           │
                                                                                       │   ', '90229', '70041',    ││                           │
                                                                                       │ '41162', '35390', '16364',││                           │
                                                                                       │  '39500', '68908', '26689'││                           │
                                                                                       │ , '52868', '81335', '40146││                           │
                                                                                       │   ', '11340', '61527',    ││                           │
                                                                                       │ '61794', '71997', '30415',││                           │
                                                                                       │  '59004', '29450', '58117'││                           │
                                                                                       │ , '69952', '33562', '83833││                           │
                                                                                       │   ', '27385', '61860',    ││                           │
                                                                                       │ '96435', '48333', '23065',││                           │
                                                                                       │  '32961', '84919', '61997'││                           │
                                                                                       │ , '99132', '22815', '56600││                           │
                                                                                       │   ', '68730', '48017',    ││                           │
                                                                                       │ '95694', '32919', '88217',││                           │
                                                                                       │  '27116', '28239', '58032'││                           │
                                                                                       │ , '18884', '16791', '21343││                           │
                                                                                       │   ', '97462', '18569',    ││                           │
                                                                                       │     '75660', '15475'))    ││                           │
                                                                                       │                           ││                           │
                                                                                       │       ~200,000 rows       ││       ~767,241 rows       │
                                                                                       └───────────────────────────┘└─────────────┬─────────────┘
                                                                                                                    ┌─────────────┴─────────────┐
                                                                                                                    │         PROJECTION        │
                                                                                                                    │    ────────────────────   │
                                                                                                                    │             #0            │
                                                                                                                    │__internal_compress_integra│
                                                                                                                    │     l_uinteger(#1, 1)     │
                                                                                                                    │                           │
                                                                                                                    │       ~767,241 rows       │
                                                                                                                    └─────────────┬─────────────┘
                                                                                                                    ┌─────────────┴─────────────┐
                                                                                                                    │         HASH_JOIN         │
                                                                                                                    │    ────────────────────   │
                                                                                                                    │      Join Type: INNER     │
                                                                                                                    │                           │
                                                                                                                    │        Conditions:        ├──────────────┐
                                                                                                                    │      ca_address_sk =      │              │
                                                                                                                    │      c_current_addr_sk    │              │
                                                                                                                    │                           │              │
                                                                                                                    │       ~767,241 rows       │              │
                                                                                                                    └─────────────┬─────────────┘              │
                                                                                                                    ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
                                                                                                                    │         SEQ_SCAN          ││         SEQ_SCAN          │
                                                                                                                    │    ────────────────────   ││    ────────────────────   │
                                                                                                                    │           Table:          ││      Table: customer      │
                                                                                                                    │      customer_address     ││   Type: Sequential Scan   │
                                                                                                                    │                           ││                           │
                                                                                                                    │   Type: Sequential Scan   ││        Projections:       │
                                                                                                                    │                           ││     c_current_addr_sk     │
                                                                                                                    │        Projections:       ││                           │
                                                                                                                    │       ca_address_sk       ││          Filters:         │
                                                                                                                    │           ca_zip          ││ c_preferred_cust_flag='Y' │
                                                                                                                    │                           ││                           │
                                                                                                                    │      ~1,000,000 rows      ││      ~1,000,000 rows      │
                                                                                                                    └───────────────────────────┘└───────────────────────────┘

```


## Previous Attempts (Learn From These!)

### Attempt 1: SUCCESS
Speedup: 1.08x
Strategy: pushdown
Nodes changed: filtered_dates, filtered_stores, filtered_sales, zip_subquery, main_query
Changes: same result rows, same ordering, same column output, same grouping and aggregation

### Attempt 2: SUCCESS
Speedup: 1.13x
Strategy: semantic_rewrite
Nodes changed: filtered_dates, zip_candidates, preferred_customer_zips, final_zips, filtered_sales, main_query
Changes: same result rows, same ordering, same column output, same grouping and aggregation

### Attempt 3: INVALID
Strategy: semantic_rewrite
Nodes changed: filtered_dates, zip_candidates, preferred_customer_zips, final_zips, filtered_sales, main_query
Changes: same result rows, same ordering, same column output, same grouping and aggregation
Error: Expected 10 rows, got 10
Hint: Query missing rows - check for: overly restrictive filters, incorrect JOIN type, missing UNION branches

### Attempt 4: INVALID
Strategy: semantic_rewrite
Nodes changed: filtered_dates, zip_prefixes, filtered_sales, filtered_stores, main_query
Changes: same result rows, same column output, same grouping and aggregation, same ordering
Error: Expected 10 rows, got 10
Hint: Query missing rows - check for: overly restrictive filters, incorrect JOIN type, missing UNION branches

### Attempt 5: SUCCESS
Speedup: 1.01x
Strategy: pushdown
Nodes changed: main_query
Changes: output_columns, grain, required_predicates, join relationships

## Current Best: 1.13x (Attempt 2)
You must BEAT this to improve the result.

**IMPORTANT:** The following patterns were provided: date_cte_isolate, or_to_union, pushdown. Consider a DIFFERENT approach!
