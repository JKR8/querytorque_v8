{
  "timestamp": "20260203_225848",
  "provider": "deepseek",
  "model": "adaptive_rewriter",
  "max_iterations": 5,
  "target_speedup": 2.0,
  "sample_db": "/mnt/d/TPC-DS/tpcds_sf100_sampled_1pct.duckdb",
  "full_db": "/mnt/d/TPC-DS/tpcds_sf100.duckdb",
  "queries": [
    1
  ],
  "total_time_minutes": 1.8272297166666667,
  "passed": 1,
  "failed": 0,
  "errors": 0,
  "no_improvement": 0,
  "avg_speedup": 1.0294336175455887,
  "results": [
    {
      "query": 1,
      "status": "pass",
      "sample_speedup": 1.5387768901614607,
      "full_speedup": 1.0294336175455887,
      "original_ms": 250.40259966772282,
      "optimized_ms": 243.24307599817985,
      "attempts": 5,
      "successful_attempts": 5,
      "elapsed_s": 106.01640629768372,
      "rewrites": {
        "customer_total_return": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk",
        "store_avg_return": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM customer_total_return GROUP BY ctr_store_sk",
        "main_query": "WITH customer_total_return AS ( SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk ), store_avg_return AS ( SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM customer_total_return GROUP BY ctr_store_sk ) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, store_avg_return AS sar WHERE ctr1.ctr_total_return > sar.avg_return AND ctr1.ctr_store_sk = sar.ctr_store_sk AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk ORDER BY c_customer_id LIMIT 100"
      },
      "attempt_history": [
        {
          "num": 1,
          "strategy": "Pre-compute store-level aggregates in a CTE to eliminate correlated subquery, then join directly with filtered results.",
          "changes": [
            "Created store_avg_return CTE",
            "removed correlated subquery",
            "joined pre-computed averages"
          ],
          "nodes_rewritten": [
            "customer_total_return",
            "store_avg_return",
            "main_query"
          ],
          "result": "success",
          "speedup": 1.5387768901614607
        },
        {
          "num": 2,
          "strategy": "Push store filtering and join conditions into the CTE to reduce its size, then pre-compute store-level averages in a separate CTE to eliminate the correlated subquery entirely.",
          "changes": [
            "pushed store filter to CTE",
            "created store_avg_return CTE",
            "removed correlated subquery",
            "joined pre-computed averages"
          ],
          "nodes_rewritten": [
            "customer_total_return",
            "store_avg_return",
            "main_query"
          ],
          "result": "success",
          "speedup": 1.1125327793733388
        },
        {
          "num": 3,
          "strategy": "Filter stores by state early, join with the CTE to get relevant customer keys, then efficiently join with customer table using those keys.",
          "changes": [
            "pushed store state filter to CTE join",
            "restructured main query to join store-CTE before customer",
            "removed redundant conditions"
          ],
          "nodes_rewritten": [
            "main_query"
          ],
          "result": "success",
          "speedup": 1.1032319505585158
        },
        {
          "num": 4,
          "strategy": "Compute store-level average return directly in the CTE and join it with the customer returns, then filter for customers exceeding 1.2x the store average.",
          "changes": [
            "added store average to CTE",
            "removed correlated subquery",
            "joined CTE with store average"
          ],
          "nodes_rewritten": [
            "customer_total_return",
            "main_query",
            "subquery_1"
          ],
          "result": "success",
          "speedup": 1.0333895074867179
        },
        {
          "num": 5,
          "strategy": "Filter stores by state early in the CTE, compute store-level average using a window function, and eliminate the correlated subquery entirely by joining on pre-computed averages.",
          "changes": [
            "pushed store state filter to CTE",
            "added store average via window function",
            "removed correlated subquery",
            "simplified main query join"
          ],
          "nodes_rewritten": [
            "customer_total_return",
            "main_query",
            "subquery_1"
          ],
          "result": "success",
          "speedup": 1.5041951671567424
        }
      ]
    }
  ]
}