WITH date_filtered_sales AS (SELECT ws_ext_sales_price AS ext_price, ws_sold_date_sk AS sold_date_sk, ws_item_sk AS sold_item_sk, ws_sold_time_sk AS time_sk FROM web_sales, date_dim WHERE d_date_sk = ws_sold_date_sk AND d_moy = 12 AND d_year = 1998 UNION ALL SELECT cs_ext_sales_price AS ext_price, cs_sold_date_sk AS sold_date_sk, cs_item_sk AS sold_item_sk, cs_sold_time_sk AS time_sk FROM catalog_sales, date_dim WHERE d_date_sk = cs_sold_date_sk AND d_moy = 12 AND d_year = 1998 UNION ALL SELECT ss_ext_sales_price AS ext_price, ss_sold_date_sk AS sold_date_sk, ss_item_sk AS sold_item_sk, ss_sold_time_sk AS time_sk FROM store_sales, date_dim WHERE d_date_sk = ss_sold_date_sk AND d_moy = 12 AND d_year = 1998), filtered_items AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1), meal_sales AS (SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM filtered_items, date_filtered_sales, time_dim WHERE sold_item_sk = i_item_sk AND time_sk = t_time_sk AND t_meal_time = 'breakfast' UNION ALL SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM filtered_items, date_filtered_sales, time_dim WHERE sold_item_sk = i_item_sk AND time_sk = t_time_sk AND t_meal_time = 'dinner')
SELECT brand_id, brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM meal_sales GROUP BY brand, brand_id, t_hour, t_minute ORDER BY ext_price DESC, brand_id