1. **Pushed store filter into CTE**: By joining store with s_state='SD' early in the CTE, we reduce the store_returns processing to only relevant stores (53 stores instead of all stores), significantly reducing the intermediate result size.
2. **Used window function for threshold**: Replaced the correlated subquery with a window function that computes the average per store once, eliminating repeated calculations for each customer.
3. **Reduced customer scan**: By filtering stores first, we join fewer rows with customer, reducing the expensive customer table scan impact.
4. **Explicit JOIN syntax**: Changed implicit joins to explicit JOINs for better readability and optimizer hints.
5. **Maintained semantics**: All conditions and logic remain identical to the original query.