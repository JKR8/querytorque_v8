Converted the correlated subquery to a window function in the CTE. The original query calculated `AVG(ctr_total_return) * 1.2` repeatedly for each store via a correlated subquery. By using `AVG(SUM(SR_FEE)) OVER (PARTITION BY sr_store_sk) * 1.2` in the CTE, the average is computed once per store during the single pass of the data. The main query now simply compares `ctr_total_return > ctr_avg_return_threshold` without a subquery scan. This eliminates the O(nÂ²) nested loop behavior and allows DuckDB to use efficient parallel hash joins for the main query joins. Explicit JOIN syntax was added to help the optimizer recognize join conditions.