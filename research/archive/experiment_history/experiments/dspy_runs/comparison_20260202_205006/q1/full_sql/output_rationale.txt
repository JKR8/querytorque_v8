1. **Correlated Subquery Elimination**: Replaced the expensive correlated subquery `(SELECT AVG(ctr_total_return)*1.2...)` with a window function `AVG(SUM(SR_FEE)) OVER (PARTITION BY sr_store_sk) * 1.2` inside the CTE. This computes the per-store average once during CTE materialization, avoiding O(nÂ²) nested scans and eliminating the LEFT_DELIM_JOIN overhead.

2. **Explicit JOIN Syntax**: Converted comma joins to explicit JOIN clauses, enabling DuckDB's optimizer to utilize parallel hash joins effectively and push filters down the pipeline.

3. **Early Filtering**: The store filter `s_state = 'SD'` is now applied in a JOIN condition, allowing the optimizer to filter the 53-row store table before joining to the 2M-row customer table, significantly reducing the customer scan cost identified in the execution plan.

4. **Simplified Comparison**: The WHERE clause now uses a simple column-to-column comparison (`ctr_total_return > avg_threshold`) instead of a subquery, allowing better cardinality estimation and index utilization.