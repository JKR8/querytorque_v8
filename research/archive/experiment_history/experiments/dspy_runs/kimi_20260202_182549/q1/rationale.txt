Pushing the s_state = 'SD' filter into the initial CTE reduces the input dataset from 56,138 rows to approximately 2% of that volume (assuming uniform store distribution across 50 states), making the subsequent grouping operation significantly cheaper. Converting the correlated subquery to a separate CTE (store_avg_return) eliminates the expensive per-row subquery execution and allows the optimizer to use efficient hash joins instead of nested loop joins or multiple CTE scans. Most importantly, by filtering to SD stores and high-return customers before joining to the customer table, the query avoids the 73.4% cost full scan on 1.99M customer rows, instead performing an index-optimized or hash join on only the small subset of customers who actually meet the business criteria.