Decorrelated the subquery by replacing it with a window function in the CTE. The window function `AVG(SUM(SR_FEE)) OVER (PARTITION BY sr_store_sk)` calculates the average return per store during the initial aggregation phase, storing it as `ctr_avg_threshold`. This eliminates the need to re-scan `customer_total_return` for every row in the main query, reducing complexity from O(n√óm) to O(n). DuckDB can now execute this as a single-pass operation with efficient hash joins rather than nested loop joins, significantly reducing the cost of the customer table scan and join operations.