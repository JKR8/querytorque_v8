{
  "operations": [
    {
      "op": "add_cte",
      "after": "start",
      "name": "mixed_orders",
      "sql": "select cs_order_number from catalog_sales group by cs_order_number having count(distinct cs_warehouse_sk) > 1"
    },
    {
      "op": "add_cte",
      "after": "mixed_orders",
      "name": "returned_orders",
      "sql": "select distinct cr_order_number from catalog_returns"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from catalog_sales cs1\n  join date_dim on cs1.cs_ship_date_sk = d_date_sk\n  join customer_address on cs1.cs_ship_addr_sk = ca_address_sk\n  join call_center on cs1.cs_call_center_sk = cc_call_center_sk\n  join mixed_orders mo on cs1.cs_order_number = mo.cs_order_number\n  left join returned_orders ro on cs1.cs_order_number = ro.cr_order_number"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "where d_date between '2002-4-01' and (cast('2002-4-01' as date) + INTERVAL 60 DAY)\n  and ca_state = 'WV'\n  and cc_county in ('Ziebach County','Luce County','Richland County','Daviess County','Barrow County')\n  and ro.cr_order_number is null"
    }
  ],
  "semantic_warnings": [
    "Replaced correlated EXISTS/NOT EXISTS with CTEs and Joins."
  ],
  "explanation": "Pre-calculated orders with multiple warehouses ('mixed_orders') and returned orders ('returned_orders') in CTEs. Replaced correlated subqueries with standard joins (and anti-join for returns) to avoid row-by-row execution."
}