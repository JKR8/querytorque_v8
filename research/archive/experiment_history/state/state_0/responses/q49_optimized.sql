WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12), web_sales_prejoin AS (SELECT ws.ws_order_number, ws.ws_item_sk, ws.ws_quantity, ws.ws_net_paid, ws.ws_net_profit FROM web_sales AS ws JOIN filtered_dates AS fd ON ws.ws_sold_date_sk = fd.d_date_sk WHERE ws.ws_net_profit > 1 AND ws.ws_net_paid > 0 AND ws.ws_quantity > 0), catalog_sales_prejoin AS (SELECT cs.cs_order_number, cs.cs_item_sk, cs.cs_quantity, cs.cs_net_paid, cs.cs_net_profit FROM catalog_sales AS cs JOIN filtered_dates AS fd ON cs.cs_sold_date_sk = fd.d_date_sk WHERE cs.cs_net_profit > 1 AND cs.cs_net_paid > 0 AND cs.cs_quantity > 0), store_sales_prejoin AS (SELECT ss.ss_ticket_number, ss.ss_item_sk, ss.ss_quantity, ss.ss_net_paid, ss.ss_net_profit FROM store_sales AS ss JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk WHERE ss.ss_net_profit > 1 AND ss.ss_net_paid > 0 AND ss.ss_quantity > 0)
SELECT channel, item, return_ratio, return_rank, currency_rank FROM (SELECT 'web' AS channel, web.item, web.return_ratio, web.return_rank, web.currency_rank FROM (SELECT item, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM (SELECT ws.ws_item_sk AS item, (CAST(SUM(COALESCE(wr.wr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(ws.ws_quantity, 0)) AS DECIMAL(15, 4))) AS return_ratio, (CAST(SUM(COALESCE(wr.wr_return_amt, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(ws.ws_net_paid, 0)) AS DECIMAL(15, 4))) AS currency_ratio FROM web_sales_prejoin AS ws LEFT OUTER JOIN web_returns AS wr ON (ws.ws_order_number = wr.wr_order_number AND ws.ws_item_sk = wr.wr_item_sk) WHERE wr.wr_return_amt > 10000 GROUP BY ws.ws_item_sk) AS in_web) AS web WHERE (web.return_rank <= 10 OR web.currency_rank <= 10) UNION SELECT 'catalog' AS channel, catalog.item, catalog.return_ratio, catalog.return_rank, catalog.currency_rank FROM (SELECT item, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM (SELECT cs.cs_item_sk AS item, (CAST(SUM(COALESCE(cr.cr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(cs.cs_quantity, 0)) AS DECIMAL(15, 4))) AS return_ratio, (CAST(SUM(COALESCE(cr.cr_return_amount, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(cs.cs_net_paid, 0)) AS DECIMAL(15, 4))) AS currency_ratio FROM catalog_sales_prejoin AS cs LEFT OUTER JOIN catalog_returns AS cr ON (cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk) WHERE cr.cr_return_amount > 10000 GROUP BY cs.cs_item_sk) AS in_cat) AS catalog WHERE (catalog.return_rank <= 10 OR catalog.currency_rank <= 10) UNION SELECT 'store' AS channel, store.item, store.return_ratio, store.return_rank, store.currency_rank FROM (SELECT item, return_ratio, currency_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM (SELECT sts.ss_item_sk AS item, (CAST(SUM(COALESCE(sr.sr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(sts.ss_quantity, 0)) AS DECIMAL(15, 4))) AS return_ratio, (CAST(SUM(COALESCE(sr.sr_return_amt, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(sts.ss_net_paid, 0)) AS DECIMAL(15, 4))) AS currency_ratio FROM store_sales_prejoin AS sts LEFT OUTER JOIN store_returns AS sr ON (sts.ss_ticket_number = sr.sr_ticket_number AND sts.ss_item_sk = sr.sr_item_sk) WHERE sr.sr_return_amt > 10000 GROUP BY sts.ss_item_sk) AS in_store) AS store WHERE (store.return_rank <= 10 OR store.currency_rank <= 10)) ORDER BY 1, 4, 5, 2 LIMIT 100