WITH filtered_store_dates AS (SELECT d_date_sk FROM date_dim), filtered_catalog_dates AS (SELECT d_date_sk FROM date_dim), store_sales_agg AS (SELECT 'store' AS channel, 'ss_hdemo_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ss_ext_sales_price) AS sales_amt FROM store_sales JOIN filtered_store_dates ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE ss_hdemo_sk IS NULL GROUP BY d_year, d_qoy, i_category), catalog_sales_agg AS (SELECT 'catalog' AS channel, 'cs_warehouse_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(cs_ext_sales_price) AS sales_amt FROM catalog_sales JOIN filtered_catalog_dates ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE cs_warehouse_sk IS NULL GROUP BY d_year, d_qoy, i_category), web_sales_agg AS (SELECT 'web' AS channel, 'ws_bill_addr_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ws_ext_sales_price) AS sales_amt FROM web_sales, item, date_dim WHERE ws_bill_addr_sk IS NULL AND ws_sold_date_sk = d_date_sk AND ws_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category)
SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM catalog_sales_agg