WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001), prefetched_sales AS (SELECT cs_sales_price, cs_bill_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk), zip_sales AS (SELECT cs_sales_price, ca_zip FROM prefetched_sales AS s JOIN customer AS c ON s.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address AS a ON c.c_current_addr_sk = a.ca_address_sk WHERE SUBSTRING(ca_zip, 1, 5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792')), state_sales AS (SELECT cs_sales_price, ca_zip FROM prefetched_sales AS s JOIN customer AS c ON s.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address AS a ON c.c_current_addr_sk = a.ca_address_sk WHERE ca_state IN ('CA', 'WA', 'GA')), price_sales AS (SELECT cs_sales_price, ca_zip FROM prefetched_sales AS s JOIN customer AS c ON s.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address AS a ON c.c_current_addr_sk = a.ca_address_sk WHERE cs_sales_price > 500), filtered_sales AS (SELECT * FROM zip_sales UNION ALL SELECT * FROM state_sales UNION ALL SELECT * FROM price_sales)
SELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100