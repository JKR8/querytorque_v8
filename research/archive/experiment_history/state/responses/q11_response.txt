```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year IN (2001, 2002)",
        "store_year_total": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, c.c_birth_country AS customer_birth_country, c.c_login AS customer_login, c.c_email_address AS customer_email_address, d.d_year AS dyear, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total, 's' AS sale_type FROM customer c JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year IN (2001, 2002) GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_country, c.c_login, c.c_email_address, d.d_year",
        "web_year_total": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, c.c_birth_country AS customer_birth_country, c.c_login AS customer_login, c.c_email_address AS customer_email_address, d.d_year AS dyear, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total, 'w' AS sale_type FROM customer c JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE d.d_year IN (2001, 2002) GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_country, c.c_login, c.c_email_address, d.d_year",
        "main_query": "SELECT t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name, t_s_secyear.customer_birth_country FROM store_year_total AS t_s_firstyear JOIN store_year_total AS t_s_secyear ON t_s_firstyear.customer_id = t_s_secyear.customer_id JOIN web_year_total AS t_w_firstyear ON t_s_firstyear.customer_id = t_w_firstyear.customer_id JOIN web_year_total AS t_w_secyear ON t_s_firstyear.customer_id = t_w_secyear.customer_id WHERE t_s_firstyear.dyear = 2001 AND t_s_secyear.dyear = 2002 AND t_w_firstyear.dyear = 2001 AND t_w_secyear.dyear = 2002 AND t_s_firstyear.year_total > 0 AND t_w_firstyear.year_total > 0 AND CASE WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total ELSE 0.0 END > CASE WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total ELSE 0.0 END ORDER BY t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name, t_s_secyear.customer_birth_country LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same grouping and aggregation"
      ],
      "expected_speedup": "3.0x",
      "risk": "low"
    }
  ],
  "explanation": "Created a filtered_dates CTE to isolate date_dim scans for years 2001 and 2002 only, reducing unnecessary date scans from 4 to 1. Split the year_total CTE into separate store_year_total and web_year_total CTEs with the year filter pushed down, allowing each to use the pre-filtered dates. This prevents scanning the entire date_dim multiple times and reduces the cardinality of intermediate results by filtering years early. The main query now joins these pre-filtered CTEs with explicit year conditions, maintaining the same logic."
}
```