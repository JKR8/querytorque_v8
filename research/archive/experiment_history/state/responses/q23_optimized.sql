WITH date_filter_years AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)), frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales JOIN date_filter_years ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN date_filter_years ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk GROUP BY c_customer_sk) AS t), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT tpcds_cmax FROM max_store_sales)), date_filter_month AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy = 5), filtered_catalog_sales AS (SELECT cs_item_sk, cs_bill_customer_sk, cs_quantity * cs_list_price AS sales FROM catalog_sales JOIN date_filter_month ON cs_sold_date_sk = d_date_sk), filtered_web_sales AS (SELECT ws_item_sk, ws_bill_customer_sk, ws_quantity * ws_list_price AS sales FROM web_sales JOIN date_filter_month ON ws_sold_date_sk = d_date_sk)
SELECT SUM(sales) FROM (SELECT sales FROM filtered_catalog_sales AS cs JOIN frequent_ss_items AS f ON cs.cs_item_sk = f.item_sk JOIN best_ss_customer AS b ON cs.cs_bill_customer_sk = b.c_customer_sk UNION ALL SELECT sales FROM filtered_web_sales AS ws JOIN frequent_ss_items AS f ON ws.ws_item_sk = f.item_sk JOIN best_ss_customer AS b ON ws.ws_bill_customer_sk = b.c_customer_sk) AS t LIMIT 100