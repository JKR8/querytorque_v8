payload_version: duckdb.sqlopt.v1
engine:
  name: duckdb
  version: v1.4.4
  execution_mode: IN_MEMORY
  settings_snapshot:
    threads: 12
    memory_limit: 25.0 GiB
    temp_directory: /mnt/d/TPC-DS/tpcds_sf100.duckdb.tmp
    enable_optimizer: true
    preserve_insertion_order: false
task:
  goal: produce_complete_optimized_sql_rewrite
  deliverables:
  - optimized_sql
  - verification_sql
  - recommended_actions
  dialect: duckdb_sql
  query_name: query_1.sql
constraints:
  must_preserve:
    output_columns: []
    row_count_exact: null
    sort_order: ''
  permitted_transformations:
  - predicate_pushdown
  - join_reordering
  - derived_table_prefilter
  - projection_pruning
  forbidden_transformations:
  - remove_or_weaken_filters
  - add_row_count_limit
  - change_join_types
  - add_distinct_or_groupby
  - change_null_semantics
  - introduce_randomness_or_sampling
  - remove_required_order_by
  - add_order_by_keys
input_sql:
  sql_text: |
    -- start query 1 in stream 0 using template query1.tpl
    with customer_total_return as
    (select sr_customer_sk as ctr_customer_sk
    ,sr_store_sk as ctr_store_sk
    ,sum(SR_FEE) as ctr_total_return
    from store_returns
    ,date_dim
    where sr_returned_date_sk = d_date_sk
    and d_year =2000
    group by sr_customer_sk
    ,sr_store_sk)
     select c_customer_id
    from customer_total_return ctr1
    ,store
    ,customer
    where ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2
    from customer_total_return ctr2
    where ctr1.ctr_store_sk = ctr2.ctr_store_sk)
    and s_store_sk = ctr1.ctr_store_sk
    and s_state = 'SD'
    and ctr1.ctr_customer_sk = c_customer_sk
    order by c_customer_id
     LIMIT 100;
  referenced_filters:
  - id: F-EQUALITY-001
    expression: sr_returned_date_sk = d_date_sk
    type: EQUALITY
  - id: F-EQUALITY-002
    expression: d_year =2000
    type: EQUALITY
schema:
  tables:
  - name: store_returns
    row_count: 28792282
    columns:
    - name: sr_returned_date_sk
      type: BIGINT
    - name: sr_return_time_sk
      type: BIGINT
    - name: sr_item_sk
      type: BIGINT
    - name: sr_customer_sk
      type: BIGINT
    - name: sr_cdemo_sk
      type: BIGINT
    - name: sr_hdemo_sk
      type: BIGINT
    - name: sr_addr_sk
      type: BIGINT
    - name: sr_store_sk
      type: BIGINT
    - name: sr_reason_sk
      type: BIGINT
    - name: sr_ticket_number
      type: BIGINT
    - name: sr_return_quantity
      type: BIGINT
    - name: sr_return_amt
      type: DECIMAL(7,2)
    - name: sr_return_tax
      type: DECIMAL(7,2)
    - name: sr_return_amt_inc_tax
      type: DECIMAL(7,2)
    - name: sr_fee
      type: DECIMAL(7,2)
    - name: sr_return_ship_cost
      type: DECIMAL(7,2)
    - name: sr_refunded_cash
      type: DECIMAL(7,2)
    - name: sr_reversed_charge
      type: DECIMAL(7,2)
    - name: sr_store_credit
      type: DECIMAL(7,2)
    - name: sr_net_loss
      type: DECIMAL(7,2)
  - name: date_dim
    row_count: 73049
    columns:
    - name: d_date_sk
      type: BIGINT
    - name: d_date_id
      type: VARCHAR
    - name: d_date
      type: DATE
    # ... 25 more columns ...
  - name: store
    row_count: 402
    columns:
    - name: s_store_sk
      type: BIGINT
    - name: s_store_id
      type: VARCHAR
    # ... 27 more columns including s_state ...
  - name: customer
    row_count: 2000000
    columns:
    - name: c_customer_sk
      type: BIGINT
    - name: c_customer_id
      type: VARCHAR
    # ... 16 more columns ...
recommended_actions_catalog:
  stats:
  - ANALYZE store_returns
  - ANALYZE date_dim
  - ANALYZE store
  - ANALYZE customer
  data_layout: []
  notes:
  - DuckDB ART indexes are limited to selective equality/IN probes
output_requirements:
  optimized_sql_must:
  - return_exact_same_rows
  - include_required_order_by
  - avoid_engine_specific_hints
  verification_harness_must:
  - prove_row_count_equal
  - prove_multiset_equality
  - prove_ordering_spec_present
response_format:
  type: optimized_sql
  format: json
  schema:
    optimized_sql: <complete optimized SQL>
    explanation: Brief explanation of changes
    changes:
    - rule_id: SQL-XXX
      description: What was fixed
  rules:
  - return_only_json_no_markdown
  - optimized_sql_must_be_complete_and_valid
  - preserve_query_semantics
