Optimize this SQL query.

## Optimization Process

1. ANALYZE: Look at the plan summary. Find where rows are largest.
2. OPTIMIZE: For each large row source, ask "what could reduce it earlier?"
3. VERIFY: The result must be semantically equivalent.

Key principle: Reduce rows as early as possible.

## Example: Predicate Pushdown

WRONG - filter after aggregation:
```sql
WITH sales_agg AS (
    SELECT store_id, SUM(amount) as total
    FROM sales
    GROUP BY store_id  -- aggregates ALL stores
),
good_stores AS (
    SELECT store_id FROM stores WHERE region = 'West'
)
SELECT * FROM sales_agg JOIN good_stores USING (store_id)  -- filters AFTER
```

RIGHT - filter inside aggregation:
```sql
WITH sales_agg AS (
    SELECT s.store_id, SUM(amount) as total
    FROM sales
    JOIN stores s ON sales.store_id = s.store_id  -- join INSIDE
    WHERE s.region = 'West'  -- filter INSIDE, before GROUP BY
    GROUP BY s.store_id  -- aggregates only West stores
)
SELECT * FROM sales_agg
```

The RIGHT version aggregates 100x fewer rows.

## Plan Summary

Top operators by cost:
{operators_by_cost}

Table scans:
{table_scans}

Cardinality misestimates:
{misestimates}

## SQL

```sql
{query}
```

Return only the optimized SQL.
