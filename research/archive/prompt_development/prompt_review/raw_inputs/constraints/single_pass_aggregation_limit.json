{
  "id": "SINGLE_PASS_AGGREGATION_LIMIT",
  "severity": "MEDIUM",
  "overridable": true,
  "description": "Prefer limiting single-pass aggregation to 8 CASE branches. Beyond 8, CASE evaluation overhead may reduce benefit.",
  "observed_failures": [
    {
      "query": "Q88",
      "note": "8 CASE branches (time slices) was the maximum tested that still showed improvement (6.28x). More branches are untested, not proven harmful.",
      "type": "CASE_BRANCH_LIMIT"
    }
  ],
  "observed_successes": [
    {
      "query": "Q88",
      "speedup": "6.28x",
      "context": "8 CASE branches consolidating 8 separate time-bucket subqueries into a single scan."
    },
    {
      "query": "Q9",
      "speedup": "4.47x",
      "context": "5 CASE branches consolidating repeated store_sales scans."
    }
  ],
  "constraint_rules": [
    {
      "rule": "PREFER_8_OR_FEWER_CASE_BRANCHES",
      "description": "When consolidating repeated scans into CASE WHEN aggregates, 8 or fewer branches is well-tested. More branches are untested territory."
    }
  ],
  "override_conditions": [
    "The original query has 9-12 repeated scans on the same fact table (high consolidation value)",
    "Each CASE branch is a simple equality check (low per-row overhead)",
    "The fact table is large (>1M rows) so scan reduction dominates CASE evaluation cost"
  ],
  "prompt_instruction": "DEFAULT: Use at most 8 CASE branches for single_pass_aggregation (tested up to 8 at 6.28x on Q88). HOWEVER: 9-12 branches with simple equality checks on large fact tables may still net positive. The exploration worker MAY try 9-12 branches if the scan reduction value is high. Beyond 12 branches is not recommended."
}
