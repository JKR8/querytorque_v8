{
  "id": "OR_TO_UNION_SELF_JOIN",
  "severity": "HIGH",
  "overridable": true,
  "description": "Avoid or_to_union on queries with self-joins. Splitting OR conditions on self-joined tables can create multiple independent scans that cannot share the self-join optimization.",
  "observed_failures": [
    {
      "query": "Q23",
      "regression": "0.51x",
      "problem": "Self-join on store_sales was split into separate UNION branches, each requiring its own full self-join, doubling execution time.",
      "type": "SELF_JOIN_SPLIT"
    }
  ],
  "constraint_rules": [
    {
      "rule": "AVOID_OR_TO_UNION_ON_SELF_JOINS",
      "description": "If a query contains a self-join (same table aliased twice), or_to_union is risky because the self-join must typically remain in a single query block to share the scan."
    }
  ],
  "override_conditions": [
    "The OR conditions are on a column NOT involved in the self-join predicate",
    "The self-join aliases have independent WHERE filters that make each branch selective",
    "EXPLAIN shows the self-join is already executed multiple times in baseline"
  ],
  "prompt_instruction": "DEFAULT: Avoid or_to_union when the query contains a self-join (same table with different aliases). Splitting forces each branch to independently perform the self-join (observed 0.51x on Q23). HOWEVER: if the OR conditions target a column not involved in the self-join predicate, or if each alias already has independent selective filters, splitting may still help. The exploration worker MAY attempt this with written reasoning about why the structural context differs from Q23."
}
