WITH duplicate_reason AS (SELECT r_reason_sk FROM reason WHERE r_reason_desc = 'duplicate purchase'), filtered_returns AS (SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN duplicate_reason ON sr_reason_sk = r_reason_sk), sales_with_returns AS (SELECT ss_customer_sk, (ss_quantity - COALESCE(sr_return_quantity, 0)) * ss_sales_price AS act_sales FROM store_sales LEFT JOIN filtered_returns ON sr_item_sk = ss_item_sk AND sr_ticket_number = ss_ticket_number)
SELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM sales_with_returns GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100