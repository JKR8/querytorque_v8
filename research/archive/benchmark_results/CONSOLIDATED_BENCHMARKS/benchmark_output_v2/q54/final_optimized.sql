WITH filtered_date_customers AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 5 AND d_year = 1998), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category = 'Women' AND i_class = 'maternity'), filtered_catalog_sales AS (SELECT cs_sold_date_sk, cs_bill_customer_sk, cs_item_sk FROM catalog_sales), filtered_web_sales AS (SELECT ws_sold_date_sk, ws_bill_customer_sk, ws_item_sk FROM web_sales), cs_qualified AS (SELECT DISTINCT cs_bill_customer_sk AS customer_sk, c_current_addr_sk FROM filtered_catalog_sales JOIN filtered_date_customers ON cs_sold_date_sk = d_date_sk JOIN filtered_item ON cs_item_sk = i_item_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk), ws_qualified AS (SELECT DISTINCT ws_bill_customer_sk AS customer_sk, c_current_addr_sk FROM filtered_web_sales JOIN filtered_date_customers ON ws_sold_date_sk = d_date_sk JOIN filtered_item ON ws_item_sk = i_item_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk), my_customers AS (SELECT * FROM cs_qualified UNION ALL SELECT * FROM ws_qualified), base_month AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 5), date_range AS (SELECT d_date_sk FROM date_dim CROSS JOIN base_month WHERE d_month_seq BETWEEN base_month.d_month_seq + 1 AND base_month.d_month_seq + 3), filtered_store_sales AS (SELECT ss_customer_sk, ss_ext_sales_price FROM store_sales JOIN date_range ON ss_sold_date_sk = d_date_sk), my_revenue AS (SELECT mc.c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers AS mc JOIN filtered_store_sales AS fss ON mc.c_customer_sk = fss.ss_customer_sk JOIN customer_address AS ca ON mc.c_current_addr_sk = ca.ca_address_sk JOIN store AS s ON ca.ca_county = s.s_county AND ca.ca_state = s.s_state GROUP BY mc.c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue)
SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100