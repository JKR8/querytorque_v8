## Example: Early Dimension Filter (EARLY_FILTER)
Verified speedup: 2.71x

### Input:
[main_query]:
SELECT ss_customer_sk, SUM(act_sales) AS sumsales
FROM (SELECT ss.ss_customer_sk, CASE WHEN sr.sr_return_quantity IS NOT NULL
        THEN (ss.ss_quantity - sr.sr_return_quantity) * ss.ss_sales_price
        ELSE ss.ss_quantity * ss.ss_sales_price END AS act_sales
      FROM store_sales ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk
      JOIN reason r ON sr.sr_reason_sk = r.r_reason_sk
      WHERE r.r_reason_desc = 'duplicate purchase') t
GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "early_filter",
      "nodes": {
        "filtered_reason": "SELECT r_reason_sk FROM reason WHERE r_reason_desc = 'duplicate purchase'",
        "filtered_returns": "SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN filtered_reason ON sr_reason_sk = r_reason_sk",
        "main_query": "SELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM (SELECT ss.ss_customer_sk, CASE WHEN NOT fr.sr_return_quantity IS NULL THEN (ss.ss_quantity - fr.sr_return_quantity) * ss.ss_sales_price ELSE (ss.ss_quantity * ss.ss_sales_price) END AS act_sales FROM store_sales ss JOIN filtered_returns fr ON (fr.sr_item_sk = ss.ss_item_sk AND fr.sr_ticket_number = ss.ss_ticket_number)) AS t GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "grain preserved",
        "same result rows"
      ],
      "expected_speedup": "2.71x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Filter dimension table (reason) FIRST, then join to fact. Reduces returns to only 'duplicate purchase' before expensive store_sales join.


---

## Example: Decorrelate Subquery (DECORRELATE)
Verified speedup: 2.90x

### Input:
[customer_total_return] CORRELATED:
SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return
FROM store_returns, date_dim
WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000
GROUP BY sr_customer_sk, sr_store_sk

[main_query]:
SELECT c_customer_id FROM customer_total_return ctr1, store, customer
WHERE ctr1.ctr_total_return > (SELECT avg(ctr_total_return)*1.2 FROM customer_total_return ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk)
  AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk
ORDER BY c_customer_id LIMIT 100

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "decorrelate",
      "nodes": {
        "filtered_returns": "SELECT sr.sr_customer_sk, sr.sr_store_sk, sr.sr_fee FROM store_returns sr JOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk JOIN store s ON sr.sr_store_sk = s.s_store_sk WHERE d.d_year = 2000 AND s.s_state = 'SD'",
        "customer_total_return": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(sr_fee) AS ctr_total_return FROM filtered_returns GROUP BY sr_customer_sk, sr_store_sk",
        "store_avg_return": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_store_sk",
        "main_query": "SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN store_avg_return sar ON ctr1.ctr_store_sk = sar.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output"
      ],
      "expected_speedup": "2.90x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Push s_state='SD' filter EARLY into first CTE. Compute average as SEPARATE CTE with GROUP BY (NOT window function). Join on average instead of correlated subquery.


---

## Example: OR to UNION ALL (OR_TO_UNION)
Verified speedup: 2.98x

### Input:
[main_query]:
SELECT ca_zip, sum(cs_sales_price)
FROM catalog_sales, customer, customer_address, date_dim
WHERE cs_bill_customer_sk = c_customer_sk
  AND c_current_addr_sk = ca_address_sk
  AND (substr(ca_zip,1,5) IN ('85669', '86197', ...)
       OR ca_state IN ('CA','WA','GA')
       OR cs_sales_price > 500)
  AND cs_sold_date_sk = d_date_sk
  AND d_qoy = 1 AND d_year = 2001
GROUP BY ca_zip ORDER BY ca_zip LIMIT 100

### Output:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001",
        "filtered_sales": "SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE substr(ca_zip,1,5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('CA','WA','GA') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE cs_sales_price > 500",
        "main_query": "SELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same rows after aggregation"
      ],
      "expected_speedup": "2.98x",
      "risk": "low"
    }
  ]
}
```

**Key insight:** Each OR branch becomes a separate query with focused predicates. Date filter is extracted as CTE and joined into each branch.


---

You are an autonomous Query Rewrite Engine. Your goal is to maximize execution speed while strictly preserving semantic invariants.

Output atomic rewrite sets in JSON.

RULES:
- Primary Goal: Maximize execution speed while strictly preserving semantic invariants.
- Allowed Transforms: Use the provided list. If a standard SQL optimization applies that is not listed, label it "semantic_rewrite".
- Atomic Sets: Group dependent changes (e.g., creating a CTE and joining it) into a single rewrite_set.
- Contracts: Output columns, grain, and total result rows must remain invariant.
- Naming: Use descriptive CTE names (e.g., `filtered_returns` vs `cte1`).
- Column Aliasing: Permitted only for aggregations or disambiguation.

ALLOWED TRANSFORMS: pushdown, decorrelate, or_to_union, early_filter, date_cte_isolate, materialize_cte, flatten_subquery, reorder_join, multi_push_predicate, inline_cte, remove_redundant, semantic_rewrite

OUTPUT FORMAT:
```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "transform_name",
      "nodes": {
        "node_id": "new SQL..."
      },
      "invariants_kept": ["list of preserved semantics"],
      "expected_speedup": "2x",
      "risk": "low"
    }
  ],
  "explanation": "what was changed and why"
}
```

## Target Nodes
  [zip_set2] GROUP_BY
  [main_query] GROUP_BY

## Subgraph Slice
[zip_set2] type=cte
```sql
SELECT SUBSTRING(ca_zip, 1, 5) AS ca_zip, COUNT(*) AS cnt FROM customer_address JOIN customer ON ca_address_sk = c_current_addr_sk WHERE c_preferred_cust_flag = 'Y' GROUP BY SUBSTRING(ca_zip, 1, 5) HAVING COUNT(*) > 10
```

[valid_zips] type=cte
```sql
SELECT DISTINCT z1.ca_zip FROM zip_set1 AS z1 JOIN zip_set2 AS z2 ON z1.ca_zip = z2.ca_zip
```

[main_query] type=main
```sql
SELECT s.s_store_name, SUM(ss.ss_net_profit) FROM store_sales AS ss JOIN date_filtered AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN valid_zips AS vz ON SUBSTRING(s.s_zip, 1, 2) = SUBSTRING(vz.ca_zip, 1, 2) GROUP BY s.s_store_name HAVING NOT SUM(ss.ss_net_profit) IS NULL ORDER BY s.s_store_name LIMIT 100
```

[date_filtered] type=cte
```sql
SELECT d_date_sk FROM date_dim WHERE d_qoy = 2 AND d_year = 1998
```


## Node Contracts
[zip_set2]:
  output_columns: ['ca_zip', 'cnt']
  grain: ['SUBSTRING(ca_zip, 1, 5)']
  required_predicates: ["c_preferred_cust_flag = 'Y'"]
[valid_zips]:
  output_columns: ['ca_zip']
[main_query]:
  output_columns: ['s_store_name', 'SUM(ss.ss_net_profit)']
  grain: ['s_store_name']
[date_filtered]:
  output_columns: ['d_date_sk']
  required_predicates: ['d_qoy = 2', 'd_year = 1998']

## Downstream Usage
No usage data.

## Cost Attribution
[zip_set2]: 47.3% cost, ~1000000 rows, ops=[SEQ_SCAN[customer_address], SEQ_SCAN[customer_address], SEQ_SCAN[customer]]
[valid_zips]: 10.5% cost, ~1000 rows, ops=[HASH_JOIN]
[main_query]: 41.5% cost, ~7611522 rows, ops=[SEQ_SCAN[store_sales], SEQ_SCAN[store]]
[date_filtered]: 0.0% cost, ~91 rows, ops=[SEQ_SCAN[date_dim]]

## Detected Opportunities
No obvious opportunities detected.

Now output your rewrite_sets:

## Execution Plan
```
Operators by cost:
- SEQ_SCAN(store_sales): 44.6% cost, 5,045 rows
- SEQ_SCAN(store_sales): 41.1% cost, 7,611,522 rows
- HASH_JOIN: 5.0% cost, 7,611,522 rows
- HASH_JOIN: 3.3% cost, 2,002,626 rows
- HASH_JOIN: 2.2% cost, 945,304 rows

Scans:
- store_sales x1: 3,455,964,288 rows (no filter)
- customer x1: 24,000,000 → 945,304 rows (filtered)
- customer_address x2: 9,000,000 rows (no filter)
- date_dim x1: 73,049 → 91 rows (filtered)
- store x1: 402 → 400 rows (filtered)

Misestimates:
- FILTER: est 227,611 vs actual 10 (22761.1x)
- PROJECTION: est 1,138,058 vs actual 10 (113805.8x)
- HASH_GROUP_BY: est 1,138,058 vs actual 10 (113805.8x)
- PROJECTION: est 390,685,649 vs actual 2,002,626 (195.1x)
- PROJECTION: est 390,685,649 vs actual 2,002,626 (195.1x)
- HASH_JOIN: est 390,685,649 vs actual 2,002,626 (195.1x)
- SEQ_SCAN: est 287,997,024 vs actual 7,611,522 (37.8x)
- HASH_JOIN: est 68,096 vs actual 110 (619.1x)
- HASH_GROUP_BY: est 16,770 vs actual 16 (1048.1x)
- PROJECTION: est 16,770 vs actual 16 (1048.1x)
- PROJECTION: est 16,770 vs actual 16 (1048.1x)
- HASH_JOIN: est 16,770 vs actual 16 (1048.1x)
- HASH_GROUP_BY: est 200,000 vs actual 39 (5128.2x)
- PROJECTION: est 200,000 vs actual 5,045 (39.6x)
- PROJECTION: est 200,000 vs actual 5,045 (39.6x)
- SEQ_SCAN: est 200,000 vs actual 5,045 (39.6x)
- PROJECTION: est 76,724 vs actual 3,701 (20.7x)
- FILTER: est 76,724 vs actual 3,701 (20.7x)
- HASH_GROUP_BY: est 383,620 vs actual 6,925 (55.4x)

Joins:
- HASH_JOIN: ? x ? -> 2,002,626 rows (late)
- HASH_JOIN: store_sales x ? -> 7,611,522 rows (late)
- HASH_JOIN: ? x store -> 110 rows
- HASH_JOIN: ? x ? -> 16 rows
- HASH_JOIN: customer_address x customer -> 945,304 rows
```


## Previous Successful Iterations

### Iteration 1: 0.98x speedup ✓

### Iteration 2: 1.06x speedup ✓

## Failed Attempts (avoid these approaches)
- Iteration 3: SEMANTIC ERROR: Value mismatch - row counts match but VALUES differ
Sample differences: [ValueDifference(row_index=0, column='sum(ss.ss_net_profit)', original_value=Decimal('-126429230.62'), optimized_value=Decimal('-850145775.70')), ValueDifference(row_index=1, column='sum(ss.ss_net_profit)', original_value=Decimal('-124896508.90'), optimized_value=Decimal('-407433194.74')), ValueDifference(row_index=2, column='sum(ss.ss_net_profit)', original_value=Decimal('-95403950.47'), optimized_value=Decimal('-439402756.10')), ValueDifference(row_index=3, column='sum(ss.ss_net_profit)', original_value=Decimal('-315802304.48'), optimized_value=Decimal('-848290819.50')), ValueDifference(row_index=4, column='sum(ss.ss_net_profit)', original_value=Decimal('-188737745.50'), optimized_value=Decimal('-787623553.49'))]
Original row 0: {'s_store_name': 'able', 'sum(ss.ss_net_profit)': Decimal('-126429230.62')}
Optimized row 0: {'s_store_name': 'able', 'sum(ss.ss_net_profit)': Decimal('-850145775.70')}
Your optimized SQL that failed:
```sql
WITH zip_set2 AS (SELECT SUBSTRING(ca_zip, 1, 5) AS ca_zip, COUNT(*) AS cnt FROM customer_address JOIN customer ON ca_address_sk = c_current_addr_sk WHERE c_preferred_cust_flag = 'Y' GROUP BY SUBSTRING(ca_zip, 1, 5) HAVING COUNT(*) > 10), zip_prefixes AS (SELECT DISTINCT SUBSTRING(ca_zip, 1, 2) AS zip_prefix FROM zip_set2), filtered_stores AS (SELECT s_store_sk, s_store_name, s_zip FROM store WHERE SUBSTRING(s_zip, 1, 2) IN (SELECT zip_prefix FROM zip_prefixes)), date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 2 AND d_year = 1998), zip_set1 AS (SELECT DISTINCT SUBSTRING(ca_zip, 1, 5) AS ca_zip FROM customer_address WHERE SUBSTRING(ca_zip, 1, 5) IN ('47602', '16704', '35863', '28577', '83910', '36201', '58412', '48162', '28055', '41419', '80332', '38607', '77817', '24891', '16226', '18410', '21231', '59345', '13918', '51089', '20317', '17167', '54585', '67881', '78366', '47770', '18360', '51717', '73108', '14440', '21800', '89338', '45859', '65501', '34948', '25973', '73219', '25333', '17291', '10374', '18829', '60736', '82620', '41351', '52094', '19326', '25214', '54207', '40936', '21814', '79077', '25178', '75742', '77454', '30621', '89193', '27369', '41232', '48567', '83041', '71948', '37119', '68341', '14073', '16891', '62878', '49130', '19833', '24286', '27700', '40979', '50412', '81504', '94835', '84844', '71954', '39503', '57649', '18434', '24987', '12350', '86379', '27413', '44529', '98569', '16515', '27287', '24255', '21094', '16005', '56436', '91110', '68293', '56455', '54558', '10298', '83647', '32754', '27052', '51766', '19444', '13869', '45645', '94791', '57631', '20712', '37788', '41807', '46507', '21727', '71836', '81070', '50632', '88086', '63991', '20244', '31655', '51782', '29818', '63792', '68605', '94898', '36430', '57025', '20601', '82080', '33869', '22728', '35834', '29086', '92645', '98584', '98072', '11652', '78093', '57553', '43830', '71144', '53565', '18700', '90209', '71256', '38353', '54364', '28571', '96560', '57839', '56355', '50679', '45266', '84680', '34306', '34972', '48530', '30106', '15371', '92380', '84247', '92292', '68852', '13338', '34594', '82602', '70073', '98069', '85066', '47289', '11686', '98862', '26217', '47529', '63294', '51793', '35926', '24227', '14196', '24594', '32489', '99060', '49472', '43432', '49211', '14312', '88137', '47369', '56877', '20534', '81755', '15794', '12318', '21060', '73134', '41255', '63073', '81003', '73873', '66057', '51184', '51195', '45676', '92696', '70450', '90669', '98338', '25264', '38919', '59226', '58581', '60298', '17895', '19489', '52301', '80846', '95464', '68770', '51634', '19988', '18367', '18421', '11618', '67975', '25494', '41352', '95430', '15734', '62585', '97173', '33773', '10425', '75675', '53535', '17879', '41967', '12197', '67998', '79658', '59130', '72592', '14851', '43933', '68101', '50636', '25717', '71286', '24660', '58058', '72991', '95042', '15543', '33122', '69280', '11912', '59386', '27642', '65177', '17672', '33467', '64592', '36335', '54010', '18767', '63193', '42361', '49254', '33113', '33159', '36479', '59080', '11855', '81963', '31016', '49140', '29392', '41836', '32958', '53163', '13844', '73146', '23952', '65148', '93498', '14530', '46131', '58454', '13376', '13378', '83986', '12320', '17193', '59852', '46081', '98533', '52389', '13086', '68843', '31013', '13261', '60560', '13443', '45533', '83583', '11489', '58218', '19753', '22911', '25115', '86709', '27156', '32669', '13123', '51933', '39214', '41331', '66943', '14155', '69998', '49101', '70070', '35076', '14242', '73021', '59494', '15782', '29752', '37914', '74686', '83086', '34473', '15751', '81084', '49230', '91894', '60624', '17819', '28810', '63180', '56224', '39459', '55233', '75752', '43639', '55349', '86057', '62361', '50788', '31830', '58062', '18218', '85761', '60083', '45484', '21204', '90229', '70041', '41162', '35390', '16364', '39500', '68908', '26689', '52868', '81335', '40146', '11340', '61527', '61794', '71997', '30415', '59004', '29450', '58117', '69952', '33562', '83833', '27385', '61860', '96435', '48333', '23065', '32961', '84919', '61997', '99132', '22815', '56600', '68730', '48017', '95694', '32919', '88217', '27116', '28239', '58032', '18884', '16791', '21343', '97462', '18569', '75660', '15475')), valid_zips AS (SELECT DISTINCT z1.ca_zip FROM zip_set1 AS z1 JOIN zip_set2 AS z2 ON z1.ca_zip = z2.ca_zip) SELECT s.s_store_name, SUM(ss.ss_net_profit) FROM store_sales AS ss JOIN date_filtered AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN filtered_stores AS s ON ss.ss_store_sk = s.s_store_sk GROUP BY s.s_store_name HAVING NOT SUM(ss.ss_net_profit) IS NULL ORDER BY s.s_store_name LIMIT 100
```
- Iteration 4: SEMANTIC ERROR: Value mismatch - row counts match but VALUES differ
Sample differences: [ValueDifference(row_index=3, column='sum(ss.ss_net_profit)', original_value=Decimal('-315802304.48'), optimized_value=Decimal('-284347050.80')), ValueDifference(row_index=5, column='sum(ss.ss_net_profit)', original_value=Decimal('-224050572.28'), optimized_value=Decimal('-191402729.64'))]
Original row 0: {'s_store_name': 'able', 'sum(ss.ss_net_profit)': Decimal('-126429230.62')}
Optimized row 0: {'s_store_name': 'able', 'sum(ss.ss_net_profit)': Decimal('-126429230.62')}
Your optimized SQL that failed:
```sql
WITH zip_set2 AS (SELECT SUBSTRING(ca_zip, 1, 5) AS ca_zip, COUNT(*) AS cnt FROM customer_address JOIN customer ON ca_address_sk = c_current_addr_sk WHERE c_preferred_cust_flag = 'Y' GROUP BY SUBSTRING(ca_zip, 1, 5) HAVING COUNT(*) > 10), zip_set1 AS (SELECT DISTINCT SUBSTRING(ca_zip, 1, 5) AS ca_zip FROM customer_address WHERE SUBSTRING(ca_zip, 1, 5) IN ('47602', '16704', '35863', '28577', '83910', '36201', '58412', '48162', '28055', '41419', '80332', '38607', '77817', '24891', '16226', '18410', '21231', '59345', '13918', '51089', '20317', '17167', '54585', '67881', '78366', '47770', '18360', '51717', '73108', '14440', '21800', '89338', '45859', '65501', '34948', '25973', '73219', '25333', '17291', '10374', '18829', '60736', '82620', '41351', '52094', '19326', '25214', '54207', '40936', '21814', '79077', '25178', '75742', '77454', '30621', '89193', '27369', '41232', '48567', '83041', '71948', '37119', '68341', '14073', '16891', '62878', '49130', '19833', '24286', '27700', '40979', '50412', '81504', '94835', '84844', '71954', '39503', '57649', '18434', '24987', '12350', '86379', '27413', '44529', '98569', '16515', '27287', '24255', '21094', '16005', '56436', '91110', '68293', '56455', '54558', '10298', '83647', '32754', '27052', '51766', '19444', '13869', '45645', '94791', '57631', '20712', '37788', '41807', '46507', '21727', '71836', '81070', '50632', '88086', '63991', '20244', '31655', '51782', '29818', '63792', '68605', '94898', '36430', '57025', '20601', '82080', '33869', '22728', '35834', '29086', '92645', '98584', '98072', '11652', '78093', '57553', '43830', '71144', '53565', '18700', '90209', '71256', '38353', '54364', '28571', '96560', '57839', '56355', '50679', '45266', '84680', '34306', '34972', '48530', '30106', '15371', '92380', '84247', '92292', '68852', '13338', '34594', '82602', '70073', '98069', '85066', '47289', '11686', '98862', '26217', '47529', '63294', '51793', '35926', '24227', '14196', '24594', '32489', '99060', '49472', '43432', '49211', '14312', '88137', '47369', '56877', '20534', '81755', '15794', '12318', '21060', '73134', '41255', '63073', '81003', '73873', '66057', '51184', '51195', '45676', '92696', '70450', '90669', '98338', '25264', '38919', '59226', '58581', '60298', '17895', '19489', '52301', '80846', '95464', '68770', '51634', '19988', '18367', '18421', '11618', '67975', '25494', '41352', '95430', '15734', '62585', '97173', '33773', '10425', '75675', '53535', '17879', '41967', '12197', '67998', '79658', '59130', '72592', '14851', '43933', '68101', '50636', '25717', '71286', '24660', '58058', '72991', '95042', '15543', '33122', '69280', '11912', '59386', '27642', '65177', '17672', '33467', '64592', '36335', '54010', '18767', '63193', '42361', '49254', '33113', '33159', '36479', '59080', '11855', '81963', '31016', '49140', '29392', '41836', '32958', '53163', '13844', '73146', '23952', '65148', '93498', '14530', '46131', '58454', '13376', '13378', '83986', '12320', '17193', '59852', '46081', '98533', '52389', '13086', '68843', '31013', '13261', '60560', '13443', '45533', '83583', '11489', '58218', '19753', '22911', '25115', '86709', '27156', '32669', '13123', '51933', '39214', '41331', '66943', '14155', '69998', '49101', '70070', '35076', '14242', '73021', '59494', '15782', '29752', '37914', '74686', '83086', '34473', '15751', '81084', '49230', '91894', '60624', '17819', '28810', '63180', '56224', '39459', '55233', '75752', '43639', '55349', '86057', '62361', '50788', '31830', '58062', '18218', '85761', '60083', '45484', '21204', '90229', '70041', '41162', '35390', '16364', '39500', '68908', '26689', '52868', '81335', '40146', '11340', '61527', '61794', '71997', '30415', '59004', '29450', '58117', '69952', '33562', '83833', '27385', '61860', '96435', '48333', '23065', '32961', '84919', '61997', '99132', '22815', '56600', '68730', '48017', '95694', '32919', '88217', '27116', '28239', '58032', '18884', '16791', '21343', '97462', '18569', '75660', '15475')), valid_zips AS (SELECT DISTINCT z1.ca_zip FROM zip_set1 AS z1 JOIN zip_set2 AS z2 ON z1.ca_zip = z2.ca_zip), zip_prefixes AS (SELECT DISTINCT SUBSTRING(ca_zip, 1, 2) AS zip_prefix FROM valid_zips), filtered_stores AS (SELECT s_store_sk, s_store_name FROM store WHERE SUBSTRING(s_zip, 1, 2) IN (SELECT zip_prefix FROM zip_prefixes)), date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 2 AND d_year = 1998) SELECT s.s_store_name, SUM(ss.ss_net_profit) FROM store_sales AS ss JOIN date_filtered AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN filtered_stores AS s ON ss.ss_store_sk = s.s_store_sk GROUP BY s.s_store_name HAVING NOT SUM(ss.ss_net_profit) IS NULL ORDER BY s.s_store_name LIMIT 100
```

## Current Challenge
**Current best:** 1.06x speedup
**Target:** 2.0x
**Gap:** 0.94x needed

Try a DIFFERENT approach to improve upon the current best.



**IMPORTANT:** The following patterns were provided: early_filter, decorrelate, or_to_union. Consider a DIFFERENT approach!
