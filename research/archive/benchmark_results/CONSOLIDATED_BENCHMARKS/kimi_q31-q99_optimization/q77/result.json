{
  "query_num": 77,
  "status": "success",
  "original_sql": "-- start query 77 in stream 0 using template query77.tpl\nwith ss as\n (select s_store_sk,\n         sum(ss_ext_sales_price) as sales,\n         sum(ss_net_profit) as profit\n from store_sales,\n      date_dim,\n      store\n where ss_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date) \n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY) \n       and ss_store_sk = s_store_sk\n group by s_store_sk)\n ,\n sr as\n (select s_store_sk,\n         sum(sr_return_amt) as \"returns\",\n         sum(sr_net_loss) as profit_loss\n from store_returns,\n      date_dim,\n      store\n where sr_returned_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date)\n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY)\n       and sr_store_sk = s_store_sk\n group by s_store_sk), \n cs as\n (select cs_call_center_sk,\n        sum(cs_ext_sales_price) as sales,\n        sum(cs_net_profit) as profit\n from catalog_sales,\n      date_dim\n where cs_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date)\n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY)\n group by cs_call_center_sk \n ), \n cr as\n (select cr_call_center_sk,\n         sum(cr_return_amount) as \"returns\",\n         sum(cr_net_loss) as profit_loss\n from catalog_returns,\n      date_dim\n where cr_returned_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date)\n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY)\n group by cr_call_center_sk\n ), \n ws as\n ( select wp_web_page_sk,\n        sum(ws_ext_sales_price) as sales,\n        sum(ws_net_profit) as profit\n from web_sales,\n      date_dim,\n      web_page\n where ws_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date)\n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY)\n       and ws_web_page_sk = wp_web_page_sk\n group by wp_web_page_sk), \n wr as\n (select wp_web_page_sk,\n        sum(wr_return_amt) as \"returns\",\n        sum(wr_net_loss) as profit_loss\n from web_returns,\n      date_dim,\n      web_page\n where wr_returned_date_sk = d_date_sk\n       and d_date between cast('1998-08-05' as date)\n                  and (cast('1998-08-05' as date) + INTERVAL 30 DAY)\n       and wr_web_page_sk = wp_web_page_sk\n group by wp_web_page_sk)\n  select channel\n        , id\n        , sum(sales) as sales\n        , sum(\"returns\") as \"returns\"\n        , sum(profit) as profit\n from \n (select 'store channel' as channel\n        , ss.s_store_sk as id\n        , sales\n        , coalesce(\"returns\", 0) as \"returns\"\n        , (profit - coalesce(profit_loss,0)) as profit\n from   ss left join sr\n        on  ss.s_store_sk = sr.s_store_sk\n union all\n select 'catalog channel' as channel\n        , cs_call_center_sk as id\n        , sales\n        , \"returns\"\n        , (profit - profit_loss) as profit\n from  cs\n       , cr\n union all\n select 'web channel' as channel\n        , ws.wp_web_page_sk as id\n        , sales\n        , coalesce(\"returns\", 0) AS \"returns\"\n        , (profit - coalesce(profit_loss,0)) as profit\n from   ws left join wr\n        on  ws.wp_web_page_sk = wr.wp_web_page_sk\n ) x\n group by rollup (channel, id)\n order by channel\n         ,id\n LIMIT 100;\n\n-- end query 77 in stream 0 using template query77.tpl\n",
  "optimized_sql": "WITH ss AS (SELECT s_store_sk, SUM(ss_ext_sales_price) AS sales, SUM(ss_net_profit) AS profit FROM store_sales, date_dim, store WHERE ss_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) AND ss_store_sk = s_store_sk GROUP BY s_store_sk), sr AS (SELECT s_store_sk, SUM(sr_return_amt) AS \"returns\", SUM(sr_net_loss) AS profit_loss FROM store_returns, date_dim, store WHERE sr_returned_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) AND sr_store_sk = s_store_sk GROUP BY s_store_sk), cs AS (SELECT cs_call_center_sk, SUM(cs_ext_sales_price) AS sales, SUM(cs_net_profit) AS profit FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) GROUP BY cs_call_center_sk), cr AS (SELECT cr_call_center_sk, SUM(cr_return_amount) AS \"returns\", SUM(cr_net_loss) AS profit_loss FROM catalog_returns, date_dim WHERE cr_returned_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) GROUP BY cr_call_center_sk), ws AS (SELECT wp_web_page_sk, SUM(ws_ext_sales_price) AS sales, SUM(ws_net_profit) AS profit FROM web_sales, date_dim, web_page WHERE ws_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) AND ws_web_page_sk = wp_web_page_sk GROUP BY wp_web_page_sk), wr AS (SELECT wp_web_page_sk, SUM(wr_return_amt) AS \"returns\", SUM(wr_net_loss) AS profit_loss FROM web_returns, date_dim, web_page WHERE wr_returned_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) AND wr_web_page_sk = wp_web_page_sk GROUP BY wp_web_page_sk) SELECT channel, id, SUM(sales) AS sales, SUM(\"returns\") AS \"returns\", SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, ss.s_store_sk AS id, sales, COALESCE(\"returns\", 0) AS \"returns\", (profit - COALESCE(profit_loss, 0)) AS profit FROM ss LEFT JOIN sr ON ss.s_store_sk = sr.s_store_sk UNION ALL SELECT 'catalog channel' AS channel, cs_call_center_sk AS id, sales, \"returns\", (profit - profit_loss) AS profit FROM cs, cr UNION ALL SELECT 'web channel' AS channel, ws.wp_web_page_sk AS id, sales, COALESCE(\"returns\", 0) AS \"returns\", (profit - COALESCE(profit_loss, 0)) AS profit FROM ws LEFT JOIN wr ON ws.wp_web_page_sk = wr.wp_web_page_sk) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100",
  "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"projection_prune\",\n      \"nodes\": {\n        \"ss\": \"SELECT ss_store_sk AS s_store_sk, SUM(ss_ext_sales_price) AS sales, SUM(ss_net_profit) AS profit FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) GROUP BY ss_store_sk\",\n        \"sr\": \"SELECT sr_store_sk AS s_store_sk, SUM(sr_return_amt) AS \\\"returns\\\", SUM(sr_net_loss) AS profit_loss FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL '30' DAY) GROUP BY sr_store_sk\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"grain preserved (grouped by store_sk)\",\n        \"same result rows assuming referential integrity\"\n      ],\n      \"expected_speedup\": \"1.8x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Removed unnecessary joins to the store dimension table from both [ss] and [sr] CTEs. Since the queries only select s_store_sk (the join key) and aggregate measures, and do not filter on or select any other store attributes, the join is redundant. The foreign key ss_store_sk/sr_store_sk from the fact tables provides the same grouping key, eliminating the need to join with the store table while preserving output schema and semantics.\"\n}\n```",
  "error": null,
  "latency_ms": 128571.56108499476,
  "tokens_in": 2805,
  "tokens_out": 6526
}