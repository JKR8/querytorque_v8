WITH quantity_1_20_stats AS (SELECT COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_ext_discount_amt, AVG(ss_net_paid) AS avg_net_paid FROM store_sales WHERE ss_quantity BETWEEN 1 AND 20), quantity_21_40_stats AS (SELECT COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_ext_discount_amt, AVG(ss_net_paid) AS avg_net_paid FROM store_sales WHERE ss_quantity BETWEEN 21 AND 40), quantity_41_60_stats AS (SELECT COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_ext_discount_amt, AVG(ss_net_paid) AS avg_net_paid FROM store_sales WHERE ss_quantity BETWEEN 41 AND 60), quantity_61_80_stats AS (SELECT COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_ext_discount_amt, AVG(ss_net_paid) AS avg_net_paid FROM store_sales WHERE ss_quantity BETWEEN 61 AND 80), quantity_81_100_stats AS (SELECT COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_ext_discount_amt, AVG(ss_net_paid) AS avg_net_paid FROM store_sales WHERE ss_quantity BETWEEN 81 AND 100)
SELECT CASE WHEN q1.cnt > 74129 THEN q1.avg_ext_discount_amt ELSE q1.avg_net_paid END AS bucket1, CASE WHEN q2.cnt > 122840 THEN q2.avg_ext_discount_amt ELSE q2.avg_net_paid END AS bucket2, CASE WHEN q3.cnt > 56580 THEN q3.avg_ext_discount_amt ELSE q3.avg_net_paid END AS bucket3, CASE WHEN q4.cnt > 10097 THEN q4.avg_ext_discount_amt ELSE q4.avg_net_paid END AS bucket4, CASE WHEN q5.cnt > 165306 THEN q5.avg_ext_discount_amt ELSE q5.avg_net_paid END AS bucket5 FROM reason CROSS JOIN quantity_1_20_stats AS q1 CROSS JOIN quantity_21_40_stats AS q2 CROSS JOIN quantity_41_60_stats AS q3 CROSS JOIN quantity_61_80_stats AS q4 CROSS JOIN quantity_81_100_stats AS q5 WHERE r_reason_sk = 1