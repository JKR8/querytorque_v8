WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_dow = 1 AND d_year IN (1999, 2000, 2001)), store_filtered AS (SELECT s_store_sk, s_city FROM store WHERE s_number_employees BETWEEN 200 AND 295), hd_branch1 AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count = 6), hd_branch2 AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_vehicle_count > 2 AND hd_dep_count <> 6), branch1_data AS (SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, sf.s_city, ss_coupon_amt, ss_net_profit FROM store_sales AS ss JOIN date_filtered AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN store_filtered AS sf ON ss.ss_store_sk = sf.s_store_sk JOIN hd_branch1 AS hd1 ON ss.ss_hdemo_sk = hd1.hd_demo_sk), branch2_data AS (SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, sf.s_city, ss_coupon_amt, ss_net_profit FROM store_sales AS ss JOIN date_filtered AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN store_filtered AS sf ON ss.ss_store_sk = sf.s_store_sk JOIN hd_branch2 AS hd2 ON ss.ss_hdemo_sk = hd2.hd_demo_sk), ms AS (SELECT ss_ticket_number, ss_customer_sk, s_city, SUM(ss_coupon_amt) AS amt, SUM(ss_net_profit) AS profit FROM (SELECT * FROM branch1_data UNION ALL SELECT * FROM branch2_data) AS union_data GROUP BY ss_ticket_number, ss_customer_sk, ss_addr_sk, s_city)
SELECT c_last_name, c_first_name, SUBSTRING(s_city, 1, 30), ss_ticket_number, amt, profit FROM ms JOIN customer ON ms.ss_customer_sk = customer.c_customer_sk ORDER BY c_last_name NULLS FIRST, c_first_name NULLS FIRST, SUBSTRING(s_city, 1, 30) NULLS FIRST, profit NULLS FIRST, ss_ticket_number LIMIT 100