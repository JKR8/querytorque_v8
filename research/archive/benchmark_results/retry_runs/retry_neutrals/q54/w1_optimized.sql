WITH base_month_seq AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 12), dec_1998_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 12), next_three_months_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN (SELECT d_month_seq FROM base_month_seq) + 1 AND (SELECT d_month_seq FROM base_month_seq) + 3), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk FROM web_sales) AS cs_or_ws_sales JOIN dec_1998_dates AS d ON cs_or_ws_sales.sold_date_sk = d.d_date_sk JOIN item AS i ON cs_or_ws_sales.item_sk = i.i_item_sk JOIN customer AS c ON cs_or_ws_sales.customer_sk = c.c_customer_sk WHERE i.i_category = 'Women' AND i.i_class = 'maternity'), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers AS mc JOIN store_sales AS ss ON mc.c_customer_sk = ss.ss_customer_sk JOIN customer_address AS ca ON mc.c_current_addr_sk = ca.ca_address_sk JOIN store AS s ON ca.ca_county = s.s_county AND ca.ca_state = s.s_state JOIN next_three_months_dates AS nd ON ss.ss_sold_date_sk = nd.d_date_sk GROUP BY c_customer_sk), segments AS (SELECT CAST(ROUND(revenue / 50) AS INT) AS SEGMENT FROM my_revenue)
SELECT SEGMENT, COUNT(*) AS num_customers, SEGMENT * 50 AS segment_base FROM segments GROUP BY SEGMENT ORDER BY SEGMENT NULLS FIRST, num_customers NULLS FIRST, segment_base LIMIT 100