```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_d1": "SELECT d_date_sk, d_date, d_week_seq FROM date_dim WHERE d_year = 1999",
        "filtered_d2": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM filtered_d1)",
        "filtered_d3": "SELECT d_date_sk, d_date FROM date_dim",
        "filtered_cd": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D'",
        "filtered_hd": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'",
        "main_query": "SELECT i_item_desc, w_warehouse_name, fd1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales cs JOIN filtered_d1 fd1 ON cs.cs_sold_date_sk = fd1.d_date_sk JOIN filtered_d2 fd2 ON fd1.d_week_seq = fd2.d_week_seq JOIN filtered_d3 fd3 ON cs.cs_ship_date_sk = fd3.d_date_sk AND fd3.d_date > fd1.d_date + 5 JOIN inventory inv ON inv.inv_item_sk = cs.cs_item_sk AND inv.inv_date_sk = fd2.d_date_sk AND inv.inv_quantity_on_hand < cs.cs_quantity JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN item i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk LEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number GROUP BY i_item_desc, w_warehouse_name, fd1.d_week_seq ORDER BY total_cnt DESC NULLS FIRST, i_item_desc NULLS FIRST, w_warehouse_name NULLS FIRST, fd1.d_week_seq NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same grouping grain"
      ],
      "expected_speedup": "3.2x",
      "risk": "medium"
    },
    {
      "id": "rs_02",
      "transform": "early_filter",
      "nodes": {
        "filtered_facts": "SELECT cs_item_sk, cs_sold_date_sk, cs_ship_date_sk, cs_quantity, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk, cs_order_number FROM catalog_sales cs JOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_d1 fd1 ON cs.cs_sold_date_sk = fd1.d_date_sk WHERE EXISTS (SELECT 1 FROM filtered_d2 fd2 WHERE fd2.d_week_seq = fd1.d_week_seq) AND EXISTS (SELECT 1 FROM filtered_d3 fd3 WHERE cs.cs_ship_date_sk = fd3.d_date_sk AND fd3.d_date > fd1.d_date + 5)",
        "main_query": "SELECT i_item_desc, w_warehouse_name, fd1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_facts ff JOIN filtered_d1 fd1 ON ff.cs_sold_date_sk = fd1.d_date_sk JOIN inventory inv ON inv.inv_item_sk = ff.cs_item_sk AND EXISTS (SELECT 1 FROM filtered_d2 fd2 WHERE inv.inv_date_sk = fd2.d_date_sk AND fd2.d_week_seq = fd1.d_week_seq) AND inv.inv_quantity_on_hand < ff.cs_quantity JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN item i ON i.i_item_sk = ff.cs_item_sk LEFT OUTER JOIN promotion p ON ff.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = ff.cs_item_sk AND cr.cr_order_number = ff.cs_order_number GROUP BY i_item_desc, w_warehouse_name, fd1.d_week_seq ORDER BY total_cnt DESC NULLS FIRST, i_item_desc NULLS FIRST, w_warehouse_name NULLS FIRST, fd1.d_week_seq NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same grouping grain"
      ],
      "expected_speedup": "1.8x",
      "risk": "high"
    }
  ],
  "explanation": "rs_01: Isolate date_dim filters into CTEs early. Filter d2 by week_seq from d1 (since they must match). Apply d3 filter as join condition. This reduces the date_dim scans from 3 sequential scans to 1 filtered scan and 2 filtered CTEs. rs_02: Push dimension filters (customer_demographics, household_demographics, d1, d2, d3) early into catalog_sales via a CTE, reducing the fact table rows before expensive joins. This is higher risk due to complexity but could yield additional speedup when combined with rs_01."
}
```