WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000), filtered_reason AS (SELECT r_reason_sk, SUBSTRING(r_reason_desc, 1, 20) AS r_reason_desc_short FROM reason), filtered_customer_address_1 AS (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('IN', 'OH', 'NJ')), filtered_customer_address_2 AS (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('WI', 'CT', 'KY')), filtered_customer_address_3 AS (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('LA', 'IA', 'AR')), filtered_cd_status_m AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree'), filtered_cd_status_s AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_education_status = 'College'), filtered_cd_status_w AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'W' AND cd_education_status = '2 yr Degree'), branch_m_in AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_1 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_m AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_m AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 100.00 AND 150.00 AND ws.ws_net_profit BETWEEN 100 AND 200), branch_m_wi AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_2 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_m AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_m AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 100.00 AND 150.00 AND ws.ws_net_profit BETWEEN 150 AND 300), branch_m_la AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_3 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_m AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_m AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 100.00 AND 150.00 AND ws.ws_net_profit BETWEEN 50 AND 250), branch_s_in AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_1 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_s AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_s AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 50.00 AND 100.00 AND ws.ws_net_profit BETWEEN 100 AND 200), branch_s_wi AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_2 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_s AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_s AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 50.00 AND 100.00 AND ws.ws_net_profit BETWEEN 150 AND 300), branch_s_la AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_3 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_s AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_s AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 50.00 AND 100.00 AND ws.ws_net_profit BETWEEN 50 AND 250), branch_w_in AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_1 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_w AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_w AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 150.00 AND 200.00 AND ws.ws_net_profit BETWEEN 100 AND 200), branch_w_wi AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_2 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_w AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_w AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 150.00 AND 200.00 AND ws.ws_net_profit BETWEEN 150 AND 300), branch_w_la AS (SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc_short FROM web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN filtered_customer_address_3 AS ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN filtered_cd_status_w AS cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd_status_w AS cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN filtered_reason AS r ON wr.wr_reason_sk = r.r_reason_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE ws.ws_sales_price BETWEEN 150.00 AND 200.00 AND ws.ws_net_profit BETWEEN 50 AND 250)
SELECT r_reason_desc_short, AVG(ws_quantity) AS avg1, AVG(wr_refunded_cash) AS avg2, AVG(wr_fee) FROM (SELECT * FROM branch_m_in UNION ALL SELECT * FROM branch_m_wi UNION ALL SELECT * FROM branch_m_la UNION ALL SELECT * FROM branch_s_in UNION ALL SELECT * FROM branch_s_wi UNION ALL SELECT * FROM branch_s_la UNION ALL SELECT * FROM branch_w_in UNION ALL SELECT * FROM branch_w_wi UNION ALL SELECT * FROM branch_w_la) AS all_branches GROUP BY r_reason_desc_short ORDER BY r_reason_desc_short, AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100