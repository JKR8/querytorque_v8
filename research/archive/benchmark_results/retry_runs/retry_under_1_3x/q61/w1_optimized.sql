WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 11), item_filter AS (SELECT i_item_sk FROM item WHERE i_category = 'Jewelry'), store_filter AS (SELECT s_store_sk FROM store WHERE s_gmt_offset = -5), address_filter AS (SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -5), promotion_filter_dmail AS (SELECT p_promo_sk FROM promotion WHERE p_channel_dmail = 'Y'), promotion_filter_email AS (SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'Y'), promotion_filter_tv AS (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'Y'), base_sales AS (SELECT ss_ext_sales_price, ss_promo_sk, ss_customer_sk, ss_item_sk, ss_store_sk, ss_sold_date_sk FROM store_sales), promotional_sales AS (SELECT SUM(ss_ext_sales_price) AS promotions FROM base_sales AS bs JOIN date_filter AS df ON bs.ss_sold_date_sk = df.d_date_sk JOIN store_filter AS sf ON bs.ss_store_sk = sf.s_store_sk JOIN item_filter AS itf ON bs.ss_item_sk = itf.i_item_sk JOIN customer AS c ON bs.ss_customer_sk = c.c_customer_sk JOIN address_filter AS af ON c.c_current_addr_sk = af.ca_address_sk WHERE bs.ss_promo_sk IN (SELECT p_promo_sk FROM promotion_filter_dmail UNION SELECT p_promo_sk FROM promotion_filter_email UNION SELECT p_promo_sk FROM promotion_filter_tv)), all_sales AS (SELECT SUM(ss_ext_sales_price) AS total FROM base_sales AS bs JOIN date_filter AS df ON bs.ss_sold_date_sk = df.d_date_sk JOIN store_filter AS sf ON bs.ss_store_sk = sf.s_store_sk JOIN item_filter AS itf ON bs.ss_item_sk = itf.i_item_sk JOIN customer AS c ON bs.ss_customer_sk = c.c_customer_sk JOIN address_filter AS af ON c.c_current_addr_sk = af.ca_address_sk)
SELECT ps.promotions, als.total, CAST(ps.promotions AS DECIMAL(15, 4)) / CAST(als.total AS DECIMAL(15, 4)) * 100 FROM promotional_sales AS ps CROSS JOIN all_sales AS als ORDER BY ps.promotions, als.total LIMIT 100