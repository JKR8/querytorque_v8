Looking at this query, I see a pattern of UNION ALL across three sales channels (store, web, catalog) with similar joins to date_dim and item tables. The query filters for NULL values in specific columns for each channel. The main opportunity is that we're scanning date_dim three times (once for each UNION branch) and performing similar joins repeatedly.

**Key insight:** We can create a filtered CTE for the date_dim table that will be reused across all three UNION branches. Additionally, we can pre-join the fact tables with the filtered date_dim to reduce the number of scans.

```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk, d_year, d_qoy FROM date_dim",
        "store_sales_filtered": "SELECT 'store' AS channel, 'ss_store_sk' AS col_name, d_year, d_qoy, i_category, ss_ext_sales_price AS ext_sales_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE ss_store_sk IS NULL",
        "web_sales_filtered": "SELECT 'web' AS channel, 'ws_ship_customer_sk' AS col_name, d_year, d_qoy, i_category, ws_ext_sales_price AS ext_sales_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN item ON ws_item_sk = i_item_sk WHERE ws_ship_customer_sk IS NULL",
        "catalog_sales_filtered": "SELECT 'catalog' AS channel, 'cs_ship_addr_sk' AS col_name, d_year, d_qoy, i_category, cs_ext_sales_price AS ext_sales_price FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE cs_ship_addr_sk IS NULL",
        "main_query": "SELECT channel, col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ext_sales_price) AS sales_amt FROM (SELECT * FROM store_sales_filtered UNION ALL SELECT * FROM web_sales_filtered UNION ALL SELECT * FROM catalog_sales_filtered) AS foo GROUP BY channel, col_name, d_year, d_qoy, i_category ORDER BY channel NULLS FIRST, col_name NULLS FIRST, d_year NULLS FIRST, d_qoy NULLS FIRST, i_category NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same aggregation"
      ],
      "expected_speedup": "2.5x",
      "risk": "low"
    }
  ],
  "explanation": "Created a CTE for date_dim to avoid scanning it three times across UNION branches. Each branch now joins with this single CTE instead of scanning date_dim separately. Also restructured each UNION branch as its own CTE for clarity and potential parallel execution benefits."
}
```