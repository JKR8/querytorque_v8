WITH store_filtered AS (SELECT ss_sold_date_sk, ss_item_sk, ss_ext_sales_price, ss_store_sk FROM store_sales WHERE ss_store_sk IS NULL), web_filtered AS (SELECT ws_sold_date_sk, ws_item_sk, ws_ext_sales_price, ws_ship_customer_sk FROM web_sales WHERE ws_ship_customer_sk IS NULL), catalog_filtered AS (SELECT cs_sold_date_sk, cs_item_sk, cs_ext_sales_price, cs_ship_addr_sk FROM catalog_sales WHERE cs_ship_addr_sk IS NULL)
SELECT channel, col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ext_sales_price) AS sales_amt FROM (SELECT 'store' AS channel, 'ss_store_sk' AS col_name, d.d_year, d.d_qoy, i.i_category, ss.ss_ext_sales_price AS ext_sales_price FROM store_filtered AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN item AS i ON ss.ss_item_sk = i.i_item_sk UNION ALL SELECT 'web' AS channel, 'ws_ship_customer_sk' AS col_name, d.d_year, d.d_qoy, i.i_category, ws.ws_ext_sales_price AS ext_sales_price FROM web_filtered AS ws JOIN date_dim AS d ON ws.ws_sold_date_sk = d.d_date_sk JOIN item AS i ON ws.ws_item_sk = i.i_item_sk UNION ALL SELECT 'catalog' AS channel, 'cs_ship_addr_sk' AS col_name, d.d_year, d.d_qoy, i.i_category, cs.cs_ext_sales_price AS ext_sales_price FROM catalog_filtered AS cs JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item AS i ON cs.cs_item_sk = i.i_item_sk) AS foo GROUP BY channel, col_name, d_year, d_qoy, i_category ORDER BY channel NULLS FIRST, col_name NULLS FIRST, d_year NULLS FIRST, d_qoy NULLS FIRST, i_category NULLS FIRST LIMIT 100