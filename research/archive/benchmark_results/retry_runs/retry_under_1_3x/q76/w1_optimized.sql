WITH filtered_dates AS (SELECT d_date_sk, d_year, d_qoy FROM date_dim), store_filtered AS (SELECT ss_ext_sales_price, d_year, d_qoy, i_category, 'store' AS channel, 'ss_store_sk' AS col_name FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE ss_store_sk IS NULL), web_filtered AS (SELECT ws_ext_sales_price, d_year, d_qoy, i_category, 'web' AS channel, 'ws_ship_customer_sk' AS col_name FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN item ON ws_item_sk = i_item_sk WHERE ws_ship_customer_sk IS NULL), catalog_filtered AS (SELECT cs_ext_sales_price, d_year, d_qoy, i_category, 'catalog' AS channel, 'cs_ship_addr_sk' AS col_name FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE cs_ship_addr_sk IS NULL)
SELECT channel, col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ext_sales_price) AS sales_amt FROM (SELECT * FROM store_filtered UNION ALL SELECT * FROM web_filtered UNION ALL SELECT * FROM catalog_filtered) AS foo GROUP BY channel, col_name, d_year, d_qoy, i_category ORDER BY channel NULLS FIRST, col_name NULLS FIRST, d_year NULLS FIRST, d_qoy NULLS FIRST, i_category NULLS FIRST LIMIT 100