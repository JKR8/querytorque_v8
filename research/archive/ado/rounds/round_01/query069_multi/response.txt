```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "main_query": "WITH filtered_dates AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 2002\n    AND d_moy BETWEEN 3 AND 3 + 2\n), \nstore_customers AS (\n  SELECT DISTINCT ss_customer_sk\n  FROM store_sales\n  JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk\n  WHERE ss_list_price BETWEEN 100 AND 189\n),\nweb_customers AS (\n  SELECT DISTINCT ws_bill_customer_sk\n  FROM web_sales\n  JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk\n  WHERE ws_list_price BETWEEN 100 AND 189\n),\ncatalog_customers AS (\n  SELECT DISTINCT cs_ship_customer_sk\n  FROM catalog_sales\n  JOIN filtered_dates ON catalog_sales.cs_sold_date_sk = filtered_dates.d_date_sk\n  WHERE cs_list_price BETWEEN 100 AND 189\n)\nSELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3 \nFROM customer AS c\nJOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk\nWHERE ca_state IN ('IA', 'MO', 'TX') \n  AND cd_marital_status IN ('S', 'S', 'S') \n  AND cd_education_status IN ('Primary', 'Secondary')\n  AND c.c_customer_sk IN (SELECT ss_customer_sk FROM store_customers)\n  AND c.c_customer_sk NOT IN (SELECT ws_bill_customer_sk FROM web_customers)\n  AND c.c_customer_sk NOT IN (SELECT cs_ship_customer_sk FROM catalog_customers)\nGROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating \nORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating \nLIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "grouping grain unchanged",
        "literal values preserved exactly",
        "semantics of EXISTS/NOT EXISTS preserved via IN/NOT IN"
      ],
      "expected_speedup": "3x",
      "risk": "low"
    }
  ],
  "explanation": "Isolated date_dim filter into a CTE (filtered_dates) to compute date keys once, then created separate CTEs for each sales channel (store, web, catalog) that join fact tables with filtered_dates early. This allows: 1) Date predicate evaluation once instead of three times, 2) Early filtering of fact tables by price range, 3) Conversion of correlated EXISTS to IN/NOT IN with precomputed customer sets, reducing join complexity. The CTEs return distinct customer keys, preserving semantics while enabling better join ordering and predicate pushdown."
}
```