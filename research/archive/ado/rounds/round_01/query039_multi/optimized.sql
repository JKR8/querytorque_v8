WITH inv AS (WITH date_filtered AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002 AND d_moy IN (10, 11)), item_filtered AS (SELECT i_item_sk FROM item WHERE i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 25 AND 44) SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, cov FROM (SELECT MAX(w.w_warehouse_name) AS w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, df.d_moy, STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev, AVG(inv.inv_quantity_on_hand) AS mean FROM inventory AS inv JOIN date_filtered AS df ON inv.inv_date_sk = df.d_date_sk JOIN item_filtered AS i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse AS w ON inv.inv_warehouse_sk = w.w_warehouse_sk WHERE inv.inv_quantity_on_hand BETWEEN 140 AND 340 GROUP BY w.w_warehouse_sk, i.i_item_sk, df.d_moy) AS foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1)
SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv AS inv1, inv AS inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 10 AND inv2.d_moy = 10 + 1 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov