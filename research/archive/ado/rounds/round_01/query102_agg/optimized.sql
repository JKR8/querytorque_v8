WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2002), filtered_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('GA', 'MD', 'MO', 'NC', 'OR')), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Home', 'Men', 'Music') AND i_manager_id IN (1, 2, 4, 11, 12, 14, 21, 29, 32, 52)), filtered_inventory AS (SELECT inv_warehouse_sk, inv_item_sk, inv_date_sk, inv_quantity_on_hand FROM inventory WHERE inv_quantity_on_hand >= 0), store_sales_base AS (SELECT ss_item_sk, ss_sold_date_sk, ss_customer_sk, ss_quantity FROM store_sales WHERE ss_item_sk IN (SELECT i_item_sk FROM filtered_item) AND ss_sold_date_sk IN (SELECT d_date_sk FROM filtered_dates)) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM store_sales_base AS ss JOIN web_sales AS ws ON ss.ss_item_sk = ws.ws_item_sk JOIN filtered_dates AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON ws.ws_sold_date_sk = d2.d_date_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk AND ws.ws_bill_customer_sk = c.c_customer_sk JOIN filtered_inventory AS inv ON inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk AND inv.inv_quantity_on_hand >= ss.ss_quantity JOIN store AS s ON inv.inv_warehouse_sk = s.s_warehouse_sk JOIN warehouse AS w ON ws.ws_warehouse_sk = w.w_warehouse_sk AND s.s_state = w.w_state JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN filtered_customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') AND ws.ws_wholesale_cost BETWEEN 34 AND 54 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt