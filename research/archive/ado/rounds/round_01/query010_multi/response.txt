```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "main_query": "WITH date_filter AS (\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_year = 1998\n      AND d_moy BETWEEN 4 AND 4 + 3\n),\nitem_filter AS (\n    SELECT i_item_sk\n    FROM item\n    WHERE i_category IN ('Children', 'Electronics', 'Men')\n      AND i_manager_id BETWEEN 51 AND 60\n),\nstore_customers AS (\n    SELECT DISTINCT ss_customer_sk\n    FROM store_sales\n    INNER JOIN date_filter ON ss_sold_date_sk = d_date_sk\n    INNER JOIN item_filter ON ss_item_sk = i_item_sk\n    WHERE ss_sales_price / ss_list_price BETWEEN 11 * 0.01 AND 21 * 0.01\n),\nweb_or_catalog_customers AS (\n    SELECT ws_bill_customer_sk AS customer_sk\n    FROM web_sales\n    INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk\n    INNER JOIN item_filter ON ws_item_sk = i_item_sk\n    WHERE ws_sales_price / ws_list_price BETWEEN 11 * 0.01 AND 21 * 0.01\n    UNION ALL\n    SELECT cs_ship_customer_sk AS customer_sk\n    FROM catalog_sales\n    INNER JOIN date_filter ON cs_sold_date_sk = d_date_sk\n    INNER JOIN item_filter ON cs_item_sk = i_item_sk\n    WHERE cs_sales_price / cs_list_price BETWEEN 11 * 0.01 AND 21 * 0.01\n)\nSELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6\nFROM customer AS c\nINNER JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk\nINNER JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk\nWHERE ca_county IN ('Hickman County', 'Ohio County', 'Parke County', 'Pointe Coupee Parish', 'Siskiyou County')\n  AND c.c_birth_month IN (3, 8)\n  AND cd_marital_status IN ('S', 'U', 'M')\n  AND cd_education_status IN ('Secondary', 'Advanced Degree', '4 yr Degree')\n  AND cd_gender = 'M'\n  AND EXISTS (SELECT 1 FROM store_customers WHERE ss_customer_sk = c.c_customer_sk)\n  AND EXISTS (SELECT 1 FROM web_or_catalog_customers WHERE customer_sk = c.c_customer_sk)\nGROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\nORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\nLIMIT 100"
      },
      "invariants_kept": [
        "Same output columns and grouping",
        "Same filtering logic with literal preservation",
        "Same EXISTS semantics",
        "Same OR logic preserved via UNION ALL"
      ],
      "expected_speedup": "3x",
      "risk": "medium"
    }
  ],
  "explanation": "1. Applied date_cte_isolate: Created reusable CTEs for date_dim and item filters to avoid repeated joins.\n2. Created pre-aggregated customer sets for store_sales and (web_sales OR catalog_sales).\n3. Used UNION ALL for the OR condition as it has only 2 simple branches (web_sales and catalog_sales), which is within OR_TO_UNION_LIMIT constraints.\n4. Preserved all literal values exactly as in original query.\n5. Maintained EXISTS semantics while reducing correlation complexity.\n6. Early filtering in CTEs reduces join sizes before main customer joins."
}
```