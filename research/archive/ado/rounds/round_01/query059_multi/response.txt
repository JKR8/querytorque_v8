```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate, pushdown",
      "nodes": {
        "wss": "WITH filtered_stores AS (\n  SELECT s_store_sk\n  FROM store\n  WHERE s_state IN ('GA', 'IA', 'LA', 'MO', 'SD', 'TN', 'TX', 'VA')\n),\nfiltered_dates AS (\n  SELECT d_date_sk, d_week_seq, d_day_name\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1208 AND 1208 + 23\n)\nSELECT d_week_seq, ss_store_sk,\n       SUM(CASE WHEN (d_day_name = 'Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales,\n       SUM(CASE WHEN (d_day_name = 'Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales,\n       SUM(CASE WHEN (d_day_name = 'Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales,\n       SUM(CASE WHEN (d_day_name = 'Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales,\n       SUM(CASE WHEN (d_day_name = 'Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales,\n       SUM(CASE WHEN (d_day_name = 'Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales,\n       SUM(CASE WHEN (d_day_name = 'Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales\nFROM store_sales\nJOIN filtered_dates ON d_date_sk = ss_sold_date_sk\nJOIN filtered_stores ON ss_store_sk = s_store_sk\nWHERE ss_sales_price / ss_list_price BETWEEN 11 * 0.01 AND 31 * 0.01\nGROUP BY d_week_seq, ss_store_sk"
      },
      "invariants_kept": [
        "output_columns",
        "grain",
        "required_predicates",
        "literal values unchanged"
      ],
      "expected_speedup": "2x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "pushdown, reorder_join",
      "nodes": {
        "main_query": "WITH wss AS (\n  SELECT d_week_seq, ss_store_sk,\n         SUM(CASE WHEN (d_day_name = 'Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales,\n         SUM(CASE WHEN (d_day_name = 'Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales,\n         SUM(CASE WHEN (d_day_name = 'Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales,\n         SUM(CASE WHEN (d_day_name = 'Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales,\n         SUM(CASE WHEN (d_day_name = 'Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales,\n         SUM(CASE WHEN (d_day_name = 'Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales,\n         SUM(CASE WHEN (d_day_name = 'Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales\n  FROM store_sales, date_dim\n  WHERE d_date_sk = ss_sold_date_sk\n    AND ss_sales_price / ss_list_price BETWEEN 11 * 0.01 AND 31 * 0.01\n  GROUP BY d_week_seq, ss_store_sk\n),\nfiltered_stores AS (\n  SELECT s_store_sk, s_store_id, s_store_name\n  FROM store\n  WHERE s_state IN ('GA', 'IA', 'LA', 'MO', 'SD', 'TN', 'TX', 'VA')\n)\nSELECT s_store_name1, s_store_id1, d_week_seq1,\n       sun_sales1 / sun_sales2,\n       mon_sales1 / mon_sales2,\n       tue_sales1 / tue_sales2,\n       wed_sales1 / wed_sales2,\n       thu_sales1 / thu_sales2,\n       fri_sales1 / fri_sales2,\n       sat_sales1 / sat_sales2\nFROM (\n  SELECT s_store_name AS s_store_name1,\n         wss.d_week_seq AS d_week_seq1,\n         s_store_id AS s_store_id1,\n         sun_sales AS sun_sales1,\n         mon_sales AS mon_sales1,\n         tue_sales AS tue_sales1,\n         wed_sales AS wed_sales1,\n         thu_sales AS thu_sales1,\n         fri_sales AS fri_sales1,\n         sat_sales AS sat_sales1\n  FROM wss\n  JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  JOIN date_dim AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d_month_seq BETWEEN 1208 AND 1208 + 11\n) AS y,\n(\n  SELECT s_store_name AS s_store_name2,\n         wss.d_week_seq AS d_week_seq2,\n         s_store_id AS s_store_id2,\n         sun_sales AS sun_sales2,\n         mon_sales AS mon_sales2,\n         tue_sales AS tue_sales2,\n         wed_sales AS wed_sales2,\n         thu_sales AS thu_sales2,\n         fri_sales AS fri_sales2,\n         sat_sales AS sat_sales2\n  FROM wss\n  JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  JOIN date_dim AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d_month_seq BETWEEN 1208 + 12 AND 1208 + 23\n) AS x\nWHERE s_store_id1 = s_store_id2\n  AND d_week_seq1 = d_week_seq2 - 52\nORDER BY s_store_name1, s_store_id1, d_week_seq1\nLIMIT 100"
      },
      "invariants_kept": [
        "output_columns",
        "required_predicates",
        "literal values unchanged"
      ],
      "expected_speedup": "1.5x",
      "risk": "low"
    }
  ],
  "explanation": "Applied two complementary optimizations: 1) For the wss CTE, isolated date_dim and store filters into separate CTEs and joined them early with store_sales to reduce rows before aggregation (QT-OPT-003 pattern). 2) For the main query, pushed the s_state filter into a filtered_stores CTE and reordered joins to filter stores early before joining with date_dim and wss. Both rewrites preserve exact literal values and avoid over-splitting OR conditions."
}
```