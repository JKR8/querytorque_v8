```sql
WITH date_dim_store AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_year IN (2000, 2001, 2002, 2003)
), date_dim_main AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_year = 2000 AND d_moy = 5
), store_sales_filtered AS (
    SELECT
        ss_item_sk,
        ss_customer_sk,
        ss_quantity,
        ss_sales_price
    FROM store_sales
    JOIN date_dim_store ON ss_sold_date_sk = d_date_sk
), frequent_ss_items AS (
    SELECT DISTINCT i_item_sk AS item_sk
    FROM store_sales_filtered
    JOIN item ON ss_item_sk = i_item_sk
    GROUP BY i_item_sk, SUBSTRING(i_item_desc, 1, 30), d_date
    HAVING COUNT(*) > 4
), customer_store_sales AS (
    SELECT
        c_customer_sk,
        SUM(ss_quantity * ss_sales_price) AS csales
    FROM store_sales_filtered
    JOIN customer ON ss_customer_sk = c_customer_sk
    GROUP BY c_customer_sk
), max_store_sales AS (
    SELECT MAX(csales) AS tpcds_cmax
    FROM customer_store_sales
), best_ss_customer AS (
    SELECT DISTINCT c_customer_sk
    FROM customer_store_sales
    WHERE csales > (95 / 100.0) * (SELECT tpcds_cmax FROM max_store_sales)
)
SELECT SUM(sales)
FROM (
    SELECT cs_quantity * cs_list_price AS sales
    FROM catalog_sales
    JOIN date_dim_main ON cs_sold_date_sk = d_date_sk
    JOIN frequent_ss_items ON cs_item_sk = item_sk
    JOIN best_ss_customer ON cs_bill_customer_sk = c_customer_sk
    UNION ALL
    SELECT ws_quantity * ws_list_price AS sales
    FROM web_sales
    JOIN date_dim_main ON ws_sold_date_sk = d_date_sk
    JOIN frequent_ss_items ON ws_item_sk = item_sk
    JOIN best_ss_customer ON ws_bill_customer_sk = c_customer_sk
)
LIMIT 100;
```

```
Changes: Isolated date dimensions into CTEs, computed store_sales aggregations in single pass with filtered dates, converted IN subqueries to hash joins with materialized frequent_ss_items and best_ss_customer tables.
Expected speedup: 2-3x from reduced store_sales scans, efficient hash joins, and date dimension reuse.
```