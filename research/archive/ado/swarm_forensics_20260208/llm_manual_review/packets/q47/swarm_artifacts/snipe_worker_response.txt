```sql
WITH filtered_dates AS (
    SELECT d_date_sk, d_year, d_moy
    FROM date_dim
    WHERE (d_year = 2001)
       OR (d_year = 2000 AND d_moy = 12)
       OR (d_year = 2002 AND d_moy = 1)
),
v1 AS (
    SELECT
        i_category,
        i_brand,
        s_store_name,
        s_company_name,
        d_year,
        d_moy,
        SUM(ss_sales_price) AS sum_sales,
        AVG(SUM(ss_sales_price)) OVER (
            PARTITION BY i_category, i_brand, s_store_name, s_company_name, d_year
        ) AS avg_monthly_sales,
        RANK() OVER (
            PARTITION BY i_category, i_brand, s_store_name, s_company_name
            ORDER BY d_year, d_moy
        ) AS rn,
        LAG(SUM(ss_sales_price)) OVER (
            PARTITION BY i_category, i_brand, s_store_name, s_company_name
            ORDER BY d_year, d_moy
        ) AS psum,
        LEAD(SUM(ss_sales_price)) OVER (
            PARTITION BY i_category, i_brand, s_store_name, s_company_name
            ORDER BY d_year, d_moy
        ) AS nsum
    FROM
        item
        JOIN store_sales ON ss_item_sk = i_item_sk
        JOIN filtered_dates ON ss_sold_date_sk = d_date_sk
        JOIN store ON ss_store_sk = s_store_sk
    GROUP BY
        i_category,
        i_brand,
        s_store_name,
        s_company_name,
        d_year,
        d_moy
)
SELECT
    s_store_name,
    d_year,
    avg_monthly_sales,
    sum_sales,
    psum,
    nsum
FROM v1
WHERE
    d_year = 2001
    AND avg_monthly_sales > 0
    AND ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales > 0.1
    AND psum IS NOT NULL
    AND nsum IS NOT NULL
ORDER BY
    sum_sales - avg_monthly_sales,
    nsum
LIMIT 100;
```

```
Changes: Eliminated the expensive 3-way self-join by using LAG/LEAD window functions in a single pass. Pre-filtered date_dim into a CTE to reduce join size early. Removed redundant CASE expression in main filter.
Expected speedup: â‰¥2.0x due to eliminating self-join overhead and reducing intermediate result sizes.
```