WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_dom BETWEEN 1 AND 2 AND d_year IN (1999, 2000, 2001)), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_county IN ('Orange County', 'Bronx County', 'Franklin Parish', 'Williamson County')), filtered_hd_combined AS (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_vehicle_count > 0 AND (hd_dep_count * 1.000) / hd_vehicle_count > 1 AND hd_buy_potential IN ('Unknown', '>10000')), store_sales_joined AS (SELECT ss_ticket_number, ss_customer_sk, hd_buy_potential FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_stores ON ss_store_sk = s_store_sk JOIN filtered_hd_combined ON ss_hdemo_sk = hd_demo_sk), union_aggregate AS (SELECT ss_ticket_number, ss_customer_sk, COUNT(*) AS cnt FROM store_sales_joined WHERE hd_buy_potential = 'Unknown' GROUP BY ss_ticket_number, ss_customer_sk UNION ALL SELECT ss_ticket_number, ss_customer_sk, COUNT(*) AS cnt FROM store_sales_joined WHERE hd_buy_potential = '>10000' GROUP BY ss_ticket_number, ss_customer_sk), filtered_hd_unknown AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = 'Unknown' AND hd_vehicle_count > 0 AND (hd_dep_count * 1.000) / hd_vehicle_count > 1), filtered_hd_high AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000' AND hd_vehicle_count > 0 AND (hd_dep_count * 1.000) / hd_vehicle_count > 1)
SELECT c_last_name, c_first_name, c_salutation, c_preferred_cust_flag, ss_ticket_number, cnt FROM (SELECT ss_ticket_number, ss_customer_sk, SUM(cnt) AS cnt FROM union_aggregate GROUP BY ss_ticket_number, ss_customer_sk HAVING SUM(cnt) BETWEEN 1 AND 5) AS dj, customer WHERE ss_customer_sk = c_customer_sk ORDER BY cnt DESC, c_last_name ASC LIMIT 100