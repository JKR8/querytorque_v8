WITH filtered_base AS (SELECT ss.ss_ticket_number, ss.ss_item_sk, ss.ss_customer_sk, ss.ss_store_sk, ss.ss_net_profit, i.i_color, i.i_item_sk, s.s_store_name, s.s_market_id, s.s_zip, c.c_last_name, c.c_first_name, c.c_current_addr_sk, c.c_birth_country, ca.ca_address_sk, ca.ca_state, ca.ca_country, ca.ca_zip FROM store_sales AS ss JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE s.s_market_id = 8 AND s.s_zip = ca.ca_zip AND c.c_birth_country <> UPPER(ca.ca_country)), beige_sales AS (SELECT c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size, SUM(ss_net_profit) AS netpaid FROM filtered_base WHERE i_color = 'beige' GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size), all_sales_threshold AS (SELECT 0.05 * AVG(netpaid) AS threshold FROM (SELECT SUM(ss_net_profit) AS netpaid FROM filtered_base GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size) AS t), ssales AS (SELECT c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size, SUM(ss_net_profit) AS netpaid FROM store_sales, store_returns, store, item, customer, customer_address WHERE ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = c_customer_sk AND ss_item_sk = i_item_sk AND ss_store_sk = s_store_sk AND c_current_addr_sk = ca_address_sk AND c_birth_country <> UPPER(ca_country) AND s_zip = ca_zip AND s_market_id = 8 GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size)
SELECT c_last_name, c_first_name, s_store_name, SUM(netpaid) AS paid FROM beige_sales, all_sales_threshold GROUP BY c_last_name, c_first_name, s_store_name, all_sales_threshold.threshold HAVING SUM(netpaid) > all_sales_threshold.threshold ORDER BY c_last_name, c_first_name, s_store_name LIMIT 100