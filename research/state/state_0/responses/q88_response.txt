Looking at this query, I can see 8 independent subqueries all scanning the same tables (store_sales, household_demographics, time_dim, store) with the same filtering conditions except for different time ranges. This is a perfect candidate for **single-pass aggregation** where we scan once and compute all 8 counts simultaneously.

**Key insights:**
1. All 8 subqueries join the same 4 tables with identical join conditions
2. Only difference is time range filters (t_hour and t_minute conditions)
3. Each subquery has the same complex OR condition on household_demographics
4. The query does 8 separate scans of store_sales â†’ can be reduced to 1 scan

```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "single_pass_aggregation",
      "nodes": {
        "filtered_sales": "SELECT time_dim.t_hour, time_dim.t_minute FROM store_sales JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN time_dim ON ss_sold_time_sk = t_time_sk JOIN store ON ss_store_sk = s_store_sk WHERE store.s_store_name = 'ese' AND ((household_demographics.hd_dep_count = -1 AND household_demographics.hd_vehicle_count <= -1 + 2) OR (household_demographics.hd_dep_count = 4 AND household_demographics.hd_vehicle_count <= 4 + 2) OR (household_demographics.hd_dep_count = 3 AND household_demographics.hd_vehicle_count <= 3 + 2))",
        "main_query": "SELECT COUNT(CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN t_hour = 9 AND t_minute < 30 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN t_hour = 9 AND t_minute >= 30 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN t_hour = 10 AND t_minute < 30 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN t_hour = 10 AND t_minute >= 30 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN t_hour = 11 AND t_minute < 30 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN t_hour = 11 AND t_minute >= 30 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN t_hour = 12 AND t_minute < 30 THEN 1 END) AS h12_to_12_30 FROM filtered_sales"
      },
      "invariants_kept": [
        "same result values",
        "same column output",
        "same row count (1 row)",
        "all literal values preserved exactly"
      ],
      "expected_speedup": "5.0x",
      "risk": "low"
    }
  ],
  "explanation": "Consolidated 8 separate subqueries into a single pass through the joined tables. The original query performed 8 separate joins of store_sales, household_demographics, time_dim, and store, each with identical filters except for time ranges. The rewrite scans once and uses conditional COUNT() with CASE expressions to compute all 8 time bucket counts simultaneously, reducing 8 table scans to 1 while preserving exact semantics."
}
```