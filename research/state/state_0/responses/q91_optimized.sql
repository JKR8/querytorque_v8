WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 11), filtered_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -6), filtered_hh_demo AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential LIKE '1001-5000%'), filtered_cust_demo_branch1 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status = 'M' AND cd_education_status = 'Unknown'), filtered_cust_demo_branch2 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree'), filtered_returns_branch1 AS (SELECT cr_call_center_sk, cr_returning_customer_sk, cr_net_loss FROM catalog_returns AS cr JOIN filtered_date AS fd ON cr.cr_returned_date_sk = fd.d_date_sk), filtered_returns_branch2 AS (SELECT cr_call_center_sk, cr_returning_customer_sk, cr_net_loss FROM catalog_returns AS cr JOIN filtered_date AS fd ON cr.cr_returned_date_sk = fd.d_date_sk), branch1_results AS (SELECT cc_call_center_id, cc_name, cc_manager, cd.cd_marital_status, cd.cd_education_status, SUM(cr.cr_net_loss) AS Returns_Loss FROM call_center AS cc JOIN filtered_returns_branch1 AS cr ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer AS c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN filtered_cust_demo_branch1 AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN filtered_hh_demo AS hd ON hd.hd_demo_sk = c.c_current_hdemo_sk JOIN filtered_address AS ca ON ca.ca_address_sk = c.c_current_addr_sk GROUP BY cc_call_center_id, cc_name, cc_manager, cd.cd_marital_status, cd.cd_education_status), branch2_results AS (SELECT cc_call_center_id, cc_name, cc_manager, cd.cd_marital_status, cd.cd_education_status, SUM(cr.cr_net_loss) AS Returns_Loss FROM call_center AS cc JOIN filtered_returns_branch2 AS cr ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer AS c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN filtered_cust_demo_branch2 AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN filtered_hh_demo AS hd ON hd.hd_demo_sk = c.c_current_hdemo_sk JOIN filtered_address AS ca ON ca.ca_address_sk = c.c_current_addr_sk GROUP BY cc_call_center_id, cc_name, cc_manager, cd.cd_marital_status, cd.cd_education_status)
SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(Returns_Loss) AS Returns_Loss FROM (SELECT * FROM branch1_results UNION ALL SELECT * FROM branch2_results) AS combined GROUP BY cc_call_center_id, cc_name, cc_manager ORDER BY SUM(Returns_Loss) DESC