WITH filtered_d1 AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 2002), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'W'), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '501-1000'), pre_joined_catalog_sales AS (SELECT cs.cs_item_sk, cs.cs_quantity, cs.cs_order_number, cs.cs_sold_date_sk, cs.cs_ship_date_sk, cs.cs_promo_sk, d1.d_week_seq, d1.d_date FROM catalog_sales AS cs JOIN filtered_d1 AS d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN filtered_customer_demographics AS fcd ON cs.cs_bill_cdemo_sk = fcd.cd_demo_sk JOIN filtered_household_demographics AS fhd ON cs.cs_bill_hdemo_sk = fhd.hd_demo_sk)
SELECT i.i_item_desc, w.w_warehouse_name, pjcs.d_week_seq AS d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM pre_joined_catalog_sales AS pjcs JOIN inventory AS inv ON pjcs.cs_item_sk = inv.inv_item_sk JOIN warehouse AS w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN item AS i ON pjcs.cs_item_sk = i.i_item_sk JOIN date_dim AS d2 ON inv.inv_date_sk = d2.d_date_sk AND pjcs.d_week_seq = d2.d_week_seq JOIN date_dim AS d3 ON pjcs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion AS p ON pjcs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns AS cr ON cr.cr_item_sk = pjcs.cs_item_sk AND cr.cr_order_number = pjcs.cs_order_number WHERE inv.inv_quantity_on_hand < pjcs.cs_quantity AND d3.d_date > pjcs.d_date + 5 GROUP BY i.i_item_desc, w.w_warehouse_name, pjcs.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, pjcs.d_week_seq LIMIT 100