-- Q57 EXPLAIN ANALYZE (SF10)
-- State: baseline
-- Best speedup: 1.02x
-- Source SQL: /mnt/d/TPC-DS/queries_duckdb_converted/query_57.sql

analyzed_plan
┌─────────────────────────────────────┐
│┌───────────────────────────────────┐│
││    Query Profiling Information    ││
│└───────────────────────────────────┘│
└─────────────────────────────────────┘
EXPLAIN ANALYZE with v1 as(  select i_category, i_brand,         cc_name,         d_year, d_moy,         sum(cs_sales_price) sum_sales,         avg(sum(cs_sales_price)) over           (partition by i_category, i_brand,                      cc_name, d_year)           avg_monthly_sales,         rank() over           (partition by i_category, i_brand,                      cc_name            order by d_year, d_moy) rn  from item, catalog_sales, date_dim, call_center  where cs_item_sk = i_item_sk and        cs_sold_date_sk = d_date_sk and        cc_call_center_sk= cs_call_center_sk and        (          d_year = 1999 or          ( d_year = 1999-1 and d_moy =12) or          ( d_year = 1999+1 and d_moy =1)        )  group by i_category, i_brand,           cc_name , d_year, d_moy),  v2 as(  select v1.i_brand         ,v1.d_year         ,v1.avg_monthly_sales         ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum  from v1, v1 v1_lag, v1 v1_lead  where v1.i_category = v1_lag.i_category and        v1.i_category = v1_lead.i_category and        v1.i_brand = v1_lag.i_brand and        v1.i_brand = v1_lead.i_brand and        v1. cc_name = v1_lag. cc_name and        v1. cc_name = v1_lead. cc_name and        v1.rn = v1_lag.rn + 1 and        v1.rn = v1_lead.rn - 1)   select *  from v2  where  d_year = 1999 and         avg_monthly_sales > 0 and         case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1  order by sum_sales - avg_monthly_sales, nsum  LIMIT 100
┌────────────────────────────────────────────────┐
│┌──────────────────────────────────────────────┐│
││              Total Time: 0.398s              ││
│└──────────────────────────────────────────────┘│
└────────────────────────────────────────────────┘
┌───────────────────────────┐
│           QUERY           │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│      EXPLAIN_ANALYZE      │
│    ────────────────────   │
│           0 rows          │
│          (0.00s)          │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│            CTE            │
│    ────────────────────   │
│        CTE Name: v1       │
│       Table Index: 0      ├─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                           │                                                                                                     │
│           0 rows          │                                                                                                     │
│          (0.02s)          │                                                                                                     │
└─────────────┬─────────────┘                                                                                                     │
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│         PROJECTION        │                                                                                       │         PROJECTION        │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│             #0            │                                                                                       │             #0            │
│             #1            │                                                                                       │             #1            │
│             #2            │                                                                                       │             #2            │
│             #3            │                                                                                       │             #3            │
│             #4            │                                                                                       │             #4            │
│             #5            │                                                                                       │             #5            │
│             #6            │                                                                                       │                           │
│             #7            │                                                                                       │                           │
│                           │                                                                                       │                           │
│        147,562 rows       │                                                                                       │          100 rows         │
│          (0.00s)          │                                                                                       │          (0.00s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│           WINDOW          │                                                                                       │           TOP_N           │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│        Projections:       │                                                                                       │          Top: 100         │
│ RANK() OVER (PARTITION BY │                                                                                       │                           │
│    i_category, i_brand,   │                                                                                       │         Order By:         │
│   cc_name ORDER BY d_year │                                                                                       │           #6 ASC          │
│  ASC NULLS LAST, d_moy ASC│                                                                                       │        v2.nsum ASC        │
│         NULLS LAST)       │                                                                                       │                           │
│                           │                                                                                       │                           │
│        147,562 rows       │                                                                                       │          100 rows         │
│          (0.25s)          │                                                                                       │          (0.01s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│           WINDOW          │                                                                                       │         PROJECTION        │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│        Projections:       │                                                                                       │          i_brand          │
│  avg(sum(cs_sales_price)) │                                                                                       │           d_year          │
│     OVER (PARTITION BY    │                                                                                       │     avg_monthly_sales     │
│    i_category, i_brand,   │                                                                                       │         sum_sales         │
│      cc_name, d_year)     │                                                                                       │            psum           │
│                           │                                                                                       │            nsum           │
│                           │                                                                                       │ (CAST(sum_sales AS DOUBLE)│
│                           │                                                                                       │    - avg_monthly_sales)   │
│                           │                                                                                       │                           │
│        147,562 rows       │                                                                                       │        111,526 rows       │
│          (0.52s)          │                                                                                       │          (0.00s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│         PROJECTION        │                                                                                       │           FILTER          │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│__internal_decompress_strin│                                                                                       │       (CASE  WHEN (       │
│           g(#0)           │                                                                                       │ (avg_monthly_sales > 0.0))│
│             #1            │                                                                                       │      THEN ((abs((CAST     │
│             #2            │                                                                                       │  (sum_sales AS DOUBLE) -  │
│__internal_decompress_integ│                                                                                       │    avg_monthly_sales)) /  │
│   ral_integer(#3, 1900)   │                                                                                       │  avg_monthly_sales)) ELSE │
│__internal_decompress_integ│                                                                                       │       NULL END > 0.1)     │
│     ral_integer(#4, 1)    │                                                                                       │                           │
│             #5            │                                                                                       │                           │
│                           │                                                                                       │                           │
│        147,562 rows       │                                                                                       │        111,526 rows       │
│          (0.00s)          │                                                                                       │          (0.01s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│       HASH_GROUP_BY       │                                                                                       │         PROJECTION        │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│          Groups:          │                                                                                       │          i_brand          │
│             #0            │                                                                                       │           d_year          │
│             #1            │                                                                                       │     avg_monthly_sales     │
│             #2            │                                                                                       │         sum_sales         │
│             #3            │                                                                                       │            psum           │
│             #4            │                                                                                       │            nsum           │
│                           │                                                                                       │                           │
│    Aggregates: sum(#5)    │                                                                                       │                           │
│                           │                                                                                       │                           │
│        147,562 rows       │                                                                                       │        122,145 rows       │
│          (1.06s)          │                                                                                       │          (0.00s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐
│         PROJECTION        │                                                                                       │         HASH_JOIN         │
│    ────────────────────   │                                                                                       │    ────────────────────   │
│         i_category        │                                                                                       │      Join Type: INNER     │
│          i_brand          │                                                                                       │                           │
│          cc_name          │                                                                                       │        Conditions:        │
│           d_year          │                                                                                       │  i_category = i_category  │
│           d_moy           │                                                                                       │     i_brand = i_brand     │
│       cs_sales_price      │                                                                                       │     cc_name = cc_name     │
│                           │                                                                                       │       (rn - 1) = rn       ├───────────────────────────────────────────┐
│                           │                                                                                       │  i_category = i_category  │                                           │
│                           │                                                                                       │     i_brand = i_brand     │                                           │
│                           │                                                                                       │     cc_name = cc_name     │                                           │
│                           │                                                                                       │       (rn + 1) = rn       │                                           │
│                           │                                                                                       │                           │                                           │
│       3,468,218 rows      │                                                                                       │        122,145 rows       │                                           │
│          (0.00s)          │                                                                                       │          (0.11s)          │                                           │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘                                           │
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐
│         PROJECTION        │                                                                                       │         HASH_JOIN         │                             │         PROJECTION        │
│    ────────────────────   │                                                                                       │    ────────────────────   │                             │    ────────────────────   │
│             #0            │                                                                                       │      Join Type: INNER     │                             │             #0            │
│__internal_compress_integra│                                                                                       │                           │                             │             #1            │
│    l_utinyint(#1, 1900)   │                                                                                       │        Conditions:        │                             │             #2            │
│__internal_compress_integra│                                                                                       │  i_category = i_category  │                             │             #3            │
│     l_utinyint(#2, 1)     │                                                                                       │     i_brand = i_brand     │                             │             #5            │
│             #3            │                                                                                       │     cc_name = cc_name     ├──────────────┐              │             #6            │
│__internal_compress_string_│                                                                                       │    (rn + 1) = (rn - 1)    │              │              │             #7            │
│        uhugeint(#4)       │                                                                                       │                           │              │              │                           │
│             #5            │                                                                                       │                           │              │              │                           │
│                           │                                                                                       │                           │              │              │                           │
│       3,468,218 rows      │                                                                                       │        122,145 rows       │              │              │        126,297 rows       │
│          (0.13s)          │                                                                                       │          (0.07s)          │              │              │          (0.00s)          │
└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘              │              └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         HASH_JOIN         │                                                                                       │          CTE_SCAN         ││          CTE_SCAN         ││           FILTER          │
│    ────────────────────   │                                                                                       │    ────────────────────   ││    ────────────────────   ││    ────────────────────   │
│      Join Type: INNER     │                                                                                       │        CTE Index: 0       ││        CTE Index: 0       ││   ((d_year = 1999) AND    │
│                           │                                                                                       │                           ││                           ││ (avg_monthly_sales > 0.0))│
│        Conditions:        ├────────────────────────────────────────────────────────────────────────┐              │                           ││                           ││                           │
│   cs_item_sk = i_item_sk  │                                                                        │              │                           ││                           ││                           │
│                           │                                                                        │              │                           ││                           ││                           │
│       3,468,218 rows      │                                                                        │              │        147,562 rows       ││        147,562 rows       ││        126,297 rows       │
│          (0.02s)          │                                                                        │              │          (0.00s)          ││          (0.00s)          ││          (0.00s)          │
└─────────────┬─────────────┘                                                                        │              └───────────────────────────┘└───────────────────────────┘└─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         HASH_JOIN         │                                                          │         TABLE_SCAN        │                                                          │          CTE_SCAN         │
│    ────────────────────   │                                                          │    ────────────────────   │                                                          │    ────────────────────   │
│      Join Type: INNER     │                                                          │        Table: item        │                                                          │        CTE Index: 0       │
│                           │                                                          │   Type: Sequential Scan   │                                                          │                           │
│        Conditions:        │                                                          │                           │                                                          │                           │
│    cs_call_center_sk =    │                                                          │        Projections:       │                                                          │                           │
│      cc_call_center_sk    ├───────────────────────────────────────────┐              │         i_item_sk         │                                                          │                           │
│                           │                                           │              │         i_category        │                                                          │                           │
│                           │                                           │              │          i_brand          │                                                          │                           │
│                           │                                           │              │                           │                                                          │                           │
│       3,468,218 rows      │                                           │              │        102,000 rows       │                                                          │        147,562 rows       │
│          (0.02s)          │                                           │              │          (0.00s)          │                                                          │          (0.05s)          │
└─────────────┬─────────────┘                                           │              └───────────────────────────┘                                                          └───────────────────────────┘
┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐
│         HASH_JOIN         │                             │         TABLE_SCAN        │
│    ────────────────────   │                             │    ────────────────────   │
│      Join Type: INNER     │                             │     Table: call_center    │
│                           │                             │   Type: Sequential Scan   │
│        Conditions:        │                             │                           │
│cs_sold_date_sk = d_date_sk├──────────────┐              │        Projections:       │
│                           │              │              │     cc_call_center_sk     │
│                           │              │              │          cc_name          │
│                           │              │              │                           │
│       3,468,218 rows      │              │              │          24 rows          │
│          (0.03s)          │              │              │          (0.00s)          │
└─────────────┬─────────────┘              │              └───────────────────────────┘
┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         TABLE_SCAN        ││           FILTER          │
│    ────────────────────   ││    ────────────────────   │
│    Table: catalog_sales   ││   ((d_year = 1999) OR (   │
│   Type: Sequential Scan   ││ (d_year = 1998) AND (d_moy│
│                           ││  = 12)) OR ((d_year = 2000│
│        Projections:       ││    ) AND (d_moy = 1)))    │
│         cs_item_sk        ││                           │
│      cs_sold_date_sk      ││                           │
│     cs_call_center_sk     ││                           │
│       cs_sales_price      ││                           │
│                           ││                           │
│       3,468,218 rows      ││          427 rows         │
│          (0.33s)          ││          (0.00s)          │
└───────────────────────────┘└─────────────┬─────────────┘
                             ┌─────────────┴─────────────┐
                             │         TABLE_SCAN        │
                             │    ────────────────────   │
                             │      Table: date_dim      │
                             │   Type: Sequential Scan   │
                             │                           │
                             │        Projections:       │
                             │         d_date_sk         │
                             │           d_year          │
                             │           d_moy           │
                             │                           │
                             │          Filters:         │
                             │   d_date_sk>=2450815 AND  │
                             │     d_date_sk<=2452653    │
                             │                           │
                             │         1,839 rows        │
                             │          (0.00s)          │
                             └───────────────────────────┘
