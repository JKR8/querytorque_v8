-- Q54 EXPLAIN ANALYZE (SF10)
-- State: baseline
-- Best speedup: 1.03x
-- Source SQL: /mnt/d/TPC-DS/queries_duckdb_converted/query_54.sql

analyzed_plan
┌─────────────────────────────────────┐
│┌───────────────────────────────────┐│
││    Query Profiling Information    ││
│└───────────────────────────────────┘│
└─────────────────────────────────────┘
EXPLAIN ANALYZE with my_customers as (  select distinct c_customer_sk         , c_current_addr_sk  from            ( select cs_sold_date_sk sold_date_sk,                  cs_bill_customer_sk customer_sk,                  cs_item_sk item_sk           from   catalog_sales           union all           select ws_sold_date_sk sold_date_sk,                  ws_bill_customer_sk customer_sk,                  ws_item_sk item_sk           from   web_sales          ) cs_or_ws_sales,          item,          date_dim,          customer  where   sold_date_sk = d_date_sk          and item_sk = i_item_sk          and i_category = 'Women'          and i_class = 'maternity'          and c_customer_sk = cs_or_ws_sales.customer_sk          and d_moy = 5          and d_year = 1998  )  , my_revenue as (  select c_customer_sk,         sum(ss_ext_sales_price) as revenue  from   my_customers,         store_sales,         customer_address,         store,         date_dim  where  c_current_addr_sk = ca_address_sk         and ca_county = s_county         and ca_state = s_state         and ss_sold_date_sk = d_date_sk         and c_customer_sk = ss_customer_sk         and d_month_seq between (select distinct d_month_seq+1                                  from   date_dim where d_year = 1998 and d_moy = 5)                            and  (select distinct d_month_seq+3                                  from   date_dim where d_year = 1998 and d_moy = 5)  group by c_customer_sk  )  , segments as  (select cast((revenue/50) as int) as segment   from   my_revenue  )   select segment, count(*) as num_customers, segment*50 as segment_base  from segments  group by segment  order by segment, num_customers  LIMIT 100
┌────────────────────────────────────────────────┐
│┌──────────────────────────────────────────────┐│
││              Total Time: 0.0783s             ││
│└──────────────────────────────────────────────┘│
└────────────────────────────────────────────────┘
┌───────────────────┐
│       QUERY       │
└─────────┬─────────┘
┌─────────┴─────────┐
│  EXPLAIN_ANALYZE  │
│    ────────────   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│       TOP_N       │
│    ────────────   │
│      Top: 100     │
│                   │
│     Order By:     │
│  segments.segment │
│         ASC       │
│  count_star() ASC │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│      segment      │
│   num_customers   │
│    segment_base   │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│   HASH_GROUP_BY   │
│    ────────────   │
│     Groups: #0    │
│                   │
│    Aggregates:    │
│    count_star()   │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│      segment      │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│      segment      │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│      revenue      │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│   HASH_GROUP_BY   │
│    ────────────   │
│     Groups: #0    │
│                   │
│    Aggregates:    │
│      sum(#1)      │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│   c_customer_sk   │
│ ss_ext_sales_price│
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     PROJECTION    │
│    ────────────   │
│         #0        │
│__internal_compress│
│ _string_uinteger( │
│        #1)        │
│         #3        │
│         #2        │
│                   │
│       0 rows      │
│      (0.00s)      │
└─────────┬─────────┘
┌─────────┴─────────┐
│     HASH_JOIN     │
│    ────────────   │
│     Join Type:    │
│       INNER       │
│                   │
│    Conditions:    │
│     s_county =    ├──────────┐
│      ca_county    │          │
│ s_state = ca_state│          │
│                   │          │
│       0 rows      │          │
│      (0.00s)      │          │
└─────────┬─────────┘          │
┌─────────┴─────────┐┌─────────┴─────────┐
│     TABLE_SCAN    ││     HASH_JOIN     │
│    ────────────   ││    ────────────   │
│    Table: store   ││     Join Type:    │
│                   ││       INNER       │
│       Type:       ││                   │
│  Sequential Scan  ││    Conditions:    │
│                   ││  ca_address_sk =  ├──────────┐
│    Projections:   ││  c_current_addr_sk│          │
│      s_county     ││                   │          │
│      s_state      ││                   │          │
│                   ││                   │          │
│      66 rows      ││    10,414 rows    │          │
│      (0.00s)      ││      (0.00s)      │          │
└───────────────────┘└─────────┬─────────┘          │
                     ┌─────────┴─────────┐┌─────────┴─────────┐
                     │     TABLE_SCAN    ││     HASH_JOIN     │
                     │    ────────────   ││    ────────────   │
                     │       Table:      ││     Join Type:    │
                     │  customer_address ││       INNER       │
                     │                   ││                   │
                     │       Type:       ││    Conditions:    │
                     │  Sequential Scan  ││  ss_customer_sk = │
                     │                   ││    c_customer_sk  ├─────────────────────────────────────────────────────────────────────────┐
                     │    Projections:   ││                   │                                                                         │
                     │   ca_address_sk   ││                   │                                                                         │
                     │     ca_county     ││                   │                                                                         │
                     │      ca_state     ││                   │                                                                         │
                     │                   ││                   │                                                                         │
                     │    249,439 rows   ││    10,414 rows    │                                                                         │
                     │      (0.01s)      ││      (0.03s)      │                                                                         │
                     └───────────────────┘└─────────┬─────────┘                                                                         │
                                          ┌─────────┴─────────┐                                                               ┌─────────┴─────────┐
                                          │     HASH_JOIN     │                                                               │   HASH_GROUP_BY   │
                                          │    ────────────   │                                                               │    ────────────   │
                                          │     Join Type:    │                                                               │      Groups:      │
                                          │       INNER       │                                                               │         #0        │
                                          │                   │                                                               │         #1        │
                                          │    Conditions:    ├──────────┐                                                    │                   │
                                          │ ss_sold_date_sk = │          │                                                    │                   │
                                          │      d_date_sk    │          │                                                    │                   │
                                          │                   │          │                                                    │                   │
                                          │   1,093,819 rows  │          │                                                    │     4,605 rows    │
                                          │      (0.05s)      │          │                                                    │      (0.00s)      │
                                          └─────────┬─────────┘          │                                                    └─────────┬─────────┘
                                          ┌─────────┴─────────┐┌─────────┴─────────┐                                          ┌─────────┴─────────┐
                                          │     TABLE_SCAN    ││  NESTED_LOOP_JOIN │                                          │     PROJECTION    │
                                          │    ────────────   ││    ────────────   │                                          │    ────────────   │
                                          │       Table:      ││     Join Type:    │                                          │   c_customer_sk   │
                                          │    store_sales    ││       INNER       │                                          │ c_current_addr_sk │
                                          │                   ││                   │                                          │                   │
                                          │       Type:       ││    Conditions:    │                                          │                   │
                                          │  Sequential Scan  ││   d_month_seq <=  │                                          │                   │
                                          │                   ││      SUBQUERY     ├───────────────────────────────┐          │                   │
                                          │    Projections:   ││                   │                               │          │                   │
                                          │  ss_sold_date_sk  ││                   │                               │          │                   │
                                          │   ss_customer_sk  ││                   │                               │          │                   │
                                          │ ss_ext_sales_price││                   │                               │          │                   │
                                          │                   ││                   │                               │          │                   │
                                          │   1,093,819 rows  ││      92 rows      │                               │          │     5,270 rows    │
                                          │      (0.29s)      ││      (0.00s)      │                               │          │      (0.00s)      │
                                          └───────────────────┘└─────────┬─────────┘                               │          └─────────┬─────────┘
                                                               ┌─────────┴─────────┐                     ┌─────────┴─────────┐┌─────────┴─────────┐
                                                               │  NESTED_LOOP_JOIN │                     │     PROJECTION    ││     PROJECTION    │
                                                               │    ────────────   │                     │    ────────────   ││    ────────────   │
                                                               │     Join Type:    │                     │ CASE  WHEN ((#1 > ││   c_customer_sk   │
                                                               │       INNER       │                     │  1)) THEN ("error"││ c_current_addr_sk │
                                                               │                   │                     │  ('More than one  ││                   │
                                                               │    Conditions:    │                     │  row returned by a││                   │
                                                               │   d_month_seq >=  │                     │  subquery used as ││                   │
                                                               │      SUBQUERY     │                     │   an expression - ││                   │
                                                               │                   │                     │  scalar subqueries││                   │
                                                               │                   │                     │  can only return a││                   │
                                                               │                   │                     │     single row.   ││                   │
                                                               │                   ├──────────┐          │      Use "SET     ││                   │
                                                               │                   │          │          │ scalar_subquery_er││                   │
                                                               │                   │          │          │ror_on_multiple_row││                   │
                                                               │                   │          │          │ s=false" to revert││                   │
                                                               │                   │          │          │     to previous   ││                   │
                                                               │                   │          │          │     behavior of   ││                   │
                                                               │                   │          │          │     returning a   ││                   │
                                                               │                   │          │          │   random row.'))  ││                   │
                                                               │                   │          │          │     ELSE #0 END   ││                   │
                                                               │                   │          │          │                   ││                   │
                                                               │      92 rows      │          │          │       1 row       ││     5,270 rows    │
                                                               │      (0.00s)      │          │          │      (0.00s)      ││      (0.00s)      │
                                                               └─────────┬─────────┘          │          └─────────┬─────────┘└─────────┬─────────┘
                                                               ┌─────────┴─────────┐┌─────────┴─────────┐┌─────────┴─────────┐┌─────────┴─────────┐
                                                               │     TABLE_SCAN    ││     PROJECTION    ││UNGROUPED_AGGREGATE││     HASH_JOIN     │
                                                               │    ────────────   ││    ────────────   ││    ────────────   ││    ────────────   │
                                                               │       Table:      ││ CASE  WHEN ((#1 > ││    Aggregates:    ││     Join Type:    │
                                                               │      date_dim     ││  1)) THEN ("error"││    "first"(#0)    ││       INNER       │
                                                               │                   ││  ('More than one  ││    count_star()   ││                   │
                                                               │       Type:       ││  row returned by a││                   ││    Conditions:    │
                                                               │  Sequential Scan  ││  subquery used as ││                   ││  c_customer_sk =  │
                                                               │                   ││   an expression - ││                   ││     customer_sk   │
                                                               │    Projections:   ││  scalar subqueries││                   ││                   │
                                                               │     d_date_sk     ││  can only return a││                   ││                   │
                                                               │    d_month_seq    ││     single row.   ││                   ││                   │
                                                               │                   ││      Use "SET     ││                   ││                   ├──────────┐
                                                               │      Filters:     ││ scalar_subquery_er││                   ││                   │          │
                                                               │ d_date_sk>=2450816││ror_on_multiple_row││                   ││                   │          │
                                                               │   AND d_date_sk<  ││ s=false" to revert││                   ││                   │          │
                                                               │      =2452642     ││     to previous   ││                   ││                   │          │
                                                               │                   ││     behavior of   ││                   ││                   │          │
                                                               │                   ││     returning a   ││                   ││                   │          │
                                                               │                   ││   random row.'))  ││                   ││                   │          │
                                                               │                   ││     ELSE #0 END   ││                   ││                   │          │
                                                               │                   ││                   ││                   ││                   │          │
                                                               │      92 rows      ││       1 row       ││       1 row       ││     5,270 rows    │          │
                                                               │      (0.00s)      ││      (0.00s)      ││      (0.00s)      ││      (0.01s)      │          │
                                                               └───────────────────┘└─────────┬─────────┘└─────────┬─────────┘└─────────┬─────────┘          │
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐┌─────────┴─────────┐┌─────────┴─────────┐
                                                                                    │UNGROUPED_AGGREGATE││     PROJECTION    ││     TABLE_SCAN    ││     HASH_JOIN     │
                                                                                    │    ────────────   ││    ────────────   ││    ────────────   ││    ────────────   │
                                                                                    │    Aggregates:    ││         #0        ││       Table:      ││     Join Type:    │
                                                                                    │    "first"(#0)    ││                   ││      customer     ││       INNER       │
                                                                                    │    count_star()   ││                   ││                   ││                   │
                                                                                    │                   ││                   ││       Type:       ││    Conditions:    │
                                                                                    │                   ││                   ││  Sequential Scan  ││item_sk = i_item_sk│
                                                                                    │                   ││                   ││                   ││                   ├────────────────────────────────────────────────────┐
                                                                                    │                   ││                   ││    Projections:   ││                   │                                                    │
                                                                                    │                   ││                   ││   c_customer_sk   ││                   │                                                    │
                                                                                    │                   ││                   ││ c_current_addr_sk ││                   │                                                    │
                                                                                    │                   ││                   ││                   ││                   │                                                    │
                                                                                    │       1 row       ││       1 row       ││    499,111 rows   ││     5,281 rows    │                                                    │
                                                                                    │      (0.00s)      ││      (0.00s)      ││      (0.00s)      ││      (0.00s)      │                                                    │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘└───────────────────┘└─────────┬─────────┘                                                    │
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐                     ┌─────────┴─────────┐                                          ┌─────────┴─────────┐
                                                                                    │     PROJECTION    ││     PROJECTION    │                     │     HASH_JOIN     │                                          │     TABLE_SCAN    │
                                                                                    │    ────────────   ││    ────────────   │                     │    ────────────   │                                          │    ────────────   │
                                                                                    │         #0        ││__internal_decompre│                     │     Join Type:    │                                          │    Table: item    │
                                                                                    │                   ││ss_integral_integer│                     │       INNER       │                                          │                   │
                                                                                    │                   ││      (#0, 3)      │                     │                   │                                          │       Type:       │
                                                                                    │                   ││                   │                     │    Conditions:    │                                          │  Sequential Scan  │
                                                                                    │                   ││                   │                     │   sold_date_sk =  │                                          │                   │
                                                                                    │                   ││                   │                     │      d_date_sk    │                                          │    Projections:   │
                                                                                    │                   ││                   │                     │                   ├───────────────────────────────┐          │     i_item_sk     │
                                                                                    │                   ││                   │                     │                   │                               │          │                   │
                                                                                    │                   ││                   │                     │                   │                               │          │      Filters:     │
                                                                                    │                   ││                   │                     │                   │                               │          │ i_category='Women'│
                                                                                    │                   ││                   │                     │                   │                               │          │i_class='maternity'│
                                                                                    │                   ││                   │                     │                   │                               │          │                   │
                                                                                    │       1 row       ││       1 row       │                     │    212,553 rows   │                               │          │     2,566 rows    │
                                                                                    │      (0.00s)      ││      (0.00s)      │                     │      (0.01s)      │                               │          │      (0.00s)      │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘                     └─────────┬─────────┘                               │          └───────────────────┘
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐                     ┌─────────┴─────────┐                     ┌─────────┴─────────┐
                                                                                    │     PROJECTION    ││   HASH_GROUP_BY   │                     │       UNION       │                     │       FILTER      │
                                                                                    │    ────────────   ││    ────────────   │                     │    ────────────   │                     │    ────────────   │
                                                                                    │__internal_decompre││     Groups: #0    │                     │                   │                     │ (d_date_sk BETWEEN│
                                                                                    │ss_integral_integer││                   │                     │                   │                     │     2450815 AND   │
                                                                                    │      (#0, 1)      ││                   │                     │                   ├──────────┐          │      2452653)     │
                                                                                    │                   ││                   │                     │                   │          │          │                   │
                                                                                    │       1 row       ││       1 row       │                     │       0 rows      │          │          │      31 rows      │
                                                                                    │      (0.00s)      ││      (0.00s)      │                     │      (0.00s)      │          │          │      (0.00s)      │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘                     └─────────┬─────────┘          │          └─────────┬─────────┘
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐                     ┌─────────┴─────────┐┌─────────┴─────────┐┌─────────┴─────────┐
                                                                                    │   HASH_GROUP_BY   ││     PROJECTION    │                     │     TABLE_SCAN    ││     TABLE_SCAN    ││     TABLE_SCAN    │
                                                                                    │    ────────────   ││    ────────────   │                     │    ────────────   ││    ────────────   ││    ────────────   │
                                                                                    │     Groups: #0    ││ (d_month_seq + 3) │                     │       Table:      ││       Table:      ││       Table:      │
                                                                                    │                   ││                   │                     │   catalog_sales   ││     web_sales     ││      date_dim     │
                                                                                    │                   ││                   │                     │                   ││                   ││                   │
                                                                                    │                   ││                   │                     │       Type:       ││       Type:       ││       Type:       │
                                                                                    │                   ││                   │                     │  Sequential Scan  ││  Sequential Scan  ││  Sequential Scan  │
                                                                                    │                   ││                   │                     │                   ││                   ││                   │
                                                                                    │                   ││                   │                     │    Projections:   ││    Projections:   ││    Projections:   │
                                                                                    │                   ││                   │                     │  cs_sold_date_sk  ││  ws_sold_date_sk  ││     d_date_sk     │
                                                                                    │                   ││                   │                     │cs_bill_customer_sk││ws_bill_customer_sk││                   │
                                                                                    │                   ││                   │                     │     cs_item_sk    ││     ws_item_sk    ││      Filters:     │
                                                                                    │                   ││                   │                     │                   ││                   ││      d_moy=5      │
                                                                                    │                   ││                   │                     │                   ││                   ││    d_year=1998    │
                                                                                    │                   ││                   │                     │                   ││                   ││                   │
                                                                                    │       1 row       ││      31 rows      │                     │    141,458 rows   ││    71,095 rows    ││      31 rows      │
                                                                                    │      (0.00s)      ││      (0.00s)      │                     │      (0.00s)      ││      (0.05s)      ││      (0.00s)      │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘                     └───────────────────┘└───────────────────┘└───────────────────┘
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐
                                                                                    │     PROJECTION    ││     PROJECTION    │
                                                                                    │    ────────────   ││    ────────────   │
                                                                                    │ (d_month_seq + 1) ││__internal_compress│
                                                                                    │                   ││_integral_usmallint│
                                                                                    │                   ││      (#0, 3)      │
                                                                                    │                   ││                   │
                                                                                    │      31 rows      ││      31 rows      │
                                                                                    │      (0.00s)      ││      (0.00s)      │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐
                                                                                    │     PROJECTION    ││     PROJECTION    │
                                                                                    │    ────────────   ││    ────────────   │
                                                                                    │__internal_compress││ (d_month_seq + 3) │
                                                                                    │_integral_usmallint││                   │
                                                                                    │      (#0, 1)      ││                   │
                                                                                    │                   ││                   │
                                                                                    │      31 rows      ││      31 rows      │
                                                                                    │      (0.00s)      ││      (0.00s)      │
                                                                                    └─────────┬─────────┘└─────────┬─────────┘
                                                                                    ┌─────────┴─────────┐┌─────────┴─────────┐
                                                                                    │     PROJECTION    ││     TABLE_SCAN    │
                                                                                    │    ────────────   ││    ────────────   │
                                                                                    │ (d_month_seq + 1) ││       Table:      │
                                                                                    │                   ││      date_dim     │
                                                                                    │                   ││                   │
                                                                                    │                   ││       Type:       │
                                                                                    │                   ││  Sequential Scan  │
                                                                                    │                   ││                   │
                                                                                    │                   ││    Projections:   │
                                                                                    │                   ││    d_month_seq    │
                                                                                    │                   ││                   │
                                                                                    │                   ││      Filters:     │
                                                                                    │                   ││    d_year=1998    │
                                                                                    │                   ││      d_moy=5      │
                                                                                    │                   ││                   │
                                                                                    │      31 rows      ││      31 rows      │
                                                                                    │      (0.00s)      ││      (0.00s)      │
                                                                                    └─────────┬─────────┘└───────────────────┘
                                                                                    ┌─────────┴─────────┐
                                                                                    │     TABLE_SCAN    │
                                                                                    │    ────────────   │
                                                                                    │       Table:      │
                                                                                    │      date_dim     │
                                                                                    │                   │
                                                                                    │       Type:       │
                                                                                    │  Sequential Scan  │
                                                                                    │                   │
                                                                                    │    Projections:   │
                                                                                    │    d_month_seq    │
                                                                                    │                   │
                                                                                    │      Filters:     │
                                                                                    │    d_year=1998    │
                                                                                    │      d_moy=5      │
                                                                                    │                   │
                                                                                    │      31 rows      │
                                                                                    │      (0.00s)      │
                                                                                    └───────────────────┘
