-- Q1 EXPLAIN ANALYZE (SF10)
-- State: optimized (kimi, 2.92x)
-- Best speedup: 2.92x
-- Source SQL: /mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q1/output_optimized.sql

analyzed_plan
┌─────────────────────────────────────┐
│┌───────────────────────────────────┐│
││    Query Profiling Information    ││
│└───────────────────────────────────┘│
└─────────────────────────────────────┘
EXPLAIN ANALYZE WITH filtered_returns AS (SELECT sr.sr_customer_sk, sr.sr_store_sk, sr.SR_FEE FROM store_returns AS sr JOIN date_dim AS d ON sr.sr_returned_date_sk = d.d_date_sk JOIN store AS s ON sr.sr_store_sk = s.s_store_sk WHERE d.d_year = 2000 AND s.s_state = 'SD'), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM filtered_returns GROUP BY sr_customer_sk, sr_store_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c.c_customer_id FROM customer_total_return AS ctr1 JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id LIMIT 100
┌────────────────────────────────────────────────┐
│┌──────────────────────────────────────────────┐│
││              Total Time: 0.113s              ││
│└──────────────────────────────────────────────┘│
└────────────────────────────────────────────────┘
┌───────────────────────────┐
│           QUERY           │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│      EXPLAIN_ANALYZE      │
│    ────────────────────   │
│           0 rows          │
│          (0.00s)          │
└─────────────┬─────────────┘
┌─────────────┴─────────────┐
│            CTE            │
│    ────────────────────   │
│         CTE Name:         │
│   customer_total_return   │
│                           ├────────────────────────────────────────────────────────────────────────┐
│      Table Index: 10      │                                                                        │
│                           │                                                                        │
│           0 rows          │                                                                        │
│          (0.00s)          │                                                                        │
└─────────────┬─────────────┘                                                                        │
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         PROJECTION        │                                                          │           TOP_N           │
│    ────────────────────   │                                                          │    ────────────────────   │
│             #0            │                                                          │          Top: 100         │
│__internal_decompress_integ│                                                          │                           │
│     ral_integer(#1, 1)    │                                                          │         Order By:         │
│             #2            │                                                          │    c.c_customer_id ASC    │
│                           │                                                          │                           │
│        157,800 rows       │                                                          │          100 rows         │
│          (0.00s)          │                                                          │          (0.00s)          │
└─────────────┬─────────────┘                                                          └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│       HASH_GROUP_BY       │                                                          │         PROJECTION        │
│    ────────────────────   │                                                          │    ────────────────────   │
│          Groups:          │                                                          │       c_customer_id       │
│             #0            │                                                          │                           │
│             #1            │                                                          │                           │
│                           │                                                          │                           │
│    Aggregates: sum(#2)    │                                                          │                           │
│                           │                                                          │                           │
│        157,800 rows       │                                                          │        61,974 rows        │
│          (0.12s)          │                                                          │          (0.00s)          │
└─────────────┬─────────────┘                                                          └─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         PROJECTION        │                                                          │         HASH_JOIN         │
│    ────────────────────   │                                                          │    ────────────────────   │
│       sr_customer_sk      │                                                          │      Join Type: INNER     │
│        sr_store_sk        │                                                          │                           │
│           sr_fee          │                                                          │        Conditions:        │
│                           │                                                          │      c_customer_sk =      ├──────────────┐
│                           │                                                          │       ctr_customer_sk     │              │
│                           │                                                          │                           │              │
│        161,697 rows       │                                                          │        61,974 rows        │              │
│          (0.00s)          │                                                          │          (0.02s)          │              │
└─────────────┬─────────────┘                                                          └─────────────┬─────────────┘              │
┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         PROJECTION        │                                                          │         TABLE_SCAN        ││         HASH_JOIN         │
│    ────────────────────   │                                                          │    ────────────────────   ││    ────────────────────   │
│             #0            │                                                          │      Table: customer      ││      Join Type: INNER     │
│__internal_compress_integra│                                                          │   Type: Sequential Scan   ││                           │
│     l_utinyint(#1, 1)     │                                                          │                           ││        Conditions:        │
│             #2            │                                                          │          Filters:         ││ctr_store_sk = ctr_store_sk│
│                           │                                                          │ optional: Dynamic Filter  ││  CAST(ctr_total_return AS ├──────────────┐
│                           │                                                          │      (c_customer_id)      ││          DOUBLE) >        │              │
│                           │                                                          │                           ││    avg_return_threshold   │              │
│                           │                                                          │                           ││                           │              │
│        161,697 rows       │                                                          │        499,996 rows       ││        61,989 rows        │              │
│          (0.00s)          │                                                          │          (0.05s)          ││          (0.01s)          │              │
└─────────────┬─────────────┘                                                          └───────────────────────────┘└─────────────┬─────────────┘              │
┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐┌─────────────┴─────────────┐
│         PROJECTION        │                                                                                       │          CTE_SCAN         ││         PROJECTION        │
│    ────────────────────   │                                                                                       │    ────────────────────   ││    ────────────────────   │
│       sr_customer_sk      │                                                                                       │       CTE Index: 10       ││        ctr_store_sk       │
│        sr_store_sk        │                                                                                       │                           ││    avg_return_threshold   │
│           sr_fee          │                                                                                       │                           ││                           │
│                           │                                                                                       │                           ││                           │
│        161,697 rows       │                                                                                       │        157,800 rows       ││          15 rows          │
│          (0.00s)          │                                                                                       │          (0.00s)          ││          (0.00s)          │
└─────────────┬─────────────┘                                                                                       └───────────────────────────┘└─────────────┬─────────────┘
┌─────────────┴─────────────┐                                                                                                                    ┌─────────────┴─────────────┐
│         HASH_JOIN         │                                                                                                                    │       HASH_GROUP_BY       │
│    ────────────────────   │                                                                                                                    │    ────────────────────   │
│      Join Type: INNER     │                                                                                                                    │         Groups: #0        │
│                           │                                                                                                                    │    Aggregates: avg(#1)    │
│        Conditions:        ├───────────────────────────────────────────┐                                                                        │                           │
│  sr_store_sk = s_store_sk │                                           │                                                                        │                           │
│                           │                                           │                                                                        │                           │
│        161,697 rows       │                                           │                                                                        │          15 rows          │
│          (0.01s)          │                                           │                                                                        │          (0.01s)          │
└─────────────┬─────────────┘                                           │                                                                        └─────────────┬─────────────┘
┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         HASH_JOIN         │                             │           FILTER          │                                                          │         PROJECTION        │
│    ────────────────────   │                             │    ────────────────────   │                                                          │    ────────────────────   │
│      Join Type: INNER     │                             │    (s_store_sk <= 100)    │                                                          │        ctr_store_sk       │
│                           │                             │                           │                                                          │      ctr_total_return     │
│        Conditions:        │                             │                           │                                                          │                           │
│   sr_returned_date_sk =   ├──────────────┐              │                           │                                                          │                           │
│          d_date_sk        │              │              │                           │                                                          │                           │
│                           │              │              │                           │                                                          │                           │
│        547,442 rows       │              │              │          34 rows          │                                                          │        157,800 rows       │
│          (0.00s)          │              │              │          (0.00s)          │                                                          │          (0.00s)          │
└─────────────┬─────────────┘              │              └─────────────┬─────────────┘                                                          └─────────────┬─────────────┘
┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐
│         TABLE_SCAN        ││           FILTER          ││         TABLE_SCAN        │                                                          │          CTE_SCAN         │
│    ────────────────────   ││    ────────────────────   ││    ────────────────────   │                                                          │    ────────────────────   │
│    Table: store_returns   ││ (d_date_sk BETWEEN 2450820││        Table: store       │                                                          │       CTE Index: 10       │
│   Type: Sequential Scan   ││        AND 2452822)       ││   Type: Sequential Scan   │                                                          │                           │
│                           ││                           ││                           │                                                          │                           │
│        Projections:       ││                           ││        Projections:       │                                                          │                           │
│    sr_returned_date_sk    ││                           ││         s_store_sk        │                                                          │                           │
│        sr_store_sk        ││                           ││                           │                                                          │                           │
│       sr_customer_sk      ││                           ││   Filters: s_state='SD'   │                                                          │                           │
│           sr_fee          ││                           ││                           │                                                          │                           │
│                           ││                           ││                           │                                                          │                           │
│        547,442 rows       ││          366 rows         ││          35 rows          │                                                          │        157,800 rows       │
│          (0.79s)          ││          (0.00s)          ││          (0.00s)          │                                                          │          (0.00s)          │
└───────────────────────────┘└─────────────┬─────────────┘└───────────────────────────┘                                                          └───────────────────────────┘
                             ┌─────────────┴─────────────┐
                             │         TABLE_SCAN        │
                             │    ────────────────────   │
                             │      Table: date_dim      │
                             │   Type: Sequential Scan   │
                             │                           │
                             │        Projections:       │
                             │         d_date_sk         │
                             │                           │
                             │    Filters: d_year=2000   │
                             │                           │
                             │          366 rows         │
                             │          (0.00s)          │
                             └───────────────────────────┘
