```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "pushdown",
      "nodes": {
        "year_total": "SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, c_preferred_cust_flag AS customer_preferred_cust_flag, c_birth_country AS customer_birth_country, c_login AS customer_login, c_email_address AS customer_email_address, d_year AS dyear, SUM(((ss_ext_list_price - ss_ext_wholesale_cost - ss_ext_discount_amt) + ss_ext_sales_price) / 2) AS year_total, 's' AS sale_type FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (2001, 2002) GROUP BY c_customer_id, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_country, c_login, c_email_address, d_year UNION ALL SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, c_preferred_cust_flag AS customer_preferred_cust_flag, c_birth_country AS customer_birth_country, c_login AS customer_login, c_email_address AS customer_email_address, d_year AS dyear, SUM((((cs_ext_list_price - cs_ext_wholesale_cost - cs_ext_discount_amt) + cs_ext_sales_price) / 2)) AS year_total, 'c' AS sale_type FROM customer, catalog_sales, date_dim WHERE c_customer_sk = cs_bill_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year IN (2001, 2002) GROUP BY c_customer_id, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_country, c_login, c_email_address, d_year UNION ALL SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, c_preferred_cust_flag AS customer_preferred_cust_flag, c_birth_country AS customer_birth_country, c_login AS customer_login, c_email_address AS customer_email_address, d_year AS dyear, SUM((((ws_ext_list_price - ws_ext_wholesale_cost - ws_ext_discount_amt) + ws_ext_sales_price) / 2)) AS year_total, 'w' AS sale_type FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year IN (2001, 2002) GROUP BY c_customer_id, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_country, c_login, c_email_address, d_year"
      },
      "invariants_kept": [
        "same result rows", 
        "same column output",
        "same grain"
      ],
      "expected_speedup": "2.71x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "multi_push_predicate",
      "nodes": {
        "year_total_filtered": "SELECT * FROM year_total WHERE (sale_type = 's' AND dyear = 2001) OR (sale_type = 's' AND dyear = 2002) OR (sale_type = 'c' AND dyear = 2001) OR (sale_type = 'c' AND dyear = 2002) OR (sale_type = 'w' AND dyear = 2001) OR (sale_type = 'w' AND dyear = 2002)",
        "main_query": "SELECT t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name, t_s_secyear.customer_preferred_cust_flag FROM (SELECT * FROM year_total_filtered WHERE sale_type = 's' AND dyear = 2001) AS t_s_firstyear, (SELECT * FROM year_total_filtered WHERE sale_type = 's' AND dyear = 2002) AS t_s_secyear, (SELECT * FROM year_total_filtered WHERE sale_type = 'c' AND dyear = 2001) AS t_c_firstyear, (SELECT * FROM year_total_filtered WHERE sale_type = 'c' AND dyear = 2002) AS t_c_secyear, (SELECT * FROM year_total_filtered WHERE sale_type = 'w' AND dyear = 2001) AS t_w_firstyear, (SELECT * FROM year_total_filtered WHERE sale_type = 'w' AND dyear = 2002) AS t_w_secyear WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id AND t_s_firstyear.customer_id = t_c_secyear.customer_id AND t_s_firstyear.customer_id = t_c_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_secyear.customer_id AND t_s_firstyear.year_total > 0 AND t_c_firstyear.year_total > 0 AND t_w_firstyear.year_total > 0 AND CASE WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / NULLIF(t_c_firstyear.year_total, 0) ELSE NULL END > CASE WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / NULLIF(t_s_firstyear.year_total, 0) ELSE NULL END AND CASE WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / NULLIF(t_c_firstyear.year_total, 0) ELSE NULL END > CASE WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / NULLIF(t_w_firstyear.year_total, 0) ELSE NULL END ORDER BY t_s_secyear.customer_id NULLS FIRST, t_s_secyear.customer_first_name NULLS FIRST, t_s_secyear.customer_last_name NULLS FIRST, t_s_secyear.customer_preferred_cust_flag NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering", 
        "same column output"
      ],
      "expected_speedup": "1.5x",
      "risk": "low"
    }
  ],
  "explanation": "Applied two complementary optimizations: 1) Pushdown: Added d_year IN (2001, 2002) predicate directly into the year_total CTE before aggregation, drastically reducing the fact table scans from 6Ã—unfiltered to only scanning for relevant years. 2) Multi-push predicate: Created explicit filtered subqueries for each instance (t_s_firstyear, t_s_secyear, etc.) that apply sale_type and dyear filters before the 6-way join, reducing the join cardinality by filtering early. These work together: the CTE now only produces data for years 2001-2002, and the main query filters those further by sale_type and specific year before joining."
}
```