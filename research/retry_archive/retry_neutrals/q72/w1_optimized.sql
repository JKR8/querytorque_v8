WITH filtered_d1 AS (SELECT d_date_sk, d_date, d_week_seq FROM date_dim WHERE d_year = 1999), filtered_d2 AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM filtered_d1)), filtered_d3 AS (SELECT d_date_sk, d_date FROM date_dim), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000')
SELECT i_item_desc, w_warehouse_name, fd1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales AS cs JOIN filtered_d1 AS fd1 ON cs.cs_sold_date_sk = fd1.d_date_sk JOIN filtered_d2 AS fd2 ON fd1.d_week_seq = fd2.d_week_seq JOIN filtered_d3 AS fd3 ON cs.cs_ship_date_sk = fd3.d_date_sk AND fd3.d_date > fd1.d_date + 5 JOIN inventory AS inv ON inv.inv_item_sk = cs.cs_item_sk AND inv.inv_date_sk = fd2.d_date_sk AND inv.inv_quantity_on_hand < cs.cs_quantity JOIN warehouse AS w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN item AS i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_cd AS cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_hd AS hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk LEFT OUTER JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns AS cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number GROUP BY i_item_desc, w_warehouse_name, fd1.d_week_seq ORDER BY total_cnt DESC NULLS FIRST, i_item_desc NULLS FIRST, w_warehouse_name NULLS FIRST, fd1.d_week_seq NULLS FIRST LIMIT 100