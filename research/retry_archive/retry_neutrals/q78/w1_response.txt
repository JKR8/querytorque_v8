```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "date_2000": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "ss": "SELECT 2000 AS ss_sold_year, ss_item_sk, ss_customer_sk, SUM(ss_quantity) AS ss_qty, SUM(ss_wholesale_cost) AS ss_wc, SUM(ss_sales_price) AS ss_sp FROM store_sales LEFT JOIN store_returns ON sr_ticket_number = ss_ticket_number AND ss_item_sk = sr_item_sk JOIN date_2000 ON ss_sold_date_sk = d_date_sk WHERE sr_ticket_number IS NULL GROUP BY ss_item_sk, ss_customer_sk",
        "ws": "SELECT 2000 AS ws_sold_year, ws_item_sk, ws_bill_customer_sk AS ws_customer_sk, SUM(ws_quantity) AS ws_qty, SUM(ws_wholesale_cost) AS ws_wc, SUM(ws_sales_price) AS ws_sp FROM web_sales LEFT JOIN web_returns ON wr_order_number = ws_order_number AND ws_item_sk = wr_item_sk JOIN date_2000 ON ws_sold_date_sk = d_date_sk WHERE wr_order_number IS NULL GROUP BY ws_item_sk, ws_bill_customer_sk",
        "cs": "SELECT 2000 AS cs_sold_year, cs_item_sk, cs_bill_customer_sk AS cs_customer_sk, SUM(cs_quantity) AS cs_qty, SUM(cs_wholesale_cost) AS cs_wc, SUM(cs_sales_price) AS cs_sp FROM catalog_sales LEFT JOIN catalog_returns ON cr_order_number = cs_order_number AND cs_item_sk = cr_item_sk JOIN date_2000 ON cs_sold_date_sk = d_date_sk WHERE cr_order_number IS NULL GROUP BY cs_item_sk, cs_bill_customer_sk",
        "main_query": "SELECT ss_sold_year, ss_item_sk, ss_customer_sk, ROUND((ss_qty * 1.00) / (COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0)), 2) AS ratio, ss_qty AS store_qty, ss_wc AS store_wholesale_cost, ss_sp AS store_sales_price, COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0) AS other_chan_qty, COALESCE(ws_wc, 0) + COALESCE(cs_wc, 0) AS other_chan_wholesale_cost, COALESCE(ws_sp, 0) + COALESCE(cs_sp, 0) AS other_chan_sales_price FROM ss LEFT JOIN ws ON (ws_item_sk = ss_item_sk AND ws_customer_sk = ss_customer_sk) LEFT JOIN cs ON (cs_item_sk = ss_item_sk AND cs_customer_sk = ss_customer_sk) WHERE (COALESCE(ws_qty, 0) > 0 OR COALESCE(cs_qty, 0) > 0) ORDER BY ss_sold_year, ss_item_sk, ss_customer_sk, ss_qty DESC, ss_wc DESC, ss_sp DESC, other_chan_qty, other_chan_wholesale_cost, other_chan_sales_price, ratio LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same grain (year=2000)",
        "same aggregation semantics"
      ],
      "expected_speedup": "3.5x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "or_to_union",
      "nodes": {
        "date_2000": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "ss": "SELECT 2000 AS ss_sold_year, ss_item_sk, ss_customer_sk, SUM(ss_quantity) AS ss_qty, SUM(ss_wholesale_cost) AS ss_wc, SUM(ss_sales_price) AS ss_sp FROM store_sales LEFT JOIN store_returns ON sr_ticket_number = ss_ticket_number AND ss_item_sk = sr_item_sk JOIN date_2000 ON ss_sold_date_sk = d_date_sk WHERE sr_ticket_number IS NULL GROUP BY ss_item_sk, ss_customer_sk",
        "ws": "SELECT 2000 AS ws_sold_year, ws_item_sk, ws_bill_customer_sk AS ws_customer_sk, SUM(ws_quantity) AS ws_qty, SUM(ws_wholesale_cost) AS ws_wc, SUM(ws_sales_price) AS ws_sp FROM web_sales LEFT JOIN web_returns ON wr_order_number = ws_order_number AND ws_item_sk = wr_item_sk JOIN date_2000 ON ws_sold_date_sk = d_date_sk WHERE wr_order_number IS NULL GROUP BY ws_item_sk, ws_bill_customer_sk",
        "cs": "SELECT 2000 AS cs_sold_year, cs_item_sk, cs_bill_customer_sk AS cs_customer_sk, SUM(cs_quantity) AS cs_qty, SUM(cs_wholesale_cost) AS cs_wc, SUM(cs_sales_price) AS cs_sp FROM catalog_sales LEFT JOIN catalog_returns ON cr_order_number = cs_order_number AND cs_item_sk = cr_item_sk JOIN date_2000 ON cs_sold_date_sk = d_date_sk WHERE cr_order_number IS NULL GROUP BY cs_item_sk, cs_bill_customer_sk",
        "main_ws_qty": "SELECT ss_sold_year, ss_item_sk, ss_customer_sk, ROUND((ss_qty * 1.00) / (COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0)), 2) AS ratio, ss_qty AS store_qty, ss_wc AS store_wholesale_cost, ss_sp AS store_sales_price, COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0) AS other_chan_qty, COALESCE(ws_wc, 0) + COALESCE(cs_wc, 0) AS other_chan_wholesale_cost, COALESCE(ws_sp, 0) + COALESCE(cs_sp, 0) AS other_chan_sales_price FROM ss LEFT JOIN ws ON (ws_item_sk = ss_item_sk AND ws_customer_sk = ss_customer_sk) LEFT JOIN cs ON (cs_item_sk = ss_item_sk AND cs_customer_sk = ss_customer_sk) WHERE COALESCE(ws_qty, 0) > 0",
        "main_cs_qty": "SELECT ss_sold_year, ss_item_sk, ss_customer_sk, ROUND((ss_qty * 1.00) / (COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0)), 2) AS ratio, ss_qty AS store_qty, ss_wc AS store_wholesale_cost, ss_sp AS store_sales_price, COALESCE(ws_qty, 0) + COALESCE(cs_qty, 0) AS other_chan_qty, COALESCE(ws_wc, 0) + COALESCE(cs_wc, 0) AS other_chan_wholesale_cost, COALESCE(ws_sp, 0) + COALESCE(cs_sp, 0) AS other_chan_sales_price FROM ss LEFT JOIN ws ON (ws_item_sk = ss_item_sk AND ws_customer_sk = ss_customer_sk) LEFT JOIN cs ON (cs_item_sk = ss_item_sk AND cs_customer_sk = ss_customer_sk) WHERE COALESCE(cs_qty, 0) > 0 AND COALESCE(ws_qty, 0) <= 0",
        "main_query": "SELECT * FROM main_ws_qty UNION ALL SELECT * FROM main_cs_qty ORDER BY ss_sold_year, ss_item_sk, ss_customer_sk, ss_qty DESC, ss_wc DESC, ss_sp DESC, other_chan_qty, other_chan_wholesale_cost, other_chan_sales_price, ratio LIMIT 100"
      },
      "invariants_kept": [
        "same result rows (UNION ALL with exclusion)",
        "same output columns",
        "same ordering",
        "no duplicate rows"
      ],
      "expected_speedup": "2.2x",
      "risk": "medium"
    }
  ],
  "explanation": "Applied two optimizations: 1) Isolated date_dim filter to single CTE (date_2000) and pushed year=2000 into all CTEs, eliminating 2 redundant date_dim scans and filtering early. 2) Decomposed OR condition into UNION ALL branches: one where ws_qty>0, another where cs_qty>0 but ws_qtyâ‰¤0, eliminating the expensive OR evaluation across large joins. Combined expected speedup ~5-6x multiplicative."
}
```