WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12), web_sales_filtered AS (SELECT ws.ws_item_sk, ws.ws_order_number, ws.ws_quantity, ws.ws_net_paid, ws.ws_net_profit FROM web_sales AS ws JOIN filtered_date AS fd ON ws.ws_sold_date_sk = fd.d_date_sk WHERE ws.ws_net_profit > 1 AND ws.ws_net_paid > 0 AND ws.ws_quantity > 0), catalog_sales_filtered AS (SELECT cs.cs_item_sk, cs.cs_order_number, cs.cs_quantity, cs.cs_net_paid, cs.cs_net_profit FROM catalog_sales AS cs JOIN filtered_date AS fd ON cs.cs_sold_date_sk = fd.d_date_sk WHERE cs.cs_net_profit > 1 AND cs.cs_net_paid > 0 AND cs.cs_quantity > 0), store_sales_filtered AS (SELECT ss.ss_item_sk, ss.ss_ticket_number, ss.ss_quantity, ss.ss_net_paid, ss.ss_net_profit FROM store_sales AS ss JOIN filtered_date AS fd ON ss.ss_sold_date_sk = fd.d_date_sk WHERE ss.ss_net_profit > 1 AND ss.ss_net_paid > 0 AND ss.ss_quantity > 0), web_returns_filtered AS (SELECT wr.wr_order_number, wr.wr_item_sk, wr.wr_return_quantity, wr.wr_return_amt FROM web_returns AS wr WHERE wr.wr_return_amt > 10000), catalog_returns_filtered AS (SELECT cr.cr_order_number, cr.cr_item_sk, cr.cr_return_quantity, cr.cr_return_amount FROM catalog_returns AS cr WHERE cr.cr_return_amount > 10000), store_returns_filtered AS (SELECT sr.sr_ticket_number, sr.sr_item_sk, sr.sr_return_quantity, sr.sr_return_amt FROM store_returns AS sr WHERE sr.sr_return_amt > 10000), web_channel_base AS (SELECT wsf.ws_item_sk AS item, CAST(SUM(COALESCE(wrf.wr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(wsf.ws_quantity, 0)) AS DECIMAL(15, 4)) AS return_ratio, CAST(SUM(COALESCE(wrf.wr_return_amt, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(wsf.ws_net_paid, 0)) AS DECIMAL(15, 4)) AS currency_ratio FROM web_sales_filtered AS wsf LEFT JOIN web_returns_filtered AS wrf ON wsf.ws_order_number = wrf.wr_order_number AND wsf.ws_item_sk = wrf.wr_item_sk GROUP BY wsf.ws_item_sk), catalog_channel_base AS (SELECT csf.cs_item_sk AS item, CAST(SUM(COALESCE(crf.cr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(csf.cs_quantity, 0)) AS DECIMAL(15, 4)) AS return_ratio, CAST(SUM(COALESCE(crf.cr_return_amount, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(csf.cs_net_paid, 0)) AS DECIMAL(15, 4)) AS currency_ratio FROM catalog_sales_filtered AS csf LEFT JOIN catalog_returns_filtered AS crf ON csf.cs_order_number = crf.cr_order_number AND csf.cs_item_sk = crf.cr_item_sk GROUP BY csf.cs_item_sk), store_channel_base AS (SELECT ssf.ss_item_sk AS item, CAST(SUM(COALESCE(srf.sr_return_quantity, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(ssf.ss_quantity, 0)) AS DECIMAL(15, 4)) AS return_ratio, CAST(SUM(COALESCE(srf.sr_return_amt, 0)) AS DECIMAL(15, 4)) / CAST(SUM(COALESCE(ssf.ss_net_paid, 0)) AS DECIMAL(15, 4)) AS currency_ratio FROM store_sales_filtered AS ssf LEFT JOIN store_returns_filtered AS srf ON ssf.ss_ticket_number = srf.sr_ticket_number AND ssf.ss_item_sk = srf.sr_item_sk GROUP BY ssf.ss_item_sk), web_channel_ranked AS (SELECT 'web' AS channel, item, return_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM web_channel_base), catalog_channel_ranked AS (SELECT 'catalog' AS channel, item, return_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM catalog_channel_base), store_channel_ranked AS (SELECT 'store' AS channel, item, return_ratio, RANK() OVER (ORDER BY return_ratio) AS return_rank, RANK() OVER (ORDER BY currency_ratio) AS currency_rank FROM store_channel_base)
SELECT channel, item, return_ratio, return_rank, currency_rank FROM (SELECT * FROM web_channel_ranked WHERE return_rank <= 10 OR currency_rank <= 10 UNION SELECT * FROM catalog_channel_ranked WHERE return_rank <= 10 OR currency_rank <= 10 UNION SELECT * FROM store_channel_ranked WHERE return_rank <= 10 OR currency_rank <= 10) AS sq1 ORDER BY 1 NULLS FIRST, 4 NULLS FIRST, 5 NULLS FIRST, 2 NULLS FIRST LIMIT 100