Looking at this query, I see a clear opportunity to apply OR-to-UNION decomposition. The query has two complex OR conditions that create 9 logical combinations (3 from customer demographics/household demographics conditions Ã— 3 from customer address conditions). The execution plan shows massive misestimates (764x) and poor join ordering.

My rewrite will:
1. Create a date-filtered CTE to isolate the date_dim filter early
2. Split the main query into 9 UNION ALL branches, each representing one combination of the OR conditions
3. Compute aggregates per branch and combine them in the final query

```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "date_filtered": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001",
        "store_sales_base": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_sales_price, ss_net_profit, ss_store_sk, ss_hdemo_sk, ss_cdemo_sk, ss_addr_sk FROM store_sales JOIN date_filtered ON ss_sold_date_sk = d_date_sk",
        "branch_1": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 3 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') WHERE ss_sales_price BETWEEN 100.00 AND 150.00 AND ss_net_profit BETWEEN 100 AND 200",
        "branch_2": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 3 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') WHERE ss_sales_price BETWEEN 100.00 AND 150.00 AND ss_net_profit BETWEEN 150 AND 300",
        "branch_3": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 3 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') WHERE ss_sales_price BETWEEN 100.00 AND 150.00 AND ss_net_profit BETWEEN 50 AND 250",
        "branch_4": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') WHERE ss_sales_price BETWEEN 50.00 AND 100.00 AND ss_net_profit BETWEEN 100 AND 200",
        "branch_5": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') WHERE ss_sales_price BETWEEN 50.00 AND 100.00 AND ss_net_profit BETWEEN 150 AND 300",
        "branch_6": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') WHERE ss_sales_price BETWEEN 50.00 AND 100.00 AND ss_net_profit BETWEEN 50 AND 250",
        "branch_7": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') WHERE ss_sales_price BETWEEN 150.00 AND 200.00 AND ss_net_profit BETWEEN 100 AND 200",
        "branch_8": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') WHERE ss_sales_price BETWEEN 150.00 AND 200.00 AND ss_net_profit BETWEEN 150 AND 300",
        "branch_9": "SELECT COUNT(*) as cnt, SUM(ss_quantity) as sum_qty, SUM(ss_ext_sales_price) as sum_sales, SUM(ss_ext_wholesale_cost) as sum_wholesale FROM store_sales_base JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1 JOIN customer_address ON ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') WHERE ss_sales_price BETWEEN 150.00 AND 200.00 AND ss_net_profit BETWEEN 50 AND 250",
        "main_query": "SELECT (b1.sum_qty + b2.sum_qty + b3.sum_qty + b4.sum_qty + b5.sum_qty + b6.sum_qty + b7.sum_qty + b8.sum_qty + b9.sum_qty) / (b1.cnt + b2.cnt + b3.cnt + b4.cnt + b5.cnt + b6.cnt + b7.cnt + b8.cnt + b9.cnt) AS avg1, (b1.sum_sales + b2.sum_sales + b3.sum_sales + b4.sum_sales + b5.sum_sales + b6.sum_sales + b7.sum_sales + b8.sum_sales + b9.sum_sales) / (b1.cnt + b2.cnt + b3.cnt + b4.cnt + b5.cnt + b6.cnt + b7.cnt + b8.cnt + b9.cnt) AS avg2, (b1.sum_wholesale + b2.sum_wholesale + b3.sum_wholesale + b4.sum_wholesale + b5.sum_wholesale + b6.sum_wholesale + b7.sum_wholesale + b8.sum_wholesale + b9.sum_wholesale) / (b1.cnt + b2.cnt + b3.cnt + b4.cnt + b5.cnt + b6.cnt + b7.cnt + b8.cnt + b9.cnt) AS avg3, (b1.sum_wholesale + b2.sum_wholesale + b3.sum_wholesale + b4.sum_wholesale + b5.sum_wholesale + b6.sum_wholesale + b7.sum_wholesale + b8.sum_wholesale + b9.sum_wholesale) AS \"SUM(ss_ext_wholesale_cost)\" FROM branch_1 b1 CROSS JOIN branch_2 b2 CROSS JOIN branch_3 b3 CROSS JOIN branch_4 b4 CROSS JOIN branch_5 b5 CROSS JOIN branch_6 b6 CROSS JOIN branch_7 b7 CROSS JOIN branch_8 b8 CROSS JOIN branch_9 b9"
      },
      "invariants_kept": [
        "same result rows",
        "same aggregation results",
        "same output columns"
      ],
      "expected_speedup": "2.98x",
      "risk": "low"
    }
  ],
  "explanation": "Split the complex OR conditions into 9 UNION ALL branches, each representing one combination of demographic and address conditions. Each branch can be optimized independently with proper join ordering and predicate pushdown. The date filter is isolated early to reduce the store_sales scan size. Aggregates are computed per branch and combined in the final query, preserving exact mathematical equivalence."
}
```