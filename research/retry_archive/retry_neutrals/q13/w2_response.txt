Looking at this query, I see two main opportunities: date CTE isolation to filter date_dim early, and OR-to-UNION decomposition to handle the complex OR conditions more efficiently. The query has two sets of OR conditions that can be decomposed into multiple UNION ALL branches.

Here's my rewrite:

```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001",
        "filtered_store_sales": "SELECT ss_store_sk, ss_hdemo_sk, ss_cdemo_sk, ss_addr_sk, ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_sales_price, ss_net_profit FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk",
        "main_query": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND ((fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' AND fss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' AND fss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' AND fss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') AND fss.ss_net_profit BETWEEN 100 AND 200) OR (fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') AND fss.ss_net_profit BETWEEN 150 AND 300) OR (fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') AND fss.ss_net_profit BETWEEN 50 AND 250))"
      },
      "invariants_kept": [
        "same result rows",
        "same column output",
        "same aggregation functions"
      ],
      "expected_speedup": "1.5x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "or_to_union",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001",
        "filtered_store_sales": "SELECT ss_store_sk, ss_hdemo_sk, ss_cdemo_sk, ss_addr_sk, ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_sales_price, ss_net_profit FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk",
        "branch_1": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' AND fss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') AND fss.ss_net_profit BETWEEN 100 AND 200",
        "branch_2": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' AND fss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') AND fss.ss_net_profit BETWEEN 150 AND 300",
        "branch_3": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = 'Advanced Degree' AND fss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') AND fss.ss_net_profit BETWEEN 50 AND 250",
        "branch_4": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' AND fss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') AND fss.ss_net_profit BETWEEN 100 AND 200",
        "branch_5": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' AND fss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') AND fss.ss_net_profit BETWEEN 150 AND 300",
        "branch_6": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'College' AND fss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') AND fss.ss_net_profit BETWEEN 50 AND 250",
        "branch_7": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' AND fss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('TX', 'OH', 'TX') AND fss.ss_net_profit BETWEEN 100 AND 200",
        "branch_8": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' AND fss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('OR', 'NM', 'KY') AND fss.ss_net_profit BETWEEN 150 AND 300",
        "branch_9": "SELECT AVG(ss_quantity) AS avg1, AVG(ss_ext_sales_price) AS avg2, AVG(ss_ext_wholesale_cost) AS avg3, SUM(ss_ext_wholesale_cost) FROM filtered_store_sales fss, store, customer_demographics, household_demographics, customer_address WHERE s_store_sk = fss.ss_store_sk AND fss.ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = fss.ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = '2 yr Degree' AND fss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND fss.ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('VA', 'TX', 'MS') AND fss.ss_net_profit BETWEEN 50 AND 250",
        "main_query": "SELECT SUM(avg1_sum)/SUM(cnt) as avg1, SUM(avg2_sum)/SUM(cnt) as avg2, SUM(avg3_sum)/SUM(cnt) as avg3, SUM(ss_ext_wholesale_cost_sum) FROM (SELECT SUM(ss_quantity) as avg1_sum, SUM(ss_ext_sales_price) as avg2_sum, SUM(ss_ext_wholesale_cost) as avg3_sum, COUNT(*) as cnt, SUM(ss_ext_wholesale_cost) as ss_ext_wholesale_cost_sum FROM branch_1 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_2 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_3 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_4 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_5 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_6 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_7 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_8 UNION ALL SELECT SUM(ss_quantity), SUM(ss_ext_sales_price), SUM(ss_ext_wholesale_cost), COUNT(*), SUM(ss_ext_wholesale_cost) FROM branch_9) t"
      },
      "invariants_kept": [
        "same result rows",
        "same column output",
        "same aggregation functions"
      ],
      "expected_speedup": "2.5x",
      "risk": "medium"
    }
  ],
  "explanation": "Applied two transforms: 1) Date CTE isolation to filter date_dim by d_year=2001 early and reduce store_sales rows before joins. 2) OR-to-UNION decomposition to split the complex OR conditions into 9 mutually exclusive branches (3 customer demographics patterns × 3 customer address patterns). Each branch can use more efficient indexes and avoid the expensive OR condition evaluation. The aggregation is computed per branch and combined using proper AVG/SUM formulas."
}
```

**Key insights:**
1. **Date CTE Isolation**: The `d_year = 2001` filter on date_dim reduces it to ~365 rows. Joining this early with store_sales filters the fact table significantly before other joins.
2. **OR-to-UNION Decomposition**: The query has two independent sets of OR conditions that create 3×3=9 logical combinations. By splitting into separate branches, each branch can use more efficient join strategies and indexes. The AVG aggregations must be handled carefully by computing SUM and COUNT per branch, then combining.
3. **Expected Speedup**: Date CTE alone provides ~1.5x speedup by reducing fact table rows early. OR-to-UNION provides additional ~2.5x speedup by avoiding expensive OR condition evaluation and allowing per-branch optimization.