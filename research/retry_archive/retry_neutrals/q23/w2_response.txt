```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "date_month_2000_2": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy = 2",
        "date_range_years": "SELECT d_date_sk FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)",
        "filtered_frequent_items": "SELECT i_item_sk, SUBSTRING(i_item_desc, 1, 30) AS itemdesc, d_date, COUNT(*) AS cnt FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_range_years ON ss_sold_date_sk = d_date_sk GROUP BY i_item_sk, itemdesc, d_date HAVING COUNT(*) > 4",
        "max_csales": "SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN date_range_years ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk",
        "tpcds_cmax": "SELECT MAX(csales) AS tpcds_cmax FROM max_csales",
        "best_customers": "SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (50 / 100.0) * (SELECT tpcds_cmax FROM tpcds_cmax)",
        "catalog_sales_month": "SELECT cs_bill_customer_sk, cs_item_sk, cs_quantity * cs_list_price AS sales FROM catalog_sales JOIN date_month_2000_2 ON cs_sold_date_sk = d_date_sk",
        "web_sales_month": "SELECT ws_bill_customer_sk, ws_item_sk, ws_quantity * ws_list_price AS sales FROM web_sales JOIN date_month_2000_2 ON ws_sold_date_sk = d_date_sk",
        "main_query": "SELECT c_last_name, c_first_name, SUM(sales) AS sales FROM (SELECT c_last_name, c_first_name, sales FROM catalog_sales_month cs JOIN customer ON cs.cs_bill_customer_sk = customer.c_customer_sk JOIN filtered_frequent_items fi ON cs.cs_item_sk = fi.i_item_sk JOIN best_customers bc ON cs.cs_bill_customer_sk = bc.c_customer_sk UNION ALL SELECT c_last_name, c_first_name, sales FROM web_sales_month ws JOIN customer ON ws.ws_bill_customer_sk = customer.c_customer_sk JOIN filtered_frequent_items fi ON ws.ws_item_sk = fi.i_item_sk JOIN best_customers bc ON ws.ws_bill_customer_sk = bc.c_customer_sk) sq GROUP BY c_last_name, c_first_name ORDER BY c_last_name NULLS FIRST, c_first_name NULLS FIRST, sales NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same grouping and aggregation"
      ],
      "expected_speedup": "3.50x",
      "risk": "low"
    }
  ],
  "explanation": "Created two date CTEs: one for the month filter in main query (2000-02) and another for the year range (2000-2003) used in frequent_ss_items and max_store_sales. Pre-joined fact tables with appropriate date CTEs early to filter rows before expensive joins and aggregations. This reduces the cardinality of store_sales scans from 345M rows to only those matching date ranges. Also flattened subqueries into explicit CTEs for better optimization."
}
```