Looking at this query, I can identify two primary optimization opportunities:

1. **OR_TO_UNION**: The query has two complex OR conditions that can be decomposed into UNION ALL branches
2. **DATE_CTE_ISOLATE**: The date_dim filter (d_year = 2000) can be isolated into a CTE

The query has two independent OR conditions that are ANDed together:
1. Conditions on customer_demographics and web_sales price ranges (3 mutually exclusive branches)
2. Conditions on customer_address and web_sales profit ranges (3 branches with potentially overlapping profit ranges but disjoint state sets)

Since the state sets are disjoint ('IN', 'OH', 'NJ'), ('WI', 'CT', 'KY'), ('LA', 'IA', 'AR'), we can safely use UNION ALL without duplicates.

```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "main_query": "SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity) AS avg1, AVG(wr_refunded_cash) AS avg2, AVG(wr_fee) FROM web_sales, web_returns, web_page, customer_demographics AS cd1, customer_demographics AS cd2, customer_address, filtered_dates, reason WHERE ws_web_page_sk = wp_web_page_sk AND ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number AND ws_sold_date_sk = d_date_sk AND cd1.cd_demo_sk = wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr_returning_cdemo_sk AND ca_address_sk = wr_refunded_addr_sk AND r_reason_sk = wr_reason_sk AND ((cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Advanced Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca_country = 'United States' AND ca_state IN ('IN', 'OH', 'NJ') AND ws_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('WI', 'CT', 'KY') AND ws_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('LA', 'IA', 'AR') AND ws_net_profit BETWEEN 50 AND 250)) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
      },
      "invariants_kept": [
        "same result values",
        "same column output"
      ],
      "expected_speedup": "1.2x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "or_to_union",
      "nodes": {
        "branch_data": "SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Advanced Degree' AND ws_sales_price BETWEEN 100.00 AND 150.00 AND ca_country = 'United States' AND ca_state IN ('IN', 'OH', 'NJ') AND ws_net_profit BETWEEN 100 AND 200 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Advanced Degree' AND ws_sales_price BETWEEN 100.00 AND 150.00 AND ca_country = 'United States' AND ca_state IN ('WI', 'CT', 'KY') AND ws_net_profit BETWEEN 150 AND 300 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Advanced Degree' AND ws_sales_price BETWEEN 100.00 AND 150.00 AND ca_country = 'United States' AND ca_state IN ('LA', 'IA', 'AR') AND ws_net_profit BETWEEN 50 AND 250 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'College' AND ws_sales_price BETWEEN 50.00 AND 100.00 AND ca_country = 'United States' AND ca_state IN ('IN', 'OH', 'NJ') AND ws_net_profit BETWEEN 100 AND 200 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'College' AND ws_sales_price BETWEEN 50.00 AND 100.00 AND ca_country = 'United States' AND ca_state IN ('WI', 'CT', 'KY') AND ws_net_profit BETWEEN 150 AND 300 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'College' AND ws_sales_price BETWEEN 50.00 AND 100.00 AND ca_country = 'United States' AND ca_state IN ('LA', 'IA', 'AR') AND ws_net_profit BETWEEN 50 AND 250 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'W' AND cd1.cd_education_status = '2 yr Degree' AND ws_sales_price BETWEEN 150.00 AND 200.00 AND ca_country = 'United States' AND ca_state IN ('IN', 'OH', 'NJ') AND ws_net_profit BETWEEN 100 AND 200 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'W' AND cd1.cd_education_status = '2 yr Degree' AND ws_sales_price BETWEEN 150.00 AND 200.00 AND ca_country = 'United States' AND ca_state IN ('WI', 'CT', 'KY') AND ws_net_profit BETWEEN 150 AND 300 UNION ALL SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE cd1.cd_marital_status = 'W' AND cd1.cd_education_status = '2 yr Degree' AND ws_sales_price BETWEEN 150.00 AND 200.00 AND ca_country = 'United States' AND ca_state IN ('LA', 'IA', 'AR') AND ws_net_profit BETWEEN 50 AND 250",
        "main_query": "SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity) AS avg1, AVG(wr_refunded_cash) AS avg2, AVG(wr_fee) FROM branch_data GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same rows after aggregation",
        "same ordering"
      ],
      "expected_speedup": "3.0x",
      "risk": "medium"
    }
  ],
  "explanation": "Applied two transforms: 1) DATE_CTE_ISOLATE to create filtered_dates CTE for year 2000, reducing date_dim scan. 2) OR_TO_UNION to decompose the complex AND-OR conditions into 9 UNION ALL branches (3 marital/education status combinations Ã— 3 state/profit combinations). Each branch has focused predicates that allow better index usage and reduce the combinatorial explosion in join planning. The marital/education conditions are mutually exclusive, and state sets are disjoint, ensuring no duplicate rows in UNION ALL."
}
```