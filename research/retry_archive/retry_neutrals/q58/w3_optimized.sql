WITH filtered_items AS (SELECT s.item_id, s.ss_item_rev, c.cs_item_rev, w.ws_item_rev FROM ss_items AS s JOIN cs_items AS c ON s.item_id = c.item_id JOIN ws_items AS w ON s.item_id = w.item_id WHERE s.ss_item_rev BETWEEN 0.9 * c.cs_item_rev AND 1.1 * c.cs_item_rev AND s.ss_item_rev BETWEEN 0.9 * w.ws_item_rev AND 1.1 * w.ws_item_rev AND c.cs_item_rev BETWEEN 0.9 * s.ss_item_rev AND 1.1 * s.ss_item_rev AND c.cs_item_rev BETWEEN 0.9 * w.ws_item_rev AND 1.1 * w.ws_item_rev AND w.ws_item_rev BETWEEN 0.9 * s.ss_item_rev AND 1.1 * s.ss_item_rev AND w.ws_item_rev BETWEEN 0.9 * c.cs_item_rev AND 1.1 * c.cs_item_rev) SELECT item_id, ss_item_rev, ss_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ss_dev, cs_item_rev, cs_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS cs_dev, ws_item_rev, ws_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ws_dev, (ss_item_rev + cs_item_rev + ws_item_rev) / 3 AS average FROM filtered_items ORDER BY item_id NULLS FIRST, ss_item_rev NULLS FIRST LIMIT 100