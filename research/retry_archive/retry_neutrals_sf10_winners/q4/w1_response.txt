```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "date_filter": "SELECT d_date_sk FROM date_dim WHERE d_year IN (2001, 2002)",
        "year_total_store_2001": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2001 AS dyear, SUM(((ss_ext_list_price - ss_ext_wholesale_cost - ss_ext_discount_amt) + ss_ext_sales_price) / 2) AS year_total, 's' AS sale_type FROM customer c JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk JOIN date_filter df ON ss.ss_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag HAVING SUM(((ss_ext_list_price - ss_ext_wholesale_cost - ss_ext_discount_amt) + ss_ext_sales_price) / 2) > 0",
        "year_total_store_2002": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2002 AS dyear, SUM(((ss_ext_list_price - ss_ext_wholesale_cost - ss_ext_discount_amt) + ss_ext_sales_price) / 2) AS year_total, 's' AS sale_type FROM customer c JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk JOIN date_filter df ON ss.ss_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag",
        "year_total_catalog_2001": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2001 AS dyear, SUM(((cs_ext_list_price - cs_ext_wholesale_cost - cs_ext_discount_amt) + cs_ext_sales_price) / 2) AS year_total, 'c' AS sale_type FROM customer c JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk JOIN date_filter df ON cs.cs_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag HAVING SUM(((cs_ext_list_price - cs_ext_wholesale_cost - cs_ext_discount_amt) + cs_ext_sales_price) / 2) > 0",
        "year_total_catalog_2002": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2002 AS dyear, SUM(((cs_ext_list_price - cs_ext_wholesale_cost - cs_ext_discount_amt) + cs_ext_sales_price) / 2) AS year_total, 'c' AS sale_type FROM customer c JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk JOIN date_filter df ON cs.cs_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag",
        "year_total_web_2001": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2001 AS dyear, SUM(((ws_ext_list_price - ws_ext_wholesale_cost - ws_ext_discount_amt) + ws_ext_sales_price) / 2) AS year_total, 'w' AS sale_type FROM customer c JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk JOIN date_filter df ON ws.ws_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag HAVING SUM(((ws_ext_list_price - ws_ext_wholesale_cost - ws_ext_discount_amt) + ws_ext_sales_price) / 2) > 0",
        "year_total_web_2002": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_preferred_cust_flag AS customer_preferred_cust_flag, 2002 AS dyear, SUM(((ws_ext_list_price - ws_ext_wholesale_cost - ws_ext_discount_amt) + ws_ext_sales_price) / 2) AS year_total, 'w' AS sale_type FROM customer c JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk JOIN date_filter df ON ws.ws_sold_date_sk = df.d_date_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag",
        "main_query": "SELECT t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name, t_s_secyear.customer_preferred_cust_flag FROM year_total_store_2001 AS t_s_firstyear, year_total_store_2002 AS t_s_secyear, year_total_catalog_2001 AS t_c_firstyear, year_total_catalog_2002 AS t_c_secyear, year_total_web_2001 AS t_w_firstyear, year_total_web_2002 AS t_w_secyear WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id AND t_s_firstyear.customer_id = t_c_secyear.customer_id AND t_s_firstyear.customer_id = t_c_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_secyear.customer_id AND CASE WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / t_c_firstyear.year_total ELSE NULL END > CASE WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total ELSE NULL END AND CASE WHEN t_c_firstyear.year_total > 0 THEN t_c_secyear.year_total / t_c_firstyear.year_total ELSE NULL END > CASE WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total ELSE NULL END ORDER BY t_s_secyear.customer_id NULLS FIRST, t_s_secyear.customer_first_name NULLS FIRST, t_s_secyear.customer_last_name NULLS FIRST, t_s_secyear.customer_preferred_cust_flag NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same ordering",
        "same aggregation results"
      ],
      "expected_speedup": "3.5x",
      "risk": "low"
    }
  ],
  "explanation": "Created a date_filter CTE to isolate date_dim scans for years 2001 and 2002, reducing 6 scans to 1. Split the original year_total CTE into 6 separate CTEs, each filtered by specific year and sale_type with HAVING clause pushed down for year_total>0 conditions. This eliminates the UNION ALL and allows each fact table to be scanned only once per year with early filtering, reducing cardinality before joins. The main query now joins these pre-filtered CTEs directly."
}
```