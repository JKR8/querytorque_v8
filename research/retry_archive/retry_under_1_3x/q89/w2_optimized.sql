WITH filtered_dates AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 1999), filtered_store_sales AS (SELECT ss_item_sk, ss_store_sk, ss_sales_price, d_moy FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk), branch1 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, fss.d_moy, SUM(fss.ss_sales_price) AS sum_sales, AVG(SUM(fss.ss_sales_price)) OVER (PARTITION BY i.i_category, i.i_brand, s.s_store_name, s.s_company_name) AS avg_monthly_sales FROM filtered_store_sales AS fss JOIN item AS i ON fss.ss_item_sk = i.i_item_sk JOIN store AS s ON fss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Books', 'Electronics', 'Sports') AND i.i_class IN ('computers', 'stereo', 'football') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, fss.d_moy), branch2 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, fss.d_moy, SUM(fss.ss_sales_price) AS sum_sales, AVG(SUM(fss.ss_sales_price)) OVER (PARTITION BY i.i_category, i.i_brand, s.s_store_name, s.s_company_name) AS avg_monthly_sales FROM filtered_store_sales AS fss JOIN item AS i ON fss.ss_item_sk = i.i_item_sk JOIN store AS s ON fss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Men', 'Jewelry', 'Women') AND i.i_class IN ('shirts', 'birdal', 'dresses') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, fss.d_moy)
SELECT * FROM (SELECT * FROM branch1 UNION ALL SELECT * FROM branch2) AS tmp1 WHERE CASE WHEN (avg_monthly_sales <> 0) THEN (ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales) ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, s_store_name, 1, 2, 3, 5, 6, 7, 8 LIMIT 100