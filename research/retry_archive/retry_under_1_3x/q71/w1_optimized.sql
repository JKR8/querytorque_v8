WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 11 AND d_year = 1999), time_breakfast AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time = 'breakfast'), time_dinner AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time = 'dinner'), web_sales_union AS (SELECT ws_ext_sales_price AS ext_price, ws_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM web_sales AS ws JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN time_breakfast AS t ON ws.ws_sold_time_sk = t.t_time_sk UNION ALL SELECT ws_ext_sales_price AS ext_price, ws_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM web_sales AS ws JOIN date_filter AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN time_dinner AS t ON ws.ws_sold_time_sk = t.t_time_sk), catalog_sales_union AS (SELECT cs_ext_sales_price AS ext_price, cs_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM catalog_sales AS cs JOIN date_filter AS df ON cs.cs_sold_date_sk = df.d_date_sk JOIN time_breakfast AS t ON cs.cs_sold_time_sk = t.t_time_sk UNION ALL SELECT cs_ext_sales_price AS ext_price, cs_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM catalog_sales AS cs JOIN date_filter AS df ON cs.cs_sold_date_sk = df.d_date_sk JOIN time_dinner AS t ON cs.cs_sold_time_sk = t.t_time_sk), store_sales_union AS (SELECT ss_ext_sales_price AS ext_price, ss_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM store_sales AS ss JOIN date_filter AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN time_breakfast AS t ON ss.ss_sold_time_sk = t.t_time_sk UNION ALL SELECT ss_ext_sales_price AS ext_price, ss_item_sk AS sold_item_sk, t.t_hour, t.t_minute FROM store_sales AS ss JOIN date_filter AS df ON ss.ss_sold_date_sk = df.d_date_sk JOIN time_dinner AS t ON ss.ss_sold_time_sk = t.t_time_sk), all_sales AS (SELECT ext_price, sold_item_sk, t_hour, t_minute FROM web_sales_union UNION ALL SELECT ext_price, sold_item_sk, t_hour, t_minute FROM catalog_sales_union UNION ALL SELECT ext_price, sold_item_sk, t_hour, t_minute FROM store_sales_union)
SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM item AS i JOIN all_sales AS s ON i.i_item_sk = s.sold_item_sk WHERE i.i_manager_id = 1 GROUP BY i_brand, i_brand_id, t_hour, t_minute ORDER BY ext_price DESC NULLS FIRST, i_brand_id NULLS FIRST, t_hour NULLS FIRST