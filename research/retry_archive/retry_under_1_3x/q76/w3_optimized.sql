WITH filtered_dates AS (SELECT d_date_sk, d_year, d_qoy FROM date_dim), store_sales_filtered AS (SELECT 'store' AS channel, 'ss_store_sk' AS col_name, d_year, d_qoy, i_category, ss_ext_sales_price AS ext_sales_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE ss_store_sk IS NULL), web_sales_filtered AS (SELECT 'web' AS channel, 'ws_ship_customer_sk' AS col_name, d_year, d_qoy, i_category, ws_ext_sales_price AS ext_sales_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN item ON ws_item_sk = i_item_sk WHERE ws_ship_customer_sk IS NULL), catalog_sales_filtered AS (SELECT 'catalog' AS channel, 'cs_ship_addr_sk' AS col_name, d_year, d_qoy, i_category, cs_ext_sales_price AS ext_sales_price FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE cs_ship_addr_sk IS NULL)
SELECT channel, col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ext_sales_price) AS sales_amt FROM (SELECT * FROM store_sales_filtered UNION ALL SELECT * FROM web_sales_filtered UNION ALL SELECT * FROM catalog_sales_filtered) AS foo GROUP BY channel, col_name, d_year, d_qoy, i_category ORDER BY channel NULLS FIRST, col_name NULLS FIRST, d_year NULLS FIRST, d_qoy NULLS FIRST, i_category NULLS FIRST LIMIT 100