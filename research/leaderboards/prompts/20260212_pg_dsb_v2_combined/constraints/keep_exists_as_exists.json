{
  "id": "KEEP_EXISTS_AS_EXISTS",
  "severity": "HIGH",
  "overridable": true,
  "description": "Prefer preserving EXISTS/NOT EXISTS subqueries. Converting to IN/NOT IN risks NULL-handling changes; converting to JOINs risks duplicate rows.",
  "observed_failures": [
    {
      "problem": "Converting NOT EXISTS to NOT IN changes behavior when the subquery column contains NULLs. NOT IN with NULLs returns no rows.",
      "type": "NULL_SEMANTIC_CHANGE"
    },
    {
      "problem": "Converting EXISTS to JOIN can produce duplicate rows when the subquery matches multiple rows per outer row.",
      "type": "DUPLICATE_ROW_INTRODUCTION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "AVOID_EXISTS_TO_IN",
      "description": "Avoid converting EXISTS/NOT EXISTS to IN/NOT IN unless the subquery column is provably NOT NULL (has a NOT NULL constraint or is a primary key)."
    },
    {
      "rule": "EXISTS_TO_JOIN_NEEDS_DISTINCT",
      "description": "Converting EXISTS to JOIN requires SELECT DISTINCT or GROUP BY to prevent row duplication when the subquery matches multiple rows per outer row."
    }
  ],
  "override_conditions": [
    "The subquery join column has a NOT NULL constraint or is a primary key (safe for IN conversion)",
    "The subquery returns at most 1 row per outer row (1:1 relationship, safe for JOIN)",
    "EXISTS is converted to JOIN + DISTINCT/GROUP BY to explicitly handle duplicates"
  ],
  "prompt_instruction": "DEFAULT: Preserve EXISTS/NOT EXISTS as-is. NOT EXISTS→NOT IN breaks with NULLs; EXISTS→JOIN can duplicate rows. HOWEVER: if the join column is NOT NULL (PK or explicit constraint), EXISTS→IN is safe. If the subquery is 1:1 with the outer query, EXISTS→JOIN is safe. The exploration worker MAY convert EXISTS with written proof of NULL safety or 1:1 cardinality."
}
