{
  "id": "NO_MATERIALIZE_EXISTS",
  "severity": "HIGH",
  "overridable": true,
  "description": "Avoid converting EXISTS/NOT EXISTS subqueries into materialized CTEs with full table scans. EXISTS uses semi-join short-circuiting which is typically more efficient.",
  "failure_rate": "Caused 0.14x and 0.54x regressions (7x and 2x slowdowns)",
  "observed_failures": [
    {
      "query": "Q16",
      "regression": "0.14x (18ms -> 126ms)",
      "original": "EXISTS (SELECT * FROM catalog_sales cs2 WHERE cs1.cs_order_number = cs2.cs_order_number AND cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)",
      "broken_rewrite": "WITH multi_warehouse_orders AS (SELECT DISTINCT cs_order_number FROM catalog_sales GROUP BY cs_order_number HAVING MIN(cs_warehouse_sk) <> MAX(cs_warehouse_sk))",
      "type": "EXISTS_TO_FULL_SCAN_CTE"
    },
    {
      "query": "Q95",
      "regression": "0.54x (390ms -> 728ms)",
      "original": "EXISTS(SELECT 1 FROM ws_wh WHERE ws_wh.ws_order_number = ws1.ws_order_number)",
      "broken_rewrite": "WITH multi_warehouse_orders AS (SELECT DISTINCT ws_order_number FROM ws_wh)",
      "type": "EXISTS_TO_MATERIALIZED_DISTINCT"
    }
  ],
  "observed_successes": [
    {
      "query": "Q14",
      "speedup": "1.83x",
      "context": "intersect_to_exists: INTERSECT converted to EXISTS for semi-join short-circuit. Shows EXISTS restructuring CAN help when applied in the right direction."
    }
  ],
  "constraint_rules": [
    {
      "rule": "PREFER_EXISTS_SEMI_JOIN",
      "description": "EXISTS and NOT EXISTS use semi-join optimization that short-circuits after finding the first match. Converting to materialized CTEs usually forces a full scan."
    },
    {
      "rule": "AVOID_FULL_TABLE_DISTINCT_CTE",
      "description": "Avoid creating CTEs like SELECT DISTINCT key FROM large_table to replace EXISTS. The CTE scans the entire table; EXISTS can stop after one match."
    }
  ],
  "override_conditions": [
    "The EXISTS subquery is correlated and executed many times (optimizer fails to decorrelate it)",
    "The CTE would be small (<10K rows) and probed multiple times, amortizing materialization cost",
    "The EXISTS is inside a UNION ALL branch where each branch re-executes the same correlated subquery"
  ],
  "prompt_instruction": "DEFAULT: Keep EXISTS/NOT EXISTS as-is â€” semi-join short-circuiting is usually faster than materialization. Converting to CTEs caused 0.14x on Q16 and 0.54x on Q95. HOWEVER: if the correlated EXISTS is executed many times and the optimizer fails to decorrelate it, materializing into a small CTE (<10K rows) probed via JOIN may help. The exploration worker MAY attempt this with reasoning about correlation frequency and CTE size."
}
