{
  "id": "UNION_CTE_SPLIT_MUST_REPLACE",
  "severity": "HIGH",
  "description": "When splitting a UNION into separate CTEs, the original UNION must be eliminated. Creating CTEs that duplicate the UNION branches while keeping the original UNION doubles the work.",
  "observed_failures": [
    {
      "query": "multiple",
      "problem": "UNION branches were extracted into CTEs but the original UNION ALL remained in the main query, causing each branch to be computed twice.",
      "type": "DUPLICATE_UNION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "CTE_SPLIT_REPLACES_UNION",
      "description": "When applying union_cte_split, the final query must reference the CTEs instead of the original UNION. The total number of UNION ALL operations should not increase."
    }
  ],
  "prompt_instruction": "When applying union_cte_split (splitting UNION into CTEs), the original UNION must be eliminated from the main query. The main query should reference the split CTEs, not duplicate the UNION branches. If the rewritten query has more UNION ALL operations than the original, the rewrite is incorrect."
}
