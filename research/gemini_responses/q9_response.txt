{
  "operations": [
    {
      "op": "add_cte",
      "after": "start",
      "name": "aggregates",
      "sql": "select\n        count(case when ss_quantity between 1 and 20 then 1 end) as c1,\n        avg(case when ss_quantity between 1 and 20 then ss_ext_sales_price end) as a1_price,\n        avg(case when ss_quantity between 1 and 20 then ss_net_profit end) as a1_profit,\n        count(case when ss_quantity between 21 and 40 then 1 end) as c2,\n        avg(case when ss_quantity between 21 and 40 then ss_ext_sales_price end) as a2_price,\n        avg(case when ss_quantity between 21 and 40 then ss_net_profit end) as a2_profit,\n        count(case when ss_quantity between 41 and 60 then 1 end) as c3,\n        avg(case when ss_quantity between 41 and 60 then ss_ext_sales_price end) as a3_price,\n        avg(case when ss_quantity between 41 and 60 then ss_net_profit end) as a3_profit,\n        count(case when ss_quantity between 61 and 80 then 1 end) as c4,\n        avg(case when ss_quantity between 61 and 80 then ss_ext_sales_price end) as a4_price,\n        avg(case when ss_quantity between 61 and 80 then ss_net_profit end) as a4_profit,\n        count(case when ss_quantity between 81 and 100 then 1 end) as c5,\n        avg(case when ss_quantity between 81 and 100 then ss_ext_sales_price end) as a5_price,\n        avg(case when ss_quantity between 81 and 100 then ss_net_profit end) as a5_profit\nfrom store_sales"
    },
    {
      "op": "replace_clause",
      "target": "main_query.select",
      "sql": "select case when c1 > 2972190 then a1_price else a1_profit end bucket1,\n       case when c2 > 4505785 then a2_price else a2_profit end bucket2,\n       case when c3 > 1575726 then a3_price else a3_profit end bucket3,\n       case when c4 > 3188917 then a4_price else a4_profit end bucket4,\n       case when c5 > 3525216 then a5_price else a5_profit end bucket5"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from reason, aggregates"
    }
  ],
  "semantic_warnings": [
    "Consolidated 15 scans of store_sales into 1 scan using conditional aggregation."
  ],
  "explanation": "Replaced multiple independent subqueries scanning the same table with a single pass aggregation using CASE WHEN. This dramatically reduces I/O."
}