{
  "operations": [
    {
      "op": "add_cte",
      "after": "start",
      "name": "store_shoppers",
      "sql": "select distinct ss_customer_sk from store_sales, date_dim where ss_sold_date_sk = d_date_sk and d_year = 2001 and d_moy between 1 and 4"
    },
    {
      "op": "add_cte",
      "after": "store_shoppers",
      "name": "web_shoppers",
      "sql": "select distinct ws_bill_customer_sk from web_sales, date_dim where ws_sold_date_sk = d_date_sk and d_year = 2001 and d_moy between 1 and 4"
    },
    {
      "op": "add_cte",
      "after": "web_shoppers",
      "name": "catalog_shoppers",
      "sql": "select distinct cs_ship_customer_sk from catalog_sales, date_dim where cs_sold_date_sk = d_date_sk and d_year = 2001 and d_moy between 1 and 4"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from customer c\n     join customer_address ca on c.c_current_addr_sk = ca.ca_address_sk\n     join customer_demographics on cd_demo_sk = c.c_current_cdemo_sk\n     join store_shoppers ss on c.c_customer_sk = ss.ss_customer_sk\n     join (select ws_bill_customer_sk as customer_sk from web_shoppers union select cs_ship_customer_sk from catalog_shoppers) other on c.c_customer_sk = other.customer_sk"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "where ca_county in ('Storey County','Marquette County','Warren County','Cochran County','Kandiyohi County')"
    }
  ],
  "semantic_warnings": [
    "Replaced correlated EXISTS subqueries with explicit Joins against pre-calculated unique shopper sets."
  ],
  "explanation": "Converted row-by-row correlated subquery lookups into set-based joins. Created CTEs for customers who shopped in each channel during the target period, then joined them to valid customers."
}