{
  "operations": [
    {
      "op": "replace_cte",
      "name": "customer_total_return",
      "sql": "select sr_customer_sk as ctr_customer_sk\n,sr_store_sk as ctr_store_sk\n,sum(SR_FEE) as ctr_total_return\n,avg(sum(SR_FEE)) over (partition by sr_store_sk) as ctr_store_avg\nfrom store_returns\n,date_dim\n,store\nwhere sr_returned_date_sk = d_date_sk\nand d_year =2000\nand sr_store_sk = s_store_sk\nand s_state = 'SD'\ngroup by sr_customer_sk\n,sr_store_sk"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from customer_total_return ctr1\n,customer"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "where ctr1.ctr_total_return > ctr1.ctr_store_avg*1.2\nand ctr1.ctr_customer_sk = c_customer_sk\nand s_state = 'SD'"
    }
  ],
  "semantic_warnings": [
    "Moved 'store' join into CTE for early filtering (Predicate Pushdown).",
    "Replaced correlated subquery with window function 'ctr_store_avg'."
  ],
  "explanation": "Pushed the store state filter ('SD') into the CTE to reduce the aggregation set. Replaced the correlated subquery (which re-scanned the CTE) with a window function computed in the same pass."
}