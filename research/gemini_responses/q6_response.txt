{
  "operations": [
    {
      "op": "add_cte",
      "after": "start",
      "name": "item_avg",
      "sql": "select i_item_sk, i_current_price, i_category, avg(i_current_price) over (partition by i_category) as cat_avg from item"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from customer_address a\n     ,customer c\n     ,store_sales s\n     ,date_dim d\n     ,item_avg i"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "where       a.ca_address_sk = c.c_current_addr_sk\n \tand c.c_customer_sk = s.ss_customer_sk\n \tand s.ss_sold_date_sk = d.d_date_sk\n \tand s.ss_item_sk = i.i_item_sk\n \tand d.d_month_seq = \n \t     (select distinct (d_month_seq)\n \t      from date_dim\n               where d_year = 2002\n \t        and d_moy = 3 )\n \tand i.i_current_price > 1.2 * i.cat_avg"
    }
  ],
  "semantic_warnings": [
    "Replaced correlated subquery on 'item' with window function in 'item_avg' CTE."
  ],
  "explanation": "Converted the correlated subquery calculating average price per category into a window function within a CTE. This avoids rescanning the item table for every row."
}