WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-27' AS DATE) - INTERVAL '30' DAY) AND (CAST('2002-02-27' AS DATE) + INTERVAL '30' DAY)), filtered_items AS (SELECT i_item_sk, i_item_id FROM item WHERE i_current_price BETWEEN 0.99 AND 1.49), filtered_inventory AS (SELECT inv_warehouse_sk, inv_item_sk, inv_quantity_on_hand, inv_date_sk FROM inventory), main_aggregation AS (SELECT w_warehouse_name, filtered_items.i_item_id, SUM(CASE WHEN (CAST(filtered_dates.d_date AS DATE) < CAST('2002-02-27' AS DATE)) THEN filtered_inventory.inv_quantity_on_hand ELSE 0 END) AS inv_before, SUM(CASE WHEN (CAST(filtered_dates.d_date AS DATE) >= CAST('2002-02-27' AS DATE)) THEN filtered_inventory.inv_quantity_on_hand ELSE 0 END) AS inv_after FROM filtered_inventory JOIN filtered_dates ON filtered_inventory.inv_date_sk = filtered_dates.d_date_sk JOIN filtered_items ON filtered_inventory.inv_item_sk = filtered_items.i_item_sk JOIN warehouse ON filtered_inventory.inv_warehouse_sk = warehouse.w_warehouse_sk GROUP BY w_warehouse_name, filtered_items.i_item_id)
SELECT * FROM main_aggregation WHERE (CASE WHEN inv_before > 0 THEN inv_after / inv_before ELSE NULL END) BETWEEN 2.0 / 3.0 AND 3.0 / 2.0 ORDER BY w_warehouse_name, i_item_id LIMIT 100