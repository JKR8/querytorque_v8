{
  "query_num": 50,
  "status": "success",
  "original_sql": "-- start query 50 in stream 0 using template query50.tpl\nselect \n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\" \n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and \n                 (sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\" \n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and \n                 (sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\" \n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\" \n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\" \nfrom\n   store_sales\n  ,store_returns\n  ,store\n  ,date_dim d1\n  ,date_dim d2\nwhere\n    d2.d_year = 2001\nand d2.d_moy  = 8\nand ss_ticket_number = sr_ticket_number\nand ss_item_sk = sr_item_sk\nand ss_sold_date_sk   = d1.d_date_sk\nand sr_returned_date_sk   = d2.d_date_sk\nand ss_customer_sk = sr_customer_sk\nand ss_store_sk = s_store_sk\ngroup by\n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\norder by s_store_name\n        ,s_company_id\n        ,s_street_number\n        ,s_street_name\n        ,s_street_type\n        ,s_suite_number\n        ,s_city\n        ,s_county\n        ,s_state\n        ,s_zip\n LIMIT 100;\n\n-- end query 50 in stream 0 using template query50.tpl\n",
  "optimized_sql": "WITH filtered_d2 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 8), filtered_returns AS (SELECT sr.sr_returned_date_sk, ss.ss_store_sk, ss.ss_sold_date_sk FROM store_returns AS sr JOIN filtered_d2 ON sr.sr_returned_date_sk = filtered_d2.d_date_sk JOIN store_sales AS ss ON sr.sr_ticket_number = ss.ss_ticket_number AND sr.sr_item_sk = ss.ss_item_sk AND sr.sr_customer_sk = ss.ss_customer_sk)\nSELECT s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip, SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 30) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 60) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 90) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM filtered_returns AS fr JOIN store AS s ON fr.ss_store_sk = s.s_store_sk GROUP BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip ORDER BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip LIMIT 100",
  "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_d2\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 8\",\n        \"filtered_returns\": \"SELECT sr.sr_returned_date_sk, ss.ss_store_sk, ss.ss_sold_date_sk FROM store_returns sr JOIN filtered_d2 ON sr.sr_returned_date_sk = filtered_d2.d_date_sk JOIN store_sales ss ON sr.sr_ticket_number = ss.ss_ticket_number AND sr.sr_item_sk = ss.ss_item_sk AND sr.sr_customer_sk = ss.ss_customer_sk\",\n        \"main_query\": \"SELECT s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip, SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \\\"30 days\\\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 30) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \\\"31-60 days\\\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 60) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \\\"61-90 days\\\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 90) AND (fr.sr_returned_date_sk - fr.ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \\\"91-120 days\\\", SUM(CASE WHEN (fr.sr_returned_date_sk - fr.ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \\\">120 days\\\" FROM filtered_returns fr JOIN store s ON fr.ss_store_sk = s.s_store_sk GROUP BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip ORDER BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same grouping and aggregation results\",\n        \"same ordering\",\n        \"same limit\"\n      ],\n      \"expected_speedup\": \"2.8x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed d_year=2001 AND d_moy=8 filter on date_dim d2 into an early CTE (filtered_d2). This reduces the store_returns rows before joining with store_sales by filtering to approximately 1/120th of the data (single month vs 10 years). Eliminated redundant date_dim d1 join which served only as FK validation and projected no columns. Reordered joins to apply the highly selective date filter first, then join to store_sales and store.\"\n}\n```",
  "error": null,
  "latency_ms": 166165.0277670051,
  "tokens_in": 1920,
  "tokens_out": 7579
}