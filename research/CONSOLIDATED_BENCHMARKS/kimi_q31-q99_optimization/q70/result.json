{
  "query_num": 70,
  "status": "success",
  "original_sql": "-- start query 70 in stream 0 using template query70.tpl\nselect \n    sum(ss_net_profit) as total_sum\n   ,s_state\n   ,s_county\n   ,grouping(s_state)+grouping(s_county) as lochierarchy\n   ,rank() over (\n \tpartition by grouping(s_state)+grouping(s_county),\n \tcase when grouping(s_county) = 0 then s_state end \n \torder by sum(ss_net_profit) desc) as rank_within_parent\n from\n    store_sales\n   ,date_dim       d1\n   ,store\n where\n    d1.d_month_seq between 1213 and 1213+11\n and d1.d_date_sk = ss_sold_date_sk\n and s_store_sk  = ss_store_sk\n and s_state in\n             ( select s_state\n               from  (select s_state as s_state,\n \t\t\t    rank() over ( partition by s_state order by sum(ss_net_profit) desc) as ranking\n                      from   store_sales, store, date_dim\n                      where  d_month_seq between 1213 and 1213+11\n \t\t\t    and d_date_sk = ss_sold_date_sk\n \t\t\t    and s_store_sk  = ss_store_sk\n                      group by s_state\n                     ) tmp1 \n               where ranking <= 5\n             )\n group by rollup(s_state,s_county)\n order by\n   lochierarchy desc\n  ,case when lochierarchy = 0 then s_state end\n  ,rank_within_parent\n LIMIT 100;\n\n-- end query 70 in stream 0 using template query70.tpl\n",
  "optimized_sql": "SELECT SUM(ss_net_profit) AS total_sum, s_state, s_county, GROUPING(s_state) + GROUPING(s_county) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(s_state) + GROUPING(s_county), CASE WHEN GROUPING(s_county) = 0 THEN s_state END ORDER BY SUM(ss_net_profit) DESC) AS rank_within_parent FROM store_sales, date_dim AS d1, store WHERE d1.d_month_seq BETWEEN 1213 AND 1213 + 11 AND d1.d_date_sk = ss_sold_date_sk AND s_store_sk = ss_store_sk AND EXISTS(SELECT 1 FROM (SELECT s2.s_state AS s_state, RANK() OVER (PARTITION BY s2.s_state ORDER BY SUM(ss2.ss_net_profit) DESC) AS ranking FROM store_sales AS ss2, store AS s2, date_dim AS d2 WHERE d2.d_month_seq BETWEEN 1213 AND 1213 + 11 AND d2.d_date_sk = ss2.ss_sold_date_sk AND s2.s_store_sk = ss2.ss_store_sk GROUP BY s2.s_state) AS tmp1 WHERE tmp1.s_state = store.s_state AND tmp1.ranking <= 5) GROUP BY ROLLUP (s_state, s_county) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN s_state END, rank_within_parent LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"in_to_exists\",\n      \"nodes\": {\n        \"main_query\": \"SELECT SUM(ss_net_profit) AS total_sum, s_state, s_county, GROUPING(s_state) + GROUPING(s_county) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(s_state) + GROUPING(s_county), CASE WHEN GROUPING(s_county) = 0 THEN s_state END ORDER BY SUM(ss_net_profit) DESC) AS rank_within_parent FROM store_sales, date_dim AS d1, store WHERE d1.d_month_seq BETWEEN 1213 AND 1213 + 11 AND d1.d_date_sk = ss_sold_date_sk AND s_store_sk = ss_store_sk AND EXISTS (SELECT 1 FROM (SELECT s2.s_state AS s_state, RANK() OVER (PARTITION BY s2.s_state ORDER BY SUM(ss2.ss_net_profit) DESC) AS ranking FROM store_sales ss2, store s2, date_dim d2 WHERE d2.d_month_seq BETWEEN 1213 AND 1213 + 11 AND d2.d_date_sk = ss2.ss_sold_date_sk AND s2.s_store_sk = ss2.ss_store_sk GROUP BY s2.s_state) AS tmp1 WHERE tmp1.s_state = store.s_state AND tmp1.ranking <= 5) GROUP BY ROLLUP (s_state, s_county) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN s_state END, rank_within_parent LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same column output\",\n        \"same ordering\",\n        \"same aggregation semantics\"\n      ],\n      \"expected_speedup\": \"1.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Converted IN subquery to EXISTS with correlation on s_state. This allows early termination once a matching state is found in the top-5 ranking, rather than materializing the full subquery result set. Aliased subquery tables (ss2, s2, d2) to avoid ambiguity with outer query tables while preserving the identical filter logic (d_month_seq range and join conditions).\"\n}\n```",
  "error": null,
  "latency_ms": 80437.36059299408,
  "tokens_in": 1694,
  "tokens_out": 7103
}