WITH sales_branch_1 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Jewelry', 'Shoes', 'Electronics') AND i.i_class IN ('semi-precious', 'athletic', 'portable') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy), sales_branch_2 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Men', 'Music', 'Women') AND i.i_class IN ('accessories', 'rock', 'maternity') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy), tmp1 AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_category, i_brand, s_store_name, s_company_name) AS avg_monthly_sales FROM (SELECT * FROM sales_branch_1 UNION ALL SELECT * FROM sales_branch_2) AS unioned_sales)
SELECT * FROM tmp1 WHERE CASE WHEN (avg_monthly_sales <> 0) THEN (ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales) ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, s_store_name LIMIT 100