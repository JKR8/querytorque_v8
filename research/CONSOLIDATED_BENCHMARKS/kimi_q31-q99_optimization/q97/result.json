{
  "query_num": 97,
  "status": "success",
  "original_sql": "-- start query 97 in stream 0 using template query97.tpl\nwith ssci as (\nselect ss_customer_sk customer_sk\n      ,ss_item_sk item_sk\nfrom store_sales,date_dim\nwhere ss_sold_date_sk = d_date_sk\n  and d_month_seq between 1214 and 1214 + 11\ngroup by ss_customer_sk\n        ,ss_item_sk),\ncsci as(\n select cs_bill_customer_sk customer_sk\n      ,cs_item_sk item_sk\nfrom catalog_sales,date_dim\nwhere cs_sold_date_sk = d_date_sk\n  and d_month_seq between 1214 and 1214 + 11\ngroup by cs_bill_customer_sk\n        ,cs_item_sk)\n select sum(case when ssci.customer_sk is not null and csci.customer_sk is null then 1 else 0 end) store_only\n      ,sum(case when ssci.customer_sk is null and csci.customer_sk is not null then 1 else 0 end) catalog_only\n      ,sum(case when ssci.customer_sk is not null and csci.customer_sk is not null then 1 else 0 end) store_and_catalog\nfrom ssci full outer join csci on (ssci.customer_sk=csci.customer_sk\n                               and ssci.item_sk = csci.item_sk)\n LIMIT 100;\n\n-- end query 97 in stream 0 using template query97.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214 + 11), ssci AS (SELECT ss.ss_customer_sk AS customer_sk, ss.ss_item_sk AS item_sk FROM store_sales AS ss JOIN filtered_dates AS d ON ss.ss_sold_date_sk = d.d_date_sk GROUP BY ss.ss_customer_sk, ss.ss_item_sk), csci AS (SELECT cs.cs_bill_customer_sk AS customer_sk, cs.cs_item_sk AS item_sk FROM catalog_sales AS cs JOIN filtered_dates AS d ON cs.cs_sold_date_sk = d.d_date_sk GROUP BY cs.cs_bill_customer_sk, cs.cs_item_sk)\nSELECT SUM(CASE WHEN NOT ssci.customer_sk IS NULL AND csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS store_only, SUM(CASE WHEN ssci.customer_sk IS NULL AND NOT csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS catalog_only, SUM(CASE WHEN NOT ssci.customer_sk IS NULL AND NOT csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS store_and_catalog FROM ssci FULL OUTER JOIN csci ON (ssci.customer_sk = csci.customer_sk AND ssci.item_sk = csci.item_sk) LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214 + 11\",\n        \"ssci\": \"SELECT ss.ss_customer_sk AS customer_sk, ss.ss_item_sk AS item_sk FROM store_sales ss JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk GROUP BY ss.ss_customer_sk, ss.ss_item_sk\",\n        \"csci\": \"SELECT cs.cs_bill_customer_sk AS customer_sk, cs.cs_item_sk AS item_sk FROM catalog_sales cs JOIN filtered_dates d ON cs.cs_sold_date_sk = d.d_date_sk GROUP BY cs.cs_bill_customer_sk, cs.cs_item_sk\",\n        \"main_query\": \"SELECT SUM(CASE WHEN NOT ssci.customer_sk IS NULL AND csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS store_only, SUM(CASE WHEN ssci.customer_sk IS NULL AND NOT csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS catalog_only, SUM(CASE WHEN NOT ssci.customer_sk IS NULL AND NOT csci.customer_sk IS NULL THEN 1 ELSE 0 END) AS store_and_catalog FROM ssci FULL OUTER JOIN csci ON (ssci.customer_sk = csci.customer_sk AND ssci.item_sk = csci.item_sk) LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same grouping keys\",\n        \"same output columns\",\n        \"same join semantics\"\n      ],\n      \"expected_speedup\": \"2.00x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Extracted the date_dim filter (d_month_seq BETWEEN 1214 AND 1214 + 11) into a separate filtered_dates CTE that is reused by both ssci and csci. This ensures the date dimension is filtered once before joining with the large fact tables (store_sales and catalog_sales), reducing I/O and join overhead. The filtered_dates CTE acts as an early filter that enables better partition pruning and reduces the working set for the subsequent GROUP BY operations.\"\n}\n```",
  "error": null,
  "latency_ms": 72192.2508860007,
  "tokens_in": 2054,
  "tokens_out": 4743
}