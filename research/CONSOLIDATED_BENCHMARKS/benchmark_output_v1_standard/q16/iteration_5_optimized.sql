WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + INTERVAL '60' DAY)), filtered_addresses AS (SELECT ca_address_sk FROM customer_address WHERE ca_state = 'WV'), filtered_call_centers AS (SELECT cc_call_center_sk FROM call_center WHERE cc_county IN ('Ziebach County', 'Luce County', 'Richland County', 'Daviess County', 'Barrow County')), filtered_cs1 AS (SELECT cs1.cs_order_number, cs1.cs_ext_ship_cost, cs1.cs_net_profit FROM catalog_sales AS cs1 JOIN filtered_dates ON cs1.cs_ship_date_sk = filtered_dates.d_date_sk JOIN filtered_addresses ON cs1.cs_ship_addr_sk = filtered_addresses.ca_address_sk JOIN filtered_call_centers ON cs1.cs_call_center_sk = filtered_call_centers.cc_call_center_sk), multi_warehouse_orders AS (SELECT cs2.cs_order_number FROM catalog_sales AS cs2 JOIN filtered_cs1 AS fcs1 ON cs2.cs_order_number = fcs1.cs_order_number WHERE EXISTS(SELECT 1 FROM filtered_cs1 AS fcs2 WHERE fcs2.cs_order_number = fcs1.cs_order_number AND fcs2.rowid <> fcs1.rowid)), non_returned_orders AS (SELECT fcs1.cs_order_number FROM filtered_cs1 AS fcs1 WHERE NOT EXISTS(SELECT 1 FROM catalog_returns AS cr WHERE cr.cr_order_number = fcs1.cs_order_number))
SELECT COUNT(DISTINCT fcs1.cs_order_number) AS "order count", SUM(fcs1.cs_ext_ship_cost) AS "total shipping cost", SUM(fcs1.cs_net_profit) AS "total net profit" FROM filtered_cs1 AS fcs1 WHERE EXISTS(SELECT 1 FROM catalog_sales AS cs2 WHERE fcs1.cs_order_number = cs2.cs_order_number AND fcs1.cs_warehouse_sk <> cs2.cs_warehouse_sk) AND NOT EXISTS(SELECT 1 FROM catalog_returns AS cr WHERE fcs1.cs_order_number = cr.cr_order_number) ORDER BY COUNT(DISTINCT fcs1.cs_order_number) LIMIT 100