# DeepSeek Model Configuration
# Based on TPC-DS benchmark: 81/99 success, 18 failures
# Date: 2025-02-01

model:
  name: deepseek-chat
  provider: deepseek
  api_base: https://api.deepseek.com

# Tuning based on failure analysis
constraints:
  # DeepSeek tends to over-engineer - these constraints help
  - id: no_restructure
    text: "DO NOT restructure the query logic. Keep the same CTEs, subqueries, and JOIN structure."
    reason: "DeepSeek failures Q2, Q11, Q14 all restructured query logic and broke semantics"

  - id: no_extra_filters
    text: "DO NOT add filters that aren't already in the original query. Only MOVE existing filters earlier."
    reason: "Q81 failed because model added ctr.ctr_state='CA' filter that wasn't in original"

  - id: preserve_intersect
    text: "DO NOT convert INTERSECT/EXCEPT/UNION to JOINs. These have different NULL and duplicate handling."
    reason: "Q38 failed: INTERSECT converted to JOINs, result 486→80"

  - id: preserve_aggregation
    text: "DO NOT change GROUP BY columns or aggregation expressions."
    reason: "Q13, Q48 failures had wrong aggregation values"

# What DeepSeek does well
strengths:
  - "Pre-filtering dimensions into CTEs (Q15: 2.98x)"
  - "Early date filtering (Q39: 2.44x, Q45: 2.26x)"
  - "Converting correlated subqueries to JOINs with pre-computed CTEs (Q23: 2.33x)"
  - "Adding materialization hints"

# Failure patterns to avoid
failure_patterns:
  - pattern: "INTERSECT → JOIN conversion"
    queries: [q38, q14]
    symptom: "Same row count but different values"

  - pattern: "Added restrictive filter"
    queries: [q81, q30, q2]
    symptom: "Lost rows"

  - pattern: "Changed week/date sequence logic"
    queries: [q2]
    symptom: "Complex temporal queries broken"

# Prompt additions for this model
prompt_suffix: |
  IMPORTANT CONSTRAINTS:
  1. DO NOT restructure the query - keep same CTEs, subqueries, JOINs
  2. DO NOT add new WHERE conditions - only move existing filters earlier
  3. DO NOT convert INTERSECT/UNION to JOINs
  4. If unsure, return the original query unchanged

  SAFE optimizations:
  - Move a filter from outer query INTO a CTE (predicate pushdown)
  - Pre-compute a subquery result in a CTE
  - Add index hints or materialization hints

# Benchmark results
benchmark:
  dataset: TPC-DS SF100 (1% sample)
  database: DuckDB
  date: 2025-02-01
  success_rate: 0.82
  queries_tested: 99
  top_speedups:
    - query: q15
      speedup: 2.98
    - query: q39
      speedup: 2.44
    - query: q23
      speedup: 2.33
    - query: q45
      speedup: 2.26
    - query: q95
      speedup: 2.25
