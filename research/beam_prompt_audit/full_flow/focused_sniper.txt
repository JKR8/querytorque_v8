# Strike Commander Report - Sortie 2

## Step 1: COMPARE EXPLAIN PLANS

### Key Observations:
- **Operators Changed**: The original plan shows heavy nested loop anti joins consuming ~75% of execution time
- **Row Count Drops**: Most significant reduction would come from eliminating the 1,128 outer loop iterations in the nested loop anti joins
- **New Bottleneck**: Even after filtering, the nested loop anti joins remain expensive due to repeated scanning of web_sales and catalog_sales
- **Regressions**: None yet, but current approach still has expensive correlation patterns

## Step 2: DESIGN COMPOUND TARGETS

### Build on Wins:
- Sortie 0's decorrelation (Family B) successfully eliminated expensive re-scans
- Early filtering showed promise in reducing input set sizes

### Fix Regressions:
- Current plan still suffers from correlated subqueries that cause repeated table scans
- Need to push more filtering earlier in the pipeline

### Compound Strategies:
1. Combine decorrelation with early materialized filtering
2. Push date and price filters into CTEs to avoid repeated computation

## Step 3: OUTPUT 2 NEW TARGETS

```json
[
  {
    "target_id": "t1",
    "family": "B+D",
    "transform": "materialized_correlation_elimination",
    "relevance_score": 0.92,
    "hypothesis": "Materialize the web_sales and catalog_sales exclusion filters into CTEs to eliminate repeated scans while maintaining correlation benefits",
    "target_ir": "WITH filtered_web AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales,date_dim WHERE ws_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 12 AND ws_list_price BETWEEN 80 AND 169), filtered_catalog AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales,date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 12 AND cs_list_price BETWEEN 80 AND 169) SELECT ... FROM customer c JOIN customer_address ca ... WHERE NOT EXISTS (SELECT 1 FROM filtered_web fw WHERE fw.ws_bill_customer_sk = c.c_customer_sk) AND NOT EXISTS (SELECT 1 FROM filtered_catalog fc WHERE fc.cs_ship_customer_sk = c.c_customer_sk)",
    "recommended_examples": ["correlated_subquery_materialization", "filter_precomputation"]
  },
  {
    "target_id": "t2",
    "family": "B+A",
    "transform": "early_filter_pushdown_with_correlation_removal",
    "relevance_score": 0.89,
    "hypothesis": "Push state and demographic filters earlier in execution by restructuring JOIN order and converting correlated subqueries to JOINs",
    "target_ir": "SELECT cd_gender, cd_marital_status, cd_education_status, count(*) cnt1, cd_purchase_estimate, count(*) cnt2, cd_credit_rating, count(*) cnt3 FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk LEFT JOIN (store_sales_filtered ssf) ON c.c_customer_sk = ssf.ss_customer_sk WHERE ca_state IN ('CO','NC','TX') AND cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'College') AND ssf.ss_customer_sk IS NOT NULL AND NOT EXISTS (SELECT 1 FROM web_sales_filtered wsf WHERE wsf.ws_customer_sk = c.c_customer_sk) AND NOT EXISTS (SELECT 1 FROM catalog_sales_filtered csf WHERE csf.cs_customer_sk = c.c_customer_sk) GROUP BY ...",
    "recommended_examples": ["filter_reordering", "join_restructuring"]
  }
]
```