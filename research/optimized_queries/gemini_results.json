{
  "1": {
    "error": "unknown_pattern",
    "ops": [
      {
        "op": "replace_cte",
        "name": "customer_total_return",
        "sql": "select sr_customer_sk as ctr_customer_sk\n,sr_store_sk as ctr_store_sk\n,sum(SR_FEE) as ctr_total_return\n,avg(sum(SR_FEE)) over (partition by sr_store_sk) as ctr_store_avg\nfrom store_returns\n,date_dim\nwhere sr_returned_date_sk = d_date_sk\nand d_year =2000\ngroup by sr_customer_sk\n,sr_store_sk"
      },
      {
        "op": "replace_clause",
        "target": "main_query.where",
        "sql": "ctr1.ctr_total_return > (ctr1.ctr_store_avg*1.2)\nand s_store_sk = ctr1.ctr_store_sk\nand s_state = 'SD'\nand ctr1.ctr_customer_sk = c_customer_sk"
      }
    ]
  },
  "2": {
    "error": "unknown_pattern",
    "ops": [
      {
        "op": "replace_cte",
        "name": "wswscs",
        "sql": "select d_week_seq,\n        d_year,\n        sum(case when (d_day_name='Sunday') then sales_price else null end) sun_sales,\n        sum(case when (d_day_name='Monday') then sales_price else null end) mon_sales,\n        sum(case when (d_day_name='Tuesday') then sales_price else  null end) tue_sales,\n        sum(case when (d_day_name='Wednesday') then sales_price else null end) wed_sales,\n        sum(case when (d_day_name='Thursday') then sales_price else null end) thu_sales,\n        sum(case when (d_day_name='Friday') then sales_price else null end) fri_sales,\n        sum(case when (d_day_name='Saturday') then sales_price else null end) sat_sales\n from wscs\n     ,date_dim\n where d_date_sk = sold_date_sk\n   and d_year in (1998, 1998+1)\n group by d_week_seq, d_year"
      },
      {
        "op": "replace_clause",
        "target": "main_query.from",
        "sql": " (select d_week_seq d_week_seq1\n        ,sun_sales sun_sales1\n        ,mon_sales mon_sales1\n        ,tue_sales tue_sales1\n        ,wed_sales wed_sales1\n        ,thu_sales thu_sales1\n        ,fri_sales fri_sales1\n        ,sat_sales sat_sales1\n  from wswscs\n  where d_year = 1998) y,\n (select d_week_seq d_week_seq2\n        ,sun_sales sun_sales2\n        ,mon_sales mon_sales2\n        ,tue_sales tue_sales2\n        ,wed_sales wed_sales2\n        ,thu_sales thu_sales2\n        ,fri_sales fri_sales2\n        ,sat_sales sat_sales2\n  from wswscs\n  where d_year = 1998+1) z"
      }
    ]
  },
  "3": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "4": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "5": {
    "error": "unknown_pattern",
    "ops": [
      {
        "op": "replace_cte",
        "name": "ssr",
        "sql": "select s_store_id, sum(sales) as sales, sum(profit) as profit, sum(return_amt) as \"returns\", sum(net_loss) as profit_loss from ( select ss_store_sk as store_sk, sum(ss_ext_sales_price) as sales, sum(ss_net_profit) as profit, 0 as return_amt, 0 as net_loss from store_sales join date_dim on ss_sold_date_sk = d_date_sk where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by ss_store_sk union all select sr_store_sk as store_sk, 0 as sales, 0 as profit, sum(sr_return_amt) as return_amt, sum(sr_net_loss) as net_loss from store_returns join date_dim on sr_returned_date_sk = d_date_sk where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by sr_store_sk ) salesreturns join store on store_sk = s_store_sk group by s_store_id"
      },
      {
        "op": "replace_cte",
        "name": "csr",
        "sql": "select cp_catalog_page_id, sum(sales) as sales, sum(profit) as profit, sum(return_amt) as \"returns\", sum(net_loss) as profit_loss from ( select cs_catalog_page_sk as page_sk, sum(cs_ext_sales_price) as sales, sum(cs_net_profit) as profit, 0 as return_amt, 0 as net_loss from catalog_sales join date_dim on cs_sold_date_sk = d_date_sk where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by cs_catalog_page_sk union all select cr_catalog_page_sk as page_sk, 0 as sales, 0 as profit, sum(cr_return_amount) as return_amt, sum(cr_net_loss) as net_loss from catalog_returns join date_dim on cr_returned_date_sk = d_date_sk where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by cr_catalog_page_sk ) salesreturns join catalog_page on page_sk = cp_catalog_page_sk group by cp_catalog_page_id"
      },
      {
        "op": "replace_cte",
        "name": "wsr",
        "sql": "select web_site_id, sum(sales) as sales, sum(profit) as profit, sum(return_amt) as \"returns\", sum(net_loss) as profit_loss from ( select ws_web_site_sk as wsr_web_site_sk, sum(ws_ext_sales_price) as sales, sum(ws_net_profit) as profit, 0 as return_amt, 0 as net_loss from web_sales join date_dim on ws_sold_date_sk = d_date_sk where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by ws_web_site_sk union all select ws_web_site_sk as wsr_web_site_sk, 0 as sales, 0 as profit, sum(wr_return_amt) as return_amt, sum(wr_net_loss) as net_loss from web_returns join date_dim on wr_returned_date_sk = d_date_sk left outer join web_sales on (wr_item_sk = ws_item_sk and wr_order_number = ws_order_number) where d_date between cast('2000-08-19' as date) and (cast('2000-08-19' as date) + INTERVAL 14 DAY) group by ws_web_site_sk ) salesreturns join web_site on wsr_web_site_sk = web_site_sk group by web_site_id"
      }
    ]
  },
  "6": {
    "error": "Invalid control character at: line 21 column 55 (char 595)"
  },
  "7": {
    "speedup": 0.9911960280003099,
    "correct": true,
    "orig_time": 0.6404188871383667,
    "opt_time": 0.6461071968078613,
    "explanation": "Applied predicate pushdown by creating filtered CTEs for dimensions (date, demographics, promotion) and using explicit joins. This encourages the optimizer to reduce the fact table scan early using the smaller dimension keys."
  },
  "8": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "9": {
    "error": "opt: Parser Error: syntax error at end of input",
    "sql": "WITH ss_aggregates AS (\nSELECT count(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 ELSE NULL END) AS b1_cnt, avg(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_ext_sales_price ELSE NULL END) AS b1_avg"
  },
  "10": {
    "speedup": 0.7633664394791195,
    "correct": true,
    "orig_time": 0.2794649600982666,
    "opt_time": 0.3660954236984253,
    "explanation": "Converted correlated subqueries into semi-joins via CTEs. This eliminates repeated scans of 'date_dim' and sales tables by pre-computing valid customer keys, allowing the optimizer to use efficient hash joins."
  },
  "11": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "12": {
    "speedup": 1.06540710941665,
    "correct": true,
    "orig_time": 0.0960075855255127,
    "opt_time": 0.09011352062225342,
    "explanation": "Applied predicate pushdown by moving 'item' and 'date_dim' filters into CTEs to reduce scanned rows before joining. Switched to ANSI JOIN syntax to enforce the use of these pre-filtered datasets."
  },
  "13": {
    "error": "unknown_pattern",
    "ops": [
      {
        "op": "replace_clause",
        "target": "main_query.from",
        "sql": "store_sales\n     JOIN date_dim ON ss_sold_date_sk = d_date_sk\n     JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk\n     JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk\n     JOIN customer_address ON ss_addr_sk = ca_address_sk"
      },
      {
        "op": "replace_clause",
        "target": "main_query.where",
        "sql": "d_year = 2001\n and ss_store_sk IS NOT NULL\n and (\n   (cd_marital_status = 'D' and cd_education_status = 'Unknown' and ss_sales_price between 100.00 and 150.00 and hd_dep_count = 3)\n   or\n   (cd_marital_status = 'S' and cd_education_status = 'College' and ss_sales_price between 50.00 and 100.00 and hd_dep_count = 1)\n   or\n   (cd_marital_status = 'M' and cd_education_status = '4 yr Degree' and ss_sales_price between 150.00 and 200.00 and hd_dep_count = 1)\n )\n and ca_country = 'United States'\n and (\n   (ca_state in ('SD', 'KS', 'MI') and ss_net_profit between 100 and 200)\n   or\n   (ca_state in ('MO', 'ND', 'CO') and ss_net_profit between 150 and 300)\n   or\n   (ca_state in ('NH', 'OH', 'TX') and ss_net_profit between 50 and 250)\n )"
      }
    ]
  },
  "14": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "15": {
    "speedup": 1.0252153273752953,
    "correct": true,
    "orig_time": 0.1478825807571411,
    "opt_time": 0.14424538612365723,
    "explanation": "Decomposed the disjunctive filter (price OR location) into a UNION ALL. This allows the database to use an efficient full scan or index for high-value items, and a highly selective index scan on 'customer_address' for the location-based criteria, avoiding a costly product join."
  },
  "16": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "17": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "18": {
    "error": "unknown_pattern",
    "ops": [
      {
        "op": "replace_clause",
        "target": "main_query.from",
        "sql": "catalog_sales, customer_demographics cd1, customer, customer_address, date_dim, item"
      },
      {
        "op": "replace_clause",
        "target": "main_query.where",
        "sql": "cs_sold_date_sk = d_date_sk and\n       cs_item_sk = i_item_sk and\n       cs_bill_cdemo_sk = cd1.cd_demo_sk and\n       cs_bill_customer_sk = c_customer_sk and\n       cd1.cd_gender = 'F' and \n       cd1.cd_education_status = 'Advanced Degree' and\n       c_current_cdemo_sk IS NOT NULL and\n       c_current_addr_sk = ca_address_sk and\n       c_birth_month in (10,7,8,4,1,2) and\n       d_year = 1998 and\n       ca_state in ('WA','GA','NC'\n                   ,'ME','WY','OK','IN')"
      }
    ]
  },
  "19": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "20": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "21": {
    "error": "Command '['gemini', '-p', 'Optimize this SQL query.\\n\\n## Execution Plan\\n\\n**Operators by cost:**\\n"
  },
  "22": {
    "error": "opt: Binder Error: Referenced column \"inv_quantity_on_hand\" not found in FROM clause!",
    "sql": "WITH inv_counts AS (\nSELECT inv_item_sk, SUM(inv_quantity_on_hand) AS inv_sum, COUNT(inv_quantity_on_hand) AS inv_count FROM inventory, date_dim WHERE inv_date_sk = d_date_sk AND d_month_seq BETWEEN 1"
  }
}