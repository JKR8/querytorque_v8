{
  "query": 1,
  "api": "kimi",
  "model": "kimi-k2.5",
  "prompt_version": "v3 (generalized patterns + execution plan)",
  "sample_speedup": 1.10,
  "full_db_speedup": 2.76,
  "correct": true,
  "operations": [
    {
      "op": "replace_cte",
      "name": "customer_total_return",
      "sql": "SELECT sr_customer_sk as ctr_customer_sk\n,sr_store_sk as ctr_store_sk\n,SUM(SR_FEE) as ctr_total_return\n,AVG(SUM(SR_FEE)) OVER (PARTITION BY sr_store_sk) as ctr_avg_return\nFROM store_returns\nJOIN date_dim ON sr_returned_date_sk = d_date_sk\nJOIN store ON sr_store_sk = s_store_sk\nWHERE d_year =2000\nAND s_state = 'SD'\nGROUP BY sr_customer_sk\n,sr_store_sk"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "customer_total_return ctr1, customer"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "ctr1.ctr_total_return > ctr1.ctr_avg_return * 1.2\nAND ctr1.ctr_customer_sk = c_customer_sk"
    }
  ],
  "semantic_warnings": [
    "Hoisted store dimension filter into CTE - reduces store_returns scan from 56,138 rows to only SD stores before aggregation",
    "Replaced correlated subquery with window function AVG(...) OVER (PARTITION BY ctr_store_sk) to eliminate CTE self-join",
    "Removed store table from main query - join now occurs inside filtered CTE"
  ],
  "explanation": "Applied two high-impact optimizations targeting the 63.5% customer scan and 9.9% hash join costs: (1) Dimension filter hoisting - moved the store.s_state='SD' predicate and join into the CTE to filter store_returns before aggregation, dramatically reducing rows processed and subsequent customer join input. (2) Correlated subquery elimination - replaced the self-correlated subquery computing per-store averages with a window function in the CTE, removing the expensive hash join and second CTE materialization."
}
