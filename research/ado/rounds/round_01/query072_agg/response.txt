```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "WITH filtered_dates AS (\n  SELECT d_date_sk, d_week_seq, d_date\n  FROM date_dim\n  WHERE d_year = 1998\n)\n",
        "main_query": "SELECT i_item_desc, w_warehouse_name, fd1.d_week_seq,\n       SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo,\n       SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo,\n       COUNT(*) AS total_cnt\nFROM catalog_sales\nJOIN inventory ON (cs_item_sk = inv_item_sk)\nJOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk)\nJOIN item ON (i_item_sk = cs_item_sk)\nJOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk)\nJOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk)\nJOIN filtered_dates AS fd1 ON (cs_sold_date_sk = fd1.d_date_sk)\nJOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk)\nJOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk)\nLEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk)\nLEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number)\nWHERE fd1.d_week_seq = d2.d_week_seq\n  AND inv_quantity_on_hand < cs_quantity\n  AND d3.d_date > fd1.d_date + INTERVAL '3' DAY\n  AND hd_buy_potential = '501-1000'\n  AND cd_marital_status = 'M'\n  AND cd_dep_count BETWEEN 9 AND 11\n  AND i_category IN ('Home', 'Men', 'Music')\n  AND cs_wholesale_cost BETWEEN 34 AND 54\nGROUP BY i_item_desc, w_warehouse_name, fd1.d_week_seq\nORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, fd1.d_week_seq\nLIMIT 100"
      },
      "invariants_kept": ["All output columns preserved", "Grouping grain preserved", "All filter predicates preserved exactly", "Join relationships preserved"],
      "expected_speedup": "2-3x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "early_filter",
      "nodes": {
        "main_query": "SELECT i_item_desc, w_warehouse_name, d1.d_week_seq,\n       SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo,\n       SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo,\n       COUNT(*) AS total_cnt\nFROM catalog_sales\nJOIN inventory ON (cs_item_sk = inv_item_sk)\nJOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk)\nJOIN (\n  SELECT i_item_sk, i_item_desc\n  FROM item\n  WHERE i_category IN ('Home', 'Men', 'Music')\n) AS filtered_items ON (i_item_sk = cs_item_sk)\nJOIN (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status = 'M'\n    AND cd_dep_count BETWEEN 9 AND 11\n) AS filtered_cd ON (cs_bill_cdemo_sk = cd_demo_sk)\nJOIN (\n  SELECT hd_demo_sk\n  FROM household_demographics\n  WHERE hd_buy_potential = '501-1000'\n) AS filtered_hd ON (cs_bill_hdemo_sk = hd_demo_sk)\nJOIN date_dim AS d1 ON (cs_sold_date_sk = d1.d_date_sk AND d1.d_year = 1998)\nJOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk)\nJOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk)\nLEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk)\nLEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number)\nWHERE d1.d_week_seq = d2.d_week_seq\n  AND inv_quantity_on_hand < cs_quantity\n  AND d3.d_date > d1.d_date + INTERVAL '3' DAY\n  AND cs_wholesale_cost BETWEEN 34 AND 54\nGROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq\nORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq\nLIMIT 100"
      },
      "invariants_kept": ["All output columns preserved", "Grouping grain preserved", "All filter predicates preserved exactly", "Join relationships preserved"],
      "expected_speedup": "3-5x",
      "risk": "low"
    }
  ],
  "explanation": "Applied two complementary optimizations: 1) Isolated date_dim filtering into a CTE (QT-OPT-003) to reduce join cardinality early. 2) Pushed down selective dimension filters (item, customer_demographics, household_demographics, date_dim) as inline views to reduce the base row count before complex joins. Both transforms preserve all original literal values and maintain semantic equivalence while reducing intermediate result sizes."
}
```