{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "main_query": "WITH date_filtered AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 1998\n),\nbranch1 AS (\n  SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc\n  FROM web_sales\n  JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number\n  JOIN web_page ON ws_web_page_sk = wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n  JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk\n  JOIN date_filtered ON ws_sold_date_sk = date_filtered.d_date_sk\n  JOIN reason ON r_reason_sk = wr_reason_sk\n  WHERE cd1.cd_marital_status = 'D'\n    AND cd1.cd_education_status = 'Secondary'\n    AND ws_sales_price BETWEEN 100.00 AND 150.00\n    AND ((ca_country = 'United States' AND ca_state IN ('IA', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200)\n         OR (ca_country = 'United States' AND ca_state IN ('GA', 'MO', 'SD') AND ws_net_profit BETWEEN 150 AND 300)\n         OR (ca_country = 'United States' AND ca_state IN ('LA', 'TX', 'VA') AND ws_net_profit BETWEEN 50 AND 250))\n),\nbranch2 AS (\n  SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc\n  FROM web_sales\n  JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number\n  JOIN web_page ON ws_web_page_sk = wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n  JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk\n  JOIN date_filtered ON ws_sold_date_sk = date_filtered.d_date_sk\n  JOIN reason ON r_reason_sk = wr_reason_sk\n  WHERE cd1.cd_marital_status = 'M'\n    AND cd1.cd_education_status = '4 yr Degree'\n    AND ws_sales_price BETWEEN 50.00 AND 100.00\n    AND ((ca_country = 'United States' AND ca_state IN ('IA', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200)\n         OR (ca_country = 'United States' AND ca_state IN ('GA', 'MO', 'SD') AND ws_net_profit BETWEEN 150 AND 300)\n         OR (ca_country = 'United States' AND ca_state IN ('LA', 'TX', 'VA') AND ws_net_profit BETWEEN 50 AND 250))\n),\nbranch3 AS (\n  SELECT ws_quantity, wr_refunded_cash, wr_fee, r_reason_desc\n  FROM web_sales\n  JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number\n  JOIN web_page ON ws_web_page_sk = wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n  JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk\n  JOIN date_filtered ON ws_sold_date_sk = date_filtered.d_date_sk\n  JOIN reason ON r_reason_sk = wr_reason_sk\n  WHERE cd1.cd_marital_status = 'U'\n    AND cd1.cd_education_status = 'Unknown'\n    AND ws_sales_price BETWEEN 150.00 AND 200.00\n    AND ((ca_country = 'United States' AND ca_state IN ('IA', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200)\n         OR (ca_country = 'United States' AND ca_state IN ('GA', 'MO', 'SD') AND ws_net_profit BETWEEN 150 AND 300)\n         OR (ca_country = 'United States' AND ca_state IN ('LA', 'TX', 'VA') AND ws_net_profit BETWEEN 50 AND 250))\n)\nSELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee)\nFROM (SELECT * FROM branch1 UNION ALL SELECT * FROM branch2 UNION ALL SELECT * FROM branch3) AS union_result\nGROUP BY r_reason_desc\nORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee)\nLIMIT 100"
      },
      "invariants_kept": [
        "Output columns unchanged",
        "Grouping grain (r_reason_desc) unchanged",
        "All join predicates preserved",
        "Literal values preserved exactly"
      ],
      "expected_speedup": "2x",
      "risk": "medium"
    }
  ],
  "explanation": "Split the first OR condition (3 disjoint branches on marital status, education status, and sales price) into UNION ALL branches, each with deterministic filters. This enables efficient index usage and reduces predicate evaluation overhead. Also isolated date_dim filter into a CTE for early reduction. The second OR condition (3 branches on state/profit) remains intact per branch to avoid over-splitting (9 combinations)."
}