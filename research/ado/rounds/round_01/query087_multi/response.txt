```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "main_query": "WITH filtered_date AS (\n    SELECT d_date_sk, d_date\n    FROM date_dim\n    WHERE d_month_seq BETWEEN 1194 AND 1194 + 11\n),\nfiltered_customer AS (\n    SELECT c_customer_sk, c_last_name, c_first_name\n    FROM customer\n    WHERE c_birth_year BETWEEN 1943 AND 1949\n),\nstore_sales_data AS (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM store_sales\n    JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n    JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n    WHERE ss_list_price BETWEEN 217 AND 246\n      AND ss_wholesale_cost BETWEEN 34 AND 44\n),\ncatalog_sales_data AS (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM catalog_sales\n    JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n    JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n    WHERE cs_list_price BETWEEN 217 AND 246\n      AND cs_wholesale_cost BETWEEN 34 AND 44\n),\nweb_sales_data AS (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM web_sales\n    JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n    JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n    WHERE ws_list_price BETWEEN 217 AND 246\n      AND ws_wholesale_cost BETWEEN 34 AND 44\n)\nSELECT COUNT(*)\nFROM (\n    (SELECT * FROM store_sales_data)\n    EXCEPT\n    (SELECT * FROM catalog_sales_data)\n    EXCEPT\n    (SELECT * FROM web_sales_data)\n) AS cool_cust"
      },
      "invariants_kept": [
        "Same output columns (COUNT(*))",
        "Same set operations logic (EXCEPT)",
        "Same filtering predicates (exact literal values preserved)",
        "Same distinctness per subquery",
        "Same overall result rows"
      ],
      "expected_speedup": "1.5x-2x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "reorder_join",
      "nodes": {
        "main_query": "WITH filtered_date AS (\n    SELECT d_date_sk, d_date\n    FROM date_dim\n    WHERE d_month_seq BETWEEN 1194 AND 1194 + 11\n),\nfiltered_customer AS (\n    SELECT c_customer_sk, c_last_name, c_first_name\n    FROM customer\n    WHERE c_birth_year BETWEEN 1943 AND 1949\n)\nSELECT COUNT(*)\nFROM (\n    (SELECT DISTINCT c_last_name, c_first_name, d_date\n     FROM store_sales\n     JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n     JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n     WHERE ss_list_price BETWEEN 217 AND 246\n       AND ss_wholesale_cost BETWEEN 34 AND 44)\n    EXCEPT\n    (SELECT DISTINCT c_last_name, c_first_name, d_date\n     FROM catalog_sales\n     JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n     JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n     WHERE cs_list_price BETWEEN 217 AND 246\n       AND cs_wholesale_cost BETWEEN 34 AND 44)\n    EXCEPT\n    (SELECT DISTINCT c_last_name, c_first_name, d_date\n     FROM web_sales\n     JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n     JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n     WHERE ws_list_price BETWEEN 217 AND 246\n       AND ws_wholesale_cost BETWEEN 34 AND 44)\n) AS cool_cust"
      },
      "invariants_kept": [
        "Same output columns (COUNT(*))",
        "Same set operations logic (EXCEPT)",
        "Same filtering predicates (exact literal values preserved)",
        "Same join conditions",
        "Same overall result rows"
      ],
      "expected_speedup": "1.2x-1.5x",
      "risk": "low"
    }
  ],
  "explanation": "Applied two optimizations: 1) date_cte_isolate to create CTEs for filtered date_dim and customer, reducing repeated filtering costs across three EXCEPT branches. This isolates the date filter (d_month_seq) and customer filter (c_birth_year) into reusable CTEs. 2) reorder_join to ensure smaller filtered dimension tables are joined before applying fact table price filters. Both rewrites preserve all literal values exactly and maintain the same EXCEPT semantics. The CTE isolation should provide the biggest benefit by computing dimension filters once instead of three times."
}
```