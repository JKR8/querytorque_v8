```sql
WITH filtered_store AS (
  SELECT s_store_sk, s_store_name, s_state, s_zip
  FROM store
  WHERE s_market_id = 8
),
filtered_customer_addr AS (
  SELECT 
    c.c_customer_sk,
    c.c_last_name,
    c.c_first_name,
    c.c_birth_country,
    ca.ca_address_sk,
    ca.ca_state,
    ca.ca_country,
    ca.ca_zip
  FROM customer c
  JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
  WHERE c.c_birth_country <> UPPER(ca.ca_country)
),
filtered_item AS (
  SELECT 
    i_item_sk,
    i_color,
    i_current_price,
    i_manager_id,
    i_units,
    i_size
  FROM item
),
sales_returns_joined AS (
  SELECT
    ss.ss_ticket_number,
    ss.ss_item_sk,
    ss.ss_customer_sk,
    ss.ss_store_sk,
    ss.ss_net_profit,
    sr.sr_ticket_number,
    sr.sr_item_sk
  FROM store_sales ss
  JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number
    AND ss.ss_item_sk = sr.sr_item_sk
),
base_join AS (
  SELECT
    fca.c_last_name,
    fca.c_first_name,
    fs.s_store_name,
    fca.ca_state,
    fs.s_state,
    fi.i_color,
    fi.i_current_price,
    fi.i_manager_id,
    fi.i_units,
    fi.i_size,
    srj.ss_net_profit
  FROM sales_returns_joined srj
  JOIN filtered_store fs ON srj.ss_store_sk = fs.s_store_sk
  JOIN filtered_customer_addr fca ON srj.ss_customer_sk = fca.c_customer_sk
  JOIN filtered_item fi ON srj.ss_item_sk = fi.i_item_sk
  WHERE fs.s_zip = fca.ca_zip
),
grouped_aggregates AS (
  SELECT
    c_last_name,
    c_first_name,
    s_store_name,
    ca_state,
    s_state,
    i_color,
    i_current_price,
    i_manager_id,
    i_units,
    i_size,
    SUM(ss_net_profit) AS netpaid
  FROM base_join
  GROUP BY
    c_last_name,
    c_first_name,
    s_store_name,
    ca_state,
    s_state,
    i_color,
    i_current_price,
    i_manager_id,
    i_units,
    i_size
),
overall_avg AS (
  SELECT 0.05 * AVG(netpaid) AS threshold
  FROM grouped_aggregates
),
beige_groups AS (
  SELECT
    c_last_name,
    c_first_name,
    s_store_name,
    SUM(netpaid) AS paid
  FROM grouped_aggregates
  WHERE i_color = 'beige'
  GROUP BY
    c_last_name,
    c_first_name,
    s_store_name
)
SELECT
  c_last_name,
  c_first_name,
  s_store_name,
  paid
FROM beige_groups, overall_avg
WHERE paid > overall_avg.threshold
ORDER BY
  c_last_name,
  c_first_name,
  s_store_name
```

```
Changes: Restructured query using aggressive_restructure_with_prefetch strategy: created filtered dimension CTEs (store, customer+address, item), pre-joined fact tables (store_sales with store_returns), then performed single-pass aggregation. Consolidated the two ssales references into one grouped_aggregates CTE with overall average computed separately.
Expected speedup: 2.5-3.5x from reduced fact table scans and eliminated duplicate aggregation work.
```