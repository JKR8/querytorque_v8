```sql
WITH 
-- Pre-filter dimensions for efficient join
filtered_date AS (
    SELECT d_date_sk, d_year, d_moy
    FROM date_dim
    WHERE d_year = 1998
),
filtered_time AS (
    SELECT t_time_sk
    FROM time_dim
    WHERE t_time BETWEEN 48821 AND 48821 + 28800
),
filtered_ship_mode AS (
    SELECT sm_ship_mode_sk
    FROM ship_mode
    WHERE sm_carrier IN ('GREAT EASTERN', 'LATVIAN')
),
-- Unified fact aggregation at warehouse+date+time+ship_mode grain
fact_agg AS (
    SELECT 
        ws_warehouse_sk AS warehouse_sk,
        ws_sold_date_sk AS date_sk,
        ws_sold_time_sk AS time_sk,
        ws_ship_mode_sk AS ship_mode_sk,
        d_moy,
        SUM(ws_ext_sales_price * ws_quantity) AS sales_amount,
        SUM(ws_net_paid_inc_ship_tax * ws_quantity) AS net_amount
    FROM web_sales
    INNER JOIN filtered_date ON ws_sold_date_sk = d_date_sk
    INNER JOIN filtered_time ON ws_sold_time_sk = t_time_sk
    INNER JOIN filtered_ship_mode ON ws_ship_mode_sk = sm_ship_mode_sk
    GROUP BY 1,2,3,4,5
    
    UNION ALL
    
    SELECT 
        cs_warehouse_sk AS warehouse_sk,
        cs_sold_date_sk AS date_sk,
        cs_sold_time_sk AS time_sk,
        cs_ship_mode_sk AS ship_mode_sk,
        d_moy,
        SUM(cs_ext_list_price * cs_quantity) AS sales_amount,
        SUM(cs_net_paid_inc_ship_tax * cs_quantity) AS net_amount
    FROM catalog_sales
    INNER JOIN filtered_date ON cs_sold_date_sk = d_date_sk
    INNER JOIN filtered_time ON cs_sold_time_sk = t_time_sk
    INNER JOIN filtered_ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk
    GROUP BY 1,2,3,4,5
),
-- Join once with warehouse and pivot using array aggregation
monthly_metrics AS (
    SELECT
        w.w_warehouse_name,
        w.w_warehouse_sq_ft,
        w.w_city,
        w.w_county,
        w.w_state,
        w.w_country,
        d_year AS year,
        LIST(
            {
                'month': d_moy::TINYINT,
                'sales': sales_amount,
                'net': net_amount
            }
        ) AS monthly_data
    FROM fact_agg f
    INNER JOIN warehouse w ON f.warehouse_sk = w.w_warehouse_sk
    INNER JOIN filtered_date fd ON f.date_sk = fd.d_date_sk
    GROUP BY 
        w.w_warehouse_name,
        w.w_warehouse_sq_ft,
        w.w_city,
        w.w_county,
        w.w_state,
        w.w_country,
        d_year
)
-- Final aggregation using UNNEST with FILTER
SELECT
    w_warehouse_name,
    w_warehouse_sq_ft,
    w_city,
    w_county,
    w_state,
    w_country,
    'GREAT EASTERN' || ',' || 'LATVIAN' AS ship_carriers,
    year,
    -- Monthly sales
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 1)), 0) AS jan_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 2)), 0) AS feb_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 3)), 0) AS mar_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 4)), 0) AS apr_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 5)), 0) AS may_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 6)), 0) AS jun_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 7)), 0) AS jul_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 8)), 0) AS aug_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 9)), 0) AS sep_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 10)), 0) AS oct_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 11)), 0) AS nov_sales,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 12)), 0) AS dec_sales,
    -- Per square foot calculations
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 1)), 0) / w_warehouse_sq_ft AS jan_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 2)), 0) / w_warehouse_sq_ft AS feb_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 3)), 0) / w_warehouse_sq_ft AS mar_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 4)), 0) / w_warehouse_sq_ft AS apr_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 5)), 0) / w_warehouse_sq_ft AS may_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 6)), 0) / w_warehouse_sq_ft AS jun_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 7)), 0) / w_warehouse_sq_ft AS jul_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 8)), 0) / w_warehouse_sq_ft AS aug_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 9)), 0) / w_warehouse_sq_ft AS sep_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 10)), 0) / w_warehouse_sq_ft AS oct_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 11)), 0) / w_warehouse_sq_ft AS nov_sales_per_sq_foot,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).sales FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 12)), 0) / w_warehouse_sq_ft AS dec_sales_per_sq_foot,
    -- Monthly net
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 1)), 0) AS jan_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 2)), 0) AS feb_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 3)), 0) AS mar_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 4)), 0) AS apr_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 5)), 0) AS may_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 6)), 0) AS jun_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 7)), 0) AS jul_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 8)), 0) AS aug_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 9)), 0) AS sep_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 10)), 0) AS oct_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 11)), 0) AS nov_net,
    COALESCE(SUM(UNNEST(monthly_data, recursive := true).net FILTER (WHERE UNNEST(monthly_data, recursive := true).month = 12)), 0) AS dec_net
FROM monthly_metrics
GROUP BY 
    w_warehouse_name,
    w_warehouse_sq_ft,
    w_city,
    w_county,
    w_state,
    w_country,
    year,
    ship_carriers
ORDER BY
    w_warehouse_name
LIMIT 100;
```

**Changes**: Replaced the original UNION ALL of two large aggregations with a staged pipeline: first pre-filter dimensions into CTEs, then create a unified fact aggregation at the lowest grain, then join once with warehouse and store monthly metrics in DuckDB struct arrays, finally pivot using UNNEST with FILTER. This eliminates 24 CASE statements per channel, reduces intermediate data size, and enables better join ordering.

**Expected speedup**: 2-4x due to reduced intermediate data volume and elimination of redundant CASE statement evaluations.