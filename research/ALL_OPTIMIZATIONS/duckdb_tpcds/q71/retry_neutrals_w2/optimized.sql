WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 11 AND d_year = 1999), web_sales_filtered AS (SELECT ws_ext_sales_price AS ext_price, ws_item_sk AS sold_item_sk, ws_sold_time_sk AS time_sk FROM web_sales JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk), catalog_sales_filtered AS (SELECT cs_ext_sales_price AS ext_price, cs_item_sk AS sold_item_sk, cs_sold_time_sk AS time_sk FROM catalog_sales JOIN filtered_dates ON catalog_sales.cs_sold_date_sk = filtered_dates.d_date_sk), store_sales_filtered AS (SELECT ss_ext_sales_price AS ext_price, ss_item_sk AS sold_item_sk, ss_sold_time_sk AS time_sk FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk), filtered_item AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1), breakfast_times AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time = 'breakfast'), dinner_times AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time = 'dinner')
SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM (SELECT ext_price, sold_item_sk, time_sk FROM web_sales_filtered UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM catalog_sales_filtered UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM store_sales_filtered) AS sales UNION ALL JOIN filtered_item ON sales.sold_item_sk = filtered_item.i_item_sk JOIN breakfast_times ON sales.time_sk = breakfast_times.t_time_sk UNION ALL SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM (SELECT ext_price, sold_item_sk, time_sk FROM web_sales_filtered UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM catalog_sales_filtered UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM store_sales_filtered) AS sales JOIN filtered_item ON sales.sold_item_sk = filtered_item.i_item_sk JOIN dinner_times ON sales.time_sk = dinner_times.t_time_sk GROUP BY i_brand_id, i_brand, t_hour, t_minute ORDER BY ext_price DESC NULLS FIRST, i_brand_id NULLS FIRST, t_hour NULLS FIRST LIMIT 100