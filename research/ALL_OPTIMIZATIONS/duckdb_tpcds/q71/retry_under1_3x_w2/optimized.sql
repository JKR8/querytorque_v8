WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 11 AND d_year = 1999), filtered_items AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1), filtered_times AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time IN ('breakfast', 'dinner')), web_sales_with_dates AS (SELECT ws_ext_sales_price AS ext_price, ws_item_sk, ws_sold_time_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), catalog_sales_with_dates AS (SELECT cs_ext_sales_price AS ext_price, cs_item_sk, cs_sold_time_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk), store_sales_with_dates AS (SELECT ss_ext_sales_price AS ext_price, ss_item_sk, ss_sold_time_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), combined_sales AS (SELECT ext_price, ws_item_sk AS item_sk, ws_sold_time_sk AS time_sk FROM web_sales_with_dates UNION ALL SELECT ext_price, cs_item_sk, cs_sold_time_sk FROM catalog_sales_with_dates UNION ALL SELECT ext_price, ss_item_sk, ss_sold_time_sk FROM store_sales_with_dates)
SELECT i.i_brand_id AS brand_id, i.i_brand AS brand, t.t_hour, t.t_minute, SUM(cs.ext_price) AS ext_price FROM combined_sales AS cs JOIN filtered_items AS i ON cs.item_sk = i.i_item_sk JOIN filtered_times AS t ON cs.time_sk = t.t_time_sk GROUP BY i.i_brand, i.i_brand_id, t.t_hour, t.t_minute ORDER BY ext_price DESC NULLS FIRST, i.i_brand_id NULLS FIRST, t.t_hour NULLS FIRST