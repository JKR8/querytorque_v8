{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_61.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q61/output_optimized.sql",
  "validation": {
    "query_num": 61,
    "status": "success",
    "original_sql": "-- start query 61 in stream 0 using template query61.tpl\nselect promotions,total,cast(promotions as decimal(15,4))/cast(total as decimal(15,4))*100\nfrom\n  (select sum(ss_ext_sales_price) promotions\n   from  store_sales\n        ,store\n        ,promotion\n        ,date_dim\n        ,customer\n        ,customer_address \n        ,item\n   where ss_sold_date_sk = d_date_sk\n   and   ss_store_sk = s_store_sk\n   and   ss_promo_sk = p_promo_sk\n   and   ss_customer_sk= c_customer_sk\n   and   ca_address_sk = c_current_addr_sk\n   and   ss_item_sk = i_item_sk \n   and   ca_gmt_offset = -7\n   and   i_category = 'Jewelry'\n   and   (p_channel_dmail = 'Y' or p_channel_email = 'Y' or p_channel_tv = 'Y')\n   and   s_gmt_offset = -7\n   and   d_year = 1999\n   and   d_moy  = 11) promotional_sales,\n  (select sum(ss_ext_sales_price) total\n   from  store_sales\n        ,store\n        ,date_dim\n        ,customer\n        ,customer_address\n        ,item\n   where ss_sold_date_sk = d_date_sk\n   and   ss_store_sk = s_store_sk\n   and   ss_customer_sk= c_customer_sk\n   and   ca_address_sk = c_current_addr_sk\n   and   ss_item_sk = i_item_sk\n   and   ca_gmt_offset = -7\n   and   i_category = 'Jewelry'\n   and   s_gmt_offset = -7\n   and   d_year = 1999\n   and   d_moy  = 11) all_sales\norder by promotions, total\n LIMIT 100;\n\n-- end query 61 in stream 0 using template query61.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 11), base_sales AS (SELECT ss.ss_ext_sales_price, ss.ss_promo_sk FROM store_sales AS ss JOIN filtered_dates AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk AND s.s_gmt_offset = -7 JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk AND ca.ca_gmt_offset = -7 JOIN item AS i ON ss.ss_item_sk = i.i_item_sk AND i.i_category = 'Jewelry'), promotional_sales AS (SELECT SUM(ss_ext_sales_price) AS promotions FROM (SELECT bs.ss_ext_sales_price FROM base_sales AS bs JOIN promotion AS p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_dmail = 'Y' UNION ALL SELECT bs.ss_ext_sales_price FROM base_sales AS bs JOIN promotion AS p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_email = 'Y' UNION ALL SELECT bs.ss_ext_sales_price FROM base_sales AS bs JOIN promotion AS p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_tv = 'Y') AS t), all_sales AS (SELECT SUM(ss_ext_sales_price) AS total FROM base_sales)\nSELECT promotions, total, CAST(promotions AS DECIMAL(15, 4)) / CAST(total AS DECIMAL(15, 4)) * 100 FROM promotional_sales, all_sales ORDER BY promotions, total LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 11\",\n        \"base_sales\": \"SELECT ss.ss_ext_sales_price, ss.ss_promo_sk FROM store_sales ss JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk AND s.s_gmt_offset = -7 JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk AND ca.ca_gmt_offset = -7 JOIN item i ON ss.ss_item_sk = i.i_item_sk AND i.i_category = 'Jewelry'\",\n        \"promotional_sales\": \"SELECT SUM(ss_ext_sales_price) AS promotions FROM (SELECT bs.ss_ext_sales_price FROM base_sales bs JOIN promotion p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_dmail = 'Y' UNION ALL SELECT bs.ss_ext_sales_price FROM base_sales bs JOIN promotion p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_email = 'Y' UNION ALL SELECT bs.ss_ext_sales_price FROM base_sales bs JOIN promotion p ON bs.ss_promo_sk = p.p_promo_sk WHERE p.p_channel_tv = 'Y') t\",\n        \"all_sales\": \"SELECT SUM(ss_ext_sales_price) AS total FROM base_sales\",\n        \"main_query\": \"SELECT promotions, total, CAST(promotions AS DECIMAL(15, 4)) / CAST(total AS DECIMAL(15, 4)) * 100 FROM promotional_sales, all_sales ORDER BY promotions, total LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same aggregation result\",\n        \"same cross join semantics between promotional_sales and all_sales\",\n        \"predicates pushed down to base_sales CTE\"\n      ],\n      \"expected_speedup\": \"2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Split the OR condition (p_channel_dmail = 'Y' OR p_channel_email = 'Y' OR p_channel_tv = 'Y') into three UNION ALL branches to enable index usage on individual channel columns. Pushed down common filters (date, store, address, item) into a shared base_sales CTE to avoid redundant computation between the two subqueries. Each branch now scans only promotions matching its specific channel, eliminating the need for full promotion table scans and OR evaluation.\"\n}\n```",
    "error": null,
    "latency_ms": 94703.84349800588,
    "tokens_in": 1711,
    "tokens_out": 6338
  }
}