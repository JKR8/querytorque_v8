{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_22.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q22/output_optimized.sql",
  "validation": {
    "query_num": 22,
    "status": "success",
    "original_sql": "-- start query 22 in stream 0 using template query22.tpl\nselect i_product_name\n             ,i_brand\n             ,i_class\n             ,i_category\n             ,avg(inv_quantity_on_hand) qoh\n       from inventory\n           ,date_dim\n           ,item\n       where inv_date_sk=d_date_sk\n              and inv_item_sk=i_item_sk\n              and d_month_seq between 1188 and 1188 + 11\n       group by rollup(i_product_name\n                       ,i_brand\n                       ,i_class\n                       ,i_category)\norder by qoh, i_product_name, i_brand, i_class, i_category\n LIMIT 100;\n\n-- end query 22 in stream 0 using template query22.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1188 AND 1188 + 11)\nSELECT i_product_name, i_brand, i_class, i_category, AVG(inv_quantity_on_hand) AS qoh FROM inventory JOIN filtered_dates ON inv_date_sk = d_date_sk JOIN item ON inv_item_sk = i_item_sk GROUP BY ROLLUP (i_product_name, i_brand, i_class, i_category) ORDER BY qoh, i_product_name, i_brand, i_class, i_category LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1188 AND 1188 + 11\",\n        \"main_query\": \"SELECT i_product_name, i_brand, i_class, i_category, AVG(inv_quantity_on_hand) AS qoh FROM inventory JOIN filtered_dates ON inv_date_sk = d_date_sk JOIN item ON inv_item_sk = i_item_sk GROUP BY ROLLUP (i_product_name, i_brand, i_class, i_category) ORDER BY qoh, i_product_name, i_brand, i_class, i_category LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation result\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"2.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to push the predicate d_month_seq BETWEEN 1188 AND 1188 + 11 down to the date_dim dimension table before joining with the large inventory fact table. This reduces the join input size by filtering to only 12 months of date keys first, minimizing I/O and hash join costs on inventory.\"\n}\n```",
    "error": null,
    "latency_ms": 354570.03883899597,
    "tokens_in": 1488,
    "tokens_out": 4946
  }
}