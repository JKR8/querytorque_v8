{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_35.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q35/output_optimized.sql",
  "validation": {
    "query_num": 35,
    "status": "success",
    "original_sql": "-- start query 35 in stream 0 using template query35.tpl\nselect  \n  ca_state,\n  cd_gender,\n  cd_marital_status,\n  cd_dep_count,\n  count(*) cnt1,\n  max(cd_dep_count),\n  sum(cd_dep_count),\n  max(cd_dep_count),\n  cd_dep_employed_count,\n  count(*) cnt2,\n  max(cd_dep_employed_count),\n  sum(cd_dep_employed_count),\n  max(cd_dep_employed_count),\n  cd_dep_college_count,\n  count(*) cnt3,\n  max(cd_dep_college_count),\n  sum(cd_dep_college_count),\n  max(cd_dep_college_count)\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  cd_demo_sk = c.c_current_cdemo_sk and \n  exists (select *\n          from store_sales,date_dim\n          where c.c_customer_sk = ss_customer_sk and\n                ss_sold_date_sk = d_date_sk and\n                d_year = 2001 and\n                d_qoy < 4) and\n   (exists (select *\n            from web_sales,date_dim\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_sold_date_sk = d_date_sk and\n                  d_year = 2001 and\n                  d_qoy < 4) or \n    exists (select * \n            from catalog_sales,date_dim\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_sold_date_sk = d_date_sk and\n                  d_year = 2001 and\n                  d_qoy < 4))\n group by ca_state,\n          cd_gender,\n          cd_marital_status,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n order by ca_state,\n          cd_gender,\n          cd_marital_status,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n LIMIT 100;\n\n-- end query 35 in stream 0 using template query35.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4), store_customers AS (SELECT DISTINCT ss_customer_sk AS customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), web_customers AS (SELECT DISTINCT ws_bill_customer_sk AS customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), catalog_customers AS (SELECT DISTINCT cs_ship_customer_sk AS customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk), branch_web AS (SELECT ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers AS sc ON c.c_customer_sk = sc.customer_sk JOIN web_customers AS wc ON c.c_customer_sk = wc.customer_sk), branch_catalog AS (SELECT ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers AS sc ON c.c_customer_sk = sc.customer_sk JOIN catalog_customers AS cc ON c.c_customer_sk = cc.customer_sk), combined_customers AS (SELECT * FROM branch_web UNION ALL SELECT * FROM branch_catalog)\nSELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM combined_customers GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4\",\n        \"store_customers\": \"SELECT DISTINCT ss_customer_sk AS customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk\",\n        \"web_customers\": \"SELECT DISTINCT ws_bill_customer_sk AS customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk\",\n        \"catalog_customers\": \"SELECT DISTINCT cs_ship_customer_sk AS customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk\",\n        \"branch_web\": \"SELECT ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers sc ON c.c_customer_sk = sc.customer_sk JOIN web_customers wc ON c.c_customer_sk = wc.customer_sk\",\n        \"branch_catalog\": \"SELECT ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers sc ON c.c_customer_sk = sc.customer_sk JOIN catalog_customers cc ON c.c_customer_sk = cc.customer_sk\",\n        \"combined_customers\": \"SELECT * FROM branch_web UNION ALL SELECT * FROM branch_catalog\",\n        \"main_query\": \"SELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM combined_customers GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same grouping keys and aggregation results\",\n        \"same ordering and limit\",\n        \"preserved correlation semantics via semi-join conversion\"\n      ],\n      \"expected_speedup\": \"2.00x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied OR_TO_UNION to split the OR condition between web_sales and catalog_sales EXISTS clauses into separate UNION ALL branches. Decorrelated the subqueries by converting them to joins with pre-computed distinct customer lists (store_customers, web_customers, catalog_customers). Applied EARLY_FILTER to push d_year=2001 and d_qoy<4 predicates into the date_dim CTE. This allows the database to use hash joins instead of correlated subqueries and enables parallel execution of the two branches.\"\n}\n```",
    "error": null,
    "latency_ms": 479063.2453289945,
    "tokens_in": 1846,
    "tokens_out": 8029
  }
}