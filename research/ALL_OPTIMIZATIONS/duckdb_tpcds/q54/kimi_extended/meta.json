{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_54.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q54/output_optimized.sql",
  "validation": {
    "query_num": 54,
    "status": "success",
    "original_sql": "-- start query 54 in stream 0 using template query54.tpl\nwith my_customers as (\n select distinct c_customer_sk\n        , c_current_addr_sk\n from   \n        ( select cs_sold_date_sk sold_date_sk,\n                 cs_bill_customer_sk customer_sk,\n                 cs_item_sk item_sk\n          from   catalog_sales\n          union all\n          select ws_sold_date_sk sold_date_sk,\n                 ws_bill_customer_sk customer_sk,\n                 ws_item_sk item_sk\n          from   web_sales\n         ) cs_or_ws_sales,\n         item,\n         date_dim,\n         customer\n where   sold_date_sk = d_date_sk\n         and item_sk = i_item_sk\n         and i_category = 'Women'\n         and i_class = 'maternity'\n         and c_customer_sk = cs_or_ws_sales.customer_sk\n         and d_moy = 5\n         and d_year = 1998\n )\n , my_revenue as (\n select c_customer_sk,\n        sum(ss_ext_sales_price) as revenue\n from   my_customers,\n        store_sales,\n        customer_address,\n        store,\n        date_dim\n where  c_current_addr_sk = ca_address_sk\n        and ca_county = s_county\n        and ca_state = s_state\n        and ss_sold_date_sk = d_date_sk\n        and c_customer_sk = ss_customer_sk\n        and d_month_seq between (select distinct d_month_seq+1\n                                 from   date_dim where d_year = 1998 and d_moy = 5)\n                           and  (select distinct d_month_seq+3\n                                 from   date_dim where d_year = 1998 and d_moy = 5)\n group by c_customer_sk\n )\n , segments as\n (select cast((revenue/50) as int) as segment\n  from   my_revenue\n )\n  select segment, count(*) as num_customers, segment*50 as segment_base\n from segments\n group by segment\n order by segment, num_customers\n LIMIT 100;\n\n-- end query 54 in stream 0 using template query54.tpl\n",
    "optimized_sql": "-- start query 54 in stream 0 using template query54.tpl\nwith my_customers as (\n select distinct c_customer_sk\n        , c_current_addr_sk\n from   \n        ( select cs_sold_date_sk sold_date_sk,\n                 cs_bill_customer_sk customer_sk,\n                 cs_item_sk item_sk\n          from   catalog_sales\n          union all\n          select ws_sold_date_sk sold_date_sk,\n                 ws_bill_customer_sk customer_sk,\n                 ws_item_sk item_sk\n          from   web_sales\n         ) cs_or_ws_sales,\n         item,\n         date_dim,\n         customer\n where   sold_date_sk = d_date_sk\n         and item_sk = i_item_sk\n         and i_category = 'Women'\n         and i_class = 'maternity'\n         and c_customer_sk = cs_or_ws_sales.customer_sk\n         and d_moy = 5\n         and d_year = 1998\n )\n , my_revenue as (\n select c_customer_sk,\n        sum(ss_ext_sales_price) as revenue\n from   my_customers,\n        store_sales,\n        customer_address,\n        store,\n        date_dim\n where  c_current_addr_sk = ca_address_sk\n        and ca_county = s_county\n        and ca_state = s_state\n        and ss_sold_date_sk = d_date_sk\n        and c_customer_sk = ss_customer_sk\n        and d_month_seq between (select distinct d_month_seq+1\n                                 from   date_dim where d_year = 1998 and d_moy = 5)\n                           and  (select distinct d_month_seq+3\n                                 from   date_dim where d_year = 1998 and d_moy = 5)\n group by c_customer_sk\n )\n , segments as\n (select cast((revenue/50) as int) as segment\n  from   my_revenue\n )\n  select segment, count(*) as num_customers, segment*50 as segment_base\n from segments\n group by segment\n order by segment, num_customers\n LIMIT 100;\n\n-- end query 54 in stream 0 using template query54.tpl\n",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"my_customers\": \"SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_bill_customer_sk AS customer_sk FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE d_year = 1998 AND d_moy = 5 AND i_category = 'Women' AND i_class = 'maternity' UNION ALL SELECT ws_bill_customer_sk AS customer_sk FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN item ON ws_item_sk = i_item_sk WHERE d_year = 1998 AND d_moy = 5 AND i_category = 'Women' AND i_class = 'maternity') AS filtered_sales, customer WHERE c_customer_sk = filtered_sales.customer_sk\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"distinct grain preserved\",\n        \"all predicates applied\"\n      ],\n      \"expected_speedup\": \"2.5x\",\n      \"risk\": \"low\"\n    },\n    {\n      \"id\": \"rs_02\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"date_bounds\": \"SELECT DISTINCT d_month_seq + 1 AS start_seq, d_month_seq + 3 AS end_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 5\",\n        \"date_range\": \"SELECT d_date_sk FROM date_dim d JOIN date_bounds b ON d.d_month_seq BETWEEN b.start_seq AND b.end_seq\",\n        \"my_revenue\": \"SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_range WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk GROUP BY c_customer_sk\"\n      },\n     ",
    "error": null,
    "latency_ms": 187070.550370001,
    "tokens_in": 2395,
    "tokens_out": 8192
  }
}