WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_qoy IN (1, 2, 3)), ss_agg AS (SELECT ca_county, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q3 FROM store_sales JOIN date_filter ON ss_sold_date_sk = d_date_sk JOIN customer_address ON ss_addr_sk = ca_address_sk GROUP BY ca_county), ws_agg AS (SELECT ca_county, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q3 FROM web_sales JOIN date_filter ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk GROUP BY ca_county), ss AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM store_sales, date_dim, customer_address WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk GROUP BY ca_county, d_qoy, d_year), ws AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM web_sales, date_dim, customer_address WHERE ws_sold_date_sk = d_date_sk AND ws_bill_addr_sk = ca_address_sk GROUP BY ca_county, d_qoy, d_year)
SELECT s.ca_county, 2000 AS d_year, CASE WHEN s.store_sales_q1 > 0 THEN (s.store_sales_q2 * 1.0000) / s.store_sales_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN s.store_sales_q2 > 0 THEN (s.store_sales_q3 * 1.0000) / s.store_sales_q2 ELSE NULL END AS store_q2_q3_increase, CASE WHEN w.web_sales_q1 > 0 THEN (w.web_sales_q2 * 1.0000) / w.web_sales_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN w.web_sales_q2 > 0 THEN (w.web_sales_q3 * 1.0000) / w.web_sales_q2 ELSE NULL END AS web_q2_q3_increase FROM ss_agg AS s JOIN ws_agg AS w ON s.ca_county = w.ca_county WHERE (CASE WHEN w.web_sales_q1 > 0 THEN (w.web_sales_q2 * 1.0000) / w.web_sales_q1 ELSE NULL END) > (CASE WHEN s.store_sales_q1 > 0 THEN (s.store_sales_q2 * 1.0000) / s.store_sales_q1 ELSE NULL END) AND (CASE WHEN w.web_sales_q2 > 0 THEN (w.web_sales_q3 * 1.0000) / w.web_sales_q2 ELSE NULL END) > (CASE WHEN s.store_sales_q2 > 0 THEN (s.store_sales_q3 * 1.0000) / s.store_sales_q2 ELSE NULL END) ORDER BY s.ca_county