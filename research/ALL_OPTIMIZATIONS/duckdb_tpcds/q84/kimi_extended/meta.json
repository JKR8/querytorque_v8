{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_84.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q84/output_optimized.sql",
  "validation": {
    "query_num": 84,
    "status": "success",
    "original_sql": "-- start query 84 in stream 0 using template query84.tpl\nselect c_customer_id as customer_id\n       , coalesce(c_last_name,'') || ', ' || coalesce(c_first_name,'') as customername\n from customer\n     ,customer_address\n     ,customer_demographics\n     ,household_demographics\n     ,income_band\n     ,store_returns\n where ca_city\t        =  'Oakwood'\n   and c_current_addr_sk = ca_address_sk\n   and ib_lower_bound   >=  5806\n   and ib_upper_bound   <=  5806 + 50000\n   and ib_income_band_sk = hd_income_band_sk\n   and cd_demo_sk = c_current_cdemo_sk\n   and hd_demo_sk = c_current_hdemo_sk\n   and sr_cdemo_sk = cd_demo_sk\n order by c_customer_id\n LIMIT 100;\n\n-- end query 84 in stream 0 using template query84.tpl\n",
    "optimized_sql": "WITH filtered_income_band AS (SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 5806 AND ib_upper_bound <= 5806 + 50000), filtered_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Oakwood')\nSELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM customer AS c JOIN filtered_address AS a ON c.c_current_addr_sk = a.ca_address_sk JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN filtered_income_band AS ib ON hd.hd_income_band_sk = ib.ib_income_band_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_returns AS sr ON sr.sr_cdemo_sk = cd.cd_demo_sk ORDER BY c_customer_id LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_income_band\": \"SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 5806 AND ib_upper_bound <= 5806 + 50000\",\n        \"filtered_address\": \"SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Oakwood'\",\n        \"main_query\": \"SELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM customer c JOIN filtered_address a ON c.c_current_addr_sk = a.ca_address_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN filtered_income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk ORDER BY c_customer_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"row multiplicity preserved (no aggregation in original)\",\n        \"ordering and limit preserved\",\n        \"all join predicates maintained\"\n      ],\n      \"expected_speedup\": \"3.2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed selective filters (ca_city='Oakwood' and income_band range) into early CTEs to reduce join cardinality before hitting large tables like store_returns and customer. The income band filter is highly selective (specific numeric range) and the city filter reduces the address dimension significantly, minimizing the customer subset that needs to be joined with the fact table.\"\n}\n```",
    "error": null,
    "latency_ms": 123299.89925499831,
    "tokens_in": 1516,
    "tokens_out": 4766
  }
}