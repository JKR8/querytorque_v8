{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_89.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q89/output_optimized.sql",
  "validation": {
    "query_num": 89,
    "status": "success",
    "original_sql": "-- start query 89 in stream 0 using template query89.tpl\nselect *\nfrom(\nselect i_category, i_class, i_brand,\n       s_store_name, s_company_name,\n       d_moy,\n       sum(ss_sales_price) sum_sales,\n       avg(sum(ss_sales_price)) over\n         (partition by i_category, i_brand, s_store_name, s_company_name)\n         avg_monthly_sales\nfrom item, store_sales, date_dim, store\nwhere ss_item_sk = i_item_sk and\n      ss_sold_date_sk = d_date_sk and\n      ss_store_sk = s_store_sk and\n      d_year in (1999) and\n        ((i_category in ('Jewelry','Shoes','Electronics') and\n          i_class in ('semi-precious','athletic','portable')\n         )\n      or (i_category in ('Men','Music','Women') and\n          i_class in ('accessories','rock','maternity') \n        ))\ngroup by i_category, i_class, i_brand,\n         s_store_name, s_company_name, d_moy) tmp1\nwhere case when (avg_monthly_sales <> 0) then (abs(sum_sales - avg_monthly_sales) / avg_monthly_sales) else null end > 0.1\norder by sum_sales - avg_monthly_sales, s_store_name\n LIMIT 100;\n\n-- end query 89 in stream 0 using template query89.tpl\n",
    "optimized_sql": "WITH sales_branch_1 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Jewelry', 'Shoes', 'Electronics') AND i.i_class IN ('semi-precious', 'athletic', 'portable') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy), sales_branch_2 AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Men', 'Music', 'Women') AND i.i_class IN ('accessories', 'rock', 'maternity') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy), tmp1 AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_category, i_brand, s_store_name, s_company_name) AS avg_monthly_sales FROM (SELECT * FROM sales_branch_1 UNION ALL SELECT * FROM sales_branch_2) AS unioned_sales)\nSELECT * FROM tmp1 WHERE CASE WHEN (avg_monthly_sales <> 0) THEN (ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales) ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, s_store_name LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"sales_branch_1\": \"SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item i JOIN store_sales ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Jewelry', 'Shoes', 'Electronics') AND i.i_class IN ('semi-precious', 'athletic', 'portable') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy\",\n        \"sales_branch_2\": \"SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, SUM(ss.ss_sales_price) AS sum_sales FROM item i JOIN store_sales ss ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE d.d_year = 1999 AND i.i_category IN ('Men', 'Music', 'Women') AND i.i_class IN ('accessories', 'rock', 'maternity') GROUP BY i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy\",\n        \"tmp1\": \"SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_category, i_brand, s_store_name, s_company_name) AS avg_monthly_sales FROM (SELECT * FROM sales_branch_1 UNION ALL SELECT * FROM sales_branch_2) AS unioned_sales\",\n        \"main_query\": \"SELECT * FROM tmp1 WHERE CASE WHEN (avg_monthly_sales <> 0) THEN (ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales) ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, s_store_name LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same grain (GROUP BY columns preserved in each branch)\",\n        \"same rows (UNION ALL of mutually exclusive categories)\",\n        \"same ordering\",\n        \"outer filter predicate preserved\"\n      ],\n      \"expected_speedup\": \"2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Split the OR condition into two separate UNION ALL branches to enable better predicate pushdown and partition pruning on i_category. Each branch filters on disjoint category sets (Jewelry/Shoes/Electronics vs Men/Music/Women) allowing the optimizer to use more selective access paths. The window function is applied after the union since partitions remain distinct across branches.\"\n}\n```",
    "error": null,
    "latency_ms": 136026.5954419956,
    "tokens_in": 1678,
    "tokens_out": 6364
  }
}