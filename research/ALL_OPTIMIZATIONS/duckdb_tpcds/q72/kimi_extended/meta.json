{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_72.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q72/output_optimized.sql",
  "validation": {
    "query_num": 72,
    "status": "success",
    "original_sql": "-- start query 72 in stream 0 using template query72.tpl\nselect i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk)\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk)\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity \n  and d3.d_date > d1.d_date + 5\n  and hd_buy_potential = '501-1000'\n  and d1.d_year = 2002\n  and cd_marital_status = 'W'\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d1.d_week_seq\n LIMIT 100;\n\n-- end query 72 in stream 0 using template query72.tpl\n",
    "optimized_sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 2002), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'W'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '501-1000')\nSELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN filtered_d1 AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN inventory ON (cs_item_sk = inv_item_sk AND inv_quantity_on_hand < cs_quantity) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_cd ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN filtered_hd ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk AND d1.d_week_seq = d2.d_week_seq) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk AND d3.d_date > d1.d_date + 5) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_d1\": \"SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 2002\",\n        \"filtered_cd\": \"SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'W'\",\n        \"filtered_hd\": \"SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '501-1000'\",\n        \"main_query\": \"SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN filtered_d1 d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN inventory ON (cs_item_sk = inv_item_sk AND inv_quantity_on_hand < cs_quantity) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_cd ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN filtered_hd ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk AND d1.d_week_seq = d2.d_week_seq) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk AND d3.d_date > d1.d_date + 5) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"grain preserved (i_item_desc, w_warehouse_name, d_week_seq)\",\n        \"required predicates preserved\",\n        \"same result set\"\n      ],\n      \"expected_speedup\": \"3.50x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to push down selective predicates on dimension tables (date_dim d1, customer_demographics, household_demographics) before joining to the large catalog_sales fact table. Also pushed join conditions (inv_quantity_on_hand < cs_quantity, d_week_seq equality, and d3.d_date > d1.d_date + 5) into respective JOIN ON clauses to enable early filtering at the join operators. This reduces the intermediate result size significantly by filtering early on high-cardinality dimensions (year=2002, marital_status='W', buy_potential='501-1000') rather than after the joins.\"\n}\n```",
    "error": null,
    "latency_ms": 141268.536485004,
    "tokens_in": 1768,
    "tokens_out": 4664
  }
}