{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_36.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q36/output_optimized.sql",
  "validation": {
    "query_num": 36,
    "status": "success",
    "original_sql": "-- start query 36 in stream 0 using template query36.tpl\nselect \n    sum(ss_net_profit)/sum(ss_ext_sales_price) as gross_margin\n   ,i_category\n   ,i_class\n   ,grouping(i_category)+grouping(i_class) as lochierarchy\n   ,rank() over (\n \tpartition by grouping(i_category)+grouping(i_class),\n \tcase when grouping(i_class) = 0 then i_category end \n \torder by sum(ss_net_profit)/sum(ss_ext_sales_price) asc) as rank_within_parent\n from\n    store_sales\n   ,date_dim       d1\n   ,item\n   ,store\n where\n    d1.d_year = 2002 \n and d1.d_date_sk = ss_sold_date_sk\n and i_item_sk  = ss_item_sk \n and s_store_sk  = ss_store_sk\n and s_state in ('SD','TN','GA','SC',\n                 'MO','AL','MI','OH')\n group by rollup(i_category,i_class)\n order by\n   lochierarchy desc\n  ,case when lochierarchy = 0 then i_category end\n  ,rank_within_parent\n LIMIT 100;\n\n-- end query 36 in stream 0 using template query36.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH'))\nSELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING(i_category) + GROUPING(i_class) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(i_category) + GROUPING(i_class), CASE WHEN GROUPING(i_class) = 0 THEN i_category END ORDER BY SUM(ss_net_profit) / SUM(ss_ext_sales_price) ASC) AS rank_within_parent FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_stores ON ss_store_sk = s_store_sk JOIN item ON i_item_sk = ss_item_sk GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 2002\",\n        \"filtered_stores\": \"SELECT s_store_sk FROM store WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH')\",\n        \"main_query\": \"SELECT SUM(ss_net_profit) / SUM(ss_ext_sales_price) AS gross_margin, i_category, i_class, GROUPING(i_category) + GROUPING(i_class) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(i_category) + GROUPING(i_class), CASE WHEN GROUPING(i_class) = 0 THEN i_category END ORDER BY SUM(ss_net_profit) / SUM(ss_ext_sales_price) ASC) AS rank_within_parent FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_stores ON ss_store_sk = s_store_sk JOIN item ON i_item_sk = ss_item_sk GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation results\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"3.2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed down filters on dimension tables (date_dim.d_year=2002 and store.s_state IN ...) to reduce the fact table (store_sales) scan size before joining. This star schema optimization filters the small dimension tables first, then joins with the filtered fact table rows only, significantly reducing I/O and join computation.\"\n}\n```",
    "error": null,
    "latency_ms": 225234.38060499757,
    "tokens_in": 1606,
    "tokens_out": 3409
  }
}