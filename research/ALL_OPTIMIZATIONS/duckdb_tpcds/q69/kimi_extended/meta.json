{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_69.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q69/output_optimized.sql",
  "validation": {
    "query_num": 69,
    "status": "success",
    "original_sql": "-- start query 69 in stream 0 using template query69.tpl\nselect \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  ca_state in ('TX','VA','MI') and\n  cd_demo_sk = c.c_current_cdemo_sk and \n  exists (select *\n          from store_sales,date_dim\n          where c.c_customer_sk = ss_customer_sk and\n                ss_sold_date_sk = d_date_sk and\n                d_year = 2000 and\n                d_moy between 1 and 1+2) and\n   (not exists (select *\n            from web_sales,date_dim\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_sold_date_sk = d_date_sk and\n                  d_year = 2000 and\n                  d_moy between 1 and 1+2) and\n    not exists (select * \n            from catalog_sales,date_dim\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_sold_date_sk = d_date_sk and\n                  d_year = 2000 and\n                  d_moy between 1 and 1+2))\n group by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating\n order by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating\n LIMIT 100;\n\n-- end query 69 in stream 0 using template query69.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy BETWEEN 1 AND 1 + 2), store_buyers AS (SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), web_buyers AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), catalog_buyers AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk)\nSELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, COUNT(*) AS cnt1, cd.cd_purchase_estimate, COUNT(*) AS cnt2, cd.cd_credit_rating, COUNT(*) AS cnt3 FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN store_buyers AS sb ON c.c_customer_sk = sb.ss_customer_sk LEFT JOIN web_buyers AS wb ON c.c_customer_sk = wb.ws_bill_customer_sk LEFT JOIN catalog_buyers AS cb ON c.c_customer_sk = cb.cs_ship_customer_sk WHERE ca.ca_state IN ('TX', 'VA', 'MI') AND wb.ws_bill_customer_sk IS NULL AND cb.cs_ship_customer_sk IS NULL GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating ORDER BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy BETWEEN 1 AND 1 + 2\",\n        \"store_buyers\": \"SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk\",\n        \"web_buyers\": \"SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk\",\n        \"catalog_buyers\": \"SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk\",\n        \"main_query\": \"SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, COUNT(*) AS cnt1, cd.cd_purchase_estimate, COUNT(*) AS cnt2, cd.cd_credit_rating, COUNT(*) AS cnt3 FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN store_buyers sb ON c.c_customer_sk = sb.ss_customer_sk LEFT JOIN web_buyers wb ON c.c_customer_sk = wb.ws_bill_customer_sk LEFT JOIN catalog_buyers cb ON c.c_customer_sk = cb.cs_ship_customer_sk WHERE ca.ca_state IN ('TX', 'VA', 'MI') AND wb.ws_bill_customer_sk IS NULL AND cb.cs_ship_customer_sk IS NULL GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating ORDER BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\",\n        \"same aggregation semantics\"\n      ],\n      \"expected_speedup\": \"3.50x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Decorrelated the three EXISTS/NOT EXISTS subqueries by materializing distinct customer sets for each sales channel (store, web, catalog) filtered by the date range (d_year=2000, d_moy 1-3). Converted the correlated semi-joins and anti-joins into explicit joins: INNER JOIN with store_buyers ensures customers have store sales, LEFT JOIN with IS NULL checks on web_buyers and catalog_buyers ensures customers have no sales in those channels. Pushed the date filter into a shared CTE to avoid redundant scans of date_dim. This eliminates repeated subquery execution per customer row.\"\n}\n```",
    "error": null,
    "latency_ms": 159641.11124600458,
    "tokens_in": 1752,
    "tokens_out": 5907
  }
}