{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_19.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q19/output_optimized.sql",
  "validation": {
    "query_num": 19,
    "status": "success",
    "original_sql": "-- start query 19 in stream 0 using template query19.tpl\nselect i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact,\n \tsum(ss_ext_sales_price) ext_price\n from date_dim, store_sales, item,customer,customer_address,store\n where d_date_sk = ss_sold_date_sk\n   and ss_item_sk = i_item_sk\n   and i_manager_id=2\n   and d_moy=12\n   and d_year=1999\n   and ss_customer_sk = c_customer_sk \n   and c_current_addr_sk = ca_address_sk\n   and substr(ca_zip,1,5) <> substr(s_zip,1,5) \n   and ss_store_sk = s_store_sk \n group by i_brand\n      ,i_brand_id\n      ,i_manufact_id\n      ,i_manufact\n order by ext_price desc\n         ,i_brand\n         ,i_brand_id\n         ,i_manufact_id\n         ,i_manufact\n LIMIT 100;\n\n-- end query 19 in stream 0 using template query19.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12), filtered_items AS (SELECT i_item_sk, i_brand_id, i_brand, i_manufact_id, i_manufact FROM item WHERE i_manager_id = 2)\nSELECT i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact, SUM(ss.ss_ext_sales_price) AS ext_price FROM store_sales AS ss JOIN filtered_dates AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_items AS i ON ss.ss_item_sk = i.i_item_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE SUBSTRING(ca.ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5) GROUP BY i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact ORDER BY ext_price DESC, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12\",\n        \"filtered_items\": \"SELECT i_item_sk, i_brand_id, i_brand, i_manufact_id, i_manufact FROM item WHERE i_manager_id = 2\",\n        \"main_query\": \"SELECT i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact, SUM(ss.ss_ext_sales_price) AS ext_price FROM store_sales ss JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_items i ON ss.ss_item_sk = i.i_item_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE SUBSTRING(ca.ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5) GROUP BY i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact ORDER BY ext_price DESC, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"aggregation grain preserved\",\n        \"all join predicates maintained\",\n        \"filter conditions preserved\",\n        \"same result set and ordering\"\n      ],\n      \"expected_speedup\": \"3.8x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to pre-filter dimension tables date_dim (d_year=1999, d_moy=12) and item (i_manager_id=2) before joining with the large store_sales fact table. This reduces the join cardinality significantly by filtering the dimension tables first, then only joining matching rows to store_sales. The zip code inequality predicate is preserved in the WHERE clause.\"\n}\n```",
    "error": null,
    "latency_ms": 372799.10666999785,
    "tokens_in": 1601,
    "tokens_out": 5961
  }
}