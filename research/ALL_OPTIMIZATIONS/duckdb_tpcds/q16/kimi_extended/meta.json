{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_16.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q16/output_optimized.sql",
  "validation": {
    "query_num": 16,
    "status": "success",
    "original_sql": "-- start query 16 in stream 0 using template query16.tpl\nselect \n   count(distinct cs_order_number) as \"order count\"\n  ,sum(cs_ext_ship_cost) as \"total shipping cost\"\n  ,sum(cs_net_profit) as \"total net profit\"\nfrom\n   catalog_sales cs1\n  ,date_dim\n  ,customer_address\n  ,call_center\nwhere\n    d_date between '2002-4-01' and \n           (cast('2002-4-01' as date) + INTERVAL 60 DAY)\nand cs1.cs_ship_date_sk = d_date_sk\nand cs1.cs_ship_addr_sk = ca_address_sk\nand ca_state = 'WV'\nand cs1.cs_call_center_sk = cc_call_center_sk\nand cc_county in ('Ziebach County','Luce County','Richland County','Daviess County',\n                  'Barrow County'\n)\nand exists (select *\n            from catalog_sales cs2\n            where cs1.cs_order_number = cs2.cs_order_number\n              and cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)\nand not exists(select *\n               from catalog_returns cr1\n               where cs1.cs_order_number = cr1.cr_order_number)\norder by count(distinct cs_order_number)\n LIMIT 100;\n\n-- end query 16 in stream 0 using template query16.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + INTERVAL '60' DAY)), filtered_addresses AS (SELECT ca_address_sk FROM customer_address WHERE ca_state = 'WV'), filtered_call_centers AS (SELECT cc_call_center_sk FROM call_center WHERE cc_county IN ('Ziebach County', 'Luce County', 'Richland County', 'Daviess County', 'Barrow County')), multi_warehouse_orders AS (SELECT cs_order_number FROM catalog_sales GROUP BY cs_order_number HAVING COUNT(DISTINCT cs_warehouse_sk) > 1), returned_orders AS (SELECT DISTINCT cr_order_number FROM catalog_returns), filtered_sales AS (SELECT cs.cs_order_number, cs.cs_ext_ship_cost, cs.cs_net_profit FROM catalog_sales AS cs JOIN filtered_dates AS fd ON cs.cs_ship_date_sk = fd.d_date_sk JOIN filtered_addresses AS fa ON cs.cs_ship_addr_sk = fa.ca_address_sk JOIN filtered_call_centers AS fcc ON cs.cs_call_center_sk = fcc.cc_call_center_sk JOIN multi_warehouse_orders AS mwo ON cs.cs_order_number = mwo.cs_order_number LEFT JOIN returned_orders AS ro ON cs.cs_order_number = ro.cr_order_number WHERE ro.cr_order_number IS NULL)\nSELECT COUNT(DISTINCT cs_order_number) AS \"order count\", SUM(cs_ext_ship_cost) AS \"total shipping cost\", SUM(cs_net_profit) AS \"total net profit\" FROM filtered_sales ORDER BY COUNT(DISTINCT cs_order_number) LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + INTERVAL '60' DAY)\",\n        \"filtered_addresses\": \"SELECT ca_address_sk FROM customer_address WHERE ca_state = 'WV'\",\n        \"filtered_call_centers\": \"SELECT cc_call_center_sk FROM call_center WHERE cc_county IN ('Ziebach County', 'Luce County', 'Richland County', 'Daviess County', 'Barrow County')\",\n        \"multi_warehouse_orders\": \"SELECT cs_order_number FROM catalog_sales GROUP BY cs_order_number HAVING COUNT(DISTINCT cs_warehouse_sk) > 1\",\n        \"returned_orders\": \"SELECT DISTINCT cr_order_number FROM catalog_returns\",\n        \"filtered_sales\": \"SELECT cs.cs_order_number, cs.cs_ext_ship_cost, cs.cs_net_profit FROM catalog_sales cs JOIN filtered_dates fd ON cs.cs_ship_date_sk = fd.d_date_sk JOIN filtered_addresses fa ON cs.cs_ship_addr_sk = fa.ca_address_sk JOIN filtered_call_centers fcc ON cs.cs_call_center_sk = fcc.cc_call_center_sk JOIN multi_warehouse_orders mwo ON cs.cs_order_number = mwo.cs_order_number LEFT JOIN returned_orders ro ON cs.cs_order_number = ro.cr_order_number WHERE ro.cr_order_number IS NULL\",\n        \"main_query\": \"SELECT COUNT(DISTINCT cs_order_number) AS \\\"order count\\\", SUM(cs_ext_ship_cost) AS \\\"total shipping cost\\\", SUM(cs_net_profit) AS \\\"total net profit\\\" FROM filtered_sales ORDER BY COUNT(DISTINCT cs_order_number) LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same aggregation results\",\n        \"same date range filtering\",\n        \"same state and county filtering\",\n        \"same multi-warehouse order detection (EXISTS logic)\",\n        \"same no-return order filtering (NOT EXISTS logic)\"\n      ],\n      \"expected_speedup\": \"3.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Decorrelated both EXISTS and NOT EXISTS subqueries into joins. The EXISTS (same order, different warehouse) was converted to a join with a pre-computed set of order_numbers having COUNT(DISTINCT warehouse) > 1. The NOT EXISTS (no returns) was converted to an anti-join via LEFT JOIN with returned_orders WHERE IS NULL. Additionally, pushed down filters on date_dim, customer_address, and call_center into early CTEs to reduce the input size to the main catalog_sales scan. This eliminates correlated subquery execution and enables hash joins throughout.\"\n}\n```",
    "error": null,
    "latency_ms": 60871.348640997894,
    "tokens_in": 1644,
    "tokens_out": 4715
  }
}