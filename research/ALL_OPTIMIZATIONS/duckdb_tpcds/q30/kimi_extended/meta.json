{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_30.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q30/output_optimized.sql",
  "validation": {
    "query_num": 30,
    "status": "success",
    "original_sql": "-- start query 30 in stream 0 using template query30.tpl\nwith customer_total_return as\n (select wr_returning_customer_sk as ctr_customer_sk\n        ,ca_state as ctr_state, \n \tsum(wr_return_amt) as ctr_total_return\n from web_returns\n     ,date_dim\n     ,customer_address\n where wr_returned_date_sk = d_date_sk \n   and d_year =2002\n   and wr_returning_addr_sk = ca_address_sk \n group by wr_returning_customer_sk\n         ,ca_state)\n  select c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag\n       ,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address\n       ,c_last_review_date_sk,ctr_total_return\n from customer_total_return ctr1\n     ,customer_address\n     ,customer\n where ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2\n \t\t\t  from customer_total_return ctr2 \n                  \t  where ctr1.ctr_state = ctr2.ctr_state)\n       and ca_address_sk = c_current_addr_sk\n       and ca_state = 'IN'\n       and ctr1.ctr_customer_sk = c_customer_sk\n order by c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag\n                  ,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address\n                  ,c_last_review_date_sk,ctr_total_return\n LIMIT 100;\n\n-- end query 30 in stream 0 using template query30.tpl\n",
    "optimized_sql": "WITH filtered_returns AS (SELECT wr.wr_returning_customer_sk, ra.ca_state AS ctr_state, wr.wr_return_amt FROM web_returns AS wr JOIN date_dim AS d ON wr.wr_returned_date_sk = d.d_date_sk JOIN customer_address AS ra ON wr.wr_returning_addr_sk = ra.ca_address_sk JOIN customer AS c ON wr.wr_returning_customer_sk = c.c_customer_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND ca.ca_state = 'IN'), customer_total_return AS (SELECT ctr_customer_sk, ctr_state, SUM(wr_return_amt) AS ctr_total_return FROM filtered_returns GROUP BY ctr_customer_sk, ctr_state), state_avg_return AS (SELECT ctr_state, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_state)\nSELECT c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr1.ctr_total_return FROM customer_total_return AS ctr1 JOIN state_avg_return AS sar ON ctr1.ctr_state = sar.ctr_state JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr1.ctr_total_return LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"filtered_returns\": \"SELECT wr.wr_returning_customer_sk, ra.ca_state AS ctr_state, wr.wr_return_amt FROM web_returns wr JOIN date_dim d ON wr.wr_returned_date_sk = d.d_date_sk JOIN customer_address ra ON wr.wr_returning_addr_sk = ra.ca_address_sk JOIN customer c ON wr.wr_returning_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND ca.ca_state = 'IN'\",\n        \"customer_total_return\": \"SELECT ctr_customer_sk, ctr_state, SUM(wr_return_amt) AS ctr_total_return FROM filtered_returns GROUP BY ctr_customer_sk, ctr_state\",\n        \"state_avg_return\": \"SELECT ctr_state, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_state\",\n        \"main_query\": \"SELECT c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr1.ctr_total_return FROM customer_total_return ctr1 JOIN state_avg_return sar ON ctr1.ctr_state = sar.ctr_state JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr1.ctr_total_return LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"2.85x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed ca_state='IN' filter and customer/current_address joins into the first CTE (filtered_returns) to reduce data processed during aggregation. Decorrelated the subquery by computing state-level averages as a separate CTE (state_avg_return) with GROUP BY, then joined on ctr_state instead of using correlated subquery. Eliminated redundant customer_address join from main query since filter was pushed down.\"\n}\n```",
    "error": null,
    "latency_ms": 191298.01423999743,
    "tokens_in": 2083,
    "tokens_out": 6488
  }
}