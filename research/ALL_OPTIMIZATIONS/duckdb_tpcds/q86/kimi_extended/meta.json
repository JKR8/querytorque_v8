{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_86.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q86/output_optimized.sql",
  "validation": {
    "query_num": 86,
    "status": "success",
    "original_sql": "-- start query 86 in stream 0 using template query86.tpl\nselect  \n    sum(ws_net_paid) as total_sum\n   ,i_category\n   ,i_class\n   ,grouping(i_category)+grouping(i_class) as lochierarchy\n   ,rank() over (\n \tpartition by grouping(i_category)+grouping(i_class),\n \tcase when grouping(i_class) = 0 then i_category end \n \torder by sum(ws_net_paid) desc) as rank_within_parent\n from\n    web_sales\n   ,date_dim       d1\n   ,item\n where\n    d1.d_month_seq between 1224 and 1224+11\n and d1.d_date_sk = ws_sold_date_sk\n and i_item_sk  = ws_item_sk\n group by rollup(i_category,i_class)\n order by\n   lochierarchy desc,\n   case when lochierarchy = 0 then i_category end,\n   rank_within_parent\n LIMIT 100;\n\n-- end query 86 in stream 0 using template query86.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1224 AND 1224 + 11), filtered_sales AS (SELECT ws_net_paid, ws_item_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk)\nSELECT SUM(ws_net_paid) AS total_sum, i_category, i_class, GROUPING(i_category) + GROUPING(i_class) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(i_category) + GROUPING(i_class), CASE WHEN GROUPING(i_class) = 0 THEN i_category END ORDER BY SUM(ws_net_paid) DESC) AS rank_within_parent FROM filtered_sales JOIN item ON ws_item_sk = i_item_sk GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1224 AND 1224 + 11\",\n        \"filtered_sales\": \"SELECT ws_net_paid, ws_item_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk\",\n        \"main_query\": \"SELECT SUM(ws_net_paid) AS total_sum, i_category, i_class, GROUPING(i_category) + GROUPING(i_class) AS lochierarchy, RANK() OVER (PARTITION BY GROUPING(i_category) + GROUPING(i_class), CASE WHEN GROUPING(i_class) = 0 THEN i_category END ORDER BY SUM(ws_net_paid) DESC) AS rank_within_parent FROM filtered_sales JOIN item ON ws_item_sk = i_item_sk GROUP BY ROLLUP (i_category, i_class) ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation results\",\n        \"same window function behavior\",\n        \"same ordering\"\n      ],\n      \"expected_speedup\": \"2.0x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to pre-filter date_dim to only 12 months of data (d_month_seq BETWEEN 1224 AND 1235) before joining with web_sales. This reduces the intermediate join result size significantly since web_sales is typically large. Additionally, projected only necessary columns (d_date_sk from date_dim, ws_net_paid and ws_item_sk from web_sales) to minimize memory usage and I/O during query execution.\"\n}\n```",
    "error": null,
    "latency_ms": 595926.6979899985,
    "tokens_in": 1555,
    "tokens_out": 4143
  }
}