{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_27.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q27/output_optimized.sql",
  "validation": {
    "query_num": 27,
    "status": "success",
    "original_sql": "-- start query 27 in stream 0 using template query27.tpl\nselect i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\n from store_sales, customer_demographics, date_dim, store, item\n where ss_sold_date_sk = d_date_sk and\n       ss_item_sk = i_item_sk and\n       ss_store_sk = s_store_sk and\n       ss_cdemo_sk = cd_demo_sk and\n       cd_gender = 'F' and\n       cd_marital_status = 'D' and\n       cd_education_status = 'Secondary' and\n       d_year = 1999 and\n       s_state in ('MO','AL', 'MI', 'TN', 'LA', 'SC')\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n LIMIT 100;\n\n-- end query 27 in stream 0 using template query27.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999), filtered_demo AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'D' AND cd_education_status = 'Secondary'), filtered_store AS (SELECT s_store_sk, s_state FROM store WHERE s_state IN ('MO', 'AL', 'MI', 'TN', 'LA', 'SC'))\nSELECT i.i_item_id, fs.s_state, GROUPING(fs.s_state) AS g_state, AVG(ss.ss_quantity) AS agg1, AVG(ss.ss_list_price) AS agg2, AVG(ss.ss_coupon_amt) AS agg3, AVG(ss.ss_sales_price) AS agg4 FROM store_sales AS ss JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_demo AS fcd ON ss.ss_cdemo_sk = fcd.cd_demo_sk JOIN filtered_store AS fs ON ss.ss_store_sk = fs.s_store_sk JOIN item AS i ON ss.ss_item_sk = i.i_item_sk GROUP BY ROLLUP (i.i_item_id, fs.s_state) ORDER BY i.i_item_id, fs.s_state LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 1999\",\n        \"filtered_demo\": \"SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'D' AND cd_education_status = 'Secondary'\",\n        \"filtered_store\": \"SELECT s_store_sk, s_state FROM store WHERE s_state IN ('MO', 'AL', 'MI', 'TN', 'LA', 'SC')\",\n        \"main_query\": \"SELECT i.i_item_id, fs.s_state, GROUPING(fs.s_state) AS g_state, AVG(ss.ss_quantity) AS agg1, AVG(ss.ss_list_price) AS agg2, AVG(ss.ss_coupon_amt) AS agg3, AVG(ss.ss_sales_price) AS agg4 FROM store_sales ss JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_demo fcd ON ss.ss_cdemo_sk = fcd.cd_demo_sk JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk GROUP BY ROLLUP (i.i_item_id, fs.s_state) ORDER BY i.i_item_id, fs.s_state LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same aggregation results\",\n        \"same ordering\"\n      ],\n      \"expected_speedup\": \"3.50x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed down selective predicates on dimension tables (date_dim, customer_demographics, store) into separate filtered CTEs before joining with the fact table (store_sales). This reduces the join cardinality significantly by filtering dimension tables first, then joining only the matching rows with store_sales. The ROLLUP aggregation and final ordering remain unchanged.\"\n}\n```",
    "error": null,
    "latency_ms": 34228.81664799934,
    "tokens_in": 1602,
    "tokens_out": 3634
  }
}