{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_3.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q3/output_optimized.sql",
  "validation": {
    "query_num": 3,
    "status": "success",
    "original_sql": "-- start query 3 in stream 0 using template query3.tpl\nselect dt.d_year \n       ,item.i_brand_id brand_id \n       ,item.i_brand brand\n       ,sum(ss_sales_price) sum_agg\n from  date_dim dt \n      ,store_sales\n      ,item\n where dt.d_date_sk = store_sales.ss_sold_date_sk\n   and store_sales.ss_item_sk = item.i_item_sk\n   and item.i_manufact_id = 816\n   and dt.d_moy=11\n group by dt.d_year\n      ,item.i_brand\n      ,item.i_brand_id\n order by dt.d_year\n         ,sum_agg desc\n         ,brand_id\n LIMIT 100;\n\n-- end query 3 in stream 0 using template query3.tpl\n",
    "optimized_sql": "WITH filtered_items AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manufact_id = 816), filtered_dates AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_moy = 11)\nSELECT fd.d_year, fi.i_brand_id AS brand_id, fi.i_brand AS brand, SUM(ss.ss_sales_price) AS sum_agg FROM filtered_dates AS fd JOIN store_sales AS ss ON fd.d_date_sk = ss.ss_sold_date_sk JOIN filtered_items AS fi ON ss.ss_item_sk = fi.i_item_sk GROUP BY fd.d_year, fi.i_brand, fi.i_brand_id ORDER BY fd.d_year, sum_agg DESC, brand_id LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_items\": \"SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manufact_id = 816\",\n        \"filtered_dates\": \"SELECT d_date_sk, d_year FROM date_dim WHERE d_moy = 11\",\n        \"main_query\": \"SELECT fd.d_year, fi.i_brand_id AS brand_id, fi.i_brand AS brand, SUM(ss.ss_sales_price) AS sum_agg FROM filtered_dates fd JOIN store_sales ss ON fd.d_date_sk = ss.ss_sold_date_sk JOIN filtered_items fi ON ss.ss_item_sk = fi.i_item_sk GROUP BY fd.d_year, fi.i_brand, fi.i_brand_id ORDER BY fd.d_year, sum_agg DESC, brand_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation groups\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"2.50x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed down predicates i_manufact_id=816 and d_moy=11 to filter dimension tables (item, date_dim) before joining with the large fact table (store_sales). This reduces the join input size significantly by filtering items to only manufacturer 816 and dates to only November (month 11) before the expensive join and aggregation operations.\"\n}\n```",
    "error": null,
    "latency_ms": 122578.95121799811,
    "tokens_in": 1521,
    "tokens_out": 3983
  }
}