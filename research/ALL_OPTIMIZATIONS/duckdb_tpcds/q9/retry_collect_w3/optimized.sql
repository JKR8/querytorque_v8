WITH quantity_aggregations AS (SELECT CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END AS bucket, COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_disc, AVG(ss_net_paid) AS avg_net FROM store_sales WHERE ss_quantity BETWEEN 1 AND 100 GROUP BY CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END) SELECT CASE WHEN (SELECT cnt FROM quantity_aggregations WHERE bucket = 1) > 74129 THEN (SELECT avg_disc FROM quantity_aggregations WHERE bucket = 1) ELSE (SELECT avg_net FROM quantity_aggregations WHERE bucket = 1) END AS bucket1, CASE WHEN (SELECT cnt FROM quantity_aggregations WHERE bucket = 2) > 122840 THEN (SELECT avg_disc FROM quantity_aggregations WHERE bucket = 2) ELSE (SELECT avg_net FROM quantity_aggregations WHERE bucket = 2) END AS bucket2, CASE WHEN (SELECT cnt FROM quantity_aggregations WHERE bucket = 3) > 56580 THEN (SELECT avg_disc FROM quantity_aggregations WHERE bucket = 3) ELSE (SELECT avg_net FROM quantity_aggregations WHERE bucket = 3) END AS bucket3, CASE WHEN (SELECT cnt FROM quantity_aggregations WHERE bucket = 4) > 10097 THEN (SELECT avg_disc FROM quantity_aggregations WHERE bucket = 4) ELSE (SELECT avg_net FROM quantity_aggregations WHERE bucket = 4) END AS bucket4, CASE WHEN (SELECT cnt FROM quantity_aggregations WHERE bucket = 5) > 165306 THEN (SELECT avg_disc FROM quantity_aggregations WHERE bucket = 5) ELSE (SELECT avg_net FROM quantity_aggregations WHERE bucket = 5) END AS bucket5 FROM reason WHERE r_reason_sk = 1