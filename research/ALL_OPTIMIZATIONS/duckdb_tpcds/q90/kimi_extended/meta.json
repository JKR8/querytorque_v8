{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_90.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q90/output_optimized.sql",
  "validation": {
    "query_num": 90,
    "status": "success",
    "original_sql": "-- start query 90 in stream 0 using template query90.tpl\nselect cast(amc as decimal(15,4))/cast(pmc as decimal(15,4)) am_pm_ratio\n from ( select count(*) amc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 10 and 10+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) at_tbl,\n      ( select count(*) pmc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 16 and 16+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) pt\n order by am_pm_ratio\n LIMIT 100;\n\n-- end query 90 in stream 0 using template query90.tpl\n",
    "optimized_sql": "WITH filtered_web_data AS (SELECT CASE WHEN t.t_hour BETWEEN 10 AND 11 THEN 1 END AS am_flag, CASE WHEN t.t_hour BETWEEN 16 AND 17 THEN 1 END AS pm_flag FROM web_sales AS ws JOIN household_demographics AS hd ON ws.ws_ship_hdemo_sk = hd.hd_demo_sk JOIN time_dim AS t ON ws.ws_sold_time_sk = t.t_time_sk JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE hd.hd_dep_count = 2 AND wp.wp_char_count BETWEEN 5000 AND 5200 AND (t.t_hour BETWEEN 10 AND 11 OR t.t_hour BETWEEN 16 AND 17)), counts AS (SELECT COUNT(am_flag) AS amc, COUNT(pm_flag) AS pmc FROM filtered_web_data)\nSELECT CAST(amc AS DECIMAL(15, 4)) / CAST(pmc AS DECIMAL(15, 4)) AS am_pm_ratio FROM counts ORDER BY am_pm_ratio LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_web_data\": \"SELECT CASE WHEN t.t_hour BETWEEN 10 AND 11 THEN 1 END AS am_flag, CASE WHEN t.t_hour BETWEEN 16 AND 17 THEN 1 END AS pm_flag FROM web_sales ws JOIN household_demographics hd ON ws.ws_ship_hdemo_sk = hd.hd_demo_sk JOIN time_dim t ON ws.ws_sold_time_sk = t.t_time_sk JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE hd.hd_dep_count = 2 AND wp.wp_char_count BETWEEN 5000 AND 5200 AND (t.t_hour BETWEEN 10 AND 11 OR t.t_hour BETWEEN 16 AND 17)\",\n        \"counts\": \"SELECT COUNT(am_flag) AS amc, COUNT(pm_flag) AS pmc FROM filtered_web_data\",\n        \"main_query\": \"SELECT CAST(amc AS DECIMAL(15, 4)) / CAST(pmc AS DECIMAL(15, 4)) AS am_pm_ratio FROM counts ORDER BY am_pm_ratio LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same ratio calculation\",\n        \"same limit and ordering\",\n        \"preserved all join predicates\"\n      ],\n      \"expected_speedup\": \"1.85x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Eliminated redundant table scans by merging the two subqueries (AM and PM counts) into a single scan with conditional aggregation. The original query scanned web_sales and dimension tables twice (once for each time range). By filtering early with the OR condition covering both time windows and using CASE statements to flag AM vs PM rows, we compute both counts in one pass through the data. This reduces I/O and join processing approximately by half.\"\n}\n```",
    "error": null,
    "latency_ms": 70388.61634700152,
    "tokens_in": 1621,
    "tokens_out": 4117
  }
}