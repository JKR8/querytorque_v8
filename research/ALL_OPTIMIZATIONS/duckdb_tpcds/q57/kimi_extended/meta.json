{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_57.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q57/output_optimized.sql",
  "validation": {
    "query_num": 57,
    "status": "success",
    "original_sql": "-- start query 57 in stream 0 using template query57.tpl\nwith v1 as(\n select i_category, i_brand,\n        cc_name,\n        d_year, d_moy,\n        sum(cs_sales_price) sum_sales,\n        avg(sum(cs_sales_price)) over\n          (partition by i_category, i_brand,\n                     cc_name, d_year)\n          avg_monthly_sales,\n        rank() over\n          (partition by i_category, i_brand,\n                     cc_name\n           order by d_year, d_moy) rn\n from item, catalog_sales, date_dim, call_center\n where cs_item_sk = i_item_sk and\n       cs_sold_date_sk = d_date_sk and\n       cc_call_center_sk= cs_call_center_sk and\n       (\n         d_year = 1999 or\n         ( d_year = 1999-1 and d_moy =12) or\n         ( d_year = 1999+1 and d_moy =1)\n       )\n group by i_category, i_brand,\n          cc_name , d_year, d_moy),\n v2 as(\n select v1.i_brand\n        ,v1.d_year\n        ,v1.avg_monthly_sales\n        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum\n from v1, v1 v1_lag, v1 v1_lead\n where v1.i_category = v1_lag.i_category and\n       v1.i_category = v1_lead.i_category and\n       v1.i_brand = v1_lag.i_brand and\n       v1.i_brand = v1_lead.i_brand and\n       v1. cc_name = v1_lag. cc_name and\n       v1. cc_name = v1_lead. cc_name and\n       v1.rn = v1_lag.rn + 1 and\n       v1.rn = v1_lead.rn - 1)\n  select *\n from v2\n where  d_year = 1999 and\n        avg_monthly_sales > 0 and\n        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\n order by sum_sales - avg_monthly_sales, nsum\n LIMIT 100;\n\n-- end query 57 in stream 0 using template query57.tpl\n",
    "optimized_sql": "WITH filtered_sales AS (SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales AS cs JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 1999 UNION ALL SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales AS cs JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 1998 AND d.d_moy = 12 UNION ALL SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales AS cs JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 2000 AND d.d_moy = 1), v1 AS (SELECT i_category, i_brand, cc_name, d_year, d_moy, SUM(cs_sales_price) AS sum_sales, AVG(SUM(cs_sales_price)) OVER (PARTITION BY i_category, i_brand, cc_name, d_year) AS avg_monthly_sales, RANK() OVER (PARTITION BY i_category, i_brand, cc_name ORDER BY d_year, d_moy) AS rn FROM filtered_sales GROUP BY i_category, i_brand, cc_name, d_year, d_moy), v2 AS (SELECT v1.i_brand, v1.d_year, v1.avg_monthly_sales, v1.sum_sales, v1_lag.sum_sales AS psum, v1_lead.sum_sales AS nsum FROM v1, v1 AS v1_lag, v1 AS v1_lead WHERE v1.i_category = v1_lag.i_category AND v1.i_category = v1_lead.i_category AND v1.i_brand = v1_lag.i_brand AND v1.i_brand = v1_lead.i_brand AND v1.cc_name = v1_lag.cc_name AND v1.cc_name = v1_lead.cc_name AND v1.rn = v1_lag.rn + 1 AND v1.rn = v1_lead.rn - 1)\nSELECT * FROM v2 WHERE d_year = 1999 AND avg_monthly_sales > 0 AND CASE WHEN avg_monthly_sales > 0 THEN ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, nsum LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_sales\": \"SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 1999 UNION ALL SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 1998 AND d.d_moy = 12 UNION ALL SELECT i.i_category, i.i_brand, cc.cc_name, d.d_year, d.d_moy, cs.cs_sales_price FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE d.d_year = 2000 AND d.d_moy = 1\",\n        \"v1\": \"SELECT i_category, i_brand, cc_name, d_year, d_moy, SUM(cs_sales_price) AS sum_sales, AVG(SUM(cs_sales_price)) OVER (PARTITION BY i_category, i_brand, cc_name, d_year) AS avg_monthly_sales, RANK() OVER (PARTITION BY i_category, i_brand, cc_name ORDER BY d_year, d_moy) AS rn FROM filtered_sales GROUP BY i_category, i_brand, cc_name, d_year, d_moy\",\n        \"v2\": \"SELECT v1.i_brand, v1.d_year, v1.avg_monthly_sales, v1.sum_sales, v1_lag.sum_sales AS psum, v1_lead.sum_sales AS nsum FROM v1, v1 AS v1_lag, v1 AS v1_lead WHERE v1.i_category = v1_lag.i_category AND v1.i_category = v1_lead.i_category AND v1.i_brand = v1_lag.i_brand AND v1.i_brand = v1_lead.i_brand AND v1.cc_name = v1_lag.cc_name AND v1.cc_name = v1_lead.cc_name AND v1.rn = v1_lag.rn + 1 AND v1.rn = v1_lead.rn - 1\",\n        \"main_query\": \"SELECT * FROM v2 WHERE d_year = 1999 AND avg_monthly_sales > 0 AND CASE WHEN avg_monthly_sales > 0 THEN ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1 ORDER BY sum_sales - avg_monthly_sales, nsum LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\",\n        \"preserved window function semantics across union\"\n      ],\n      \"expected_speedup\": \"2.0x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied OR_TO_UNION to split the date range filter in v1 into three separate UNION ALL branches. This allows the database to use partition pruning or indexes on date_dim for each specific year/month combination, reducing I/O. The GROUP BY and window functions are applied after the union to maintain correct aggregation and ranking semantics. The self-join in v2 and final filtering in main_query remain unchanged as they depend on the full windowed result set including adjacent months needed for lag/lead calculations.\"\n}\n```",
    "error": null,
    "latency_ms": 521087.65164399665,
    "tokens_in": 2683,
    "tokens_out": 7284
  }
}