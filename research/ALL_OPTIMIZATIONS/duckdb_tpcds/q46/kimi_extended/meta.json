{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_46.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q46/output_optimized.sql",
  "validation": {
    "query_num": 46,
    "status": "success",
    "original_sql": "-- start query 46 in stream 0 using template query46.tpl\nselect c_last_name\n       ,c_first_name\n       ,ca_city\n       ,bought_city\n       ,ss_ticket_number\n       ,amt,profit \n from\n   (select ss_ticket_number\n          ,ss_customer_sk\n          ,ca_city bought_city\n          ,sum(ss_coupon_amt) amt\n          ,sum(ss_net_profit) profit\n    from store_sales,date_dim,store,household_demographics,customer_address \n    where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    and store_sales.ss_store_sk = store.s_store_sk  \n    and store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk\n    and store_sales.ss_addr_sk = customer_address.ca_address_sk\n    and (household_demographics.hd_dep_count = 6 or\n         household_demographics.hd_vehicle_count= 0)\n    and date_dim.d_dow in (6,0)\n    and date_dim.d_year in (1999,1999+1,1999+2) \n    and store.s_city in ('Five Points','Centerville','Oak Grove','Fairview','Liberty') \n    group by ss_ticket_number,ss_customer_sk,ss_addr_sk,ca_city) dn,customer,customer_address current_addr\n    where ss_customer_sk = c_customer_sk\n      and customer.c_current_addr_sk = current_addr.ca_address_sk\n      and current_addr.ca_city <> bought_city\n  order by c_last_name\n          ,c_first_name\n          ,ca_city\n          ,bought_city\n          ,ss_ticket_number\n LIMIT 100;\n\n-- end query 46 in stream 0 using template query46.tpl\n",
    "optimized_sql": "-- start query 46 in stream 0 using template query46.tpl\nselect c_last_name\n       ,c_first_name\n       ,ca_city\n       ,bought_city\n       ,ss_ticket_number\n       ,amt,profit \n from\n   (select ss_ticket_number\n          ,ss_customer_sk\n          ,ca_city bought_city\n          ,sum(ss_coupon_amt) amt\n          ,sum(ss_net_profit) profit\n    from store_sales,date_dim,store,household_demographics,customer_address \n    where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    and store_sales.ss_store_sk = store.s_store_sk  \n    and store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk\n    and store_sales.ss_addr_sk = customer_address.ca_address_sk\n    and (household_demographics.hd_dep_count = 6 or\n         household_demographics.hd_vehicle_count= 0)\n    and date_dim.d_dow in (6,0)\n    and date_dim.d_year in (1999,1999+1,1999+2) \n    and store.s_city in ('Five Points','Centerville','Oak Grove','Fairview','Liberty') \n    group by ss_ticket_number,ss_customer_sk,ss_addr_sk,ca_city) dn,customer,customer_address current_addr\n    where ss_customer_sk = c_customer_sk\n      and customer.c_current_addr_sk = current_addr.ca_address_sk\n      and current_addr.ca_city <> bought_city\n  order by c_last_name\n          ,c_first_name\n          ,ca_city\n          ,bought_city\n          ,ss_ticket_number\n LIMIT 100;\n\n-- end query 46 in stream 0 using template query46.tpl\n",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_dow IN (6, 0) AND d_year IN (1999, 2000, 2001)\",\n        \"filtered_stores\": \"SELECT s_store_sk FROM store WHERE s_city IN ('Five Points', 'Centerville', 'Oak Grove', 'Fairview', 'Liberty')\",\n        \"sales_dep\": \"SELECT ss.ss_ticket_number, ss.ss_customer_sk, ss.ss_addr_sk, ca.ca_city AS bought_city, ss.ss_coupon_amt, ss.ss_net_profit FROM store_sales ss JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_stores fs ON ss.ss_store_sk = fs.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk AND hd.hd_dep_count = 6 JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk\",\n        \"sales_vehicle\": \"SELECT ss.ss_ticket_number, ss.ss_customer_sk, ss.ss_addr_sk, ca.ca_city AS bought_city, ss.ss_coupon_amt, ss.ss_net_profit FROM store_sales ss JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_stores fs ON ss.ss_store_sk = fs.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk AND hd.hd_vehicle_count = 0 JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk\",\n        \"customer_total_return\": \"SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, bought_city, SUM(ss_coupon_amt) AS amt, SUM(ss_net_profit) AS profit FROM (SELECT * FROM sales_dep UNION ALL SELECT * FROM sales_vehicle) AS combined GROUP BY ss_ticket_number, ss_customer_sk, ss_addr_sk, bought_city\",\n        \"main_query\": \"SELECT c.c_last_name, c.c_first_name, current_addr.ca_city, dn.bought_city, dn.ss_ticket_number, dn.amt, dn.profit FROM customer_total_return dn JOIN customer c ON dn.ss_customer_sk = c.c_customer_sk JOIN customer_address current_addr ON c.c_current_addr_sk = current_addr.ca_address_sk WHERE current_addr.ca_city <> dn.bought_city ORDER BY c.c_last_name, c.c_first_name, current_addr.ca_city, dn.bought_city, dn.ss_ticket_number LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"2.0x\",\n      \"risk\": \"medium\"\n    }\n  ],\n  \"explanation\": \"Split the OR condition (hd_dep_count = 6 OR hd_vehicle_count = 0) into two UNION ALL branches to enable better index usage on household_demographics. Each branch filters store_sales by one condition before joining.",
    "error": null,
    "latency_ms": 1253115.7107539985,
    "tokens_in": 1730,
    "tokens_out": 8192
  }
}