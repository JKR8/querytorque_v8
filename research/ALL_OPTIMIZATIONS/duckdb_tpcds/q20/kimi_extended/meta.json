{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_20.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q1-q30_optimization/q20/output_optimized.sql",
  "validation": {
    "query_num": 20,
    "status": "success",
    "original_sql": "-- start query 20 in stream 0 using template query20.tpl\nselect i_item_id\n       ,i_item_desc \n       ,i_category \n       ,i_class \n       ,i_current_price\n       ,sum(cs_ext_sales_price) as itemrevenue \n       ,sum(cs_ext_sales_price)*100/sum(sum(cs_ext_sales_price)) over\n           (partition by i_class) as revenueratio\n from\tcatalog_sales\n     ,item \n     ,date_dim\n where cs_item_sk = i_item_sk \n   and i_category in ('Shoes', 'Books', 'Women')\n   and cs_sold_date_sk = d_date_sk\n and d_date between cast('2002-01-26' as date) \n \t\t\t\tand (cast('2002-01-26' as date) + INTERVAL 30 DAY)\n group by i_item_id\n         ,i_item_desc \n         ,i_category\n         ,i_class\n         ,i_current_price\n order by i_category\n         ,i_class\n         ,i_item_id\n         ,i_item_desc\n         ,revenueratio\n LIMIT 100;\n\n-- end query 20 in stream 0 using template query20.tpl\n",
    "optimized_sql": "WITH filtered_items AS (SELECT i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price FROM item WHERE i_category IN ('Shoes', 'Books', 'Women')), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('2002-01-26' AS DATE) AND (CAST('2002-01-26' AS DATE) + INTERVAL '30' DAY))\nSELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(cs_ext_sales_price) AS itemrevenue, SUM(cs_ext_sales_price) * 100 / SUM(SUM(cs_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio FROM catalog_sales JOIN filtered_items ON cs_item_sk = i_item_sk JOIN filtered_dates ON cs_sold_date_sk = d_date_sk GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price ORDER BY i_category, i_class, i_item_id, i_item_desc, revenueratio LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_items\": \"SELECT i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price FROM item WHERE i_category IN ('Shoes', 'Books', 'Women')\",\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('2002-01-26' AS DATE) AND (CAST('2002-01-26' AS DATE) + INTERVAL '30' DAY)\",\n        \"main_query\": \"SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(cs_ext_sales_price) AS itemrevenue, SUM(cs_ext_sales_price) * 100 / SUM(SUM(cs_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio FROM catalog_sales JOIN filtered_items ON cs_item_sk = i_item_sk JOIN filtered_dates ON cs_sold_date_sk = d_date_sk GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price ORDER BY i_category, i_class, i_item_id, i_item_desc, revenueratio LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation results\",\n        \"same window function computation\",\n        \"same ordering\",\n        \"same output columns\"\n      ],\n      \"expected_speedup\": \"3.2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to push selective predicates (i_category IN (...) and d_date BETWEEN ...) down to dimension tables (item and date_dim) before joining with the large fact table (catalog_sales). This reduces the join input sizes significantly. Also implicitly applies projection_prune by selecting only necessary columns from dimension tables.\"\n}\n```",
    "error": null,
    "latency_ms": 64617.2217409985,
    "tokens_in": 1606,
    "tokens_out": 3366
  }
}