WITH base_joins AS (SELECT c.c_last_name, c.c_first_name, s.s_store_name, ca.ca_state, s.s_state, i.i_color, i.i_current_price, i.i_manager_id, i.i_units, i.i_size, ss.ss_net_paid FROM store_sales AS ss JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE s.s_market_id = 8 AND s.s_zip = ca.ca_zip AND c.c_birth_country <> UPPER(ca.ca_country)), ssales_with_color_filter AS (SELECT c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size, SUM(ss_net_paid) AS netpaid FROM base_joins WHERE i_color = 'peach' GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size), ssales_all_colors AS (SELECT c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size, SUM(ss_net_paid) AS netpaid FROM base_joins GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size), ssales AS (SELECT c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size, SUM(ss_net_paid) AS netpaid FROM store_sales, store_returns, store, item, customer, customer_address WHERE ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = c_customer_sk AND ss_item_sk = i_item_sk AND ss_store_sk = s_store_sk AND c_current_addr_sk = ca_address_sk AND c_birth_country <> UPPER(ca_country) AND s_zip = ca_zip AND s_market_id = 8 GROUP BY c_last_name, c_first_name, s_store_name, ca_state, s_state, i_color, i_current_price, i_manager_id, i_units, i_size)
SELECT c_last_name, c_first_name, s_store_name, SUM(netpaid) AS paid FROM ssales_with_color_filter GROUP BY c_last_name, c_first_name, s_store_name HAVING SUM(netpaid) > (SELECT 0.05 * AVG(netpaid) FROM ssales_all_colors) ORDER BY c_last_name, c_first_name, s_store_name