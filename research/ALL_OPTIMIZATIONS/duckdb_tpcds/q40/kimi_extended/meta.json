{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_40.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q40/output_optimized.sql",
  "validation": {
    "query_num": 40,
    "status": "success",
    "original_sql": "-- start query 40 in stream 0 using template query40.tpl\nselect \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2001-04-02' as date)) \n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2001-04-02' as date)) \n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number \n        and cs_item_sk = cr_item_sk)\n  ,warehouse \n  ,item\n  ,date_dim\n where\n     i_current_price between 0.99 and 1.49\n and i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk \n and cs_sold_date_sk    = d_date_sk\n and d_date between (cast ('2001-04-02' as date) - INTERVAL 30 DAY)\n                and (cast ('2001-04-02' as date) + INTERVAL 30 DAY) \n group by\n    w_state,i_item_id\n order by w_state,i_item_id\n LIMIT 100;\n\n-- end query 40 in stream 0 using template query40.tpl\n",
    "optimized_sql": "WITH filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_current_price BETWEEN 0.99 AND 1.49), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2001-04-02' AS DATE) - INTERVAL '30' DAY) AND (CAST('2001-04-02' AS DATE) + INTERVAL '30' DAY))\nSELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2001-04-02' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2001-04-02' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk) JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk JOIN filtered_item ON i_item_sk = cs_item_sk JOIN filtered_dates ON cs_sold_date_sk = d_date_sk GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_item\": \"SELECT i_item_sk, i_item_id FROM item WHERE i_current_price BETWEEN 0.99 AND 1.49\",\n        \"filtered_dates\": \"SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2001-04-02' AS DATE) - INTERVAL '30' DAY) AND (CAST('2001-04-02' AS DATE) + INTERVAL '30' DAY)\",\n        \"main_query\": \"SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2001-04-02' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2001-04-02' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk) JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk JOIN filtered_item ON i_item_sk = cs_item_sk JOIN filtered_dates ON cs_sold_date_sk = d_date_sk GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same aggregation results\",\n        \"same row filtering logic\",\n        \"same join semantics\",\n        \"same NULL handling from LEFT JOIN\"\n      ],\n      \"expected_speedup\": \"4.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to dimension tables item and date_dim to reduce data before joins. Filtered item by i_current_price (0.99-1.49) and date_dim by 60-day window. This eliminates scanning rows from catalog_sales that would be filtered out by these dimension predicates anyway, significantly reducing join input size.\"\n}\n```",
    "error": null,
    "latency_ms": 69748.22924299951,
    "tokens_in": 1650,
    "tokens_out": 3245
  }
}