{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_34.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q34/output_optimized.sql",
  "validation": {
    "query_num": 34,
    "status": "success",
    "original_sql": "-- start query 34 in stream 0 using template query34.tpl\nselect c_last_name\n       ,c_first_name\n       ,c_salutation\n       ,c_preferred_cust_flag\n       ,ss_ticket_number\n       ,cnt from\n   (select ss_ticket_number\n          ,ss_customer_sk\n          ,count(*) cnt\n    from store_sales,date_dim,store,household_demographics\n    where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    and store_sales.ss_store_sk = store.s_store_sk  \n    and store_sales.ss_hdemo_sk = household_demographics.hd_demo_sk\n    and (date_dim.d_dom between 1 and 3 or date_dim.d_dom between 25 and 28)\n    and (household_demographics.hd_buy_potential = '1001-5000' or\n         household_demographics.hd_buy_potential = '0-500')\n    and household_demographics.hd_vehicle_count > 0\n    and (case when household_demographics.hd_vehicle_count > 0 \n\tthen household_demographics.hd_dep_count/ household_demographics.hd_vehicle_count \n\telse null \n\tend)  > 1.2\n    and date_dim.d_year in (1998,1998+1,1998+2)\n    and store.s_county in ('Ziebach County','Daviess County','Walker County','Richland County',\n                           'Barrow County','Franklin Parish','Williamson County','Luce County')\n    group by ss_ticket_number,ss_customer_sk) dn,customer\n    where ss_customer_sk = c_customer_sk\n      and cnt between 15 and 20\n    order by c_last_name,c_first_name,c_salutation,c_preferred_cust_flag desc, ss_ticket_number;\n\n-- end query 34 in stream 0 using template query34.tpl\n",
    "optimized_sql": "WITH filtered_sales AS (SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 1 AND 3 AND hd.hd_buy_potential = '1001-5000' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 1 AND 3 AND hd.hd_buy_potential = '0-500' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 25 AND 28 AND hd.hd_buy_potential = '1001-5000' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 25 AND 28 AND hd.hd_buy_potential = '0-500' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County')), ticket_counts AS (SELECT ss_ticket_number, ss_customer_sk, COUNT(*) AS cnt FROM filtered_sales GROUP BY ss_ticket_number, ss_customer_sk)\nSELECT c.c_last_name, c.c_first_name, c.c_salutation, c.c_preferred_cust_flag, tc.ss_ticket_number, tc.cnt FROM ticket_counts AS tc JOIN customer AS c ON tc.ss_customer_sk = c.c_customer_sk WHERE tc.cnt BETWEEN 15 AND 20 ORDER BY c.c_last_name, c.c_first_name, c.c_salutation, c.c_preferred_cust_flag DESC, tc.ss_ticket_number",
    "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_sales\": \"SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 1 AND 3 AND hd.hd_buy_potential = '1001-5000' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 1 AND 3 AND hd.hd_buy_potential = '0-500' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 25 AND 28 AND hd.hd_buy_potential = '1001-5000' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County') UNION ALL SELECT ss.ss_ticket_number, ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_dom BETWEEN 25 AND 28 AND hd.hd_buy_potential = '0-500' AND hd.hd_vehicle_count > 0 AND (CASE WHEN hd.hd_vehicle_count > 0 THEN hd.hd_dep_count / hd.hd_vehicle_count ELSE NULL END) > 1.2 AND d.d_year IN (1998, 1999, 2000) AND s.s_county IN ('Ziebach County', 'Daviess County', 'Walker County', 'Richland County', 'Barrow County', 'Franklin Parish', 'Williamson County', 'Luce County')\",\n        \"ticket_counts\": \"SELECT ss_ticket_number, ss_customer_sk, COUNT(*) AS cnt FROM filtered_sales GROUP BY ss_ticket_number, ss_customer_sk\",\n        \"main_query\": \"SELECT c.c_last_name, c.c_first_name, c.c_salutation, c.c_preferred_cust_flag, tc.ss_ticket_number, tc.cnt FROM ticket_counts tc JOIN customer c ON tc.ss_customer_sk = c.c_customer_sk WHERE tc.cnt BETWEEN 15 AND 20 ORDER BY c.c_last_name, c.c_first_name, c.c_salutation, c.c_preferred_cust_flag DESC, tc.ss_ticket_number\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same aggregation grain (ss_ticket_number, ss_customer_sk)\",\n        \"same row count after filtering (OR conditions are mutually exclusive)\",\n        \"same ordering\"\n      ],\n      \"expected_speedup\": \"2.00x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied OR_TO_UNION transform to split the two OR conditions (d_dom ranges and hd_buy_potential values) into four mutually exclusive UNION ALL branches. This eliminates the OR predicates that prevent index usage and partition pruning, allowing each branch to be optimized independently. All common predicates (year, county, vehicle count, derived ratio) are pushed down to each branch. The subquery is materialized as ticket_counts CTE, then joined with customer in main_query preserving the original semantics.\"\n}\n```",
    "error": null,
    "latency_ms": 180455.89016199665,
    "tokens_in": 1745,
    "tokens_out": 7056
  }
}