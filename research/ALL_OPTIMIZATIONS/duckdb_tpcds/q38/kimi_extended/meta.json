{
  "source": "kimi_extended",
  "original_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/packages/qt-sql/qt_sql/benchmarks/duckdb_tpcds/queries/query_38.sql",
  "optimized_path": "/mnt/c/Users/jakc9/Documents/QueryTorque_V8/research/archive/benchmark_results/CONSOLIDATED_BENCHMARKS/kimi_q31-q99_optimization/q38/output_optimized.sql",
  "validation": {
    "query_num": 38,
    "status": "success",
    "original_sql": "-- start query 38 in stream 0 using template query38.tpl\nselect count(*) from (\n    select distinct c_last_name, c_first_name, d_date\n    from store_sales, date_dim, customer\n          where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n      and store_sales.ss_customer_sk = customer.c_customer_sk\n      and d_month_seq between 1183 and 1183 + 11\n  intersect\n    select distinct c_last_name, c_first_name, d_date\n    from catalog_sales, date_dim, customer\n          where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n      and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n      and d_month_seq between 1183 and 1183 + 11\n  intersect\n    select distinct c_last_name, c_first_name, d_date\n    from web_sales, date_dim, customer\n          where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n      and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n      and d_month_seq between 1183 and 1183 + 11\n) hot_cust\n LIMIT 100;\n\n-- end query 38 in stream 0 using template query38.tpl\n",
    "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1183 AND 1183 + 11), store_customers AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk), catalog_customers AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk), web_customers AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk)\nSELECT COUNT(*) FROM (SELECT * FROM store_customers INTERSECT SELECT * FROM catalog_customers INTERSECT SELECT * FROM web_customers) AS hot_cust LIMIT 100",
    "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1183 AND 1183 + 11\",\n        \"store_customers\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk\",\n        \"catalog_customers\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk\",\n        \"web_customers\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk\",\n        \"main_query\": \"SELECT COUNT(*) FROM (SELECT * FROM store_customers INTERSECT SELECT * FROM catalog_customers INTERSECT SELECT * FROM web_customers) AS hot_cust LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same count output\",\n        \"same limit constraint\",\n        \"preserved distinctness semantics\",\n        \"preserved intersect logic\"\n      ],\n      \"expected_speedup\": \"2.50x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Factored out the date_dim filter (d_month_seq BETWEEN 1183 AND 1194) into a single CTE to avoid redundant scanning and filtering of the dimension table three times. Applied projection pruning to ensure only necessary columns (c_last_name, c_first_name, d_date) are carried through the joins and distinct operations. This reduces I/O and memory pressure during the INTERSECT operations.\"\n}\n```",
    "error": null,
    "latency_ms": 50062.53846700565,
    "tokens_in": 1580,
    "tokens_out": 3581
  }
}