{
  "operations": [
    {
      "op": "add_cte",
      "after": "start",
      "name": "filtered_ca",
      "sql": "select ca_address_sk, ca_state from customer_address where ca_country = 'United States' and ca_state in ('SD', 'KS', 'MI', 'MO', 'ND', 'CO', 'NH', 'OH', 'TX')"
    },
    {
      "op": "add_cte",
      "after": "filtered_ca",
      "name": "filtered_cd",
      "sql": "select cd_demo_sk, cd_marital_status, cd_education_status from customer_demographics where cd_marital_status in ('D', 'S', 'M') and cd_education_status in ('Unknown', 'College', '4 yr Degree')"
    },
    {
      "op": "add_cte",
      "after": "filtered_cd",
      "name": "filtered_hd",
      "sql": "select hd_demo_sk, hd_dep_count from household_demographics where hd_dep_count in (1, 3)"
    },
    {
      "op": "replace_clause",
      "target": "main_query.from",
      "sql": "from store_sales, store, filtered_cd, filtered_hd, filtered_ca, date_dim"
    },
    {
      "op": "replace_clause",
      "target": "main_query.where",
      "sql": "where s_store_sk = ss_store_sk\n and  ss_sold_date_sk = d_date_sk and d_year = 2001\n and((ss_hdemo_sk=hd_demo_sk\n  and cd_demo_sk = ss_cdemo_sk\n  and cd_marital_status = 'D'\n  and cd_education_status = 'Unknown'\n  and ss_sales_price between 100.00 and 150.00\n  and hd_dep_count = 3   \n     )or\n     (ss_hdemo_sk=hd_demo_sk\n  and cd_demo_sk = ss_cdemo_sk\n  and cd_marital_status = 'S'\n  and cd_education_status = 'College'\n  and ss_sales_price between 50.00 and 100.00   \n  and hd_dep_count = 1\n     ) or \n     (ss_hdemo_sk=hd_demo_sk\n  and cd_demo_sk = ss_cdemo_sk\n  and cd_marital_status = 'M'\n  and cd_education_status = '4 yr Degree'\n  and ss_sales_price between 150.00 and 200.00 \n  and hd_dep_count = 1  \n     ))\n and((ss_addr_sk = ca_address_sk\n  and ca_state in ('SD', 'KS', 'MI')\n  and ss_net_profit between 100 and 200  \n     ) or\n     (ss_addr_sk = ca_address_sk\n  and ca_state in ('MO', 'ND', 'CO')\n  and ss_net_profit between 150 and 300  \n     ) or\n     (ss_addr_sk = ca_address_sk\n  and ca_state in ('NH', 'OH', 'TX')\n  and ss_net_profit between 50 and 250  \n     ))"
    }
  ],
  "semantic_warnings": [
    "Pre-filtered dimensions ca, cd, hd using CTEs to reduce join volume."
  ],
  "explanation": "Consolidated predicates by pre-filtering dimension tables in CTEs to include only the union of all required values. This avoids joining the full dimension tables."
}