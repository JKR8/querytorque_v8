1. **Explicit JOIN syntax**: Replaced comma-separated joins with explicit INNER JOINs for better readability and optimizer hinting, allowing clearer join conditions and potential reordering.
2. **Filter pushdown**: Moved `d1.d_year = 2002` and `s_state IN (...)` directly into the WHERE clause, ensuring these filters are applied early in the join process. This reduces the intermediate result set before grouping, as `date_dim` is filtered to ~365 rows and `store` to ~402 rows based on row estimates, minimizing rows scanned from `store_sales`.
3. **Preserved semantics**: Maintained identical GROUP BY ROLLUP, window function, and ordering logic to ensure the query returns the same results.
4. **Performance impact**: By reducing the rows joined from `date_dim` and `store` upfront, the hash joins and subsequent operations (HASH_GROUP_BY, WINDOW) process fewer rows, lowering overall cost, especially the 89.7% sequential scan on `store_sales`.