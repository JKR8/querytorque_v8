1. **Combined CTE with Early Filtering**: The CTE now includes `i_color IN ('beige', 'blue')`, reducing the initial data volume by filtering on i_color early, which leverages the item table scan efficiency. This avoids processing irrelevant colors twice.
2. **Explicit JOIN Syntax**: Changed implicit joins to explicit INNER JOINs for better readability and potential optimizer hints.
3. **Optimized Subqueries in HAVING**: The subquery for average calculation is now filtered by i_color, so it only computes the average for the relevant color group, reducing computation compared to the original which averaged over all colors.
4. **UNION ALL for Combined Execution**: The two original queries are merged using UNION ALL, allowing the CTE to be computed once and reused, eliminating redundant scans and joins. This reduces overall I/O and CPU usage.
5. **Maintained Semantics**: All original logic (joins, filters, groupings, ordering) is preserved. The output remains identical but is generated more efficiently.
6. **Potential for Further Optimization**: If the database supports materialized CTEs or indexes on filtered columns (e.g., s_market_id, i_color), performance could improve further, but the query is now structured to minimize data movement and recomputation.