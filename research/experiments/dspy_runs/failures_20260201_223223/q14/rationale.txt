1. **Added MATERIALIZED hint to avg_sales CTE**: This forces DuckDB to compute and store the average sales value once, preventing repeated computation in each HAVING clause across all UNION ALL branches. The avg_sales is referenced 6 times total (3 in first query, 3 in second), so materialization significantly reduces computation.

2. **Date filters already optimally placed**: The execution plan shows date_dim is already filtered early (1,096 rows vs 365,000+ total). The cross_items CTE already has date filters in each INTERSECT subquery, and main query branches already filter by specific year/month. No additional filter movement needed.

3. **Preserved all original structure**: Maintained identical CTEs, INTERSECT operations, UNION ALL branches, and JOIN patterns as required by constraints.

4. **Expected performance improvements**: 
   - Materializing avg_sales reduces 6 subquery executions to 1 computation + 6 lookups
   - DuckDB's optimizer can now better parallelize operations with explicit materialization hints
   - Hash joins will process fewer intermediate rows due to pre-computed averages

The optimization is minimal but safe within constraints, focusing on the most impactful change (materialization) that addresses the repeated subquery execution visible in the execution plan.