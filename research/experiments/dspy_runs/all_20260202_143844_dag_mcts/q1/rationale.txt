Optimized by pushing the `s_state = 'SD'` filter from the main query into the CTE `customer_total_return`. This is done by joining `store` inside the CTE and adding the state condition. This reduces the number of rows processed in the CTE, as only returns from stores in South Dakota are aggregated. This also reduces the size of the data scanned in the correlated subquery, since it now operates on a smaller CTE. The CTE is still used in the main query and subquery, but now it's pre-filtered, improving performance. The JOIN syntax is also made explicit for clarity. No other changes were made to maintain the query structure.