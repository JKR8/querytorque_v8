============================================================
PROMPT SENT TO LLM
============================================================

--- Call 1 ---

[system]
Your input fields are:
1. `original_query` (str): The original SQL query to optimize
2. `execution_plan` (str): Execution plan showing operator costs and row counts
3. `table_scans` (str): Table scan info: table name, rows, filter status
Your output fields are:
1. `reasoning` (str): 
2. `optimized_query` (str): The optimized SQL query with identical semantics
3. `rationale` (str): Why this optimization improves performance
All interactions will be structured in the following way, with the appropriate values filled in.

[[ ## original_query ## ]]
{original_query}

[[ ## execution_plan ## ]]
{execution_plan}

[[ ## table_scans ## ]]
{table_scans}

[[ ## reasoning ## ]]
{reasoning}

[[ ## optimized_query ## ]]
{optimized_query}

[[ ## rationale ## ]]
{rationale}

[[ ## completed ## ]]
In adhering to this structure, your objective is: 
        Optimize SQL query for better execution performance.

[user]
[[ ## original_query ## ]]
with customer_total_return as
(select sr_customer_sk as ctr_customer_sk
,sr_store_sk as ctr_store_sk
,sum(SR_FEE) as ctr_total_return
from store_returns
,date_dim
where sr_returned_date_sk = d_date_sk
and d_year =2000
group by sr_customer_sk
,sr_store_sk)
 select c_customer_id
from customer_total_return ctr1
,store
,customer
where ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2
from customer_total_return ctr2
where ctr1.ctr_store_sk = ctr2.ctr_store_sk)
and s_store_sk = ctr1.ctr_store_sk
and s_state = 'SD'
and ctr1.ctr_customer_sk = c_customer_sk
order by c_customer_id
 LIMIT 100;

[[ ## execution_plan ## ]]

Operators by cost:
- SEQ_SCAN (customer): 73.4% cost, 1,999,335 rows
- HASH_JOIN: 11.0% cost, 7,986 rows
- SEQ_SCAN (store_returns): 5.2% cost, 56,138 rows
- HASH_GROUP_BY: 2.9% cost, 55,341 rows


[[ ## table_scans ## ]]

- store_returns: 56,138 rows (NO FILTER)
- date_dim: 366 rows ← FILTERED by d_year=2000
- customer: 1,999,335 rows (NO FILTER)
- store: 53 rows ← FILTERED by s_state='SD'

Key insight: store has only 53 rows after s_state='SD' filter,
but this filter is applied AFTER aggregating store_returns.


Respond with the corresponding output fields, starting with the field `[[ ## reasoning ## ]]`, then `[[ ## optimized_query ## ]]`, then `[[ ## rationale ## ]]`, and then ending with the marker for `[[ ## completed ## ]]`.


