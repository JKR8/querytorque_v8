{
  "query_num": 44,
  "status": "success",
  "original_sql": "-- start query 44 in stream 0 using template query44.tpl\nselect asceding.rnk, i1.i_product_name best_performing, i2.i_product_name worst_performing\nfrom(select *\n     from (select item_sk,rank() over (order by rank_col asc) rnk\n           from (select ss_item_sk item_sk,avg(ss_net_profit) rank_col \n                 from store_sales ss1\n                 where ss_store_sk = 146\n                 group by ss_item_sk\n                 having avg(ss_net_profit) > 0.9*(select avg(ss_net_profit) rank_col\n                                                  from store_sales\n                                                  where ss_store_sk = 146\n                                                    and ss_addr_sk is null\n                                                  group by ss_store_sk))V1)V11\n     where rnk  < 11) asceding,\n    (select *\n     from (select item_sk,rank() over (order by rank_col desc) rnk\n           from (select ss_item_sk item_sk,avg(ss_net_profit) rank_col\n                 from store_sales ss1\n                 where ss_store_sk = 146\n                 group by ss_item_sk\n                 having avg(ss_net_profit) > 0.9*(select avg(ss_net_profit) rank_col\n                                                  from store_sales\n                                                  where ss_store_sk = 146\n                                                    and ss_addr_sk is null\n                                                  group by ss_store_sk))V2)V21\n     where rnk  < 11) descending,\nitem i1,\nitem i2\nwhere asceding.rnk = descending.rnk \n  and i1.i_item_sk=asceding.item_sk\n  and i2.i_item_sk=descending.item_sk\norder by asceding.rnk\n LIMIT 100;\n\n-- end query 44 in stream 0 using template query44.tpl\n",
  "optimized_sql": "WITH threshold_calc AS (SELECT AVG(ss_net_profit) * 0.9 AS profit_threshold FROM store_sales WHERE ss_store_sk = 146 AND ss_addr_sk IS NULL GROUP BY ss_store_sk), qualified_items AS (SELECT ss1.ss_item_sk AS item_sk, AVG(ss1.ss_net_profit) AS rank_col FROM store_sales AS ss1 CROSS JOIN threshold_calc WHERE ss1.ss_store_sk = 146 GROUP BY ss1.ss_item_sk HAVING AVG(ss1.ss_net_profit) > threshold_calc.profit_threshold), ascending AS (SELECT item_sk, rnk FROM (SELECT item_sk, RANK() OVER (ORDER BY rank_col ASC) AS rnk FROM qualified_items) AS t WHERE rnk < 11), descending AS (SELECT item_sk, rnk FROM (SELECT item_sk, RANK() OVER (ORDER BY rank_col DESC) AS rnk FROM qualified_items) AS t WHERE rnk < 11)\nSELECT a.rnk, i1.i_product_name AS best_performing, i2.i_product_name AS worst_performing FROM ascending AS a JOIN descending AS d ON a.rnk = d.rnk JOIN item AS i1 ON i1.i_item_sk = a.item_sk JOIN item AS i2 ON i2.i_item_sk = d.item_sk ORDER BY a.rnk LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"threshold_calc\": \"SELECT AVG(ss_net_profit) * 0.9 AS profit_threshold FROM store_sales WHERE ss_store_sk = 146 AND ss_addr_sk IS NULL GROUP BY ss_store_sk\",\n        \"qualified_items\": \"SELECT ss1.ss_item_sk AS item_sk, AVG(ss1.ss_net_profit) AS rank_col FROM store_sales ss1 CROSS JOIN threshold_calc WHERE ss1.ss_store_sk = 146 GROUP BY ss1.ss_item_sk HAVING AVG(ss1.ss_net_profit) > threshold_calc.profit_threshold\",\n        \"ascending\": \"SELECT item_sk, rnk FROM (SELECT item_sk, RANK() OVER (ORDER BY rank_col ASC) AS rnk FROM qualified_items) t WHERE rnk < 11\",\n        \"descending\": \"SELECT item_sk, rnk FROM (SELECT item_sk, RANK() OVER (ORDER BY rank_col DESC) AS rnk FROM qualified_items) t WHERE rnk < 11\",\n        \"main_query\": \"SELECT a.rnk, i1.i_product_name AS best_performing, i2.i_product_name AS worst_performing FROM ascending a JOIN descending d ON a.rnk = d.rnk JOIN item i1 ON i1.i_item_sk = a.item_sk JOIN item i2 ON i2.i_item_sk = d.item_sk ORDER BY a.rnk LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same row filtering (rnk < 11)\",\n        \"same join predicates\",\n        \"same ordering\",\n        \"same limit\"\n      ],\n      \"expected_speedup\": \"1.80x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Extracted the scalar subquery from the HAVING clause into a separate threshold_calc node (decorrelate). This eliminates redundant computation of the 0.9*avg threshold. Additionally, factored out the common item aggregation (qualified_items) that was previously computed twice (once for ascending, once for descending). Now store_sales is scanned only twice (once for threshold, once for item aggregates) instead of three times, and the aggregation is computed once and reused for both ranking directions.\"\n}\n```",
  "error": null,
  "latency_ms": 103908.17439799866,
  "tokens_in": 1731,
  "tokens_out": 6382
}