{
  "query_num": 87,
  "status": "success",
  "original_sql": "-- start query 87 in stream 0 using template query87.tpl\nselect count(*) \nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1184 and 1184+11)\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1184 and 1184+11)\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1184 and 1184+11)\n) cool_cust\n;\n\n-- end query 87 in stream 0 using template query87.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1184 AND 1184 + 11), store_branch AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk), catalog_branch AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk), web_branch AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk)\nSELECT COUNT(*) FROM ((SELECT * FROM store_branch) EXCEPT (SELECT * FROM catalog_branch) EXCEPT (SELECT * FROM web_branch)) AS cool_cust",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1184 AND 1184 + 11\",\n        \"store_branch\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk\",\n        \"catalog_branch\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk\",\n        \"web_branch\": \"SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk\",\n        \"main_query\": \"SELECT COUNT(*) FROM ((SELECT * FROM store_branch) EXCEPT (SELECT * FROM catalog_branch) EXCEPT (SELECT * FROM web_branch)) AS cool_cust\"\n      },\n      \"invariants_kept\": [\n        \"same result count\",\n        \"same set difference semantics\",\n        \"same column output\",\n        \"preserved date range filter\"\n      ],\n      \"expected_speedup\": \"2.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to pre-filter date_dim once instead of scanning it three times (once per EXCEPT branch). The date_dim filter d_month_seq BETWEEN 1184 AND 1195 is computed once in the filtered_dates CTE, reducing the input size for all three subsequent joins against store_sales, catalog_sales, and web_sales. This eliminates redundant I/O and predicate evaluation on the dimension table.\"\n}\n```",
  "error": null,
  "latency_ms": 100869.77812799887,
  "tokens_in": 1579,
  "tokens_out": 4446
}