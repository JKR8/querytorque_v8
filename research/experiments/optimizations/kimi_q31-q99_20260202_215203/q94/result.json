{
  "query_num": 94,
  "status": "success",
  "original_sql": "-- start query 94 in stream 0 using template query94.tpl\nselect \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '2000-2-01' and \n           (cast('2000-2-01' as date) + INTERVAL 60 DAY)\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state = 'OK'\nand ws1.ws_web_site_sk = web_site_sk\nand web_company_name = 'pri'\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number)\norder by count(distinct ws_order_number)\n LIMIT 100;\n\n-- end query 94 in stream 0 using template query94.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2000-2-01' AND (CAST('2000-2-01' AS DATE) + INTERVAL '60' DAY)), filtered_addresses AS (SELECT ca_address_sk FROM customer_address WHERE ca_state = 'OK'), filtered_sites AS (SELECT web_site_sk FROM web_site WHERE web_company_name = 'pri'), multi_warehouse_orders AS (SELECT ws_order_number FROM web_sales GROUP BY ws_order_number HAVING COUNT(DISTINCT ws_warehouse_sk) > 1), orders_with_returns AS (SELECT DISTINCT wr_order_number FROM web_returns)\nSELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales AS ws1 JOIN filtered_dates ON ws1.ws_ship_date_sk = filtered_dates.d_date_sk JOIN filtered_addresses ON ws1.ws_ship_addr_sk = filtered_addresses.ca_address_sk JOIN filtered_sites ON ws1.ws_web_site_sk = filtered_sites.web_site_sk JOIN multi_warehouse_orders AS mwo ON ws1.ws_order_number = mwo.ws_order_number LEFT JOIN orders_with_returns AS owr ON ws1.ws_order_number = owr.wr_order_number WHERE owr.wr_order_number IS NULL ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2000-2-01' AND (CAST('2000-2-01' AS DATE) + INTERVAL '60' DAY)\",\n        \"filtered_addresses\": \"SELECT ca_address_sk FROM customer_address WHERE ca_state = 'OK'\",\n        \"filtered_sites\": \"SELECT web_site_sk FROM web_site WHERE web_company_name = 'pri'\",\n        \"multi_warehouse_orders\": \"SELECT ws_order_number FROM web_sales GROUP BY ws_order_number HAVING COUNT(DISTINCT ws_warehouse_sk) > 1\",\n        \"orders_with_returns\": \"SELECT DISTINCT wr_order_number FROM web_returns\",\n        \"main_query\": \"SELECT COUNT(DISTINCT ws1.ws_order_number) AS \\\"order count\\\", SUM(ws1.ws_ext_ship_cost) AS \\\"total shipping cost\\\", SUM(ws1.ws_net_profit) AS \\\"total net profit\\\" FROM web_sales AS ws1 JOIN filtered_dates ON ws1.ws_ship_date_sk = filtered_dates.d_date_sk JOIN filtered_addresses ON ws1.ws_ship_addr_sk = filtered_addresses.ca_address_sk JOIN filtered_sites ON ws1.ws_web_site_sk = filtered_sites.web_site_sk JOIN multi_warehouse_orders mwo ON ws1.ws_order_number = mwo.ws_order_number LEFT JOIN orders_with_returns owr ON ws1.ws_order_number = owr.wr_order_number WHERE owr.wr_order_number IS NULL ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation results\",\n        \"same ordering\",\n        \"required predicates preserved via early filters\",\n        \"correlated EXISTS converted to semi-join\",\n        \"correlated NOT EXISTS converted to anti-join\"\n      ],\n      \"expected_speedup\": \"3.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Eliminated correlated subqueries by pre-computing: (1) orders with multiple warehouses using GROUP BY/HAVING, and (2) orders with returns using DISTINCT scan. Converted EXISTS to inner join and NOT EXISTS to left join with IS NULL check. Pushed down filters on date_dim, customer_address, and web_site into early CTEs to reduce input size before joins.\"\n}\n```",
  "error": null,
  "latency_ms": 85368.51527300314,
  "tokens_in": 1597,
  "tokens_out": 5147
}