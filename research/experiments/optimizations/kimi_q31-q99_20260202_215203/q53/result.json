{
  "query_num": 53,
  "status": "success",
  "original_sql": "-- start query 53 in stream 0 using template query53.tpl\nselect * from \n(select i_manufact_id,\nsum(ss_sales_price) sum_sales,\navg(sum(ss_sales_price)) over (partition by i_manufact_id) avg_quarterly_sales\nfrom item, store_sales, date_dim, store\nwhere ss_item_sk = i_item_sk and\nss_sold_date_sk = d_date_sk and\nss_store_sk = s_store_sk and\nd_month_seq in (1200,1200+1,1200+2,1200+3,1200+4,1200+5,1200+6,1200+7,1200+8,1200+9,1200+10,1200+11) and\n((i_category in ('Books','Children','Electronics') and\ni_class in ('personal','portable','reference','self-help') and\ni_brand in ('scholaramalgamalg #14','scholaramalgamalg #7',\n\t\t'exportiunivamalg #9','scholaramalgamalg #9'))\nor(i_category in ('Women','Music','Men') and\ni_class in ('accessories','classical','fragrances','pants') and\ni_brand in ('amalgimporto #1','edu packscholar #1','exportiimporto #1',\n\t\t'importoamalg #1')))\ngroup by i_manufact_id, d_qoy ) tmp1\nwhere case when avg_quarterly_sales > 0 \n\tthen abs (sum_sales - avg_quarterly_sales)/ avg_quarterly_sales \n\telse null end > 0.1\norder by avg_quarterly_sales,\n\t sum_sales,\n\t i_manufact_id\n LIMIT 100;\n\n-- end query 53 in stream 0 using template query53.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_qoy FROM date_dim WHERE d_month_seq IN (1200, 1200 + 1, 1200 + 2, 1200 + 3, 1200 + 4, 1200 + 5, 1200 + 6, 1200 + 7, 1200 + 8, 1200 + 9, 1200 + 10, 1200 + 11)), filtered_sales AS (SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN filtered_dates AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Books', 'Children', 'Electronics') AND i.i_class IN ('personal', 'portable', 'reference', 'self-help') AND i.i_brand IN ('scholaramalgamalg #14', 'scholaramalgamalg #7', 'exportiunivamalg #9', 'scholaramalgamalg #9') UNION ALL SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM item AS i JOIN store_sales AS ss ON ss.ss_item_sk = i.i_item_sk JOIN filtered_dates AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Women', 'Music', 'Men') AND i.i_class IN ('accessories', 'classical', 'fragrances', 'pants') AND i.i_brand IN ('amalgimporto #1', 'edu packscholar #1', 'exportiimporto #1', 'importoamalg #1'))\nSELECT * FROM (SELECT i_manufact_id, SUM(ss_sales_price) AS sum_sales, AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manufact_id) AS avg_quarterly_sales FROM filtered_sales GROUP BY i_manufact_id, d_qoy) AS tmp1 WHERE CASE WHEN avg_quarterly_sales > 0 THEN ABS(sum_sales - avg_quarterly_sales) / avg_quarterly_sales ELSE NULL END > 0.1 ORDER BY avg_quarterly_sales, sum_sales, i_manufact_id LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk, d_qoy FROM date_dim WHERE d_month_seq IN (1200, 1200 + 1, 1200 + 2, 1200 + 3, 1200 + 4, 1200 + 5, 1200 + 6, 1200 + 7, 1200 + 8, 1200 + 9, 1200 + 10, 1200 + 11)\",\n        \"filtered_sales\": \"SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM item i JOIN store_sales ss ON ss.ss_item_sk = i.i_item_sk JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Books', 'Children', 'Electronics') AND i.i_class IN ('personal', 'portable', 'reference', 'self-help') AND i.i_brand IN ('scholaramalgamalg #14', 'scholaramalgamalg #7', 'exportiunivamalg #9', 'scholaramalgamalg #9') UNION ALL SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM item i JOIN store_sales ss ON ss.ss_item_sk = i.i_item_sk JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE i.i_category IN ('Women', 'Music', 'Men') AND i.i_class IN ('accessories', 'classical', 'fragrances', 'pants') AND i.i_brand IN ('amalgimporto #1', 'edu packscholar #1', 'exportiimporto #1', 'importoamalg #1')\",\n        \"main_query\": \"SELECT * FROM (SELECT i_manufact_id, SUM(ss_sales_price) AS sum_sales, AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manufact_id) AS avg_quarterly_sales FROM filtered_sales GROUP BY i_manufact_id, d_qoy) AS tmp1 WHERE CASE WHEN avg_quarterly_sales > 0 THEN ABS(sum_sales - avg_quarterly_sales) / avg_quarterly_sales ELSE NULL END > 0.1 ORDER BY avg_quarterly_sales, sum_sales, i_manufact_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\",\n        \"window function semantics preserved\"\n      ],\n      \"expected_speedup\": \"2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Split the OR condition on item attributes (category/class/brand) into two UNION ALL branches. This allows the optimizer to use selective indexes on each branch (one for Books/Children/Electronics categories, one for Women/Music/Men categories) rather than scanning all items and applying a complex OR predicate. The date filter is pushed into a CTE to avoid recomputation, and the aggregation/window function logic remains unchanged in the main query.\"\n}\n```",
  "error": null,
  "latency_ms": 137692.45881200186,
  "tokens_in": 1794,
  "tokens_out": 4446
}