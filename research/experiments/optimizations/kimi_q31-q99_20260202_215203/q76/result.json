{
  "query_num": 76,
  "status": "success",
  "original_sql": "-- start query 76 in stream 0 using template query76.tpl\nselect channel, col_name, d_year, d_qoy, i_category, COUNT(*) sales_cnt, SUM(ext_sales_price) sales_amt FROM (\n        SELECT 'store' as channel, 'ss_hdemo_sk' col_name, d_year, d_qoy, i_category, ss_ext_sales_price ext_sales_price\n         FROM store_sales, item, date_dim\n         WHERE ss_hdemo_sk IS NULL\n           AND ss_sold_date_sk=d_date_sk\n           AND ss_item_sk=i_item_sk\n        UNION ALL\n        SELECT 'web' as channel, 'ws_bill_addr_sk' col_name, d_year, d_qoy, i_category, ws_ext_sales_price ext_sales_price\n         FROM web_sales, item, date_dim\n         WHERE ws_bill_addr_sk IS NULL\n           AND ws_sold_date_sk=d_date_sk\n           AND ws_item_sk=i_item_sk\n        UNION ALL\n        SELECT 'catalog' as channel, 'cs_warehouse_sk' col_name, d_year, d_qoy, i_category, cs_ext_sales_price ext_sales_price\n         FROM catalog_sales, item, date_dim\n         WHERE cs_warehouse_sk IS NULL\n           AND cs_sold_date_sk=d_date_sk\n           AND cs_item_sk=i_item_sk) foo\nGROUP BY channel, col_name, d_year, d_qoy, i_category\nORDER BY channel, col_name, d_year, d_qoy, i_category\n LIMIT 100;\n\n-- end query 76 in stream 0 using template query76.tpl\n",
  "optimized_sql": "WITH store_sales_agg AS (SELECT 'store' AS channel, 'ss_hdemo_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ss_ext_sales_price) AS sales_amt FROM store_sales, item, date_dim WHERE ss_hdemo_sk IS NULL AND ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category), web_sales_agg AS (SELECT 'web' AS channel, 'ws_bill_addr_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ws_ext_sales_price) AS sales_amt FROM web_sales, item, date_dim WHERE ws_bill_addr_sk IS NULL AND ws_sold_date_sk = d_date_sk AND ws_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category), catalog_sales_agg AS (SELECT 'catalog' AS channel, 'cs_warehouse_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(cs_ext_sales_price) AS sales_amt FROM catalog_sales, item, date_dim WHERE cs_warehouse_sk IS NULL AND cs_sold_date_sk = d_date_sk AND cs_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category)\nSELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM store_sales_agg UNION ALL SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM web_sales_agg UNION ALL SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM catalog_sales_agg ORDER BY channel, col_name, d_year, d_qoy, i_category LIMIT 100",
  "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"pushdown\",\n      \"nodes\": {\n        \"store_sales_agg\": \"SELECT 'store' AS channel, 'ss_hdemo_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ss_ext_sales_price) AS sales_amt FROM store_sales, item, date_dim WHERE ss_hdemo_sk IS NULL AND ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category\",\n        \"web_sales_agg\": \"SELECT 'web' AS channel, 'ws_bill_addr_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(ws_ext_sales_price) AS sales_amt FROM web_sales, item, date_dim WHERE ws_bill_addr_sk IS NULL AND ws_sold_date_sk = d_date_sk AND ws_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category\",\n        \"catalog_sales_agg\": \"SELECT 'catalog' AS channel, 'cs_warehouse_sk' AS col_name, d_year, d_qoy, i_category, COUNT(*) AS sales_cnt, SUM(cs_ext_sales_price) AS sales_amt FROM catalog_sales, item, date_dim WHERE cs_warehouse_sk IS NULL AND cs_sold_date_sk = d_date_sk AND cs_item_sk = i_item_sk GROUP BY d_year, d_qoy, i_category\",\n        \"main_query\": \"SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM store_sales_agg UNION ALL SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM web_sales_agg UNION ALL SELECT channel, col_name, d_year, d_qoy, i_category, sales_cnt, sales_amt FROM catalog_sales_agg ORDER BY channel, col_name, d_year, d_qoy, i_category LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"row grain preserved (channel, col_name distinguish union branches)\",\n        \"same aggregation results (COUNT and SUM pushed down)\",\n        \"same ordering and limit\"\n      ],\n      \"expected_speedup\": \"3.20x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Pushed GROUP BY and aggregations (COUNT, SUM) down into each UNION branch. Since channel and col_name are constants per branch, aggregating within each branch first reduces data volume before the UNION ALL, eliminating the need for the outer GROUP BY. Each branch now computes partial aggregates on (d_year, d_qoy, i_category) locally.\"\n}\n```",
  "error": null,
  "latency_ms": 97270.33718900202,
  "tokens_in": 1697,
  "tokens_out": 4437
}