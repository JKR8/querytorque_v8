{
  "query_num": 92,
  "status": "success",
  "original_sql": "-- start query 92 in stream 0 using template query92.tpl\nselect \n   sum(ws_ext_discount_amt)  as \"Excess Discount Amount\" \nfrom \n    web_sales \n   ,item \n   ,date_dim\nwhere\ni_manufact_id = 320\nand i_item_sk = ws_item_sk \nand d_date between '2002-02-26' and \n        (cast('2002-02-26' as date) + INTERVAL 90 DAY)\nand d_date_sk = ws_sold_date_sk \nand ws_ext_discount_amt  \n     > ( \n         SELECT \n            1.3 * avg(ws_ext_discount_amt) \n         FROM \n            web_sales \n           ,date_dim\n         WHERE \n              ws_item_sk = i_item_sk \n          and d_date between '2002-02-26' and\n                             (cast('2002-02-26' as date) + INTERVAL 90 DAY)\n          and d_date_sk = ws_sold_date_sk \n      ) \norder by sum(ws_ext_discount_amt)\n LIMIT 100;\n\n-- end query 92 in stream 0 using template query92.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-02-26' AND (CAST('2002-02-26' AS DATE) + INTERVAL '90' DAY)), filtered_items AS (SELECT i_item_sk FROM item WHERE i_manufact_id = 320), item_avg_discount AS (SELECT ws.ws_item_sk, 1.3 * AVG(ws.ws_ext_discount_amt) AS discount_threshold FROM web_sales AS ws JOIN filtered_dates AS fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN filtered_items AS fi ON ws.ws_item_sk = fi.i_item_sk GROUP BY ws.ws_item_sk)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales AS ws JOIN filtered_dates AS fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN filtered_items AS fi ON ws.ws_item_sk = fi.i_item_sk JOIN item_avg_discount AS iad ON ws.ws_item_sk = iad.ws_item_sk WHERE ws.ws_ext_discount_amt > iad.discount_threshold ORDER BY SUM(ws.ws_ext_discount_amt) LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"decorrelate\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-02-26' AND (CAST('2002-02-26' AS DATE) + INTERVAL '90' DAY)\",\n        \"filtered_items\": \"SELECT i_item_sk FROM item WHERE i_manufact_id = 320\",\n        \"item_avg_discount\": \"SELECT ws.ws_item_sk, 1.3 * AVG(ws.ws_ext_discount_amt) AS discount_threshold FROM web_sales ws JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN filtered_items fi ON ws.ws_item_sk = fi.i_item_sk GROUP BY ws.ws_item_sk\",\n        \"main_query\": \"SELECT SUM(ws.ws_ext_discount_amt) AS \\\"Excess Discount Amount\\\" FROM web_sales ws JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN filtered_items fi ON ws.ws_item_sk = fi.i_item_sk JOIN item_avg_discount iad ON ws.ws_item_sk = iad.ws_item_sk WHERE ws.ws_ext_discount_amt > iad.discount_threshold ORDER BY SUM(ws.ws_ext_discount_amt) LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation result\",\n        \"same ordering\",\n        \"same column output\"\n      ],\n      \"expected_speedup\": \"3.2x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Decorrelated the scalar subquery by computing the 1.3x average discount per item as a separate grouped CTE (item_avg_discount) rather than a correlated subquery executed per row. Pushed down the date range filter into filtered_dates CTE used by both the average calculation and main query. Pushed down i_manufact_id=320 filter into filtered_items CTE to limit computation to relevant items only. The main query now joins these pre-computed results instead of using a dependent subquery, enabling hash joins and eliminating repeated scans of web_sales.\"\n}\n```",
  "error": null,
  "latency_ms": 899370.4735349966,
  "tokens_in": 1563,
  "tokens_out": 5911
}