{
  "query_num": 65,
  "status": "success",
  "original_sql": "-- start query 65 in stream 0 using template query65.tpl\nselect\n\ts_store_name,\n\ti_item_desc,\n\tsc.revenue,\n\ti_current_price,\n\ti_wholesale_cost,\n\ti_brand\n from store, item,\n     (select ss_store_sk, avg(revenue) as ave\n \tfrom\n \t    (select  ss_store_sk, ss_item_sk, \n \t\t     sum(ss_sales_price) as revenue\n \t\tfrom store_sales, date_dim\n \t\twhere ss_sold_date_sk = d_date_sk and d_month_seq between 1221 and 1221+11\n \t\tgroup by ss_store_sk, ss_item_sk) sa\n \tgroup by ss_store_sk) sb,\n     (select  ss_store_sk, ss_item_sk, sum(ss_sales_price) as revenue\n \tfrom store_sales, date_dim\n \twhere ss_sold_date_sk = d_date_sk and d_month_seq between 1221 and 1221+11\n \tgroup by ss_store_sk, ss_item_sk) sc\n where sb.ss_store_sk = sc.ss_store_sk and \n       sc.revenue <= 0.1 * sb.ave and\n       s_store_sk = sc.ss_store_sk and\n       i_item_sk = sc.ss_item_sk\n order by s_store_name, i_item_desc\n LIMIT 100;\n\n-- end query 65 in stream 0 using template query65.tpl\n",
  "optimized_sql": "WITH filtered_sales AS (SELECT ss.ss_store_sk, ss.ss_item_sk, ss.ss_sales_price FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq BETWEEN 1221 AND 1221 + 11), item_revenue AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM filtered_sales GROUP BY ss_store_sk, ss_item_sk), store_avg AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM item_revenue GROUP BY ss_store_sk)\nSELECT s.s_store_name, i.i_item_desc, ir.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM item_revenue AS ir JOIN store_avg AS sb ON ir.ss_store_sk = sb.ss_store_sk JOIN store AS s ON s.s_store_sk = ir.ss_store_sk JOIN item AS i ON i.i_item_sk = ir.ss_item_sk WHERE ir.revenue <= 0.1 * sb.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_sales\": \"SELECT ss.ss_store_sk, ss.ss_item_sk, ss.ss_sales_price FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq BETWEEN 1221 AND 1221 + 11\",\n        \"item_revenue\": \"SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM filtered_sales GROUP BY ss_store_sk, ss_item_sk\",\n        \"store_avg\": \"SELECT ss_store_sk, AVG(revenue) AS ave FROM item_revenue GROUP BY ss_store_sk\",\n        \"main_query\": \"SELECT s.s_store_name, i.i_item_desc, ir.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM item_revenue ir JOIN store_avg sb ON ir.ss_store_sk = sb.ss_store_sk JOIN store s ON s.s_store_sk = ir.ss_store_sk JOIN item i ON i.i_item_sk = ir.ss_item_sk WHERE ir.revenue <= 0.1 * sb.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"grain preserved (store-item level)\",\n        \"same filter predicate d_month_seq applied\",\n        \"same ordering and limit\"\n      ],\n      \"expected_speedup\": \"2.00x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Eliminated redundant scan of store_sales by extracting common date filter into CTE 'filtered_sales'. The original query scanned store_sales twice (once for sb via sa, once for sc). Now we filter once, then compute item_revenue (replacing both sa and sc), compute store_avg from it (replacing sb), and join. This cuts I/O on the largest table in half.\"\n}\n```",
  "error": null,
  "latency_ms": 363851.90358899854,
  "tokens_in": 1641,
  "tokens_out": 5008
}