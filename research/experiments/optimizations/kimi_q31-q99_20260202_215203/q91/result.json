{
  "query_num": 91,
  "status": "success",
  "original_sql": "-- start query 91 in stream 0 using template query91.tpl\nselect  \n        cc_call_center_id Call_Center,\n        cc_name Call_Center_Name,\n        cc_manager Manager,\n        sum(cr_net_loss) Returns_Loss\nfrom\n        call_center,\n        catalog_returns,\n        date_dim,\n        customer,\n        customer_address,\n        customer_demographics,\n        household_demographics\nwhere\n        cr_call_center_sk       = cc_call_center_sk\nand     cr_returned_date_sk     = d_date_sk\nand     cr_returning_customer_sk= c_customer_sk\nand     cd_demo_sk              = c_current_cdemo_sk\nand     hd_demo_sk              = c_current_hdemo_sk\nand     ca_address_sk           = c_current_addr_sk\nand     d_year                  = 2001 \nand     d_moy                   = 11\nand     ( (cd_marital_status       = 'M' and cd_education_status     = 'Unknown')\n        or(cd_marital_status       = 'W' and cd_education_status     = 'Advanced Degree'))\nand     hd_buy_potential like '1001-5000%'\nand     ca_gmt_offset           = -6\ngroup by cc_call_center_id,cc_name,cc_manager,cd_marital_status,cd_education_status\norder by sum(cr_net_loss) desc;\n\n-- end query 91 in stream 0 using template query91.tpl\n",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 11), filtered_returns AS (SELECT cr.cr_net_loss, cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status FROM catalog_returns AS cr JOIN filtered_dates AS d ON cr.cr_returned_date_sk = d.d_date_sk JOIN call_center AS cc ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer AS c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Unknown' AND hd.hd_buy_potential LIKE '1001-5000%' AND ca.ca_gmt_offset = -6 UNION ALL SELECT cr.cr_net_loss, cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status FROM catalog_returns AS cr JOIN filtered_dates AS d ON cr.cr_returned_date_sk = d.d_date_sk JOIN call_center AS cc ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer AS c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Advanced Degree' AND hd.hd_buy_potential LIKE '1001-5000%' AND ca.ca_gmt_offset = -6)\nSELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM filtered_returns GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"or_to_union\",\n      \"nodes\": {\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 11\",\n        \"filtered_returns\": \"SELECT cr.cr_net_loss, cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status FROM catalog_returns cr JOIN filtered_dates d ON cr.cr_returned_date_sk = d.d_date_sk JOIN call_center cc ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Unknown' AND hd.hd_buy_potential LIKE '1001-5000%' AND ca.ca_gmt_offset = -6 UNION ALL SELECT cr.cr_net_loss, cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status FROM catalog_returns cr JOIN filtered_dates d ON cr.cr_returned_date_sk = d.d_date_sk JOIN call_center cc ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN customer c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Advanced Degree' AND hd.hd_buy_potential LIKE '1001-5000%' AND ca.ca_gmt_offset = -6\",\n        \"main_query\": \"SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM filtered_returns GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"same grouping columns\",\n        \"same aggregation result\",\n        \"same ordering\",\n        \"all required predicates applied\"\n      ],\n      \"expected_speedup\": \"2.00x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Split the OR condition on customer demographics into two UNION ALL branches to enable better index usage and partition pruning. Pushed down date filters (d_year=2001, d_moy=11) into a separate CTE to avoid repeated filtering. Each branch applies its specific marital_status/education_status filter along with the common predicates (hd_buy_potential, ca_gmt_offset) to reduce intermediate result sets before aggregation.\"\n}\n```",
  "error": null,
  "latency_ms": 133188.92288699863,
  "tokens_in": 1665,
  "tokens_out": 4033
}