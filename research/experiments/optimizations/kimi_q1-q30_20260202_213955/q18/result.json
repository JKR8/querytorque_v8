{
  "query_num": 18,
  "status": "success",
  "original_sql": "-- start query 18 in stream 0 using template query18.tpl\nselect i_item_id,\n        ca_country,\n        ca_state, \n        ca_county,\n        avg( cast(cs_quantity as decimal(12,2))) agg1,\n        avg( cast(cs_list_price as decimal(12,2))) agg2,\n        avg( cast(cs_coupon_amt as decimal(12,2))) agg3,\n        avg( cast(cs_sales_price as decimal(12,2))) agg4,\n        avg( cast(cs_net_profit as decimal(12,2))) agg5,\n        avg( cast(c_birth_year as decimal(12,2))) agg6,\n        avg( cast(cd1.cd_dep_count as decimal(12,2))) agg7\n from catalog_sales, customer_demographics cd1, \n      customer_demographics cd2, customer, customer_address, date_dim, item\n where cs_sold_date_sk = d_date_sk and\n       cs_item_sk = i_item_sk and\n       cs_bill_cdemo_sk = cd1.cd_demo_sk and\n       cs_bill_customer_sk = c_customer_sk and\n       cd1.cd_gender = 'F' and \n       cd1.cd_education_status = 'Advanced Degree' and\n       c_current_cdemo_sk = cd2.cd_demo_sk and\n       c_current_addr_sk = ca_address_sk and\n       c_birth_month in (10,7,8,4,1,2) and\n       d_year = 1998 and\n       ca_state in ('WA','GA','NC'\n                   ,'ME','WY','OK','IN')\n group by rollup (i_item_id, ca_country, ca_state, ca_county)\n order by ca_country,\n        ca_state, \n        ca_county,\n\ti_item_id\n LIMIT 100;\n\n-- end query 18 in stream 0 using template query18.tpl\n",
  "optimized_sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998), filtered_cd1 AS (SELECT cd_demo_sk, cd_dep_count FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = 'Advanced Degree'), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_month IN (10, 7, 8, 4, 1, 2)), filtered_customer_address AS (SELECT ca_address_sk, ca_country, ca_state, ca_county FROM customer_address WHERE ca_state IN ('WA', 'GA', 'NC', 'ME', 'WY', 'OK', 'IN'))\nSELECT i_item_id, ca_country, ca_state, ca_county, AVG(CAST(cs_quantity AS DECIMAL(12, 2))) AS agg1, AVG(CAST(cs_list_price AS DECIMAL(12, 2))) AS agg2, AVG(CAST(cs_coupon_amt AS DECIMAL(12, 2))) AS agg3, AVG(CAST(cs_sales_price AS DECIMAL(12, 2))) AS agg4, AVG(CAST(cs_net_profit AS DECIMAL(12, 2))) AS agg5, AVG(CAST(c_birth_year AS DECIMAL(12, 2))) AS agg6, AVG(CAST(cd1.cd_dep_count AS DECIMAL(12, 2))) AS agg7 FROM catalog_sales JOIN filtered_date_dim ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk JOIN filtered_cd1 AS cd1 ON cs_bill_cdemo_sk = cd1.cd_demo_sk JOIN filtered_customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_demographics AS cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk JOIN filtered_customer_address ON c_current_addr_sk = ca_address_sk GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county) ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_date_dim\": \"SELECT d_date_sk FROM date_dim WHERE d_year = 1998\",\n        \"filtered_cd1\": \"SELECT cd_demo_sk, cd_dep_count FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = 'Advanced Degree'\",\n        \"filtered_customer\": \"SELECT c_customer_sk, c_current_cdemo_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_month IN (10, 7, 8, 4, 1, 2)\",\n        \"filtered_customer_address\": \"SELECT ca_address_sk, ca_country, ca_state, ca_county FROM customer_address WHERE ca_state IN ('WA', 'GA', 'NC', 'ME', 'WY', 'OK', 'IN')\",\n        \"main_query\": \"SELECT i_item_id, ca_country, ca_state, ca_county, AVG(CAST(cs_quantity AS DECIMAL(12, 2))) AS agg1, AVG(CAST(cs_list_price AS DECIMAL(12, 2))) AS agg2, AVG(CAST(cs_coupon_amt AS DECIMAL(12, 2))) AS agg3, AVG(CAST(cs_sales_price AS DECIMAL(12, 2))) AS agg4, AVG(CAST(cs_net_profit AS DECIMAL(12, 2))) AS agg5, AVG(CAST(c_birth_year AS DECIMAL(12, 2))) AS agg6, AVG(CAST(cd1.cd_dep_count AS DECIMAL(12, 2))) AS agg7 FROM catalog_sales JOIN filtered_date_dim ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk JOIN filtered_cd1 cd1 ON cs_bill_cdemo_sk = cd1.cd_demo_sk JOIN filtered_customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_demographics cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk JOIN filtered_customer_address ON c_current_addr_sk = ca_address_sk GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county) ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same aggregation results\",\n        \"same column output\",\n        \"same ordering\",\n        \"same rollup semantics\"\n      ],\n      \"expected_speedup\": \"3.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to push down selective predicates on dimension tables (date_dim, customer_demographics cd1, customer, customer_address) before joining with the large catalog_sales fact table. This reduces the intermediate join cardinality significantly. Filtered CTEs project only columns needed for subsequent joins and aggregations, minimizing data movement. The main query preserves all original join relationships, group by rollup, and ordering.\"\n}\n```",
  "error": null,
  "latency_ms": 540820.2348650012,
  "tokens_in": 1768,
  "tokens_out": 4019
}