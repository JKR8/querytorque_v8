{
  "query_num": 21,
  "status": "success",
  "original_sql": "-- start query 21 in stream 0 using template query21.tpl\nselect *\n from(select w_warehouse_name\n            ,i_item_id\n            ,sum(case when (cast(d_date as date) < cast ('2002-02-27' as date))\n\t                then inv_quantity_on_hand \n                      else 0 end) as inv_before\n            ,sum(case when (cast(d_date as date) >= cast ('2002-02-27' as date))\n                      then inv_quantity_on_hand \n                      else 0 end) as inv_after\n   from inventory\n       ,warehouse\n       ,item\n       ,date_dim\n   where i_current_price between 0.99 and 1.49\n     and i_item_sk          = inv_item_sk\n     and inv_warehouse_sk   = w_warehouse_sk\n     and inv_date_sk    = d_date_sk\n     and d_date between (cast ('2002-02-27' as date) - INTERVAL 30 DAY)\n                    and (cast ('2002-02-27' as date) + INTERVAL 30 DAY)\n   group by w_warehouse_name, i_item_id) x\n where (case when inv_before > 0 \n             then inv_after / inv_before \n             else null\n             end) between 2.0/3.0 and 3.0/2.0\n order by w_warehouse_name\n         ,i_item_id\n LIMIT 100;\n\n-- end query 21 in stream 0 using template query21.tpl\n",
  "optimized_sql": "WITH filtered_items AS (SELECT i_item_sk, i_item_id FROM item WHERE i_current_price BETWEEN 0.99 AND 1.49), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-27' AS DATE) - INTERVAL '30' DAY) AND (CAST('2002-02-27' AS DATE) + INTERVAL '30' DAY)), filtered_inventory AS (SELECT w.w_warehouse_name, i.i_item_id, d.d_date, inv.inv_quantity_on_hand FROM inventory AS inv JOIN filtered_items AS i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse AS w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN filtered_dates AS d ON inv.inv_date_sk = d.d_date_sk)\nSELECT w_warehouse_name, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-27' AS DATE)) THEN inv_quantity_on_hand ELSE 0 END) AS inv_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-27' AS DATE)) THEN inv_quantity_on_hand ELSE 0 END) AS inv_after FROM filtered_inventory GROUP BY w_warehouse_name, i_item_id HAVING (CASE WHEN inv_before > 0 THEN inv_after / inv_before ELSE NULL END) BETWEEN 2.0 / 3.0 AND 3.0 / 2.0 ORDER BY w_warehouse_name, i_item_id LIMIT 100",
  "raw_response": "```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_items\": \"SELECT i_item_sk, i_item_id FROM item WHERE i_current_price BETWEEN 0.99 AND 1.49\",\n        \"filtered_dates\": \"SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-27' AS DATE) - INTERVAL '30' DAY) AND (CAST('2002-02-27' AS DATE) + INTERVAL '30' DAY)\",\n        \"filtered_inventory\": \"SELECT w.w_warehouse_name, i.i_item_id, d.d_date, inv.inv_quantity_on_hand FROM inventory inv JOIN filtered_items i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN filtered_dates d ON inv.inv_date_sk = d.d_date_sk\",\n        \"main_query\": \"SELECT w_warehouse_name, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-27' AS DATE)) THEN inv_quantity_on_hand ELSE 0 END) AS inv_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-27' AS DATE)) THEN inv_quantity_on_hand ELSE 0 END) AS inv_after FROM filtered_inventory GROUP BY w_warehouse_name, i_item_id HAVING (CASE WHEN inv_before > 0 THEN inv_after / inv_before ELSE NULL END) BETWEEN 2.0 / 3.0 AND 3.0 / 2.0 ORDER BY w_warehouse_name, i_item_id LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"same result rows\",\n        \"same ordering\",\n        \"same column output\",\n        \"inv_before > 0 predicate preserved via HAVING clause\"\n      ],\n      \"expected_speedup\": \"2.10x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early filtering by creating CTEs for filtered_items and filtered_dates to reduce the inventory fact table scan before joining. Projection pruning ensures only necessary columns (i_item_sk, i_item_id, d_date_sk, d_date, w_warehouse_sk, w_warehouse_name) are carried through the pipeline. Converted the outer subquery filter to a HAVING clause to eliminate the derived table wrapper while preserving the ratio filter semantics.\"\n}\n```",
  "error": null,
  "latency_ms": 177722.4541579999,
  "tokens_in": 1618,
  "tokens_out": 7548
}