{
  "query_num": 12,
  "status": "success",
  "original_sql": "-- start query 12 in stream 0 using template query12.tpl\nselect i_item_id\n      ,i_item_desc \n      ,i_category \n      ,i_class \n      ,i_current_price\n      ,sum(ws_ext_sales_price) as itemrevenue \n      ,sum(ws_ext_sales_price)*100/sum(sum(ws_ext_sales_price)) over\n          (partition by i_class) as revenueratio\nfrom\t\n\tweb_sales\n    \t,item \n    \t,date_dim\nwhere \n\tws_item_sk = i_item_sk \n  \tand i_category in ('Books', 'Sports', 'Men')\n  \tand ws_sold_date_sk = d_date_sk\n\tand d_date between cast('1998-04-06' as date) \n\t\t\t\tand (cast('1998-04-06' as date) + INTERVAL 30 DAY)\ngroup by \n\ti_item_id\n        ,i_item_desc \n        ,i_category\n        ,i_class\n        ,i_current_price\norder by \n\ti_category\n        ,i_class\n        ,i_item_id\n        ,i_item_desc\n        ,revenueratio\n LIMIT 100;\n\n-- end query 12 in stream 0 using template query12.tpl\n",
  "optimized_sql": "WITH filtered_items AS (SELECT i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price FROM item WHERE i_category IN ('Books', 'Sports', 'Men')), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL '30' DAY)), filtered_sales AS (SELECT ws_item_sk, ws_ext_sales_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk)\nSELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(ws_ext_sales_price) AS itemrevenue, SUM(ws_ext_sales_price) * 100 / SUM(SUM(ws_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio FROM filtered_sales JOIN filtered_items ON ws_item_sk = i_item_sk GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price ORDER BY i_category, i_class, i_item_id, i_item_desc, revenueratio LIMIT 100",
  "raw_response": " ```json\n{\n  \"rewrite_sets\": [\n    {\n      \"id\": \"rs_01\",\n      \"transform\": \"early_filter\",\n      \"nodes\": {\n        \"filtered_items\": \"SELECT i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price FROM item WHERE i_category IN ('Books', 'Sports', 'Men')\",\n        \"filtered_dates\": \"SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL '30' DAY)\",\n        \"filtered_sales\": \"SELECT ws_item_sk, ws_ext_sales_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk\",\n        \"main_query\": \"SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(ws_ext_sales_price) AS itemrevenue, SUM(ws_ext_sales_price) * 100 / SUM(SUM(ws_ext_sales_price)) OVER (PARTITION BY i_class) AS revenueratio FROM filtered_sales JOIN filtered_items ON ws_item_sk = i_item_sk GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price ORDER BY i_category, i_class, i_item_id, i_item_desc, revenueratio LIMIT 100\"\n      },\n      \"invariants_kept\": [\n        \"output columns unchanged\",\n        \"grain preserved\",\n        \"required predicates maintained\",\n        \"same result set\"\n      ],\n      \"expected_speedup\": \"2.5x\",\n      \"risk\": \"low\"\n    }\n  ],\n  \"explanation\": \"Applied early_filter to push the i_category predicate down to the item table and the date range predicate down to the date_dim table before joining. This reduces the cardinality of the joins significantly by filtering base tables early. Also pruned unnecessary columns in intermediate CTEs (projection_prune) to minimize memory usage during query execution.\"\n}\n```",
  "error": null,
  "latency_ms": 327597.9825749964,
  "tokens_in": 1605,
  "tokens_out": 4433
}