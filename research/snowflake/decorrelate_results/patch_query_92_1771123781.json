{
  "query_id": "query_92",
  "mode": "patch",
  "model": "qwen/qwen3-coder",
  "elapsed_s": 2.63,
  "prompt_chars": 7349,
  "response": "{\n  \"plan_id\": \"W1_S0\",\n  \"dialect\": \"snowflake\",\n  \"steps\": [\n    {\n      \"step_id\": \"s1\",\n      \"op\": \"insert_cte\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"cte_name\": \"common_scan\",\n        \"cte_query_sql\": \"SELECT ws_item_sk, ws_ext_discount_amt FROM web_sales INNER JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '2002-02-26' AND (CAST('2002-02-26' AS DATE) + INTERVAL '90 DAY')\"\n      },\n      \"description\": \"Shared scan CTE: date-filtered web_sales\"\n    },\n    {\n      \"step_id\": \"s2\",\n      \"op\": \"insert_cte\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"cte_name\": \"threshold_computation\",\n        \"cte_query_sql\": \"SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM common_scan GROUP BY ws_item_sk\"\n      },\n      \"description\": \"Per-item threshold from shared scan\"\n    },\n    {\n      \"step_id\": \"s3\",\n      \"op\": \"replace_body\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"sql_fragment\": \"SELECT SUM(cs.ws_ext_discount_amt) AS \\\"Excess Discount Amount\\\" FROM common_scan cs INNER JOIN item ON i_item_sk = cs.ws_item_sk INNER JOIN threshold_computation t ON cs.ws_item_sk = t.ws_item_sk WHERE i_manufact_id = 320 AND cs.ws_ext_discount_amt > t.threshold ORDER BY SUM(cs.ws_ext_discount_amt) LIMIT 100\"\n      },\n      \"description\": \"Replace main query: JOIN threshold CTE instead of correlated subquery\"\n    }\n  ]\n}",
  "original_sql": "-- start query 92 in stream 0 using template query92.tpl\nselect \n   sum(ws_ext_discount_amt)  as \"Excess Discount Amount\" \nfrom \n    web_sales \n   ,item \n   ,date_dim\nwhere\ni_manufact_id = 320\nand i_item_sk = ws_item_sk \nand d_date between '2002-02-26' and \n        (cast('2002-02-26' as date) + INTERVAL '90 DAY')\nand d_date_sk = ws_sold_date_sk \nand ws_ext_discount_amt  \n     > ( \n         SELECT \n            1.3 * avg(ws_ext_discount_amt) \n         FROM \n            web_sales \n           ,date_dim\n         WHERE \n              ws_item_sk = i_item_sk \n          and d_date between '2002-02-26' and\n                             (cast('2002-02-26' as date) + INTERVAL '90 DAY')\n          and d_date_sk = ws_sold_date_sk \n      ) \norder by sum(ws_ext_discount_amt)\n LIMIT 100;\n\n-- end query 92 in stream 0 using template query92.tpl\n",
  "ir_node_map": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: web_sales, item, date_dim\n    WHERE [d19a1964890bdea2]: i_manufact_id = 320 AND i_item_sk = ws_item_sk AND d_date BETWEEN '2002-02-26' AND (CAST('2002-02...\n    ORDER BY: SUM(ws_ext_discount_amt)\nS1 [OTHER_DDL]\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "usage": "CompletionUsage(completion_tokens=430, prompt_tokens=2175, total_tokens=2605, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=None), prompt_tokens_details=PromptTokensDetails(audio_tokens=0, cached_tokens=64), cost=0.000895828, is_byok=False, cost_details={'upstream_inference_cost': 0.000895828, 'upstream_inference_prompt_cost': 0.000465828, 'upstream_inference_completions_cost': 0.00043})"
}