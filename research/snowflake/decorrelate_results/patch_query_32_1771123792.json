{
  "query_id": "query_32",
  "mode": "patch",
  "model": "qwen/qwen3-coder",
  "elapsed_s": 3.94,
  "prompt_chars": 7281,
  "response": "{\n  \"plan_id\": \"W1_query_32\",\n  \"dialect\": \"snowflake\",\n  \"steps\": [\n    {\n      \"step_id\": \"s1\",\n      \"op\": \"insert_cte\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"cte_name\": \"common_scan\",\n        \"cte_query_sql\": \"SELECT cs_item_sk, cs_ext_discount_amt FROM catalog_sales INNER JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE d_date BETWEEN '1999-01-07' AND (CAST('1999-01-07' AS DATE) + INTERVAL '90 DAY')\"\n      },\n      \"description\": \"Shared scan CTE: date-filtered catalog_sales\"\n    },\n    {\n      \"step_id\": \"s2\",\n      \"op\": \"insert_cte\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"cte_name\": \"threshold_computation\",\n        \"cte_query_sql\": \"SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM common_scan GROUP BY cs_item_sk\"\n      },\n      \"description\": \"Per-item threshold from shared scan\"\n    },\n    {\n      \"step_id\": \"s3\",\n      \"op\": \"replace_body\",\n      \"target\": {\n        \"by_node_id\": \"S0\"\n      },\n      \"payload\": {\n        \"sql_fragment\": \"SELECT SUM(cs.cs_ext_discount_amt) AS \\\"excess discount amount\\\" FROM common_scan cs INNER JOIN item ON i_item_sk = cs.cs_item_sk INNER JOIN threshold_computation t ON cs.cs_item_sk = t.cs_item_sk WHERE i_manufact_id = 29 AND cs.cs_ext_discount_amt > t.threshold LIMIT 100\"\n      },\n      \"description\": \"Replace main query: JOIN threshold CTE instead of correlated subquery\"\n    }\n  ]\n}",
  "original_sql": "-- start query 32 in stream 0 using template query32.tpl\nselect sum(cs_ext_discount_amt)  as \"excess discount amount\" \nfrom \n   catalog_sales \n   ,item \n   ,date_dim\nwhere\ni_manufact_id = 29\nand i_item_sk = cs_item_sk \nand d_date between '1999-01-07' and \n        (cast('1999-01-07' as date) + INTERVAL '90 DAY')\nand d_date_sk = cs_sold_date_sk \nand cs_ext_discount_amt  \n     > ( \n         select \n            1.3 * avg(cs_ext_discount_amt) \n         from \n            catalog_sales \n           ,date_dim\n         where \n              cs_item_sk = i_item_sk \n          and d_date between '1999-01-07' and\n                             (cast('1999-01-07' as date) + INTERVAL '90 DAY')\n          and d_date_sk = cs_sold_date_sk \n      )\n LIMIT 100;\n\n-- end query 32 in stream 0 using template query32.tpl\n",
  "ir_node_map": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: catalog_sales, item, date_dim\n    WHERE [77af5e19c2f97066]: i_manufact_id = 29 AND i_item_sk = cs_item_sk AND d_date BETWEEN '1999-01-07' AND (CAST('1999-01-...\nS1 [OTHER_DDL]\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "usage": "CompletionUsage(completion_tokens=422, prompt_tokens=2154, total_tokens=2576, completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=None, audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=None), prompt_tokens_details=PromptTokensDetails(audio_tokens=0, cached_tokens=1728), cost=0.000553736, is_byok=False, cost_details={'upstream_inference_cost': 0.000553736, 'upstream_inference_prompt_cost': 0.000131736, 'upstream_inference_completions_cost': 0.000422})"
}