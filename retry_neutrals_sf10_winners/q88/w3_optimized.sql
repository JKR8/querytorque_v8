WITH filtered_store AS (SELECT s_store_sk, s_store_name FROM store WHERE s_store_name = 'ese'), filtered_time_windows AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 'h8_30_to_9' WHEN t_hour = 9 AND t_minute < 30 THEN 'h9_to_9_30' WHEN t_hour = 9 AND t_minute >= 30 THEN 'h9_30_to_10' WHEN t_hour = 10 AND t_minute < 30 THEN 'h10_to_10_30' WHEN t_hour = 10 AND t_minute >= 30 THEN 'h10_30_to_11' WHEN t_hour = 11 AND t_minute < 30 THEN 'h11_to_11_30' WHEN t_hour = 11 AND t_minute >= 30 THEN 'h11_30_to_12' WHEN t_hour = 12 AND t_minute < 30 THEN 'h12_to_12_30' ELSE 'other' END AS time_window FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), filtered_hh_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE ((hd_dep_count = 4 AND hd_vehicle_count <= 6) OR (hd_dep_count = 2 AND hd_vehicle_count <= 4) OR (hd_dep_count = 0 AND hd_vehicle_count <= 2)))
SELECT s1.h8_30_to_9, s2.h9_to_9_30, s3.h9_30_to_10, s4.h10_to_10_30, s5.h10_30_to_11, s6.h11_to_11_30, s7.h11_30_to_12, s8.h12_to_12_30 FROM (SELECT COUNT(*) AS h8_30_to_9 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h8_30_to_9') AS s1, (SELECT COUNT(*) AS h9_to_9_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h9_to_9_30') AS s2, (SELECT COUNT(*) AS h9_30_to_10 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h9_30_to_10') AS s3, (SELECT COUNT(*) AS h10_to_10_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h10_to_10_30') AS s4, (SELECT COUNT(*) AS h10_30_to_11 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h10_30_to_11') AS s5, (SELECT COUNT(*) AS h11_to_11_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h11_to_11_30') AS s6, (SELECT COUNT(*) AS h11_30_to_12 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h11_30_to_12') AS s7, (SELECT COUNT(*) AS h12_to_12_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_time_windows ON ss_sold_time_sk = t_time_sk JOIN filtered_hh_demographics ON ss_hdemo_sk = hd_demo_sk WHERE time_window = 'h12_to_12_30') AS s8