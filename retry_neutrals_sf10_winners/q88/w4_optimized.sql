WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), filtered_hh AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = 4 AND hd_vehicle_count <= 6) OR (hd_dep_count = 2 AND hd_vehicle_count <= 4) OR (hd_dep_count = 0 AND hd_vehicle_count <= 2)), time_slots AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_slot FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9) OR (t_hour = 10) OR (t_hour = 11) OR (t_hour = 12 AND t_minute < 30)), qualified_sales AS (SELECT ss.sales_price, ts.time_slot FROM (SELECT ss_sold_time_sk, ss_hdemo_sk, ss_store_sk, 1 AS sales_price FROM store_sales) AS ss JOIN time_slots AS ts ON ss.ss_sold_time_sk = ts.t_time_sk JOIN filtered_hh AS hh ON ss.ss_hdemo_sk = hh.hd_demo_sk JOIN filtered_store AS s ON ss.ss_store_sk = s.s_store_sk WHERE NOT ts.time_slot IS NULL)
SELECT SUM(CASE WHEN time_slot = 1 THEN sales_price END) AS h8_30_to_9, SUM(CASE WHEN time_slot = 2 THEN sales_price END) AS h9_to_9_30, SUM(CASE WHEN time_slot = 3 THEN sales_price END) AS h9_30_to_10, SUM(CASE WHEN time_slot = 4 THEN sales_price END) AS h10_to_10_30, SUM(CASE WHEN time_slot = 5 THEN sales_price END) AS h10_30_to_11, SUM(CASE WHEN time_slot = 6 THEN sales_price END) AS h11_to_11_30, SUM(CASE WHEN time_slot = 7 THEN sales_price END) AS h11_30_to_12, SUM(CASE WHEN time_slot = 8 THEN sales_price END) AS h12_to_12_30 FROM qualified_sales