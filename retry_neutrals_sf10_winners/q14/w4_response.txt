```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "dates_main": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 11",
        "dates_3years": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 2001",
        "avg_sales": "SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales JOIN dates_3years ON ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales JOIN dates_3years ON cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales JOIN dates_3years ON ws_sold_date_sk = d_date_sk) AS sq2"
      },
      "invariants_kept": [
        "same average_sales value",
        "same date filters applied"
      ],
      "expected_speedup": "1.5x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "intersect_to_exists",
      "nodes": {
        "cross_items": "SELECT i_item_sk AS ss_item_sk FROM item i WHERE EXISTS (SELECT 1 FROM store_sales, item iss, dates_3years d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND iss.i_brand_id = i.i_brand_id AND iss.i_class_id = i.i_class_id AND iss.i_category_id = i.i_category_id) AND EXISTS (SELECT 1 FROM catalog_sales, item ics, dates_3years d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND ics.i_brand_id = i.i_brand_id AND ics.i_class_id = i.i_class_id AND ics.i_category_id = i.i_category_id) AND EXISTS (SELECT 1 FROM web_sales, item iws, dates_3years d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND iws.i_brand_id = i.i_brand_id AND iws.i_class_id = i.i_class_id AND iws.i_category_id = i.i_category_id)"
      },
      "invariants_kept": [
        "same ss_item_sk output",
        "same intersection logic",
        "same date filters"
      ],
      "expected_speedup": "1.8x",
      "risk": "low"
    },
    {
      "id": "rs_03",
      "transform": "materialize_cte",
      "nodes": {
        "avg_sales_materialized": "SELECT average_sales FROM avg_sales",
        "cross_items_materialized": "SELECT ss_item_sk FROM cross_items"
      },
      "invariants_kept": [
        "same scalar value for average_sales",
        "same item set for cross_items"
      ],
      "expected_speedup": "1.2x",
      "risk": "low"
    },
    {
      "id": "rs_04",
      "transform": "pushdown",
      "nodes": {
        "main_query": "SELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales) AS sum_sales, SUM(number_sales) AS sum_number_sales FROM (SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales, item, dates_main WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items_materialized) AND ss_item_sk = i_item_sk AND ss_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales_materialized) UNION ALL SELECT 'catalog' AS channel, i_brand_id, i_class_id, i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales, item, dates_main WHERE cs_item_sk IN (SELECT ss_item_sk FROM cross_items_materialized) AND cs_item_sk = i_item_sk AND cs_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales_materialized) UNION ALL SELECT 'web' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales, item, dates_main WHERE ws_item_sk IN (SELECT ss_item_sk FROM cross_items_materialized) AND ws_item_sk = i_item_sk AND ws_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales_materialized)) AS y GROUP BY ROLLUP (channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel NULLS FIRST, i_brand_id NULLS FIRST, i_class_id NULLS FIRST, i_category_id NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same output columns",
        "same aggregation results",
        "same HAVING filter logic",
        "same ROLLUP grouping"
      ],
      "expected_speedup": "3.0x",
      "risk": "low"
    }
  ],
  "explanation": "1. Created date CTEs to isolate date_dim scans (dates_main for 2001-11, dates_3years for 1999-2001 range).\n2. Converted INTERSECT in cross_items to EXISTS for better join optimization.\n3. Materialized avg_sales and cross_items CTEs to compute once and reuse.\n4. Pushed date CTEs and materialized CTEs into main query to eliminate repeated date_dim scans and redundant subquery executions.\nCollectively reduces 9 date_dim scans to 2 (dates_main + dates_3years), converts expensive INTERSECT to efficient EXISTS, and avoids recomputing scalar aggregates per channel."
}
```