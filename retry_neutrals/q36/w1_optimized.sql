WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state = 'TN'), filtered_sales AS (SELECT ss_net_profit, ss_ext_sales_price, ss_item_sk, ss_store_sk FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk), results AS (SELECT SUM(fs.ss_net_profit) AS ss_net_profit, SUM(fs.ss_ext_sales_price) AS ss_ext_sales_price, (SUM(fs.ss_net_profit) * 1.0000) / SUM(fs.ss_ext_sales_price) AS gross_margin, i.i_category, i.i_class, 0 AS g_category, 0 AS g_class FROM filtered_sales AS fs JOIN filtered_store AS s ON fs.ss_store_sk = s.s_store_sk JOIN item AS i ON fs.ss_item_sk = i.i_item_sk GROUP BY i.i_category, i.i_class), results_rollup AS (SELECT gross_margin, i_category, i_class, 0 AS t_category, 0 AS t_class, 0 AS lochierarchy FROM results UNION ALL SELECT (SUM(ss_net_profit) * 1.0000) / SUM(ss_ext_sales_price) AS gross_margin, i_category, NULL AS i_class, 0 AS t_category, 1 AS t_class, 1 AS lochierarchy FROM results GROUP BY i_category UNION ALL SELECT (SUM(ss_net_profit) * 1.0000) / SUM(ss_ext_sales_price) AS gross_margin, NULL AS i_category, NULL AS i_class, 1 AS t_category, 1 AS t_class, 2 AS lochierarchy FROM results)
SELECT gross_margin, i_category, i_class, lochierarchy, RANK() OVER (PARTITION BY lochierarchy, CASE WHEN t_class = 0 THEN i_category END ORDER BY gross_margin ASC) AS rank_within_parent FROM results_rollup ORDER BY lochierarchy DESC NULLS FIRST, CASE WHEN lochierarchy = 0 THEN i_category END NULLS FIRST, rank_within_parent NULLS FIRST LIMIT 100