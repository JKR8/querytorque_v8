WITH filtered_dates_my_customers AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998), filtered_items AS (SELECT i_item_sk FROM item WHERE i_category = 'Women' AND i_class = 'maternity'), cs_sales_filtered AS (SELECT cs_sold_date_sk, cs_bill_customer_sk FROM catalog_sales JOIN filtered_dates_my_customers ON catalog_sales.cs_sold_date_sk = filtered_dates_my_customers.d_date_sk JOIN filtered_items ON catalog_sales.cs_item_sk = filtered_items.i_item_sk), ws_sales_filtered AS (SELECT ws_sold_date_sk, ws_bill_customer_sk FROM web_sales JOIN filtered_dates_my_customers ON web_sales.ws_sold_date_sk = filtered_dates_my_customers.d_date_sk JOIN filtered_items ON web_sales.ws_item_sk = filtered_items.i_item_sk), cs_or_ws_sales_union AS (SELECT cs_bill_customer_sk AS customer_sk FROM cs_sales_filtered UNION ALL SELECT ws_bill_customer_sk AS customer_sk FROM ws_sales_filtered), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM cs_or_ws_sales_union, customer WHERE c_customer_sk = cs_or_ws_sales_union.customer_sk), base_month_seq AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 12), date_range_dates AS (SELECT d_date_sk FROM date_dim, base_month_seq WHERE d_month_seq BETWEEN base_month_seq.d_month_seq + 1 AND base_month_seq.d_month_seq + 3), filtered_store_sales AS (SELECT ss_customer_sk, ss_ext_sales_price FROM store_sales JOIN date_range_dates ON store_sales.ss_sold_date_sk = date_range_dates.d_date_sk), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, filtered_store_sales, customer_address, store WHERE my_customers.c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND my_customers.c_customer_sk = filtered_store_sales.ss_customer_sk GROUP BY c_customer_sk), segments AS (SELECT CAST(ROUND(revenue / 50) AS INT) AS SEGMENT FROM my_revenue)
SELECT SEGMENT, COUNT(*) AS num_customers, SEGMENT * 50 AS segment_base FROM segments GROUP BY SEGMENT ORDER BY SEGMENT NULLS FIRST, num_customers NULLS FIRST, segment_base LIMIT 100