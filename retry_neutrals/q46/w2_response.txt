```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "hd_filter_or_branch1": "SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count = 4",
        "hd_filter_or_branch2": "SELECT hd_demo_sk FROM household_demographics WHERE hd_vehicle_count = 3",
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_dow IN (6, 0) AND d_year IN (1999, 2000, 2001)",
        "filtered_stores": "SELECT s_store_sk FROM store WHERE s_city IN ('Fairview', 'Midway')",
        "filtered_sales_union": "SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, ca_city AS bought_city, SUM(ss_coupon_amt) AS amt, SUM(ss_net_profit) AS profit FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_stores ON store_sales.ss_store_sk = filtered_stores.s_store_sk JOIN hd_filter_or_branch1 ON store_sales.ss_hdemo_sk = hd_filter_or_branch1.hd_demo_sk JOIN customer_address ON store_sales.ss_addr_sk = customer_address.ca_address_sk GROUP BY ss_ticket_number, ss_customer_sk, ss_addr_sk, ca_city UNION ALL SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, ca_city AS bought_city, SUM(ss_coupon_amt) AS amt, SUM(ss_net_profit) AS profit FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_stores ON store_sales.ss_store_sk = filtered_stores.s_store_sk JOIN hd_filter_or_branch2 ON store_sales.ss_hdemo_sk = hd_filter_or_branch2.hd_demo_sk JOIN customer_address ON store_sales.ss_addr_sk = customer_address.ca_address_sk WHERE NOT EXISTS (SELECT 1 FROM hd_filter_or_branch1 WHERE hd_filter_or_branch1.hd_demo_sk = store_sales.ss_hdemo_sk) GROUP BY ss_ticket_number, ss_customer_sk, ss_addr_sk, ca_city",
        "main_query": "SELECT c_last_name, c_first_name, ca_city, bought_city, ss_ticket_number, amt, profit FROM filtered_sales_union AS dn, customer, customer_address AS current_addr WHERE ss_customer_sk = c_customer_sk AND customer.c_current_addr_sk = current_addr.ca_address_sk AND current_addr.ca_city <> bought_city ORDER BY c_last_name NULLS FIRST, c_first_name NULLS FIRST, ca_city NULLS FIRST, bought_city NULLS FIRST, ss_ticket_number NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same grouping and aggregation"
      ],
      "expected_speedup": "2.5x",
      "risk": "medium"
    }
  ],
  "explanation": "The original query has an OR condition on household_demographics (hd_dep_count=4 OR hd_vehicle_count=3). This prevents efficient index usage and forces sequential scans. By splitting into UNION ALL branches with deduplication (using NOT EXISTS in second branch), each branch can use indexes on the respective columns. Additionally, date_dim and store filters are pre-computed into CTEs to reduce fact table joins early. This pattern matches QT-OPT-001 (OR to UNION ALL) with demonstrated speedups of 2.98x in similar TPC-DS queries."
}
```