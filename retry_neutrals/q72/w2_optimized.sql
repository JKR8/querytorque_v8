WITH d1_dates AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), filtered_inventory AS (SELECT inv_item_sk, inv_warehouse_sk, inv_quantity_on_hand FROM inventory JOIN d1_dates AS d2 ON inv_date_sk = d2.d_date_sk), filtered_catalog_sales AS (SELECT cs_item_sk, cs_order_number, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_quantity, cs_promo_sk FROM catalog_sales JOIN d1_dates AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk WHERE d3.d_date > d1.d_date + 5), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D'), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), joined_facts AS (SELECT cs_item_sk, cs_order_number, cs_quantity, cs_promo_sk, inv_warehouse_sk, inv_quantity_on_hand FROM filtered_catalog_sales AS cs JOIN filtered_inventory AS inv ON cs.cs_item_sk = inv.inv_item_sk AND EXISTS(SELECT 1 FROM d1_dates AS d1, d1_dates AS d2 WHERE cs.cs_sold_date_sk = d1.d_date_sk AND inv.inv_date_sk = d2.d_date_sk AND d1.d_week_seq = d2.d_week_seq) WHERE inv_quantity_on_hand < cs_quantity)
SELECT i.i_item_desc, w.w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM joined_facts AS jf JOIN item AS i ON jf.cs_item_sk = i.i_item_sk JOIN warehouse AS w ON jf.inv_warehouse_sk = w.w_warehouse_sk JOIN d1_dates AS d1 ON jf.cs_sold_date_sk = d1.d_date_sk JOIN filtered_customer_demographics AS cd ON jf.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics AS hd ON jf.cs_bill_hdemo_sk = hd.hd_demo_sk LEFT OUTER JOIN promotion AS p ON jf.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns AS cr ON jf.cs_item_sk = cr.cr_item_sk AND jf.cs_order_number = cr.cr_order_number GROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq LIMIT 100