WITH date_month_2000_2 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy = 2), date_range_years AS (SELECT d_date_sk FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)), filtered_frequent_items AS (SELECT i_item_sk, SUBSTRING(i_item_desc, 1, 30) AS itemdesc, d_date, COUNT(*) AS cnt FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_range_years ON ss_sold_date_sk = d_date_sk GROUP BY i_item_sk, itemdesc, d_date HAVING COUNT(*) > 4), max_csales AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN date_range_years ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk), tpcds_cmax AS (SELECT MAX(csales) AS tpcds_cmax FROM max_csales), best_customers AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (50 / 100.0) * (SELECT tpcds_cmax FROM tpcds_cmax)), catalog_sales_month AS (SELECT cs_bill_customer_sk, cs_item_sk, cs_quantity * cs_list_price AS sales FROM catalog_sales JOIN date_month_2000_2 ON cs_sold_date_sk = d_date_sk), web_sales_month AS (SELECT ws_bill_customer_sk, ws_item_sk, ws_quantity * ws_list_price AS sales FROM web_sales JOIN date_month_2000_2 ON ws_sold_date_sk = d_date_sk), frequent_ss_items AS (SELECT itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, * FROM item) AS sq1 WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year IN (2000, 2000 + 1, 2000 + 2, 2000 + 3) GROUP BY itemdesc, i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (2000, 2000 + 1, 2000 + 2, 2000 + 3) GROUP BY c_customer_sk) AS sq2), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer, max_store_sales WHERE ss_customer_sk = c_customer_sk GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (50 / 100.0) * MAX(tpcds_cmax))
SELECT c_last_name, c_first_name, SUM(sales) AS sales FROM (SELECT c_last_name, c_first_name, sales FROM catalog_sales_month AS cs JOIN customer ON cs.cs_bill_customer_sk = customer.c_customer_sk JOIN filtered_frequent_items AS fi ON cs.cs_item_sk = fi.i_item_sk JOIN best_customers AS bc ON cs.cs_bill_customer_sk = bc.c_customer_sk UNION ALL SELECT c_last_name, c_first_name, sales FROM web_sales_month AS ws JOIN customer ON ws.ws_bill_customer_sk = customer.c_customer_sk JOIN filtered_frequent_items AS fi ON ws.ws_item_sk = fi.i_item_sk JOIN best_customers AS bc ON ws.ws_bill_customer_sk = bc.c_customer_sk) AS sq GROUP BY c_last_name, c_first_name ORDER BY c_last_name NULLS FIRST, c_first_name NULLS FIRST, sales NULLS FIRST LIMIT 100