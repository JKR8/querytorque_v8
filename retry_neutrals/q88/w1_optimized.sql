WITH filtered_hh_demo AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = 4 AND hd_vehicle_count <= 6) UNION ALL SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = 2 AND hd_vehicle_count <= 4) UNION ALL SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = 0 AND hd_vehicle_count <= 2)), filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), time_intervals AS (SELECT 8 AS interval_hour, 30 AS min_minute, 8 AS max_hour, 59 AS max_minute UNION ALL SELECT 9, 0, 9, 29 UNION ALL SELECT 9, 30, 9, 59 UNION ALL SELECT 10, 0, 10, 29 UNION ALL SELECT 10, 30, 10, 59 UNION ALL SELECT 11, 0, 11, 29 UNION ALL SELECT 11, 30, 11, 59 UNION ALL SELECT 12, 0, 12, 29), sales_by_interval AS (SELECT ti.interval_hour, COUNT(*) AS cnt FROM store_sales AS ss JOIN time_dim AS td ON ss.ss_sold_time_sk = td.t_time_sk JOIN filtered_hh_demo AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN filtered_store AS s ON ss.ss_store_sk = s.s_store_sk JOIN time_intervals AS ti ON td.t_hour = ti.interval_hour WHERE td.t_minute BETWEEN ti.min_minute AND ti.max_minute GROUP BY ti.interval_hour)
SELECT s1.cnt AS h8_30_to_9, s2.cnt AS h9_to_9_30, s3.cnt AS h9_30_to_10, s4.cnt AS h10_to_10_30, s5.cnt AS h10_30_to_11, s6.cnt AS h11_to_11_30, s7.cnt AS h11_30_to_12, s8.cnt AS h12_to_12_30 FROM sales_by_interval AS s1, sales_by_interval AS s2, sales_by_interval AS s3, sales_by_interval AS s4, sales_by_interval AS s5, sales_by_interval AS s6, sales_by_interval AS s7, sales_by_interval AS s8 WHERE s1.interval_hour = 8 AND s2.interval_hour = 9 AND s3.interval_hour = 9 AND s4.interval_hour = 10 AND s5.interval_hour = 10 AND s6.interval_hour = 11 AND s7.interval_hour = 11 AND s8.interval_hour = 12 AND s2.cnt = s3.cnt AND s4.cnt = s5.cnt AND s6.cnt = s7.cnt