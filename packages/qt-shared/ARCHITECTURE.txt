┌─────────────────────────────────────────────────────────────────────────────────┐
│                           qt-shared Architecture                                │
│                    Shared Python Infrastructure Package                         │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────┐
                              │    qt-shared     │
                              │  (Core Library)  │
                              └────────┬─────────┘
                                       │
       ┌───────────┬───────────────────┼───────────────────┬───────────┐
       │           │                   │                   │           │
       ▼           ▼                   ▼                   ▼           ▼
┌───────────┐ ┌───────────┐    ┌───────────┐    ┌───────────┐  ┌───────────┐
│   config  │ │    llm    │    │   auth    │    │  billing  │  │ database  │
└─────┬─────┘ └─────┬─────┘    └─────┬─────┘    └─────┬─────┘  └─────┬─────┘
      │             │                │                │              │
      ▼             │                │                │              ▼
┌───────────┐       │                │                │       ┌───────────┐
│ Settings  │       │                │                │       │  models   │
│ (pydantic)│       │                │                │       │connection │
│           │       │                │                │       │migrations │
│ - DB URL  │       │                │                │       └───────────┘
│ - Auth0   │       │                │                │
│ - Stripe  │       │                │                │
│ - LLM keys│       │                │                │
└───────────┘       │                │                │
                    │                │                │
                    ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                           LLM FACTORY                                     │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ create_llm_client(provider, model, api_key) -> LLMClient           │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                  │                                        │
│           ┌────────────┬────────┼────────┬────────────┬────────────┐     │
│           ▼            ▼        ▼        ▼            ▼            ▼     │
│    ┌──────────┐ ┌──────────┐ ┌──────┐ ┌──────┐ ┌──────────┐ ┌─────────┐ │
│    │Anthropic │ │ DeepSeek │ │Gemini│ │ Groq │ │  OpenAI  │ │Gemini   │ │
│    │ Client   │ │  Client  │ │ API  │ │Client│ │  Client  │ │  CLI    │ │
│    │          │ │          │ │Client│ │      │ │          │ │         │ │
│    │ claude-  │ │deepseek- │ │gemini│ │llama-│ │  gpt-4o  │ │(local)  │ │
│    │ sonnet-4 │ │ reasoner │ │3-flas│ │ 3.3  │ │          │ │         │ │
│    └──────────┘ └──────────┘ └──────┘ └──────┘ └──────────┘ └─────────┘ │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                           AUTH MODULE                                     │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                         Auth0 Integration                          │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│    │ middleware  │ ──►  │   context   │ ──►  │   service   │            │
│    │             │      │             │      │             │            │
│    │ JWT verify  │      │ UserContext │      │ User CRUD   │            │
│    │ API protect │      │ Org data    │      │ Permissions │            │
│    └─────────────┘      └─────────────┘      └─────────────┘            │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                          BILLING MODULE                                   │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                       Stripe Integration                           │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│    ┌─────────────┐      ┌─────────────┐                                  │
│    │   tiers     │      │   service   │                                  │
│    │             │      │             │                                  │
│    │ Free        │      │ Subscription│                                  │
│    │ Pro         │      │ management  │                                  │
│    │ Enterprise  │      │ Webhooks    │                                  │
│    │             │      │ Usage track │                                  │
│    └─────────────┘      └─────────────┘                                  │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                         DATABASE MODULE                                   │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │                    SQLAlchemy + PostgreSQL                         │  │
│  └────────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │
│    │   models    │      │ connection  │      │  (alembic)  │            │
│    │             │      │             │      │             │            │
│    │ User        │      │ Engine pool │      │ Migrations  │            │
│    │ Organization│      │ Session mgr │      │ (root pkg)  │            │
│    │ Subscription│      │ Health check│      │             │            │
│    └─────────────┘      └─────────────┘      └─────────────┘            │
└──────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DEPENDENCY GRAPH                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  qt-shared   │
                              │ (standalone) │
                              └──────┬───────┘
                                     │
                    ┌───────────────────────┐
                    │                       │
                    ▼                       ▼
             ┌──────────┐            ┌──────────┐
             │  qt-sql  │            │  qt-dax  │
             │          │            │          │
             └──────────┘            └──────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           USAGE EXAMPLES                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Create LLM client
  from qt_shared.llm import create_llm_client
  client = create_llm_client(provider="groq")
  response = client.analyze("Optimize this SQL...")

  # Access settings
  from qt_shared.config import get_settings
  settings = get_settings()
  db_url = settings.database_url

  # Database session
  from qt_shared.database import get_session
  with get_session() as session:
      user = session.query(User).filter_by(email=email).first()

  # Auth middleware (FastAPI)
  from qt_shared.auth import require_auth
  @app.get("/protected")
  @require_auth
  async def protected_route(user: UserContext = Depends(get_current_user)):
      ...


┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ENVIRONMENT VARIABLES                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Database
  QT_DATABASE_URL=postgresql://user:pass@localhost:5432/querytorque

  # Auth0
  QT_AUTH0_DOMAIN=your-tenant.auth0.com
  QT_AUTH0_API_AUDIENCE=https://api.querytorque.com
  QT_AUTH0_CLIENT_ID=xxx

  # Stripe
  QT_STRIPE_API_KEY=sk_xxx
  QT_STRIPE_WEBHOOK_SECRET=whsec_xxx

  # LLM (choose one or more)
  QT_LLM_PROVIDER=groq
  QT_ANTHROPIC_API_KEY=xxx
  QT_DEEPSEEK_API_KEY=xxx
  QT_GEMINI_API_KEY=xxx
  QT_GROQ_API_KEY=xxx
  QT_OPENAI_API_KEY=xxx
