WITH sales_stats AS (SELECT COUNT(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 END) AS cnt1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_ext_sales_price END) AS avg_price1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_net_profit END) AS avg_profit1, COUNT(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN 1 END) AS cnt2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_ext_sales_price END) AS avg_price2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_net_profit END) AS avg_profit2, COUNT(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN 1 END) AS cnt3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_ext_sales_price END) AS avg_price3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_net_profit END) AS avg_profit3, COUNT(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN 1 END) AS cnt4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_ext_sales_price END) AS avg_price4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_net_profit END) AS avg_profit4, COUNT(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN 1 END) AS cnt5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_ext_sales_price END) AS avg_price5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_net_profit END) AS avg_profit5 FROM store_sales)
SELECT CASE WHEN s.cnt1 > 2972190 THEN s.avg_price1 ELSE s.avg_profit1 END AS bucket1, CASE WHEN s.cnt2 > 4505785 THEN s.avg_price2 ELSE s.avg_profit2 END AS bucket2, CASE WHEN s.cnt3 > 1575726 THEN s.avg_price3 ELSE s.avg_profit3 END AS bucket3, CASE WHEN s.cnt4 > 3188917 THEN s.avg_price4 ELSE s.avg_profit4 END AS bucket4, CASE WHEN s.cnt5 > 3525216 THEN s.avg_price5 ELSE s.avg_profit5 END AS bucket5 FROM reason AS r, sales_stats AS s WHERE r.r_reason_sk = 1
