```sql
WITH filtered_dates AS (
  SELECT d_date_sk
  FROM date_dim
  WHERE d_year = 2002
),
filtered_stores AS (
  SELECT s_store_sk
  FROM store
  WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH')
),
joined_sales AS (
  SELECT
    i.i_category,
    i.i_class,
    ss.ss_net_profit,
    ss.ss_ext_sales_price
  FROM store_sales ss
  JOIN filtered_dates d1 ON ss.ss_sold_date_sk = d1.d_date_sk
  JOIN filtered_stores s ON ss.ss_store_sk = s.s_store_sk
  JOIN item i ON ss.ss_item_sk = i.i_item_sk
),
aggregated AS (
  SELECT
    i_category,
    i_class,
    SUM(ss_net_profit) AS sum_net_profit,
    SUM(ss_ext_sales_price) AS sum_sales_price,
    GROUPING(i_category) + GROUPING(i_class) AS lochierarchy
  FROM joined_sales
  GROUP BY ROLLUP (i_category, i_class)
),
with_margin AS (
  SELECT
    sum_net_profit / sum_sales_price AS gross_margin,
    i_category,
    i_class,
    lochierarchy
  FROM aggregated
)
SELECT
  gross_margin,
  i_category,
  i_class,
  lochierarchy,
  RANK() OVER (
    PARTITION BY lochierarchy,
                 CASE WHEN lochierarchy = 0 THEN i_category END
    ORDER BY gross_margin ASC
  ) AS rank_within_parent
FROM with_margin
ORDER BY
  lochierarchy DESC,
  CASE WHEN lochierarchy = 0 THEN i_category END,
  rank_within_parent
LIMIT 100
```

**Changes**: Pre-filtered date_dim and store into separate CTEs, then joined with store_sales and item in a single CTE. Consolidated ROLLUP aggregation into one CTE before computing gross margin and applying window function.

**Expected speedup**: 2-3x by reducing fact table scans through early dimension filtering and consolidating aggregation passes.