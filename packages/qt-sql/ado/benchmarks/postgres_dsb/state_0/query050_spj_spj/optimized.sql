WITH filtered_d2 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_moy = 12), filtered_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_dow = 1), filtered_store AS (SELECT s_store_sk, s_store_name, s_company_id, s_street_number, s_street_name, s_suite_number, s_city, s_zip, s_state FROM store WHERE s_state IN ('LA', 'TX', 'VA'))
SELECT MIN(s.s_store_name), MIN(s.s_company_id), MIN(s.s_street_number), MIN(s.s_street_name), MIN(s.s_suite_number), MIN(s.s_city), MIN(s.s_zip), MIN(ss.ss_ticket_number), MIN(ss.ss_sold_date_sk), MIN(sr.sr_returned_date_sk), MIN(ss.ss_item_sk), MIN(d1.d_date_sk) FROM store_sales AS ss JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN filtered_store AS s ON ss.ss_store_sk = s.s_store_sk AND sr.sr_store_sk = s.s_store_sk JOIN filtered_d1 AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN filtered_d2 AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk WHERE d1.d_date BETWEEN (d2.d_date - INTERVAL '120 DAY') AND d2.d_date