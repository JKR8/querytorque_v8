WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998), correlated_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('IA', 'PA', 'TX', 'GA', 'MO', 'SD', 'LA', 'TX', 'VA')), web_sales_filtered AS (SELECT ws_item_sk, ws_order_number, ws_quantity, ws_sales_price, ws_net_profit, ws_sold_date_sk, CASE WHEN ws_sales_price BETWEEN 100.00 AND 150.00 THEN 1 WHEN ws_sales_price BETWEEN 50.00 AND 100.00 THEN 2 WHEN ws_sales_price BETWEEN 150.00 AND 200.00 THEN 3 END AS price_group, CASE WHEN ws_net_profit BETWEEN 100 AND 200 THEN 1 WHEN ws_net_profit BETWEEN 150 AND 300 THEN 2 WHEN ws_net_profit BETWEEN 50 AND 250 THEN 3 END AS profit_group FROM web_sales WHERE ((ws_sales_price BETWEEN 100.00 AND 150.00) OR (ws_sales_price BETWEEN 50.00 AND 100.00) OR (ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ws_net_profit BETWEEN 100 AND 200) OR (ws_net_profit BETWEEN 150 AND 300) OR (ws_net_profit BETWEEN 50 AND 250))) SELECT MIN(ws_quantity), MIN(wr_refunded_cash), MIN(wr_fee), MIN(ws_item_sk), MIN(wr_order_number), MIN(cd1.cd_demo_sk), MIN(cd2.cd_demo_sk) FROM web_sales_filtered AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN customer_demographics AS cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk JOIN customer_demographics AS cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk JOIN correlated_customer_address AS ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk JOIN date_filtered AS df ON ws.ws_sold_date_sk = df.d_date_sk JOIN reason AS r ON r.r_reason_sk = wr.wr_reason_sk WHERE ((cd1.cd_marital_status = 'D' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.price_group = 1) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '4 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.price_group = 2) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND ws.price_group = 3)) AND ((ca_state IN ('IA', 'PA', 'TX') AND ws.profit_group = 1) OR (ca_state IN ('GA', 'MO', 'SD') AND ws.profit_group = 2) OR (ca_state IN ('LA', 'TX', 'VA') AND ws.profit_group = 3))