{
  "id": "OR_TO_UNION_GUARD",
  "severity": "HIGH",
  "description": "Guard rails for or_to_union: branches must have different access paths (not same column) and be limited to 3 or fewer.",
  "observed_failures": [
    {
      "query": "Q90",
      "regression": "0.59x (16ms -> 27ms)",
      "original": "WHERE t.t_hour BETWEEN 10 AND 11 OR t.t_hour BETWEEN 16 AND 17",
      "broken_rewrite": "UNION ALL of two separate web_sales scans (one for AM hours, one for PM hours)",
      "problem": "Doubles the fact table scan. The OR on t_hour is trivial for the optimizer - it just checks two ranges on one column.",
      "type": "UNION_SAME_COLUMN_OR"
    },
    {
      "query": "Q13",
      "regression": "0.23x",
      "problem": "9 UNION branches from nested OR expansion (3 conditions x 3 values) caused 9x fact table scans.",
      "type": "UNION_BRANCH_EXPLOSION"
    },
    {
      "query": "Q48",
      "regression": "0.41x",
      "problem": "9 UNION branches from nested OR expansion caused severe regression from multiplied fact table scans.",
      "type": "UNION_BRANCH_EXPLOSION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "OR_TO_UNION_REQUIRES_DIFFERENT_PATHS",
      "description": "or_to_union is only beneficial when OR conditions create fundamentally different access paths (e.g., across different tables or between a correlated subquery and a direct filter). Same-column ORs are handled efficiently by the optimizer as a single scan."
    },
    {
      "rule": "OR_TO_UNION_MAX_3_BRANCHES",
      "description": "Never expand OR conditions into more than 3 UNION ALL branches. Nested ORs (e.g., 3 conditions x 3 values = 9 combinations) must not be expanded — keep the original OR structure."
    }
  ],
  "prompt_instruction": "Only apply or_to_union when (a) the OR branches involve different tables or fundamentally different access paths — never when all branches filter the same column (e.g., t_hour ranges), since the optimizer already handles same-column ORs efficiently in a single scan — and (b) the result is 3 or fewer UNION ALL branches. Nested ORs that would expand into 4+ branches (e.g., 3 conditions x 3 values = 9 combinations) must be left as-is. Violating these rules causes 0.23x–0.59x regressions from multiplied fact table scans."
}
