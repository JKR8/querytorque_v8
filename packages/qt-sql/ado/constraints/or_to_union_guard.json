{
  "id": "OR_TO_UNION_GUARD",
  "severity": "HIGH",
  "overridable": true,
  "description": "Guard rails for or_to_union: branches should have different access paths (not same column) and be limited to 3 or fewer.",
  "observed_failures": [
    {
      "query": "Q90",
      "regression": "0.59x (16ms -> 27ms)",
      "original": "WHERE t.t_hour BETWEEN 10 AND 11 OR t.t_hour BETWEEN 16 AND 17",
      "broken_rewrite": "UNION ALL of two separate web_sales scans (one for AM hours, one for PM hours)",
      "problem": "Doubles the fact table scan. The OR on t_hour is trivial for the optimizer - it just checks two ranges on one column.",
      "type": "UNION_SAME_COLUMN_OR"
    },
    {
      "query": "Q13",
      "regression": "0.23x",
      "problem": "9 UNION branches from nested OR expansion (3 conditions x 3 values) caused 9x fact table scans.",
      "type": "UNION_BRANCH_EXPLOSION"
    },
    {
      "query": "Q48",
      "regression": "0.41x",
      "problem": "9 UNION branches from nested OR expansion caused severe regression from multiplied fact table scans.",
      "type": "UNION_BRANCH_EXPLOSION"
    }
  ],
  "observed_successes": [
    {
      "query": "Q88",
      "speedup": "6.28x",
      "context": "8 time-bucket subqueries on store_sales, each filtering distinct hour ranges via different WHERE clauses. Branches access genuinely different row subsets."
    },
    {
      "query": "Q10",
      "speedup": "1.49x",
      "context": "OR across different dimension table lookups creating distinct access paths."
    },
    {
      "query": "Q45",
      "speedup": "1.35x",
      "context": "OR conditions reference different tables/subqueries."
    }
  ],
  "constraint_rules": [
    {
      "rule": "OR_TO_UNION_REQUIRES_DIFFERENT_PATHS",
      "description": "or_to_union is most beneficial when OR conditions create fundamentally different access paths (e.g., across different tables or between a correlated subquery and a direct filter). Same-column ORs on trivial ranges are usually handled efficiently by the optimizer as a single scan."
    },
    {
      "rule": "OR_TO_UNION_PREFER_3_OR_FEWER",
      "description": "Prefer 3 or fewer UNION ALL branches. Nested ORs that expand into 9+ combinations are almost always harmful. 4-5 branches may be acceptable if each accesses genuinely different row subsets."
    }
  ],
  "override_conditions": [
    "Branches access genuinely different row subsets (different WHERE predicates, not just same-column ranges)",
    "Total branch count stays at 4-5 or fewer (not Cartesian expansion of nested ORs)",
    "EXPLAIN shows the fact table is already scanned N times in baseline, so splitting does not increase scan count",
    "Each branch filters to <20% of fact table rows (high selectivity per branch)"
  ],
  "prompt_instruction": "DEFAULT: Prefer 3 or fewer UNION ALL branches with different access paths per branch. Same-column ORs on simple ranges are usually handled efficiently by the optimizer. Nested ORs that expand into 4+ branches (e.g., 3 x 3 = 9 combinations) caused 0.23x-0.41x regressions. HOWEVER: or_to_union achieved 6.28x on Q88 where branches had genuinely different row subsets. The exploration worker MAY try 4-5 branches if each branch has distinct access paths and high selectivity. Provide reasoning."
}
