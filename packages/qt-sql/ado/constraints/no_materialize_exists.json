{
  "id": "NO_MATERIALIZE_EXISTS",
  "severity": "CRITICAL",
  "description": "Never convert EXISTS/NOT EXISTS subqueries into materialized CTEs with full table scans. EXISTS uses semi-join short-circuiting which is far more efficient than materializing the full result set.",
  "failure_rate": "Caused 0.14x and 0.54x regressions (7x and 2x slowdowns)",
  "observed_failures": [
    {
      "query": "Q16",
      "regression": "0.14x (18ms -> 126ms)",
      "original": "EXISTS (SELECT * FROM catalog_sales cs2 WHERE cs1.cs_order_number = cs2.cs_order_number AND cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)",
      "broken_rewrite": "WITH multi_warehouse_orders AS (SELECT DISTINCT cs_order_number FROM catalog_sales GROUP BY cs_order_number HAVING MIN(cs_warehouse_sk) <> MAX(cs_warehouse_sk))",
      "type": "EXISTS_TO_FULL_SCAN_CTE"
    },
    {
      "query": "Q95",
      "regression": "0.54x (390ms -> 728ms)",
      "original": "EXISTS(SELECT 1 FROM ws_wh WHERE ws_wh.ws_order_number = ws1.ws_order_number)",
      "broken_rewrite": "WITH multi_warehouse_orders AS (SELECT DISTINCT ws_order_number FROM ws_wh)",
      "type": "EXISTS_TO_MATERIALIZED_DISTINCT"
    }
  ],
  "constraint_rules": [
    {
      "rule": "KEEP_EXISTS_AS_EXISTS",
      "description": "EXISTS and NOT EXISTS subqueries use semi-join optimization that short-circuits after finding the first match. Converting them to CTEs forces full materialization of the entire subquery result set."
    },
    {
      "rule": "NO_FULL_TABLE_DISTINCT_CTE",
      "description": "Never create a CTE like SELECT DISTINCT key FROM large_table to replace an EXISTS check. The CTE must scan the entire table; EXISTS can stop after one match."
    }
  ],
  "prompt_instruction": "Keep EXISTS and NOT EXISTS as-is â€” they use semi-join short-circuiting that stops scanning after the first match. Converting them to materialized CTEs (e.g., WITH cte AS (SELECT DISTINCT ... FROM large_table)) forces a full table scan, which is catastrophically slower (0.14x observed on Q16). When you see EXISTS, preserve it."
}
