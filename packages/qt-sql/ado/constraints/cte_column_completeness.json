{
  "id": "CTE_COLUMN_COMPLETENESS",
  "severity": "CRITICAL",
  "description": "When creating or modifying a CTE, its SELECT list MUST include ALL columns that downstream nodes reference. Check the Node Contracts and Downstream Usage sections before writing any CTE.",
  "failure_rate": "Caused 54% of all execution errors (7 of 13 failures)",
  "observed_failures": [
    {
      "query": "Q21",
      "error": "prefetched_inventory CTE omits i_item_id but main query references it in SELECT and GROUP BY",
      "type": "MISSING_COLUMN_IN_CTE"
    },
    {
      "query": "Q76",
      "error": "filtered_store_dates CTE omits d_year and d_qoy but aggregation CTE uses them in GROUP BY",
      "type": "MISSING_COLUMN_IN_CTE"
    },
    {
      "query": "Q24",
      "error": "filtered_base CTE omits s_state, i_current_price, i_manager_id, i_units, i_size needed by downstream CTEs",
      "type": "MISSING_COLUMN_IN_CTE"
    },
    {
      "query": "Q64",
      "error": "filtered_store_sales CTE omits ss_sold_date_sk needed for JOIN in cross_sales CTE",
      "type": "MISSING_COLUMN_IN_CTE"
    },
    {
      "query": "Q60",
      "error": "ss/ws/cs CTEs reference item.i_item_sk and item.i_category in WHERE but item table not joined in CTE",
      "type": "MISSING_TABLE_IN_CTE"
    },
    {
      "query": "Q13",
      "error": "filtered_store_sales CTE references hd_demo_sk, cd_demo_sk from tables not joined in the CTE",
      "type": "MISSING_TABLE_IN_CTE"
    },
    {
      "query": "Q2",
      "error": "Ambiguous d_date_sk and d_week_seq columns between CTE and re-joined date_dim",
      "type": "AMBIGUOUS_COLUMN_REF"
    }
  ],
  "constraint_rules": [
    {
      "rule": "CHECK_DOWNSTREAM_REFS",
      "description": "Before writing a CTE, check the Downstream Usage section. Every column listed in downstream_refs for that node MUST appear in the CTE's SELECT list."
    },
    {
      "rule": "CHECK_JOIN_COLUMNS",
      "description": "If a downstream node JOINs on a column from this CTE (e.g., ON cte.d_date_sk = ...), that column MUST be in the CTE's SELECT."
    },
    {
      "rule": "CHECK_TABLE_PRESENCE",
      "description": "If a CTE's WHERE clause references columns from a table, that table MUST be in the CTE's FROM/JOIN clause."
    }
  ],
  "prompt_instruction": "CRITICAL: When creating or modifying a CTE, its SELECT list MUST include ALL columns referenced by downstream queries. Check the Node Contracts section: every column in downstream_refs MUST appear in the CTE output. Also ensure: (1) JOIN columns used by consumers are included in SELECT, (2) every table referenced in WHERE is present in FROM/JOIN, (3) no ambiguous column names between the CTE and re-joined tables. Dropping a column that a downstream node needs will cause an execution error."
}
