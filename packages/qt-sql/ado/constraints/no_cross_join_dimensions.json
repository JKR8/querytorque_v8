{
  "id": "NO_CROSS_JOIN_DIMENSIONS",
  "severity": "CRITICAL",
  "description": "Never CROSS JOIN or Cartesian-join dimension tables into a single CTE. A 30-row date × 200-row item × 20-row promotion = 120K rows, which prevents index use on fact tables and causes 132x regressions (0.0076x observed on Q080).",
  "failure_rate": "Caused 0.0076x regression on Q080 (132x slower)",
  "observed_failures": [
    {
      "query": "Q080_multi",
      "regression": "0.0076x (57ms -> 7500ms)",
      "broken_rewrite": "filtered_dims AS (SELECT d_date_sk, i_item_sk, p_promo_sk FROM date_dim CROSS JOIN item CROSS JOIN promotion WHERE ...)",
      "problem": "CROSS JOIN created 120K-row CTE, then 3-key join prevented index use on fact tables.",
      "type": "CROSS_JOIN_DIMENSION_EXPLOSION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "SEPARATE_DIMENSION_CTES",
      "description": "Each dimension table must be its own CTE with its own filter. Never combine multiple dimension tables into a single CTE via CROSS JOIN, Cartesian product, or JOIN ON TRUE."
    }
  ],
  "prompt_instruction": "NEVER combine multiple dimension tables into a single CTE via CROSS JOIN, Cartesian product, or JOIN ON TRUE. Even small dimensions (30 dates × 200 items × 20 promos = 120K rows) create huge intermediate results that prevent index use on fact tables. Always keep each dimension as a SEPARATE CTE: filtered_date AS (...), filtered_item AS (...), filtered_promotion AS (...). This was validated at 3.32x with separate CTEs vs 0.0076x with a merged CROSS JOIN CTE."
}
