{
  "id": "SINGLE_PASS_AGGREGATION_LIMIT",
  "severity": "HIGH",
  "description": "Limit single-pass aggregation rewrites to at most 8 CASE branches inside aggregate functions. Beyond 8 branches, the CASE evaluation overhead can exceed the benefit of reduced scans.",
  "observed_failures": [
    {
      "query": "Q88",
      "note": "8 CASE branches (time slices) was the maximum that still showed improvement. More branches risk diminishing returns.",
      "type": "CASE_BRANCH_LIMIT"
    }
  ],
  "constraint_rules": [
    {
      "rule": "MAX_8_CASE_BRANCHES",
      "description": "When consolidating repeated scans into CASE WHEN aggregates, limit to 8 or fewer CASE branches per aggregate function. Each branch adds evaluation overhead per row."
    }
  ],
  "prompt_instruction": "When applying single_pass_aggregation (consolidating repeated scans into CASE WHEN aggregates), use at most 8 CASE branches. Beyond 8 branches, the per-row CASE evaluation overhead can negate the benefit of reducing table scans. If the original query has more than 8 distinct filter conditions, keep some scans separate rather than forcing all into one pass."
}
