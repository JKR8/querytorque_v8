{
  "id": "PREFETCH_MULTI_FACT_CHAIN",
  "severity": "HIGH",
  "description": "Do not create more than 2 cascading fact-table CTEs. Each additional CTE in a fact-table chain materializes a large intermediate result, increasing memory pressure and I/O.",
  "observed_failures": [
    {
      "query": "Q4",
      "regression": "0.78x",
      "problem": "3 cascading fact-table CTEs (store_sales -> catalog_sales -> web_sales) created excessive intermediate materialization.",
      "type": "FACT_CHAIN_OVERHEAD"
    }
  ],
  "constraint_rules": [
    {
      "rule": "MAX_2_FACT_CTES_IN_CHAIN",
      "description": "When pre-joining fact tables with filtered dimensions in CTEs, limit to at most 2 cascading fact CTEs. A third CTE that reads from a previous fact CTE creates a materialization chain that often regresses."
    }
  ],
  "prompt_instruction": "When using prefetch_fact_join, do not create more than 2 cascading CTEs that each reference a fact table (store_sales, catalog_sales, web_sales, etc.). Each CTE in the chain materializes a large intermediate result. Observed 0.78x regression on Q4 from 3 cascading fact CTEs."
}
