{
  "id": "TOP_N_PER_GROUP_TO_LATERAL",
  "name": "Top N Per Group to LATERAL",
  "description": "Convert correlated subqueries for 'top N per group' to LATERAL joins with LIMIT, enabling index-only scans per group instead of window functions over entire dataset.",
  "verified_speedup": "10x+",
  "benchmark": "dsb",
  "database": "postgres",
  "example": {
    "opportunity": "TOP_N_PER_GROUP_TO_LATERAL",
    "before_sql": "SELECT c.id, c.name, (SELECT o.order_id FROM orders o WHERE o.customer_id = c.id ORDER BY o.order_date DESC LIMIT 1) AS latest_order FROM customers c;",
    "after_sql": "SELECT c.id, c.name, latest.order_id AS latest_order FROM customers c LEFT JOIN LATERAL (SELECT order_id FROM orders WHERE customer_id = c.id ORDER BY order_date DESC LIMIT 1) latest ON TRUE;",
    "transforms": ["decorrelate", "lateral_join", "top_n_lateral"],
    "key_insight": "With index on (customer_id, order_date DESC), PostgreSQL performs efficient index scan per customer rather than sorting all orders.",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "top_n_lateral",
          "nodes": {
            "main_query": "SELECT c.id, c.name, latest.order_id AS latest_order FROM customers c LEFT JOIN LATERAL (SELECT order_id FROM orders WHERE customer_id = c.id ORDER BY order_date DESC LIMIT 1) latest ON TRUE;"
          },
          "invariants_kept": ["same result rows", "same ordering semantics"],
          "expected_speedup": "10x+",
          "risk": "low"
        }
      ]
    }
  }
}
