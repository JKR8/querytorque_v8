{
  "id": "CORRELATED_AGGREGATE_TO_LATERAL",
  "name": "Correlated Aggregate to LATERAL",
  "description": "Rewrite scalar subqueries with aggregations to LATERAL joins, enabling the optimizer to select optimal join strategies (hash, merge) rather than nested loop.",
  "verified_speedup": "5-20x",
  "benchmark": "dsb",
  "database": "postgres",
  "example": {
    "opportunity": "CORRELATED_AGGREGATE_TO_LATERAL",
    "before_sql": "SELECT c.id, c.name, (SELECT SUM(o.amount) FROM orders o WHERE o.customer_id = c.id) AS total_spent FROM customers c;",
    "after_sql": "SELECT c.id, c.name, agg.total_spent FROM customers c LEFT JOIN LATERAL (SELECT SUM(amount) AS total_spent FROM orders WHERE customer_id = c.id) agg ON TRUE;",
    "transforms": ["decorrelate", "lateral_join"],
    "key_insight": "LATERAL enables the optimizer to select hash/merge join instead of being restricted to nested loop execution for correlated aggregates.",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "decorrelate",
          "nodes": {
            "main_query": "SELECT c.id, c.name, agg.total_spent FROM customers c LEFT JOIN LATERAL (SELECT SUM(amount) AS total_spent FROM orders WHERE customer_id = c.id) agg ON TRUE;"
          },
          "invariants_kept": ["same result rows", "same aggregation"],
          "expected_speedup": "5x+",
          "risk": "low"
        }
      ]
    }
  }
}
