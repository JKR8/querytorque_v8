{
  "id": "CTE_INLINE_NOT_MATERIALIZED",
  "name": "CTE Inline with NOT MATERIALIZED",
  "description": "Force CTE inlining with NOT MATERIALIZED to enable predicate pushdown when CTE is referenced multiple times but benefits from different filters in each reference.",
  "verified_speedup": "2-5x",
  "benchmark": "dsb",
  "database": "postgres",
  "example": {
    "opportunity": "CTE_INLINE_NOT_MATERIALIZED",
    "before_sql": "WITH data AS (SELECT * FROM very_large_table) SELECT * FROM data WHERE category = 'A' UNION ALL SELECT * FROM data WHERE category = 'B';",
    "after_sql": "WITH data AS NOT MATERIALIZED (SELECT * FROM very_large_table) SELECT * FROM data WHERE category = 'A' UNION ALL SELECT * FROM data WHERE category = 'B';",
    "transforms": ["cte_not_materialized", "pushdown"],
    "key_insight": "WITHOUT NOT MATERIALIZED, PostgreSQL scans entire table then filters twice. WITH NOT MATERIALIZED, predicates are pushed down enabling two filtered scans.",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "cte_not_materialized",
          "nodes": {
            "main_query": "WITH data AS NOT MATERIALIZED (SELECT * FROM very_large_table) SELECT * FROM data WHERE category = 'A' UNION ALL SELECT * FROM data WHERE category = 'B';"
          },
          "invariants_kept": ["same result rows", "same output columns"],
          "expected_speedup": "2-5x",
          "risk": "low"
        }
      ]
    }
  }
}
