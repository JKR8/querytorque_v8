{
  "id": "regression_q90_materialize_cte",
  "type": "regression",
  "name": "Q90 regression: materialize_cte (0.59x)",
  "description": "Never convert OR conditions on the SAME column (e.g., range conditions on t_hour) into UNION ALL. The optimizer already handles same-column ORs as a single scan. UNION ALL only helps when branches access fundamentally different tables or columns.",
  "verified_speedup": "0.59x",
  "query_id": "q90",
  "transform_attempted": "materialize_cte",
  "regression_mechanism": "Split a simple OR condition (t_hour BETWEEN 10 AND 11 OR t_hour BETWEEN 16 AND 17) into UNION ALL of two separate web_sales scans. This doubles the fact table scan. DuckDB handles same-column OR ranges efficiently in a single scan \u2014 the UNION ALL adds materialization overhead with zero selectivity benefit.",
  "original_sql": "-- start query 90 in stream 0 using template query90.tpl\nselect cast(amc as decimal(15,4))/cast(pmc as decimal(15,4)) am_pm_ratio\n from ( select count(*) amc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 10 and 10+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) at_tbl,\n      ( select count(*) pmc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 16 and 16+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) pt\n order by am_pm_ratio\n LIMIT 100;\n\n-- end query 90 in stream 0 using template query90.tpl",
  "example": {
    "before_sql": "-- start query 90 in stream 0 using template query90.tpl\nselect cast(amc as decimal(15,4))/cast(pmc as decimal(15,4)) am_pm_ratio\n from ( select count(*) amc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 10 and 10+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) at_tbl,\n      ( select count(*) pmc\n       from web_sales, household_demographics , time_dim, web_page\n       where ws_sold_time_sk = time_dim.t_time_sk\n         and ws_ship_hdemo_sk = household_demographics.hd_demo_sk\n         and ws_web_page_sk = web_page.wp_web_page_sk\n         and time_dim.t_hour between 16 and 16+1\n         and household_demographics.hd_dep_count = 2\n         and web_page.wp_char_count between 5000 and 5200) pt\n order by am_pm_ratio\n LIMIT 100;\n\n-- end query 90 in stream 0 using template query90.tpl",
    "after_sql": "WITH filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count = 2), filtered_web_page AS (SELECT wp_web_page_sk FROM web_page WHERE wp_char_count BETWEEN 5000 AND 5200), filtered_time_am AS (SELECT t_time_sk FROM time_dim WHERE t_hour BETWEEN 10 AND 11), filtered_time_pm AS (SELECT t_time_sk FROM time_dim WHERE t_hour BETWEEN 16 AND 17), filtered_web_data AS (SELECT 1 AS am_flag, NULL AS pm_flag FROM web_sales AS ws JOIN filtered_household_demographics AS hd ON ws.ws_ship_hdemo_sk = hd.hd_demo_sk JOIN filtered_time_am AS t ON ws.ws_sold_time_sk = t.t_time_sk JOIN filtered_web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk UNION ALL SELECT NULL AS am_flag, 1 AS pm_flag FROM web_sales AS ws JOIN filtered_household_demographics AS hd ON ws.ws_ship_hdemo_sk = hd.hd_demo_sk JOIN filtered_time_pm AS t ON ws.ws_sold_time_sk = t.t_time_sk JOIN filtered_web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk), counts AS (SELECT COUNT(am_flag) AS amc, COUNT(pm_flag) AS pmc FROM filtered_web_data)\nSELECT CAST(amc AS DECIMAL(15, 4)) / CAST(pmc AS DECIMAL(15, 4)) AS am_pm_ratio FROM counts ORDER BY am_pm_ratio LIMIT 100",
    "key_insight": "Never convert OR conditions on the SAME column (e.g., range conditions on t_hour) into UNION ALL. The optimizer already handles same-column ORs as a single scan. UNION ALL only helps when branches access fundamentally different tables or columns."
  }
}