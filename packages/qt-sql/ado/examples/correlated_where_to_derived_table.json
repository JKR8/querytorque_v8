{
  "id": "CORRELATED_WHERE_TO_DERIVED_TABLE",
  "name": "Correlated WHERE to Derived Table",
  "description": "Convert correlated subqueries in WHERE clause to derived table joins when PostgreSQL fails to decorrelate automatically. Common for 'above average' type queries.",
  "verified_speedup": "5-20x",
  "benchmark": "dsb",
  "database": "postgres",
  "example": {
    "opportunity": "CORRELATED_WHERE_TO_DERIVED_TABLE",
    "before_sql": "SELECT * FROM employees emp WHERE salary > (SELECT AVG(salary) FROM employees WHERE department = emp.department);",
    "after_sql": "SELECT emp.* FROM employees emp JOIN (SELECT department, AVG(salary) AS avg_salary FROM employees GROUP BY department) dept_avg ON emp.department = dept_avg.department WHERE emp.salary > dept_avg.avg_salary;",
    "transforms": ["decorrelate", "derived_table"],
    "key_insight": "Correlated subqueries execute O(N) times. Derived table with GROUP BY executes once, then hash join provides O(1) lookup.",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "decorrelate",
          "nodes": {
            "main_query": "SELECT emp.* FROM employees emp JOIN (SELECT department, AVG(salary) AS avg_salary FROM employees GROUP BY department) dept_avg ON emp.department = dept_avg.department WHERE emp.salary > dept_avg.avg_salary;"
          },
          "invariants_kept": ["same result rows", "same comparison semantics"],
          "expected_speedup": "5x+",
          "risk": "low"
        }
      ]
    }
  }
}
