┌─────────────────────────────────────────────────────────────────────────────────┐
│                           qt-sql CLI Operations                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  qt-sql CLI  │
                              └──────┬───────┘
                                     │
           ┌─────────────────────────┼─────────────────────────┐
           │                         │                         │
           ▼                         ▼                         ▼
    ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
    │    audit    │          │  optimize   │          │  validate   │
    └──────┬──────┘          └──────┬──────┘          └──────┬──────┘
           │                        │                        │
           ▼                        │                        ▼
    ┌─────────────┐                 │                 ┌─────────────┐
    │ SQLAnti-    │                 │                 │ Compare     │
    │ Pattern     │                 │                 │ Original vs │
    │ Detector    │                 │                 │ Optimized   │
    └──────┬──────┘                 │                 └─────────────┘
           │                        │
           ▼                        │
    ┌─────────────┐                 │
    │ 119 Rules   │                 │
    │ Score 0-100 │                 │
    └─────────────┘                 │
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
             ┌───────────┐                 ┌───────────┐
             │   --dag   │                 │  default  │
             │   MODE    │                 │   MODE    │
             └─────┬─────┘                 └─────┬─────┘
                   │                             │
                   ▼                             ▼
┌──────────────────────────┐           ┌──────────────────────┐
│     DAG PIPELINE         │           │   SIMPLE LLM CALL    │
│  ┌────────────────────┐  │     │     │                      │
│  │ 1. Parse SQL→DAG   │  │     │     │  Build prompt with:  │
│  │    (CTEs, subqs)   │  │     │     │  - SQL query         │
│  └─────────┬──────────┘  │     │     │  - Scan info         │
│            ▼             │     │     │  - Issues found      │
│  ┌────────────────────┐  │     │     │                      │
│  │ 2. JSON v5 LLM     │  │     │     │  Send to LLM →       │
│  │    Node-by-node    │  │     │     │  Extract SQL from    │
│  └─────────┬──────────┘  │     │     │  response            │
│            ▼             │     │     └──────────────────────┘
│  ┌────────────────────┐  │     │
│  │ 3. Validate vs DB  │  │     │
│  │    (row counts)    │  │     │
│  └─────────┬──────────┘  │     │
│            ▼             │     │
│  ┌────────────────────┐  │     │
│  │ 4. Retry if wrong  │  │     │
│  │    (max 2 retries) │  │     │
│  └────────────────────┘  │     │
└────────────┬─────────────┘     │
             │                   │
             │                   │
             ▼                   ▼
      ┌──────────────────────────────┐
      │         OUTPUT               │
      │  ┌────────────────────────┐  │
      │  │ -o file.sql → Save     │  │
      │  │ (no -o)    → Display   │  │
      │  └────────────────────────┘  │
      └──────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

   query.sql ──┬──► SQLAntiPatternDetector ──► Issues + Score
               │
               ├──► DuckDB EXPLAIN ──► Execution Plan
               │
               └──► DuckDB Execute ──► Row Counts (for validation)

   ┌─────────────────────────────────────────────────────────────────┐
   │                    VALIDATION LOOP                              │
   │                                                                 │
   │   Original SQL ──► DuckDB ──► Result Set A                     │
   │                                    │                            │
   │   Optimized SQL ──► DuckDB ──► Result Set B                    │
   │                                    │                            │
   │                              A == B ?                           │
   │                              ├─ YES → Valid optimization        │
   │                              └─ NO  → Retry with feedback       │
   └─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           COMMAND EXAMPLES                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Static analysis only
  qt-sql audit query.sql

  # DAG mode (recommended)
  qt-sql optimize query.sql -d db.duckdb --dag

  # Simple LLM (legacy, no validation)
  qt-sql optimize query.sql --provider deepseek

  # Save output
  qt-sql optimize query.sql -d db.duckdb --dag -o optimized.sql
