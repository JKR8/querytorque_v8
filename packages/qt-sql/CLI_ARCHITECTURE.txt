┌─────────────────────────────────────────────────────────────────────────────────┐
│                           qt-sql CLI Operations                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  qt-sql CLI  │
                              └──────┬───────┘
                                     │
           ┌─────────────────────────┼─────────────────────────┐
           │                         │                         │
           ▼                         ▼                         ▼
    ┌─────────────┐          ┌─────────────┐          ┌─────────────┐
    │    audit    │          │  optimize   │          │  validate   │
    └──────┬──────┘          └──────┬──────┘          └──────┬──────┘
           │                        │                        │
           ▼                        │                        ▼
    ┌─────────────┐                 │                 ┌─────────────┐
    │ SQLAnti-    │                 │                 │ Compare     │
    │ Pattern     │                 │                 │ Original vs │
    │ Detector    │                 │                 │ Optimized   │
    └──────┬──────┘                 │                 └─────────────┘
           │                        │
           ▼                        │
    ┌─────────────┐                 │
    │ 119 Rules   │                 │
    │ Score 0-100 │                 │
    └─────────────┘                 │
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
             ┌───────────┐  ┌───────────┐  ┌───────────┐
             │   --dag   │  │  --mcts   │  │  default  │
             │   MODE    │  │   MODE    │  │   MODE    │
             └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
                   │              │              │
                   ▼              │              ▼
┌──────────────────────────┐     │     ┌──────────────────────┐
│     DAG PIPELINE         │     │     │   SIMPLE LLM CALL    │
│  ┌────────────────────┐  │     │     │                      │
│  │ 1. Parse SQL→DAG   │  │     │     │  Build prompt with:  │
│  │    (CTEs, subqs)   │  │     │     │  - SQL query         │
│  └─────────┬──────────┘  │     │     │  - Scan info         │
│            ▼             │     │     │  - Issues found      │
│  ┌────────────────────┐  │     │     │                      │
│  │ 2. DSPy Optimize   │  │     │     │  Send to LLM →       │
│  │    Node-by-node    │  │     │     │  Extract SQL from    │
│  └─────────┬──────────┘  │     │     │  response            │
│            ▼             │     │     └──────────────────────┘
│  ┌────────────────────┐  │     │
│  │ 3. Validate vs DB  │  │     │
│  │    (row counts)    │  │     │
│  └─────────┬──────────┘  │     │
│            ▼             │     │
│  ┌────────────────────┐  │     │
│  │ 4. Retry if wrong  │  │     │
│  │    (max 2 retries) │  │     │
│  └────────────────────┘  │     │
└────────────┬─────────────┘     │
             │                   │
             │ FAIL?             │
             │                   │
     ┌───────┴───────┐           │
     │--mcts-on-     │           │
     │failure?       │           │
     └───────┬───────┘           │
             │ YES               │
             ▼                   ▼
      ┌──────────────────────────────────────────┐
      │            MCTS PIPELINE                  │
      │  ┌────────────────────────────────────┐  │
      │  │ 1. Initialize Tree (root = query)  │  │
      │  └─────────────────┬──────────────────┘  │
      │                    ▼                     │
      │  ┌────────────────────────────────────┐  │
      │  │ 2. UCT Select best node            │  │
      │  └─────────────────┬──────────────────┘  │
      │                    ▼                     │
      │  ┌────────────────────────────────────┐  │
      │  │ 3. Expand: Apply transform via LLM │  │
      │  │    (filter_pushdown, join_reorder, │  │
      │  │     cte_materialize, etc.)         │  │
      │  └─────────────────┬──────────────────┘  │
      │                    ▼                     │
      │  ┌────────────────────────────────────┐  │
      │  │ 4. Validate + Benchmark            │  │
      │  │    (compare row counts + timing)   │  │
      │  └─────────────────┬──────────────────┘  │
      │                    ▼                     │
      │  ┌────────────────────────────────────┐  │
      │  │ 5. Backpropagate reward            │  │
      │  └─────────────────┬──────────────────┘  │
      │                    ▼                     │
      │  ┌────────────────────────────────────┐  │
      │  │ 6. Repeat (max iterations)         │  │
      │  │    --mcts-parallel for parallel    │  │
      │  │    LLM calls                       │  │
      │  └────────────────────────────────────┘  │
      └──────────────────────┬───────────────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Best Speedup   │
                    │  Node Selected  │
                    └────────┬────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │         OUTPUT               │
              │  ┌────────────────────────┐  │
              │  │ -o file.sql → Save     │  │
              │  │ (no -o)    → Display   │  │
              │  └────────────────────────┘  │
              └──────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

   query.sql ──┬──► SQLAntiPatternDetector ──► Issues + Score
               │
               ├──► DuckDB EXPLAIN ──► Execution Plan
               │
               └──► DuckDB Execute ──► Row Counts (for validation)

   ┌─────────────────────────────────────────────────────────────────┐
   │                    VALIDATION LOOP                              │
   │                                                                 │
   │   Original SQL ──► DuckDB ──► Result Set A                     │
   │                                    │                            │
   │   Optimized SQL ──► DuckDB ──► Result Set B                    │
   │                                    │                            │
   │                              A == B ?                           │
   │                              ├─ YES → Valid optimization        │
   │                              └─ NO  → Retry with feedback       │
   └─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           COMMAND EXAMPLES                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Static analysis only
  qt-sql audit query.sql

  # DAG mode (recommended)
  qt-sql optimize query.sql -d db.duckdb --dag

  # DAG + MCTS fallback (most robust)
  qt-sql optimize query.sql -d db.duckdb --dag --mcts-on-failure

  # Direct MCTS (brute force search)
  qt-sql optimize query.sql -d db.duckdb --mcts --mcts-iterations 50

  # Simple LLM (legacy, no validation)
  qt-sql optimize query.sql --provider deepseek

  # Save output
  qt-sql optimize query.sql -d db.duckdb --dag -o optimized.sql
