<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Torque | {{ file_name }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
:root {
    --bg: #ffffff;
    --bg-card: #ffffff;
    --bg-code: #1e1e2e;
    --fg: #0f172a;
    --fg-muted: #64748b;
    --fg-code: #cdd6f4;
    --border: #e2e8f0;
    --border-strong: #cbd5e1;

    --critical: #dc2626;
    --critical-bg: #fef2f2;
    --high: #ea580c;
    --high-bg: #fff7ed;
    --medium: #ca8a04;
    --medium-bg: #fefce8;
    --low: #16a34a;
    --low-bg: #f0fdf4;

    --primary: #2563eb;
    --primary-bg: #eff6ff;
    --primary-hover: #1d4ed8;

    --radius: 8px;
    --radius-sm: 4px;
    --shadow: 0 1px 3px rgba(0,0,0,0.05);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; font-size: 14px; }
code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.875em; }
.page { max-width: 1200px; margin: 0 auto; padding: 2rem; }

/* Header */
.header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
.header-left { display: flex; flex-direction: column; gap: 0.5rem; }
.brand { display: flex; align-items: center; gap: 0.75rem; }
.brand-mark { width: 36px; height: 36px; background: var(--primary-bg); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.brand-mark svg { width: 20px; height: 20px; stroke: var(--primary); }
.brand-text { font-weight: 700; font-size: 1.125rem; letter-spacing: -0.02em; }
.brand-tag { font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.125rem 0.5rem; background: var(--primary-bg); color: var(--primary); border-radius: 4px; margin-left: 0.5rem; }
.query-id { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; color: var(--fg-muted); }
.header-right { text-align: right; font-size: 0.8125rem; color: var(--fg-muted); line-height: 1.7; }
.header-right strong { color: var(--fg); font-weight: 600; }

/* Verdict */
.verdict { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; display: grid; grid-template-columns: 120px 1fr auto; gap: 2rem; align-items: center; box-shadow: var(--shadow); }
.verdict-score { text-align: center; padding-right: 1.5rem; border-right: 1px solid var(--border); }
.score-value { font-size: 2.75rem; font-weight: 700; line-height: 1; letter-spacing: -0.03em; }
.score-value.critical { color: var(--critical); }
.score-value.high { color: var(--high); }
.score-value.medium { color: var(--medium); }
.score-value.pass { color: var(--low); }
.score-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--fg-muted); margin-top: 0.25rem; }
.verdict-summary { flex: 1; }
.verdict-headline { font-size: 1rem; font-weight: 600; line-height: 1.4; margin-bottom: 0.5rem; }
.verdict-stats { display: flex; gap: 1.5rem; font-size: 0.875rem; flex-wrap: wrap; }
.verdict-stat { display: flex; align-items: baseline; gap: 0.375rem; }
.verdict-stat-value { font-weight: 700; font-size: 1.125rem; }
.verdict-stat-value.high { color: var(--high); }
.verdict-stat-label { color: var(--fg-muted); }
.verdict-action { display: flex; flex-direction: column; gap: 0.5rem; }
.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8125rem; font-weight: 500; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-hover); }
.btn-secondary { background: var(--bg); color: var(--fg); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--border-strong); }

/* Cost Breakdown */
.cost-breakdown { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
.cost-header { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--fg-muted); margin-bottom: 1rem; }
.cost-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
.cost-item { }
.cost-label { font-size: 0.75rem; color: var(--fg-muted); margin-bottom: 0.25rem; }
.cost-value { font-size: 1.5rem; font-weight: 700; }
.cost-value.savings { color: var(--low); }
.cost-subvalue { font-size: 0.75rem; color: var(--fg-muted); }
.cost-divider { border-left: 1px solid var(--border); padding-left: 1.5rem; }

/* Section Divider */
.section-divider { border-top: 2px solid var(--primary); margin: 2rem 0 1.5rem 0; padding-top: 1rem; }
.section-divider-label { display: inline-block; background: var(--primary); color: white; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.25rem 0.75rem; border-radius: 3px; margin-bottom: 0.5rem; }
.section-divider-title { font-size: 1.125rem; font-weight: 700; }
.section-divider-desc { font-size: 0.8125rem; color: var(--fg-muted); margin-top: 0.25rem; }

/* LLM Payload Header */
.llm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.llm-header-left { display: flex; align-items: center; gap: 1rem; }
.llm-title { font-weight: 600; color: var(--fg); }
.llm-meta { font-size: 0.75rem; color: var(--fg-muted); }
.llm-actions { display: flex; gap: 0.5rem; }

/* Accordion */
.accordion { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--bg-card); }
.accordion-item { border-bottom: 1px solid var(--border); }
.accordion-item:last-child { border-bottom: none; }

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    cursor: pointer;
    background: var(--bg-card);
    transition: background 0.15s;
    user-select: none;
}
.accordion-header:hover { background: var(--bg); }
.accordion-item.open .accordion-header { background: var(--bg); border-bottom: 1px solid var(--border); }

.accordion-header-left { display: flex; align-items: center; gap: 0.75rem; }
.accordion-num {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-bg);
    color: var(--primary);
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 4px;
}
.accordion-title { font-weight: 600; font-size: 0.875rem; }
.accordion-subtitle { font-size: 0.75rem; color: var(--fg-muted); margin-left: 0.5rem; }

.accordion-chevron {
    color: var(--fg-muted);
    transition: transform 0.2s;
    font-size: 0.75rem;
}
.accordion-item.open .accordion-chevron { transform: rotate(180deg); }

.accordion-content {
    display: none;
    padding: 1rem;
    background: var(--bg);
    font-size: 0.8125rem;
}
.accordion-item.open .accordion-content { display: block; }

/* Content Styling */
.content-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
.content-label { color: var(--fg-muted); min-width: 120px; }
.content-value { font-weight: 500; }
.content-value code { background: var(--bg-card); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.75rem; }

.content-list { margin: 0.5rem 0; padding-left: 1.25rem; }
.content-list li { margin-bottom: 0.25rem; }

.content-tag {
    display: inline-block;
    font-size: 0.6875rem;
    font-weight: 600;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    margin-right: 0.375rem;
}
.content-tag.permitted { background: var(--low-bg); color: var(--low); }
.content-tag.forbidden { background: var(--critical-bg); color: var(--critical); }

/* SQL Block */
.sql-block {
    background: var(--bg-code);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin-top: 0.5rem;
}
.sql-block-header {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: rgba(0,0,0,0.3);
    font-size: 0.6875rem;
    color: #a6adc8;
}
.sql-block-content {
    padding: 0.75rem;
    overflow-x: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    line-height: 1.7;
    color: var(--fg-code);
}
.sql-line { display: flex; }
.sql-ln { color: #585b70; width: 36px; text-align: right; padding-right: 1rem; user-select: none; }
.sql-code { flex: 1; white-space: pre; }
.sql-marker { color: #f38ba8; margin-left: 1rem; }
.sql-line.has-issue { background: rgba(243, 139, 168, 0.1); }
.sql-line.bottleneck { background: rgba(243, 139, 168, 0.25); border-left: 3px solid var(--critical); }

/* Data Tables */
.data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 0.5rem; }
.data-table th {
    text-align: left;
    padding: 0.5rem 0.625rem;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--fg-muted);
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.data-table td {
    padding: 0.5rem 0.625rem;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table code { font-size: 0.6875rem; background: var(--bg-card); padding: 0.125rem 0.25rem; border-radius: 2px; }

.status-badge {
    display: inline-block;
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
}
.status-badge.ok { background: var(--low-bg); color: var(--low); }
.status-badge.warn { background: var(--medium-bg); color: var(--medium); }
.status-badge.error { background: var(--critical-bg); color: var(--critical); }

.severity-badge {
    display: inline-block;
    font-size: 0.625rem;
    font-weight: 700;
    padding: 0.125rem 0.5rem;
    border-radius: 3px;
    text-transform: uppercase;
}
.severity-badge.critical { background: var(--critical-bg); color: var(--critical); }
.severity-badge.high { background: var(--high-bg); color: var(--high); }
.severity-badge.medium { background: var(--medium-bg); color: var(--medium); }

/* Fix descriptions */
.fix-item {
    display: flex;
    gap: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
}
.fix-item:last-child { border-bottom: none; }
.fix-id {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.6875rem;
    font-weight: 600;
    color: var(--primary);
    min-width: 60px;
}
.fix-text { color: var(--fg-muted); }

/* Output format code */
.yaml-block {
    background: var(--bg-code);
    border-radius: var(--radius-sm);
    padding: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    line-height: 1.6;
    color: var(--fg-code);
    overflow-x: auto;
    margin-top: 0.5rem;
}

/* Footer */
.footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1.5rem; border-top: 1px solid var(--border); margin-top: 2rem; font-size: 0.8125rem; color: var(--fg-muted); }
.footer-actions { display: flex; gap: 1rem; }
.footer-action { color: var(--primary); cursor: pointer; background: none; border: none; font-size: 0.8125rem; }
.footer-action:hover { text-decoration: underline; }

/* Toast */
.toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-code); color: var(--fg-code); padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: all 0.3s; z-index: 1000; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

#qt-audit-data { display: none; }
    </style>
</head>
<body>

<!-- Machine-Readable JSON -->
<script type="application/json" id="qt-audit-data">
{{ json_data | safe }}
</script>

<div class="page">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <div class="brand">
            <div class="brand-mark">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
            </div>
            <span class="brand-text">Query Torque</span>
            <span class="brand-tag">Audit</span>
        </div>
        <div class="query-id">{{ query_name }} &middot; {{ query_hash }}</div>
    </div>
    <div class="header-right">
        <div><strong>Report:</strong> {{ report_id }}</div>
        <div><strong>Generated:</strong> {{ generated_date }}</div>
        <div><strong>Dialect:</strong> {{ dialect }}</div>
    </div>
</header>

<!-- HUMAN SECTION: Executive Summary -->

<div class="verdict">
    <div class="verdict-score">
        <div class="score-value {{ score_class }}">{{ score }}</div>
        <div class="score-label">Torque Score</div>
    </div>
    <div class="verdict-summary">
        <div class="verdict-headline">{{ headline }}</div>
        <div class="verdict-stats">
            <div class="verdict-stat"><span class="verdict-stat-value">{{ issue_count }}</span><span class="verdict-stat-label">Anti-patterns</span></div>
            {% if execution_time_ms %}
            <div class="verdict-stat"><span class="verdict-stat-value high">{{ execution_time_ms }}ms</span><span class="verdict-stat-label">Execution</span></div>
            {% endif %}
            {% if cu_cost %}
            <div class="verdict-stat"><span class="verdict-stat-value">{{ cu_cost }} CU</span><span class="verdict-stat-label">/run</span></div>
            {% endif %}
            {% if monthly_cost %}
            <div class="verdict-stat"><span class="verdict-stat-value">${{ monthly_cost }}</span><span class="verdict-stat-label">/mo</span></div>
            {% endif %}
        </div>
    </div>
    <div class="verdict-action">
        <button class="btn btn-primary" onclick="copyLLMPayload()">Copy LLM Payload</button>
        <button class="btn btn-secondary" onclick="downloadJSON()">Download JSON</button>
    </div>
</div>

<div class="cost-breakdown">
    <div class="cost-header">Cost Impact Analysis{% if not cost_analysis or not cost_analysis.current_monthly %} <span style="font-weight:normal;font-size:0.85em;opacity:0.7">(connect database for metrics)</span>{% endif %}</div>
    <div class="cost-grid">
        <div class="cost-item">
            <div class="cost-label">Current Monthly Cost</div>
            <div class="cost-value">{% if cost_analysis and cost_analysis.current_monthly %}${{ cost_analysis.current_monthly|round|int }}{% else %}—{% endif %}</div>
            <div class="cost-subvalue">{% if cost_analysis and cost_analysis.cu_per_run %}{{ cost_analysis.cu_per_run|round(1) }} CU/run{% else %}Run query to measure{% endif %}</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Projected After Fix</div>
            <div class="cost-value savings">{% if cost_analysis and cost_analysis.projected_monthly %}${{ cost_analysis.projected_monthly|round|int }}{% else %}—{% endif %}</div>
            <div class="cost-subvalue">{% if cost_analysis and cost_analysis.savings_pct %}~{{ cost_analysis.savings_pct }}% reduction{% else %}Estimated savings{% endif %}</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Est. Monthly Savings</div>
            <div class="cost-value savings">{% if cost_analysis and cost_analysis.monthly_savings %}${{ cost_analysis.monthly_savings|round|int }}{% else %}—{% endif %}</div>
            <div class="cost-subvalue">Based on typical fixes</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Est. Annual Savings</div>
            <div class="cost-value savings">{% if cost_analysis and cost_analysis.annual_savings %}${{ cost_analysis.annual_savings|round|int }}{% else %}—{% endif %}</div>
            <div class="cost-subvalue">Projected estimate</div>
        </div>
    </div>
</div>


<!-- LLM SECTION -->

<div class="section-divider">
    <span class="section-divider-label">LLM Payload</span>
    <div class="section-divider-title">Optimization Context for AI Processing</div>
    <div class="section-divider-desc">Click sections to expand. Copy button captures full payload as markdown.</div>
</div>

<div class="llm-header">
    <div class="llm-header-left">
        <span class="llm-title">llm-optimization-payload.md</span>
        <span class="llm-meta">Sections &middot; ~{{ token_estimate }}k tokens</span>
    </div>
    <div class="llm-actions">
        <button class="btn btn-secondary" onclick="toggleAll(true)">Expand All</button>
        <button class="btn btn-secondary" onclick="toggleAll(false)">Collapse All</button>
        <button class="btn btn-primary" onclick="copyLLMPayload()">Copy Full Payload</button>
    </div>
</div>

<div class="accordion" id="llm-accordion">
    <!-- Sections will be populated by JavaScript -->
</div>

<!-- Paste Response Section -->
<div class="response-section" style="background: var(--bg-card); border: 2px dashed var(--primary); border-radius: var(--radius); padding: 1.5rem; margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <span style="font-weight: 700; font-size: 1rem; color: var(--primary);">Paste LLM Response</span>
        <button class="btn btn-secondary" onclick="pasteFromClipboard()">Paste from Clipboard</button>
    </div>
    <div style="font-size: 0.8125rem; color: var(--fg-muted); margin-bottom: 1rem;">
        After copying the payload above and getting a response from your AI tool, paste the JSON response here (optimized SQL or patches).
    </div>
    <textarea id="llm-response" style="width: 100%; min-height: 200px; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; resize: vertical; background: var(--bg);" placeholder="Paste LLM response here..."></textarea>
    <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
        <button class="btn" style="background: var(--low); color: white;" onclick="validateResponse()">Validate Response</button>
        <button class="btn btn-secondary" onclick="clearResponse()">Clear</button>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div><strong>Query Torque</strong> &middot; Audit Report v8.0 &middot; Spec: llm-payload-v3</div>
    <div class="footer-actions">
        <button class="footer-action" onclick="copyLLMPayload()">Copy LLM Payload</button>
        <button class="footer-action" onclick="copyJSON()">Copy JSON</button>
    </div>
</footer>

</div>

<div class="toast" id="toast"></div>

<script>
const data = JSON.parse(document.getElementById('qt-audit-data').textContent);

// Map line numbers to anti-patterns for SQL annotation
const linePatterns = {};
(data.anti_patterns || []).forEach(p => {
    (p.lines || []).forEach(line => {
        if (!linePatterns[line]) linePatterns[line] = [];
        linePatterns[line].push(p.id);
    });
});

// Find bottleneck lines from execution plan
const bottleneckLines = new Set();
const plan = data.execution_plan || {};
const hotspots = plan.hotspots || [];
const bottleneck = hotspots.find(h => h.is_bottleneck);
if (bottleneck && bottleneck.why) {
    const sql = (data.query?.raw_sql || '').toLowerCase();
    const sqlLines = sql.split('\n');
    const expr = bottleneck.why.toLowerCase();

    // Extract key terms from the expression to search for
    const searchTerms = [];
    // Look for column names and functions in the expression
    const matches = expr.match(/\b(year|month|day|date|order_date|customer_id|status|region|[a-z_]+)\b/g) || [];
    matches.forEach(m => { if (m.length > 2) searchTerms.push(m); });

    // Find lines containing these terms
    sqlLines.forEach((line, i) => {
        const lineNum = i + 1;
        const lineLower = line.toLowerCase();
        // Check if line contains multiple search terms (more likely to be the bottleneck location)
        const matchCount = searchTerms.filter(term => lineLower.includes(term)).length;
        if (matchCount >= 2) {
            bottleneckLines.add(lineNum);
        }
    });
}

// Section definitions
const sections = [
    {title: 'Constraints', subtitle: 'What must be preserved', render: renderConstraints},
    {title: 'SQL', subtitle: `${data.query?.lines || 0} lines, annotated`, render: renderSQL},
    {title: 'Execution Plan', subtitle: 'Parsed operator tree', render: renderExecutionPlan},
    {title: 'DAG', subtitle: 'Query structure & table accesses', render: renderDAG},
    {title: 'Schema', subtitle: `${(data.schema || []).length} tables`, render: renderSchema},
    {title: 'Anti-Patterns', subtitle: `${(data.anti_patterns || []).length} detected`, render: renderAntiPatterns},
    {title: 'Output Format', subtitle: 'Sequenced fix steps', render: renderOutputFormat},
];

function renderAccordion() {
    const container = document.getElementById('llm-accordion');
    container.innerHTML = sections.map((s, index) => `
        <div class="accordion-item" data-section="${index + 1}">
            <div class="accordion-header" onclick="toggleSection(${index + 1})">
                <div class="accordion-header-left">
                    <span class="accordion-num">${index + 1}</span>
                    <span class="accordion-title">${s.title}</span>
                    <span class="accordion-subtitle">${s.subtitle}</span>
                </div>
                <span class="accordion-chevron">&#9660;</span>
            </div>
            <div class="accordion-content">${s.render()}</div>
        </div>
    `).join('');
}

function renderConstraints() {
    const c = data.constraints || {};
    const preserve = c.preserve || {};
    return `
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Must Preserve</div>
            <div class="content-row">
                <span class="content-label">Output grain:</span>
                <span class="content-value"><code>[${(preserve.output_grain || []).join(', ')}]</code></span>
            </div>
            <div class="content-row">
                <span class="content-label">Output columns:</span>
                <span class="content-value">${(preserve.output_columns || []).map(col => '<code>' + col + '</code>').join(', ')}</span>
            </div>
            <div class="content-row">
                <span class="content-label">Sort order:</span>
                <span class="content-value"><code>${preserve.sort_order || 'none'}</code></span>
            </div>
            <div class="content-row">
                <span class="content-label">Row count:</span>
                <span class="content-value">${(preserve.row_count || 0).toLocaleString()} &plusmn; ${preserve.row_tolerance || 0}</span>
            </div>
            <div class="content-row">
                <span class="content-label">Checksum cols:</span>
                <span class="content-value">${(preserve.checksum_columns || []).map(col => '<code>' + col + '</code>').join(', ') || 'none'}</span>
            </div>
        </div>
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Permitted Transformations</div>
            ${(c.permitted || []).map(p => '<span class="content-tag permitted">&#10003;</span>' + p).join('<br>')}
        </div>
        <div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Forbidden Transformations</div>
            ${(c.forbidden || []).map(f => '<span class="content-tag forbidden">&#10007;</span>' + f).join('<br>')}
        </div>
    `;
}

function renderSQL() {
    const q = data.query || {};
    const lines = (q.raw_sql || '').split('\n').map((line, i) => {
        const lineNum = i + 1;
        const hasIssue = linePatterns[lineNum];
        const isBottleneck = bottleneckLines.has(lineNum);
        const markers = [];
        if (hasIssue) markers.push(`[${linePatterns[lineNum].join(', ')}]`);
        if (isBottleneck) markers.push('<span style="color: var(--critical); font-weight: 600;">[BOTTLENECK]</span>');
        const marker = markers.length > 0 ? `&larr; ${markers.join(' ')}` : '';
        const lineClass = isBottleneck ? ' bottleneck' : (hasIssue ? ' has-issue' : '');
        return `<div class="sql-line${lineClass}"><span class="sql-ln">${lineNum}</span><span class="sql-code">${escapeHtml(line)}</span>${marker ? `<span class="sql-marker">${marker}</span>` : ''}</div>`;
    }).join('');

    return `
        <div class="sql-block">
            <div class="sql-block-header">
                <span>${q.id || 'query'}</span>
                <span>hash: ${q.hash || 'unknown'}</span>
            </div>
            <div class="sql-block-content">${lines}</div>
        </div>
    `;
}

function renderExecutionPlan() {
    const plan = data.execution_plan || {};
    const hotspots = plan.hotspots || [];

    if (hotspots.length === 0) {
        return '<p style="color: var(--fg-muted);">No execution plan data. Connect to a database and run the query first.</p>';
    }

    // Single list: hotspots with full detail (80% impact or top 10)
    const rows = hotspots.map((h, i) => {
        const ev = h.evidence || {};
        const isBottleneck = h.is_bottleneck;
        const rowStyle = isBottleneck ? 'background: var(--critical-bg);' : '';
        const costStyle = ev.cost_pct > 30 ? 'color: var(--critical); font-weight: 600;' : '';

        return `<tr style="${rowStyle}">
            <td style="font-weight: 500; text-align: center;">${i + 1}</td>
            <td><code>${h.what}</code>${isBottleneck ? ' <span class="status-badge error">BOTTLENECK</span>' : ''}</td>
            <td>${h.where ? `<code>${h.where}</code>` : '—'}</td>
            <td style="font-size: 0.75rem;">${h.why || '—'}</td>
            <td style="${costStyle} text-align: right;">${ev.cost_pct}%</td>
            <td style="text-align: right;">${ev.timing_ms}ms</td>
            <td style="text-align: right;">${(ev.actual_rows || 0).toLocaleString()}</td>
            <td style="text-align: right;">${ev.est_rows != null ? ev.est_rows.toLocaleString() : '—'}</td>
        </tr>`;
    }).join('');

    return `
        <table class="data-table" style="font-size: 0.8125rem;">
            <tr>
                <th style="width: 2rem;">#</th>
                <th>Operator</th>
                <th>Table</th>
                <th>Expression</th>
                <th style="text-align: right;">Cost%</th>
                <th style="text-align: right;">Time</th>
                <th style="text-align: right;">Rows</th>
                <th style="text-align: right;">Est</th>
            </tr>
            ${rows}
        </table>
    `;
}

function renderDAG() {
    const dag = data.dag || {};
    const nodes = dag.nodes || [];
    const edges = dag.edges || [];
    const tableAccesses = dag.table_accesses || [];
    const execOrder = dag.execution_order || [];

    // Build analysis flags display
    const flagsHtml = (n) => {
        const flags = [];
        if (n.agg) flags.push('<span title="Has aggregation" style="color: var(--primary);">Σ</span>');
        if (n.filter) flags.push('<span title="Has filter" style="color: var(--medium);">⊳</span>');
        if (n.window) flags.push('<span title="Has window function" style="color: var(--high);">⊞</span>');
        if (n.join_count > 0) flags.push(`<span title="${n.join_count} join(s)" style="color: var(--fg-muted);">⋈${n.join_count}</span>`);
        return flags.length ? flags.join(' ') : '—';
    };

    // Format grain columns for display
    const grainHtml = (cols) => {
        if (!cols || !cols.length) return '<span style="color: var(--fg-muted);">—</span>';
        const display = cols.slice(0, 3).map(c => `<code>${c}</code>`).join(', ');
        return cols.length > 3 ? display + '...' : display;
    };

    // Separate CTEs/subqueries from base tables
    const cteNodes = nodes.filter(n => n.type !== 'base_table');
    const baseTables = nodes.filter(n => n.type === 'base_table');

    // Format node type for display
    const nodeTypeDisplay = (type) => {
        const typeMap = {
            'cte': { label: 'CTE', class: 'ok' },
            'in_subquery': { label: 'IN subquery', class: 'warn' },
            'exists_subquery': { label: 'EXISTS', class: 'warn' },
            'scalar_subquery': { label: 'Scalar', class: 'warn' },
            'subquery': { label: 'Subquery', class: 'warn' },
        };
        return typeMap[type] || { label: type, class: 'warn' };
    };

    // Format node ID for display (make subquery names more readable)
    const nodeIdDisplay = (id, type) => {
        if (id.startsWith('__subquery_')) {
            const num = id.replace('__subquery_', '').replace('__', '');
            return `Subquery #${num}`;
        }
        return id;
    };

    // Build rows for CTEs/subqueries
    const cteRows = cteNodes.map(n => {
        const typeInfo = nodeTypeDisplay(n.type);
        return `
        <tr>
            <td><code style="font-weight: 500;">${nodeIdDisplay(n.id, n.type)}</code></td>
            <td><span class="status-badge ${typeInfo.class}">${typeInfo.label}</span></td>
            <td style="text-align: center;">${n.lines ? n.lines.join('–') : '—'}</td>
            <td>${grainHtml(n.grain)}</td>
            <td>${n.tables && n.tables.length ? n.tables.map(t => '<code>' + t + '</code>').join(', ') : '—'}</td>
            <td style="text-align: center;">${flagsHtml(n)}</td>
        </tr>
    `}).join('');

    // Build rows for base tables (shown when no CTEs)
    const baseTableRows = baseTables.map(n => `
        <tr>
            <td><code style="font-weight: 500;">${n.id}</code></td>
            <td><span class="status-badge warn">table</span></td>
            <td style="text-align: center;">${n.lines ? n.lines.join('–') : '—'}</td>
            <td>${grainHtml(n.grain)}</td>
            <td>—</td>
            <td style="text-align: center;">${flagsHtml(n)}</td>
        </tr>
    `).join('');

    // Separate dependency edges from join edges for clarity
    const depEdges = edges.filter(e => e.join_type === 'DEPENDS');
    const joinEdges = edges.filter(e => e.join_type !== 'DEPENDS' && e.cardinality);

    const depRows = depEdges.map(e => `
        <tr>
            <td><code>${e.from}</code> → <code>${e.to}</code></td>
            <td><span class="status-badge ok">data flow</span></td>
        </tr>
    `).join('');

    const riskClass = (risk) => risk === 'danger' ? 'error' : (risk === 'warn' ? 'warn' : 'ok');
    const joinRows = joinEdges.map(e => `
        <tr>
            <td><code>${e.from}</code>.${e.left_col || '?'} → <code>${e.to}</code>.${e.right_col || '?'}</td>
            <td>${e.join_type}</td>
            <td><span class="status-badge ${e.cardinality === 'N:M' ? 'warn' : 'ok'}">${e.cardinality}</span></td>
            <td><span class="status-badge ${riskClass(e.risk)}">${e.risk}</span></td>
        </tr>
    `).join('');

    const accessRows = tableAccesses.map(t => `
        <tr>
            <td><code>${t.table}</code></td>
            <td style="text-align: center; ${t.count > 1 ? 'color: var(--high); font-weight: 600;' : ''}">${t.count}</td>
            <td style="text-align: center;">${t.optimal}</td>
            <td><span class="status-badge ${t.problem ? 'error' : 'ok'}">${t.problem ? '⚠ REDUNDANT' : '✓'}</span></td>
        </tr>
    `).join('');

    // Show execution order if available
    const execOrderHtml = execOrder.length > 0
        ? `<div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm);">
               <span style="font-weight: 500; font-size: 0.75rem; text-transform: uppercase; color: var(--fg-muted);">Execution Order:</span>
               <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; margin-left: 0.5rem;">${execOrder.filter(n => n !== '__output__').join(' → ')}</span>
           </div>`
        : '';

    // Determine what to show in Query Blocks section
    const hasCTEs = cteRows.length > 0;
    const queryBlocksTitle = hasCTEs ? 'Query Blocks (CTEs & Subqueries)' : 'Query Structure';
    const queryBlocksContent = hasCTEs ? cteRows : (baseTableRows || '<tr><td colspan="6" style="text-align:center; color: var(--fg-muted);">Simple query - no CTEs or subqueries</td></tr>');

    return `
        ${execOrderHtml}
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">${queryBlocksTitle}</div>
            <table class="data-table">
                <tr><th>Node</th><th>Type</th><th>Lines</th><th>Output Columns</th><th>Source Tables</th><th>Flags</th></tr>
                ${queryBlocksContent}
            </table>
        </div>
        ${depRows ? `
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Data Dependencies</div>
            <table class="data-table">
                <tr><th>From → To</th><th>Type</th></tr>
                ${depRows}
            </table>
        </div>
        ` : ''}
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Join Cardinalities</div>
            <table class="data-table">
                <tr><th>Join Condition</th><th>Type</th><th>Cardinality</th><th>Risk</th></tr>
                ${joinRows || '<tr><td colspan="4" style="text-align:center; color: var(--fg-muted);">No joins detected</td></tr>'}
            </table>
        </div>
        <div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Table Access Count</div>
            <table class="data-table">
                <tr><th>Table</th><th>Accesses</th><th>Optimal</th><th>Status</th></tr>
                ${accessRows || '<tr><td colspan="4" style="text-align:center; color: var(--fg-muted);">No base tables detected</td></tr>'}
            </table>
        </div>
    `;
}

function renderSchema() {
    const schema = data.schema || [];
    const cols = data.columns || [];

    const tableRows = schema.map(s => `
        <tr>
            <td><code>${s.table}</code></td>
            <td>${(s.rows || 0).toLocaleString()}</td>
            <td><code>${s.pk}</code></td>
            <td>${(s.indexes || []).length ? (s.indexes || []).map(i => '<code>' + i + '</code>').join(', ') : '&mdash;'}</td>
            <td>${s.partition || '&mdash;'}</td>
        </tr>
    `).join('');

    const colRows = cols.map(c => `
        <tr>
            <td><code>${c.table}.${c.column}</code></td>
            <td>${c.type}</td>
            <td>${c.nulls}</td>
            <td>${c.distinct ? c.distinct.toLocaleString() : '&mdash;'}</td>
            <td style="font-size: 0.7rem; color: var(--fg-muted);">${c.note || (c.values_sample ? c.values_sample.join(', ') : '')}</td>
        </tr>
    `).join('');

    return `
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Tables</div>
            <table class="data-table">
                <tr><th>Table</th><th>Rows</th><th>PK</th><th>Indexes</th><th>Partition</th></tr>
                ${tableRows || '<tr><td colspan="5" style="text-align:center; color: var(--fg-muted);">No schema data</td></tr>'}
            </table>
        </div>
        <div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Columns</div>
            <table class="data-table">
                <tr><th>Column</th><th>Type</th><th>Nulls</th><th>Distinct</th><th>Notes</th></tr>
                ${colRows || '<tr><td colspan="5" style="text-align:center; color: var(--fg-muted);">No column data</td></tr>'}
            </table>
        </div>
    `;
}

function renderAntiPatterns() {
    const patterns = data.anti_patterns || [];

    const rows = patterns.map(p => `
        <tr>
            <td><code>${p.id}</code></td>
            <td><span class="severity-badge ${p.severity}">${p.severity}</span></td>
            <td>${p.name}</td>
            <td>${(p.lines || []).join(', ')}</td>
            <td style="font-size: 0.7rem;">${p.evidence || ''}</td>
        </tr>
    `).join('');

    const fixes = patterns.map(p => `
        <div class="fix-item">
            <span class="fix-id">${p.id}</span>
            <span class="fix-text">${p.fix || ''}</span>
        </div>
    `).join('');

    return `
        <div style="margin-bottom: 1rem;">
            <table class="data-table">
                <tr><th>ID</th><th>Severity</th><th>Pattern</th><th>Lines</th><th>Evidence</th></tr>
                ${rows || '<tr><td colspan="5" style="text-align:center; color: var(--fg-muted);">No anti-patterns detected</td></tr>'}
            </table>
        </div>
        <div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Suggested Fixes</div>
            ${fixes || '<div style="color: var(--fg-muted);">No fixes needed</div>'}
        </div>
    `;
}

function renderOutputFormat() {
    return `
        <div style="margin-bottom: 0.75rem; color: var(--fg-muted);">
            Return your response as <strong>JSON</strong> with the complete optimized SQL.
        </div>
        <div class="yaml-block">{
  "optimized_sql": "&lt;complete optimized SQL code&gt;",
  "explanation": "Brief explanation of changes made",
  "changes": [
    {"rule_id": "SQL-XXX", "description": "What was fixed"}
  ]
}</div>
        <div style="margin-top: 0.75rem; color: var(--fg-muted); font-size: 0.8rem;">
            <strong>Rules:</strong><br>
            - Return the COMPLETE optimized SQL in <code>optimized_sql</code><br>
            - The SQL must be syntactically valid<br>
            - Preserve original semantics (same results, just more efficient)
        </div>
    `;
}

// Generate full markdown payload for copying
function generateLLMPayload() {
    const q = data.query || {};
    const m = data.metrics || {};
    const c = data.constraints || {};
    const preserve = c.preserve || {};
    const dag = data.dag || {};
    const plan = data.execution_plan || {};
    const schema = data.schema || [];
    const cols = data.columns || [];
    const patterns = data.anti_patterns || [];

    const annotatedSql = (q.raw_sql || '').split('\n').map((line, i) => {
        const lineNum = i + 1;
        const markers = [];
        if (linePatterns[lineNum]) markers.push(`[${linePatterns[lineNum].join(', ')}]`);
        if (bottleneckLines.has(lineNum)) markers.push('**[BOTTLENECK]**');
        const marker = markers.length > 0 ? `  -- <- ${markers.join(' ')}` : '';
        return `${String(lineNum).padStart(3, '0')}:  ${line}${marker}`;
    }).join('\n');

    // Build execution plan markdown - single table format
    const hotspots = plan.hotspots || [];

    const execPlanMd = hotspots.length > 0 ? `| # | Operator | Table | Expression | Cost% | Time | Rows | Est |
|---|----------|-------|------------|-------|------|------|-----|
${hotspots.map((h, i) => {
        const ev = h.evidence || {};
        const bottleneckMark = h.is_bottleneck ? ' **[BOTTLENECK]**' : '';
        return `| ${i + 1} | ${h.what}${bottleneckMark} | ${h.where || '—'} | ${h.why || '—'} | ${ev.cost_pct}% | ${ev.timing_ms}ms | ${ev.actual_rows || 0} | ${ev.est_rows != null ? ev.est_rows : '—'} |`;
    }).join('\n')}` : 'No execution plan data';

    return `# SQL Optimization Payload

**Task:** Produce sequenced SEARCH/REPLACE patches to fix performance issues.
**Dialect:** ${data.dialect || 'sql'}
**Query:** ${q.id || 'query'} (${q.hash || 'unknown'})

---

## 1. Constraints

**Must Preserve:**
- Output grain: \`[${(preserve.output_grain || []).join(', ')}]\`
- Output columns: ${(preserve.output_columns || []).map(col => '\`' + col + '\`').join(', ')}
- Sort order: \`${preserve.sort_order || 'none'}\`
- Row count: ${preserve.row_count || 0} +/- ${preserve.row_tolerance || 0}
- Checksum columns: ${(preserve.checksum_columns || []).map(col => '\`' + col + '\`').join(', ') || 'none'}

**Permitted:** ${(c.permitted || []).join('; ')}

**Forbidden:** ${(c.forbidden || []).join('; ')}

---

## 2. SQL

\`\`\`sql
${annotatedSql}
\`\`\`

---

## 3. Execution Plan (80% impact or top 10)

${execPlanMd}

---

## 4. DAG

**Query Blocks:**
${(dag.nodes || []).filter(n => n.type !== 'base_table').map(n =>
`- **${n.id}** (lines ${n.lines ? n.lines.join('-') : 'N/A'}): grain=\`[${(n.grain || []).join(', ')}]\`${n.tables ? ', tables=[' + n.tables.join(', ') + ']' : ''}`
).join('\n') || 'No DAG data'}

**Join Cardinalities:**
${(dag.edges || []).filter(e => e.cardinality).map(e =>
`- \`${e.from}\` -> \`${e.to}\`: **${e.cardinality}** via ${e.join_type} -- ${e.risk === 'safe' ? 'safe' : e.risk}`
).join('\n') || 'No join data'}

---

## 5. Schema

| Table | Rows | PK | Indexes | Partition |
|-------|------|-------|---------|-----------|
${schema.map(s =>
`| ${s.table} | ${(s.rows || 0).toLocaleString()} | ${s.pk} | ${(s.indexes || []).join(', ') || '-'} | ${s.partition || '-'} |`
).join('\n') || '| No data | - | - | - | - |'}

**Key Columns:**
| Column | Type | Distinct | Notes |
|--------|------|----------|-------|
${cols.map(c =>
`| ${c.table}.${c.column} | ${c.type} | ${c.distinct ? c.distinct.toLocaleString() : '-'} | ${c.note || (c.values_sample ? c.values_sample.join(', ') : '')} |`
).join('\n') || '| No data | - | - | - |'}

---

## 6. Anti-Patterns

| ID | Pattern | Severity | Lines | Evidence |
|----|---------|----------|-------|----------|
${patterns.map(p =>
`| ${p.id} | ${p.name} | ${(p.severity || '').toUpperCase()} | ${(p.lines || []).join(', ')} | ${p.evidence || ''} |`
).join('\n') || '| None detected | - | - | - | - |'}

**Suggested Fixes:**
${patterns.map(p => `- **${p.id}:** ${p.fix || ''}`).join('\n') || 'No fixes needed'}

---

## 7. Output Format

Return your response as JSON with this structure:

\`\`\`json
{
  "optimized_sql": "<complete optimized SQL code>",
  "explanation": "Brief explanation of changes made",
  "changes": [
    {"rule_id": "SQL-XXX", "description": "What was fixed"}
  ]
}
\`\`\`

**Rules:**
- Return the COMPLETE optimized SQL in \`optimized_sql\`
- The SQL must be syntactically valid
- Preserve original semantics (same results, just more efficient)
- List each fix applied in the \`changes\` array
`;
}

// Accordion toggle
function toggleSection(num) {
    const item = document.querySelector(`.accordion-item[data-section="${num}"]`);
    item.classList.toggle('open');
}

function toggleAll(open) {
    document.querySelectorAll('.accordion-item').forEach(item => {
        if (open) {
            item.classList.add('open');
        } else {
            item.classList.remove('open');
        }
    });
}

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function copyJSON() {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2))
        .then(() => showToast('JSON copied!'));
}

function downloadJSON() {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${data.report_id || 'report'}.json`;
    a.click();
}

function copyLLMPayload() {
    const payload = generateLLMPayload();
    navigator.clipboard.writeText(payload)
        .then(() => showToast('LLM Payload copied!'));
}

// Paste response functions
function pasteFromClipboard() {
    navigator.clipboard.readText()
        .then(text => {
            document.getElementById('llm-response').value = text;
            showToast('Pasted from clipboard!');
        })
        .catch(() => showToast('Clipboard access denied'));
}

function clearResponse() {
    document.getElementById('llm-response').value = '';
    showToast('Cleared');
}

function validateResponse() {
    const response = document.getElementById('llm-response').value;
    if (!response.trim()) {
        showToast('Please paste a response first');
        return;
    }
    // Send response to parent window (web UI) for validation
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'qt-llm-response',
            response: response
        }, '*');
        showToast('Sending to validator...');
    } else {
        // Standalone mode
        showToast('Response captured! Use web UI for full validation.');
        console.log('LLM Response:', response);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    renderAccordion();
    // All sections start collapsed - user clicks to expand
});
</script>

</body>
</html>
