<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Torque | {{ filename }}</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
:root {
    --bg: #fafafa;
    --bg-card: #ffffff;
    --bg-code: #1e1e2e;
    --fg: #18181b;
    --fg-muted: #71717a;
    --fg-code: #cdd6f4;
    --border: #e4e4e7;
    --border-strong: #d4d4d8;
    --critical: #dc2626;
    --critical-bg: #fef2f2;
    --high: #ea580c;
    --high-bg: #fff7ed;
    --medium: #ca8a04;
    --medium-bg: #fefce8;
    --low: #16a34a;
    --low-bg: #f0fdf4;
    --tier-1: #6d28d9;
    --tier-1-bg: #f5f3ff;
    --radius: 8px;
    --radius-sm: 4px;
    --shadow: 0 1px 3px rgba(0,0,0,0.05);
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; font-size: 14px; }
code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.875em; }
.page { max-width: 1200px; margin: 0 auto; padding: 2rem; }

.header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
.header-left { display: flex; flex-direction: column; gap: 0.5rem; }
.brand { display: flex; align-items: center; gap: 0.75rem; }
.brand-mark { width: 36px; height: 36px; background: linear-gradient(135deg, #6d28d9 0%, #a855f7 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.brand-mark svg { width: 20px; height: 20px; }
.brand-text { font-weight: 700; font-size: 1.125rem; letter-spacing: -0.02em; }
.brand-tag { font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.125rem 0.5rem; background: var(--tier-1-bg); color: var(--tier-1); border-radius: 4px; margin-left: 0.5rem; }
.query-id { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; color: var(--fg-muted); }
.header-right { text-align: right; font-size: 0.8125rem; color: var(--fg-muted); line-height: 1.7; }
.header-right strong { color: var(--fg); font-weight: 600; }

.verdict { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1rem; display: grid; grid-template-columns: 120px 1fr auto; gap: 2rem; align-items: center; box-shadow: var(--shadow); }
.verdict-score { text-align: center; padding-right: 1.5rem; border-right: 1px solid var(--border); }
.score-value { font-size: 2.75rem; font-weight: 700; line-height: 1; letter-spacing: -0.03em; }
.score-value.critical { color: var(--critical); }
.score-value.high { color: var(--high); }
.score-value.medium { color: var(--medium); }
.score-value.pass { color: var(--low); }
.score-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--fg-muted); margin-top: 0.25rem; }
.verdict-summary { flex: 1; }
.verdict-headline { font-size: 1rem; font-weight: 600; line-height: 1.4; margin-bottom: 0.5rem; }
.verdict-stats { display: flex; gap: 1.5rem; font-size: 0.875rem; flex-wrap: wrap; }
.verdict-stat { display: flex; align-items: baseline; gap: 0.375rem; }
.verdict-stat-value { font-weight: 700; font-size: 1.125rem; }
.verdict-stat-value.high { color: var(--high); }
.verdict-stat-value.critical { color: var(--critical); }
.verdict-stat-label { color: var(--fg-muted); }
.verdict-action { display: flex; flex-direction: column; gap: 0.5rem; }
.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8125rem; font-weight: 500; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; }
.btn-primary { background: var(--tier-1); color: white; }
.btn-primary:hover { background: #5b21b6; }
.btn-secondary { background: var(--bg); color: var(--fg); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--border-strong); }
.btn-success { background: var(--low); color: white; }
.btn-success:hover { background: #15803d; }

.cost-breakdown { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.25rem 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
.cost-header { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.04em; color: var(--fg-muted); margin-bottom: 1rem; }
.cost-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
.cost-item { }
.cost-label { font-size: 0.75rem; color: var(--fg-muted); margin-bottom: 0.25rem; }
.cost-value { font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.cost-value.savings { color: var(--low); }
.cost-subvalue { font-size: 0.75rem; color: var(--fg-muted); }
.cost-divider { border-left: 1px solid var(--border); padding-left: 1.5rem; }

.section-divider { border-top: 2px solid var(--tier-1); margin: 2rem 0 1.5rem 0; padding-top: 1rem; }
.section-divider-label { display: inline-block; background: var(--tier-1); color: white; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.25rem 0.75rem; border-radius: 3px; margin-bottom: 0.5rem; }
.section-divider-title { font-size: 1.125rem; font-weight: 700; }
.section-divider-desc { font-size: 0.8125rem; color: var(--fg-muted); margin-top: 0.25rem; }

.llm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.llm-header-left { display: flex; align-items: center; gap: 1rem; }
.llm-title { font-weight: 600; color: var(--fg); }
.llm-meta { font-size: 0.75rem; color: var(--fg-muted); }
.llm-actions { display: flex; gap: 0.5rem; }

.accordion { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--bg-card); }
.accordion-item { border-bottom: 1px solid var(--border); }
.accordion-item:last-child { border-bottom: none; }
.accordion-header { display: flex; justify-content: space-between; align-items: center; padding: 0.875rem 1rem; cursor: pointer; background: var(--bg-card); transition: background 0.15s; user-select: none; }
.accordion-header:hover { background: var(--bg); }
.accordion-item.open .accordion-header { background: var(--bg); border-bottom: 1px solid var(--border); }
.accordion-header-left { display: flex; align-items: center; gap: 0.75rem; }
.accordion-num { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; background: var(--tier-1-bg); color: var(--tier-1); font-size: 0.75rem; font-weight: 700; border-radius: 4px; }
.accordion-title { font-weight: 600; font-size: 0.875rem; }
.accordion-subtitle { font-size: 0.75rem; color: var(--fg-muted); margin-left: 0.5rem; }
.accordion-chevron { color: var(--fg-muted); transition: transform 0.2s; font-size: 0.75rem; }
.accordion-item.open .accordion-chevron { transform: rotate(180deg); }
.accordion-content { display: none; padding: 1rem; background: var(--bg); font-size: 0.8125rem; }
.accordion-item.open .accordion-content { display: block; }

.content-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
.content-label { color: var(--fg-muted); min-width: 120px; }
.content-value { font-weight: 500; }
.content-value code { background: var(--bg-card); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.75rem; }
.content-tag { display: inline-block; font-size: 0.6875rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 3px; margin-right: 0.375rem; }
.content-tag.permitted { background: var(--low-bg); color: var(--low); }
.content-tag.forbidden { background: var(--critical-bg); color: var(--critical); }

.sql-block { background: var(--bg-code); border-radius: var(--radius-sm); overflow: hidden; margin-top: 0.5rem; }
.sql-block-header { display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: rgba(0,0,0,0.3); font-size: 0.6875rem; color: #a6adc8; }
.sql-block-content { padding: 0.75rem; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; line-height: 1.7; color: var(--fg-code); }
.sql-line { display: flex; }
.sql-ln { color: #585b70; width: 36px; text-align: right; padding-right: 1rem; user-select: none; }
.sql-code { flex: 1; white-space: pre; }
.sql-marker { color: #f38ba8; margin-left: 1rem; }
.sql-line.has-issue { background: rgba(243, 139, 168, 0.1); }

.data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 0.5rem; }
.data-table th { text-align: left; padding: 0.5rem 0.625rem; font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--fg-muted); background: var(--bg-card); border-bottom: 1px solid var(--border); }
.data-table td { padding: 0.5rem 0.625rem; border-bottom: 1px solid var(--border); vertical-align: top; }
.data-table tr:last-child td { border-bottom: none; }
.data-table code { font-size: 0.6875rem; background: var(--bg-card); padding: 0.125rem 0.25rem; border-radius: 2px; }
.status-badge { display: inline-block; font-size: 0.625rem; font-weight: 600; padding: 0.125rem 0.375rem; border-radius: 3px; }
.status-badge.ok { background: var(--low-bg); color: var(--low); }
.status-badge.warn { background: var(--medium-bg); color: var(--medium); }
.status-badge.error { background: var(--critical-bg); color: var(--critical); }
.severity-badge { display: inline-block; font-size: 0.625rem; font-weight: 700; padding: 0.125rem 0.5rem; border-radius: 3px; text-transform: uppercase; }
.severity-badge.critical { background: var(--critical-bg); color: var(--critical); }
.severity-badge.high { background: var(--high-bg); color: var(--high); }
.severity-badge.medium { background: var(--medium-bg); color: var(--medium); }
.severity-badge.low { background: var(--low-bg); color: var(--low); }

.fix-item { display: flex; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.fix-item:last-child { border-bottom: none; }
.fix-id { font-family: 'JetBrains Mono', monospace; font-size: 0.6875rem; font-weight: 600; color: var(--tier-1); min-width: 60px; }
.fix-text { color: var(--fg-muted); }

.yaml-block { background: var(--bg-code); border-radius: var(--radius-sm); padding: 0.75rem; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; line-height: 1.6; color: var(--fg-code); overflow-x: auto; margin-top: 0.5rem; white-space: pre; }

/* Response Input Section */
.response-section { background: var(--bg-card); border: 2px dashed var(--tier-1); border-radius: var(--radius); padding: 1.5rem; margin-top: 2rem; }
.response-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.response-title { font-weight: 700; font-size: 1rem; color: var(--tier-1); }
.response-hint { font-size: 0.8125rem; color: var(--fg-muted); margin-bottom: 1rem; }
.response-textarea { width: 100%; min-height: 200px; padding: 1rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; resize: vertical; background: var(--bg); }
.response-textarea:focus { outline: none; border-color: var(--tier-1); box-shadow: 0 0 0 3px var(--tier-1-bg); }
.response-actions { display: flex; gap: 0.75rem; margin-top: 1rem; }

.footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1.5rem; border-top: 1px solid var(--border); margin-top: 2rem; font-size: 0.8125rem; color: var(--fg-muted); }
.footer-actions { display: flex; gap: 1rem; }
.footer-action { color: var(--tier-1); cursor: pointer; background: none; border: none; font-size: 0.8125rem; }
.footer-action:hover { text-decoration: underline; }

.toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-code); color: var(--fg-code); padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: all 0.3s; z-index: 1000; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

#qt-audit-data { display: none; }
    </style>
</head>
<body>

<script type="application/json" id="qt-audit-data">
{{ json_data | safe }}
</script>

<script type="text/plain" id="qt-llm-payload">{{ llm_payload }}</script>

<div class="page">

<header class="header">
    <div class="header-left">
        <div class="brand">
            <div class="brand-mark">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <span class="brand-text">Query Torque</span>
            <span class="brand-tag">Audit</span>
        </div>
        <div class="query-id" id="query-id"></div>
    </div>
    <div class="header-right" id="header-right"></div>
</header>

<div class="verdict" id="verdict"></div>

<div class="cost-breakdown" id="cost-breakdown"></div>

<div class="section-divider">
    <span class="section-divider-label">LLM Payload</span>
    <div class="section-divider-title">Optimization Context for AI Processing</div>
    <div class="section-divider-desc">Click sections to expand. Copy button captures full payload as markdown.</div>
</div>

<div class="llm-header">
    <div class="llm-header-left">
        <span class="llm-title">llm-optimization-payload.md</span>
        <span class="llm-meta" id="llm-meta"></span>
    </div>
    <div class="llm-actions">
        <button class="btn btn-secondary" onclick="toggleAll(true)">Expand All</button>
        <button class="btn btn-secondary" onclick="toggleAll(false)">Collapse All</button>
        <button class="btn btn-primary" onclick="copyLLMPayload()">Copy Full Payload</button>
    </div>
</div>

<div class="accordion" id="llm-accordion"></div>

<!-- Paste Response Section -->
<div class="response-section">
    <div class="response-header">
        <span class="response-title">Paste LLM Response</span>
        <button class="btn btn-secondary" onclick="pasteFromClipboard()">Paste from Clipboard</button>
    </div>
    <div class="response-hint">
        After copying the payload above and getting a response from your AI tool, paste the fix_sequence YAML or optimized SQL here.
    </div>
    <textarea id="llm-response" class="response-textarea" placeholder="Paste LLM response here...

Expected format:

```yaml
fix_sequence:
  - step: 1
    description: &quot;Fix description&quot;
    patches:
      - search: |
          original code
        replace: |
          new code
```

Or just paste the optimized SQL directly."></textarea>
    <div class="response-actions">
        <button class="btn btn-success" onclick="validateResponse()">Validate Response</button>
        <button class="btn btn-secondary" onclick="clearResponse()">Clear</button>
    </div>
</div>

<footer class="footer">
    <div><strong>Query Torque</strong> ¬∑ Audit Report v8.0</div>
    <div class="footer-actions">
        <button class="footer-action" onclick="copyLLMPayload()">Copy LLM Payload</button>
        <button class="footer-action" onclick="copyJSON()">Copy JSON</button>
    </div>
</footer>

</div>

<div class="toast" id="toast"></div>

<script>
const data = JSON.parse(document.getElementById('qt-audit-data').textContent);

// Utility functions
function fmt(num, decimals = 0) {
    if (num === undefined || num === null) return '‚Äî';
    return Number(num).toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}
function fmtMs(ms) {
    if (ms === undefined || ms === null) return '‚Äî';
    if (ms >= 1000) return fmt(ms / 1000, 1) + 's';
    return fmt(ms, ms < 10 ? 1 : 0) + 'ms';
}
function fmtMoney(val) {
    if (val === undefined || val === null) return '‚Äî';
    return '$' + fmt(val, 0);
}
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Build line patterns map
const linePatterns = {};
const issues = data.issues || [];
issues.forEach(issue => {
    const line = issue.line || (issue.location && issue.location.line);
    if (line) {
        if (!linePatterns[line]) linePatterns[line] = [];
        linePatterns[line].push(issue.rule || issue.rule_id);
    }
});

// Render header
document.getElementById('query-id').textContent = (data.query?.name || data.filename || 'query') + ' ¬∑ ' + (data.report_id || '').substring(0, 8);
document.getElementById('header-right').innerHTML = `
    <div><strong>Report:</strong> ${data.report_id || '‚Äî'}</div>
    <div><strong>Generated:</strong> ${data.generated_date || new Date().toLocaleDateString()}</div>
    <div><strong>Dialect:</strong> ${data.query?.platform || data.platform || 'SQL'}</div>
`;

// Render verdict - score is calculated from detected issues (100 - penalties)
const summary = data.summary || {};
const score = summary.torque_score ?? null;
const hasScore = score !== null;
const scoreClass = !hasScore ? '' : score < 50 ? 'critical' : score < 70 ? 'high' : score < 90 ? 'medium' : 'pass';
const execMs = data.execution_reality?.duration_ms;
document.getElementById('verdict').innerHTML = `
    <div class="verdict-score">
        <div class="score-value ${scoreClass}">${hasScore ? score : '‚Äî'}</div>
        <div class="score-label">Torque Score</div>
    </div>
    <div class="verdict-summary">
        <div class="verdict-headline">${summary.headline || 'Query analysis complete'}</div>
        <div class="verdict-stats">
            <div class="verdict-stat"><span class="verdict-stat-value">${issues.length}</span><span class="verdict-stat-label">Issues</span></div>
            ${execMs ? `<div class="verdict-stat"><span class="verdict-stat-value high">${fmtMs(execMs)}</span><span class="verdict-stat-label">Execution</span></div>` : ''}
            ${summary.improvement_estimate ? `<div class="verdict-stat"><span class="verdict-stat-value">${summary.improvement_estimate}</span><span class="verdict-stat-label">Est. Improvement</span></div>` : ''}
        </div>
    </div>
    <div class="verdict-action">
        <button class="btn btn-primary" onclick="copyLLMPayload()">Copy LLM Payload</button>
        <button class="btn btn-secondary" onclick="downloadJSON()">Download JSON</button>
    </div>
`;

// Render cost breakdown - only show real data from backend, no fake fallbacks
const metrics = data.metrics || {};
const cost = data.cost_impact || {};
const costAnalysis = data.cost_analysis || {};

// Use real data from backend only (no hardcoded fallbacks)
const hasRealCostData = costAnalysis.current_monthly > 0 || cost.monthly_current > 0;
const monthlyCost = costAnalysis.current_monthly || cost.monthly_current || 0;
const projectedCost = costAnalysis.projected_monthly || cost.monthly_projected || null;
const savingsPct = costAnalysis.savings_pct || cost.reduction_pct || null;
const monthlySavings = costAnalysis.monthly_savings || (projectedCost !== null ? monthlyCost - projectedCost : null);
const annualSavings = costAnalysis.annual_savings || cost.annual_savings || null;

// Get execution metrics
const execTime = data.execution_reality?.duration_ms;
const cuPerRun = costAnalysis.cu_per_run || metrics.fabric_cu_cost || null;
const rowsScanned = metrics.rows_scanned;

document.getElementById('cost-breakdown').innerHTML = `
    <div class="cost-header">Optimization Impact${hasRealCostData ? '' : ' <span style="font-weight:normal;font-size:0.85em;opacity:0.7">(connect database for metrics)</span>'}</div>
    <div class="cost-grid">
        <div class="cost-item">
            <div class="cost-label">Execution Time</div>
            <div class="cost-value">${execTime ? fmtMs(execTime) : '‚Äî'}</div>
            <div class="cost-subvalue">${cuPerRun ? `${fmt(cuPerRun, 1)} CU/run` : 'Run query to measure'}</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Issues Detected</div>
            <div class="cost-value ${issues.length > 0 ? 'high' : ''}">${issues.length}</div>
            <div class="cost-subvalue">${issues.filter(i => i.severity === 'critical' || i.severity === 'high').length} high priority</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Est. Monthly Savings</div>
            <div class="cost-value ${monthlySavings ? 'savings' : ''}">${monthlySavings ? fmtMoney(monthlySavings) : '‚Äî'}</div>
            <div class="cost-subvalue">${savingsPct ? `~${savingsPct}% reduction` : 'Based on typical fixes'}</div>
        </div>
        <div class="cost-item cost-divider">
            <div class="cost-label">Est. Annual Savings</div>
            <div class="cost-value ${annualSavings ? 'savings' : ''}">${annualSavings ? fmtMoney(annualSavings) : '‚Äî'}</div>
            <div class="cost-subvalue">${rowsScanned ? `${fmt(rowsScanned)} rows scanned` : 'Projected estimate'}</div>
        </div>
    </div>
`;

// Section definitions
const schemaMap = data.schema_map || {};
const columns = schemaMap.columns || [];
const joins = schemaMap.joins || [];
const execReality = data.execution_reality || {};
const source = data.source || {};

const sections = [
    {num: 1, title: 'Constraints', subtitle: 'What must be preserved', render: renderConstraints},
    {num: 2, title: 'SQL', subtitle: `${(source.sql || '').split('\n').length} lines`, render: renderSQL},
    {num: 3, title: 'Execution Plan', subtitle: execReality.duration_ms ? fmtMs(execReality.duration_ms) : 'Analysis', render: renderExecutionPlan},
    {num: 4, title: 'DAG', subtitle: 'Query structure', render: renderDAG},
    {num: 5, title: 'Schema', subtitle: `${columns.length} columns`, render: renderSchema},
    {num: 6, title: 'Anti-Patterns', subtitle: `${issues.length} detected`, render: renderAntiPatterns},
    {num: 7, title: 'Output Format', subtitle: 'Sequenced steps', render: renderOutputFormat}
];

document.getElementById('llm-meta').textContent = `7 sections ¬∑ ${issues.length} issues`;

function renderAccordion() {
    document.getElementById('llm-accordion').innerHTML = sections.map(s => `
        <div class="accordion-item${s.num === 2 ? ' open' : ''}" data-section="${s.num}">
            <div class="accordion-header" onclick="toggleSection(${s.num})">
                <div class="accordion-header-left">
                    <span class="accordion-num">${s.num}</span>
                    <span class="accordion-title">${s.title}</span>
                    <span class="accordion-subtitle">${s.subtitle}</span>
                </div>
                <span class="accordion-chevron">‚ñº</span>
            </div>
            <div class="accordion-content">${s.render()}</div>
        </div>
    `).join('');
}

function renderConstraints() {
    const constraints = data.constraints || {};
    const preserve = constraints.preserve || {};
    const permitted = constraints.permitted || [];
    const forbidden = constraints.forbidden || [];
    const features = constraints.query_features || {};

    // Build output columns display
    const outputCols = preserve.output_columns || [];
    const colsDisplay = outputCols.length > 0
        ? outputCols.slice(0, 5).map(c => '<code>' + c + '</code>').join(', ') + (outputCols.length > 5 ? '...' : '')
        : '<code>*</code>';

    // Build row count display
    const rowCount = preserve.row_count;
    const rowTolerance = preserve.row_tolerance || 0;
    const rowDisplay = rowCount !== null && rowCount !== undefined
        ? `${fmt(rowCount)} ¬± ${rowTolerance}`
        : 'Must match original ¬± 0';

    // Build sort order display
    const sortOrder = preserve.sort_order || 'none';
    const sortDisplay = sortOrder !== 'none'
        ? `<code>${sortOrder}</code>`
        : 'No ordering required';

    // Build permitted list
    const permittedHtml = permitted.length > 0
        ? permitted.map(p => `<span class="content-tag permitted">‚úì</span> ${p}`).join('<br>')
        : '<span class="content-tag permitted">‚úì</span> Standard query rewrites';

    // Build forbidden list
    const forbiddenHtml = forbidden.length > 0
        ? forbidden.map(f => `<span class="content-tag forbidden">‚úó</span> ${f}`).join('<br>')
        : '<span class="content-tag forbidden">‚úó</span> Changes affecting output';

    // Build features summary if available
    let featuresHtml = '';
    if (features.has_aggregation || features.has_window || features.has_distinct || features.cte_count > 0) {
        const featureList = [];
        if (features.has_aggregation) featureList.push('Aggregation');
        if (features.has_window) featureList.push('Window functions');
        if (features.has_distinct) featureList.push('DISTINCT');
        if (features.has_union) featureList.push('UNION');
        if (features.cte_count > 0) featureList.push(`${features.cte_count} CTE(s)`);
        featuresHtml = `<div class="content-row"><span class="content-label">Query features:</span><span class="content-value">${featureList.join(', ')}</span></div>`;
    }

    return `
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Must Preserve</div>
            <div class="content-row"><span class="content-label">Output columns:</span><span class="content-value">${colsDisplay}</span></div>
            <div class="content-row"><span class="content-label">Row count:</span><span class="content-value">${rowDisplay}</span></div>
            <div class="content-row"><span class="content-label">Sort order:</span><span class="content-value">${sortDisplay}</span></div>
            ${featuresHtml}
        </div>
        <div style="margin-bottom: 1rem;">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Permitted Transformations</div>
            ${permittedHtml}
        </div>
        <div>
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Forbidden Transformations</div>
            ${forbiddenHtml}
        </div>
    `;
}

function renderSQL() {
    const sql = source.sql || data.query?.raw_sql || '';
    const lines = sql.split('\n');
    const html = lines.map((line, i) => {
        const lineNum = i + 1;
        const markers = linePatterns[lineNum];
        const hasIssue = markers && markers.length > 0;
        return `<div class="sql-line${hasIssue ? ' has-issue' : ''}"><span class="sql-ln">${lineNum}</span><span class="sql-code">${escapeHtml(line)}</span>${hasIssue ? '<span class="sql-marker">‚Üê [' + markers.join(', ') + ']</span>' : ''}</div>`;
    }).join('');
    return `<div class="sql-block"><div class="sql-block-header"><span>${data.filename || 'query.sql'}</span><span>${data.report_id || ''}</span></div><div class="sql-block-content">${html}</div></div>`;
}

function renderExecutionPlan() {
    const ops = execReality.top_operators || [];
    const scans = execReality.full_scans || [];
    const cardinality = execReality.cardinality || [];
    const planTree = execReality.plan_tree || [];
    const bottleneck = execReality.bottleneck;
    const warnings = execReality.warnings || [];
    const hasComparison = execReality.has_comparison;
    let html = '';

    // Performance comparison section (when available)
    if (hasComparison && execReality.original_time_ms && execReality.duration_after_ms) {
        const improvement = execReality.improvement_percent || 0;
        const speedup = execReality.speedup_ratio || 1;
        const isImproved = improvement < 0;
        html += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-surface); border-radius: 8px; border-left: 4px solid ${isImproved ? 'var(--ok)' : 'var(--high)'};">`;
        html += `<div style="font-weight: 600; margin-bottom: 0.75rem;">Performance Comparison</div>`;
        html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">`;
        html += `<div><div style="font-size: 0.75rem; color: var(--fg-muted); text-transform: uppercase;">Original</div><div style="font-size: 1.25rem; font-weight: 600;">${fmtMs(execReality.original_time_ms)}</div></div>`;
        html += `<div><div style="font-size: 0.75rem; color: var(--fg-muted); text-transform: uppercase;">Optimized</div><div style="font-size: 1.25rem; font-weight: 600; color: var(--ok);">${fmtMs(execReality.duration_after_ms)}</div></div>`;
        html += `<div><div style="font-size: 0.75rem; color: var(--fg-muted); text-transform: uppercase;">Speedup</div><div style="font-size: 1.25rem; font-weight: 600; color: ${isImproved ? 'var(--ok)' : 'var(--high)'};">${speedup.toFixed(1)}√ó</div></div>`;
        html += `</div></div>`;
    }

    // Bottleneck alert (primary performance issue)
    if (bottleneck && bottleneck.operator) {
        html += `<div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(239, 68, 68, 0.08); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">`;
        html += `<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">`;
        html += `<span style="font-size: 1.25rem;">üéØ</span>`;
        html += `<span style="font-weight: 600; color: var(--high);">Primary Bottleneck</span>`;
        html += `<code style="background: var(--bg-elevated); padding: 0.25rem 0.5rem; border-radius: 4px;">${bottleneck.operator}</code>`;
        if (bottleneck.cost_pct) html += `<span class="status-badge error">${fmt(bottleneck.cost_pct, 0)}% cost</span>`;
        html += `</div>`;
        if (bottleneck.suggestion || bottleneck.detail) {
            html += `<div style="color: var(--fg-muted); font-size: 0.9rem; margin-left: 2rem;">${bottleneck.suggestion || bottleneck.detail}</div>`;
        }
        html += `</div>`;
    }

    // Plan warnings
    if (warnings.length) {
        html += '<div style="margin-bottom: 1.5rem;">';
        html += '<div style="font-weight: 600; margin-bottom: 0.75rem;">Plan Warnings</div>';
        html += '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
        warnings.forEach(w => {
            html += `<div style="display: flex; align-items: flex-start; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(245, 158, 11, 0.1); border-radius: 4px; border-left: 3px solid var(--medium);">`;
            html += `<span style="color: var(--medium);">‚ö†</span>`;
            html += `<span style="font-size: 0.9rem;">${w}</span>`;
            html += `</div>`;
        });
        html += '</div></div>';
    }

    // Full table scans warning
    if (scans.length) {
        html += '<div style="margin-bottom: 1.5rem; padding: 0.75rem 1rem; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid var(--high);">';
        html += '<div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--high);">Full Table Scans Detected</div>';
        html += '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
        scans.forEach(t => { html += `<span class="status-badge error">${t}</span>`; });
        html += '</div></div>';
    }

    // Execution plan tree (visual hierarchy)
    if (planTree.length) {
        html += '<div style="margin-bottom: 1.5rem;">';
        html += '<div style="font-weight: 600; margin-bottom: 0.75rem;">Execution Plan Tree</div>';
        html += '<div style="font-family: monospace; font-size: 0.85rem; background: var(--bg-surface); border-radius: 6px; padding: 1rem; overflow-x: auto;">';
        planTree.forEach(node => {
            const indent = '  '.repeat(node.indent || 0);
            const prefix = node.indent > 0 ? '‚îî‚îÄ ' : '';
            const isBottleneck = node.is_bottleneck || node.problem;
            const costPct = node.cost_pct || 0;
            const costColor = costPct > 50 ? 'var(--high)' : costPct > 25 ? 'var(--medium)' : 'var(--fg-muted)';

            html += `<div style="white-space: nowrap;${isBottleneck ? ' background: rgba(239, 68, 68, 0.1); margin: 0 -1rem; padding: 0.25rem 1rem;' : ''}">`;
            html += `<span style="color: var(--fg-muted);">${indent}${prefix}</span>`;
            html += `<span style="font-weight: ${isBottleneck ? '600' : '500'}; color: ${isBottleneck ? 'var(--high)' : 'var(--fg)'};">${node.operator}</span>`;

            // Meta info (rows, timing, cost)
            const metaParts = [];
            if (node.rows > 0) metaParts.push(`${fmt(node.rows, 0)} rows`);
            if (node.timing_ms > 0) metaParts.push(fmtMs(node.timing_ms));
            if (costPct > 0) metaParts.push(`<span style="color: ${costColor};">${fmt(costPct, 1)}%</span>`);
            if (node.spill) metaParts.push('<span style="color: var(--high);">SPILL</span>');
            if (node.pruning_ratio) metaParts.push(`<span style="color: var(--ok);">${node.pruning_ratio}% pruned</span>`);

            if (metaParts.length) {
                html += ` <span style="color: var(--fg-muted); font-size: 0.8rem;">(${metaParts.join(' | ')})</span>`;
            }
            html += '</div>';
        });
        html += '</div></div>';
    }

    // Top operators with visual cost bars (only show if no plan tree, or as summary)
    if (ops.length && !planTree.length) {
        html += '<div style="margin-bottom: 1.5rem;"><div style="font-weight: 600; margin-bottom: 0.75rem;">Top Operators <span style="font-weight: 400; color: var(--fg-muted); font-size: 0.85rem;">(80% of execution time)</span></div>';
        html += '<table class="data-table"><tr><th>Operator</th><th style="width: 120px;">Cost</th><th style="width: 80px;">Time</th></tr>';
        ops.forEach(op => {
            const pct = op.pct || 0;
            const barColor = pct > 50 ? 'var(--high)' : pct > 25 ? 'var(--medium)' : 'var(--ok)';
            html += `<tr>`;
            html += `<td><code>${op.operator}</code></td>`;
            html += `<td><div style="display: flex; align-items: center; gap: 0.5rem;"><div style="flex: 1; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden;"><div style="width: ${pct}%; height: 100%; background: ${barColor};"></div></div><span style="min-width: 36px; text-align: right;">${fmt(pct, 0)}%</span></div></td>`;
            html += `<td style="text-align: right;">${fmtMs(op.time_ms)}</td>`;
            html += `</tr>`;
        });
        html += '</table></div>';
    }

    // Cardinality (row counts) - show as collapsible if plan tree is shown
    if (cardinality.length) {
        html += '<div style="margin-bottom: 1.5rem;"><div style="font-weight: 600; margin-bottom: 0.75rem;">Row Cardinality</div>';
        html += '<table class="data-table"><tr><th>Operator</th><th style="width: 100px; text-align: right;">Rows</th></tr>';
        cardinality.forEach(c => {
            html += `<tr><td><code>${c.operator}</code></td><td style="text-align: right;">${fmt(c.rows, 0)}</td></tr>`;
        });
        html += '</table></div>';
    }

    // Summary metrics
    html += '<div style="display: flex; gap: 2rem; padding-top: 0.75rem; border-top: 1px solid var(--border);">';
    html += `<div class="content-row" style="flex: 1;"><span class="content-label">Total Execution Time:</span><span class="content-value">${fmtMs(execReality.duration_ms)}</span></div>`;
    if (planTree.length) {
        html += `<div class="content-row" style="flex: 1;"><span class="content-label">Plan Nodes:</span><span class="content-value">${planTree.length}</span></div>`;
    } else if (ops.length) {
        html += `<div class="content-row" style="flex: 1;"><span class="content-label">Top Operators:</span><span class="content-value">${ops.length}</span></div>`;
    }
    if (scans.length) {
        html += `<div class="content-row" style="flex: 1;"><span class="content-label">Table Scans:</span><span class="content-value" style="color: var(--high);">${scans.length}</span></div>`;
    }
    html += '</div>';

    return html || '<p style="color: var(--fg-muted);">No execution plan data available. Connect to a database to see execution metrics.</p>';
}

function renderDAG() {
    let html = '';
    const ctes = schemaMap.cte_chain || [];
    const cteDeps = schemaMap.cte_dependencies || [];
    const tables = schemaMap.tables || [];

    // Show execution order if we have CTEs
    if (ctes.length > 1) {
        const orderStr = ctes.map(c => c.name).filter(n => n !== 'final').join(' ‚Üí ');
        if (orderStr) {
            html += `<div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-sm);">
                <span style="font-weight: 500; font-size: 0.75rem; text-transform: uppercase; color: var(--fg-muted);">Execution Order:</span>
                <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; margin-left: 0.5rem;">${orderStr}</span>
            </div>`;
        }
    }

    // Query blocks (CTEs)
    if (ctes.length) {
        html += '<div style="margin-bottom: 1rem;"><div style="font-weight: 600; margin-bottom: 0.5rem;">Query Blocks (CTEs & Subqueries)</div><table class="data-table"><tr><th>Block</th><th>Output Columns</th></tr>';
        ctes.forEach(c => {
            const cols = c.columns || '‚Äî';
            html += `<tr><td><code style="font-weight: 500;">${c.name}</code></td><td>${cols}</td></tr>`;
        });
        html += '</table></div>';
    }

    // CTE Dependencies
    if (cteDeps.length) {
        html += '<div style="margin-bottom: 1rem;"><div style="font-weight: 600; margin-bottom: 0.5rem;">Data Dependencies</div><table class="data-table"><tr><th>From ‚Üí To</th><th>Type</th></tr>';
        cteDeps.forEach(d => {
            html += `<tr><td><code>${d.from}</code> ‚Üí <code>${d.to}</code></td><td><span class="status-badge ok">data flow</span></td></tr>`;
        });
        html += '</table></div>';
    }

    // Join cardinalities
    if (joins.length) {
        html += '<div style="margin-bottom: 1rem;"><div style="font-weight: 600; margin-bottom: 0.5rem;">Join Cardinalities</div><table class="data-table"><tr><th>Join Condition</th><th>Type</th><th>Cardinality</th><th>Risk</th></tr>';
        joins.forEach(j => {
            const cardinality = j.cardinality || (j.type === 'CROSS' ? 'N:M' : '1:N');
            const riskClass = j.problem ? 'error' : j.ok ? 'ok' : 'warn';
            const riskLabel = j.problem ? 'danger' : j.ok ? 'safe' : 'check';
            html += `<tr><td><code>${j.left}</code> ‚Üí <code>${j.right}</code></td><td>${j.type}</td><td><span class="status-badge ${cardinality === 'N:M' ? 'warn' : 'ok'}">${cardinality}</span></td><td><span class="status-badge ${riskClass}">${riskLabel}</span></td></tr>`;
        });
        html += '</table></div>';
    }

    // Table access stats
    if (tables.length) {
        html += '<div><div style="font-weight: 600; margin-bottom: 0.5rem;">Table Access Count</div><table class="data-table"><tr><th>Table</th><th>Rows</th><th>Status</th></tr>';
        tables.forEach(t => {
            const rowCount = t.row_count ? t.row_count.toLocaleString() : '‚Äî';
            html += `<tr><td><code>${t.name}</code></td><td>${rowCount}</td><td><span class="status-badge ok">‚úì</span></td></tr>`;
        });
        html += '</table></div>';
    }

    return html || '<p style="color: var(--fg-muted);">No DAG data available. The query structure could not be parsed.</p>';
}

function renderSchema() {
    if (!columns.length) return '<p>No schema data available.</p>';
    let html = '<div style="font-weight: 600; margin-bottom: 0.5rem;">Output Columns</div><table class="data-table"><tr><th>Column</th><th>Type</th><th>Notes</th></tr>';
    columns.forEach(c => { html += `<tr><td><code>${c.name}</code></td><td>${c.type || '‚Äî'}</td><td>${c.note || ''}</td></tr>`; });
    return html + '</table>';
}

function renderAntiPatterns() {
    if (!issues.length) return '<p>No anti-patterns detected.</p>';
    let html = '<table class="data-table"><tr><th>ID</th><th>Severity</th><th>Pattern</th><th>Line</th></tr>';
    issues.forEach(i => {
        const sev = i.severity || 'medium';
        const line = i.line || (i.location && i.location.line) || '‚Äî';
        html += `<tr><td><code>${i.rule || i.rule_id}</code></td><td><span class="severity-badge ${sev}">${sev}</span></td><td>${i.title}</td><td>${line}</td></tr>`;
    });
    html += '</table><div style="margin-top: 1rem;"><div style="font-weight: 600; margin-bottom: 0.5rem;">Suggested Fixes</div>';
    issues.forEach(i => {
        const fix = i.fix?.after || i.suggestion || 'Review and refactor';
        html += `<div class="fix-item"><span class="fix-id">${i.rule || i.rule_id}</span><span class="fix-text">${fix}</span></div>`;
    });
    return html + '</div>';
}

function renderOutputFormat() {
    return `<div style="margin-bottom: 0.75rem; color: var(--fg-muted);">Return fixes as <strong>sequenced steps</strong>. Each step is validated before proceeding.</div>
<div class="yaml-block">fix_sequence:
  - step: 1
    description: "Brief description"
    targets:
      anti_patterns: [SQL-XXX]
      lines: [start, end]
    patches:
      - search: |
          &lt;exact text to find&gt;
        replace: |
          &lt;replacement text&gt;
    checkpoint:
      must_compile: true

  - step: 2
    depends_on: [1]
    description: "Next fix"
    ...</div>`;
}

// Toggle functions
function toggleSection(num) {
    document.querySelector(`.accordion-item[data-section="${num}"]`).classList.toggle('open');
}
function toggleAll(open) {
    document.querySelectorAll('.accordion-item').forEach(item => {
        item.classList[open ? 'add' : 'remove']('open');
    });
}

// Utility functions
function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}
function copyJSON() {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => showToast('JSON copied!'));
}
function downloadJSON() {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${data.report_id || 'audit'}.json`;
    a.click();
}

function copyLLMPayload() {
    // Use pre-generated payload from backend (single source of truth)
    const payload = document.getElementById('qt-llm-payload').textContent;

    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(payload)
            .then(() => showToast('LLM Payload copied!'))
            .catch(() => fallbackCopy(payload));
    } else {
        fallbackCopy(payload);
    }
}

function fallbackCopy(text) {
    // Fallback: create textarea, select, and copy
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.left = '-9999px';
    textarea.style.top = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    try {
        const success = document.execCommand('copy');
        if (success) {
            showToast('LLM Payload copied!');
        } else {
            showPayloadModal(text);
        }
    } catch (err) {
        showPayloadModal(text);
    }

    document.body.removeChild(textarea);
}

function showPayloadModal(text) {
    // If all copy methods fail, show a modal with the text to manually copy
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999;padding:2rem;';
    modal.innerHTML = \`
        <div style="background:var(--bg-card);border-radius:var(--radius);max-width:800px;width:100%;max-height:80vh;display:flex;flex-direction:column;">
            <div style="padding:1rem 1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
                <span style="font-weight:600;">Copy LLM Payload</span>
                <button onclick="this.closest('div').parentElement.remove()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--fg-muted);">&times;</button>
            </div>
            <div style="padding:1rem 1.5rem;color:var(--fg-muted);font-size:0.875rem;">
                Select all (Ctrl+A) and copy (Ctrl+C) the payload below:
            </div>
            <textarea readonly style="flex:1;margin:0 1.5rem 1.5rem;padding:1rem;font-family:'JetBrains Mono',monospace;font-size:0.75rem;border:1px solid var(--border);border-radius:var(--radius-sm);resize:none;background:var(--bg-code);color:var(--fg-code);">\${text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
        </div>
    \`;
    document.body.appendChild(modal);
    const textarea = modal.querySelector('textarea');
    textarea.focus();
    textarea.select();
}

// Response handling
function pasteFromClipboard() {
    navigator.clipboard.readText().then(text => {
        document.getElementById('llm-response').value = text;
        showToast('Pasted!');
    }).catch(() => showToast('Clipboard access denied'));
}
function clearResponse() {
    document.getElementById('llm-response').value = '';
}
function validateResponse() {
    const response = document.getElementById('llm-response').value;
    if (!response.trim()) {
        showToast('Please paste a response first');
        return;
    }
    // Send response to parent window (web UI) for validation
    if (window.parent !== window) {
        window.parent.postMessage({
            type: 'qt-llm-response',
            response: response
        }, '*');
        showToast('Sending to validator...');
    } else {
        // Standalone mode
        showToast('Response captured! Use web UI for full validation.');
        console.log('LLM Response:', response);
    }
}

// Initialize
renderAccordion();
</script>

</body>
</html>
