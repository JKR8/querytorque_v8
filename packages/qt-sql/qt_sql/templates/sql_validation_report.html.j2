<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Query Torque | Validation Report</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
:root {
    --bg: #fafafa;
    --bg-card: #ffffff;
    --bg-code: #1e1e2e;
    --fg: #18181b;
    --fg-muted: #71717a;
    --fg-code: #cdd6f4;
    --border: #e4e4e7;
    --border-strong: #d4d4d8;

    --pass: #16a34a;
    --pass-bg: #f0fdf4;
    --fail: #dc2626;
    --fail-bg: #fef2f2;
    --warn: #ca8a04;
    --warn-bg: #fefce8;

    --tier-1: #6d28d9;
    --tier-1-bg: #f5f3ff;

    --radius: 8px;
    --radius-sm: 4px;
    --shadow: 0 1px 3px rgba(0,0,0,0.05);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'DM Sans', system-ui, sans-serif; background: var(--bg); color: var(--fg); line-height: 1.6; font-size: 14px; }
code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.875em; }
.page { max-width: 1200px; margin: 0 auto; padding: 2rem; }

/* Header */
.header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border); margin-bottom: 1.5rem; }
.header-left { display: flex; flex-direction: column; gap: 0.5rem; }
.brand { display: flex; align-items: center; gap: 0.75rem; }
.brand-mark { width: 36px; height: 36px; background: linear-gradient(135deg, #6d28d9 0%, #a855f7 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.brand-mark svg { width: 20px; height: 20px; }
.brand-text { font-weight: 700; font-size: 1.125rem; letter-spacing: -0.02em; }
.brand-tag { font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.125rem 0.5rem; border-radius: 4px; margin-left: 0.5rem; }
.brand-tag.validation { background: var(--tier-1-bg); color: var(--tier-1); }
.brand-tag.pass { background: var(--pass-bg); color: var(--pass); }
.brand-tag.fail { background: var(--fail-bg); color: var(--fail); }
.query-id { font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; color: var(--fg-muted); }
.header-right { text-align: right; font-size: 0.8125rem; color: var(--fg-muted); line-height: 1.7; }
.header-right strong { color: var(--fg); font-weight: 600; }

/* Verdict - the human summary bar */
.verdict { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
.verdict.pass { border-left: 4px solid var(--pass); }
.verdict.fail { border-left: 4px solid var(--fail); }

.verdict-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.verdict-status { display: flex; align-items: center; gap: 1rem; }
.status-badge-large { display: flex; align-items: center; gap: 0.5rem; font-size: 1.25rem; font-weight: 700; }
.status-badge-large.pass { color: var(--pass); }
.status-badge-large.fail { color: var(--fail); }
.status-icon { font-size: 1.5rem; }
.verdict-actions { display: flex; gap: 0.5rem; }
.btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.8125rem; font-weight: 500; border-radius: var(--radius-sm); border: none; cursor: pointer; transition: all 0.15s; text-decoration: none; }
.btn-primary { background: var(--tier-1); color: white; }
.btn-primary:hover { background: #5b21b6; }
.btn-secondary { background: var(--bg); color: var(--fg); border: 1px solid var(--border); }
.btn-secondary:hover { border-color: var(--border-strong); }
.btn-success { background: var(--pass); color: white; }

.verdict-metrics { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border); }
.verdict-metric { text-align: center; }
.verdict-metric-value { font-size: 1.75rem; font-weight: 700; line-height: 1.2; }
.verdict-metric-value.savings { color: var(--pass); }
.verdict-metric-value.improved { color: var(--pass); }
.verdict-metric-label { font-size: 0.75rem; color: var(--fg-muted); margin-top: 0.25rem; }
.verdict-metric-detail { font-size: 0.7rem; color: var(--fg-muted); }

/* Section Divider */
.section-divider { border-top: 2px solid var(--tier-1); margin: 2rem 0 1.5rem 0; padding-top: 1rem; }
.section-divider-label { display: inline-block; background: var(--tier-1); color: white; font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.25rem 0.75rem; border-radius: 3px; margin-bottom: 0.5rem; }
.section-divider-title { font-size: 1.125rem; font-weight: 700; }
.section-divider-desc { font-size: 0.8125rem; color: var(--fg-muted); margin-top: 0.25rem; }

/* LLM Section Header */
.llm-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.llm-header-left { display: flex; align-items: center; gap: 1rem; }
.llm-title { font-weight: 600; color: var(--fg); }
.llm-meta { font-size: 0.75rem; color: var(--fg-muted); }
.llm-actions { display: flex; gap: 0.5rem; }

/* Accordion */
.accordion { border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: var(--bg-card); }
.accordion-item { border-bottom: 1px solid var(--border); }
.accordion-item:last-child { border-bottom: none; }

.accordion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    cursor: pointer;
    background: var(--bg-card);
    transition: background 0.15s;
    user-select: none;
}
.accordion-header:hover { background: var(--bg); }
.accordion-item.open .accordion-header { background: var(--bg); border-bottom: 1px solid var(--border); }

.accordion-header-left { display: flex; align-items: center; gap: 0.75rem; }
.accordion-num {
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    border-radius: 4px;
}
.accordion-num.pass { background: var(--pass-bg); color: var(--pass); }
.accordion-num.fail { background: var(--fail-bg); color: var(--fail); }
.accordion-num.info { background: var(--tier-1-bg); color: var(--tier-1); }
.accordion-title { font-weight: 600; font-size: 0.875rem; }
.accordion-subtitle { font-size: 0.75rem; color: var(--fg-muted); margin-left: 0.5rem; }

.accordion-header-right { display: flex; align-items: center; gap: 0.75rem; }
.accordion-badge { font-size: 0.625rem; font-weight: 700; padding: 0.125rem 0.375rem; border-radius: 3px; text-transform: uppercase; }
.accordion-badge.pass { background: var(--pass-bg); color: var(--pass); }
.accordion-badge.fail { background: var(--fail-bg); color: var(--fail); }
.accordion-chevron {
    color: var(--fg-muted);
    transition: transform 0.2s;
    font-size: 0.75rem;
}
.accordion-item.open .accordion-chevron { transform: rotate(180deg); }

.accordion-content {
    display: none;
    padding: 1rem;
    background: var(--bg);
    font-size: 0.8125rem;
}
.accordion-item.open .accordion-content { display: block; }

/* Content Styling */
.content-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; }
.content-label { color: var(--fg-muted); min-width: 140px; }
.content-value { font-weight: 500; }
.content-value code { background: var(--bg-card); padding: 0.125rem 0.375rem; border-radius: 3px; font-size: 0.75rem; }

/* Data Tables */
.data-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 0.5rem; }
.data-table th {
    text-align: left;
    padding: 0.5rem 0.625rem;
    font-size: 0.625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--fg-muted);
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.data-table td {
    padding: 0.5rem 0.625rem;
    border-bottom: 1px solid var(--border);
    vertical-align: top;
}
.data-table tr:last-child td { border-bottom: none; }
.data-table code { font-size: 0.6875rem; background: var(--bg-card); padding: 0.125rem 0.25rem; border-radius: 2px; }

.status-badge {
    display: inline-block;
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.125rem 0.375rem;
    border-radius: 3px;
}
.status-badge.pass { background: var(--pass-bg); color: var(--pass); }
.status-badge.fail { background: var(--fail-bg); color: var(--fail); }
.status-badge.warn { background: var(--warn-bg); color: var(--warn); }

/* SQL Block */
.sql-block {
    background: var(--bg-code);
    border-radius: var(--radius-sm);
    overflow: hidden;
    margin-top: 0.5rem;
}
.sql-block-header {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0.75rem;
    background: rgba(0,0,0,0.3);
    font-size: 0.6875rem;
    color: #a6adc8;
}
.sql-block-content {
    padding: 0.75rem;
    overflow-x: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    line-height: 1.7;
    color: var(--fg-code);
    white-space: pre;
}

/* Diff styling */
.diff-block { background: var(--bg-code); border-radius: var(--radius-sm); overflow: hidden; margin-top: 0.5rem; }
.diff-header { display: flex; justify-content: space-between; padding: 0.5rem 0.75rem; background: rgba(0,0,0,0.3); font-size: 0.6875rem; color: #a6adc8; }
.diff-content { padding: 0.75rem; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; line-height: 1.7; }
.diff-line { display: flex; }
.diff-line.added { background: rgba(22, 163, 74, 0.15); color: #86efac; }
.diff-line.removed { background: rgba(220, 38, 38, 0.15); color: #fca5a5; }
.diff-line.context { color: var(--fg-code); }
.diff-marker { width: 20px; text-align: center; user-select: none; }
.diff-text { flex: 1; white-space: pre; }

/* Learning card */
.learning-card { background: var(--pass-bg); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 1rem; border-left: 3px solid var(--pass); }
.learning-card.warn { background: var(--warn-bg); border-left-color: var(--warn); }
.learning-card.fail { background: var(--fail-bg); border-left-color: var(--fail); }
.learning-card-title { font-weight: 600; margin-bottom: 0.5rem; }

/* Footer */
.footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1.5rem; border-top: 1px solid var(--border); margin-top: 2rem; font-size: 0.8125rem; color: var(--fg-muted); }
.footer-actions { display: flex; gap: 1rem; }
.footer-action { color: var(--tier-1); cursor: pointer; background: none; border: none; font-size: 0.8125rem; }
.footer-action:hover { text-decoration: underline; }

/* Toast */
.toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-code); color: var(--fg-code); padding: 0.75rem 1.5rem; border-radius: var(--radius); font-weight: 500; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transition: all 0.3s; z-index: 1000; }
.toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

#qt-validation-data { display: none; }
    </style>
</head>
<body>

<!-- Machine-Readable JSON -->
<script type="application/json" id="qt-validation-data">
{{ json_data | safe }}
</script>

<div class="page">

<!-- Header -->
<header class="header">
    <div class="header-left">
        <div class="brand">
            <div class="brand-mark">
                <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <span class="brand-text">Query Torque</span>
            <span class="brand-tag validation">Validation</span>
            <span class="brand-tag {{ 'pass' if overall_status == 'pass' else 'fail' }}" id="status-tag">{{ 'PASS' if overall_status == 'pass' else 'FAIL' }}</span>
        </div>
        <div class="query-id">{{ query_name or 'query' }} · {{ hash_before[:8] if hash_before else '?' }} → {{ hash_after[:8] if hash_after else '?' }}</div>
    </div>
    <div class="header-right">
        <div><strong>Report:</strong> {{ report_id or 'QT-VAL-' ~ now }}</div>
        <div><strong>Audit Ref:</strong> {{ audit_ref or '—' }}</div>
        <div><strong>Validated:</strong> {{ validated_at or now }}</div>
    </div>
</header>

<!-- HUMAN SECTION: The money bar -->

<div class="verdict {{ 'pass' if overall_status == 'pass' else 'fail' }}" id="verdict-container">
    <div class="verdict-top">
        <div class="verdict-status">
            <div class="status-badge-large {{ 'pass' if overall_status == 'pass' else 'fail' }}" id="status-display">
                <span class="status-icon">{{ '✓' if overall_status == 'pass' else '✗' }}</span>
                <span>{{ 'VALIDATED' if overall_status == 'pass' else 'FAILED' }}</span>
            </div>
            <span style="color: var(--fg-muted); font-size: 0.875rem;">
                {% if overall_status == 'pass' %}
                All checks passed · Ready for deployment
                {% else %}
                {{ validation_errors | length }} issue(s) detected · Review required
                {% endif %}
            </span>
        </div>
        <div class="verdict-actions">
            {% if overall_status == 'pass' %}
            <button class="btn btn-success" onclick="copySQL()">Copy Optimized SQL</button>
            {% endif %}
            <button class="btn btn-secondary" onclick="copyJSON()">Copy JSON</button>
        </div>
    </div>
    <div class="verdict-metrics">
        <div class="verdict-metric">
            <div class="verdict-metric-value {{ 'savings' if execution_improvement_pct and execution_improvement_pct > 0 else '' }}">
                {% if execution_improvement_pct %}−{{ execution_improvement_pct | round(0) | int }}%{% else %}—{% endif %}
            </div>
            <div class="verdict-metric-label">Execution Time</div>
            <div class="verdict-metric-detail">
                {% if original_time_ms and optimized_time_ms %}
                {{ original_time_ms | round(1) }}ms → {{ optimized_time_ms | round(1) }}ms
                {% else %}—{% endif %}
            </div>
        </div>
        <div class="verdict-metric">
            <div class="verdict-metric-value">{{ issues_fixed | length }}</div>
            <div class="verdict-metric-label">Issues Fixed</div>
            <div class="verdict-metric-detail">of {{ original_issues | length }} detected</div>
        </div>
        <div class="verdict-metric">
            <div class="verdict-metric-value {{ 'fail' if new_issues | length > 0 else '' }}">{{ new_issues | length }}</div>
            <div class="verdict-metric-label">New Issues</div>
            <div class="verdict-metric-detail">{{ 'none introduced' if new_issues | length == 0 else 'review required' }}</div>
        </div>
        <div class="verdict-metric">
            <div class="verdict-metric-value {{ 'pass' if row_count_match else 'fail' }}">
                {% if row_count_match %}✓{% else %}✗{% endif %}
            </div>
            <div class="verdict-metric-label">Row Count</div>
            <div class="verdict-metric-detail">
                {% if original_row_count is not none and optimized_row_count is not none %}
                {{ original_row_count }} → {{ optimized_row_count }}
                {% else %}not checked{% endif %}
            </div>
        </div>
        <div class="verdict-metric">
            <div class="verdict-metric-value">{{ checks_passed }}/{{ checks_total }}</div>
            <div class="verdict-metric-label">Checks Passed</div>
            <div class="verdict-metric-detail">validation pipeline</div>
        </div>
    </div>
</div>


<!-- LLM SECTION -->

<div class="section-divider">
    <span class="section-divider-label">Validation Details</span>
    <div class="section-divider-title">Full Validation Results</div>
    <div class="section-divider-desc">Click sections to expand. Copy button captures full report as JSON.</div>
</div>

<div class="llm-header">
    <div class="llm-header-left">
        <span class="llm-title">validation-report.json</span>
        <span class="llm-meta">5 sections · {{ checks_total }} checks</span>
    </div>
    <div class="llm-actions">
        <button class="btn btn-secondary" onclick="toggleAll(true)">Expand All</button>
        <button class="btn btn-secondary" onclick="toggleAll(false)">Collapse All</button>
        <button class="btn btn-primary" onclick="copyJSON()">Copy Full Report</button>
    </div>
</div>

<div class="accordion" id="llm-accordion">
    <!-- 1. Validation Checks -->
    <div class="accordion-item open" data-section="1">
        <div class="accordion-header" onclick="toggleSection(1)">
            <div class="accordion-header-left">
                <span class="accordion-num {{ 'pass' if all_checks_passed else 'fail' }}">{{ '✓' if all_checks_passed else '✗' }}</span>
                <span class="accordion-title">Validation Checks</span>
                <span class="accordion-subtitle">{{ checks_passed }}/{{ checks_total }} passed</span>
            </div>
            <div class="accordion-header-right">
                <span class="accordion-badge {{ 'pass' if all_checks_passed else 'fail' }}">{{ 'PASS' if all_checks_passed else 'FAIL' }}</span>
                <span class="accordion-chevron">▼</span>
            </div>
        </div>
        <div class="accordion-content">
            <table class="data-table">
                <tr><th>Check</th><th>Status</th><th>Detail</th></tr>
                <tr>
                    <td><strong>Syntax</strong></td>
                    <td><span class="status-badge {{ syntax_status }}">{{ syntax_status | upper }}</span></td>
                    <td>{% if syntax_errors %}{{ syntax_errors | join(', ') }}{% else %}No syntax errors{% endif %}</td>
                </tr>
                <tr>
                    <td><strong>Schema</strong></td>
                    <td><span class="status-badge {{ schema_status }}">{{ schema_status | upper }}</span></td>
                    <td>{% if schema_violations %}{{ schema_violations | join(', ') }}{% else %}All references valid{% endif %}</td>
                </tr>
                <tr>
                    <td><strong>Regression</strong></td>
                    <td><span class="status-badge {{ regression_status }}">{{ regression_status | upper }}</span></td>
                    <td>{% if new_issues | length > 0 %}{{ new_issues | length }} new issue(s) introduced{% else %}No new issues{% endif %}</td>
                </tr>
                <tr>
                    <td><strong>Equivalence</strong></td>
                    <td><span class="status-badge {{ equivalence_status }}">{{ equivalence_status | upper }}</span></td>
                    <td>{% if equivalence_status == 'pass' %}Results match{% elif equivalence_status == 'skip' %}Not tested{% else %}Results differ{% endif %}</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- 2. Issues Fixed -->
    <div class="accordion-item" data-section="2">
        <div class="accordion-header" onclick="toggleSection(2)">
            <div class="accordion-header-left">
                <span class="accordion-num pass">{{ issues_fixed | length }}</span>
                <span class="accordion-title">Issues Fixed</span>
                <span class="accordion-subtitle">{{ issues_fixed | length }} anti-patterns resolved</span>
            </div>
            <div class="accordion-header-right">
                <span class="accordion-chevron">▼</span>
            </div>
        </div>
        <div class="accordion-content">
            {% if issues_fixed | length > 0 %}
            <table class="data-table">
                <tr><th>Rule</th><th>Severity</th><th>Description</th></tr>
                {% for issue in issues_fixed %}
                <tr>
                    <td><code>{{ issue.rule_id or issue.rule or 'UNKNOWN' }}</code></td>
                    <td><span class="status-badge {{ issue.severity or 'medium' }}">{{ (issue.severity or 'medium') | upper }}</span></td>
                    <td>{{ issue.title or issue.description or 'Issue fixed' }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <p style="color: var(--fg-muted);">No issues were fixed in this optimization.</p>
            {% endif %}
        </div>
    </div>

    <!-- 3. New Issues (if any) -->
    <div class="accordion-item" data-section="3">
        <div class="accordion-header" onclick="toggleSection(3)">
            <div class="accordion-header-left">
                <span class="accordion-num {{ 'fail' if new_issues | length > 0 else 'pass' }}">{{ new_issues | length }}</span>
                <span class="accordion-title">New Issues</span>
                <span class="accordion-subtitle">{{ 'issues introduced' if new_issues | length > 0 else 'none introduced' }}</span>
            </div>
            <div class="accordion-header-right">
                {% if new_issues | length > 0 %}
                <span class="accordion-badge fail">REVIEW</span>
                {% endif %}
                <span class="accordion-chevron">▼</span>
            </div>
        </div>
        <div class="accordion-content">
            {% if new_issues | length > 0 %}
            <div class="learning-card fail">
                <div class="learning-card-title">New Anti-Patterns Detected</div>
                <p>The optimization introduced {{ new_issues | length }} new issue(s) that were not in the original code.</p>
            </div>
            <table class="data-table">
                <tr><th>Rule</th><th>Severity</th><th>Description</th></tr>
                {% for issue in new_issues %}
                <tr>
                    <td><code>{{ issue.rule_id or issue.rule or 'UNKNOWN' }}</code></td>
                    <td><span class="status-badge {{ issue.severity or 'medium' }}">{{ (issue.severity or 'medium') | upper }}</span></td>
                    <td>{{ issue.title or issue.description or 'New issue' }}</td>
                </tr>
                {% endfor %}
            </table>
            {% else %}
            <div class="learning-card">
                <div class="learning-card-title">No New Issues</div>
                <p>The optimization did not introduce any new anti-patterns.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 4. Execution Comparison -->
    <div class="accordion-item" data-section="4">
        <div class="accordion-header" onclick="toggleSection(4)">
            <div class="accordion-header-left">
                <span class="accordion-num info">4</span>
                <span class="accordion-title">Execution Comparison</span>
                <span class="accordion-subtitle">{% if execution_improvement_pct %}{{ execution_improvement_pct | round(0) | int }}% improvement{% else %}not measured{% endif %}</span>
            </div>
            <div class="accordion-header-right">
                <span class="accordion-chevron">▼</span>
            </div>
        </div>
        <div class="accordion-content">
            {% if original_time_ms or optimized_time_ms %}
            <div style="margin-bottom: 1rem;">
                <div class="content-row">
                    <span class="content-label">Original time:</span>
                    <span class="content-value">{{ original_time_ms | round(2) if original_time_ms else '—' }}ms</span>
                </div>
                <div class="content-row">
                    <span class="content-label">Optimized time:</span>
                    <span class="content-value" style="color: var(--pass);">{{ optimized_time_ms | round(2) if optimized_time_ms else '—' }}ms{% if execution_improvement_pct %} (−{{ execution_improvement_pct | round(0) | int }}%){% endif %}</span>
                </div>
                {% if speedup_ratio %}
                <div class="content-row">
                    <span class="content-label">Speedup:</span>
                    <span class="content-value">{{ speedup_ratio | round(2) }}x faster</span>
                </div>
                {% endif %}
            </div>
            {% if original_row_count is not none %}
            <div style="margin-bottom: 1rem;">
                <div class="content-row">
                    <span class="content-label">Original rows:</span>
                    <span class="content-value">{{ original_row_count | int }}</span>
                </div>
                <div class="content-row">
                    <span class="content-label">Optimized rows:</span>
                    <span class="content-value" style="color: {{ 'var(--pass)' if row_count_match else 'var(--fail)' }};">{{ optimized_row_count | int }}{% if not row_count_match %} (MISMATCH!){% endif %}</span>
                </div>
            </div>
            {% endif %}
            {% else %}
            <p style="color: var(--fg-muted);">No execution metrics available. Connect a database for performance comparison.</p>
            {% endif %}
        </div>
    </div>

    <!-- 5. Final SQL -->
    <div class="accordion-item" data-section="5">
        <div class="accordion-header" onclick="toggleSection(5)">
            <div class="accordion-header-left">
                <span class="accordion-num info">5</span>
                <span class="accordion-title">Optimized SQL</span>
                <span class="accordion-subtitle">final query</span>
            </div>
            <div class="accordion-header-right">
                <span class="accordion-chevron">▼</span>
            </div>
        </div>
        <div class="accordion-content">
            <div style="margin-bottom: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">Optimized SQL (ready for deployment)</div>
                <div class="sql-block">
                    <div class="sql-block-header">
                        <span>{{ query_name or 'optimized.sql' }}</span>
                        <span>{{ hash_after[:8] if hash_after else '' }}</span>
                    </div>
                    <div class="sql-block-content">{{ optimized_sql }}</div>
                </div>
            </div>
            {% if llm_explanation %}
            <div style="margin-top: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem;">LLM Explanation</div>
                <p style="color: var(--fg-muted);">{{ llm_explanation }}</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="footer">
    <div><strong>Query Torque</strong> · Validation Report v1.0</div>
    <div class="footer-actions">
        <button class="footer-action" onclick="copySQL()">Copy SQL</button>
        <button class="footer-action" onclick="copyJSON()">Copy JSON</button>
    </div>
</footer>

</div>

<div class="toast" id="toast"></div>

<script>
const data = JSON.parse(document.getElementById('qt-validation-data').textContent);

// Toggle functions
function toggleSection(num) {
    const item = document.querySelector(`.accordion-item[data-section="${num}"]`);
    item.classList.toggle('open');
}

function toggleAll(open) {
    document.querySelectorAll('.accordion-item').forEach(item => {
        if (open) {
            item.classList.add('open');
        } else {
            item.classList.remove('open');
        }
    });
}

// Utilities
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}

function copyJSON() {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2))
        .then(() => showToast('JSON copied!'));
}

function copySQL() {
    navigator.clipboard.writeText(data.optimized_sql || '')
        .then(() => showToast('SQL copied!'));
}

// Initialize - open first section by default
document.addEventListener('DOMContentLoaded', function() {
    // Update UI based on status
    if (data.overall_status === 'fail') {
        document.getElementById('status-tag').className = 'brand-tag fail';
        document.getElementById('status-tag').textContent = 'FAIL';
        document.getElementById('verdict-container').className = 'verdict fail';
        document.getElementById('status-display').className = 'status-badge-large fail';
        document.getElementById('status-display').innerHTML = '<span class="status-icon">✗</span><span>FAILED</span>';
    }
});
</script>

</body>
</html>
