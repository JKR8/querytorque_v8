{"id": 1, "query_sql": "select a.ca_state state, count(*) cnt\n from customer_address a\n     ,customer c\n     ,store_sales s\n     ,date_dim d\n     ,item i\n where       a.ca_address_sk = c.c_current_addr_sk\n \tand c.c_customer_sk = s.ss_customer_sk\n \tand s.ss_sold_date_sk = d.d_date_sk\n \tand s.ss_item_sk = i.i_item_sk\n \tand d.d_month_seq = \n \t     (select distinct (d_month_seq)\n \t      from date_dim\n               where d_year = 2002\n \t        and d_moy = 3 )\n \tand i.i_current_price > 1.2 * \n             (select avg(j.i_current_price) \n \t     from item j \n \t     where j.i_category = i.i_category)\n group by a.ca_state\n having count(*) >= 10\n order by cnt, a.ca_state\n LIMIT 100;", "rewritten_sql": "WITH target_month AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2002 AND d_moy = 3), category_avg AS (SELECT i_category, AVG(i_current_price) * 1.2 AS price_threshold FROM item GROUP BY i_category)\nSELECT a.ca_state AS state, COUNT(*) AS cnt FROM customer_address AS a JOIN customer AS c ON a.ca_address_sk = c.c_current_addr_sk JOIN store_sales AS s ON c.c_customer_sk = s.ss_customer_sk JOIN date_dim AS d ON s.ss_sold_date_sk = d.d_date_sk JOIN target_month AS tm ON d.d_month_seq = tm.d_month_seq JOIN item AS i ON s.ss_item_sk = i.i_item_sk JOIN category_avg AS ca ON i.i_category = ca.i_category WHERE i.i_current_price > ca.price_threshold GROUP BY a.ca_state HAVING COUNT(*) >= 10 ORDER BY cnt, a.ca_state LIMIT 100;", "transform": "date_cte_isolate", "original_ms": 340.0, "rewritten_ms": 253.0, "ratio": 4.0, "outcome": "WIN", "declared_speedup": "4.00x", "sf10_speedup": 1.86, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select a.ca_state state, count(*) cnt  from customer_address a      ,customer c      ,store_sales s      ,date_dim d      ,item i  where       a.ca_address_sk = c.c_current_addr_sk  \tand c.c_customer_sk = s.ss_customer_sk  \tand s.ss_sold_date_sk = d.d_date_sk  \tand s.ss_item_sk = i.i_item_sk  \tand d.d_month_seq =   \t     (select distinct (d_month_seq)  \t      from date_dim                where d_year = 2002  \t        and d_moy = 3 )  \tand i.i_current_price > 1.2 *               (select avg(j.i_current_price)   \t     from item j   \t     where j.i_category = i.i_category)  group by a.ca_state  having count(*) >= 10  order by cnt, a.ca_state  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.340s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────────────┐\n│        QUERY        │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│   EXPLAIN_ANALYZE   │\n│    ──────────────   │\n│        0 Rows       │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│        TOP_N        │\n│    ──────────────   │\n│       Top: 100      │\n│                     │\n│      Order By:      │\n│   count_star() ASC  │\n│    a.ca_state ASC   │\n│                     │\n│       51 Rows       │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│        FILTER       │\n│    ──────────────   │\n│ (count_star() >= 10)│\n│                     │\n│       51 Rows       │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│      PROJECTION     │\n│    ──────────────   │\n│__internal_decompress│\n│     _string(#0)     │\n│          #1         │\n│                     │\n│       52 Rows       │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│    HASH_GROUP_BY    │\n│    ──────────────   │\n│      Groups: #0     │\n│                     │\n│     Aggregates:     │\n│     count_star()    │\n│                     │\n│       52 Rows       │\n│       (0.01s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│      PROJECTION     │\n│    ──────────────   │\n│       ca_state      │\n│                     │\n│      25108 Rows     │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│      PROJECTION     │\n│    ──────────────   │\n│          #0         │\n│          #1         │\n│__internal_compress_s│\n│  tring_uinteger(#2) │\n│                     │\n│      25108 Rows     │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│      PROJECTION     │\n│    ──────────────   │\n│          #0         │\n│          #3         │\n│          #5         │\n│                     │\n│      25108 Rows     │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│        FILTER       │\n│    ──────────────   │\n│(CAST(i_current_price│\n│  AS DOUBLE) > (1.2 *│\n│      SUBQUERY))     │\n│                     │\n│      25108 Rows     │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│   RIGHT_DELIM_JOIN  │\n│    ──────────────   │\n│      Join Type:     │\n│        RIGHT        │\n│                     │\n│     Conditions:     │\n│  i_category IS NOT  │\n│     DISTINCT FROM   ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────┐\n│      i_category     │                                                                                                                              │                                                                    │\n│                     │                                                                                                                              │                                                                    │\n│    Delim Index: 1   │                                                                                                                              │                                                                    │\n│                     │                                                                                                                              │                                                                    │\n│        0 Rows       │                                                                                                                              │                                                                    │\n│       (0.02s)       │                                                                                                                              │                                                                    │\n└──────────┬──────────┘                                                                                                                              │                                                                    │\n┌──────────┴──────────┐                                                                                                                   ┌──────────┴──────────┐                                              ┌──────────┴──────────┐\n│      HASH_JOIN      │                                                                                                                   │      HASH_JOIN      │                                              │    HASH_GROUP_BY    │\n│    ──────────────   │                                                                                                                   │    ──────────────   │                                              │    ──────────────   │\n│      Join Type:     │                                                                                                                   │      Join Type:     │                                              │      Groups: #2     │\n... (183 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH target_month AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2002 AND d_moy = 3), category_avg AS (SELECT i_category, AVG(i_current_price) * 1.2 AS price_threshold FROM item GROUP BY i_category) SELECT a.ca_state AS state, COUNT(*) AS cnt FROM customer_address AS a JOIN customer AS c ON a.ca_address_sk = c.c_current_addr_sk JOIN store_sales AS s ON c.c_customer_sk = s.ss_customer_sk JOIN date_dim AS d ON s.ss_sold_date_sk = d.d_date_sk JOIN target_month AS tm ON d.d_month_seq = tm.d_month_seq JOIN item AS i ON s.ss_item_sk = i.i_item_sk JOIN category_avg AS ca ON i.i_category = ca.i_category WHERE i.i_current_price > ca.price_threshold GROUP BY a.ca_state HAVING COUNT(*) >= 10 ORDER BY cnt, a.ca_state LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.253s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│      count_star() ASC     │\n│       a.ca_state ASC      │\n│                           │\n│          51 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           FILTER          │\n│    ────────────────────   │\n│    (count_star() >= 10)   │\n│                           │\n│          51 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│__internal_decompress_strin│\n│           g(#0)           │\n│             #1            │\n│                           │\n│          52 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│         Groups: #0        │\n│                           │\n│        Aggregates:        │\n│        count_star()       │\n│                           │\n│          52 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│          ca_state         │\n│                           │\n│         25108 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│__internal_compress_string_│\n│        uinteger(#1)       │\n│             #2            │\n│                           │\n│         25108 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│      ca_address_sk =      │\n│      c_current_addr_sk    ├──────────────┐\n│                           │              │\n│        Build Min: 1       │              │\n│     Build Max: 250000     │              │\n│                           │              │\n│         25108 Rows        │              │\n│          (0.00s)          │              │\n└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││         HASH_JOIN         │\n│    ────────────────────   ││    ────────────────────   │\n│      customer_address     ││      Join Type: INNER     │\n│                           ││                           │\n│        Projections:       ││        Conditions:        │\n│       ca_address_sk       ││      c_customer_sk =      │\n│          ca_state         ││       ss_customer_sk      ├──────────────┐\n│                           ││                           │              │\n│                           ││        Build Min: 1       │              │\n│                           ││     Build Max: 500000     │              │\n│                           ││                           │              │\n│        249936 Rows        ││         25108 Rows        │              │\n│          (0.01s)          ││          (0.01s)          │              │\n└───────────────────────────┘└─────────────┬─────────────┘              │\n                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n                             │         TABLE_SCAN        ││         HASH_JOIN         │\n                             │    ────────────────────   ││    ────────────────────   │\n                             │          customer         ││      Join Type: INNER     │\n                             │                           ││                           │\n                             │        Projections:       ││        Conditions:        │\n                             │     c_current_addr_sk     ││ss_sold_date_sk = d_date_sk│\n                             │       c_customer_sk       ││                           ├────────────────────────────────────────────────────────────────────────┐\n                             │                           ││     Build Min: 2450816    │                                                                        │\n                             │                           ││     Build Max: 2452642    │                                                                        │\n... (106 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q6", "Q11"]}
{"id": 2, "query_sql": "select * \nfrom (select i_manager_id\n             ,sum(ss_sales_price) sum_sales\n             ,avg(sum(ss_sales_price)) over (partition by i_manager_id) avg_monthly_sales\n      from item\n          ,store_sales\n          ,date_dim\n          ,store\n      where ss_item_sk = i_item_sk\n        and ss_sold_date_sk = d_date_sk\n        and ss_store_sk = s_store_sk\n        and d_month_seq in (1181,1181+1,1181+2,1181+3,1181+4,1181+5,1181+6,1181+7,1181+8,1181+9,1181+10,1181+11)\n        and ((    i_category in ('Books','Children','Electronics')\n              and i_class in ('personal','portable','reference','self-help')\n              and i_brand in ('scholaramalgamalg #14','scholaramalgamalg #7',\n\t\t                  'exportiunivamalg #9','scholaramalgamalg #9'))\n           or(    i_category in ('Women','Music','Men')\n              and i_class in ('accessories','classical','fragrances','pants')\n              and i_brand in ('amalgimporto #1','edu packscholar #1','exportiimporto #1',\n\t\t                 'importoamalg #1')))\ngroup by i_manager_id, d_moy) tmp1\nwhere case when avg_monthly_sales > 0 then abs (sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1\norder by i_manager_id\n        ,avg_monthly_sales\n        ,sum_sales\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_month_seq IN (1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1209, 1210, 1211)), filtered_sales AS (SELECT ss_item_sk, ss_store_sk, ss_sales_price, d_moy FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), first_branch AS (SELECT i_manager_id, d_moy, ss_sales_price FROM item JOIN filtered_sales ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk WHERE i_category IN ('Books', 'Children', 'Electronics') AND i_class IN ('personal', 'portable', 'reference', 'self-help') AND i_brand IN ('scholaramalgamalg #14', 'scholaramalgamalg #7', 'exportiunivamalg #9', 'scholaramalgamalg #9')), second_branch AS (SELECT i_manager_id, d_moy, ss_sales_price FROM item JOIN filtered_sales ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk WHERE i_category IN ('Women', 'Music', 'Men') AND i_class IN ('accessories', 'classical', 'fragrances', 'pants') AND i_brand IN ('amalgimporto #1', 'edu packscholar #1', 'exportiimporto #1', 'importoamalg #1')), combined_sales AS (SELECT * FROM first_branch UNION ALL SELECT * FROM second_branch)\nSELECT i_manager_id, SUM(ss_sales_price) AS sum_sales, AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manager_id) AS avg_monthly_sales FROM combined_sales GROUP BY i_manager_id, d_moy HAVING CASE WHEN AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manager_id) > 0 THEN ABS(SUM(ss_sales_price) - AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manager_id)) / AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manager_id) ELSE NULL END > 0.1 ORDER BY i_manager_id, avg_monthly_sales, sum_sales LIMIT 100;", "transform": "prefetch_fact_join", "original_ms": 392.0, "rewritten_ms": 0.0, "ratio": 3.77, "outcome": "WIN", "declared_speedup": "3.77x", "sf10_speedup": null, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select *  from (select i_manager_id              ,sum(ss_sales_price) sum_sales              ,avg(sum(ss_sales_price)) over (partition by i_manager_id) avg_monthly_sales       from item           ,store_sales           ,date_dim           ,store       where ss_item_sk = i_item_sk         and ss_sold_date_sk = d_date_sk         and ss_store_sk = s_store_sk         and d_month_seq in (1181,1181+1,1181+2,1181+3,1181+4,1181+5,1181+6,1181+7,1181+8,1181+9,1181+10,1181+11)         and ((    i_category in ('Books','Children','Electronics')               and i_class in ('personal','portable','reference','self-help')               and i_brand in ('scholaramalgamalg #14','scholaramalgamalg #7', \t\t                  'exportiunivamalg #9','scholaramalgamalg #9'))            or(    i_category in ('Women','Music','Men')               and i_class in ('accessories','classical','fragrances','pants')               and i_brand in ('amalgimporto #1','edu packscholar #1','exportiimporto #1', \t\t                 'importoamalg #1'))) group by i_manager_id, d_moy) tmp1 where case when avg_monthly_sales > 0 then abs (sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1 order by i_manager_id         ,avg_monthly_sales         ,sum_sales  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.392s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│   tmp1.i_manager_id ASC   │\n│ tmp1.avg_monthly_sales ASC│\n│     tmp1.sum_sales ASC    │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #2            │\n│             #3            │\n│                           │\n│         1180 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           FILTER          │\n│    ────────────────────   │\n│       (CASE  WHEN (       │\n│ (avg_monthly_sales > 0.0))│\n│      THEN ((abs((CAST     │\n│  (sum_sales AS DOUBLE) -  │\n│    avg_monthly_sales)) /  │\n│  avg_monthly_sales)) ELSE │\n│       NULL END > 0.1)     │\n│                           │\n│         1180 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│                           │\n│         1200 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           WINDOW          │\n│    ────────────────────   │\n│        Projections:       │\n│  avg(sum(ss_sales_price)) │\n│     OVER (PARTITION BY    │\n│        i_manager_id)      │\n│                           │\n│         1200 Rows         │\n│          (0.02s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│__internal_decompress_integ│\n│     ral_integer(#0, 1)    │\n│__internal_decompress_integ│\n│     ral_integer(#1, 1)    │\n│             #2            │\n│                           │\n│         1200 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│   PERFECT_HASH_GROUP_BY   │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│                           │\n│    Aggregates: sum(#2)    │\n│                           │\n│         1200 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        i_manager_id       │\n│           d_moy           │\n│       ss_sales_price      │\n│                           │\n│        372712 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│__internal_compress_integra│\n│  l_usmallint(#1, 2450816) │\n│__internal_compress_integra│\n... (109 more lines truncated)", "explain_rewritten": "ERROR: Binder Error: HAVING clause cannot contain window functions!\nLINE 2: ...210, 1211)), filtered_sales AS (SELECT ss_item_sk, ss_store_sk, ss_sales_price...\n                                                  ^", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q63"]}
{"id": 3, "query_sql": "select ss_customer_sk\n            ,sum(act_sales) sumsales\n      from (select ss_item_sk\n                  ,ss_ticket_number\n                  ,ss_customer_sk\n                  ,case when sr_return_quantity is not null then (ss_quantity-sr_return_quantity)*ss_sales_price\n                                                            else (ss_quantity*ss_sales_price) end act_sales\n            from store_sales left outer join store_returns on (sr_item_sk = ss_item_sk\n                                                               and sr_ticket_number = ss_ticket_number)\n                ,reason\n            where sr_reason_sk = r_reason_sk\n              and r_reason_desc = 'duplicate purchase') t\n      group by ss_customer_sk\n      order by sumsales, ss_customer_sk\n LIMIT 100;", "rewritten_sql": "WITH filtered_reason AS (SELECT r_reason_sk FROM reason WHERE r_reason_desc = 'duplicate purchase'), filtered_returns AS (SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN filtered_reason ON sr_reason_sk = r_reason_sk)\nSELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM (SELECT ss.ss_customer_sk, CASE WHEN NOT fr.sr_return_quantity IS NULL THEN (ss.ss_quantity - fr.sr_return_quantity) * ss.ss_sales_price ELSE (ss.ss_quantity * ss.ss_sales_price) END AS act_sales FROM store_sales AS ss JOIN filtered_returns AS fr ON (fr.sr_item_sk = ss.ss_item_sk AND fr.sr_ticket_number = ss.ss_ticket_number)) AS t GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100;", "transform": "early_filter", "original_ms": 682.0, "rewritten_ms": 436.0, "ratio": 4.0, "outcome": "WIN", "declared_speedup": "4.00x", "sf10_speedup": 2.97, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select ss_customer_sk             ,sum(act_sales) sumsales       from (select ss_item_sk                   ,ss_ticket_number                   ,ss_customer_sk                   ,case when sr_return_quantity is not null then (ss_quantity-sr_return_quantity)*ss_sales_price                                                             else (ss_quantity*ss_sales_price) end act_sales             from store_sales left outer join store_returns on (sr_item_sk = ss_item_sk                                                                and sr_ticket_number = ss_ticket_number)                 ,reason             where sr_reason_sk = r_reason_sk               and r_reason_desc = 'duplicate purchase') t       group by ss_customer_sk       order by sumsales, ss_customer_sk  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.682s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│    sum(t.act_sales) ASC   │\n│    t.ss_customer_sk ASC   │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│         Groups: #0        │\n│    Aggregates: sum(#1)    │\n│                           │\n│         54761 Rows        │\n│          (0.18s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│       ss_customer_sk      │\n│         act_sales         │\n│                           │\n│         61506 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│       ss_customer_sk      │\n│         act_sales         │\n│                           │\n│         61506 Rows        │\n│          (0.04s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│ sr_reason_sk = r_reason_sk│\n│                           ├───────────────────────────────────────────┐\n│        Build Min: 1       │                                           │\n│       Build Max: 45       │                                           │\n│                           │                                           │\n│         61506 Rows        │                                           │\n│          (0.11s)          │                                           │\n└─────────────┬─────────────┘                                           │\n┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐\n│         HASH_JOIN         │                             │         TABLE_SCAN        │\n│    ────────────────────   │                             │    ────────────────────   │\n│      Join Type: LEFT      │                             │           reason          │\n│                           │                             │                           │\n│        Conditions:        │                             │        Projections:       │\n│  ss_item_sk = sr_item_sk  │                             │        r_reason_sk        │\n│     ss_ticket_number =    │                             │                           │\n│      sr_ticket_number     ├──────────────┐              │          Filters:         │\n│                           │              │              │  r_reason_desc='duplicate │\n│                           │              │              │        purchase' AND      │\n│                           │              │              │  r_reason_desc IS NOT NULL│\n│                           │              │              │                           │\n│       28800991 Rows       │              │              │           1 Rows          │\n│          (4.60s)          │              │              │          (0.01s)          │\n└─────────────┬─────────────┘              │              └───────────────────────────┘\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││         TABLE_SCAN        │\n│    ────────────────────   ││    ────────────────────   │\n│        store_sales        ││       store_returns       │\n│                           ││                           │\n│        Projections:       ││        Projections:       │\n│         ss_item_sk        ││         sr_item_sk        │\n│      ss_ticket_number     ││      sr_ticket_number     │\n│       ss_customer_sk      ││        sr_reason_sk       │\n│        ss_quantity        ││     sr_return_quantity    │\n│       ss_sales_price      ││                           │\n│                           ││                           │\n│       28800991 Rows       ││        2877532 Rows       │\n│          (11.75s)         ││          (0.58s)          │\n└───────────────────────────┘└───────────────────────────┘", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_reason AS (SELECT r_reason_sk FROM reason WHERE r_reason_desc = 'duplicate purchase'), filtered_returns AS (SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN filtered_reason ON sr_reason_sk = r_reason_sk) SELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM (SELECT ss.ss_customer_sk, CASE WHEN NOT fr.sr_return_quantity IS NULL THEN (ss.ss_quantity - fr.sr_return_quantity) * ss.ss_sales_price ELSE (ss.ss_quantity * ss.ss_sales_price) END AS act_sales FROM store_sales AS ss JOIN filtered_returns AS fr ON (fr.sr_item_sk = ss.ss_item_sk AND fr.sr_ticket_number = ss.ss_ticket_number)) AS t GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.436s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│    sum(t.act_sales) ASC   │\n│    t.ss_customer_sk ASC   │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│         Groups: #0        │\n│    Aggregates: sum(#1)    │\n│                           │\n│         54761 Rows        │\n│          (0.02s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│       ss_customer_sk      │\n│         act_sales         │\n│                           │\n│         61506 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│       ss_customer_sk      │\n│         act_sales         │\n│                           │\n│         61506 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│  ss_item_sk = sr_item_sk  ├──────────────┐\n│     ss_ticket_number =    │              │\n│      sr_ticket_number     │              │\n│                           │              │\n│         61506 Rows        │              │\n│          (0.82s)          │              │\n└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││         PROJECTION        │\n│    ────────────────────   ││    ────────────────────   │\n│        store_sales        ││         sr_item_sk        │\n│                           ││      sr_ticket_number     │\n│        Projections:       ││     sr_return_quantity    │\n│         ss_item_sk        ││                           │\n│      ss_ticket_number     ││                           │\n│       ss_customer_sk      ││                           │\n│        ss_quantity        ││                           │\n│       ss_sales_price      ││                           │\n│                           ││                           │\n│          Filters:         ││                           │\n│ ss_ticket_number<=2399999 ││                           │\n│   AND ss_ticket_number IS ││                           │\n│          NOT NULL         ││                           │\n│                           ││                           │\n│       28799261 Rows       ││         61506 Rows        │\n│          (9.78s)          ││          (0.00s)          │\n└───────────────────────────┘└─────────────┬─────────────┘\n                             ┌─────────────┴─────────────┐\n                             │         HASH_JOIN         │\n                             │    ────────────────────   │\n                             │      Join Type: INNER     │\n                             │                           │\n                             │        Conditions:        │\n                             │ sr_reason_sk = r_reason_sk│\n                             │                           ├──────────────┐\n                             │        Build Min: 1       │              │\n                             │       Build Max: 45       │              │\n                             │                           │              │\n                             │         61506 Rows        │              │\n                             │          (0.01s)          │              │\n                             └─────────────┬─────────────┘              │\n                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n                             │         TABLE_SCAN        ││         TABLE_SCAN        │\n                             │    ────────────────────   ││    ────────────────────   │\n                             │       store_returns       ││           reason          │\n                             │                           ││                           │\n                             │        Projections:       ││        Projections:       │\n                             │        sr_reason_sk       ││        r_reason_sk        │\n                             │         sr_item_sk        ││                           │\n                             │      sr_ticket_number     ││          Filters:         │\n                             │     sr_return_quantity    ││  r_reason_desc='duplicate │\n                             │                           ││        purchase' AND      │\n                             │                           ││  r_reason_desc IS NOT NULL│\n                             │                           ││                           │\n                             │         61506 Rows        ││           1 Rows          │\n... (2 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q93", "Q11"]}
{"id": 4, "query_sql": "select case when (select count(*) \n                  from store_sales \n                  where ss_quantity between 1 and 20) > 2972190\n            then (select avg(ss_ext_sales_price) \n                  from store_sales \n                  where ss_quantity between 1 and 20) \n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 1 and 20) end bucket1 ,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 21 and 40) > 4505785\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 21 and 40) \n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 21 and 40) end bucket2,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 41 and 60) > 1575726\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 41 and 60)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 41 and 60) end bucket3,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 61 and 80) > 3188917\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 61 and 80)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 61 and 80) end bucket4,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 81 and 100) > 3525216\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 81 and 100)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 81 and 100) end bucket5\nfrom reason\nwhere r_reason_sk = 1;", "rewritten_sql": "WITH quantity_aggregations AS (SELECT CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END AS bucket, COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_disc, AVG(ss_net_paid) AS avg_net FROM store_sales WHERE ss_quantity BETWEEN 1 AND 100 GROUP BY CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END)\nSELECT CASE WHEN q1.cnt > 74129 THEN q1.avg_disc ELSE q1.avg_net END AS bucket1, CASE WHEN q2.cnt > 122840 THEN q2.avg_disc ELSE q2.avg_net END AS bucket2, CASE WHEN q3.cnt > 56580 THEN q3.avg_disc ELSE q3.avg_net END AS bucket3, CASE WHEN q4.cnt > 10097 THEN q4.avg_disc ELSE q4.avg_net END AS bucket4, CASE WHEN q5.cnt > 165306 THEN q5.avg_disc ELSE q5.avg_net END AS bucket5 FROM reason CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 1) AS q1 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 2) AS q2 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 3) AS q3 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 4) AS q4 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 5) AS q5 WHERE r_reason_sk = 1;", "transform": "pushdown", "original_ms": 550.0, "rewritten_ms": 469.0, "ratio": 2.11, "outcome": "WIN", "declared_speedup": "2.11x", "sf10_speedup": 0.49, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select case when (select count(*)                    from store_sales                    where ss_quantity between 1 and 20) > 2972190             then (select avg(ss_ext_sales_price)                    from store_sales                    where ss_quantity between 1 and 20)              else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 1 and 20) end bucket1 ,        case when (select count(*)                   from store_sales                   where ss_quantity between 21 and 40) > 4505785             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 21 and 40)              else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 21 and 40) end bucket2,        case when (select count(*)                   from store_sales                   where ss_quantity between 41 and 60) > 1575726             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 41 and 60)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 41 and 60) end bucket3,        case when (select count(*)                   from store_sales                   where ss_quantity between 61 and 80) > 3188917             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 61 and 80)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 61 and 80) end bucket4,        case when (select count(*)                   from store_sales                   where ss_quantity between 81 and 100) > 3525216             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 81 and 100)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 81 and 100) end bucket5 from reason where r_reason_sk = 1;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.550s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│   bucket1   │\n│   bucket2   │\n│   bucket3   │\n│   bucket4   │\n│   bucket5   │\n│             │\n│    1 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│CROSS_PRODUCT│\n│    ──────   │\n│    1 Rows   ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                                                                                │\n└──────┬──────┘                                                                                                                │\n┌──────┴──────┐                                                                                                         ┌──────┴──────┐\n│CROSS_PRODUCT│                                                                                                         │CROSS_PRODUCT│\n│    ──────   │                                                                                                         │    ──────   │\n│    1 Rows   ├────────────────────────────────────────────────────┐                                                    │    1 Rows   ├─────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                    │                                                    │   (0.00s)   │                                                                                                 │\n└──────┬──────┘                                                    │                                                    └──────┬──────┘                                                                                                 │\n┌──────┴──────┐                                             ┌──────┴──────┐                                             ┌──────┴──────┐                                                                                          ┌──────┴──────┐\n│CROSS_PRODUCT│                                             │CROSS_PRODUCT│                                             │CROSS_PRODUCT│                                                                                          │  PROJECTION │\n│    ──────   │                                             │    ──────   │                                             │    ──────   │                                                                                          │    ──────   │\n│             │                                             │             │                                             │             │                                                                                          │ CASE  WHEN (│\n│             │                                             │             │                                             │             │                                                                                          │  (#1 > 1))  │\n│             │                                             │             │                                             │             │                                                                                          │  THEN (error│\n│             │                                             │             │                                             │             │                                                                                          │ ('More than │\n│             │                                             │             │                                             │             │                                                                                          │    one row  │\n│             │                                             │             │                                             │             │                                                                                          │  returned by│\n│             │                                             │             │                                             │             │                                                                                          │  a subquery │\n│             │                                             │             │                                             │             │                                                                                          │  used as an │\n│             │                                             │             │                                             │             │                                                                                          │  expression │\n│             │                                             │             │                                             │             │                                                                                          │   - scalar  │\n│             │                                             │             │                                             │             │                                                                                          │  subqueries │\n│             │                                             │             │                                             │             │                                                                                          │   can only  │\n│             │                                             │             │                                             │             │                                                                                          │   return a  │\n│             ├──────────────────────┐                      │             ├──────────────────────┐                      │             ├──────────────────────────────────────────────────────────────────────────────────┐       │  single row.│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   Use \"SET  │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ scalar_subqu│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ery_error_on_│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │multiple_rows│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  =false\" to │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   revert to │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   previous  │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  behavior of│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  returning a│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  random row.│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ ')) ELSE #0 │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │      END    │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │             │\n│    1 Rows   │                      │                      │    1 Rows   │                      │                      │    1 Rows   │                                                                                  │       │    1 Rows   │\n│   (0.00s)   │                      │                      │   (0.00s)   │                      │                      │   (0.00s)   │                                                                                  │       │   (0.00s)   │\n└──────┬──────┘                      │                      └──────┬──────┘                      │                      └──────┬──────┘                                                                                  │       └──────┬──────┘\n┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐                                                                           ┌──────┴──────┐┌──────┴──────┐\n│CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│                                                                           │  PROJECTION ││UNGROUPE...  │\n│    ──────   │               │    ──────   │               │    ──────   │               │    ──────   │               │    ──────   │                                                                           │    ──────   ││    ──────   │\n│             │               │             │               │             │               │             │               │             │                                                                           │ CASE  WHEN (││ Aggregates: │\n│             │               │             │               │             │               │             │               │             │                                                                           │  (#1 > 1))  ││ \"first\"(#0) │\n│             │               │             │               │             │               │             │               │             │                                                                           │  THEN (error││ count_star()│\n│             │               │             │               │             │               │             │               │             │                                                                           │ ('More than ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │    one row  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  returned by││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  a subquery ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  used as an ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  expression ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   - scalar  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  subqueries ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   can only  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   return a  ││             │\n│             ├───────┐       │             ├───────┐       │             ├───────┐       │             ├───────┐       │             ├───────────────────────────────────────────────────────────────────┐       │  single row.││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   Use \"SET  ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ scalar_subqu││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ery_error_on_││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │multiple_rows││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  =false\" to ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   revert to ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   previous  ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  behavior of││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  returning a││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  random row.││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ ')) ELSE #0 ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │      END    ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │             ││             │\n│    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │                                                                   │       │    1 Rows   ││    1 Rows   │\n│   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │                                                                   │       │   (0.00s)   ││   (0.00s)   │\n└──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘                                                                   │       └──────┬──────┘└──────┬──────┘\n┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐                                                            ┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐\n│  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││CROSS_PRODUCT│                                                            │  PROJECTION ││UNGROUPE...  ││  PROJECTION │\n│    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   │                                                            │    ──────   ││    ──────   ││    ──────   │\n│ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││             │                                                            │ CASE  WHEN (││ Aggregates: ││      #0     │\n│  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││             │                                                            │  (#1 > 1))  ││ \"first\"(#0) ││             │\n│  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││             │                                                            │  THEN (error││ count_star()││             │\n│ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││             │                                                            │ ('More than ││             ││             │\n│    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││             │                                                            │    one row  ││             ││             │\n│  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││             │                                                            │  returned by││             ││             │\n│  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││             │                                                            │  a subquery ││             ││             │\n... (223 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH quantity_aggregations AS (SELECT CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END AS bucket, COUNT(*) AS cnt, AVG(ss_ext_discount_amt) AS avg_disc, AVG(ss_net_paid) AS avg_net FROM store_sales WHERE ss_quantity BETWEEN 1 AND 100 GROUP BY CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END) SELECT CASE WHEN q1.cnt > 74129 THEN q1.avg_disc ELSE q1.avg_net END AS bucket1, CASE WHEN q2.cnt > 122840 THEN q2.avg_disc ELSE q2.avg_net END AS bucket2, CASE WHEN q3.cnt > 56580 THEN q3.avg_disc ELSE q3.avg_net END AS bucket3, CASE WHEN q4.cnt > 10097 THEN q4.avg_disc ELSE q4.avg_net END AS bucket4, CASE WHEN q5.cnt > 165306 THEN q5.avg_disc ELSE q5.avg_net END AS bucket5 FROM reason CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 1) AS q1 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 2) AS q2 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 3) AS q3 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 4) AS q4 CROSS JOIN (SELECT cnt, avg_disc, avg_net FROM quantity_aggregations WHERE bucket = 5) AS q5 WHERE r_reason_sk = 1;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.469s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│          bucket1          │\n│          bucket2          │\n│          bucket3          │\n│          bucket4          │\n│          bucket5          │\n│                           │\n│           1 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│            CTE            │\n│    ────────────────────   │\n│         CTE Name:         │\n│   quantity_aggregations   │\n│                           ├──────────────┐\n│       Table Index: 0      │              │\n│                           │              │\n│           0 Rows          │              │\n│          (0.00s)          │              │\n└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       ││       CROSS_PRODUCT       │\n│    ────────────────────   ││    ────────────────────   │\n│         Groups: #0        ││                           │\n│                           ││                           │\n│        Aggregates:        ││                           │\n│        count_star()       ││                           ├─────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│          avg(#1)          ││                           │                                                                                                     │\n│          avg(#2)          ││                           │                                                                                                     │\n│                           ││                           │                                                                                                     │\n│           5 Rows          ││           1 Rows          │                                                                                                     │\n│          (0.98s)          ││          (0.00s)          │                                                                                                     │\n└─────────────┬─────────────┘└─────────────┬─────────────┘                                                                                                     │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐\n│         PROJECTION        ││       CROSS_PRODUCT       │                                                                                       │       CROSS_PRODUCT       │\n│    ────────────────────   ││    ────────────────────   │                                                                                       │    ────────────────────   │\n│ CASE  WHEN ((ss_quantity <││                           │                                                                                       │                           │\n│  = 20)) THEN (1) WHEN ((  ││                           │                                                                                       │                           │\n│  (ss_quantity >= 21) AND  ││                           │                                                                                       │                           │\n│ (ss_quantity <= 40))) THEN││                           │                                                                                       │                           │\n│  (2) WHEN (((ss_quantity >││                           │                                                                                       │                           │\n│ = 41) AND (ss_quantity <= ││                           │                                                                                       │                           │\n│   60))) THEN (3) WHEN ((  ││                           │                                                                                       │                           │\n│  (ss_quantity >= 61) AND  ││                           ├────────────────────────────────────────────────────────────────────────┐              │                           ├──────────────┐\n│ (ss_quantity <= 80))) THEN││                           │                                                                        │              │                           │              │\n│  (4) WHEN ((ss_quantity >=││                           │                                                                        │              │                           │              │\n│   81)) THEN (5) ELSE NULL ││                           │                                                                        │              │                           │              │\n│             END           ││                           │                                                                        │              │                           │              │\n│    ss_ext_discount_amt    ││                           │                                                                        │              │                           │              │\n│        ss_net_paid        ││                           │                                                                        │              │                           │              │\n│                           ││                           │                                                                        │              │                           │              │\n│       27504809 Rows       ││           1 Rows          │                                                                        │              │           1 Rows          │              │\n│          (0.57s)          ││          (0.00s)          │                                                                        │              │          (0.00s)          │              │\n└─────────────┬─────────────┘└─────────────┬─────────────┘                                                                        │              └─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│           FILTER          ││       CROSS_PRODUCT       │                                                          │         PROJECTION        ││         PROJECTION        ││         PROJECTION        │\n│    ────────────────────   ││    ────────────────────   │                                                          │    ────────────────────   ││    ────────────────────   ││    ────────────────────   │\n│ ((CASE  WHEN ((ss_quantity││                           │                                                          │            cnt            ││            cnt            ││            cnt            │\n│  <= 20)) THEN (1) WHEN (( ││                           │                                                          │          avg_disc         ││          avg_disc         ││          avg_disc         │\n│  (ss_quantity >= 21) AND  ││                           │                                                          │          avg_net          ││          avg_net          ││          avg_net          │\n│ (ss_quantity <= 40))) THEN││                           │                                                          │                           ││                           ││                           │\n│  (2) WHEN (((ss_quantity >││                           │                                                          │                           ││                           ││                           │\n│ = 41) AND (ss_quantity <= ││                           │                                                          │                           ││                           ││                           │\n│   60))) THEN (3) WHEN ((  ││                           │                                                          │                           ││                           ││                           │\n│  (ss_quantity >= 61) AND  ││                           │                                                          │                           ││                           ││                           │\n│ (ss_quantity <= 80))) THEN││                           │                                                          │                           ││                           ││                           │\n│  (4) WHEN ((ss_quantity >=││                           │                                                          │                           ││                           ││                           │\n│   81)) THEN (5) ELSE NULL ││                           │                                                          │                           ││                           ││                           │\n│  END = 5) OR ((CASE  WHEN ││                           │                                                          │                           ││                           ││                           │\n│ ((ss_quantity <= 20)) THEN││                           │                                                          │                           ││                           ││                           │\n│  (1) WHEN (((ss_quantity >││                           ├───────────────────────────────────────────┐              │                           ││                           ││                           │\n│ = 21) AND (ss_quantity <= ││                           │                                           │              │                           ││                           ││                           │\n│   40))) THEN (2) WHEN ((  ││                           │                                           │              │                           ││                           ││                           │\n│  (ss_quantity >= 41) AND  ││                           │                                           │              │                           ││                           ││                           │\n│ (ss_quantity <= 60))) THEN││                           │                                           │              │                           ││                           ││                           │\n│  (3) WHEN (((ss_quantity >││                           │                                           │              │                           ││                           ││                           │\n│ = 61) AND (ss_quantity <= ││                           │                                           │              │                           ││                           ││                           │\n│    80))) THEN (4) WHEN (  ││                           │                                           │              │                           ││                           ││                           │\n│ (ss_quantity >= 81)) THEN ││                           │                                           │              │                           ││                           ││                           │\n│ (5) ELSE NULL END = 4) OR ││                           │                                           │              │                           ││                           ││                           │\n│ ((CASE  WHEN ((ss_quantity││                           │                                           │              │                           ││                           ││                           │\n│  <= 20)) THEN (1) WHEN (( ││                           │                                           │              │                           ││                           ││                           │\n│  (ss_quantity >= 21) AND  ││                           │                                           │              │                           ││                           ││                           │\n│ (ss_quantity <= 40))) THEN││                           │                                           │              │                           ││                           ││                           │\n│  (2) WHEN (((ss_quantity >││           1 Rows          │                                           │              │           1 Rows          ││           1 Rows          ││           1 Rows          │\n│ = 41) AND (ss_quantity <= ││          (0.00s)          │                                           │              │          (0.00s)          ││          (0.00s)          ││          (0.00s)          │\n└─────────────┬─────────────┘└─────────────┬─────────────┘                                           │              └─────────────┬─────────────┘└─────────────┬─────────────┘└─────────────┬─────────────┘\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││       CROSS_PRODUCT       │                             │         PROJECTION        ││           FILTER          ││           FILTER          ││           FILTER          │\n│    ────────────────────   ││    ────────────────────   │                             │    ────────────────────   ││    ────────────────────   ││    ────────────────────   ││    ────────────────────   │\n│        store_sales        ││                           │                             │            cnt            ││        (bucket = 3)       ││        (bucket = 5)       ││        (bucket = 4)       │\n│                           ││                           │                             │          avg_disc         ││                           ││                           ││                           │\n│        Projections:       ││                           │                             │          avg_net          ││                           ││                           ││                           │\n│        ss_quantity        ││                           │                             │                           ││                           ││                           ││                           │\n│    ss_ext_discount_amt    ││                           │                             │                           ││                           ││                           ││                           │\n│        ss_net_paid        ││                           │                             │                           ││                           ││                           ││                           │\n│                           ││                           ├──────────────┐              │                           ││                           ││                           ││                           │\n... (36 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q9"]}
{"id": 5, "query_sql": "select i_item_id, \n        avg(cs_quantity) agg1,\n        avg(cs_list_price) agg2,\n        avg(cs_coupon_amt) agg3,\n        avg(cs_sales_price) agg4 \n from catalog_sales, customer_demographics, date_dim, item, promotion\n where cs_sold_date_sk = d_date_sk and\n       cs_item_sk = i_item_sk and\n       cs_bill_cdemo_sk = cd_demo_sk and\n       cs_promo_sk = p_promo_sk and\n       cd_gender = 'M' and \n       cd_marital_status = 'S' and\n       cd_education_status = 'Unknown' and\n       (p_channel_email = 'N' or p_channel_event = 'N') and\n       d_year = 2001 \n group by i_item_id\n order by i_item_id\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'S' AND cd_education_status = 'College'), prejoined_sales AS (SELECT cs.cs_quantity, cs.cs_list_price, cs.cs_coupon_amt, cs.cs_sales_price, i.i_item_id, p.p_channel_email, p.p_channel_event FROM catalog_sales AS cs JOIN filtered_dates AS fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN filtered_customer_demographics AS fcd ON cs.cs_bill_cdemo_sk = fcd.cd_demo_sk JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk), branch_both AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email = 'N' AND p_channel_event = 'N'), branch_email AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email = 'N' AND p_channel_event <> 'N'), branch_event AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email <> 'N' AND p_channel_event = 'N'), combined_sales AS (SELECT * FROM branch_email UNION ALL SELECT * FROM branch_event UNION ALL SELECT * FROM branch_both)\nSELECT i_item_id, AVG(cs_quantity) AS agg1, AVG(cs_list_price) AS agg2, AVG(cs_coupon_amt) AS agg3, AVG(cs_sales_price) AS agg4 FROM combined_sales GROUP BY i_item_id ORDER BY i_item_id LIMIT 100;", "transform": "dimension_cte_isolate", "original_ms": 180.0, "rewritten_ms": 169.0, "ratio": 1.93, "outcome": "WIN", "declared_speedup": "1.93x", "sf10_speedup": null, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select i_item_id,          avg(cs_quantity) agg1,         avg(cs_list_price) agg2,         avg(cs_coupon_amt) agg3,         avg(cs_sales_price) agg4   from catalog_sales, customer_demographics, date_dim, item, promotion  where cs_sold_date_sk = d_date_sk and        cs_item_sk = i_item_sk and        cs_bill_cdemo_sk = cd_demo_sk and        cs_promo_sk = p_promo_sk and        cd_gender = 'M' and         cd_marital_status = 'S' and        cd_education_status = 'Unknown' and        (p_channel_email = 'N' or p_channel_event = 'N') and        d_year = 2001   group by i_item_id  order by i_item_id  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.180s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│     item.i_item_id ASC    │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│         Groups: #0        │\n│                           │\n│        Aggregates:        │\n│          avg(#1)          │\n│          avg(#2)          │\n│          avg(#3)          │\n│          avg(#4)          │\n│                           │\n│         27432 Rows        │\n│          (0.01s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│         i_item_id         │\n│        cs_quantity        │\n│       cs_list_price       │\n│       cs_coupon_amt       │\n│       cs_sales_price      │\n│                           │\n│         39564 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│   i_item_sk = cs_item_sk  │\n│                           ├──────────────┐\n│        Build Min: 1       │              │\n│     Build Max: 102000     │              │\n│                           │              │\n│         39564 Rows        │              │\n│          (0.01s)          │              │\n└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││         HASH_JOIN         │\n│    ────────────────────   ││    ────────────────────   │\n│            item           ││      Join Type: INNER     │\n│                           ││                           │\n│        Projections:       ││        Conditions:        │\n│         i_item_sk         ││  cs_promo_sk = p_promo_sk │\n│         i_item_id         ││                           ├────────────────────────────────────────────────────────────────────────┐\n│                           ││        Build Min: 1       │                                                                        │\n│                           ││       Build Max: 500      │                                                                        │\n│                           ││                           │                                                                        │\n│        101997 Rows        ││         39564 Rows        │                                                                        │\n│          (0.01s)          ││          (0.00s)          │                                                                        │\n└───────────────────────────┘└─────────────┬─────────────┘                                                                        │\n                             ┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐\n                             │         HASH_JOIN         │                                                          │           FILTER          │\n                             │    ────────────────────   │                                                          │    ────────────────────   │\n                             │      Join Type: INNER     │                                                          │  ((p_channel_email = 'N') │\n                             │                           │                                                          │  OR (p_channel_event = 'N'│\n                             │        Conditions:        │                                                          │             ))            │\n                             │        cd_demo_sk =       ├──────────────┐                                           │                           │\n                             │      cs_bill_cdemo_sk     │              │                                           │                           │\n                             │                           │              │                                           │                           │\n                             │         39791 Rows        │              │                                           │          498 Rows         │\n                             │          (0.91s)          │              │                                           │          (0.00s)          │\n                             └─────────────┬─────────────┘              │                                           └─────────────┬─────────────┘\n                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐\n                             │           FILTER          ││         HASH_JOIN         │                             │         TABLE_SCAN        │\n                             │    ────────────────────   ││    ────────────────────   │                             │    ────────────────────   │\n                             │     (cd_demo_sk >= 2)     ││      Join Type: INNER     │                             │         promotion         │\n                             │                           ││                           │                             │                           │\n                             │                           ││        Conditions:        │                             │        Projections:       │\n                             │                           ││cs_sold_date_sk = d_date_sk│                             │         p_promo_sk        │\n                             │                           ││                           ├──────────────┐              │      p_channel_email      │\n                             │                           ││     Build Min: 2450815    │              │              │      p_channel_event      │\n                             │                           ││     Build Max: 2452653    │              │              │                           │\n                             │                           ││                           │              │              │                           │\n                             │         27440 Rows        ││        2852586 Rows       │              │              │          500 Rows         │\n                             │          (0.00s)          ││          (0.03s)          │              │              │          (0.01s)          │\n                             └─────────────┬─────────────┘└─────────────┬─────────────┘              │              └───────────────────────────┘\n                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n                             │         TABLE_SCAN        ││         TABLE_SCAN        ││           FILTER          │\n                             │    ────────────────────   ││    ────────────────────   ││    ────────────────────   │\n                             │   customer_demographics   ││       catalog_sales       ││ (d_date_sk BETWEEN 2450815│\n                             │                           ││                           ││        AND 2452653)       │\n                             │        Projections:       ││        Projections:       ││                           │\n                             │         cd_demo_sk        ││      cs_sold_date_sk      ││                           │\n                             │                           ││         cs_item_sk        ││                           │\n                             │          Filters:         ││      cs_bill_cdemo_sk     ││                           │\n... (28 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'S' AND cd_education_status = 'College'), prejoined_sales AS (SELECT cs.cs_quantity, cs.cs_list_price, cs.cs_coupon_amt, cs.cs_sales_price, i.i_item_id, p.p_channel_email, p.p_channel_event FROM catalog_sales AS cs JOIN filtered_dates AS fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN filtered_customer_demographics AS fcd ON cs.cs_bill_cdemo_sk = fcd.cd_demo_sk JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk), branch_both AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email = 'N' AND p_channel_event = 'N'), branch_email AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email = 'N' AND p_channel_event <> 'N'), branch_event AS (SELECT cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, i_item_id FROM prejoined_sales WHERE p_channel_email <> 'N' AND p_channel_event = 'N'), combined_sales AS (SELECT * FROM branch_email UNION ALL SELECT * FROM branch_event UNION ALL SELECT * FROM branch_both) SELECT i_item_id, AVG(cs_quantity) AS agg1, AVG(cs_list_price) AS agg2, AVG(cs_coupon_amt) AS agg3, AVG(cs_sales_price) AS agg4 FROM combined_sales GROUP BY i_item_id ORDER BY i_item_id LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.169s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    TOP_N    │\n│    ──────   │\n│     Top:    │\n│     100     │\n│             │\n│  Order By:  │\n│combined_sale│\n│ s.i_item_id │\n│      ASC    │\n│             │\n│   100 Rows  │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│HASH_GROUP_BY│\n│    ──────   │\n│   Groups:   │\n│      #0     │\n│             │\n│ Aggregates: │\n│   avg(#1)   │\n│   avg(#2)   │\n│   avg(#3)   │\n│   avg(#4)   │\n│             │\n│  27442 Rows │\n│   (0.01s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│  i_item_id  │\n│ cs_quantity │\n│cs_list_price│\n│cs_coupon_amt│\n│cs_sales_pric│\n│      e      │\n│             │\n│  39015 Rows │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    UNION    │\n│    ──────   │\n│    0 Rows   ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                                                                                                              │\n└──────┬──────┘                                                                                                                                              │\n┌──────┴──────┐                                                                                                                                       ┌──────┴──────┐\n│    UNION    │                                                                                                                                       │  PROJECTION │\n│    ──────   │                                                                                                                                       │    ──────   │\n│             │                                                                                                                                       │ cs_quantity │\n│             │                                                                                                                                       │cs_list_price│\n│             │                                                                                                                                       │cs_coupon_amt│\n│             ├───────────────────────────────────────────────────────────────────┐                                                                   │cs_sales_pric│\n│             │                                                                   │                                                                   │      e      │\n│             │                                                                   │                                                                   │  i_item_id  │\n│             │                                                                   │                                                                   │             │\n│    0 Rows   │                                                                   │                                                                   │  39015 Rows │\n│   (0.00s)   │                                                                   │                                                                   │   (0.00s)   │\n└──────┬──────┘                                                                   │                                                                   └──────┬──────┘\n┌──────┴──────┐                                                            ┌──────┴──────┐                                                            ┌──────┴──────┐\n│  PROJECTION │                                                            │  PROJECTION │                                                            │  HASH_JOIN  │\n│    ──────   │                                                            │    ──────   │                                                            │    ──────   │\n│ cs_quantity │                                                            │ cs_quantity │                                                            │  Join Type: │\n│cs_list_price│                                                            │cs_list_price│                                                            │    INNER    │\n│cs_coupon_amt│                                                            │cs_coupon_amt│                                                            │             │\n│cs_sales_pric│                                                            │cs_sales_pric│                                                            │ Conditions: │\n│      e      │                                                            │      e      │                                                            │ i_item_sk = │\n│  i_item_id  │                                                            │  i_item_id  │                                                            │  cs_item_sk │\n│             │                                                            │             │                                                            │             ├───────┐\n│             │                                                            │             │                                                            │  Build Min: │       │\n│             │                                                            │             │                                                            │      1      │       │\n│             │                                                            │             │                                                            │             │       │\n│             │                                                            │             │                                                            │  Build Max: │       │\n│             │                                                            │             │                                                            │    102000   │       │\n│             │                                                            │             │                                                            │             │       │\n│    0 Rows   │                                                            │    0 Rows   │                                                            │  39015 Rows │       │\n│   (0.00s)   │                                                            │   (0.00s)   │                                                            │   (0.03s)   │       │\n└──────┬──────┘                                                            └──────┬──────┘                                                            └──────┬──────┘       │\n┌──────┴──────┐                                                            ┌──────┴──────┐                                                            ┌──────┴──────┐┌──────┴──────┐\n│  HASH_JOIN  │                                                            │  HASH_JOIN  │                                                            │  TABLE_SCAN ││  HASH_JOIN  │\n│    ──────   │                                                            │    ──────   │                                                            │    ──────   ││    ──────   │\n│  Join Type: │                                                            │  Join Type: │                                                            │     item    ││  Join Type: │\n│    INNER    │                                                            │    INNER    │                                                            │             ││    INNER    │\n│             │                                                            │             │                                                            │ Projections:││             │\n│ Conditions: │                                                            │ Conditions: │                                                            │  i_item_sk  ││ Conditions: │\n│ i_item_sk = │                                                            │ i_item_sk = │                                                            │  i_item_id  ││ cs_promo_sk │\n│  cs_item_sk │                                                            │  cs_item_sk │                                                            │             ││ = p_promo_sk│\n│             ├───────┐                                                    │             ├───────┐                                                    │             ││             ├─────────────────────────────────────┐\n│  Build Min: │       │                                                    │  Build Min: │       │                                                    │             ││  Build Min: │                                     │\n│      1      │       │                                                    │      1      │       │                                                    │             ││      1      │                                     │\n│             │       │                                                    │             │       │                                                    │             ││             │                                     │\n│  Build Max: │       │                                                    │  Build Max: │       │                                                    │             ││  Build Max: │                                     │\n│    102000   │       │                                                    │    102000   │       │                                                    │             ││     500     │                                     │\n│             │       │                                                    │             │       │                                                    │             ││             │                                     │\n│    0 Rows   │       │                                                    │    0 Rows   │       │                                                    │ 101999 Rows ││  39015 Rows │                                     │\n│   (0.00s)   │       │                                                    │   (0.00s)   │       │                                                    │   (0.01s)   ││   (0.00s)   │                                     │\n└──────┬──────┘       │                                                    └──────┬──────┘       │                                                    └─────────────┘└──────┬──────┘                                     │\n┌──────┴──────┐┌──────┴──────┐                                             ┌──────┴──────┐┌──────┴──────┐                                                            ┌──────┴──────┐                              ┌──────┴──────┐\n... (107 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q26"]}
{"id": 6, "query_sql": "select  \n     i_item_id\n    ,i_item_desc\n    ,s_store_id\n    ,s_store_name\n    ,avg(ss_quantity)        as store_sales_quantity\n    ,avg(sr_return_quantity) as store_returns_quantity\n    ,avg(cs_quantity)        as catalog_sales_quantity\n from\n    store_sales\n   ,store_returns\n   ,catalog_sales\n   ,date_dim             d1\n   ,date_dim             d2\n   ,date_dim             d3\n   ,store\n   ,item\n where\n     d1.d_moy               = 4 \n and d1.d_year              = 1999\n and d1.d_date_sk           = ss_sold_date_sk\n and i_item_sk              = ss_item_sk\n and s_store_sk             = ss_store_sk\n and ss_customer_sk         = sr_customer_sk\n and ss_item_sk             = sr_item_sk\n and ss_ticket_number       = sr_ticket_number\n and sr_returned_date_sk    = d2.d_date_sk\n and d2.d_moy               between 4 and  4 + 3 \n and d2.d_year              = 1999\n and sr_customer_sk         = cs_bill_customer_sk\n and sr_item_sk             = cs_item_sk\n and cs_sold_date_sk        = d3.d_date_sk     \n and d3.d_year              in (1999,1999+1,1999+2)\n group by\n    i_item_id\n   ,i_item_desc\n   ,s_store_id\n   ,s_store_name\n order by\n    i_item_id \n   ,i_item_desc\n   ,s_store_id\n   ,s_store_name\n LIMIT 100;", "rewritten_sql": "WITH d1_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 4 AND d_year = 1999), d2_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 4 AND 7 AND d_year = 1999), d3_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year IN (1999, 2000, 2001)), filtered_store_sales AS (SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_customer_sk, ss.ss_ticket_number, ss.ss_quantity FROM store_sales AS ss JOIN d1_filtered AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk), filtered_store_returns AS (SELECT sr.sr_customer_sk, sr.sr_item_sk, sr.sr_ticket_number, sr.sr_return_quantity FROM store_returns AS sr JOIN d2_filtered AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk), filtered_catalog_sales AS (SELECT cs.cs_bill_customer_sk, cs.cs_item_sk, cs.cs_quantity FROM catalog_sales AS cs JOIN d3_filtered AS d3 ON cs.cs_sold_date_sk = d3.d_date_sk)\nSELECT i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name, AVG(ss.ss_quantity) AS store_sales_quantity, AVG(sr.sr_return_quantity) AS store_returns_quantity, AVG(cs.cs_quantity) AS catalog_sales_quantity FROM filtered_store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_store_returns AS sr ON ss.ss_customer_sk = sr.sr_customer_sk AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN filtered_catalog_sales AS cs ON sr.sr_customer_sk = cs.cs_bill_customer_sk AND sr.sr_item_sk = cs.cs_item_sk GROUP BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name ORDER BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name LIMIT 100;", "transform": "multi_date_range_cte", "original_ms": 600.0, "rewritten_ms": 611.0, "ratio": 2.35, "outcome": "WIN", "declared_speedup": "2.35x", "sf10_speedup": null, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select        i_item_id     ,i_item_desc     ,s_store_id     ,s_store_name     ,avg(ss_quantity)        as store_sales_quantity     ,avg(sr_return_quantity) as store_returns_quantity     ,avg(cs_quantity)        as catalog_sales_quantity  from     store_sales    ,store_returns    ,catalog_sales    ,date_dim             d1    ,date_dim             d2    ,date_dim             d3    ,store    ,item  where      d1.d_moy               = 4   and d1.d_year              = 1999  and d1.d_date_sk           = ss_sold_date_sk  and i_item_sk              = ss_item_sk  and s_store_sk             = ss_store_sk  and ss_customer_sk         = sr_customer_sk  and ss_item_sk             = sr_item_sk  and ss_ticket_number       = sr_ticket_number  and sr_returned_date_sk    = d2.d_date_sk  and d2.d_moy               between 4 and  4 + 3   and d2.d_year              = 1999  and sr_customer_sk         = cs_bill_customer_sk  and sr_item_sk             = cs_item_sk  and cs_sold_date_sk        = d3.d_date_sk       and d3.d_year              in (1999,1999+1,1999+2)  group by     i_item_id    ,i_item_desc    ,s_store_id    ,s_store_name  order by     i_item_id     ,i_item_desc    ,s_store_id    ,s_store_name  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.600s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│     item.i_item_id ASC    │\n│    item.i_item_desc ASC   │\n│    store.s_store_id ASC   │\n│   store.s_store_name ASC  │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│__internal_decompress_strin│\n│           g(#3)           │\n│             #4            │\n│             #5            │\n│             #6            │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│                           │\n│        Aggregates:        │\n│          avg(#4)          │\n│          avg(#5)          │\n│          avg(#6)          │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│         i_item_id         │\n│        i_item_desc        │\n│         s_store_id        │\n│        s_store_name       │\n│        ss_quantity        │\n│     sr_return_quantity    │\n│        cs_quantity        │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│__internal_compress_integra│\n│  l_usmallint(#2, 2450815) │\n│             #3            │\n│             #4            │\n│             #5            │\n│             #6            │\n│             #7            │\n│             #8            │\n│             #9            │\n│            #10            │\n│__internal_compress_string_│\n│        ubigint(#11)       │\n│__internal_compress_integra│\n│ l_usmallint(#12, 2450815) │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│cs_sold_date_sk = d_date_sk│\n│                           ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│     Build Min: 2450815    │                                                                                                                                                                                            │\n│     Build Max: 2452653    │                                                                                                                                                                                            │\n│                           │                                                                                                                                                                                            │\n│           4 Rows          │                                                                                                                                                                                            │\n│          (0.00s)          │                                                                                                                                                                                            │\n└─────────────┬─────────────┘                                                                                                                                                                                            │\n┌─────────────┴─────────────┐                                                                                                                                                                              ┌─────────────┴─────────────┐\n│         HASH_JOIN         │                                                                                                                                                                              │           FILTER          │\n│    ────────────────────   │                                                                                                                                                                              │    ────────────────────   │\n... (110 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH d1_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 4 AND d_year = 1999), d2_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 4 AND 7 AND d_year = 1999), d3_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year IN (1999, 2000, 2001)), filtered_store_sales AS (SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_customer_sk, ss.ss_ticket_number, ss.ss_quantity FROM store_sales AS ss JOIN d1_filtered AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk), filtered_store_returns AS (SELECT sr.sr_customer_sk, sr.sr_item_sk, sr.sr_ticket_number, sr.sr_return_quantity FROM store_returns AS sr JOIN d2_filtered AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk), filtered_catalog_sales AS (SELECT cs.cs_bill_customer_sk, cs.cs_item_sk, cs.cs_quantity FROM catalog_sales AS cs JOIN d3_filtered AS d3 ON cs.cs_sold_date_sk = d3.d_date_sk) SELECT i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name, AVG(ss.ss_quantity) AS store_sales_quantity, AVG(sr.sr_return_quantity) AS store_returns_quantity, AVG(cs.cs_quantity) AS catalog_sales_quantity FROM filtered_store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_store_returns AS sr ON ss.ss_customer_sk = sr.sr_customer_sk AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN filtered_catalog_sales AS cs ON sr.sr_customer_sk = cs.cs_bill_customer_sk AND sr.sr_item_sk = cs.cs_item_sk GROUP BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name ORDER BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.611s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│      i.i_item_id ASC      │\n│     i.i_item_desc ASC     │\n│      s.s_store_id ASC     │\n│     s.s_store_name ASC    │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│__internal_decompress_strin│\n│           g(#3)           │\n│             #4            │\n│             #5            │\n│             #6            │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│                           │\n│        Aggregates:        │\n│          avg(#4)          │\n│          avg(#5)          │\n│          avg(#6)          │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│         i_item_id         │\n│        i_item_desc        │\n│         s_store_id        │\n│        s_store_name       │\n│        ss_quantity        │\n│     sr_return_quantity    │\n│        cs_quantity        │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│             #5            │\n│             #6            │\n│             #7            │\n│             #8            │\n│             #9            │\n│__internal_compress_string_│\n│        ubigint(#10)       │\n│                           │\n│           4 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│  cs_item_sk = ss_item_sk  ├───────────────────────────────────────────┐\n│   cs_bill_customer_sk =   │                                           │\n│       ss_customer_sk      │                                           │\n│                           │                                           │\n│           4 Rows          │                                           │\n│          (0.12s)          │                                           │\n└─────────────┬─────────────┘                                           │\n┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐\n│         PROJECTION        │                             │         HASH_JOIN         │\n│    ────────────────────   │                             │    ────────────────────   │\n│    cs_bill_customer_sk    │                             │      Join Type: INNER     │\n│         cs_item_sk        │                             │                           │\n│        cs_quantity        │                             │        Conditions:        │\n│                           │                             │  ss_store_sk = s_store_sk │\n│                           │                             │                           ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n... (107 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q29"]}
{"id": 7, "query_sql": "select s_store_name, s_store_id,\n        sum(case when (d_day_name='Sunday') then ss_sales_price else null end) sun_sales,\n        sum(case when (d_day_name='Monday') then ss_sales_price else null end) mon_sales,\n        sum(case when (d_day_name='Tuesday') then ss_sales_price else  null end) tue_sales,\n        sum(case when (d_day_name='Wednesday') then ss_sales_price else null end) wed_sales,\n        sum(case when (d_day_name='Thursday') then ss_sales_price else null end) thu_sales,\n        sum(case when (d_day_name='Friday') then ss_sales_price else null end) fri_sales,\n        sum(case when (d_day_name='Saturday') then ss_sales_price else null end) sat_sales\n from date_dim, store_sales, store\n where d_date_sk = ss_sold_date_sk and\n       s_store_sk = ss_store_sk and\n       s_gmt_offset = -5 and\n       d_year = 2000 \n group by s_store_name, s_store_id\n order by s_store_name, s_store_id,sun_sales,mon_sales,tue_sales,wed_sales,thu_sales,fri_sales,sat_sales\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_day_name FROM date_dim WHERE d_year = 2000), filtered_stores AS (SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_gmt_offset = -5), filtered_sales AS (SELECT ss_sales_price, d_day_name, s_store_id, s_store_name FROM store_sales JOIN filtered_dates ON d_date_sk = ss_sold_date_sk JOIN filtered_stores ON s_store_sk = ss_store_sk)\nSELECT s_store_name, s_store_id, SUM(CASE WHEN (d_day_name = 'Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN (d_day_name = 'Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN (d_day_name = 'Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN (d_day_name = 'Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN (d_day_name = 'Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN (d_day_name = 'Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN (d_day_name = 'Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM filtered_sales GROUP BY s_store_name, s_store_id ORDER BY s_store_name, s_store_id, sun_sales, mon_sales, tue_sales, wed_sales, thu_sales, fri_sales, sat_sales LIMIT 100;", "transform": "multi_dimension_prefetch", "original_ms": 329.0, "rewritten_ms": 336.0, "ratio": 2.71, "outcome": "WIN", "declared_speedup": "2.71x", "sf10_speedup": 1.07, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select s_store_name, s_store_id,         sum(case when (d_day_name='Sunday') then ss_sales_price else null end) sun_sales,         sum(case when (d_day_name='Monday') then ss_sales_price else null end) mon_sales,         sum(case when (d_day_name='Tuesday') then ss_sales_price else  null end) tue_sales,         sum(case when (d_day_name='Wednesday') then ss_sales_price else null end) wed_sales,         sum(case when (d_day_name='Thursday') then ss_sales_price else null end) thu_sales,         sum(case when (d_day_name='Friday') then ss_sales_price else null end) fri_sales,         sum(case when (d_day_name='Saturday') then ss_sales_price else null end) sat_sales  from date_dim, store_sales, store  where d_date_sk = ss_sold_date_sk and        s_store_sk = ss_store_sk and        s_gmt_offset = -5 and        d_year = 2000   group by s_store_name, s_store_id  order by s_store_name, s_store_id,sun_sales,mon_sales,tue_sales,wed_sales,thu_sales,fri_sales,sat_sales  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.329s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│   store.s_store_name ASC  │\n│    store.s_store_id ASC   │\n│ sum(CASE  WHEN ((date_dim │\n│  .d_day_name = 'Sunday')) │\n│      THEN (store_sales    │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│ sum(CASE  WHEN ((date_dim │\n│  .d_day_name = 'Monday')) │\n│      THEN (store_sales    │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│ sum(CASE  WHEN ((date_dim │\n│ .d_day_name = 'Tuesday')) │\n│      THEN (store_sales    │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│ sum(CASE  WHEN ((date_dim │\n│ .d_day_name = 'Wednesday')│\n│    ) THEN (store_sales    │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│ sum(CASE  WHEN ((date_dim │\n│ .d_day_name = 'Thursday'))│\n│      THEN (store_sales    │\n│ .ss_sales_price) ELSE NULL│\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│__internal_decompress_strin│\n│           g(#0)           │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│             #5            │\n│             #6            │\n│             #7            │\n│             #8            │\n│                           │\n│          18 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│                           │\n│        Aggregates:        │\n│          sum(#2)          │\n│          sum(#3)          │\n│          sum(#4)          │\n│          sum(#5)          │\n│          sum(#6)          │\n│          sum(#7)          │\n│          sum(#8)          │\n│                           │\n│          18 Rows          │\n│          (0.34s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        s_store_name       │\n│         s_store_id        │\n│ CASE  WHEN ((d_day_name = │\n│      'Sunday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│      'Monday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Tuesday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│    'Wednesday')) THEN     │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Thursday')) THEN     │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│      'Friday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Saturday')) THEN     │\n... (83 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk, d_day_name FROM date_dim WHERE d_year = 2000), filtered_stores AS (SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_gmt_offset = -5), filtered_sales AS (SELECT ss_sales_price, d_day_name, s_store_id, s_store_name FROM store_sales JOIN filtered_dates ON d_date_sk = ss_sold_date_sk JOIN filtered_stores ON s_store_sk = ss_store_sk) SELECT s_store_name, s_store_id, SUM(CASE WHEN (d_day_name = 'Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN (d_day_name = 'Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN (d_day_name = 'Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN (d_day_name = 'Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN (d_day_name = 'Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN (d_day_name = 'Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN (d_day_name = 'Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM filtered_sales GROUP BY s_store_name, s_store_id ORDER BY s_store_name, s_store_id, sun_sales, mon_sales, tue_sales, wed_sales, thu_sales, fri_sales, sat_sales LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.336s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│       filtered_sales      │\n│     .s_store_name ASC     │\n│ filtered_sales.s_store_id │\n│             ASC           │\n│      sum(CASE  WHEN (     │\n│ (filtered_sales.d_day_name│\n│     = 'Sunday')) THEN     │\n│      (filtered_sales      │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│      sum(CASE  WHEN (     │\n│ (filtered_sales.d_day_name│\n│     = 'Monday')) THEN     │\n│      (filtered_sales      │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│      sum(CASE  WHEN (     │\n│ (filtered_sales.d_day_name│\n│     = 'Tuesday')) THEN    │\n│      (filtered_sales      │\n│ .ss_sales_price) ELSE NULL│\n│          END) ASC         │\n│      sum(CASE  WHEN (     │\n│ (filtered_sales.d_day_name│\n│    = 'Wednesday')) THEN   │\n│      (filtered_sales      │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│__internal_decompress_strin│\n│           g(#0)           │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│             #5            │\n│             #6            │\n│             #7            │\n│             #8            │\n│                           │\n│          18 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│                           │\n│        Aggregates:        │\n│          sum(#2)          │\n│          sum(#3)          │\n│          sum(#4)          │\n│          sum(#5)          │\n│          sum(#6)          │\n│          sum(#7)          │\n│          sum(#8)          │\n│                           │\n│          18 Rows          │\n│          (0.45s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        s_store_name       │\n│         s_store_id        │\n│ CASE  WHEN ((d_day_name = │\n│      'Sunday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│      'Monday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Tuesday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│    'Wednesday')) THEN     │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Thursday')) THEN     │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│      'Friday')) THEN      │\n│ (ss_sales_price) ELSE NULL│\n│             END           │\n│ CASE  WHEN ((d_day_name = │\n│     'Saturday')) THEN     │\n... (86 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q43"]}
{"id": 8, "query_sql": "with ssr as\n (select  s_store_id as store_id,\n          sum(ss_ext_sales_price) as sales,\n          sum(coalesce(sr_return_amt, 0)) as \"returns\",\n          sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n  from store_sales left outer join store_returns on\n         (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n     date_dim,\n     store,\n     item,\n     promotion\n where ss_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-28' as date) \n                  and (cast('1998-08-28' as date) + INTERVAL 30 DAY)\n       and ss_store_sk = s_store_sk\n       and ss_item_sk = i_item_sk\n       and i_current_price > 50\n       and ss_promo_sk = p_promo_sk\n       and p_channel_tv = 'N'\n group by s_store_id)\n ,\n csr as\n (select  cp_catalog_page_id as catalog_page_id,\n          sum(cs_ext_sales_price) as sales,\n          sum(coalesce(cr_return_amount, 0)) as \"returns\",\n          sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n  from catalog_sales left outer join catalog_returns on\n         (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),\n     date_dim,\n     catalog_page,\n     item,\n     promotion\n where cs_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-28' as date)\n                  and (cast('1998-08-28' as date) + INTERVAL 30 DAY)\n        and cs_catalog_page_sk = cp_catalog_page_sk\n       and cs_item_sk = i_item_sk\n       and i_current_price > 50\n       and cs_promo_sk = p_promo_sk\n       and p_channel_tv = 'N'\ngroup by cp_catalog_page_id)\n ,\n wsr as\n (select  web_site_id,\n          sum(ws_ext_sales_price) as sales,\n          sum(coalesce(wr_return_amt, 0)) as \"returns\",\n          sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n  from web_sales left outer join web_returns on\n         (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),\n     date_dim,\n     web_site,\n     item,\n     promotion\n where ws_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-28' as date)\n                  and (cast('1998-08-28' as date) + INTERVAL 30 DAY)\n        and ws_web_site_sk = web_site_sk\n       and ws_item_sk = i_item_sk\n       and i_current_price > 50\n       and ws_promo_sk = p_promo_sk\n       and p_channel_tv = 'N'\ngroup by web_site_id)\n  select channel\n        , id\n        , sum(sales) as sales\n        , sum(\"returns\") as \"returns\"\n        , sum(profit) as profit\n from \n (select 'store channel' as channel\n        , 'store' || store_id as id\n        , sales\n        , \"returns\"\n        , profit\n from   ssr\n union all\n select 'catalog channel' as channel\n        , 'catalog_page' || catalog_page_id as id\n        , sales\n        , \"returns\"\n        , profit\n from  csr\n union all\n select 'web channel' as channel\n        , 'web_site' || web_site_id as id\n        , sales\n        , \"returns\"\n        , profit\n from   wsr\n ) x\n group by rollup (channel, id)\n order by channel\n         ,id\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL '30' DAY)), filtered_items AS (SELECT i_item_sk FROM item WHERE i_current_price > 50), filtered_promotions AS (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'), prefiltered_store_sales AS (SELECT ss_item_sk, ss_store_sk, ss_ticket_number, ss_ext_sales_price, ss_net_profit FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_items ON ss_item_sk = i_item_sk JOIN filtered_promotions ON ss_promo_sk = p_promo_sk), prefiltered_web_sales AS (SELECT ws_item_sk, ws_web_site_sk, ws_order_number, ws_ext_sales_price, ws_net_profit FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN filtered_items ON ws_item_sk = i_item_sk JOIN filtered_promotions ON ws_promo_sk = p_promo_sk), ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS \"returns\", SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM prefiltered_store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) JOIN store ON ss_store_sk = s_store_sk GROUP BY s_store_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS \"returns\", SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM prefiltered_web_sales LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) JOIN web_site ON ws_web_site_sk = web_site_sk GROUP BY web_site_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS \"returns\", SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number), date_dim, catalog_page, item, promotion WHERE cs_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL '30' DAY) AND cs_catalog_page_sk = cp_catalog_page_sk AND cs_item_sk = i_item_sk AND i_current_price > 50 AND cs_promo_sk = p_promo_sk AND p_channel_tv = 'N' GROUP BY cp_catalog_page_id)\nSELECT channel, id, SUM(sales) AS sales, SUM(\"returns\") AS \"returns\", SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, \"returns\", profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, \"returns\", profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, \"returns\", profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;", "transform": "shared_dimension_multi_channel", "original_ms": 1000.0, "rewritten_ms": 920.0, "ratio": 1.3, "outcome": "WIN", "declared_speedup": "1.30x", "sf10_speedup": 1.4, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE with ssr as  (select  s_store_id as store_id,           sum(ss_ext_sales_price) as sales,           sum(coalesce(sr_return_amt, 0)) as \"returns\",           sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit   from store_sales left outer join store_returns on          (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),      date_dim,      store,      item,      promotion  where ss_sold_date_sk = d_date_sk        and d_date between cast('1998-08-28' as date)                    and (cast('1998-08-28' as date) + INTERVAL 30 DAY)        and ss_store_sk = s_store_sk        and ss_item_sk = i_item_sk        and i_current_price > 50        and ss_promo_sk = p_promo_sk        and p_channel_tv = 'N'  group by s_store_id)  ,  csr as  (select  cp_catalog_page_id as catalog_page_id,           sum(cs_ext_sales_price) as sales,           sum(coalesce(cr_return_amount, 0)) as \"returns\",           sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit   from catalog_sales left outer join catalog_returns on          (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),      date_dim,      catalog_page,      item,      promotion  where cs_sold_date_sk = d_date_sk        and d_date between cast('1998-08-28' as date)                   and (cast('1998-08-28' as date) + INTERVAL 30 DAY)         and cs_catalog_page_sk = cp_catalog_page_sk        and cs_item_sk = i_item_sk        and i_current_price > 50        and cs_promo_sk = p_promo_sk        and p_channel_tv = 'N' group by cp_catalog_page_id)  ,  wsr as  (select  web_site_id,           sum(ws_ext_sales_price) as sales,           sum(coalesce(wr_return_amt, 0)) as \"returns\",           sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit   from web_sales left outer join web_returns on          (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),      date_dim,      web_site,      item,      promotion  where ws_sold_date_sk = d_date_sk        and d_date between cast('1998-08-28' as date)                   and (cast('1998-08-28' as date) + INTERVAL 30 DAY)         and ws_web_site_sk = web_site_sk        and ws_item_sk = i_item_sk        and i_current_price > 50        and ws_promo_sk = p_promo_sk        and p_channel_tv = 'N' group by web_site_id)   select channel         , id         , sum(sales) as sales         , sum(\"returns\") as \"returns\"         , sum(profit) as profit  from   (select 'store channel' as channel         , 'store' || store_id as id         , sales         , \"returns\"         , profit  from   ssr  union all  select 'catalog channel' as channel         , 'catalog_page' || catalog_page_id as id         , sales         , \"returns\"         , profit  from  csr  union all  select 'web channel' as channel         , 'web_site' || web_site_id as id         , sales         , \"returns\"         , profit  from   wsr  ) x  group by rollup (channel, id)  order by channel          ,id  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││               Total Time: 1.00s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    TOP_N    │\n│    ──────   │\n│     Top:    │\n│     100     │\n│             │\n│  Order By:  │\n│x.channel ASC│\n│   x.id ASC  │\n│             │\n│   100 Rows  │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│HASH_GROUP_BY│\n│    ──────   │\n│   Groups:   │\n│      #0     │\n│      #1     │\n│             │\n│ Aggregates: │\n│   sum(#2)   │\n│   sum(#3)   │\n│   sum(#4)   │\n│             │\n│   520 Rows  │\n│   (0.03s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│   channel   │\n│      id     │\n│    sales    │\n│   returns   │\n│    profit   │\n│             │\n│   516 Rows  │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    UNION    │\n│    ──────   │\n│    0 Rows   ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                                                                                                                                            │\n└──────┬──────┘                                                                                                                                                                            │\n┌──────┴──────┐                                                                                                                                                                     ┌──────┴──────┐\n│    UNION    │                                                                                                                                                                     │  PROJECTION │\n│    ──────   │                                                                                                                                                                     │    ──────   │\n│             │                                                                                                                                                                     │   channel   │\n│             │                                                                                                                                                                     │      id     │\n│             │                                                                                                                                                                     │    sales    │\n│             ├──────────────────────────────────────────────────────────────────────────────────┐                                                                                  │   returns   │\n│             │                                                                                  │                                                                                  │    profit   │\n│             │                                                                                  │                                                                                  │             │\n│    0 Rows   │                                                                                  │                                                                                  │   21 Rows   │\n│   (0.00s)   │                                                                                  │                                                                                  │   (0.00s)   │\n└──────┬──────┘                                                                                  │                                                                                  └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│  PROJECTION │                                                                           │  PROJECTION │                                                                           │HASH_GROUP_BY│\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│   channel   │                                                                           │   channel   │                                                                           │   Groups:   │\n│      id     │                                                                           │      id     │                                                                           │      #0     │\n│    sales    │                                                                           │    sales    │                                                                           │             │\n│   returns   │                                                                           │   returns   │                                                                           │ Aggregates: │\n│    profit   │                                                                           │    profit   │                                                                           │   sum(#1)   │\n│             │                                                                           │             │                                                                           │   sum(#2)   │\n│             │                                                                           │             │                                                                           │   sum(#3)   │\n│             │                                                                           │             │                                                                           │             │\n│   51 Rows   │                                                                           │   444 Rows  │                                                                           │   21 Rows   │\n│   (0.00s)   │                                                                           │   (0.00s)   │                                                                           │   (0.02s)   │\n└──────┬──────┘                                                                           └──────┬──────┘                                                                           └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│HASH_GROUP_BY│                                                                           │HASH_GROUP_BY│                                                                           │  PROJECTION │\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│   Groups:   │                                                                           │   Groups:   │                                                                           │ web_site_id │\n│      #0     │                                                                           │      #0     │                                                                           │ws_ext_sales_│\n│             │                                                                           │             │                                                                           │    price    │\n│ Aggregates: │                                                                           │ Aggregates: │                                                                           │   COALESCE  │\n│   sum(#1)   │                                                                           │   sum(#1)   │                                                                           │(CAST(wr_retu│\n│   sum(#2)   │                                                                           │   sum(#2)   │                                                                           │  rn_amt AS  │\n│   sum(#3)   │                                                                           │   sum(#3)   │                                                                           │  DECIMAL(12 │\n│             │                                                                           │             │                                                                           │ ,2)), 0.00) │\n│             │                                                                           │             │                                                                           │(CAST(ws_net_│\n│             │                                                                           │             │                                                                           │  profit AS  │\n│             │                                                                           │             │                                                                           │  DECIMAL(13 │\n│             │                                                                           │             │                                                                           │,2)) - COALES│\n│             │                                                                           │             │                                                                           │CE(CAST(wr_ne│\n│             │                                                                           │             │                                                                           │  t_loss AS  │\n│             │                                                                           │             │                                                                           │  DECIMAL(12 │\n│             │                                                                           │             │                                                                           │ ,2)), 0.00))│\n│             │                                                                           │             │                                                                           │             │\n│   51 Rows   │                                                                           │   444 Rows  │                                                                           │  8702 Rows  │\n│   (0.18s)   │                                                                           │   (0.00s)   │                                                                           │   (0.00s)   │\n└──────┬──────┘                                                                           └──────┬──────┘                                                                           └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│  PROJECTION │                                                                           │  PROJECTION │                                                                           │  PROJECTION │\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│  s_store_id │                                                                           │cp_catalog_pa│                                                                           │      #0     │\n│ss_ext_sales_│                                                                           │    ge_id    │                                                                           │      #1     │\n... (185 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL '30' DAY)), filtered_items AS (SELECT i_item_sk FROM item WHERE i_current_price > 50), filtered_promotions AS (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'), prefiltered_store_sales AS (SELECT ss_item_sk, ss_store_sk, ss_ticket_number, ss_ext_sales_price, ss_net_profit FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_items ON ss_item_sk = i_item_sk JOIN filtered_promotions ON ss_promo_sk = p_promo_sk), prefiltered_web_sales AS (SELECT ws_item_sk, ws_web_site_sk, ws_order_number, ws_ext_sales_price, ws_net_profit FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN filtered_items ON ws_item_sk = i_item_sk JOIN filtered_promotions ON ws_promo_sk = p_promo_sk), ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS \"returns\", SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM prefiltered_store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) JOIN store ON ss_store_sk = s_store_sk GROUP BY s_store_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS \"returns\", SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM prefiltered_web_sales LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) JOIN web_site ON ws_web_site_sk = web_site_sk GROUP BY web_site_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS \"returns\", SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number), date_dim, catalog_page, item, promotion WHERE cs_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL '30' DAY) AND cs_catalog_page_sk = cp_catalog_page_sk AND cs_item_sk = i_item_sk AND i_current_price > 50 AND cs_promo_sk = p_promo_sk AND p_channel_tv = 'N' GROUP BY cp_catalog_page_id) SELECT channel, id, SUM(sales) AS sales, SUM(\"returns\") AS \"returns\", SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, \"returns\", profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, \"returns\", profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, \"returns\", profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.920s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    TOP_N    │\n│    ──────   │\n│     Top:    │\n│     100     │\n│             │\n│  Order By:  │\n│x.channel ASC│\n│   x.id ASC  │\n│             │\n│   100 Rows  │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│HASH_GROUP_BY│\n│    ──────   │\n│   Groups:   │\n│      #0     │\n│      #1     │\n│             │\n│ Aggregates: │\n│   sum(#2)   │\n│   sum(#3)   │\n│   sum(#4)   │\n│             │\n│   520 Rows  │\n│   (0.01s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│   channel   │\n│      id     │\n│    sales    │\n│   returns   │\n│    profit   │\n│             │\n│   516 Rows  │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    UNION    │\n│    ──────   │\n│    0 Rows   ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                                                                                                                                            │\n└──────┬──────┘                                                                                                                                                                            │\n┌──────┴──────┐                                                                                                                                                                     ┌──────┴──────┐\n│    UNION    │                                                                                                                                                                     │  PROJECTION │\n│    ──────   │                                                                                                                                                                     │    ──────   │\n│             │                                                                                                                                                                     │   channel   │\n│             │                                                                                                                                                                     │      id     │\n│             │                                                                                                                                                                     │    sales    │\n│             ├──────────────────────────────────────────────────────────────────────────────────┐                                                                                  │   returns   │\n│             │                                                                                  │                                                                                  │    profit   │\n│             │                                                                                  │                                                                                  │             │\n│    0 Rows   │                                                                                  │                                                                                  │   21 Rows   │\n│   (0.00s)   │                                                                                  │                                                                                  │   (0.00s)   │\n└──────┬──────┘                                                                                  │                                                                                  └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│  PROJECTION │                                                                           │  PROJECTION │                                                                           │HASH_GROUP_BY│\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│   channel   │                                                                           │   channel   │                                                                           │   Groups:   │\n│      id     │                                                                           │      id     │                                                                           │      #0     │\n│    sales    │                                                                           │    sales    │                                                                           │             │\n│   returns   │                                                                           │   returns   │                                                                           │ Aggregates: │\n│    profit   │                                                                           │    profit   │                                                                           │   sum(#1)   │\n│             │                                                                           │             │                                                                           │   sum(#2)   │\n│             │                                                                           │             │                                                                           │   sum(#3)   │\n│             │                                                                           │             │                                                                           │             │\n│   51 Rows   │                                                                           │   444 Rows  │                                                                           │   21 Rows   │\n│   (0.00s)   │                                                                           │   (0.00s)   │                                                                           │   (0.00s)   │\n└──────┬──────┘                                                                           └──────┬──────┘                                                                           └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│HASH_GROUP_BY│                                                                           │HASH_GROUP_BY│                                                                           │  PROJECTION │\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│   Groups:   │                                                                           │   Groups:   │                                                                           │ web_site_id │\n│      #0     │                                                                           │      #0     │                                                                           │ws_ext_sales_│\n│             │                                                                           │             │                                                                           │    price    │\n│ Aggregates: │                                                                           │ Aggregates: │                                                                           │   COALESCE  │\n│   sum(#1)   │                                                                           │   sum(#1)   │                                                                           │(CAST(wr_retu│\n│   sum(#2)   │                                                                           │   sum(#2)   │                                                                           │  rn_amt AS  │\n│   sum(#3)   │                                                                           │   sum(#3)   │                                                                           │  DECIMAL(12 │\n│             │                                                                           │             │                                                                           │ ,2)), 0.00) │\n│             │                                                                           │             │                                                                           │(CAST(ws_net_│\n│             │                                                                           │             │                                                                           │  profit AS  │\n│             │                                                                           │             │                                                                           │  DECIMAL(13 │\n│             │                                                                           │             │                                                                           │,2)) - COALES│\n│             │                                                                           │             │                                                                           │CE(CAST(wr_ne│\n│             │                                                                           │             │                                                                           │  t_loss AS  │\n│             │                                                                           │             │                                                                           │  DECIMAL(12 │\n│             │                                                                           │             │                                                                           │ ,2)), 0.00))│\n│             │                                                                           │             │                                                                           │             │\n│   51 Rows   │                                                                           │   444 Rows  │                                                                           │  8702 Rows  │\n│   (0.01s)   │                                                                           │   (0.00s)   │                                                                           │   (0.00s)   │\n└──────┬──────┘                                                                           └──────┬──────┘                                                                           └──────┬──────┘\n┌──────┴──────┐                                                                           ┌──────┴──────┐                                                                           ┌──────┴──────┐\n│  PROJECTION │                                                                           │  PROJECTION │                                                                           │  PROJECTION │\n│    ──────   │                                                                           │    ──────   │                                                                           │    ──────   │\n│  s_store_id │                                                                           │cp_catalog_pa│                                                                           │      #0     │\n│ss_ext_sales_│                                                                           │    ge_id    │                                                                           │      #1     │\n... (196 more lines truncated)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q80"]}
{"id": 9, "query_sql": "select case when (select count(*) \n                  from store_sales \n                  where ss_quantity between 1 and 20) > 2972190\n            then (select avg(ss_ext_sales_price) \n                  from store_sales \n                  where ss_quantity between 1 and 20) \n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 1 and 20) end bucket1 ,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 21 and 40) > 4505785\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 21 and 40) \n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 21 and 40) end bucket2,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 41 and 60) > 1575726\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 41 and 60)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 41 and 60) end bucket3,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 61 and 80) > 3188917\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 61 and 80)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 61 and 80) end bucket4,\n       case when (select count(*)\n                  from store_sales\n                  where ss_quantity between 81 and 100) > 3525216\n            then (select avg(ss_ext_sales_price)\n                  from store_sales\n                  where ss_quantity between 81 and 100)\n            else (select avg(ss_net_profit)\n                  from store_sales\n                  where ss_quantity between 81 and 100) end bucket5\nfrom reason\nwhere r_reason_sk = 1;", "rewritten_sql": "WITH sales_stats AS (SELECT COUNT(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 END) AS cnt1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_ext_sales_price END) AS avg_price1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_net_profit END) AS avg_profit1, COUNT(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN 1 END) AS cnt2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_ext_sales_price END) AS avg_price2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_net_profit END) AS avg_profit2, COUNT(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN 1 END) AS cnt3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_ext_sales_price END) AS avg_price3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_net_profit END) AS avg_profit3, COUNT(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN 1 END) AS cnt4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_ext_sales_price END) AS avg_price4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_net_profit END) AS avg_profit4, COUNT(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN 1 END) AS cnt5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_ext_sales_price END) AS avg_price5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_net_profit END) AS avg_profit5 FROM store_sales)\nSELECT CASE WHEN s.cnt1 > 2972190 THEN s.avg_price1 ELSE s.avg_profit1 END AS bucket1, CASE WHEN s.cnt2 > 4505785 THEN s.avg_price2 ELSE s.avg_profit2 END AS bucket2, CASE WHEN s.cnt3 > 1575726 THEN s.avg_price3 ELSE s.avg_profit3 END AS bucket3, CASE WHEN s.cnt4 > 3188917 THEN s.avg_price4 ELSE s.avg_profit4 END AS bucket4, CASE WHEN s.cnt5 > 3525216 THEN s.avg_price5 ELSE s.avg_profit5 END AS bucket5 FROM reason AS r, sales_stats AS s WHERE r.r_reason_sk = 1;", "transform": "single_pass_aggregation", "original_ms": 520.0, "rewritten_ms": 576.0, "ratio": 4.47, "outcome": "WIN", "declared_speedup": "4.47x", "sf10_speedup": null, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select case when (select count(*)                    from store_sales                    where ss_quantity between 1 and 20) > 2972190             then (select avg(ss_ext_sales_price)                    from store_sales                    where ss_quantity between 1 and 20)              else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 1 and 20) end bucket1 ,        case when (select count(*)                   from store_sales                   where ss_quantity between 21 and 40) > 4505785             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 21 and 40)              else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 21 and 40) end bucket2,        case when (select count(*)                   from store_sales                   where ss_quantity between 41 and 60) > 1575726             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 41 and 60)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 41 and 60) end bucket3,        case when (select count(*)                   from store_sales                   where ss_quantity between 61 and 80) > 3188917             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 61 and 80)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 61 and 80) end bucket4,        case when (select count(*)                   from store_sales                   where ss_quantity between 81 and 100) > 3525216             then (select avg(ss_ext_sales_price)                   from store_sales                   where ss_quantity between 81 and 100)             else (select avg(ss_net_profit)                   from store_sales                   where ss_quantity between 81 and 100) end bucket5 from reason where r_reason_sk = 1;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.520s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│   bucket1   │\n│   bucket2   │\n│   bucket3   │\n│   bucket4   │\n│   bucket5   │\n│             │\n│    1 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│CROSS_PRODUCT│\n│    ──────   │\n│    1 Rows   ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                                                                                │\n└──────┬──────┘                                                                                                                │\n┌──────┴──────┐                                                                                                         ┌──────┴──────┐\n│CROSS_PRODUCT│                                                                                                         │CROSS_PRODUCT│\n│    ──────   │                                                                                                         │    ──────   │\n│    1 Rows   ├────────────────────────────────────────────────────┐                                                    │    1 Rows   ├─────────────────────────────────────────────────────────────────────────────────────────────────┐\n│   (0.00s)   │                                                    │                                                    │   (0.00s)   │                                                                                                 │\n└──────┬──────┘                                                    │                                                    └──────┬──────┘                                                                                                 │\n┌──────┴──────┐                                             ┌──────┴──────┐                                             ┌──────┴──────┐                                                                                          ┌──────┴──────┐\n│CROSS_PRODUCT│                                             │CROSS_PRODUCT│                                             │CROSS_PRODUCT│                                                                                          │  PROJECTION │\n│    ──────   │                                             │    ──────   │                                             │    ──────   │                                                                                          │    ──────   │\n│             │                                             │             │                                             │             │                                                                                          │ CASE  WHEN (│\n│             │                                             │             │                                             │             │                                                                                          │  (#1 > 1))  │\n│             │                                             │             │                                             │             │                                                                                          │  THEN (error│\n│             │                                             │             │                                             │             │                                                                                          │ ('More than │\n│             │                                             │             │                                             │             │                                                                                          │    one row  │\n│             │                                             │             │                                             │             │                                                                                          │  returned by│\n│             │                                             │             │                                             │             │                                                                                          │  a subquery │\n│             │                                             │             │                                             │             │                                                                                          │  used as an │\n│             │                                             │             │                                             │             │                                                                                          │  expression │\n│             │                                             │             │                                             │             │                                                                                          │   - scalar  │\n│             │                                             │             │                                             │             │                                                                                          │  subqueries │\n│             │                                             │             │                                             │             │                                                                                          │   can only  │\n│             │                                             │             │                                             │             │                                                                                          │   return a  │\n│             ├──────────────────────┐                      │             ├──────────────────────┐                      │             ├──────────────────────────────────────────────────────────────────────────────────┐       │  single row.│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   Use \"SET  │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ scalar_subqu│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ery_error_on_│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │multiple_rows│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  =false\" to │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   revert to │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │   previous  │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  behavior of│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  returning a│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │  random row.│\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │ ')) ELSE #0 │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │      END    │\n│             │                      │                      │             │                      │                      │             │                                                                                  │       │             │\n│    1 Rows   │                      │                      │    1 Rows   │                      │                      │    1 Rows   │                                                                                  │       │    1 Rows   │\n│   (0.00s)   │                      │                      │   (0.00s)   │                      │                      │   (0.00s)   │                                                                                  │       │   (0.00s)   │\n└──────┬──────┘                      │                      └──────┬──────┘                      │                      └──────┬──────┘                                                                                  │       └──────┬──────┘\n┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐               ┌──────┴──────┐                                                                           ┌──────┴──────┐┌──────┴──────┐\n│CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│               │CROSS_PRODUCT│                                                                           │  PROJECTION ││UNGROUPE...  │\n│    ──────   │               │    ──────   │               │    ──────   │               │    ──────   │               │    ──────   │                                                                           │    ──────   ││    ──────   │\n│             │               │             │               │             │               │             │               │             │                                                                           │ CASE  WHEN (││ Aggregates: │\n│             │               │             │               │             │               │             │               │             │                                                                           │  (#1 > 1))  ││ \"first\"(#0) │\n│             │               │             │               │             │               │             │               │             │                                                                           │  THEN (error││ count_star()│\n│             │               │             │               │             │               │             │               │             │                                                                           │ ('More than ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │    one row  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  returned by││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  a subquery ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  used as an ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  expression ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   - scalar  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │  subqueries ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   can only  ││             │\n│             │               │             │               │             │               │             │               │             │                                                                           │   return a  ││             │\n│             ├───────┐       │             ├───────┐       │             ├───────┐       │             ├───────┐       │             ├───────────────────────────────────────────────────────────────────┐       │  single row.││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   Use \"SET  ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ scalar_subqu││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ery_error_on_││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │multiple_rows││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  =false\" to ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   revert to ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │   previous  ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  behavior of││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  returning a││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │  random row.││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │ ')) ELSE #0 ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │      END    ││             │\n│             │       │       │             │       │       │             │       │       │             │       │       │             │                                                                   │       │             ││             │\n│    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │       │       │    1 Rows   │                                                                   │       │    1 Rows   ││    1 Rows   │\n│   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │       │       │   (0.00s)   │                                                                   │       │   (0.00s)   ││   (0.00s)   │\n└──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘       │       └──────┬──────┘                                                                   │       └──────┬──────┘└──────┬──────┘\n┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐                                                            ┌──────┴──────┐┌──────┴──────┐┌──────┴──────┐\n│  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││  PROJECTION ││CROSS_PRODUCT│                                                            │  PROJECTION ││UNGROUPE...  ││  PROJECTION │\n│    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   ││    ──────   │                                                            │    ──────   ││    ──────   ││    ──────   │\n│ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││ CASE  WHEN (││             │                                                            │ CASE  WHEN (││ Aggregates: ││      #0     │\n│  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││  (#1 > 1))  ││             │                                                            │  (#1 > 1))  ││ \"first\"(#0) ││             │\n│  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││  THEN (error││             │                                                            │  THEN (error││ count_star()││             │\n│ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││ ('More than ││             │                                                            │ ('More than ││             ││             │\n│    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││    one row  ││             │                                                            │    one row  ││             ││             │\n│  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││  returned by││             │                                                            │  returned by││             ││             │\n│  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││  a subquery ││             │                                                            │  a subquery ││             ││             │\n... (223 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH sales_stats AS (SELECT COUNT(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 END) AS cnt1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_ext_sales_price END) AS avg_price1, AVG(CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN ss_net_profit END) AS avg_profit1, COUNT(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN 1 END) AS cnt2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_ext_sales_price END) AS avg_price2, AVG(CASE WHEN ss_quantity BETWEEN 21 AND 40 THEN ss_net_profit END) AS avg_profit2, COUNT(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN 1 END) AS cnt3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_ext_sales_price END) AS avg_price3, AVG(CASE WHEN ss_quantity BETWEEN 41 AND 60 THEN ss_net_profit END) AS avg_profit3, COUNT(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN 1 END) AS cnt4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_ext_sales_price END) AS avg_price4, AVG(CASE WHEN ss_quantity BETWEEN 61 AND 80 THEN ss_net_profit END) AS avg_profit4, COUNT(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN 1 END) AS cnt5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_ext_sales_price END) AS avg_price5, AVG(CASE WHEN ss_quantity BETWEEN 81 AND 100 THEN ss_net_profit END) AS avg_profit5 FROM store_sales) SELECT CASE WHEN s.cnt1 > 2972190 THEN s.avg_price1 ELSE s.avg_profit1 END AS bucket1, CASE WHEN s.cnt2 > 4505785 THEN s.avg_price2 ELSE s.avg_profit2 END AS bucket2, CASE WHEN s.cnt3 > 1575726 THEN s.avg_price3 ELSE s.avg_profit3 END AS bucket3, CASE WHEN s.cnt4 > 3188917 THEN s.avg_price4 ELSE s.avg_profit4 END AS bucket4, CASE WHEN s.cnt5 > 3525216 THEN s.avg_price5 ELSE s.avg_profit5 END AS bucket5 FROM reason AS r, sales_stats AS s WHERE r.r_reason_sk = 1;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.576s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│          bucket1          │\n│          bucket2          │\n│          bucket3          │\n│          bucket4          │\n│          bucket5          │\n│                           │\n│           1 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       CROSS_PRODUCT       │\n│    ────────────────────   │\n│           1 Rows          ├──────────────┐\n│          (0.00s)          │              │\n└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│    UNGROUPED_AGGREGATE    ││         TABLE_SCAN        │\n│    ────────────────────   ││    ────────────────────   │\n│        Aggregates:        ││           reason          │\n│         count(#0)         ││                           │\n│          avg(#1)          ││          Filters:         │\n│          avg(#2)          ││     r_reason_sk=1 AND     │\n│         count(#3)         ││   r_reason_sk IS NOT NULL │\n│          avg(#4)          ││                           │\n│          avg(#5)          ││                           │\n│         count(#6)         ││                           │\n│          avg(#7)          ││                           │\n│          avg(#8)          ││                           │\n│         count(#9)         ││                           │\n│          avg(#10)         ││                           │\n│          avg(#11)         ││                           │\n│         count(#12)        ││                           │\n│          avg(#13)         ││                           │\n│          avg(#14)         ││                           │\n│                           ││                           │\n│           1 Rows          ││           1 Rows          │\n│          (0.72s)          ││          (0.01s)          │\n└─────────────┬─────────────┘└───────────────────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│ CASE  WHEN (((ss_quantity │\n│         <= 20) AND        │\n│   constant_or_null(true,  │\n│  ss_quantity, 1))) THEN (1│\n│      ) ELSE NULL END      │\n│ CASE  WHEN (((ss_quantity │\n│         <= 20) AND        │\n│   constant_or_null(true,  │\n│   ss_quantity, 1))) THEN  │\n│ (ss_ext_sales_price) ELSE │\n│          NULL END         │\n│ CASE  WHEN (((ss_quantity │\n│         <= 20) AND        │\n│   constant_or_null(true,  │\n│   ss_quantity, 1))) THEN  │\n│ (ss_net_profit) ELSE NULL │\n│             END           │\n│ CASE  WHEN (((ss_quantity │\n│ >= 21) AND (ss_quantity <=│\n│  40))) THEN (1) ELSE NULL │\n│             END           │\n│ CASE  WHEN (((ss_quantity │\n│ >= 21) AND (ss_quantity <=│\n│         40))) THEN        │\n│ (ss_ext_sales_price) ELSE │\n│          NULL END         │\n│ CASE  WHEN (((ss_quantity │\n│ >= 21) AND (ss_quantity <=│\n│  40))) THEN (ss_net_profit│\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         TABLE_SCAN        │\n│    ────────────────────   │\n│        store_sales        │\n│                           │\n│        Projections:       │\n│        ss_quantity        │\n│     ss_ext_sales_price    │\n│       ss_net_profit       │\n│                           │\n│       28800991 Rows       │\n│          (11.76s)         │\n└───────────────────────────┘", "gap": "REDUNDANT_SCAN_ELIMINATION", "queries": ["Q9"]}
{"id": 10, "query_sql": "select * from\n (select count(*) h8_30_to_9\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 8 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s1,\n (select count(*) h9_to_9_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 9 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s2,\n (select count(*) h9_30_to_10\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 9 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s3,\n (select count(*) h10_to_10_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 10 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s4,\n (select count(*) h10_30_to_11\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 10 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s5,\n (select count(*) h11_to_11_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 11 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s6,\n (select count(*) h11_30_to_12\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 11 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s7,\n (select count(*) h12_to_12_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 12 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s8;", "rewritten_sql": "WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = -1 AND hd_vehicle_count <= -1 + 2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4 + 2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3 + 2)), time_ranges AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_window FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), sales_with_time AS (SELECT tr.time_window FROM store_sales ss JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_hd fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN time_ranges tr ON ss.ss_sold_time_sk = tr.t_time_sk)\nSELECT COUNT(CASE WHEN time_window = 1 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN time_window = 2 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN time_window = 3 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN time_window = 4 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN time_window = 5 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN time_window = 6 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN time_window = 7 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN time_window = 8 THEN 1 END) AS h12_to_12_30 FROM sales_with_time;", "transform": "channel_bitmap_aggregation", "original_ms": 353.0, "rewritten_ms": 244.0, "ratio": 6.24, "outcome": "WIN", "declared_speedup": "6.24x", "sf10_speedup": 6.24, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select * from  (select count(*) h8_30_to_9  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 8 and time_dim.t_minute >= 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s1,  (select count(*) h9_to_9_30  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 9 and time_dim.t_minute < 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s2,  (select count(*) h9_30_to_10  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 9 and time_dim.t_minute >= 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s3,  (select count(*) h10_to_10_30  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 10 and time_dim.t_minute < 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s4,  (select count(*) h10_30_to_11  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 10 and time_dim.t_minute >= 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s5,  (select count(*) h11_to_11_30  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 11 and time_dim.t_minute < 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s6,  (select count(*) h11_30_to_12  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 11 and time_dim.t_minute >= 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s7,  (select count(*) h12_to_12_30  from store_sales, household_demographics, time_dim, store  where ss_sold_time_sk = time_dim.t_time_sk    and ss_hdemo_sk = household_demographics.hd_demo_sk    and ss_store_sk = s_store_sk    and time_dim.t_hour = 12 and time_dim.t_minute < 30    and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or         (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or         (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))    and store.s_store_name = 'ese') s8;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.353s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│  h8_30_to_9 │\n│  h9_to_9_30 │\n│ h9_30_to_10 │\n│ h10_to_10_30│\n│ h10_30_to_11│\n│ h11_to_11_30│\n│ h11_30_to_12│\n│ h12_to_12_30│\n│             │\n│    1 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│CROSS_PRODUCT│\n│    ──────   │\n│    1 Rows   ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n│   (0.00s)   │                                                                                                                                                                                                                                 \n└──────┬──────┘                                                                                                                                                                                                                                 \n┌──────┴──────┐                                                                                                                                                                                                                                 \n│CROSS_PRODUCT│                                                                                                                                                                                                                                 \n│    ──────   │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n│             │                                                                                                                                                                                                                                 \n│    1 Rows   │                                                                                                                                                                                                                                 \n│   (0.00s)   │                                                                                                                                                                                                                                 \n└──────┬──────┘                                                                                                                                                                                                                                 \n┌──────┴──────┐                                                                                                                                                                                                                                 \n│CROSS_PRODUCT│                                                                                                                                                                                                                                 \n│    ──────   │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│    1 Rows   │                                                                                                                                                                                                                                 \n│   (0.00s)   │                                                                                                                                                                                                                                 \n└──────┬──────┘                                                                                                                                                                                                                                 \n┌──────┴──────┐                                                                                                                                                                                                                                 \n│CROSS_PRODUCT│                                                                                                                                                                                                                                 \n│    ──────   │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             ├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│    1 Rows   │                                                                                                                                                                                                                                 \n│   (0.00s)   │                                                                                                                                                                                                                                 \n└──────┬──────┘                                                                                                                                                                                                                                 \n┌──────┴──────┐                                                                                                                                                                                                                                 \n│CROSS_PRODUCT│                                                                                                                                                                                                                                 \n│    ──────   │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             │                                                                                                                                                                                                                                 \n│             ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐                                                    \n│             │                                                                                                                                                                            │                                                    \n│             │                                                                                                                                                                            │                                                    \n│             │                                                                                                                                                                            │                                                    \n│             │                                                                                                                                                                            │                                                    \n│             │                                                                                                                                                                            │                                                    \n│             │                                                                                                                                                                            │                                                    \n│    1 Rows   │                                                                                                                                                                            │                                                    \n│   (0.00s)   │                                                                                                                                                                            │                                                    \n└──────┬──────┘                                                                                                                                                                            │                                                    \n┌──────┴──────┐                                                                                                                                                                     ┌──────┴──────┐                                             \n│CROSS_PRODUCT│                                                                                                                                                                     │UNGROUPE...  │                                             \n│    ──────   │                                                                                                                                                                     │    ──────   │                                             \n│             │                                                                                                                                                                     │ Aggregates: │                                             \n│             │                                                                                                                                                                     │ count_star()│                                             \n│             │                                                                                                                                                                     │             │                                             \n│             │                                                                                                                                                                     │             │                                             \n│             │                                                                                                                                                                     │             │                                             \n│             │                                                                                                                                                                     │             │                                             \n│             │                                                                                                                                                                     │             │                                             \n│             ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐                                                    │             │                                             \n│             │                                                                                                                │                                                    │             │                                             \n... (146 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = -1 AND hd_vehicle_count <= -1 + 2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4 + 2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3 + 2)), time_ranges AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_window FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), sales_with_time AS (SELECT tr.time_window FROM store_sales ss JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_hd fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN time_ranges tr ON ss.ss_sold_time_sk = tr.t_time_sk) SELECT COUNT(CASE WHEN time_window = 1 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN time_window = 2 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN time_window = 3 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN time_window = 4 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN time_window = 5 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN time_window = 6 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN time_window = 7 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN time_window = 8 THEN 1 END) AS h12_to_12_30 FROM sales_with_time;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.244s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│    UNGROUPED_AGGREGATE    │\n│    ────────────────────   │\n│        Aggregates:        │\n│         count(#0)         │\n│         count(#1)         │\n│         count(#2)         │\n│         count(#3)         │\n│         count(#4)         │\n│         count(#5)         │\n│         count(#6)         │\n│         count(#7)         │\n│                           │\n│           1 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│ CASE  WHEN ((time_window =│\n│ 1)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 2)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 3)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 4)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 5)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 6)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 7)) THEN (1) ELSE NULL END│\n│ CASE  WHEN ((time_window =│\n│ 8)) THEN (1) ELSE NULL END│\n│                           │\n│        239752 Rows        │\n│          (0.01s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        time_window        │\n│                           │\n│        239752 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│ss_sold_time_sk = t_time_sk│\n│                           ├────────────────────────────────────────────────────────────────────────┐\n│      Build Min: 28800     │                                                                        │\n│      Build Max: 75599     │                                                                        │\n│                           │                                                                        │\n│        239752 Rows        │                                                                        │\n│          (0.00s)          │                                                                        │\n└─────────────┬─────────────┘                                                                        │\n┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐\n│         HASH_JOIN         │                                                          │         PROJECTION        │\n│    ────────────────────   │                                                          │    ────────────────────   │\n│      Join Type: INNER     │                                                          │         t_time_sk         │\n│                           │                                                          │        time_window        │\n│        Conditions:        │                                                          │                           │\n│  ss_hdemo_sk = hd_demo_sk │                                                          │                           │\n│                           ├───────────────────────────────────────────┐              │                           │\n│        Build Min: 1       │                                           │              │                           │\n│      Build Max: 7200      │                                           │              │                           │\n│                           │                                           │              │                           │\n│        239752 Rows        │                                           │              │         14400 Rows        │\n│          (0.01s)          │                                           │              │          (0.00s)          │\n└─────────────┬─────────────┘                                           │              └─────────────┬─────────────┘\n┌─────────────┴─────────────┐                             ┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         HASH_JOIN         │                             │         PROJECTION        ││           FILTER          │\n│    ────────────────────   │                             │    ────────────────────   ││    ────────────────────   │\n│      Join Type: INNER     │                             │         hd_demo_sk        ││    (((t_hour = 8) AND     │\n│                           │                             │                           ││   (t_minute >= 30)) OR (  │\n│        Conditions:        │                             │                           ││ (t_hour = 9) AND (t_minute│\n│  ss_store_sk = s_store_sk │                             │                           ││   < 30)) OR ((t_hour = 9) │\n│                           │                             │                           ││  AND (t_minute >= 30)) OR │\n│        Build Min: 1       │                             │                           ││    ((t_hour = 10) AND     │\n│       Build Max: 100      │                             │                           ││   (t_minute < 30)) OR (   │\n│                           │                             │                           ││     (t_hour = 10) AND     │\n│                           ├──────────────┐              │                           ││   (t_minute >= 30)) OR (  │\n│                           │              │              │                           ││     (t_hour = 11) AND     │\n│                           │              │              │                           ││   (t_minute < 30)) OR (   │\n│                           │              │              │                           ││     (t_hour = 11) AND     │\n│                           │              │              │                           ││   (t_minute >= 30)) OR (  │\n│                           │              │              │                           ││     (t_hour = 12) AND     │\n│                           │              │              │                           ││     (t_minute < 30)))     │\n│                           │              │              │                           ││                           │\n│        1043920 Rows       │              │              │         1440 Rows         ││         14400 Rows        │\n│          (0.02s)          │              │              │          (0.00s)          ││          (0.00s)          │\n└─────────────┬─────────────┘              │              └─────────────┬─────────────┘└─────────────┬─────────────┘\n┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         TABLE_SCAN        ││           FILTER          ││         PROJECTION        ││         TABLE_SCAN        │\n│    ────────────────────   ││    ────────────────────   ││    ────────────────────   ││    ────────────────────   │\n... (43 more lines truncated)", "gap": "REDUNDANT_SCAN_ELIMINATION", "queries": ["Q88"]}
{"id": 11, "query_sql": "with customer_total_return as\n(select sr_customer_sk as ctr_customer_sk\n,sr_store_sk as ctr_store_sk\n,sum(SR_FEE) as ctr_total_return\nfrom store_returns\n,date_dim\nwhere sr_returned_date_sk = d_date_sk\nand d_year =2000\ngroup by sr_customer_sk\n,sr_store_sk)\n select c_customer_id\nfrom customer_total_return ctr1\n,store\n,customer\nwhere ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2\nfrom customer_total_return ctr2\nwhere ctr1.ctr_store_sk = ctr2.ctr_store_sk)\nand s_store_sk = ctr1.ctr_store_sk\nand s_state = 'SD'\nand ctr1.ctr_customer_sk = c_customer_sk\norder by c_customer_id\n LIMIT 100;", "rewritten_sql": "WITH filtered_returns AS (SELECT sr.sr_customer_sk, sr.sr_store_sk, sr.SR_FEE FROM store_returns AS sr JOIN date_dim AS d ON sr.sr_returned_date_sk = d.d_date_sk JOIN store AS s ON sr.sr_store_sk = s.s_store_sk WHERE d.d_year = 2000 AND s.s_state = 'SD'), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM filtered_returns GROUP BY sr_customer_sk, sr_store_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_store_sk)\nSELECT c.c_customer_id FROM customer_total_return AS ctr1 JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id LIMIT 100;", "transform": "decorrelate", "original_ms": 143.0, "rewritten_ms": 98.6, "ratio": 2.92, "outcome": "WIN", "declared_speedup": "2.92x", "sf10_speedup": 1.87, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE with customer_total_return as (select sr_customer_sk as ctr_customer_sk ,sr_store_sk as ctr_store_sk ,sum(SR_FEE) as ctr_total_return from store_returns ,date_dim where sr_returned_date_sk = d_date_sk and d_year =2000 group by sr_customer_sk ,sr_store_sk)  select c_customer_id from customer_total_return ctr1 ,store ,customer where ctr1.ctr_total_return > (select avg(ctr_total_return)*1.2 from customer_total_return ctr2 where ctr1.ctr_store_sk = ctr2.ctr_store_sk) and s_store_sk = ctr1.ctr_store_sk and s_state = 'SD' and ctr1.ctr_customer_sk = c_customer_sk order by c_customer_id  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.143s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────┐\n│         QUERY         │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│    EXPLAIN_ANALYZE    │\n│    ────────────────   │\n│         0 Rows        │\n│        (0.00s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│         TOP_N         │\n│    ────────────────   │\n│        Top: 100       │\n│                       │\n│       Order By:       │\n│ customer.c_customer_id│\n│           ASC         │\n│                       │\n│        100 Rows       │\n│        (0.01s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│       PROJECTION      │\n│    ────────────────   │\n│     c_customer_id     │\n│                       │\n│       61974 Rows      │\n│        (0.00s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│          CTE          │\n│    ────────────────   │\n│       CTE Name:       │\n│ customer_total_return │\n│                       ├─────────────────────────────────────┐\n│     Table Index: 0    │                                     │\n│                       │                                     │\n│         0 Rows        │                                     │\n│        (0.00s)        │                                     │\n└───────────┬───────────┘                                     │\n┌───────────┴───────────┐                         ┌───────────┴───────────┐\n│       PROJECTION      │                         │         FILTER        │\n│    ────────────────   │                         │    ────────────────   │\n│           #0          │                         │ (CAST(ctr_total_return│\n│__internal_decompress_i│                         │ AS DOUBLE) > SUBQUERY)│\n│ ntegral_integer(#1, 1)│                         │                       │\n│           #2          │                         │                       │\n│                       │                         │                       │\n│      539331 Rows      │                         │       61974 Rows      │\n│        (0.00s)        │                         │        (0.00s)        │\n└───────────┬───────────┘                         └───────────┬───────────┘\n┌───────────┴───────────┐                         ┌───────────┴───────────┐\n│     HASH_GROUP_BY     │                         │    RIGHT_DELIM_JOIN   │\n│    ────────────────   │                         │    ────────────────   │\n│        Groups:        │                         │    Join Type: RIGHT   │\n│           #0          │                         │                       │\n│           #1          │                         │      Conditions:      │\n│                       │                         │  ctr_store_sk IS NOT  │\n│      Aggregates:      │                         │      DISTINCT FROM    ├──────────────────────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────┐\n│        sum(#2)        │                         │      ctr_store_sk     │                                                              │                                                                          │\n│                       │                         │                       │                                                              │                                                                          │\n│                       │                         │     Delim Index: 1    │                                                              │                                                                          │\n│                       │                         │                       │                                                              │                                                                          │\n│      539331 Rows      │                         │         0 Rows        │                                                              │                                                                          │\n│        (0.42s)        │                         │        (0.01s)        │                                                              │                                                                          │\n└───────────┬───────────┘                         └───────────┬───────────┘                                                              │                                                                          │\n┌───────────┴───────────┐                         ┌───────────┴───────────┐                                                  ┌───────────┴───────────┐                                                  ┌───────────┴───────────┐\n│       PROJECTION      │                         │       HASH_JOIN       │                                                  │       HASH_JOIN       │                                                  │     HASH_GROUP_BY     │\n│    ────────────────   │                         │    ────────────────   │                                                  │    ────────────────   │                                                  │    ────────────────   │\n│     sr_customer_sk    │                         │    Join Type: INNER   │                                                  │    Join Type: RIGHT   │                                                  │       Groups: #3      │\n│      sr_store_sk      │                         │                       │                                                  │                       │                                                  │                       │\n│         sr_fee        │                         │      Conditions:      │                                                  │      Conditions:      │                                                  │                       │\n│                       │                         │    c_customer_sk =    ├────────────┐                                     │  ctr_store_sk IS NOT  ├─────────────────────────────────────┐            │                       │\n│                       │                         │     ctr_customer_sk   │            │                                     │      DISTINCT FROM    │                                     │            │                       │\n│                       │                         │                       │            │                                     │      ctr_store_sk     │                                     │            │                       │\n│                       │                         │                       │            │                                     │                       │                                     │            │                       │\n│      557705 Rows      │                         │      157785 Rows      │            │                                     │      157785 Rows      │                                     │            │        15 Rows        │\n│        (0.00s)        │                         │        (0.05s)        │            │                                     │        (0.05s)        │                                     │            │        (0.00s)        │\n└───────────┬───────────┘                         └───────────┬───────────┘            │                                     └───────────┬───────────┘                                     │            └───────────────────────┘\n┌───────────┴───────────┐                         ┌───────────┴───────────┐┌───────────┴───────────┐                         ┌───────────┴───────────┐                         ┌───────────┴───────────┐\n│       PROJECTION      │                         │       TABLE_SCAN      ││       HASH_JOIN       │                         │       PROJECTION      │                         │       DUMMY_SCAN      │\n│    ────────────────   │                         │    ────────────────   ││    ────────────────   │                         │    ────────────────   │                         │    ────────────────   │\n│__internal_compress_int│                         │        customer       ││    Join Type: INNER   │                         │ (avg(ctr_total_return)│                         │                       │\n│  egral_usmallint(#0,  │                         │                       ││                       │                         │         * 1.2)        │                         │                       │\n│        2450820)       │                         │                       ││      Conditions:      │                         │      ctr_store_sk     │                         │                       │\n│           #1          │                         │                       ││     ctr_store_sk =    │                         │                       │                         │                       │\n│__internal_compress_int│                         │                       ││       s_store_sk      │                         │                       │                         │                       │\n│ egral_utinyint(#2, 1) │                         │                       ││                       ├────────────┐            │                       │                         │                       │\n│           #3          │                         │                       ││                       │            │            │                       │                         │                       │\n│__internal_compress_int│                         │                       ││                       │            │            │                       │                         │                       │\n│  egral_usmallint(#4,  │                         │                       ││                       │            │            │                       │                         │                       │\n│        2450820)       │                         │                       ││                       │            │            │                       │                         │                       │\n│                       │                         │                       ││                       │            │            │                       │                         │                       │\n│      557705 Rows      │                         │      499996 Rows      ││      157800 Rows      │            │            │        15 Rows        │                         │         0 Rows        │\n│        (0.01s)        │                         │        (0.06s)        ││        (0.02s)        │            │            │        (0.00s)        │                         │        (0.00s)        │\n└───────────┬───────────┘                         └───────────────────────┘└───────────┬───────────┘            │            └───────────┬───────────┘                         └───────────────────────┘\n┌───────────┴───────────┐                                                  ┌───────────┴───────────┐┌───────────┴───────────┐┌───────────┴───────────┐\n│       HASH_JOIN       │                                                  │        CTE_SCAN       ││       TABLE_SCAN      ││     HASH_GROUP_BY     │\n│    ────────────────   │                                                  │    ────────────────   ││    ────────────────   ││    ────────────────   │\n│    Join Type: INNER   │                                                  │      CTE Index: 0     ││         store         ││       Groups: #0      │\n│                       │                                                  │                       ││                       ││                       │\n│      Conditions:      │                                                  │                       ││        Filters:       ││      Aggregates:      │\n│ sr_returned_date_sk = │                                                  │                       ││    s_state='SD' AND   ││        avg(#1)        │\n│        d_date_sk      │                                                  │                       ││   s_state IS NOT NULL ││                       │\n│                       │                                                  │                       ││                       ││                       │\n│       Build Min:      ├────────────┐                                     │                       ││                       ││                       │\n│        2450820        │            │                                     │                       ││                       ││                       │\n│                       │            │                                     │                       ││                       ││                       │\n│       Build Max:      │            │                                     │                       ││                       ││                       │\n... (42 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_returns AS (SELECT sr.sr_customer_sk, sr.sr_store_sk, sr.SR_FEE FROM store_returns AS sr JOIN date_dim AS d ON sr.sr_returned_date_sk = d.d_date_sk JOIN store AS s ON sr.sr_store_sk = s.s_store_sk WHERE d.d_year = 2000 AND s.s_state = 'SD'), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM filtered_returns GROUP BY sr_customer_sk, sr_store_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c.c_customer_id FROM customer_total_return AS ctr1 JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold ORDER BY c.c_customer_id LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.0986s             ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│    c.c_customer_id ASC    │\n│                           │\n│          100 Rows         │\n│          (0.02s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│       c_customer_id       │\n│                           │\n│         61974 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│            CTE            │\n│    ────────────────────   │\n│         CTE Name:         │\n│   customer_total_return   │\n│                           ├────────────────────────────────────────────────────────────────────────┐\n│       Table Index: 0      │                                                                        │\n│                           │                                                                        │\n│           0 Rows          │                                                                        │\n│          (0.00s)          │                                                                        │\n└─────────────┬─────────────┘                                                                        │\n┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐\n│         PROJECTION        │                                                          │         HASH_JOIN         │\n│    ────────────────────   │                                                          │    ────────────────────   │\n│             #0            │                                                          │      Join Type: INNER     │\n│__internal_decompress_integ│                                                          │                           │\n│     ral_integer(#1, 1)    │                                                          │        Conditions:        │\n│             #2            │                                                          │      c_customer_sk =      ├──────────────┐\n│                           │                                                          │       ctr_customer_sk     │              │\n│                           │                                                          │                           │              │\n│        157800 Rows        │                                                          │         61974 Rows        │              │\n│          (0.00s)          │                                                          │          (0.02s)          │              │\n└─────────────┬─────────────┘                                                          └─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐                                                          ┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │                                                          │         TABLE_SCAN        ││         HASH_JOIN         │\n│    ────────────────────   │                                                          │    ────────────────────   ││    ────────────────────   │\n│          Groups:          │                                                          │          customer         ││      Join Type: INNER     │\n│             #0            │                                                          │                           ││                           │\n│             #1            │                                                          │                           ││        Conditions:        │\n│                           │                                                          │                           ││ctr_store_sk = ctr_store_sk│\n│    Aggregates: sum(#2)    │                                                          │                           ││  CAST(ctr_total_return AS ├──────────────┐\n│                           │                                                          │                           ││          DOUBLE) >        │              │\n│                           │                                                          │                           ││    avg_return_threshold   │              │\n│                           │                                                          │                           ││                           │              │\n│        157800 Rows        │                                                          │        499996 Rows        ││         61989 Rows        │              │\n│          (0.21s)          │                                                          │          (0.04s)          ││          (0.01s)          │              │\n└─────────────┬─────────────┘                                                          └───────────────────────────┘└─────────────┬─────────────┘              │\n┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐┌─────────────┴─────────────┐\n│         PROJECTION        │                                                                                       │          CTE_SCAN         ││         PROJECTION        │\n│    ────────────────────   │                                                                                       │    ────────────────────   ││    ────────────────────   │\n│       sr_customer_sk      │                                                                                       │        CTE Index: 0       ││        ctr_store_sk       │\n│        sr_store_sk        │                                                                                       │                           ││    avg_return_threshold   │\n│           sr_fee          │                                                                                       │                           ││                           │\n│                           │                                                                                       │                           ││                           │\n│        161697 Rows        │                                                                                       │        157800 Rows        ││          15 Rows          │\n│          (0.00s)          │                                                                                       │          (0.00s)          ││          (0.00s)          │\n└─────────────┬─────────────┘                                                                                       └───────────────────────────┘└─────────────┬─────────────┘\n┌─────────────┴─────────────┐                                                                                                                    ┌─────────────┴─────────────┐\n│         PROJECTION        │                                                                                                                    │       HASH_GROUP_BY       │\n│    ────────────────────   │                                                                                                                    │    ────────────────────   │\n│             #0            │                                                                                                                    │         Groups: #0        │\n│__internal_compress_integra│                                                                                                                    │    Aggregates: avg(#1)    │\n│     l_utinyint(#1, 1)     │                                                                                                                    │                           │\n│             #2            │                                                                                                                    │                           │\n│                           │                                                                                                                    │                           │\n│        161697 Rows        │                                                                                                                    │          15 Rows          │\n│          (0.00s)          │                                                                                                                    │          (0.03s)          │\n└─────────────┬─────────────┘                                                                                                                    └─────────────┬─────────────┘\n┌─────────────┴─────────────┐                                                                                                                    ┌─────────────┴─────────────┐\n│         PROJECTION        │                                                                                                                    │         PROJECTION        │\n│    ────────────────────   │                                                                                                                    │    ────────────────────   │\n│       sr_customer_sk      │                                                                                                                    │        ctr_store_sk       │\n│        sr_store_sk        │                                                                                                                    │      ctr_total_return     │\n│           sr_fee          │                                                                                                                    │                           │\n│                           │                                                                                                                    │                           │\n│        161697 Rows        │                                                                                                                    │        157800 Rows        │\n│          (0.00s)          │                                                                                                                    │          (0.00s)          │\n└─────────────┬─────────────┘                                                                                                                    └─────────────┬─────────────┘\n┌─────────────┴─────────────┐                                                                                                                    ┌─────────────┴─────────────┐\n│         HASH_JOIN         │                                                                                                                    │          CTE_SCAN         │\n│    ────────────────────   │                                                                                                                    │    ────────────────────   │\n│      Join Type: INNER     │                                                                                                                    │        CTE Index: 0       │\n│                           │                                                                                                                    │                           │\n│        Conditions:        │                                                                                                                    │                           │\n│  sr_store_sk = s_store_sk │                                                                                                                    │                           │\n│                           ├───────────────────────────────────────────┐                                                                        │                           │\n│        Build Min: 1       │                                           │                                                                        │                           │\n│       Build Max: 100      │                                           │                                                                        │                           │\n│                           │                                           │                                                                        │                           │\n│        161697 Rows        │                                           │                                                                        │        157800 Rows        │\n│          (0.00s)          │                                           │                                                                        │          (0.00s)          │\n... (46 more lines truncated)", "gap": "CORRELATED_SUBQUERY_PARALYSIS", "queries": ["Q1"]}
{"id": 12, "query_sql": "select  \n  ca_state,\n  cd_gender,\n  cd_marital_status,\n  cd_dep_count,\n  count(*) cnt1,\n  max(cd_dep_count),\n  sum(cd_dep_count),\n  max(cd_dep_count),\n  cd_dep_employed_count,\n  count(*) cnt2,\n  max(cd_dep_employed_count),\n  sum(cd_dep_employed_count),\n  max(cd_dep_employed_count),\n  cd_dep_college_count,\n  count(*) cnt3,\n  max(cd_dep_college_count),\n  sum(cd_dep_college_count),\n  max(cd_dep_college_count)\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  cd_demo_sk = c.c_current_cdemo_sk and \n  exists (select *\n          from store_sales,date_dim\n          where c.c_customer_sk = ss_customer_sk and\n                ss_sold_date_sk = d_date_sk and\n                d_year = 2001 and\n                d_qoy < 4) and\n   (exists (select *\n            from web_sales,date_dim\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_sold_date_sk = d_date_sk and\n                  d_year = 2001 and\n                  d_qoy < 4) or \n    exists (select * \n            from catalog_sales,date_dim\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_sold_date_sk = d_date_sk and\n                  d_year = 2001 and\n                  d_qoy < 4))\n group by ca_state,\n          cd_gender,\n          cd_marital_status,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n order by ca_state,\n          cd_gender,\n          cd_marital_status,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4), store_customers AS (SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), web_customers AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), catalog_customers AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk), web_or_catalog_customers AS (SELECT ws_bill_customer_sk AS customer_sk FROM web_customers UNION SELECT cs_ship_customer_sk AS customer_sk FROM catalog_customers)\nSELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers AS sc ON c.c_customer_sk = sc.ss_customer_sk JOIN web_or_catalog_customers AS wcc ON c.c_customer_sk = wcc.customer_sk GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;", "transform": "composite_decorrelate_union", "original_ms": 449.0, "rewritten_ms": 320.0, "ratio": 2.42, "outcome": "WIN", "declared_speedup": "2.42x", "sf10_speedup": 2.01, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select     ca_state,   cd_gender,   cd_marital_status,   cd_dep_count,   count(*) cnt1,   max(cd_dep_count),   sum(cd_dep_count),   max(cd_dep_count),   cd_dep_employed_count,   count(*) cnt2,   max(cd_dep_employed_count),   sum(cd_dep_employed_count),   max(cd_dep_employed_count),   cd_dep_college_count,   count(*) cnt3,   max(cd_dep_college_count),   sum(cd_dep_college_count),   max(cd_dep_college_count)  from   customer c,customer_address ca,customer_demographics  where   c.c_current_addr_sk = ca.ca_address_sk and   cd_demo_sk = c.c_current_cdemo_sk and    exists (select *           from store_sales,date_dim           where c.c_customer_sk = ss_customer_sk and                 ss_sold_date_sk = d_date_sk and                 d_year = 2001 and                 d_qoy < 4) and    (exists (select *             from web_sales,date_dim             where c.c_customer_sk = ws_bill_customer_sk and                   ws_sold_date_sk = d_date_sk and                   d_year = 2001 and                   d_qoy < 4) or      exists (select *              from catalog_sales,date_dim             where c.c_customer_sk = cs_ship_customer_sk and                   cs_sold_date_sk = d_date_sk and                   d_year = 2001 and                   d_qoy < 4))  group by ca_state,           cd_gender,           cd_marital_status,           cd_dep_count,           cd_dep_employed_count,           cd_dep_college_count  order by ca_state,           cd_gender,           cd_marital_status,           cd_dep_count,           cd_dep_employed_count,           cd_dep_college_count  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.449s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────┐\n│    QUERY    │\n└──────┬──────┘\n┌──────┴──────┐\n│EXPLAIN_...  │\n│    ──────   │\n│    0 Rows   │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│    TOP_N    │\n│    ──────   │\n│     Top:    │\n│     100     │\n│             │\n│  Order By:  │\n│ ca.ca_state │\n│      ASC    │\n│customer_demo│\n│   graphics  │\n│  .cd_gender │\n│      ASC    │\n│customer_demo│\n│   graphics  │\n│.cd_marital_s│\n│  tatus ASC  │\n│customer_demo│\n│   graphics  │\n│.cd_dep_count│\n│      ASC    │\n│customer_demo│\n│   graphics  │\n│.cd_dep_emplo│\n│yed_count ASC│\n│customer_demo│\n│   graphics  │\n│.cd_dep_colle│\n│ ge_count ASC│\n│             │\n│   100 Rows  │\n│   (0.01s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│   ca_state  │\n│  cd_gender  │\n│cd_marital_st│\n│     atus    │\n│ cd_dep_count│\n│     cnt1    │\n│max(cd_dep_co│\n│     unt)    │\n│sum(cd_dep_co│\n│     unt)    │\n│max(cd_dep_co│\n│     unt)    │\n│cd_dep_employ│\n│   ed_count  │\n│     cnt2    │\n│max(cd_dep_em│\n│ployed_count)│\n│sum(cd_dep_em│\n│ployed_count)│\n│max(cd_dep_em│\n│ployed_count)│\n│cd_dep_colleg│\n│   e_count   │\n│     cnt3    │\n│max(cd_dep_co│\n│ llege_count)│\n│sum(cd_dep_co│\n│ llege_count)│\n│max(cd_dep_co│\n└──────┬──────┘\n┌──────┴──────┐\n│  PROJECTION │\n│    ──────   │\n│__internal_de│\n│compress_stri│\n│    ng(#0)   │\n│__internal_de│\n│compress_stri│\n│    ng(#1)   │\n│__internal_de│\n│compress_stri│\n│    ng(#2)   │\n│      #3     │\n│      #4     │\n│      #5     │\n│      #6     │\n│      #7     │\n│      #8     │\n│      #9     │\n│     #10     │\n│     #11     │\n│     #12     │\n│             │\n│  57571 Rows │\n│   (0.00s)   │\n└──────┬──────┘\n┌──────┴──────┐\n│HASH_GROUP_BY│\n│    ──────   │\n│   Groups:   │\n│      #0     │\n│      #1     │\n│      #2     │\n│      #3     │\n... (265 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4), store_customers AS (SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk), web_customers AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), catalog_customers AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk), web_or_catalog_customers AS (SELECT ws_bill_customer_sk AS customer_sk FROM web_customers UNION SELECT cs_ship_customer_sk AS customer_sk FROM catalog_customers) SELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers AS sc ON c.c_customer_sk = sc.ss_customer_sk JOIN web_or_catalog_customers AS wcc ON c.c_customer_sk = wcc.customer_sk GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.320s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────┐\n│         QUERY         │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│    EXPLAIN_ANALYZE    │\n│    ────────────────   │\n│         0 Rows        │\n│        (0.00s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│         TOP_N         │\n│    ────────────────   │\n│        Top: 100       │\n│                       │\n│       Order By:       │\n│    ca.ca_state ASC    │\n│ customer_demographics │\n│     .cd_gender ASC    │\n│ customer_demographics │\n│ .cd_marital_status ASC│\n│ customer_demographics │\n│   .cd_dep_count ASC   │\n│ customer_demographics │\n│ .cd_dep_employed_count│\n│           ASC         │\n│ customer_demographics │\n│ .cd_dep_college_count │\n│           ASC         │\n│                       │\n│        100 Rows       │\n│        (0.01s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│       PROJECTION      │\n│    ────────────────   │\n│        ca_state       │\n│       cd_gender       │\n│   cd_marital_status   │\n│      cd_dep_count     │\n│          cnt1         │\n│   max(cd_dep_count)   │\n│   sum(cd_dep_count)   │\n│   max(cd_dep_count)   │\n│ cd_dep_employed_count │\n│          cnt2         │\n│max(cd_dep_employed_cou│\n│          nt)          │\n│sum(cd_dep_employed_cou│\n│          nt)          │\n│max(cd_dep_employed_cou│\n│          nt)          │\n│  cd_dep_college_count │\n│          cnt3         │\n│max(cd_dep_college_coun│\n│           t)          │\n│sum(cd_dep_college_coun│\n│           t)          │\n│max(cd_dep_college_coun│\n│           t)          │\n│                       │\n│       57571 Rows      │\n│        (0.00s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│       PROJECTION      │\n│    ────────────────   │\n│__internal_decompress_s│\n│       tring(#0)       │\n│__internal_decompress_s│\n│       tring(#1)       │\n│__internal_decompress_s│\n│       tring(#2)       │\n│           #3          │\n│           #4          │\n│           #5          │\n│           #6          │\n│           #7          │\n│           #8          │\n│           #9          │\n│          #10          │\n│          #11          │\n│          #12          │\n│                       │\n│       57571 Rows      │\n│        (0.00s)        │\n└───────────┬───────────┘\n┌───────────┴───────────┐\n│     HASH_GROUP_BY     │\n│    ────────────────   │\n│        Groups:        │\n│           #0          │\n│           #1          │\n│           #2          │\n│           #3          │\n│           #4          │\n│           #5          │\n│                       │\n│      Aggregates:      │\n│      count_star()     │\n│        max(#6)        │\n│        sum(#7)        │\n│        max(#8)        │\n│        sum(#9)        │\n│        max(#10)       │\n│        sum(#11)       │\n│                       │\n│       57571 Rows      │\n│        (0.02s)        │\n└───────────┬───────────┘\n... (195 more lines truncated)", "gap": "CORRELATED_SUBQUERY_PARALYSIS", "queries": ["Q35"]}
{"id": 13, "query_sql": "select ca_zip\n       ,sum(cs_sales_price)\n from catalog_sales\n     ,customer\n     ,customer_address\n     ,date_dim\n where cs_bill_customer_sk = c_customer_sk\n \tand c_current_addr_sk = ca_address_sk \n \tand ( substr(ca_zip,1,5) in ('85669', '86197','88274','83405','86475',\n                                   '85392', '85460', '80348', '81792')\n \t      or ca_state in ('CA','WA','GA')\n \t      or cs_sales_price > 500)\n \tand cs_sold_date_sk = d_date_sk\n \tand d_qoy = 1 and d_year = 2001\n group by ca_zip\n order by ca_zip\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001), filtered_sales AS (SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE SUBSTRING(ca_zip, 1, 5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('CA', 'WA', 'GA') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE cs_sales_price > 500)\nSELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100;", "transform": "or_to_union", "original_ms": 93.3, "rewritten_ms": 52.5, "ratio": 3.17, "outcome": "WIN", "declared_speedup": "3.17x", "sf10_speedup": 1.52, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select ca_zip        ,sum(cs_sales_price)  from catalog_sales      ,customer      ,customer_address      ,date_dim  where cs_bill_customer_sk = c_customer_sk  \tand c_current_addr_sk = ca_address_sk   \tand ( substr(ca_zip,1,5) in ('85669', '86197','88274','83405','86475',                                    '85392', '85460', '80348', '81792')  \t      or ca_state in ('CA','WA','GA')  \t      or cs_sales_price > 500)  \tand cs_sold_date_sk = d_date_sk  \tand d_qoy = 1 and d_year = 2001  group by ca_zip  order by ca_zip  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.0933s             ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│customer_address.ca_zip ASC│\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│__internal_decompress_strin│\n│           g(#0)           │\n│             #1            │\n│                           │\n│          520 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│         Groups: #0        │\n│    Aggregates: sum(#1)    │\n│                           │\n│          520 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│           ca_zip          │\n│       cs_sales_price      │\n│                           │\n│         33303 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│__internal_compress_integra│\n│  l_usmallint(#1, 2450815) │\n│__internal_compress_string_│\n│        ubigint(#2)        │\n│__internal_compress_string_│\n│        uinteger(#3)       │\n│             #4            │\n│__internal_compress_integra│\n│  l_usmallint(#5, 2450815) │\n│                           │\n│         33303 Rows        │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         HASH_JOIN         │\n│    ────────────────────   │\n│      Join Type: INNER     │\n│                           │\n│        Conditions:        │\n│cs_sold_date_sk = d_date_sk│\n│                           ├─────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│     Build Min: 2450815    │                                                                                                     │\n│     Build Max: 2452653    │                                                                                                     │\n│                           │                                                                                                     │\n│         33303 Rows        │                                                                                                     │\n│          (0.00s)          │                                                                                                     │\n└─────────────┬─────────────┘                                                                                                     │\n┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐\n│         PROJECTION        │                                                                                       │           FILTER          │\n│    ────────────────────   │                                                                                       │    ────────────────────   │\n│             #1            │                                                                                       │ (d_date_sk BETWEEN 2450815│\n│             #2            │                                                                                       │        AND 2452653)       │\n│             #4            │                                                                                       │                           │\n│             #5            │                                                                                       │                           │\n│             #6            │                                                                                       │                           │\n│                           │                                                                                       │                           │\n│         33303 Rows        │                                                                                       │          91 Rows          │\n│          (0.00s)          │                                                                                       │          (0.00s)          │\n└─────────────┬─────────────┘                                                                                       └─────────────┬─────────────┘\n┌─────────────┴─────────────┐                                                                                       ┌─────────────┴─────────────┐\n│           FILTER          │                                                                                       │         TABLE_SCAN        │\n│    ────────────────────   │                                                                                       │    ────────────────────   │\n│ (IN (...) OR ((ca_state = │                                                                                       │          date_dim         │\n│ 'CA') OR (ca_state = 'WA')│                                                                                       │                           │\n│  OR (ca_state = 'GA')) OR │                                                                                       │        Projections:       │\n│   constant_or_null(false, │                                                                                       │         d_date_sk         │\n│  cs_sales_price, 500.00)) │                                                                                       │                           │\n│                           │                                                                                       │          Filters:         │\n│                           │                                                                                       │  d_qoy=1 AND d_qoy IS NOT │\n│                           │                                                                                       │            NULL           │\n│                           │                                                                                       │ d_year=2001 AND d_year IS │\n│                           │                                                                                       │          NOT NULL         │\n│                           │                                                                                       │                           │\n│         33303 Rows        │                                                                                       │          91 Rows          │\n│          (0.01s)          │                                                                                       │          (0.00s)          │\n└─────────────┬─────────────┘                                                                                       └───────────────────────────┘\n┌─────────────┴─────────────┐\n... (53 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001), filtered_sales AS (SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE SUBSTRING(ca_zip, 1, 5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('CA', 'WA', 'GA') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE cs_sales_price > 500) SELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.0525s             ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────┐\n│     QUERY     │\n└───────┬───────┘\n┌───────┴───────┐\n│EXPLAIN_ANALYZE│\n│    ────────   │\n│     0 Rows    │\n│    (0.00s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│     TOP_N     │\n│    ────────   │\n│    Top: 100   │\n│               │\n│   Order By:   │\n│ filtered_sales│\n│  .ca_zip ASC  │\n│               │\n│    100 Rows   │\n│    (0.00s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│   PROJECTION  │\n│    ────────   │\n│__internal_deco│\n│ mpress_string(│\n│      #0)      │\n│       #1      │\n│               │\n│    520 Rows   │\n│    (0.00s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│ HASH_GROUP_BY │\n│    ────────   │\n│    Groups:    │\n│       #0      │\n│               │\n│  Aggregates:  │\n│    sum(#1)    │\n│               │\n│    520 Rows   │\n│    (0.01s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│   PROJECTION  │\n│    ────────   │\n│     ca_zip    │\n│ cs_sales_price│\n│               │\n│   33303 Rows  │\n│    (0.00s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│   PROJECTION  │\n│    ────────   │\n│       #0      │\n│__internal_comp│\n│ress_string_ubi│\n│    gint(#1)   │\n│               │\n│   33303 Rows  │\n│    (0.00s)    │\n└───────┬───────┘\n┌───────┴───────┐\n│     UNION     │\n│    ────────   │\n│     0 Rows    ├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│    (0.00s)    │                                                                                                                                                │\n└───────┬───────┘                                                                                                                                                │\n┌───────┴───────┐                                                                                                                                        ┌───────┴───────┐\n│     UNION     │                                                                                                                                        │   PROJECTION  │\n│    ────────   │                                                                                                                                        │    ────────   │\n│               │                                                                                                                                        │ cs_sales_price│\n│               ├────────────────────────────────────────────────────────────────────────────┐                                                           │     ca_zip    │\n│               │                                                                            │                                                           │               │\n│     0 Rows    │                                                                            │                                                           │     0 Rows    │\n│    (0.00s)    │                                                                            │                                                           │    (0.00s)    │\n└───────┬───────┘                                                                            │                                                           └───────┬───────┘\n┌───────┴───────┐                                                                    ┌───────┴───────┐                                                   ┌───────┴───────┐\n│   PROJECTION  │                                                                    │   PROJECTION  │                                                   │   HASH_JOIN   │\n│    ────────   │                                                                    │    ────────   │                                                   │    ────────   │\n│ cs_sales_price│                                                                    │ cs_sales_price│                                                   │   Join Type:  │\n│     ca_zip    │                                                                    │     ca_zip    │                                                   │     INNER     │\n│               │                                                                    │               │                                                   │               │\n│               │                                                                    │               │                                                   │  Conditions:  │\n│               │                                                                    │               │                                                   │ ca_address_sk │\n│               │                                                                    │               │                                                   │= c_current_add│\n│               │                                                                    │               │                                                   │      r_sk     │\n│               │                                                                    │               │                                                   │               ├────────┐\n│               │                                                                    │               │                                                   │   Build Min:  │        │\n│               │                                                                    │               │                                                   │       1       │        │\n│               │                                                                    │               │                                                   │               │        │\n│               │                                                                    │               │                                                   │   Build Max:  │        │\n│               │                                                                    │               │                                                   │     250000    │        │\n│               │                                                                    │               │                                                   │               │        │\n│    53 Rows    │                                                                    │   33250 Rows  │                                                   │     0 Rows    │        │\n│    (0.00s)    │                                                                    │    (0.00s)    │                                                   │    (0.00s)    │        │\n└───────┬───────┘                                                                    └───────┬───────┘                                                   └───────┬───────┘        │\n┌───────┴───────┐                                                                    ┌───────┴───────┐                                                   ┌───────┴───────┐┌───────┴───────┐\n│   HASH_JOIN   │                                                                    │   HASH_JOIN   │                                                   │   TABLE_SCAN  ││   HASH_JOIN   │\n│    ────────   │                                                                    │    ────────   │                                                   │    ────────   ││    ────────   │\n│   Join Type:  │                                                                    │   Join Type:  │                                                   │customer_addres││   Join Type:  │\n│     INNER     │                                                                    │     INNER     │                                                   │       s       ││     INNER     │\n│               │                                                                    │               │                                                   │               ││               │\n│  Conditions:  │                                                                    │  Conditions:  │                                                   │  Projections: ││  Conditions:  │\n│cs_bill_custome│                                                                    │ c_customer_sk │                                                   │ ca_address_sk ││ c_customer_sk │\n│r_sk = c_custom│                                                                    │= cs_bill_custo│                                                   │     ca_zip    ││= cs_bill_custo│\n│     er_sk     │                                                                    │     mer_sk    │                                                   │               ││     mer_sk    │\n... (76 more lines truncated)", "gap": "CROSS_COLUMN_OR_DECOMPOSITION", "queries": ["Q15"]}
{"id": 14, "query_sql": "with year_total as (\n select c_customer_id customer_id\n       ,c_first_name customer_first_name\n       ,c_last_name customer_last_name\n       ,d_year as year\n       ,stddev_samp(ss_net_paid) year_total\n       ,'s' sale_type\n from customer\n     ,store_sales\n     ,date_dim\n where c_customer_sk = ss_customer_sk\n   and ss_sold_date_sk = d_date_sk\n   and d_year in (1999,1999+1)\n group by c_customer_id\n         ,c_first_name\n         ,c_last_name\n         ,d_year\n union all\n select c_customer_id customer_id\n       ,c_first_name customer_first_name\n       ,c_last_name customer_last_name\n       ,d_year as year\n       ,stddev_samp(ws_net_paid) year_total\n       ,'w' sale_type\n from customer\n     ,web_sales\n     ,date_dim\n where c_customer_sk = ws_bill_customer_sk\n   and ws_sold_date_sk = d_date_sk\n   and d_year in (1999,1999+1)\n group by c_customer_id\n         ,c_first_name\n         ,c_last_name\n         ,d_year\n         )\n  select\n        t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name\n from year_total t_s_firstyear\n     ,year_total t_s_secyear\n     ,year_total t_w_firstyear\n     ,year_total t_w_secyear\n where t_s_secyear.customer_id = t_s_firstyear.customer_id\n         and t_s_firstyear.customer_id = t_w_secyear.customer_id\n         and t_s_firstyear.customer_id = t_w_firstyear.customer_id\n         and t_s_firstyear.sale_type = 's'\n         and t_w_firstyear.sale_type = 'w'\n         and t_s_secyear.sale_type = 's'\n         and t_w_secyear.sale_type = 'w'\n         and t_s_firstyear.year = 1999\n         and t_s_secyear.year = 1999+1\n         and t_w_firstyear.year = 1999\n         and t_w_secyear.year = 1999+1\n         and t_s_firstyear.year_total > 0\n         and t_w_firstyear.year_total > 0\n         and case when t_w_firstyear.year_total > 0 then t_w_secyear.year_total / t_w_firstyear.year_total else null end\n           > case when t_s_firstyear.year_total > 0 then t_s_secyear.year_total / t_s_firstyear.year_total else null end\n order by 2,1,3\n LIMIT 100;", "rewritten_sql": "WITH year_total AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ss_net_paid) AS year_total, 's' AS sale_type FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year UNION ALL SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ws_net_paid) AS year_total, 'w' AS sale_type FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year), year_total_store AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ss_net_paid) AS year_total FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year), year_total_web AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ws_net_paid) AS year_total FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year)\nSELECT t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name FROM year_total_store AS t_s_firstyear, year_total_store AS t_s_secyear, year_total_web AS t_w_firstyear, year_total_web AS t_w_secyear WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_secyear.customer_id AND t_s_firstyear.customer_id = t_w_firstyear.customer_id AND t_s_firstyear.year = 1999 AND t_s_secyear.year = 1999 + 1 AND t_w_firstyear.year = 1999 AND t_w_secyear.year = 1999 + 1 AND t_s_firstyear.year_total > 0 AND t_w_firstyear.year_total > 0 AND CASE WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total ELSE NULL END > CASE WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total ELSE NULL END ORDER BY 2, 1, 3 LIMIT 100;", "transform": "union_cte_split", "original_ms": 996.0, "rewritten_ms": 568.0, "ratio": 1.36, "outcome": "WIN", "declared_speedup": "1.36x", "sf10_speedup": 1.57, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE with year_total as (  select c_customer_id customer_id        ,c_first_name customer_first_name        ,c_last_name customer_last_name        ,d_year as year        ,stddev_samp(ss_net_paid) year_total        ,'s' sale_type  from customer      ,store_sales      ,date_dim  where c_customer_sk = ss_customer_sk    and ss_sold_date_sk = d_date_sk    and d_year in (1999,1999+1)  group by c_customer_id          ,c_first_name          ,c_last_name          ,d_year  union all  select c_customer_id customer_id        ,c_first_name customer_first_name        ,c_last_name customer_last_name        ,d_year as year        ,stddev_samp(ws_net_paid) year_total        ,'w' sale_type  from customer      ,web_sales      ,date_dim  where c_customer_sk = ws_bill_customer_sk    and ws_sold_date_sk = d_date_sk    and d_year in (1999,1999+1)  group by c_customer_id          ,c_first_name          ,c_last_name          ,d_year          )   select         t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name  from year_total t_s_firstyear      ,year_total t_s_secyear      ,year_total t_w_firstyear      ,year_total t_w_secyear  where t_s_secyear.customer_id = t_s_firstyear.customer_id          and t_s_firstyear.customer_id = t_w_secyear.customer_id          and t_s_firstyear.customer_id = t_w_firstyear.customer_id          and t_s_firstyear.sale_type = 's'          and t_w_firstyear.sale_type = 'w'          and t_s_secyear.sale_type = 's'          and t_w_secyear.sale_type = 'w'          and t_s_firstyear.year = 1999          and t_s_secyear.year = 1999+1          and t_w_firstyear.year = 1999          and t_w_secyear.year = 1999+1          and t_s_firstyear.year_total > 0          and t_w_firstyear.year_total > 0          and case when t_w_firstyear.year_total > 0 then t_w_secyear.year_total / t_w_firstyear.year_total else null end            > case when t_s_firstyear.year_total > 0 then t_s_secyear.year_total / t_s_firstyear.year_total else null end  order by 2,1,3  LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.996s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────────┐\n│      QUERY      │\n└────────┬────────┘\n┌────────┴────────┐\n│ EXPLAIN_ANALYZE │\n│    ──────────   │\n│      0 Rows     │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│      TOP_N      │\n│    ──────────   │\n│     Top: 100    │\n│                 │\n│    Order By:    │\n│customer_first_na│\n│      me ASC     │\n│ customer_id ASC │\n│customer_last_nam│\n│      e ASC      │\n│                 │\n│     100 Rows    │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│    PROJECTION   │\n│    ──────────   │\n│   customer_id   │\n│customer_first_na│\n│        me       │\n│customer_last_nam│\n│        e        │\n│                 │\n│    4387 Rows    │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│    PROJECTION   │\n│    ──────────   │\n│        #0       │\n│        #1       │\n│        #4       │\n│                 │\n│    4387 Rows    │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│    PROJECTION   │\n│    ──────────   │\n│        #1       │\n│        #2       │\n│        #3       │\n│        #4       │\n│        #5       │\n│        #6       │\n│        #7       │\n│                 │\n│    4387 Rows    │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│      FILTER     │\n│    ──────────   │\n│  (CASE  WHEN (  │\n│ (year_total > 0 │\n│   .0)) THEN (   │\n│  (year_total /  │\n│   year_total))  │\n│  ELSE NULL END >│\n│   CASE  WHEN (  │\n│ (year_total > 0 │\n│   .0)) THEN (   │\n│  (year_total /  │\n│   year_total))  │\n│  ELSE NULL END) │\n│                 │\n│    4387 Rows    │\n│     (0.00s)     │\n└────────┬────────┘\n┌────────┴────────┐\n│    HASH_JOIN    │\n│    ──────────   │\n│    Join Type:   │\n│      INNER      │\n│                 │\n│   Conditions:   ├───────────────────────────────────────────────┐\n│  customer_id =  │                                               │\n│    customer_id  │                                               │\n│                 │                                               │\n│    8840 Rows    │                                               │\n│     (0.01s)     │                                               │\n└────────┬────────┘                                               │\n┌────────┴────────┐                                      ┌────────┴────────┐\n│    PROJECTION   │                                      │    HASH_JOIN    │\n│    ──────────   │                                      │    ──────────   │\n│   customer_id   │                                      │    Join Type:   │\n│customer_first_na│                                      │      INNER      │\n│        me       │                                      │                 │\n│customer_last_nam│                                      │   Conditions:   ├───────────────────────────────────────────────┐\n│        e        │                                      │  customer_id =  │                                               │\n│    year_total   │                                      │    customer_id  │                                               │\n│                 │                                      │                 │                                               │\n│   309098 Rows   │                                      │    14370 Rows   │                                               │\n│     (0.00s)     │                                      │     (0.01s)     │                                               │\n└────────┬────────┘                                      └────────┬────────┘                                               │\n┌────────┴────────┐                                      ┌────────┴────────┐                                      ┌────────┴────────┐\n│    PROJECTION   │                                      │    PROJECTION   │                                      │    HASH_JOIN    │\n│    ──────────   │                                      │    ──────────   │                                      │    ──────────   │\n│        #0       │                                      │   customer_id   │                                      │    Join Type:   │\n... (201 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH year_total AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ss_net_paid) AS year_total, 's' AS sale_type FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year UNION ALL SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ws_net_paid) AS year_total, 'w' AS sale_type FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year), year_total_store AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ss_net_paid) AS year_total FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year), year_total_web AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, d_year AS year, STDDEV_SAMP(ws_net_paid) AS year_total FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year IN (1999, 1999 + 1) GROUP BY c_customer_id, c_first_name, c_last_name, d_year) SELECT t_s_secyear.customer_id, t_s_secyear.customer_first_name, t_s_secyear.customer_last_name FROM year_total_store AS t_s_firstyear, year_total_store AS t_s_secyear, year_total_web AS t_w_firstyear, year_total_web AS t_w_secyear WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id AND t_s_firstyear.customer_id = t_w_secyear.customer_id AND t_s_firstyear.customer_id = t_w_firstyear.customer_id AND t_s_firstyear.year = 1999 AND t_s_secyear.year = 1999 + 1 AND t_w_firstyear.year = 1999 AND t_w_secyear.year = 1999 + 1 AND t_s_firstyear.year_total > 0 AND t_w_firstyear.year_total > 0 AND CASE WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total ELSE NULL END > CASE WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total ELSE NULL END ORDER BY 2, 1, 3 LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.568s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌─────────────────────┐\n│        QUERY        │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│   EXPLAIN_ANALYZE   │\n│    ──────────────   │\n│        0 Rows       │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│        TOP_N        │\n│    ──────────────   │\n│       Top: 100      │\n│                     │\n│      Order By:      │\n│ customer_first_name │\n│          ASC        │\n│   customer_id ASC   │\n│  customer_last_name │\n│          ASC        │\n│                     │\n│       100 Rows      │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│      PROJECTION     │\n│    ──────────────   │\n│     customer_id     │\n│ customer_first_name │\n│  customer_last_name │\n│                     │\n│      4387 Rows      │\n│       (0.00s)       │\n└──────────┬──────────┘\n┌──────────┴──────────┐\n│         CTE         │\n│    ──────────────   │\n│      CTE Name:      │\n│   year_total_store  │\n│                     ├─────────────────────────────────────────────────────────┐\n│    Table Index: 0   │                                                         │\n│                     │                                                         │\n│        0 Rows       │                                                         │\n│       (0.01s)       │                                                         │\n└──────────┬──────────┘                                                         │\n┌──────────┴──────────┐                                              ┌──────────┴──────────┐\n│        FILTER       │                                              │         CTE         │\n│    ──────────────   │                                              │    ──────────────   │\n│ ((year = 2000) OR ( │                                              │      CTE Name:      │\n│  (year = 1999) AND  │                                              │    year_total_web   │\n│ (year_total > 0.0)))│                                              │                     ├─────────────────────────────────────────────────────────┐\n│                     │                                              │   Table Index: 10   │                                                         │\n│                     │                                              │                     │                                                         │\n│     617417 Rows     │                                              │        0 Rows       │                                                         │\n│       (0.00s)       │                                              │       (0.00s)       │                                                         │\n└──────────┬──────────┘                                              └──────────┬──────────┘                                                         │\n┌──────────┴──────────┐                                              ┌──────────┴──────────┐                                              ┌──────────┴──────────┐\n│      PROJECTION     │                                              │        FILTER       │                                              │        FILTER       │\n│    ──────────────   │                                              │    ──────────────   │                                              │    ──────────────   │\n│          #0         │                                              │ ((year = 2000) OR ( │                                              │    (CASE  WHEN (    │\n│__internal_decompress│                                              │  (year = 1999) AND  │                                              │ (year_total > 0.0)) │\n│     _string(#1)     │                                              │ (year_total > 0.0)))│                                              │  THEN ((year_total /│\n│__internal_decompress│                                              │                     │                                              │   year_total)) ELSE │\n│     _string(#2)     │                                              │                     │                                              │   NULL END > CASE   │\n│__internal_decompress│                                              │                     │                                              │  WHEN ((year_total >│\n│ _integral_integer(#3│                                              │                     │                                              │     0.0)) THEN (    │\n│       , 1999)       │                                              │                     │                                              │    (year_total /    │\n│          #4         │                                              │                     │                                              │   year_total)) ELSE │\n│                     │                                              │                     │                                              │       NULL END)     │\n│                     │                                              │                     │                                              │                     │\n│     617417 Rows     │                                              │     214319 Rows     │                                              │      4387 Rows      │\n│       (0.01s)       │                                              │       (0.00s)       │                                              │       (0.00s)       │\n└──────────┬──────────┘                                              └──────────┬──────────┘                                              └──────────┬──────────┘\n┌──────────┴──────────┐                                              ┌──────────┴──────────┐                                              ┌──────────┴──────────┐\n│    HASH_GROUP_BY    │                                              │      PROJECTION     │                                              │      HASH_JOIN      │\n│    ──────────────   │                                              │    ──────────────   │                                              │    ──────────────   │\n│       Groups:       │                                              │          #0         │                                              │      Join Type:     │\n│          #0         │                                              │__internal_decompress│                                              │        INNER        │\n│          #1         │                                              │     _string(#1)     │                                              │                     │\n│          #2         │                                              │__internal_decompress│                                              │     Conditions:     │\n│          #3         │                                              │     _string(#2)     │                                              │    customer_id =    │\n│                     │                                              │__internal_decompress│                                              │      customer_id    ├───────────┐\n│     Aggregates:     │                                              │ _integral_integer(#3│                                              │    customer_id =    │           │\n│   stddev_samp(#4)   │                                              │       , 1999)       │                                              │      customer_id    │           │\n│                     │                                              │          #4         │                                              │    customer_id =    │           │\n│                     │                                              │                     │                                              │      customer_id    │           │\n│                     │                                              │                     │                                              │                     │           │\n│     617417 Rows     │                                              │     214319 Rows     │                                              │      8840 Rows      │           │\n│       (0.93s)       │                                              │       (0.00s)       │                                              │       (0.05s)       │           │\n└──────────┬──────────┘                                              └──────────┬──────────┘                                              └──────────┬──────────┘           │\n┌──────────┴──────────┐                                              ┌──────────┴──────────┐                                              ┌──────────┴──────────┐┌──────────┴──────────┐\n│      PROJECTION     │                                              │    HASH_GROUP_BY    │                                              │        FILTER       ││      HASH_JOIN      │\n│    ──────────────   │                                              │    ──────────────   │                                              │    ──────────────   ││    ──────────────   │\n│    c_customer_id    │                                              │       Groups:       │                                              │ ((year = 1999) AND  ││      Join Type:     │\n│     c_first_name    │                                              │          #0         │                                              │ (year_total > 0.0)) ││        INNER        │\n│     c_last_name     │                                              │          #1         │                                              │                     ││                     │\n│        d_year       │                                              │          #2         │                                              │                     ││     Conditions:     │\n│ CAST(ss_net_paid AS │                                              │          #3         │                                              │                     ││    customer_id =    ├───────────┐\n│        DOUBLE)      │                                              │                     │                                              │                     ││      customer_id    │           │\n│                     │                                              │     Aggregates:     │                                              │                     ││    customer_id =    │           │\n│                     │                                              │   stddev_samp(#4)   │                                              │                     ││      customer_id    │           │\n│                     │                                              │                     │                                              │                     ││                     │           │\n│    10766229 Rows    │                                              │     214319 Rows     │                                              │     308319 Rows     ││      14338 Rows     │           │\n│       (0.04s)       │                                              │       (1.11s)       │                                              │       (0.01s)       ││       (0.14s)       │           │\n└──────────┬──────────┘                                              └──────────┬──────────┘                                              └──────────┬──────────┘└──────────┬──────────┘           │\n┌──────────┴──────────┐                                              ┌──────────┴──────────┐                                              ┌──────────┴──────────┐┌──────────┴──────────┐┌──────────┴──────────┐\n│      PROJECTION     │                                              │      PROJECTION     │                                              │       CTE_SCAN      ││        FILTER       ││      HASH_JOIN      │\n│    ──────────────   │                                              │    ──────────────   │                                              │    ──────────────   ││    ──────────────   ││    ──────────────   │\n│          #0         │                                              │    c_customer_id    │                                              │     CTE Index: 0    ││    (year = 2000)    ││      Join Type:     │\n... (118 more lines truncated)", "gap": "UNION_CTE_SELF_JOIN_DECOMPOSITION", "queries": ["Q74"]}
{"id": 15, "query_sql": "select sum(ss_net_profit)/sum(ss_ext_sales_price) as gross_margin, i_category, i_class, grouping(i_category)+grouping(i_class) as lochierarchy, rank() over (partition by grouping(i_category)+grouping(i_class), case when grouping(i_class) = 0 then i_category end order by sum(ss_net_profit)/sum(ss_ext_sales_price) asc) as rank_within_parent from store_sales, date_dim d1, item, store where d1.d_year = 2002 and d1.d_date_sk = ss_sold_date_sk and i_item_sk = ss_item_sk and s_store_sk = ss_store_sk and s_state in ('SD','TN','GA','SC','MO','AL','MI','OH') group by rollup(i_category,i_class) order by lochierarchy desc, case when lochierarchy = 0 then i_category end, rank_within_parent LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH')), item_sums AS (SELECT ss_item_sk, SUM(ss_net_profit) AS net_profit, SUM(ss_ext_sales_price) AS sales_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_stores ON ss_store_sk = filtered_stores.s_store_sk GROUP BY ss_item_sk), item_aggregates AS (SELECT i.i_category, i.i_class, SUM(item_sums.net_profit) AS net_profit, SUM(item_sums.sales_price) AS sales_price FROM item_sums JOIN item i ON item_sums.ss_item_sk = i.i_item_sk GROUP BY i.i_category, i.i_class), detailed AS (SELECT net_profit / sales_price AS gross_margin, i_category, i_class, 0 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0), category_summary AS (SELECT SUM(net_profit) / SUM(sales_price) AS gross_margin, i_category, NULL AS i_class, 1 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0 GROUP BY i_category), grand_total AS (SELECT SUM(net_profit) / SUM(sales_price) AS gross_margin, NULL AS i_category, NULL AS i_class, 2 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0), all_levels AS (SELECT * FROM detailed UNION ALL SELECT * FROM category_summary UNION ALL SELECT * FROM grand_total), ranked AS (SELECT gross_margin, i_category, i_class, lochierarchy, CASE WHEN lochierarchy < 2 THEN RANK() OVER (PARTITION BY lochierarchy, CASE WHEN lochierarchy = 0 THEN i_category END ORDER BY gross_margin ASC) ELSE 1 END AS rank_within_parent FROM all_levels)\nSELECT gross_margin, i_category, i_class, lochierarchy, rank_within_parent FROM ranked ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100;", "transform": "rollup_to_union_windowing", "original_ms": 1040.0, "rewritten_ms": 607.0, "ratio": 2.47, "outcome": "WIN", "declared_speedup": "2.47x", "sf10_speedup": 2.47, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE select sum(ss_net_profit)/sum(ss_ext_sales_price) as gross_margin, i_category, i_class, grouping(i_category)+grouping(i_class) as lochierarchy, rank() over (partition by grouping(i_category)+grouping(i_class), case when grouping(i_class) = 0 then i_category end order by sum(ss_net_profit)/sum(ss_ext_sales_price) asc) as rank_within_parent from store_sales, date_dim d1, item, store where d1.d_year = 2002 and d1.d_date_sk = ss_sold_date_sk and i_item_sk = ss_item_sk and s_store_sk = ss_store_sk and s_state in ('SD','TN','GA','SC','MO','AL','MI','OH') group by rollup(i_category,i_class) order by lochierarchy desc, case when lochierarchy = 0 then i_category end, rank_within_parent LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││               Total Time: 1.04s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│ (GROUPING(item.i_category)│\n│  + GROUPING(item.i_class))│\n│            DESC           │\n│           #5 ASC          │\n│ rank() OVER (PARTITION BY │\n│ (GROUPING(item.i_category)│\n│  + GROUPING(item.i_class))│\n│  , CASE  WHEN ((GROUPING  │\n│ (item.i_class) = 0)) THEN │\n│   (item.i_category) ELSE  │\n│   NULL END ORDER BY (sum  │\n│ (store_sales.ss_net_profit│\n│    ) / sum(store_sales    │\n│ .ss_ext_sales_price)) ASC)│\n│             ASC           │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        gross_margin       │\n│         i_category        │\n│          i_class          │\n│        lochierarchy       │\n│     rank_within_parent    │\n│   CASE  WHEN (((GROUPING  │\n│    (item.i_category) +    │\n│  GROUPING(item.i_class)) =│\n│    0)) THEN (i_category)  │\n│        ELSE NULL END      │\n│                           │\n│          164 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│             #5            │\n│             #6            │\n│             #7            │\n│             #8            │\n│             #9            │\n│            #10            │\n│            #11            │\n│                           │\n│          164 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           WINDOW          │\n│    ────────────────────   │\n│        Projections:       │\n│ RANK() OVER (PARTITION BY │\n│ (GROUPING(item.i_category)│\n│  + GROUPING(item.i_class))│\n│  , CASE  WHEN ((GROUPING  │\n│ (item.i_class) = 0)) THEN │\n│ (i_category) ELSE NULL END│\n│     ORDER BY (CAST(sum    │\n│ (ss_net_profit) AS DOUBLE)│\n│         / CAST(sum        │\n│  (ss_ext_sales_price) AS  │\n│  DOUBLE)) ASC NULLS LAST) │\n│                           │\n│          164 Rows         │\n│          (0.05s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│       HASH_GROUP_BY       │\n│    ────────────────────   │\n│          Groups:          │\n│             #0            │\n│             #1            │\n│                           │\n│        Aggregates:        │\n... (120 more lines truncated)", "explain_rewritten": "┌─────────────────────────────────────┐\n│┌───────────────────────────────────┐│\n││    Query Profiling Information    ││\n│└───────────────────────────────────┘│\n└─────────────────────────────────────┘\nEXPLAIN ANALYZE WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH')), item_sums AS (SELECT ss_item_sk, SUM(ss_net_profit) AS net_profit, SUM(ss_ext_sales_price) AS sales_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_stores ON ss_store_sk = filtered_stores.s_store_sk GROUP BY ss_item_sk), item_aggregates AS (SELECT i.i_category, i.i_class, SUM(item_sums.net_profit) AS net_profit, SUM(item_sums.sales_price) AS sales_price FROM item_sums JOIN item i ON item_sums.ss_item_sk = i.i_item_sk GROUP BY i.i_category, i.i_class), detailed AS (SELECT net_profit / sales_price AS gross_margin, i_category, i_class, 0 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0), category_summary AS (SELECT SUM(net_profit) / SUM(sales_price) AS gross_margin, i_category, NULL AS i_class, 1 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0 GROUP BY i_category), grand_total AS (SELECT SUM(net_profit) / SUM(sales_price) AS gross_margin, NULL AS i_category, NULL AS i_class, 2 AS lochierarchy FROM item_aggregates WHERE sales_price <> 0), all_levels AS (SELECT * FROM detailed UNION ALL SELECT * FROM category_summary UNION ALL SELECT * FROM grand_total), ranked AS (SELECT gross_margin, i_category, i_class, lochierarchy, CASE WHEN lochierarchy < 2 THEN RANK() OVER (PARTITION BY lochierarchy, CASE WHEN lochierarchy = 0 THEN i_category END ORDER BY gross_margin ASC) ELSE 1 END AS rank_within_parent FROM all_levels) SELECT gross_margin, i_category, i_class, lochierarchy, rank_within_parent FROM ranked ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100;\n┌────────────────────────────────────────────────┐\n│┌──────────────────────────────────────────────┐│\n││              Total Time: 0.607s              ││\n│└──────────────────────────────────────────────┘│\n└────────────────────────────────────────────────┘\n┌───────────────────────────┐\n│           QUERY           │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│      EXPLAIN_ANALYZE      │\n│    ────────────────────   │\n│           0 Rows          │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           TOP_N           │\n│    ────────────────────   │\n│          Top: 100         │\n│                           │\n│         Order By:         │\n│  ranked.lochierarchy DESC │\n│           #5 ASC          │\n│ ranked.rank_within_parent │\n│             ASC           │\n│                           │\n│          100 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        gross_margin       │\n│         i_category        │\n│          i_class          │\n│        lochierarchy       │\n│     rank_within_parent    │\n│ CASE  WHEN ((lochierarchy │\n│  = 0)) THEN (i_category)  │\n│        ELSE NULL END      │\n│                           │\n│          164 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│        gross_margin       │\n│         i_category        │\n│          i_class          │\n│        lochierarchy       │\n│     rank_within_parent    │\n│                           │\n│          164 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│         PROJECTION        │\n│    ────────────────────   │\n│             #0            │\n│             #1            │\n│             #2            │\n│             #3            │\n│             #4            │\n│                           │\n│          164 Rows         │\n│          (0.00s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│           WINDOW          │\n│    ────────────────────   │\n│        Projections:       │\n│ RANK() OVER (PARTITION BY │\n│  lochierarchy, CASE  WHEN │\n│ ((lochierarchy = 0)) THEN │\n│ (i_category) ELSE NULL END│\n│  ORDER BY gross_margin ASC│\n│         NULLS LAST)       │\n│                           │\n│          164 Rows         │\n│          (0.05s)          │\n└─────────────┬─────────────┘\n┌─────────────┴─────────────┐\n│            CTE            │\n│    ────────────────────   │\n│         CTE Name:         │\n│      item_aggregates      │\n│                           ├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐\n│       Table Index: 0      │                                                                                                                                  │\n│                           │                                                                                                                                  │\n│           0 Rows          │                                                                                                                                  │\n│          (0.00s)          │                                                                                                                                  │\n└─────────────┬─────────────┘                                                                                                                                  │\n┌─────────────┴─────────────┐                                                                                                                    ┌─────────────┴─────────────┐\n│           FILTER          │                                                                                                                    │           UNION           │\n│    ────────────────────   │                                                                                                                    │    ────────────────────   │\n│ ((sales_price != 0.00) OR │                                                                                                                    │                           │\n│ ((sales_price != 0.00) OR │                                                                                                                    │                           │\n│  (sales_price != 0.00)))  │                                                                                                                    │                           ├───────────────────────────────────────────┐\n│                           │                                                                                                                    │                           │                                           │\n│          152 Rows         │                                                                                                                    │           0 Rows          │                                           │\n│          (0.00s)          │                                                                                                                    │          (0.00s)          │                                           │\n└─────────────┬─────────────┘                                                                                                                    └─────────────┬─────────────┘                                           │\n... (197 more lines truncated)", "gap": "UNION_CTE_SELF_JOIN_DECOMPOSITION", "queries": ["Q36"]}
{"id": 16, "query_sql": "with  cross_items as\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id\n     ,iss.i_class_id class_id\n     ,iss.i_category_id category_id\n from store_sales\n     ,item iss\n     ,date_dim d1\n where ss_item_sk = iss.i_item_sk\n   and ss_sold_date_sk = d1.d_date_sk\n   and d1.d_year between 2000 AND 2000 + 2\n intersect \n select ics.i_brand_id\n     ,ics.i_class_id\n     ,ics.i_category_id\n from catalog_sales\n     ,item ics\n     ,date_dim d2\n where cs_item_sk = ics.i_item_sk\n   and cs_sold_date_sk = d2.d_date_sk\n   and d2.d_year between 2000 AND 2000 + 2\n intersect\n select iws.i_brand_id\n     ,iws.i_class_id\n     ,iws.i_category_id\n from web_sales\n     ,item iws\n     ,date_dim d3\n where ws_item_sk = iws.i_item_sk\n   and ws_sold_date_sk = d3.d_date_sk\n   and d3.d_year between 2000 AND 2000 + 2)\n where i_brand_id = brand_id\n      and i_class_id = class_id\n      and i_category_id = category_id\n),\n avg_sales as\n (select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity\n             ,ss_list_price list_price\n       from store_sales\n           ,date_dim\n       where ss_sold_date_sk = d_date_sk\n         and d_year between 2000 and 2000 + 2\n       union all \n       select cs_quantity quantity \n             ,cs_list_price list_price\n       from catalog_sales\n           ,date_dim\n       where cs_sold_date_sk = d_date_sk\n         and d_year between 2000 and 2000 + 2 \n       union all\n       select ws_quantity quantity\n             ,ws_list_price list_price\n       from web_sales\n           ,date_dim\n       where ws_sold_date_sk = d_date_sk\n         and d_year between 2000 and 2000 + 2) x)\n  select channel, i_brand_id,i_class_id,i_category_id,sum(sales), sum(number_sales)\n from(\n       select 'store' channel, i_brand_id,i_class_id\n             ,i_category_id,sum(ss_quantity*ss_list_price) sales\n             , count(*) number_sales\n       from store_sales\n           ,item\n           ,date_dim\n       where ss_item_sk in (select ss_item_sk from cross_items)\n         and ss_item_sk = i_item_sk\n         and ss_sold_date_sk = d_date_sk\n         and d_year = 2000+2 \n         and d_moy = 11\n       group by i_brand_id,i_class_id,i_category_id\n       having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)\n       union all\n       select 'catalog' channel, i_brand_id,i_class_id,i_category_id, sum(cs_quantity*cs_list_price) sales, count(*) number_sales\n       from catalog_sales\n           ,item\n           ,date_dim\n       where cs_item_sk in (select ss_item_sk from cross_items)\n         and cs_item_sk = i_item_sk\n         and cs_sold_date_sk = d_date_sk\n         and d_year = 2000+2 \n         and d_moy = 11\n       group by i_brand_id,i_class_id,i_category_id\n       having sum(cs_quantity*cs_list_price) > (select average_sales from avg_sales)\n       union all\n       select 'web' channel, i_brand_id,i_class_id,i_category_id, sum(ws_quantity*ws_list_price) sales , count(*) number_sales\n       from web_sales\n           ,item\n           ,date_dim\n       where ws_item_sk in (select ss_item_sk from cross_items)\n         and ws_item_sk = i_item_sk\n         and ws_sold_date_sk = d_date_sk\n         and d_year = 2000+2\n         and d_moy = 11\n       group by i_brand_id,i_class_id,i_category_id\n       having sum(ws_quantity*ws_list_price) > (select average_sales from avg_sales)\n ) y\n group by rollup (channel, i_brand_id,i_class_id,i_category_id)\n order by channel,i_brand_id,i_class_id,i_category_id\n LIMIT 100;", "rewritten_sql": "WITH cross_items AS (SELECT i.i_item_sk AS ss_item_sk FROM item AS i WHERE EXISTS(SELECT 1 FROM store_sales, item AS iss, date_dim AS d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 2000 AND 2000 + 2 AND iss.i_brand_id = i.i_brand_id AND iss.i_class_id = i.i_class_id AND iss.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM catalog_sales, item AS ics, date_dim AS d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 2000 AND 2000 + 2 AND ics.i_brand_id = i.i_brand_id AND ics.i_class_id = i.i_class_id AND ics.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM web_sales, item AS iws, date_dim AS d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND d3.d_year BETWEEN 2000 AND 2000 + 2 AND iws.i_brand_id = i.i_brand_id AND iws.i_class_id = i.i_class_id AND iws.i_category_id = i.i_category_id)), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_year BETWEEN 2000 AND 2000 + 2 UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year BETWEEN 2000 AND 2000 + 2 UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, date_dim WHERE ws_sold_date_sk = d_date_sk AND d_year BETWEEN 2000 AND 2000 + 2) AS x)\nSELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales), SUM(number_sales) FROM (SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales, item, date_dim WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND ss_item_sk = i_item_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2000 + 2 AND d_moy = 11 GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales) UNION ALL SELECT 'catalog' AS channel, i_brand_id, i_class_id, i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales, item, date_dim WHERE cs_item_sk IN (SELECT ss_item_sk FROM cross_items) AND cs_item_sk = i_item_sk AND cs_sold_date_sk = d_date_sk AND d_year = 2000 + 2 AND d_moy = 11 GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales) UNION ALL SELECT 'web' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales, item, date_dim WHERE ws_item_sk IN (SELECT ss_item_sk FROM cross_items) AND ws_item_sk = i_item_sk AND ws_sold_date_sk = d_date_sk AND d_year = 2000 + 2 AND d_moy = 11 GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales)) AS y GROUP BY ROLLUP (channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel, i_brand_id, i_class_id, i_category_id LIMIT 100;", "transform": "intersect_to_exists", "original_ms": null, "rewritten_ms": null, "ratio": 1.83, "outcome": "WIN", "declared_speedup": "1.83x", "sf10_speedup": 2.72, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["Q14"]}
{"id": 17, "query_sql": "with ws_wh as\n(select ws1.ws_order_number,ws1.ws_warehouse_sk wh1,ws2.ws_warehouse_sk wh2\n from web_sales ws1,web_sales ws2\n where ws1.ws_order_number = ws2.ws_order_number\n   and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '1999-2-01' and \n           (cast('1999-2-01' as date) + INTERVAL 60 DAY)\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state = 'NC'\nand ws1.ws_web_site_sk = web_site_sk\nand web_company_name = 'pri'\nand ws1.ws_order_number in (select ws_order_number\n                            from ws_wh)\nand ws1.ws_order_number in (select wr_order_number\n                            from web_returns,ws_wh\n                            where wr_order_number = ws_wh.ws_order_number)\norder by count(distinct ws_order_number)\n LIMIT 100;", "rewritten_sql": "WITH ws_wh AS (SELECT ws1.ws_order_number, ws1.ws_warehouse_sk AS wh1, ws2.ws_warehouse_sk AS wh2 FROM web_sales AS ws1, web_sales AS ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nSELECT COUNT(DISTINCT ws_order_number) AS \"order count\", SUM(ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws_net_profit) AS \"total net profit\" FROM web_sales AS ws1 JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk WHERE d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY) AND ca_state = 'NC' AND web_company_name = 'pri' AND EXISTS(SELECT 1 FROM ws_wh WHERE ws_wh.ws_order_number = ws1.ws_order_number) AND EXISTS(SELECT 1 FROM web_returns JOIN ws_wh ON wr_order_number = ws_wh.ws_order_number WHERE wr_order_number = ws1.ws_order_number) ORDER BY COUNT(DISTINCT ws_order_number) LIMIT 100;", "transform": "materialize_cte", "original_ms": null, "rewritten_ms": null, "ratio": 1.37, "outcome": "WIN", "declared_speedup": "1.37x", "sf10_speedup": 1.43, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["Q95"]}
{"id": 18, "query_sql": "WITH web_v1 as (\nselect\n  ws_item_sk item_sk, d_date,\n  sum(sum(ws_sales_price))\n      over (partition by ws_item_sk order by d_date rows between unbounded preceding and current row) cume_sales\nfrom web_sales\n    ,date_dim\nwhere ws_sold_date_sk=d_date_sk\n  and d_month_seq between 1216 and 1216+11\n  and ws_item_sk is not NULL\ngroup by ws_item_sk, d_date),\nstore_v1 as (\nselect\n  ss_item_sk item_sk, d_date,\n  sum(sum(ss_sales_price))\n      over (partition by ss_item_sk order by d_date rows between unbounded preceding and current row) cume_sales\nfrom store_sales\n    ,date_dim\nwhere ss_sold_date_sk=d_date_sk\n  and d_month_seq between 1216 and 1216+11\n  and ss_item_sk is not NULL\ngroup by ss_item_sk, d_date)\n select *\nfrom (select item_sk\n     ,d_date\n     ,web_sales\n     ,store_sales\n     ,max(web_sales)\n         over (partition by item_sk order by d_date rows between unbounded preceding and current row) web_cumulative\n     ,max(store_sales)\n         over (partition by item_sk order by d_date rows between unbounded preceding and current row) store_cumulative\n     from (select case when web.item_sk is not null then web.item_sk else store.item_sk end item_sk\n                 ,case when web.d_date is not null then web.d_date else store.d_date end d_date\n                 ,web.cume_sales web_sales\n                 ,store.cume_sales store_sales\n           from web_v1 web full outer join store_v1 store on (web.item_sk = store.item_sk\n                                                          and web.d_date = store.d_date)\n          )x )y\nwhere web_cumulative > store_cumulative\norder by item_sk\n        ,d_date\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1216 AND 1216 + 11), filtered_web_sales AS (SELECT ws_item_sk AS item_sk, d_date, ws_sales_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk WHERE NOT ws_item_sk IS NULL), filtered_store_sales AS (SELECT ss_item_sk AS item_sk, d_date, ss_sales_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk WHERE NOT ss_item_sk IS NULL), web_v1 AS (SELECT item_sk, d_date, SUM(SUM(ws_sales_price)) OVER (PARTITION BY item_sk ORDER BY d_date rows BETWEEN UNBOUNDED preceding AND CURRENT ROW) AS cume_sales FROM filtered_web_sales GROUP BY item_sk, d_date), store_v1 AS (SELECT item_sk, d_date, SUM(SUM(ss_sales_price)) OVER (PARTITION BY item_sk ORDER BY d_date rows BETWEEN UNBOUNDED preceding AND CURRENT ROW) AS cume_sales FROM filtered_store_sales GROUP BY item_sk, d_date)\nSELECT * FROM (SELECT item_sk, d_date, web_sales, store_sales, MAX(web_sales) OVER (PARTITION BY item_sk ORDER BY d_date rows BETWEEN UNBOUNDED preceding AND CURRENT ROW) AS web_cumulative, MAX(store_sales) OVER (PARTITION BY item_sk ORDER BY d_date rows BETWEEN UNBOUNDED preceding AND CURRENT ROW) AS store_cumulative FROM (SELECT CASE WHEN NOT web.item_sk IS NULL THEN web.item_sk ELSE store.item_sk END AS item_sk, CASE WHEN NOT web.d_date IS NULL THEN web.d_date ELSE store.d_date END AS d_date, web.cume_sales AS web_sales, store.cume_sales AS store_sales FROM web_v1 AS web FULL OUTER JOIN store_v1 AS store ON (web.item_sk = store.item_sk AND web.d_date = store.d_date)) AS x) AS y WHERE web_cumulative > store_cumulative ORDER BY item_sk, d_date LIMIT 100;", "transform": "deferred_window_aggregation", "original_ms": null, "rewritten_ms": null, "ratio": 1.36, "outcome": "WIN", "declared_speedup": "1.36x", "sf10_speedup": null, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["Q51"]}
{"id": 19, "query_sql": "with cross_items as\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id, iss.i_class_id class_id, iss.i_category_id category_id\n from store_sales, item iss, date_dim d1\n where ss_item_sk = iss.i_item_sk and ss_sold_date_sk = d1.d_date_sk\n   and d1.d_year between 2000 AND 2000 + 2\n intersect\n select ics.i_brand_id, ics.i_class_id, ics.i_category_id\n from catalog_sales, item ics, date_dim d2\n where cs_item_sk = ics.i_item_sk and cs_sold_date_sk = d2.d_date_sk\n   and d2.d_year between 2000 AND 2000 + 2\n intersect\n select iws.i_brand_id, iws.i_class_id, iws.i_category_id\n from web_sales, item iws, date_dim d3\n where ws_item_sk = iws.i_item_sk and ws_sold_date_sk = d3.d_date_sk\n   and d3.d_year between 2000 AND 2000 + 2)\n where i_brand_id = brand_id and i_class_id = class_id and i_category_id = category_id),\n avg_sales as\n (select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity, ss_list_price list_price from store_sales, date_dim where ss_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2\n   union all select cs_quantity, cs_list_price from catalog_sales, date_dim where cs_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2\n   union all select ws_quantity, ws_list_price from web_sales, date_dim where ws_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2) x)\n select channel, i_brand_id, i_class_id, i_category_id, sum(sales), sum(number_sales)\n from (\n  select 'store' channel, i_brand_id, i_class_id, i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n  from store_sales, item, date_dim\n  where ss_item_sk in (select ss_item_sk from cross_items) and ss_item_sk = i_item_sk and ss_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)\n  union all\n  select 'catalog' channel, i_brand_id, i_class_id, i_category_id, sum(cs_quantity*cs_list_price) sales, count(*) number_sales\n  from catalog_sales, item, date_dim\n  where cs_item_sk in (select ss_item_sk from cross_items) and cs_item_sk = i_item_sk and cs_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(cs_quantity*cs_list_price) > (select average_sales from avg_sales)\n  union all\n  select 'web' channel, i_brand_id, i_class_id, i_category_id, sum(ws_quantity*ws_list_price) sales, count(*) number_sales\n  from web_sales, item, date_dim\n  where ws_item_sk in (select ss_item_sk from cross_items) and ws_item_sk = i_item_sk and ws_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ws_quantity*ws_list_price) > (select average_sales from avg_sales)\n ) y\n group by rollup (channel, i_brand_id, i_class_id, i_category_id)\n order by channel, i_brand_id, i_class_id, i_category_id\n LIMIT 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 2000 AND 2002), cross_items AS (SELECT i_item_sk AS ss_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE EXISTS (SELECT 1 FROM store_sales JOIN item iss ON ss_item_sk = iss.i_item_sk JOIN filtered_dates d1 ON ss_sold_date_sk = d1.d_date_sk WHERE iss.i_brand_id = item.i_brand_id AND iss.i_class_id = item.i_class_id AND iss.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM catalog_sales JOIN item ics ON cs_item_sk = ics.i_item_sk JOIN filtered_dates d2 ON cs_sold_date_sk = d2.d_date_sk WHERE ics.i_brand_id = item.i_brand_id AND ics.i_class_id = item.i_class_id AND ics.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM web_sales JOIN item iws ON ws_item_sk = iws.i_item_sk JOIN filtered_dates d3 ON ws_sold_date_sk = d3.d_date_sk WHERE iws.i_brand_id = item.i_brand_id AND iws.i_class_id = item.i_class_id AND iws.i_category_id = item.i_category_id)), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity, cs_list_price FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity, ws_list_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk) x), nov2002_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 11), store_sales_data AS (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ss.ss_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ss.ss_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)), catalog_sales_data AS (SELECT 'catalog' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN nov2002_dates nd ON cs.cs_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = cs.cs_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales)), web_sales_data AS (SELECT 'web' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ws.ws_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ws.ws_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales))\nSELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales) AS \"SUM(sales)\", SUM(number_sales) AS \"SUM(number_sales)\" FROM (SELECT * FROM store_sales_data UNION ALL SELECT * FROM catalog_sales_data UNION ALL SELECT * FROM web_sales_data) y GROUP BY ROLLUP(channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel, i_brand_id, i_class_id, i_category_id LIMIT 100;", "transform": "multi_intersect_exists_cte", "original_ms": null, "rewritten_ms": null, "ratio": 2.39, "outcome": "WIN", "declared_speedup": "2.39x", "sf10_speedup": 2.39, "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["Q14"]}
{"id": 20, "query_sql": "select \n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nfrom\n   catalog_sales\n  ,warehouse\n  ,ship_mode\n  ,call_center\n  ,date_dim\nwhere\nd_month_seq between 1193 and 1193 + 23\nand cs_ship_date_sk   = d_date_sk\nand cs_warehouse_sk   = w_warehouse_sk\nand cs_ship_mode_sk   = sm_ship_mode_sk\nand cs_call_center_sk = cc_call_center_sk\nand cs_list_price between 271 and 300\nand sm_type = 'REGULAR'\nand cc_class = 'small'\nand w_gmt_offset = -5\ngroup by\n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\norder by substring(w_warehouse_name,1,20)\n        ,sm_type\n        ,cc_name\nlimit 100;", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1193 AND 1193 + 23)\nSELECT SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name, SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM catalog_sales JOIN filtered_dates ON cs_ship_date_sk = d_date_sk JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk JOIN ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk JOIN call_center ON cs_call_center_sk = cc_call_center_sk WHERE cs_list_price BETWEEN 271 AND 300 AND sm_type = 'REGULAR' AND cc_class = 'small' AND w_gmt_offset = -5 GROUP BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name ORDER BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name LIMIT 100", "transform": "pg_date_cte_explicit_join", "original_ms": 40.793, "rewritten_ms": 28.162, "ratio": 2.28, "outcome": "WIN", "declared_speedup": "2.28x", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "QUERY PLAN                                                                                                                                \n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=66077.03..66078.91 rows=12 width=117) (actual time=39.767..40.691 rows=4 loops=1)\n   Buffers: shared hit=60629 read=13455\n   ->  Finalize GroupAggregate  (cost=66077.03..66078.91 rows=12 width=117) (actual time=39.765..40.689 rows=4 loops=1)\n         Group Key: (\"substring\"((warehouse.w_warehouse_name)::text, 1, 20)), ship_mode.sm_type, call_center.cc_name\n         Buffers: shared hit=60629 read=13455\n         ->  Gather Merge  (cost=66077.03..66078.56 rows=10 width=117) (actual time=39.748..40.680 rows=10 loops=1)\n               Workers Planned: 2\n               Workers Launched: 2\n               Buffers: shared hit=60629 read=13455\n               ->  Partial GroupAggregate  (cost=65077.01..65077.38 rows=5 width=117) (actual time=24.832..24.853 rows=3 loops=3)\n                     Group Key: (\"substring\"((warehouse.w_warehouse_name)::text, 1, 20)), ship_mode.sm_type, call_center.cc_name\n                     Buffers: shared hit=60629 read=13455\n                     ->  Sort  (cost=65077.01..65077.02 rows=5 width=85) (actual time=24.824..24.829 rows=86 loops=3)\n                           Sort Key: (\"substring\"((warehouse.w_warehouse_name)::text, 1, 20)), call_center.cc_name\n                           Sort Method: quicksort  Memory: 40kB\n                           Buffers: shared hit=60629 read=13455\n                           Worker 0:  Sort Method: quicksort  Memory: 36kB\n                           Worker 1:  Sort Method: quicksort  Memory: 34kB\n                           ->  Nested Loop  (cost=0.98..65076.95 rows=5 width=85) (actual time=0.417..24.763 rows=86 loops=3)\n                                 Buffers: shared hit=60613 read=13455\n                                 ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k7_k4_k9_k1 on date_dim  (cost=0.42..1870.06 rows=315 width=4) (actual time=0.269..0.519 rows=244 loops=3)\n                                       Index Cond: ((d_month_seq >= 1193) AND (d_month_seq <= 1216))\n                                       Heap Fetches: 0\n                                       Buffers: shared hit=2 read=283\n                                 ->  Nested Loop  (cost=0.56..200.48 rows=18 width=70) (actual time=0.081..0.099 rows=0 loops=731)\n                                       Buffers: shared hit=60611 read=13172\n                                       ->  Seq Scan on call_center  (cost=0.00..2.30 rows=3 width=18) (actual time=0.000..0.002 rows=3 loops=731)\n                                             Filter: ((cc_class)::text = 'small'::text)\n                                             Rows Removed by Filter: 21\n                                             Buffers: shared hit=1462\n                                       ->  Nested Loop  (cost=0.56..66.00 rows=6 width=60) (actual time=0.029..0.032 rows=0 loops=2193)\n                                             Buffers: shared hit=59149 read=13172\n                                             ->  Seq Scan on warehouse  (cost=0.00..1.12 rows=2 width=21) (actual time=0.000..0.001 rows=2 loops=2193)\n                                                   Filter: (w_gmt_offset = '-5'::numeric)\n                                                   Rows Removed by Filter: 8\n                                                   Buffers: shared hit=2193\n                                             ->  Nested Loop  (cost=0.56..32.41 rows=3 width=47) (actual time=0.014..0.015 rows=0 loops=4386)\n                                                   Buffers: shared hit=56956 read=13172\n                                                   ->  Seq Scan on ship_mode  (cost=0.00..1.25 rows=3 width=35) (actual time=0.000..0.001 rows=3 loops=4386)\n                                                         Filter: (sm_type = 'REGULAR'::bpchar)\n                                                         Rows Removed by Filter: 17\n                                                         Buffers: shared hit=4386\n                                                   ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k3_k12_k14_k15_16_18 on catalog_sales  (cost=0.56..10.38 rows=1 width=20) (actual time=0.005..0.005 rows=0 loops=13158)\n                                                         Index Cond: ((cs_ship_date_sk = date_dim.d_date_sk) AND (cs_call_center_sk = call_center.cc_call_center_sk) AND (cs_ship_mode_sk = ship_mode.sm_ship_mode_sk) AND (cs_warehouse_sk = warehouse.w_warehouse_sk))\n                                                         Filter: ((cs_list_price >= '271'::numeric) AND (cs_list_price <= '300'::numeric))\n                                                         Rows Removed by Filter: 1\n                                                         Buffers: shared hit=52570 read=13172\n Planning:\n   Buffers: shared hit=664 read=86\n Planning Time: 1.626 ms\n Execution Time: 40.793 ms\n(51 rows)", "explain_rewritten": "QUERY PLAN                                                                                                                                \n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=66077.03..66078.91 rows=12 width=117) (actual time=26.772..28.070 rows=4 loops=1)\n   Buffers: shared hit=62495 read=11589\n   ->  Finalize GroupAggregate  (cost=66077.03..66078.91 rows=12 width=117) (actual time=26.771..28.068 rows=4 loops=1)\n         Group Key: (SUBSTRING(warehouse.w_warehouse_name FROM 1 FOR 20)), ship_mode.sm_type, call_center.cc_name\n         Buffers: shared hit=62495 read=11589\n         ->  Gather Merge  (cost=66077.03..66078.56 rows=10 width=117) (actual time=26.763..28.062 rows=10 loops=1)\n               Workers Planned: 2\n               Workers Launched: 2\n               Buffers: shared hit=62495 read=11589\n               ->  Partial GroupAggregate  (cost=65077.01..65077.38 rows=5 width=117) (actual time=24.141..24.158 rows=3 loops=3)\n                     Group Key: (SUBSTRING(warehouse.w_warehouse_name FROM 1 FOR 20)), ship_mode.sm_type, call_center.cc_name\n                     Buffers: shared hit=62495 read=11589\n                     ->  Sort  (cost=65077.01..65077.02 rows=5 width=85) (actual time=24.132..24.137 rows=86 loops=3)\n                           Sort Key: (SUBSTRING(warehouse.w_warehouse_name FROM 1 FOR 20)), call_center.cc_name\n                           Sort Method: quicksort  Memory: 40kB\n                           Buffers: shared hit=62495 read=11589\n                           Worker 0:  Sort Method: quicksort  Memory: 36kB\n                           Worker 1:  Sort Method: quicksort  Memory: 34kB\n                           ->  Nested Loop  (cost=0.98..65076.95 rows=5 width=85) (actual time=0.344..24.072 rows=86 loops=3)\n                                 Buffers: shared hit=62479 read=11589\n                                 ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k7_k4_k9_k1 on date_dim  (cost=0.42..1870.06 rows=315 width=4) (actual time=0.223..1.071 rows=244 loops=3)\n                                       Index Cond: ((d_month_seq >= 1193) AND (d_month_seq <= 1216))\n                                       Heap Fetches: 0\n                                       Buffers: shared hit=5 read=280\n                                 ->  Nested Loop  (cost=0.56..200.48 rows=18 width=70) (actual time=0.076..0.094 rows=0 loops=731)\n                                       Buffers: shared hit=62474 read=11309\n                                       ->  Seq Scan on call_center  (cost=0.00..2.30 rows=3 width=18) (actual time=0.000..0.002 rows=3 loops=731)\n                                             Filter: ((cc_class)::text = 'small'::text)\n                                             Rows Removed by Filter: 21\n                                             Buffers: shared hit=1462\n                                       ->  Nested Loop  (cost=0.56..66.00 rows=6 width=60) (actual time=0.027..0.031 rows=0 loops=2193)\n                                             Buffers: shared hit=61012 read=11309\n                                             ->  Seq Scan on warehouse  (cost=0.00..1.12 rows=2 width=21) (actual time=0.000..0.001 rows=2 loops=2193)\n                                                   Filter: (w_gmt_offset = '-5'::numeric)\n                                                   Rows Removed by Filter: 8\n                                                   Buffers: shared hit=2193\n                                             ->  Nested Loop  (cost=0.56..32.41 rows=3 width=47) (actual time=0.014..0.015 rows=0 loops=4386)\n                                                   Buffers: shared hit=58819 read=11309\n                                                   ->  Seq Scan on ship_mode  (cost=0.00..1.25 rows=3 width=35) (actual time=0.000..0.001 rows=3 loops=4386)\n                                                         Filter: (sm_type = 'REGULAR'::bpchar)\n                                                         Rows Removed by Filter: 17\n                                                         Buffers: shared hit=4386\n                                                   ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k3_k12_k14_k15_16_18 on catalog_sales  (cost=0.56..10.38 rows=1 width=20) (actual time=0.004..0.004 rows=0 loops=13158)\n                                                         Index Cond: ((cs_ship_date_sk = date_dim.d_date_sk) AND (cs_call_center_sk = call_center.cc_call_center_sk) AND (cs_ship_mode_sk = ship_mode.sm_ship_mode_sk) AND (cs_warehouse_sk = warehouse.w_warehouse_sk))\n                                                         Filter: ((cs_list_price >= '271'::numeric) AND (cs_list_price <= '300'::numeric))\n                                                         Rows Removed by Filter: 1\n                                                         Buffers: shared hit=54433 read=11309\n Planning:\n   Buffers: shared hit=697 read=53\n Planning Time: 1.486 ms\n Execution Time: 28.162 ms\n(51 rows)", "gap": "COMMA_JOIN_WEAKNESS", "queries": ["DSB Q099_agg"]}
{"id": 21, "query_sql": "with ssr as\n (select  s_store_id as store_id,\n          sum(ss_ext_sales_price) as sales,\n          sum(coalesce(sr_return_amt, 0)) as returns,\n          sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n  from store_sales left outer join store_returns on\n         (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n     date_dim,\n     store,\n     item,\n     promotion\n where ss_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-23' as date)\n                  and cast('1998-08-23' as date) + interval '30 day'\n       and ss_store_sk = s_store_sk\n       and ss_item_sk = i_item_sk\n       and i_current_price > 50\n       and ss_promo_sk = p_promo_sk\n       and p_channel_email = 'Y'\n       and p_channel_tv = 'Y'\n       and p_channel_radio = 'N'\n       and p_channel_press = 'N'\n       and p_channel_event = 'Y'\n       and ss_wholesale_cost BETWEEN 63 AND 78\n       and i_category IN ('Jewelry', 'Music')\n group by s_store_id)\n ,\n csr as\n (select  cp_catalog_page_id as catalog_page_id,\n          sum(cs_ext_sales_price) as sales,\n          sum(coalesce(cr_return_amount, 0)) as returns,\n          sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n  from catalog_sales left outer join catalog_returns on\n         (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),\n     date_dim,\n     catalog_page,\n     item,\n     promotion\n where cs_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-23' as date)\n                  and cast('1998-08-23' as date) + interval '30 day'\n        and cs_catalog_page_sk = cp_catalog_page_sk\n       and cs_item_sk = i_item_sk\n       and i_current_price > 50\n       and cs_promo_sk = p_promo_sk\n       and p_channel_email = 'Y'\n       and p_channel_tv = 'Y'\n       and p_channel_radio = 'N'\n       and p_channel_press = 'N'\n       and p_channel_event = 'Y'\n       and cs_wholesale_cost BETWEEN 63 AND 78\n       and i_category IN ('Jewelry', 'Music')\ngroup by cp_catalog_page_id)\n ,\n wsr as\n (select  web_site_id,\n          sum(ws_ext_sales_price) as sales,\n          sum(coalesce(wr_return_amt, 0)) as returns,\n          sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n  from web_sales left outer join web_returns on\n         (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),\n     date_dim,\n     web_site,\n     item,\n     promotion\n where ws_sold_date_sk = d_date_sk\n       and d_date between cast('1998-08-23' as date)\n                  and cast('1998-08-23' as date) + interval '30 day'\n        and ws_web_site_sk = web_site_sk\n       and ws_item_sk = i_item_sk\n       and i_current_price > 50\n       and ws_promo_sk = p_promo_sk\n       and p_channel_email = 'Y'\n       and p_channel_tv = 'Y'\n       and p_channel_radio = 'N'\n       and p_channel_press = 'N'\n       and p_channel_event = 'Y'\n       and ws_wholesale_cost BETWEEN 63 AND 78\n       and i_category IN ('Jewelry', 'Music')\ngroup by web_site_id)\n  select  channel\n        , id\n        , sum(sales) as sales\n        , sum(returns) as returns\n        , sum(profit) as profit\n from\n (select 'store channel' as channel\n        , 'store' || store_id as id\n        , sales\n        , returns\n        , profit\n from   ssr\n union all\n select 'catalog channel' as channel\n        , 'catalog_page' || catalog_page_id as id\n        , sales\n        , returns\n        , profit\n from  csr\n union all\n select 'web channel' as channel\n        , 'web_site' || web_site_id as id\n        , sales\n        , returns\n        , profit\n from   wsr\n ) x\n group by rollup (channel, id)\n order by channel\n         ,id\n limit 100;", "rewritten_sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-23' AS DATE) AND CAST('1998-08-23' AS DATE) + INTERVAL '30 DAY'), filtered_item AS (SELECT i_item_sk FROM item WHERE i_current_price > 50 AND i_category IN ('Jewelry', 'Music')), filtered_promotion AS (SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'Y'), ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) INNER JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN store ON ss_store_sk = s_store_sk INNER JOIN filtered_item ON ss_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON ss_promo_sk = filtered_promotion.p_promo_sk WHERE ss_wholesale_cost BETWEEN 63 AND 78 GROUP BY s_store_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number) INNER JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk INNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk INNER JOIN filtered_item ON cs_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON cs_promo_sk = filtered_promotion.p_promo_sk WHERE cs_wholesale_cost BETWEEN 63 AND 78 GROUP BY cp_catalog_page_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM web_sales LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) INNER JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk INNER JOIN web_site ON ws_web_site_sk = web_site_sk INNER JOIN filtered_item ON ws_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON ws_promo_sk = filtered_promotion.p_promo_sk WHERE ws_wholesale_cost BETWEEN 63 AND 78 GROUP BY web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100", "transform": "pg_dimension_prefetch_star", "original_ms": 67.736, "rewritten_ms": 70.286, "ratio": 3.32, "outcome": "WIN", "declared_speedup": "3.32x", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "QUERY PLAN                                                                                                                                \n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=51606.66..51606.82 rows=7 width=160) (actual time=66.741..67.402 rows=3 loops=1)\n   Buffers: shared hit=4320 read=10068\n   ->  GroupAggregate  (cost=51606.66..51606.82 rows=7 width=160) (actual time=66.740..67.400 rows=3 loops=1)\n         Group Key: ('store channel'::text), (('store'::text || (ssr.store_id)::text))\n         Group Key: ('store channel'::text)\n         Group Key: ()\n         Buffers: shared hit=4320 read=10068\n         ->  Sort  (cost=51606.66..51606.66 rows=3 width=160) (actual time=66.726..67.387 rows=1 loops=1)\n               Sort Key: ('store channel'::text), (('store'::text || (ssr.store_id)::text))\n               Sort Method: quicksort  Memory: 25kB\n               Buffers: shared hit=4320 read=10068\n               ->  Append  (cost=18713.99..51606.63 rows=3 width=160) (actual time=33.597..67.371 rows=1 loops=1)\n                     Buffers: shared hit=4317 read=10068\n                     ->  Subquery Scan on ssr  (cost=18713.99..18714.04 rows=1 width=160) (actual time=33.596..33.658 rows=1 loops=1)\n                           Buffers: shared hit=1585 read=4282\n                           ->  GroupAggregate  (cost=18713.99..18714.03 rows=1 width=113) (actual time=33.592..33.653 rows=1 loops=1)\n                                 Group Key: store.s_store_id\n                                 Buffers: shared hit=1585 read=4282\n                                 ->  Sort  (cost=18713.99..18714.00 rows=1 width=41) (actual time=33.579..33.640 rows=1 loops=1)\n                                       Sort Key: store.s_store_id\n                                       Sort Method: quicksort  Memory: 25kB\n                                       Buffers: shared hit=1585 read=4282\n                                       ->  Nested Loop  (cost=1026.12..18713.98 rows=1 width=41) (actual time=22.647..33.631 rows=1 loops=1)\n                                             Buffers: shared hit=1585 read=4282\n                                             ->  Nested Loop Left Join  (cost=1025.98..18713.82 rows=1 width=28) (actual time=22.636..33.618 rows=1 loops=1)\n                                                   Buffers: shared hit=1584 read=4281\n                                                   ->  Gather  (cost=1025.55..18711.67 rows=1 width=24) (actual time=22.620..33.601 rows=1 loops=1)\n                                                         Workers Planned: 2\n                                                         Workers Launched: 2\n                                                         Buffers: shared hit=1583 read=4279\n                                                         ->  Nested Loop  (cost=25.55..17711.57 rows=1 width=24) (actual time=9.334..12.977 rows=0 loops=3)\n                                                               Buffers: shared hit=1583 read=4279\n                                                               ->  Hash Join  (cost=25.25..17674.77 rows=21 width=24) (actual time=3.263..12.110 rows=210 loops=3)\n                                                                     Hash Cond: (store_sales.ss_promo_sk = promotion.p_promo_sk)\n                                                                     Buffers: shared hit=233 read=3742\n                                                                     ->  Nested Loop  (cost=0.85..17647.94 rows=919 width=28) (actual time=3.226..11.716 rows=9522 loops=3)\n                                                                           Buffers: shared hit=231 read=3731\n                                                                           ->  Parallel Index Scan using date_dim_pkey on date_dim  (cost=0.29..3038.09 rows=14 width=4) (actual time=3.210..3.223 rows=10 loops=3)\n                                                                                 Filter: ((d_date >= '1998-08-23'::date) AND (d_date <= '1998-09-22 00:00:00'::timestamp without time zone))\n                                                                                 Rows Removed by Filter: 24339\n                                                                                 Buffers: shared hit=122 read=1595\n                                                                           ->  Index Only Scan using _dta_index_store_sales_6_1333579789__k1_k23_k14_k6_k8_k5_k7_3_4 on store_sales  (cost=0.56..1019.82 rows=2374 width=32) (actual time=0.010..0.777 rows=921 loops=31)\n                                                                                 Index Cond: (ss_sold_date_sk = date_dim.d_date_sk)\n                                                                                 Filter: ((ss_wholesale_cost >= '63'::numeric) AND (ss_wholesale_cost <= '78'::numeric))\n                                                                                 Rows Removed by Filter: 4108\n                                                                                 Heap Fetches: 0\n                                                                                 Buffers: shared hit=109 read=2136\n                                                                     ->  Hash  (cost=24.25..24.25 rows=12 width=4) (actual time=0.091..0.094 rows=10 loops=1)\n                                                                           Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                                                                           Buffers: shared hit=2 read=11\n                                                                           ->  Seq Scan on promotion  (cost=0.00..24.25 rows=12 width=4) (actual time=0.014..0.088 rows=10 loops=1)\n                                                                                 Filter: ((p_channel_email = 'Y'::bpchar) AND (p_channel_tv = 'Y'::bpchar) AND (p_channel_event = 'Y'::bpchar) AND (p_channel_radio = 'N'::bpchar) AND (p_channel_press = 'N'::bpchar))\n                                                                                 Rows Removed by Filter: 490\n                                                                                 Buffers: shared hit=2 read=11\n                                                               ->  Index Scan using item_pkey on item  (cost=0.29..1.75 rows=1 width=4) (actual time=0.004..0.004 rows=0 loops=629)\n                                                                     Index Cond: (i_item_sk = store_sales.ss_item_sk)\n                                                                     Filter: ((i_current_price > '50'::numeric) AND (i_category = ANY ('{Jewelry,Music}'::bpchar[])))\n                                                                     Rows Removed by Filter: 1\n                                                                     Buffers: shared hit=1350 read=537\n                                                   ->  Index Scan using store_returns_pkey on store_returns  (cost=0.43..2.15 rows=1 width=20) (actual time=0.014..0.014 rows=0 loops=1)\n                                                         Index Cond: ((sr_item_sk = store_sales.ss_item_sk) AND (sr_ticket_number = store_sales.ss_ticket_number))\n                                                         Buffers: shared hit=1 read=2\n                                             ->  Index Only Scan using _dta_index_store_6_885578193__k1_2_6 on store  (cost=0.14..0.16 rows=1 width=21) (actual time=0.009..0.009 rows=1 loops=1)\n                                                   Index Cond: (s_store_sk = store_sales.ss_store_sk)\n                                                   Heap Fetches: 1\n                                                   Buffers: shared hit=1 read=1\n                     ->  Subquery Scan on csr  (cost=20562.07..20562.40 rows=1 width=160) (actual time=17.058..17.086 rows=0 loops=1)\n                           Buffers: shared hit=739 read=3803\n                           ->  GroupAggregate  (cost=20562.07..20562.39 rows=1 width=113) (actual time=17.056..17.083 rows=0 loops=1)\n                                 Group Key: catalog_page.cp_catalog_page_id\n                                 Buffers: shared hit=739 read=3803\n                                 ->  Nested Loop Left Join  (cost=20562.07..20562.36 rows=1 width=41) (actual time=17.054..17.080 rows=0 loops=1)\n                                       Buffers: shared hit=739 read=3803\n                                       ->  Gather Merge  (cost=20561.64..20561.76 rows=1 width=37) (actual time=17.053..17.078 rows=0 loops=1)\n                                             Workers Planned: 1\n                                             Workers Launched: 1\n                                             Buffers: shared hit=739 read=3803\n                                             ->  Sort  (cost=19561.63..19561.63 rows=1 width=37) (actual time=11.752..11.755 rows=0 loops=2)\n                                                   Sort Key: catalog_page.cp_catalog_page_id\n                                                   Sort Method: quicksort  Memory: 25kB\n                                                   Buffers: shared hit=739 read=3803\n                                                   Worker 0:  Sort Method: quicksort  Memory: 25kB\n                                                   ->  Nested Loop  (cost=25.41..19561.62 rows=1 width=37) (actual time=11.737..11.741 rows=0 loops=2)\n                                                         Buffers: shared hit=732 read=3803\n                                                         ->  Nested Loop  (cost=25.13..19561.31 rows=1 width=24) (actual time=11.736..11.739 rows=0 loops=2)\n                                                               Buffers: shared hit=732 read=3803\n                                                               ->  Hash Join  (cost=24.83..19558.61 rows=8 width=24) (actual time=1.655..11.332 rows=88 loops=2)\n                                                                     Hash Cond: (catalog_sales.cs_promo_sk = promotion_1.p_promo_sk)\n                                                                     Buffers: shared hit=325 read=3681\n                                                                     ->  Nested Loop  (cost=0.43..19533.31 rows=339 width=28) (actual time=1.377..11.046 rows=3789 loops=2)\n                                                                           Buffers: shared hit=267 read=3666\n                                                                           ->  Parallel Seq Scan on date_dim date_dim_1  (cost=0.00..2049.55 rows=19 width=4) (actual time=1.339..2.713 rows=16 loops=2)\n                                                                                 Filter: ((d_date >= '1998-08-23'::date) AND (d_date <= '1998-09-22 00:00:00'::timestamp without time zone))\n                                                                                 Rows Removed by Filter: 36509\n                                                                                 Buffers: shared hit=124 read=1281\n                                                                           ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k1_4 on catalog_sales  (cost=0.43..914.21 rows=599 width=32) (actual time=0.008..0.517 rows=244 loops=31)\n                                                                                 Index Cond: (cs_sold_date_sk = date_dim_1.d_date_sk)\n                                                                                 Filter: ((cs_wholesale_cost >= '63'::numeric) AND (cs_wholesale_cost <= '78'::numeric))\n                                                                                 Rows Removed by Filter: 2443\n                                                                                 Buffers: shared hit=143 read=2385\n                                                                     ->  Hash  (cost=24.25..24.25 rows=12 width=4) (actual time=0.067..0.067 rows=10 loops=2)\n                                                                           Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                                                                           Buffers: shared hit=15 read=11\n                                                                           ->  Seq Scan on promotion promotion_1  (cost=0.00..24.25 rows=12 width=4) (actual time=0.011..0.064 rows=10 loops=2)\n                                                                                 Filter: ((p_channel_email = 'Y'::bpchar) AND (p_channel_tv = 'Y'::bpchar) AND (p_channel_event = 'Y'::bpchar) AND (p_channel_radio = 'N'::bpchar) AND (p_channel_press = 'N'::bpchar))\n                                                                                 Rows Removed by Filter: 490\n                                                                                 Buffers: shared hit=15 read=11\n                                                               ->  Index Scan using item_pkey on item item_1  (cost=0.29..0.34 rows=1 width=4) (actual time=0.004..0.004 rows=0 loops=176)\n                                                                     Index Cond: (i_item_sk = catalog_sales.cs_item_sk)\n                                                                     Filter: ((i_current_price > '50'::numeric) AND (i_category = ANY ('{Jewelry,Music}'::bpchar[])))\n                                                                     Rows Removed by Filter: 1\n                                                                     Buffers: shared hit=407 read=122\n                                                         ->  Index Scan using catalog_page_pkey on catalog_page  (cost=0.29..0.30 rows=1 width=21) (never executed)\n                                                               Index Cond: (cp_catalog_page_sk = catalog_sales.cs_catalog_page_sk)\n                                       ->  Index Scan using catalog_returns_pkey on catalog_returns  (cost=0.43..0.60 rows=1 width=20) (never executed)\n                                             Index Cond: ((cr_item_sk = catalog_sales.cs_item_sk) AND (cr_order_number = catalog_sales.cs_order_number))\n                     ->  Subquery Scan on wsr  (cost=12329.88..12330.17 rows=1 width=160) (actual time=16.054..16.622 rows=0 loops=1)\n                           Buffers: shared hit=1993 read=1983\n... (53 more lines truncated)", "explain_rewritten": "QUERY PLAN                                                                                                                                \n--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=90936.74..90938.71 rows=79 width=160) (actual time=69.944..69.964 rows=3 loops=1)\n   Buffers: shared hit=465 read=10926\n   CTE filtered_date\n     ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1599.11 rows=33 width=4) (actual time=0.540..1.318 rows=31 loops=1)\n           Index Cond: ((d_date >= '1998-08-23'::date) AND (d_date <= '1998-09-22 00:00:00'::timestamp without time zone))\n           Buffers: shared read=203\n   CTE filtered_item\n     ->  Bitmap Heap Scan on item  (cost=485.15..7693.80 rows=356 width=4) (actual time=1.470..16.322 rows=344 loops=1)\n           Recheck Cond: (i_category = ANY ('{Jewelry,Music}'::bpchar[]))\n           Filter: (i_current_price > '50'::numeric)\n           Rows Removed by Filter: 5924\n           Heap Blocks: exact=4241\n           Buffers: shared hit=18 read=4335\n           ->  Bitmap Index Scan on _dta_index_item_6_853578079__k13_k11_k1  (cost=0.00..485.06 rows=6429 width=0) (actual time=0.964..0.964 rows=6268 loops=1)\n                 Index Cond: (i_category = ANY ('{Jewelry,Music}'::bpchar[]))\n                 Buffers: shared hit=1 read=111\n   CTE filtered_promotion\n     ->  Seq Scan on promotion  (cost=0.00..24.25 rows=12 width=4) (actual time=0.011..0.065 rows=10 loops=1)\n           Filter: ((p_channel_email = 'Y'::bpchar) AND (p_channel_tv = 'Y'::bpchar) AND (p_channel_event = 'Y'::bpchar) AND (p_channel_radio = 'N'::bpchar) AND (p_channel_press = 'N'::bpchar))\n           Rows Removed by Filter: 490\n           Buffers: shared hit=13\n   ->  GroupAggregate  (cost=81619.58..81621.55 rows=79 width=160) (actual time=69.943..69.960 rows=3 loops=1)\n         Group Key: ('store channel'::text), (('store'::text || (ssr.store_id)::text))\n         Group Key: ('store channel'::text)\n         Group Key: ()\n         Buffers: shared hit=465 read=10926\n         ->  Sort  (cost=81619.58..81619.68 rows=39 width=160) (actual time=69.928..69.945 rows=1 loops=1)\n               Sort Key: ('store channel'::text), (('store'::text || (ssr.store_id)::text))\n               Sort Method: quicksort  Memory: 25kB\n               Buffers: shared hit=465 read=10926\n               ->  Append  (cost=34948.97..81618.55 rows=39 width=160) (actual time=43.410..69.934 rows=1 loops=1)\n                     Buffers: shared hit=462 read=10926\n                     ->  Subquery Scan on ssr  (cost=34948.97..34950.20 rows=26 width=160) (actual time=43.409..43.416 rows=1 loops=1)\n                           Buffers: shared hit=147 read=6678\n                           ->  GroupAggregate  (cost=34948.97..34949.81 rows=26 width=113) (actual time=43.405..43.411 rows=1 loops=1)\n                                 Group Key: store.s_store_id\n                                 Buffers: shared hit=147 read=6678\n                                 ->  Sort  (cost=34948.97..34949.03 rows=26 width=41) (actual time=43.396..43.402 rows=1 loops=1)\n                                       Sort Key: store.s_store_id\n                                       Sort Method: quicksort  Memory: 25kB\n                                       Buffers: shared hit=147 read=6678\n                                       ->  Nested Loop Left Join  (cost=12.96..34948.36 rows=26 width=41) (actual time=43.381..43.391 rows=1 loops=1)\n                                             Buffers: shared hit=144 read=6678\n                                             ->  Nested Loop  (cost=12.52..34894.62 rows=26 width=37) (actual time=43.364..43.374 rows=1 loops=1)\n                                                   Join Filter: (store_sales.ss_store_sk = store.s_store_sk)\n                                                   Rows Removed by Join Filter: 101\n                                                   Buffers: shared hit=144 read=6675\n                                                   ->  Seq Scan on store  (cost=0.00..6.02 rows=102 width=21) (actual time=0.003..0.021 rows=102 loops=1)\n                                                         Buffers: shared hit=1 read=4\n                                                   ->  Materialize  (cost=12.52..34847.35 rows=27 width=24) (actual time=0.325..0.425 rows=1 loops=102)\n                                                         Buffers: shared hit=143 read=6671\n                                                         ->  Hash Join  (cost=12.52..34847.22 rows=27 width=24) (actual time=33.152..43.327 rows=1 loops=1)\n                                                               Hash Cond: (store_sales.ss_item_sk = filtered_item.i_item_sk)\n                                                               Buffers: shared hit=143 read=6671\n                                                               ->  Hash Join  (cost=0.95..34750.21 rows=1793 width=24) (actual time=0.675..26.815 rows=629 loops=1)\n                                                                     Hash Cond: (store_sales.ss_promo_sk = filtered_promotion.p_promo_sk)\n                                                                     Buffers: shared hit=125 read=2336\n                                                                     ->  Nested Loop  (cost=0.56..34438.15 rows=78330 width=28) (actual time=0.583..25.600 rows=28566 loops=1)\n                                                                           Buffers: shared hit=112 read=2336\n                                                                           ->  CTE Scan on filtered_date  (cost=0.00..0.66 rows=33 width=4) (actual time=0.541..1.335 rows=31 loops=1)\n                                                                                 Buffers: shared read=203\n                                                                           ->  Index Only Scan using _dta_index_store_sales_6_1333579789__k1_k23_k14_k6_k8_k5_k7_3_4 on store_sales  (cost=0.56..1019.82 rows=2374 width=32) (actual time=0.009..0.739 rows=921 loops=31)\n                                                                                 Index Cond: (ss_sold_date_sk = filtered_date.d_date_sk)\n                                                                                 Filter: ((ss_wholesale_cost >= '63'::numeric) AND (ss_wholesale_cost <= '78'::numeric))\n                                                                                 Rows Removed by Filter: 4108\n                                                                                 Heap Fetches: 0\n                                                                                 Buffers: shared hit=112 read=2133\n                                                                     ->  Hash  (cost=0.24..0.24 rows=12 width=4) (actual time=0.078..0.079 rows=10 loops=1)\n                                                                           Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                                                                           Buffers: shared hit=13\n                                                                           ->  CTE Scan on filtered_promotion  (cost=0.00..0.24 rows=12 width=4) (actual time=0.013..0.067 rows=10 loops=1)\n                                                                                 Buffers: shared hit=13\n                                                               ->  Hash  (cost=7.12..7.12 rows=356 width=4) (actual time=16.436..16.437 rows=344 loops=1)\n                                                                     Buckets: 1024  Batches: 1  Memory Usage: 21kB\n                                                                     Buffers: shared hit=18 read=4335\n                                                                     ->  CTE Scan on filtered_item  (cost=0.00..7.12 rows=356 width=4) (actual time=1.472..16.385 rows=344 loops=1)\n                                                                           Buffers: shared hit=18 read=4335\n                                             ->  Index Scan using store_returns_pkey on store_returns  (cost=0.43..2.07 rows=1 width=20) (actual time=0.014..0.014 rows=0 loops=1)\n                                                   Index Cond: ((sr_item_sk = store_sales.ss_item_sk) AND (sr_ticket_number = store_sales.ss_ticket_number))\n                                                   Buffers: shared read=3\n                     ->  Subquery Scan on csr  (cost=30487.04..30487.37 rows=7 width=160) (actual time=14.381..14.387 rows=0 loops=1)\n                           Buffers: shared hit=143 read=2384\n                           ->  GroupAggregate  (cost=30487.04..30487.27 rows=7 width=113) (actual time=14.380..14.385 rows=0 loops=1)\n                                 Group Key: catalog_page.cp_catalog_page_id\n                                 Buffers: shared hit=143 read=2384\n                                 ->  Sort  (cost=30487.04..30487.06 rows=7 width=41) (actual time=14.378..14.383 rows=0 loops=1)\n                                       Sort Key: catalog_page.cp_catalog_page_id\n                                       Sort Method: quicksort  Memory: 25kB\n                                       Buffers: shared hit=143 read=2384\n                                       ->  Nested Loop  (cost=13.11..30486.94 rows=7 width=41) (actual time=14.368..14.372 rows=0 loops=1)\n                                             Buffers: shared hit=143 read=2384\n                                             ->  Nested Loop Left Join  (cost=12.82..30484.82 rows=7 width=28) (actual time=14.367..14.371 rows=0 loops=1)\n                                                   Buffers: shared hit=143 read=2384\n                                                   ->  Hash Join  (cost=12.39..30480.60 rows=7 width=24) (actual time=14.366..14.369 rows=0 loops=1)\n                                                         Hash Cond: (catalog_sales.cs_item_sk = filtered_item_1.i_item_sk)\n                                                         Buffers: shared hit=143 read=2384\n                                                         ->  Hash Join  (cost=0.83..30446.49 rows=473 width=24) (actual time=0.302..14.312 rows=176 loops=1)\n                                                               Hash Cond: (catalog_sales.cs_promo_sk = filtered_promotion_1.p_promo_sk)\n                                                               Buffers: shared hit=143 read=2384\n                                                               ->  Nested Loop  (cost=0.43..30367.20 rows=19781 width=28) (actual time=0.025..13.950 rows=7578 loops=1)\n                                                                     Buffers: shared hit=143 read=2384\n                                                                     ->  CTE Scan on filtered_date filtered_date_1  (cost=0.00..0.66 rows=33 width=4) (actual time=0.000..0.008 rows=31 loops=1)\n                                                                     ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k1_4 on catalog_sales  (cost=0.43..914.21 rows=599 width=32) (actual time=0.006..0.429 rows=244 loops=31)\n                                                                           Index Cond: (cs_sold_date_sk = filtered_date_1.d_date_sk)\n                                                                           Filter: ((cs_wholesale_cost >= '63'::numeric) AND (cs_wholesale_cost <= '78'::numeric))\n                                                                           Rows Removed by Filter: 2443\n                                                                           Buffers: shared hit=143 read=2384\n                                                               ->  Hash  (cost=0.24..0.24 rows=12 width=4) (actual time=0.004..0.005 rows=10 loops=1)\n                                                                     Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                                                                     ->  CTE Scan on filtered_promotion filtered_promotion_1  (cost=0.00..0.24 rows=12 width=4) (actual time=0.000..0.001 rows=10 loops=1)\n                                                         ->  Hash  (cost=7.12..7.12 rows=356 width=4) (actual time=0.026..0.026 rows=344 loops=1)\n                                                               Buckets: 1024  Batches: 1  Memory Usage: 21kB\n                                                               ->  CTE Scan on filtered_item filtered_item_1  (cost=0.00..7.12 rows=356 width=4) (actual time=0.001..0.011 rows=344 loops=1)\n                                                   ->  Index Scan using catalog_returns_pkey on catalog_returns  (cost=0.43..0.60 rows=1 width=20) (never executed)\n                                                         Index Cond: ((cr_item_sk = catalog_sales.cs_item_sk) AND (cr_order_number = catalog_sales.cs_order_number))\n                                             ->  Index Scan using catalog_page_pkey on catalog_page  (cost=0.29..0.30 rows=1 width=21) (never executed)\n                                                   Index Cond: (cp_catalog_page_sk = catalog_sales.cs_catalog_page_sk)\n                     ->  Subquery Scan on wsr  (cost=16180.49..16180.78 rows=6 width=160) (actual time=12.124..12.126 rows=0 loops=1)\n... (44 more lines truncated)", "gap": "COMMA_JOIN_WEAKNESS", "queries": ["DSB Q080_multi"]}
{"id": 22, "query_sql": "WITH customer_total_return AS (\n  SELECT sr_customer_sk AS ctr_customer_sk,\n         sr_store_sk AS ctr_store_sk,\n         sr_reason_sk AS ctr_reason_sk,\n         SUM(SR_REFUNDED_CASH) AS ctr_total_return\n  FROM store_returns, date_dim\n  WHERE sr_returned_date_sk = d_date_sk\n    AND d_year = 2001\n    AND sr_return_amt / sr_return_quantity BETWEEN 236 AND 295\n  GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk\n)\nSELECT c_customer_id\nFROM customer_total_return ctr1, store, customer, customer_demographics\nWHERE ctr1.ctr_total_return > (\n    SELECT AVG(ctr_total_return) * 1.2\n    FROM customer_total_return ctr2\n    WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk\n  )\n  AND ctr1.ctr_reason_sk BETWEEN 28 AND 31\n  AND s_store_sk = ctr1.ctr_store_sk\n  AND s_state IN ('MI', 'NC', 'WI')\n  AND ctr1.ctr_customer_sk = c_customer_sk\n  AND c_current_cdemo_sk = cd_demo_sk\n  AND cd_marital_status IN ('W', 'W')\n  AND cd_education_status IN ('4 yr Degree', 'College')\n  AND cd_gender = 'M'\n  AND c_birth_month = 5\n  AND c_birth_year BETWEEN 1950 AND 1956\nORDER BY c_customer_id\nLIMIT 100", "rewritten_sql": "WITH customer_total_return AS (\n    SELECT sr_customer_sk AS ctr_customer_sk,\n           sr_store_sk AS ctr_store_sk,\n           sr_reason_sk AS ctr_reason_sk,\n           SUM(SR_REFUNDED_CASH) AS ctr_total_return\n    FROM store_returns\n    JOIN date_dim ON sr_returned_date_sk = d_date_sk\n    JOIN store ON sr_store_sk = s_store_sk\n    WHERE d_year = 2001\n      AND s_state IN ('MI', 'NC', 'WI')\n      AND sr_return_amt / sr_return_quantity BETWEEN 236 AND 295\n    GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk\n),\nstore_thresholds AS (\n    SELECT ctr_store_sk,\n           AVG(ctr_total_return) * 1.2 AS avg_limit\n    FROM customer_total_return\n    GROUP BY ctr_store_sk\n)\nSELECT c_customer_id\nFROM customer_total_return ctr1\nJOIN store_thresholds st ON ctr1.ctr_store_sk = st.ctr_store_sk\nJOIN customer ON ctr1.ctr_customer_sk = c_customer_sk\nJOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk\nJOIN store s ON ctr1.ctr_store_sk = s.s_store_sk\nWHERE ctr1.ctr_total_return > st.avg_limit\n  AND ctr1.ctr_reason_sk BETWEEN 28 AND 31\n  AND s.s_state IN ('MI', 'NC', 'WI')\n  AND cd_marital_status = 'W'\n  AND cd_education_status IN ('4 yr Degree', 'College')\n  AND cd_gender = 'M'\n  AND c_birth_month = 5\n  AND c_birth_year BETWEEN 1950 AND 1956\nORDER BY c_customer_id\nLIMIT 100", "transform": "early_filter_decorrelate", "original_ms": 1208.313, "rewritten_ms": 1186.172, "ratio": 1.13, "outcome": "WIN", "declared_speedup": "1.13x", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "QUERY PLAN                                                                                                   \n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=56617.64..56617.65 rows=1 width=17) (actual time=1208.062..1208.133 rows=0 loops=1)\n   Buffers: shared hit=557450 read=844599\n   CTE customer_total_return\n     ->  Finalize GroupAggregate  (cost=55898.70..55921.07 rows=172 width=44) (actual time=1130.848..1134.758 rows=6963 loops=1)\n           Group Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n           Buffers: shared hit=556877 read=844552\n           ->  Gather Merge  (cost=55898.70..55917.12 rows=144 width=44) (actual time=1130.842..1132.625 rows=6966 loops=1)\n                 Workers Planned: 2\n                 Workers Launched: 2\n                 Buffers: shared hit=556877 read=844552\n                 ->  Partial GroupAggregate  (cost=54898.68..54900.48 rows=72 width=44) (actual time=752.173..753.001 rows=2322 loops=3)\n                       Group Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n                       Buffers: shared hit=556877 read=844552\n                       ->  Sort  (cost=54898.68..54898.86 rows=72 width=18) (actual time=752.166..752.299 rows=2324 loops=3)\n                             Sort Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n                             Sort Method: quicksort  Memory: 363kB\n                             Buffers: shared hit=556877 read=844552\n                             Worker 0:  Sort Method: quicksort  Memory: 25kB\n                             Worker 1:  Sort Method: quicksort  Memory: 372kB\n                             ->  Nested Loop  (cost=0.72..54896.46 rows=72 width=18) (actual time=0.924..750.962 rows=2324 loops=3)\n                                   Buffers: shared hit=556863 read=844552\n                                   ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k1_k7_k9 on date_dim  (cost=0.29..1677.67 rows=151 width=4) (actual time=0.487..0.675 rows=122 loops=3)\n                                         Index Cond: (d_year = 2001)\n                                         Heap Fetches: 0\n                                         Buffers: shared hit=6 read=277\n                                   ->  Index Scan using _dta_index_store_returns_6_1013578649__k1_3_4_10 on store_returns  (cost=0.43..352.28 rows=16 width=22) (actual time=0.301..6.161 rows=19 loops=365)\n                                         Index Cond: (sr_returned_date_sk = date_dim.d_date_sk)\n                                         Filter: (((sr_return_amt / (sr_return_quantity)::numeric) >= '236'::numeric) AND ((sr_return_amt / (sr_return_quantity)::numeric) <= '295'::numeric))\n                                         Rows Removed by Filter: 4456\n                                         Buffers: shared hit=556857 read=844275\n   ->  Sort  (cost=696.57..696.57 rows=1 width=17) (actual time=1208.060..1208.063 rows=0 loops=1)\n         Sort Key: customer.c_customer_id\n         Sort Method: quicksort  Memory: 25kB\n         Buffers: shared hit=265176 read=427434\n         ->  Nested Loop  (cost=0.85..696.56 rows=1 width=17) (actual time=1208.047..1208.049 rows=0 loops=1)\n               Buffers: shared hit=265173 read=427434\n               ->  Nested Loop  (cost=0.42..688.38 rows=1 width=21) (actual time=1208.047..1208.048 rows=0 loops=1)\n                     Buffers: shared hit=265173 read=427434\n                     ->  Nested Loop  (cost=0.00..679.91 rows=1 width=4) (actual time=1143.098..1207.876 rows=18 loops=1)\n                           Join Filter: (ctr1.ctr_store_sk = store.s_store_sk)\n                           Rows Removed by Join Filter: 1015\n                           Buffers: shared hit=265143 read=427392\n                           ->  CTE Scan on customer_total_return ctr1  (cost=0.00..673.38 rows=1 width=8) (actual time=1135.590..1206.504 rows=122 loops=1)\n                                 Filter: ((ctr_reason_sk >= 28) AND (ctr_reason_sk <= 31) AND (ctr_total_return > (SubPlan 2)))\n                                 Rows Removed by Filter: 6841\n                                 Buffers: shared hit=264603 read=427387\n                                 SubPlan 2\n                                   ->  Aggregate  (cost=3.87..3.89 rows=1 width=32) (actual time=0.189..0.189 rows=1 loops=399)\n                                         ->  CTE Scan on customer_total_return ctr2  (cost=0.00..3.87 rows=1 width=32) (actual time=0.002..0.179 rows=177 loops=399)\n                                               Filter: (ctr1.ctr_store_sk = ctr_store_sk)\n                                               Rows Removed by Filter: 6786\n                           ->  Seq Scan on store  (cost=0.00..6.40 rows=10 width=4) (actual time=0.001..0.010 rows=8 loops=122)\n                                 Filter: (s_state = ANY ('{MI,NC,WI}'::bpchar[]))\n                                 Rows Removed by Filter: 82\n                                 Buffers: shared hit=540 read=5\n                     ->  Index Scan using _dta_index_customer_6_949578421__k1_k5 on customer  (cost=0.42..8.45 rows=1 width=25) (actual time=0.009..0.009 rows=0 loops=18)\n                           Index Cond: (c_customer_sk = ctr1.ctr_customer_sk)\n                           Filter: ((c_birth_year >= 1950) AND (c_birth_year <= 1956) AND (c_birth_month = 5))\n                           Rows Removed by Filter: 1\n                           Buffers: shared hit=30 read=42\n               ->  Index Scan using customer_demographics_pkey on customer_demographics  (cost=0.43..8.18 rows=1 width=4) (never executed)\n                     Index Cond: (cd_demo_sk = customer.c_current_cdemo_sk)\n                     Filter: ((cd_marital_status = ANY ('{W,W}'::bpchar[])) AND (cd_education_status = ANY ('{\"4 yr Degree\",College}'::bpchar[])) AND (cd_gender = 'M'::bpchar))\n Planning:\n   Buffers: shared hit=517 read=61\n Planning Time: 1.020 ms\n Execution Time: 1208.313 ms\n(67 rows)", "explain_rewritten": "QUERY PLAN                                                                                                      \n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=55924.18..55924.19 rows=1 width=17) (actual time=1185.976..1186.031 rows=0 loops=1)\n   Buffers: shared hit=540637 read=861075\n   CTE customer_total_return\n     ->  Finalize GroupAggregate  (cost=55901.99..55904.15 rows=16 width=44) (actual time=1184.623..1185.364 rows=1186 loops=1)\n           Group Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n           Buffers: shared hit=540604 read=861033\n           ->  Gather Merge  (cost=55901.99..55903.78 rows=14 width=44) (actual time=1184.615..1184.955 rows=1186 loops=1)\n                 Workers Planned: 2\n                 Workers Launched: 2\n                 Buffers: shared hit=540604 read=861033\n                 ->  Partial GroupAggregate  (cost=54901.96..54902.14 rows=7 width=44) (actual time=785.039..785.182 rows=395 loops=3)\n                       Group Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n                       Buffers: shared hit=540604 read=861033\n                       ->  Sort  (cost=54901.96..54901.98 rows=7 width=18) (actual time=785.033..785.055 rows=395 loops=3)\n                             Sort Key: store_returns.sr_customer_sk, store_returns.sr_store_sk, store_returns.sr_reason_sk\n                             Sort Method: quicksort  Memory: 70kB\n                             Buffers: shared hit=540604 read=861033\n                             Worker 0:  Sort Method: quicksort  Memory: 25kB\n                             Worker 1:  Sort Method: quicksort  Memory: 72kB\n                             ->  Nested Loop  (cost=0.88..54901.86 rows=7 width=18) (actual time=1.675..784.614 rows=395 loops=3)\n                                   Buffers: shared hit=540590 read=861033\n                                   ->  Nested Loop  (cost=0.72..54896.46 rows=72 width=18) (actual time=0.826..783.048 rows=2324 loops=3)\n                                         Buffers: shared hit=540386 read=861029\n                                         ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k1_k7_k9 on date_dim  (cost=0.29..1677.67 rows=151 width=4) (actual time=0.450..0.612 rows=122 loops=3)\n                                               Index Cond: (d_year = 2001)\n                                               Heap Fetches: 0\n                                               Buffers: shared hit=7 read=276\n                                         ->  Index Scan using _dta_index_store_returns_6_1013578649__k1_3_4_10 on store_returns  (cost=0.43..352.28 rows=16 width=22) (actual time=0.317..6.424 rows=19 loops=365)\n                                               Index Cond: (sr_returned_date_sk = date_dim.d_date_sk)\n                                               Filter: (((sr_return_amt / (sr_return_quantity)::numeric) >= '236'::numeric) AND ((sr_return_amt / (sr_return_quantity)::numeric) <= '295'::numeric))\n                                               Rows Removed by Filter: 4456\n                                               Buffers: shared hit=540379 read=860753\n                                   ->  Memoize  (cost=0.15..0.17 rows=1 width=4) (actual time=0.000..0.000 rows=0 loops=6973)\n                                         Cache Key: store_returns.sr_store_sk\n                                         Cache Mode: logical\n                                         Hits: 3377  Misses: 52  Evictions: 0  Overflows: 0  Memory Usage: 4kB\n                                         Buffers: shared hit=204 read=4\n                                         Worker 1:  Hits: 3492  Misses: 52  Evictions: 0  Overflows: 0  Memory Usage: 4kB\n                                         ->  Index Scan using _dta_index_store_6_885578193__k1_2_6 on store  (cost=0.14..0.16 rows=1 width=4) (actual time=0.003..0.003 rows=0 loops=104)\n                                               Index Cond: (s_store_sk = store_returns.sr_store_sk)\n                                               Filter: (s_state = ANY ('{MI,NC,WI}'::bpchar[]))\n                                               Rows Removed by Filter: 1\n                                               Buffers: shared hit=204 read=4\n   ->  Sort  (cost=20.03..20.03 rows=1 width=17) (actual time=1185.974..1185.976 rows=0 loops=1)\n         Sort Key: customer.c_customer_id\n         Sort Method: quicksort  Memory: 25kB\n         Buffers: shared hit=250663 read=441504\n         ->  Nested Loop  (cost=1.39..20.02 rows=1 width=17) (actual time=1185.956..1185.958 rows=0 loops=1)\n               Join Filter: (ctr1.ctr_store_sk = s.s_store_sk)\n               Buffers: shared hit=250660 read=441504\n               ->  Nested Loop  (cost=1.25..18.09 rows=1 width=25) (actual time=1185.956..1185.957 rows=0 loops=1)\n                     Buffers: shared hit=250660 read=441504\n                     ->  Nested Loop  (cost=0.82..9.91 rows=1 width=29) (actual time=1185.956..1185.957 rows=0 loops=1)\n                           Buffers: shared hit=250660 read=441504\n                           ->  Nested Loop  (cost=0.40..1.44 rows=1 width=12) (actual time=1185.646..1185.784 rows=18 loops=1)\n                                 Join Filter: ((ctr1.ctr_total_return > ((avg(customer_total_return.ctr_total_return) * 1.2))) AND (ctr1.ctr_store_sk = customer_total_return.ctr_store_sk))\n                                 Rows Removed by Join Filter: 369\n                                 Buffers: shared hit=250630 read=441462\n                                 ->  CTE Scan on customer_total_return ctr1  (cost=0.00..0.40 rows=1 width=40) (actual time=1184.630..1184.666 rows=73 loops=1)\n                                       Filter: ((ctr_reason_sk >= 28) AND (ctr_reason_sk <= 31))\n                                       Rows Removed by Filter: 1113\n                                       Buffers: shared hit=250630 read=441462\n                                 ->  HashAggregate  (cost=0.40..0.64 rows=16 width=36) (actual time=0.014..0.015 rows=5 loops=73)\n                                       Group Key: customer_total_return.ctr_store_sk\n                                       Batches: 1  Memory Usage: 24kB\n                                       ->  CTE Scan on customer_total_return  (cost=0.00..0.32 rows=16 width=36) (actual time=0.001..0.862 rows=1186 loops=1)\n                           ->  Index Scan using _dta_index_customer_6_949578421__k1_k5 on customer  (cost=0.42..8.45 rows=1 width=25) (actual time=0.009..0.009 rows=0 loops=18)\n                                 Index Cond: (c_customer_sk = ctr1.ctr_customer_sk)\n                                 Filter: ((c_birth_year >= 1950) AND (c_birth_year <= 1956) AND (c_birth_month = 5))\n                                 Rows Removed by Filter: 1\n                                 Buffers: shared hit=30 read=42\n                     ->  Index Scan using customer_demographics_pkey on customer_demographics  (cost=0.43..8.18 rows=1 width=4) (never executed)\n                           Index Cond: (cd_demo_sk = customer.c_current_cdemo_sk)\n                           Filter: ((cd_education_status = ANY ('{\"4 yr Degree\",College}'::bpchar[])) AND (cd_marital_status = 'W'::bpchar) AND (cd_gender = 'M'::bpchar))\n               ->  Index Scan using _dta_index_store_6_885578193__k1_2_6 on store s  (cost=0.14..1.91 rows=1 width=4) (never executed)\n                     Index Cond: (s_store_sk = customer_total_return.ctr_store_sk)\n                     Filter: (s_state = ANY ('{MI,NC,WI}'::bpchar[]))\n Planning:\n   Buffers: shared hit=551 read=83\n Planning Time: 1.235 ms\n Execution Time: 1186.172 ms\n(81 rows)", "gap": "CORRELATED_SUBQUERY_PARALYSIS", "queries": []}
{"id": 23, "query_sql": "select  sum(cs_ext_discount_amt)  as \"excess discount amount\"\nfrom\n   catalog_sales\n   ,item\n   ,date_dim\nwhere\n(i_manufact_id in (1, 78, 97, 516, 521)\nor i_manager_id BETWEEN 25 and 54)\nand i_item_sk = cs_item_sk\nand d_date between '1999-03-07' and\n        cast('1999-03-07' as date) + interval '90 day'\nand d_date_sk = cs_sold_date_sk\nand cs_ext_discount_amt\n     > (\n         select\n            1.3 * avg(cs_ext_discount_amt)\n         from\n            catalog_sales\n           ,date_dim\n         where\n              cs_item_sk = i_item_sk\n          and d_date between '1999-03-07' and\n                             cast('1999-03-07' as date) + interval '90 day'\n          and d_date_sk = cs_sold_date_sk\n          and cs_list_price between 16 and 45\n          and cs_sales_price / cs_list_price BETWEEN 63 * 0.01 AND 83 * 0.01\n      )\norder by sum(cs_ext_discount_amt)\nlimit 100;", "rewritten_sql": "WITH filtered_items AS MATERIALIZED (\n    SELECT i_item_sk\n    FROM item\n    WHERE i_manufact_id IN (1, 78, 97, 516, 521)\n       OR i_manager_id BETWEEN 25 AND 54\n),\ndate_filtered_sales AS MATERIALIZED (\n    SELECT cs.cs_item_sk, cs.cs_ext_discount_amt,\n           cs.cs_list_price, cs.cs_sales_price\n    FROM catalog_sales cs\n    JOIN date_dim d ON d.d_date_sk = cs.cs_sold_date_sk\n    WHERE d.d_date BETWEEN '1999-03-07' AND cast('1999-03-07' as date) + interval '90 day'\n),\nitem_avg_discount AS MATERIALIZED (\n    SELECT dfs.cs_item_sk,\n           1.3 * avg(dfs.cs_ext_discount_amt) AS threshold\n    FROM date_filtered_sales dfs\n    JOIN filtered_items fi ON fi.i_item_sk = dfs.cs_item_sk\n    WHERE dfs.cs_list_price BETWEEN 16 AND 45\n      AND dfs.cs_sales_price / dfs.cs_list_price BETWEEN 63 * 0.01 AND 83 * 0.01\n    GROUP BY dfs.cs_item_sk\n)\nSELECT sum(dfs.cs_ext_discount_amt) AS \"excess discount amount\"\nFROM date_filtered_sales dfs\nJOIN item_avg_discount iad ON iad.cs_item_sk = dfs.cs_item_sk\nWHERE dfs.cs_ext_discount_amt > iad.threshold\nORDER BY 1\nLIMIT 100;", "transform": "inline_decorrelate_materialized", "original_ms": 120100.0, "rewritten_ms": 260.0, "ratio": 461.92, "outcome": "WIN", "declared_speedup": "timeout_rescue", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "TIMEOUT: query exceeded 120s", "explain_rewritten": "QUERY PLAN                                                                                                    \n-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=68371.91..68371.92 rows=1 width=32) (actual time=242.194..242.264 rows=1 loops=1)\n   Buffers: shared hit=452 read=22825, temp read=2125 written=2125\n   CTE filtered_items\n     ->  Seq Scan on item  (cost=0.00..9137.50 rows=30902 width=4) (actual time=0.011..20.667 rows=31390 loops=1)\n           Filter: ((i_manufact_id = ANY ('{1,78,97,516,521}'::integer[])) OR ((i_manager_id >= 25) AND (i_manager_id <= 54)))\n           Rows Removed by Filter: 70610\n           Buffers: shared read=6970\n   CTE date_filtered_sales\n     ->  Gather  (cost=1000.43..57384.66 rows=18828 width=22) (actual time=3.703..69.466 rows=506190 loops=1)\n           Workers Planned: 1\n           Workers Launched: 1\n           Buffers: shared hit=446 read=15855\n           ->  Nested Loop  (cost=0.43..54501.86 rows=11075 width=22) (actual time=1.761..65.697 rows=253095 loops=2)\n                 Buffers: shared hit=446 read=15855\n                 ->  Parallel Seq Scan on date_dim d  (cost=0.00..2049.55 rows=56 width=4) (actual time=1.722..3.291 rows=46 loops=2)\n                       Filter: ((d_date >= '1999-03-07'::date) AND (d_date <= '1999-06-05 00:00:00'::timestamp without time zone))\n                       Rows Removed by Filter: 36479\n                       Buffers: shared hit=6 read=1399\n                 ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k1_4 on catalog_sales cs  (cost=0.43..869.33 rows=6732 width=26) (actual time=0.005..0.870 rows=5563 loops=91)\n                       Index Cond: (cs_sold_date_sk = d.d_date_sk)\n                       Buffers: shared hit=440 read=14456\n   CTE item_avg_discount\n     ->  GroupAggregate  (cost=1400.10..1401.28 rows=1 width=36) (actual time=180.534..182.189 rows=3391 loops=1)\n           Group Key: dfs_1.cs_item_sk\n           Buffers: shared hit=447 read=22126, temp written=2124\n           ->  Sort  (cost=1400.10..1400.49 rows=155 width=18) (actual time=180.526..180.707 rows=8496 loops=1)\n                 Sort Key: dfs_1.cs_item_sk\n                 Sort Method: quicksort  Memory: 783kB\n                 Buffers: shared hit=447 read=22126, temp written=2124\n                 ->  Hash Join  (cost=658.99..1394.46 rows=155 width=18) (actual time=151.768..179.696 rows=8496 loops=1)\n                       Hash Cond: (fi.i_item_sk = dfs_1.cs_item_sk)\n                       Buffers: shared hit=444 read=22126, temp written=2124\n                       ->  CTE Scan on filtered_items fi  (cost=0.00..618.04 rows=30902 width=4) (actual time=0.011..23.596 rows=31390 loops=1)\n                             Buffers: shared read=6970\n                       ->  Hash  (cost=658.98..658.98 rows=1 width=18) (actual time=151.730..151.731 rows=24217 loops=1)\n                             Buckets: 32768 (originally 1024)  Batches: 1 (originally 1)  Memory Usage: 1271kB\n                             Buffers: shared hit=444 read=15156, temp written=2124\n                             ->  CTE Scan on date_filtered_sales dfs_1  (cost=0.00..658.98 rows=1 width=18) (actual time=0.011..149.573 rows=24217 loops=1)\n                                   Filter: ((cs_list_price >= '16'::numeric) AND (cs_list_price <= '45'::numeric) AND ((cs_sales_price / cs_list_price) >= 0.63) AND ((cs_sales_price / cs_list_price) <= 0.83))\n                                   Rows Removed by Filter: 481973\n                                   Buffers: shared hit=444 read=15156, temp written=2124\n   ->  Sort  (cost=448.47..448.48 rows=1 width=32) (actual time=242.193..242.195 rows=1 loops=1)\n         Sort Key: (sum(dfs.cs_ext_discount_amt))\n         Sort Method: quicksort  Memory: 25kB\n         Buffers: shared hit=452 read=22825, temp read=2125 written=2125\n         ->  Aggregate  (cost=448.45..448.46 rows=1 width=32) (actual time=242.175..242.177 rows=1 loops=1)\n               Buffers: shared hit=449 read=22825, temp read=2125 written=2125\n               ->  Hash Join  (cost=0.03..448.37 rows=31 width=14) (actual time=186.437..238.866 rows=71795 loops=1)\n                     Hash Cond: (dfs.cs_item_sk = iad.cs_item_sk)\n                     Join Filter: (dfs.cs_ext_discount_amt > iad.threshold)\n                     Rows Removed by Join Filter: 47490\n                     Buffers: shared hit=449 read=22825, temp read=2125 written=2125\n                     ->  CTE Scan on date_filtered_sales dfs  (cost=0.00..376.56 rows=18828 width=18) (actual time=3.705..22.601 rows=506190 loops=1)\n                           Buffers: shared hit=2 read=699, temp read=2125 written=1\n                     ->  Hash  (cost=0.02..0.02 rows=1 width=36) (actual time=182.696..182.696 rows=3391 loops=1)\n                           Buckets: 4096 (originally 1024)  Batches: 1 (originally 1)  Memory Usage: 175kB\n                           Buffers: shared hit=447 read=22126, temp written=2124\n                           ->  CTE Scan on item_avg_discount iad  (cost=0.00..0.02 rows=1 width=36) (actual time=180.536..182.522 rows=3391 loops=1)\n                                 Buffers: shared hit=447 read=22126, temp written=2124\n Planning:\n   Buffers: shared hit=600 read=77\n Planning Time: 1.145 ms\n Execution Time: 243.970 ms\n(63 rows)", "gap": "CORRELATED_SUBQUERY_PARALYSIS", "queries": []}
{"id": 24, "query_sql": "select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk)\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk)\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '501-1000'\n  and d1.d_year = 1998\n  and cd_marital_status = 'M'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Home', 'Men', 'Music')\n  and cs_wholesale_cost BETWEEN 34 AND 54\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;", "rewritten_sql": "WITH filtered_date AS MATERIALIZED (\n  SELECT d_date_sk, d_date, d_week_seq\n  FROM date_dim\n  WHERE d_year = 1998\n),\nfiltered_item AS MATERIALIZED (\n  SELECT i_item_sk, i_item_desc\n  FROM item\n  WHERE i_category IN ('Home', 'Men', 'Music')\n),\nfiltered_cd AS MATERIALIZED (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status = 'M'\n    AND cd_dep_count BETWEEN 9 AND 11\n),\nfiltered_hd AS MATERIALIZED (\n  SELECT hd_demo_sk\n  FROM household_demographics\n  WHERE hd_buy_potential = '501-1000'\n),\ncs_filtered AS MATERIALIZED (\n  SELECT cs_item_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk,\n         cs_ship_date_sk, cs_promo_sk, cs_quantity, cs_wholesale_cost,\n         cs_order_number\n  FROM catalog_sales\n  WHERE cs_wholesale_cost BETWEEN 34 AND 54\n)\nSELECT i.i_item_desc,\n       w.w_warehouse_name,\n       d1.d_week_seq,\n       SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo,\n       SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo,\n       COUNT(*) AS total_cnt\nFROM cs_filtered cs\nJOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk\nJOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk\nJOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk\nJOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk\nJOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk\nJOIN filtered_date d1 ON cs.cs_sold_date_sk = d1.d_date_sk\nJOIN date_dim d2 ON inv.inv_date_sk = d2.d_date_sk\nJOIN date_dim d3 ON cs.cs_ship_date_sk = d3.d_date_sk\nLEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk\nLEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk \n  AND cr.cr_order_number = cs.cs_order_number\nWHERE d1.d_week_seq = d2.d_week_seq\n  AND inv.inv_quantity_on_hand < cs.cs_quantity\n  AND d3.d_date > d1.d_date + INTERVAL '3 day'\nGROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nLIMIT 100;", "transform": "pg_materialized_dimension_fact_prefilter", "original_ms": 360.637, "rewritten_ms": 76.825, "ratio": 2.68, "outcome": "WIN", "declared_speedup": "2.68x", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "QUERY PLAN                                                                                                                           \n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=141742.33..141742.34 rows=1 width=148) (actual time=358.272..360.158 rows=0 loops=1)\n   Buffers: shared hit=104676 read=76906\n   ->  Sort  (cost=141742.33..141742.34 rows=1 width=148) (actual time=358.271..360.156 rows=0 loops=1)\n         Sort Key: (count(*)) DESC, item.i_item_desc, warehouse.w_warehouse_name, d1.d_week_seq\n         Sort Method: quicksort  Memory: 25kB\n         Buffers: shared hit=104676 read=76906\n         ->  GroupAggregate  (cost=141737.90..141742.32 rows=1 width=148) (actual time=358.259..360.144 rows=0 loops=1)\n               Group Key: item.i_item_desc, warehouse.w_warehouse_name, d1.d_week_seq\n               Buffers: shared hit=104673 read=76906\n               ->  Nested Loop  (cost=141737.90..141742.30 rows=1 width=128) (actual time=358.257..360.142 rows=0 loops=1)\n                     Join Filter: (d3.d_date > (d1.d_date + '3 days'::interval))\n                     Buffers: shared hit=104673 read=76906\n                     ->  Gather Merge  (cost=141737.61..141737.72 rows=1 width=136) (actual time=358.256..360.140 rows=0 loops=1)\n                           Workers Planned: 1\n                           Workers Launched: 1\n                           Buffers: shared hit=104673 read=76906\n                           ->  Sort  (cost=140737.60..140737.60 rows=1 width=136) (actual time=355.013..355.021 rows=0 loops=2)\n                                 Sort Key: item.i_item_desc, warehouse.w_warehouse_name, d1.d_week_seq\n                                 Sort Method: quicksort  Memory: 25kB\n                                 Buffers: shared hit=104673 read=76906\n                                 Worker 0:  Sort Method: quicksort  Memory: 25kB\n                                 ->  Nested Loop Left Join  (cost=138673.76..140737.59 rows=1 width=136) (actual time=354.995..355.002 rows=0 loops=2)\n                                       Buffers: shared hit=104658 read=76906\n                                       ->  Nested Loop  (cost=138673.48..140733.44 rows=1 width=136) (actual time=354.994..355.002 rows=0 loops=2)\n                                             Buffers: shared hit=104658 read=76906\n                                             ->  Nested Loop  (cost=138673.19..140728.87 rows=1 width=41) (actual time=354.993..355.000 rows=0 loops=2)\n                                                   Join Filter: (inventory.inv_warehouse_sk = warehouse.w_warehouse_sk)\n                                                   Buffers: shared hit=104658 read=76906\n                                                   ->  Nested Loop  (cost=138673.19..140727.64 rows=1 width=28) (actual time=354.993..354.999 rows=0 loops=2)\n                                                         Buffers: shared hit=104658 read=76906\n                                                         ->  Parallel Hash Join  (cost=138672.62..140668.50 rows=4 width=28) (actual time=354.992..354.998 rows=0 loops=2)\n                                                               Hash Cond: (d2.d_week_seq = d1.d_week_seq)\n                                                               Buffers: shared hit=104658 read=76906\n                                                               ->  Parallel Seq Scan on date_dim d2  (cost=0.00..1834.70 rows=42970 width=8) (never executed)\n                                                               ->  Parallel Hash  (cost=138672.61..138672.61 rows=1 width=24) (actual time=354.921..354.924 rows=0 loops=2)\n                                                                     Buckets: 1024  Batches: 1  Memory Usage: 0kB\n                                                                     Buffers: shared hit=104612 read=76905\n                                                                     ->  Nested Loop  (cost=159.16..138672.61 rows=1 width=24) (actual time=242.881..242.884 rows=0 loops=2)\n                                                                           Buffers: shared hit=104612 read=76905\n                                                                           ->  Hash Join  (cost=158.73..134671.49 rows=844 width=28) (actual time=2.751..196.009 rows=15384 loops=2)\n                                                                                 Hash Cond: (catalog_sales.cs_bill_hdemo_sk = household_demographics.hd_demo_sk)\n                                                                                 Buffers: shared hit=2842 read=55674\n                                                                                 ->  Nested Loop  (cost=0.73..134500.12 rows=5089 width=32) (actual time=2.280..185.811 rows=163368 loops=2)\n                                                                                       Buffers: shared hit=2789 read=55621\n                                                                                       ->  Parallel Index Scan using date_dim_pkey on date_dim d1  (cost=0.29..2962.00 rows=151 width=12) (actual time=2.245..4.097 rows=182 loops=2)\n                                                                                             Filter: (d_year = 1998)\n                                                                                             Rows Removed by Filter: 36342\n                                                                                             Buffers: shared hit=11 read=1597\n                                                                                       ->  Index Scan using _dta_index_catalog_sales_6_1301579675__k1_4 on catalog_sales  (cost=0.43..859.56 rows=1155 width=32) (actual time=0.004..0.945 rows=895 loops=365)\n                                                                                             Index Cond: (cs_sold_date_sk = d1.d_date_sk)\n                                                                                             Filter: ((cs_wholesale_cost >= '34'::numeric) AND (cs_wholesale_cost <= '54'::numeric))\n                                                                                             Rows Removed by Filter: 4383\n                                                                                             Buffers: shared hit=2778 read=54024\n                                                                                 ->  Hash  (cost=143.00..143.00 rows=1200 width=4) (actual time=0.449..0.449 rows=1200 loops=2)\n                                                                                       Buckets: 2048  Batches: 1  Memory Usage: 59kB\n                                                                                       Buffers: shared hit=53 read=53\n                                                                                       ->  Seq Scan on household_demographics  (cost=0.00..143.00 rows=1200 width=4) (actual time=0.007..0.381 rows=1200 loops=2)\n                                                                                             Filter: (hd_buy_potential = '501-1000'::bpchar)\n                                                                                             Rows Removed by Filter: 6000\n                                                                                             Buffers: shared hit=53 read=53\n                                                                           ->  Index Scan using customer_demographics_pkey on customer_demographics  (cost=0.43..4.74 rows=1 width=4) (actual time=0.003..0.003 rows=0 loops=30768)\n                                                                                 Index Cond: (cd_demo_sk = catalog_sales.cs_bill_cdemo_sk)\n                                                                                 Filter: ((cd_dep_count >= 9) AND (cd_dep_count <= 11) AND (cd_marital_status = 'M'::bpchar))\n                                                                                 Rows Removed by Filter: 1\n                                                                                 Buffers: shared hit=101770 read=21231\n                                                         ->  Index Scan using inventory_pkey on inventory  (cost=0.57..14.77 rows=2 width=16) (never executed)\n                                                               Index Cond: ((inv_date_sk = d2.d_date_sk) AND (inv_item_sk = catalog_sales.cs_item_sk))\n                                                               Filter: (inv_quantity_on_hand < catalog_sales.cs_quantity)\n                                                   ->  Seq Scan on warehouse  (cost=0.00..1.10 rows=10 width=21) (never executed)\n                                             ->  Index Scan using item_pkey on item  (cost=0.29..4.57 rows=1 width=107) (never executed)\n                                                   Index Cond: (i_item_sk = catalog_sales.cs_item_sk)\n                                                   Filter: (i_category = ANY ('{Home,Men,Music}'::bpchar[]))\n                                       ->  Index Only Scan using promotion_pkey on promotion  (cost=0.27..4.14 rows=1 width=4) (never executed)\n                                             Index Cond: (p_promo_sk = catalog_sales.cs_promo_sk)\n                                             Heap Fetches: 0\n                     ->  Index Scan using date_dim_pkey on date_dim d3  (cost=0.29..4.56 rows=1 width=8) (never executed)\n                           Index Cond: (d_date_sk = catalog_sales.cs_ship_date_sk)\n Planning:\n   Buffers: shared hit=862 read=147\n Planning Time: 19.080 ms\n Execution Time: 360.637 ms\n(81 rows)", "explain_rewritten": "QUERY PLAN                                                                                            \n-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=3142313.22..3142313.47 rows=100 width=463) (actual time=75.436..75.761 rows=0 loops=1)\n   Buffers: shared hit=36 read=30230, temp written=139\n   CTE filtered_date\n     ->  Index Scan using _dta_index_date_dim_6_661577395__k7_k9 on date_dim  (cost=0.29..579.77 rows=363 width=12) (never executed)\n           Index Cond: (d_year = 1998)\n   CTE filtered_item\n     ->  Seq Scan on item  (cost=0.00..8372.50 rows=17354 width=107) (actual time=0.011..19.141 rows=17487 loops=1)\n           Filter: (i_category = ANY ('{Home,Men,Music}'::bpchar[]))\n           Rows Removed by Filter: 84513\n           Buffers: shared read=6970\n   CTE filtered_cd\n     ->  Gather  (cost=1000.00..36833.93 rows=1 width=4) (actual time=35.535..35.847 rows=0 loops=1)\n           Workers Planned: 2\n           Workers Launched: 2\n           Buffers: shared hit=18 read=21810\n           ->  Parallel Seq Scan on customer_demographics  (cost=0.00..35833.83 rows=1 width=4) (actual time=31.813..31.814 rows=0 loops=3)\n                 Filter: ((cd_dep_count >= 9) AND (cd_dep_count <= 11) AND (cd_marital_status = 'M'::bpchar))\n                 Rows Removed by Filter: 640267\n                 Buffers: shared hit=18 read=21810\n   CTE filtered_hd\n     ->  Seq Scan on household_demographics  (cost=0.00..143.00 rows=1200 width=4) (actual time=0.012..0.412 rows=1200 loops=1)\n           Filter: (hd_buy_potential = '501-1000'::bpchar)\n           Rows Removed by Filter: 6000\n           Buffers: shared read=53\n   CTE cs_filtered\n     ->  Seq Scan on catalog_sales  (cost=0.00..584898.84 rows=2470089 width=38) (actual time=0.013..0.013 rows=1 loops=1)\n           Filter: ((cs_wholesale_cost >= '34'::numeric) AND (cs_wholesale_cost <= '54'::numeric))\n           Buffers: shared read=1\n   ->  Sort  (cost=2511485.18..2511989.94 rows=201902 width=463) (actual time=75.435..75.444 rows=0 loops=1)\n         Sort Key: (count(*)) DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\n         Sort Method: quicksort  Memory: 25kB\n         Buffers: shared hit=36 read=30230, temp written=139\n         ->  GroupAggregate  (cost=2498216.33..2503768.63 rows=201902 width=463) (actual time=75.417..75.425 rows=0 loops=1)\n               Group Key: i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\n               Buffers: shared hit=27 read=30230, temp written=139\n               ->  Sort  (cost=2498216.33..2498721.08 rows=201902 width=443) (actual time=75.414..75.423 rows=0 loops=1)\n                     Sort Key: i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\n                     Sort Method: quicksort  Memory: 25kB\n                     Buffers: shared hit=27 read=30230, temp written=139\n                     ->  Hash Left Join  (cost=7686.86..2398987.43 rows=201902 width=443) (actual time=75.410..75.418 rows=0 loops=1)\n                           Hash Cond: (cs.cs_promo_sk = p.p_promo_sk)\n                           Buffers: shared hit=27 read=30230, temp written=139\n                           ->  Hash Join  (cost=7662.61..2398428.70 rows=201902 width=443) (actual time=75.409..75.416 rows=0 loops=1)\n                                 Hash Cond: (cs.cs_ship_date_sk = d3.d_date_sk)\n                                 Join Filter: (d3.d_date > (d1.d_date + '3 days'::interval))\n                                 Buffers: shared hit=27 read=30230, temp written=139\n                                 ->  Hash Join  (cost=4614.01..2393790.07 rows=605706 width=451) (actual time=61.404..61.411 rows=0 loops=1)\n                                       Hash Cond: (cs.cs_bill_hdemo_sk = hd.hd_demo_sk)\n                                       Buffers: shared hit=18 read=28834, temp written=139\n                                       ->  Hash Join  (cost=4575.01..2372298.98 rows=100951 width=455) (actual time=60.809..60.815 rows=0 loops=1)\n                                             Hash Cond: (cs.cs_item_sk = i.i_item_sk)\n                                             Buffers: shared hit=18 read=28781, temp written=139\n                                             ->  Nested Loop  (cost=3061.00..2366278.67 rows=1163 width=45) (actual time=35.564..35.570 rows=0 loops=1)\n                                                   Join Filter: (inv.inv_warehouse_sk = w.w_warehouse_sk)\n                                                   Buffers: shared hit=18 read=21811\n                                                   ->  Nested Loop  (cost=3061.00..2366117.33 rows=1163 width=32) (actual time=35.563..35.568 rows=0 loops=1)\n                                                         Buffers: shared hit=18 read=21811\n                                                         ->  Hash Join  (cost=3060.43..64486.66 rows=157517 width=32) (actual time=35.562..35.566 rows=0 loops=1)\n                                                               Hash Cond: (d1.d_week_seq = d2.d_week_seq)\n                                                               Buffers: shared hit=18 read=21811\n                                                               ->  Hash Join  (cost=11.83..59610.72 rows=22415 width=28) (actual time=35.561..35.564 rows=0 loops=1)\n                                                                     Hash Cond: (cs.cs_sold_date_sk = d1.d_date_sk)\n                                                                     Buffers: shared hit=18 read=21811\n                                                                     ->  Hash Join  (cost=0.03..58788.15 rows=12350 width=24) (actual time=35.559..35.562 rows=0 loops=1)\n                                                                           Hash Cond: (cs.cs_bill_cdemo_sk = cd.cd_demo_sk)\n                                                                           Buffers: shared hit=18 read=21811\n                                                                           ->  CTE Scan on cs_filtered cs  (cost=0.00..49401.78 rows=2470089 width=32) (actual time=0.014..0.015 rows=1 loops=1)\n                                                                                 Buffers: shared read=1\n                                                                           ->  Hash  (cost=0.02..0.02 rows=1 width=4) (actual time=35.537..35.538 rows=0 loops=1)\n                                                                                 Buckets: 1024  Batches: 1  Memory Usage: 8kB\n                                                                                 Buffers: shared hit=18 read=21810\n                                                                                 ->  CTE Scan on filtered_cd cd  (cost=0.00..0.02 rows=1 width=4) (actual time=35.536..35.536 rows=0 loops=1)\n                                                                                       Buffers: shared hit=18 read=21810\n                                                                     ->  Hash  (cost=7.26..7.26 rows=363 width=12) (never executed)\n                                                                           ->  CTE Scan on filtered_date d1  (cost=0.00..7.26 rows=363 width=12) (never executed)\n                                                               ->  Hash  (cost=2135.49..2135.49 rows=73049 width=8) (never executed)\n                                                                     ->  Seq Scan on date_dim d2  (cost=0.00..2135.49 rows=73049 width=8) (never executed)\n                                                         ->  Index Scan using inventory_pkey on inventory inv  (cost=0.57..14.59 rows=2 width=16) (never executed)\n                                                               Index Cond: ((inv_date_sk = d2.d_date_sk) AND (inv_item_sk = cs.cs_item_sk))\n                                                               Filter: (inv_quantity_on_hand < cs.cs_quantity)\n                                                   ->  Materialize  (cost=0.00..1.15 rows=10 width=21) (never executed)\n                                                         ->  Seq Scan on warehouse w  (cost=0.00..1.10 rows=10 width=21) (never executed)\n                                             ->  Hash  (cost=347.08..347.08 rows=17354 width=422) (actual time=25.042..25.042 rows=17487 loops=1)\n                                                   Buckets: 16384  Batches: 2  Memory Usage: 1323kB\n                                                   Buffers: shared read=6970, temp written=138\n                                                   ->  CTE Scan on filtered_item i  (cost=0.00..347.08 rows=17354 width=422) (actual time=0.013..22.074 rows=17487 loops=1)\n                                                         Buffers: shared read=6970\n                                       ->  Hash  (cost=24.00..24.00 rows=1200 width=4) (actual time=0.578..0.578 rows=1200 loops=1)\n                                             Buckets: 2048  Batches: 1  Memory Usage: 59kB\n                                             Buffers: shared read=53\n                                             ->  CTE Scan on filtered_hd hd  (cost=0.00..24.00 rows=1200 width=4) (actual time=0.015..0.514 rows=1200 loops=1)\n                                                   Buffers: shared read=53\n                                 ->  Hash  (cost=2135.49..2135.49 rows=73049 width=8) (actual time=13.731..13.731 rows=73049 loops=1)\n                                       Buckets: 131072  Batches: 1  Memory Usage: 3878kB\n                                       Buffers: shared hit=9 read=1396\n                                       ->  Seq Scan on date_dim d3  (cost=0.00..2135.49 rows=73049 width=8) (actual time=0.014..7.888 rows=73049 loops=1)\n                                             Buffers: shared hit=9 read=1396\n                           ->  Hash  (cost=18.00..18.00 rows=500 width=4) (never executed)\n                                 ->  Seq Scan on promotion p  (cost=0.00..18.00 rows=500 width=4) (never executed)\n Planning:\n   Buffers: shared hit=807 read=94\n Planning Time: 3.995 ms\n Execution Time: 76.825 ms\n(103 rows)", "gap": "NON_EQUI_JOIN_INPUT_BLINDNESS", "queries": ["DSB Q072_agg"]}
{"id": 25, "query_sql": "select \n\ts_store_name,\n\ti_item_desc,\n\tsc.revenue,\n\ti_current_price,\n\ti_wholesale_cost,\n\ti_brand\n from store, item,\n     (select ss_store_sk, avg(revenue) as ave\n\tfrom\n\t    (select  ss_store_sk, ss_item_sk,\n\t\t     sum(ss_sales_price) as revenue\n\t\tfrom store_sales, date_dim\n\t\twhere ss_sold_date_sk = d_date_sk and d_month_seq between 1213 and 1213+11\n   and ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n\t\tgroup by ss_store_sk, ss_item_sk) sa\n\tgroup by ss_store_sk) sb,\n     (select  ss_store_sk, ss_item_sk, sum(ss_sales_price) as revenue\n\tfrom store_sales, date_dim\n\twhere ss_sold_date_sk = d_date_sk and d_month_seq between 1213 and 1213+11\n  and ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n\tgroup by ss_store_sk, ss_item_sk) sc\n where sb.ss_store_sk = sc.ss_store_sk and\n       sc.revenue <= 0.1 * sb.ave and\n       s_store_sk = sc.ss_store_sk and\n       i_item_sk = sc.ss_item_sk\n       and i_manager_id BETWEEN 32 and 36\n       and s_state in ('TN','TX','VA')\n order by s_store_name, i_item_desc\nlimit 100;", "rewritten_sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1213 + 11), store_sales_revenue AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales JOIN date_filter ON store_sales.ss_sold_date_sk = date_filter.d_date_sk WHERE ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01 GROUP BY ss_store_sk, ss_item_sk), store_avg_revenue AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM store_sales_revenue GROUP BY ss_store_sk), filtered_store AS (SELECT s_store_sk, s_store_name, s_state FROM store WHERE s_state IN ('TN', 'TX', 'VA')), filtered_item AS (SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand, i_manager_id FROM item WHERE i_manager_id BETWEEN 32 AND 36) SELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand FROM store_avg_revenue AS sb JOIN store_sales_revenue AS sc ON sb.ss_store_sk = sc.ss_store_sk JOIN filtered_store AS s ON sc.ss_store_sk = s.s_store_sk JOIN filtered_item AS i ON sc.ss_item_sk = i.i_item_sk WHERE sc.revenue <= 0.1 * sb.ave ORDER BY s_store_name, i_item_desc LIMIT 100", "transform": "pg_self_join_decomposition", "original_ms": 1922.589, "rewritten_ms": 1121.079, "ratio": 3.93, "outcome": "WIN", "declared_speedup": "3.93x", "sf10_speedup": null, "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": "QUERY PLAN                                                                                                                                  \n------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=233852.29..233852.30 rows=1 width=202) (actual time=1916.203..1920.810 rows=100 loops=1)\n   Buffers: shared hit=11488 read=76605, temp read=2360 written=3300\n   ->  Sort  (cost=233852.29..233852.30 rows=1 width=202) (actual time=1916.202..1920.805 rows=100 loops=1)\n         Sort Key: store.s_store_name, item.i_item_desc\n         Sort Method: quicksort  Memory: 60kB\n         Buffers: shared hit=11488 read=76605, temp read=2360 written=3300\n         ->  Nested Loop  (cost=233539.23..233852.28 rows=1 width=202) (actual time=1781.335..1920.704 rows=116 loops=1)\n               Buffers: shared hit=11485 read=76605, temp read=2360 written=3300\n               ->  Merge Join  (cost=233538.94..233743.82 rows=19 width=40) (actual time=1780.883..1911.972 rows=2713 loops=1)\n                     Merge Cond: (store_sales.ss_store_sk = store_sales_1.ss_store_sk)\n                     Join Filter: ((sum(store_sales.ss_sales_price)) <= (0.1 * (avg((sum(store_sales_1.ss_sales_price))))))\n                     Rows Removed by Join Filter: 16754\n                     Buffers: shared hit=6379 read=73572, temp read=2360 written=3300\n                     ->  Finalize GroupAggregate  (cost=116766.11..116855.61 rows=709 width=40) (actual time=867.966..947.714 rows=122947 loops=1)\n                           Group Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n                           Buffers: shared hit=3187 read=36786, temp read=1012 written=1650\n                           ->  Gather Merge  (cost=116766.11..116840.85 rows=590 width=40) (actual time=867.955..909.969 rows=127296 loops=1)\n                                 Workers Planned: 2\n                                 Workers Launched: 2\n                                 Buffers: shared hit=3187 read=36786, temp read=1012 written=1650\n                                 ->  Partial GroupAggregate  (cost=115766.09..115772.72 rows=295 width=40) (actual time=545.967..566.709 rows=42605 loops=3)\n                                       Group Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n                                       Buffers: shared hit=3187 read=36786, temp read=1012 written=1650\n                                       ->  Sort  (cost=115766.09..115766.82 rows=295 width=14) (actual time=545.959..551.441 rows=86683 loops=3)\n                                             Sort Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n                                             Sort Method: external merge  Disk: 6160kB\n                                             Buffers: shared hit=3187 read=36786, temp read=1012 written=1650\n                                             Worker 0:  Sort Method: quicksort  Memory: 25kB\n                                             Worker 1:  Sort Method: external merge  Disk: 6968kB\n                                             ->  Nested Loop  (cost=0.98..115753.98 rows=295 width=14) (actual time=0.538..508.677 rows=179719 loops=3)\n                                                   Buffers: shared hit=3173 read=36786\n                                                   ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k7_k4_k9_k1 on date_dim  (cost=0.42..1868.48 rows=157 width=4) (actual time=0.512..0.576 rows=122 loops=3)\n                                                         Index Cond: ((d_month_seq >= 1213) AND (d_month_seq <= 1224))\n                                                         Heap Fetches: 0\n                                                         Buffers: shared hit=1 read=283\n                                                   ->  Index Only Scan using _dta_index_store_sales_6_1333579789__k1_k5_k8_k3_11_13_14_20 on store_sales  (cost=0.56..724.72 rows=67 width=18) (actual time=0.008..4.103 rows=1477 loops=365)\n                                                         Index Cond: (ss_sold_date_sk = date_dim.d_date_sk)\n                                                         Filter: (((ss_sales_price / ss_list_price) >= 0.38) AND ((ss_sales_price / ss_list_price) <= 0.48))\n                                                         Rows Removed by Filter: 12258\n                                                         Heap Fetches: 0\n                                                         Buffers: shared hit=3172 read=36503\n                     ->  Materialize  (cost=116772.83..116878.25 rows=16 width=44) (actual time=871.464..957.310 rows=13414 loops=1)\n                           Buffers: shared hit=3192 read=36786, temp read=1348 written=1650\n                           ->  Merge Join  (cost=116772.83..116878.21 rows=16 width=44) (actual time=871.461..956.856 rows=4 loops=1)\n                                 Merge Cond: (store.s_store_sk = store_sales_1.ss_store_sk)\n                                 Buffers: shared hit=3192 read=36786, temp read=1348 written=1650\n                                 ->  Sort  (cost=6.72..6.76 rows=16 width=8) (actual time=0.049..0.054 rows=16 loops=1)\n                                       Sort Key: store.s_store_sk\n                                       Sort Method: quicksort  Memory: 25kB\n                                       Buffers: shared read=5\n                                       ->  Seq Scan on store  (cost=0.00..6.40 rows=16 width=8) (actual time=0.015..0.040 rows=16 loops=1)\n                                             Filter: (s_state = ANY ('{TN,TX,VA}'::bpchar[]))\n                                             Rows Removed by Filter: 86\n                                             Buffers: shared read=5\n                                 ->  GroupAggregate  (cost=116766.11..116868.74 rows=200 width=36) (actual time=871.407..956.776 rows=27 loops=1)\n                                       Group Key: store_sales_1.ss_store_sk\n                                       Buffers: shared hit=3192 read=36781, temp read=1348 written=1650\n                                       ->  Finalize GroupAggregate  (cost=116766.11..116855.61 rows=709 width=40) (actual time=866.026..950.203 rows=132510 loops=1)\n                                             Group Key: store_sales_1.ss_store_sk, store_sales_1.ss_item_sk\n                                             Buffers: shared hit=3192 read=36781, temp read=1348 written=1650\n                                             ->  Gather Merge  (cost=116766.11..116840.85 rows=590 width=40) (actual time=866.017..910.681 rows=137379 loops=1)\n                                                   Workers Planned: 2\n                                                   Workers Launched: 2\n                                                   Buffers: shared hit=3192 read=36781, temp read=1348 written=1650\n                                                   ->  Partial GroupAggregate  (cost=115766.09..115772.72 rows=295 width=40) (actual time=535.328..557.835 rows=45977 loops=3)\n                                                         Group Key: store_sales_1.ss_store_sk, store_sales_1.ss_item_sk\n                                                         Buffers: shared hit=3192 read=36781, temp read=1348 written=1650\n                                                         ->  Sort  (cost=115766.09..115766.82 rows=295 width=14) (actual time=535.321..541.354 rows=93682 loops=3)\n                                                               Sort Key: store_sales_1.ss_store_sk, store_sales_1.ss_item_sk\n                                                               Sort Method: external merge  Disk: 6160kB\n                                                               Buffers: shared hit=3192 read=36781, temp read=1348 written=1650\n                                                               Worker 0:  Sort Method: external merge  Disk: 6968kB\n                                                               Worker 1:  Sort Method: quicksort  Memory: 25kB\n                                                               ->  Nested Loop  (cost=0.98..115753.98 rows=295 width=14) (actual time=0.470..498.620 rows=179719 loops=3)\n                                                                     Buffers: shared hit=3179 read=36780\n                                                                     ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k7_k4_k9_k1 on date_dim date_dim_1  (cost=0.42..1868.48 rows=157 width=4) (actual time=0.443..0.507 rows=122 loops=3)\n                                                                           Index Cond: ((d_month_seq >= 1213) AND (d_month_seq <= 1224))\n                                                                           Heap Fetches: 0\n                                                                           Buffers: shared hit=3 read=281\n                                                                     ->  Index Only Scan using _dta_index_store_sales_6_1333579789__k1_k5_k8_k3_11_13_14_20 on store_sales store_sales_1  (cost=0.56..724.72 rows=67 width=18) (actual time=0.008..4.022 rows=1477 loops=365)\n                                                                           Index Cond: (ss_sold_date_sk = date_dim_1.d_date_sk)\n                                                                           Filter: (((ss_sales_price / ss_list_price) >= 0.38) AND ((ss_sales_price / ss_list_price) <= 0.48))\n                                                                           Rows Removed by Filter: 12258\n                                                                           Heap Fetches: 0\n                                                                           Buffers: shared hit=3176 read=36499\n               ->  Index Scan using item_pkey on item  (cost=0.29..5.71 rows=1 width=170) (actual time=0.003..0.003 rows=0 loops=2713)\n                     Index Cond: (i_item_sk = store_sales.ss_item_sk)\n                     Filter: ((i_manager_id >= 32) AND (i_manager_id <= 36))\n                     Rows Removed by Filter: 1\n                     Buffers: shared hit=5106 read=3033\n Planning:\n   Buffers: shared hit=957 read=95\n Planning Time: 1.694 ms\n Execution Time: 1922.589 ms\n(94 rows)", "explain_rewritten": "QUERY PLAN                                                                                                          \n------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Limit  (cost=117012.23..117012.23 rows=1 width=202) (actual time=1118.969..1119.044 rows=100 loops=1)\n   Buffers: shared hit=8784 read=39336, temp read=2223 written=2232\n   CTE store_sales_revenue\n     ->  Finalize GroupAggregate  (cost=116766.11..116855.61 rows=709 width=40) (actual time=896.177..1044.380 rows=191850 loops=1)\n           Group Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n           Buffers: shared hit=3189 read=36784, temp read=1641 written=1650\n           ->  Gather Merge  (cost=116766.11..116840.85 rows=590 width=40) (actual time=896.170..975.492 rows=219776 loops=1)\n                 Workers Planned: 2\n                 Workers Launched: 2\n                 Buffers: shared hit=3189 read=36784, temp read=1641 written=1650\n                 ->  Partial GroupAggregate  (cost=115766.09..115772.72 rows=295 width=40) (actual time=557.268..598.613 rows=73259 loops=3)\n                       Group Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n                       Buffers: shared hit=3189 read=36784, temp read=1641 written=1650\n                       ->  Sort  (cost=115766.09..115766.82 rows=295 width=14) (actual time=557.261..569.099 rows=179719 loops=3)\n                             Sort Key: store_sales.ss_store_sk, store_sales.ss_item_sk\n                             Sort Method: external merge  Disk: 6160kB\n                             Buffers: shared hit=3189 read=36784, temp read=1641 written=1650\n                             Worker 0:  Sort Method: external merge  Disk: 6968kB\n                             Worker 1:  Sort Method: quicksort  Memory: 25kB\n                             ->  Nested Loop  (cost=0.98..115753.98 rows=295 width=14) (actual time=0.542..516.920 rows=179719 loops=3)\n                                   Buffers: shared hit=3175 read=36784\n                                   ->  Parallel Index Only Scan using _dta_index_date_dim_6_661577395__k7_k4_k9_k1 on date_dim  (cost=0.42..1868.48 rows=157 width=4) (actual time=0.518..0.587 rows=122 loops=3)\n                                         Index Cond: ((d_month_seq >= 1213) AND (d_month_seq <= 1224))\n                                         Heap Fetches: 0\n                                         Buffers: shared hit=2 read=282\n                                   ->  Index Only Scan using _dta_index_store_sales_6_1333579789__k1_k5_k8_k3_11_13_14_20 on store_sales  (cost=0.56..724.72 rows=67 width=18) (actual time=0.008..4.165 rows=1477 loops=365)\n                                         Index Cond: (ss_sold_date_sk = date_dim.d_date_sk)\n                                         Filter: (((ss_sales_price / ss_list_price) >= 0.38) AND ((ss_sales_price / ss_list_price) <= 0.48))\n                                         Rows Removed by Filter: 12258\n                                         Heap Fetches: 0\n                                         Buffers: shared hit=3173 read=36502\n   ->  Sort  (cost=156.62..156.62 rows=1 width=202) (actual time=1118.967..1118.973 rows=100 loops=1)\n         Sort Key: store.s_store_name, item.i_item_desc\n         Sort Method: quicksort  Memory: 60kB\n         Buffers: shared hit=7658 read=19818, temp read=1352 written=1356\n         ->  Nested Loop  (cost=29.86..156.61 rows=1 width=202) (actual time=1095.841..1118.875 rows=116 loops=1)\n               Buffers: shared hit=7655 read=19818, temp read=1352 written=1356\n               ->  Hash Join  (cost=29.56..48.14 rows=19 width=40) (actual time=1095.610..1111.218 rows=2713 loops=1)\n                     Hash Cond: (sc.ss_store_sk = store_sales_revenue.ss_store_sk)\n                     Join Filter: (sc.revenue <= (0.1 * (avg(store_sales_revenue.revenue))))\n                     Rows Removed by Join Filter: 16754\n                     Buffers: shared hit=2063 read=17271, temp read=1352 written=1356\n                     ->  CTE Scan on store_sales_revenue sc  (cost=0.00..14.18 rows=709 width=40) (actual time=896.180..902.895 rows=191850 loops=1)\n                           Buffers: shared hit=2063 read=17266, temp read=1072 written=775\n                     ->  Hash  (cost=29.36..29.36 rows=16 width=44) (actual time=199.410..199.413 rows=4 loops=1)\n                           Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                           Buffers: shared read=5, temp read=280 written=581\n                           ->  Hash Join  (cost=24.33..29.36 rows=16 width=44) (actual time=199.399..199.409 rows=4 loops=1)\n                                 Hash Cond: (store_sales_revenue.ss_store_sk = store.s_store_sk)\n                                 Buffers: shared read=5, temp read=280 written=581\n                                 ->  HashAggregate  (cost=17.73..20.23 rows=200 width=36) (actual time=199.333..199.343 rows=31 loops=1)\n                                       Group Key: store_sales_revenue.ss_store_sk\n                                       Batches: 1  Memory Usage: 48kB\n                                       Buffers: temp read=280 written=581\n                                       ->  CTE Scan on store_sales_revenue  (cost=0.00..14.18 rows=709 width=36) (actual time=0.001..176.791 rows=191850 loops=1)\n                                             Buffers: temp read=280 written=581\n                                 ->  Hash  (cost=6.40..6.40 rows=16 width=8) (actual time=0.047..0.048 rows=16 loops=1)\n                                       Buckets: 1024  Batches: 1  Memory Usage: 9kB\n                                       Buffers: shared read=5\n                                       ->  Seq Scan on store  (cost=0.00..6.40 rows=16 width=8) (actual time=0.021..0.043 rows=16 loops=1)\n                                             Filter: (s_state = ANY ('{TN,TX,VA}'::bpchar[]))\n                                             Rows Removed by Filter: 86\n                                             Buffers: shared read=5\n               ->  Index Scan using item_pkey on item  (cost=0.29..5.71 rows=1 width=170) (actual time=0.003..0.003 rows=0 loops=2713)\n                     Index Cond: (i_item_sk = sc.ss_item_sk)\n                     Filter: ((i_manager_id >= 32) AND (i_manager_id <= 36))\n                     Rows Removed by Filter: 1\n                     Buffers: shared hit=5592 read=2547\n Planning:\n   Buffers: shared hit=936 read=104\n Planning Time: 1.636 ms\n Execution Time: 1121.079 ms\n(72 rows)", "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["DSB Q065_multi"]}
{"id": 26, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.5, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q25"], "regression_mechanism": "Q25: 0.50x — query was 31ms baseline, CTE overhead exceeded filter savings"}
{"id": 27, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.49, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q31"], "regression_mechanism": "Q31: 0.49x — over-decomposed an already-efficient query into too many sub-CTEs"}
{"id": 28, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.23, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_COLUMN_OR_DECOMPOSITION", "queries": ["Q13"], "regression_mechanism": "Q13: 0.23x — nested OR expansion (3×3=9 branches = 9 fact scans). Cartesian OR explosion."}
{"id": 29, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.41, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_COLUMN_OR_DECOMPOSITION", "queries": ["Q48"], "regression_mechanism": "Q48: 0.41x — same nested OR explosion pattern"}
{"id": 30, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.59, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_COLUMN_OR_DECOMPOSITION", "queries": ["Q90"], "regression_mechanism": "Q90: 0.59x — same-column OR (the engine already handles this, see strengths)"}
{"id": 31, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.51, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_COLUMN_OR_DECOMPOSITION", "queries": ["Q23"], "regression_mechanism": "Q23: 0.51x — self-join table split. Each UNION branch had to independently re-do the self-join."}
{"id": 32, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.79, "outcome": "LOSS", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "NON_EQUI_JOIN_INPUT_BLINDNESS", "queries": ["Q013"], "regression_mechanism": "Q013: 0.79x — pre-filtered with UNION/OR superset (loose filter). CTE fence blocked dimension predicate pushdown."}
{"id": 33, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.74, "outcome": "LOSS", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "CTE_MATERIALIZATION_FENCE", "queries": ["Q031"], "regression_mechanism": "Q031: 0.74x — CTE fence blocked predicate pushdown that worked in original"}
{"id": 34, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.77, "outcome": "LOSS", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "CTE_MATERIALIZATION_FENCE", "queries": ["Q038"], "regression_mechanism": "Q038: 0.77x — date_cte_isolate added fence that blocked INTERSECT optimization"}
{"id": 35, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.65, "outcome": "LOSS", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "CTE_MATERIALIZATION_FENCE", "queries": ["Q064"], "regression_mechanism": "Q064: 0.65x — duplicated 18-table CTE body to push filters inside. NEVER do this — computing an 18-table join twice is always worse than computing once and filtering."}
{"id": 36, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.97, "outcome": "DRAW", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q027"], "regression_mechanism": "Q027: 0.97x — won at SF5 (9.62x) but neutral at SF10. Cost model unreliability across scale."}
{"id": 37, "query_sql": null, "rewritten_sql": null, "transform": null, "original_ms": null, "rewritten_ms": null, "ratio": 0.55, "outcome": "LOSS", "query_hash": null, "engine": "postgresql", "engine_version": "14.3+", "scale_factor": "SF10", "explain_original": null, "explain_rewritten": null, "gap": "CROSS_CTE_PREDICATE_BLINDNESS", "queries": ["Q031"], "regression_mechanism": "Q031: 0.55x — over-decomposed an already-efficient query"}
{"id": 38, "query_sql": "-- start query 16 in stream 0 using template query16.tpl\nselect \n   count(distinct cs_order_number) as \"order count\"\n  ,sum(cs_ext_ship_cost) as \"total shipping cost\"\n  ,sum(cs_net_profit) as \"total net profit\"\nfrom\n   catalog_sales cs1\n  ,date_dim\n  ,customer_address\n  ,call_center\nwhere\n    d_date between '2002-4-01' and \n           (cast('2002-4-01' as date) + INTERVAL 60 DAY)\nand cs1.cs_ship_date_sk = d_date_sk\nand cs1.cs_ship_addr_sk = ca_address_sk\nand ca_state = 'WV'\nand cs1.cs_call_center_sk = cc_call_center_sk\nand cc_county in ('Ziebach County','Luce County','Richland County','Daviess County',\n                  'Barrow County'\n)\nand exists (select *\n            from catalog_sales cs2\n            where cs1.cs_order_number = cs2.cs_order_number\n              and cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)\nand not exists(select *\n               from catalog_returns cr1\n               where cs1.cs_order_number = cr1.cr_order_number)\norder by count(distinct cs_order_number)\n LIMIT 100;\n\n-- end query 16 in stream 0 using template query16.tpl", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + INTERVAL '60' DAY)), filtered_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_state = 'WV'), filtered_call_center AS (SELECT cc_call_center_sk FROM call_center WHERE cc_county IN ('Ziebach County', 'Luce County', 'Richland County', 'Daviess County', 'Barrow County')), multi_warehouse_orders AS (SELECT DISTINCT cs_order_number FROM catalog_sales GROUP BY cs_order_number HAVING MIN(cs_warehouse_sk) <> MAX(cs_warehouse_sk)), returned_orders AS (SELECT DISTINCT cr_order_number FROM catalog_returns), filtered_sales AS (SELECT cs_order_number, cs_ext_ship_cost, cs_net_profit FROM catalog_sales AS cs1 JOIN filtered_dates ON cs1.cs_ship_date_sk = filtered_dates.d_date_sk JOIN filtered_address ON cs1.cs_ship_addr_sk = filtered_address.ca_address_sk JOIN filtered_call_center ON cs1.cs_call_center_sk = filtered_call_center.cc_call_center_sk)\nSELECT COUNT(DISTINCT fs.cs_order_number) AS \"order count\", SUM(fs.cs_ext_ship_cost) AS \"total shipping cost\", SUM(fs.cs_net_profit) AS \"total net profit\" FROM filtered_sales AS fs JOIN multi_warehouse_orders AS mwo ON fs.cs_order_number = mwo.cs_order_number LEFT JOIN returned_orders AS ro ON fs.cs_order_number = ro.cr_order_number WHERE ro.cr_order_number IS NULL ORDER BY COUNT(DISTINCT fs.cs_order_number) LIMIT 100", "transform": "semantic_rewrite", "original_ms": null, "rewritten_ms": null, "ratio": 0.14, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["q16"], "regression_mechanism": "Materialized a GROUP BY self-join (HAVING MIN() <> MAX()) on the entire fact table BEFORE applying date/address/call_center filters. The original query filters catalog_sales first via correlated EXISTS clauses, then checks warehouse conditions. Pre-materializing the unfiltered self-join creates a massive intermediate result the optimizer cannot cost-estimate correctly."}
{"id": 39, "query_sql": "-- start query 95 in stream 0 using template query95.tpl\nwith ws_wh as\n(select ws1.ws_order_number,ws1.ws_warehouse_sk wh1,ws2.ws_warehouse_sk wh2\n from web_sales ws1,web_sales ws2\n where ws1.ws_order_number = ws2.ws_order_number\n   and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '1999-2-01' and \n           (cast('1999-2-01' as date) + INTERVAL 60 DAY)\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state = 'NC'\nand ws1.ws_web_site_sk = web_site_sk\nand web_company_name = 'pri'\nand ws1.ws_order_number in (select ws_order_number\n                            from ws_wh)\nand ws1.ws_order_number in (select wr_order_number\n                            from web_returns,ws_wh\n                            where wr_order_number = ws_wh.ws_order_number)\norder by count(distinct ws_order_number)\n LIMIT 100;\n\n-- end query 95 in stream 0 using template query95.tpl", "rewritten_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY)), ws_wh AS (SELECT ws1.ws_order_number, ws1.ws_warehouse_sk AS wh1, ws2.ws_warehouse_sk AS wh2 FROM web_sales AS ws1, web_sales AS ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk), multi_warehouse_orders AS (SELECT DISTINCT ws_order_number FROM ws_wh), returned_multi_warehouse_orders AS (SELECT DISTINCT wr_order_number FROM web_returns AS wr JOIN ws_wh ON wr.wr_order_number = ws_wh.ws_order_number)\nSELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales AS ws1 JOIN filtered_dates AS fd ON ws1.ws_ship_date_sk = fd.d_date_sk JOIN customer_address AS ca ON ws1.ws_ship_addr_sk = ca.ca_address_sk JOIN web_site AS ws ON ws1.ws_web_site_sk = ws.web_site_sk JOIN multi_warehouse_orders AS mwo ON ws1.ws_order_number = mwo.ws_order_number JOIN returned_multi_warehouse_orders AS rmwo ON ws1.ws_order_number = rmwo.wr_order_number WHERE ca.ca_state = 'NC' AND ws.web_company_name = 'pri' ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100", "transform": "semantic_rewrite", "original_ms": null, "rewritten_ms": null, "ratio": 0.54, "outcome": "LOSS", "query_hash": null, "engine": "duckdb", "engine_version": "1.1+", "scale_factor": "SF1", "explain_original": null, "explain_rewritten": null, "gap": null, "queries": ["q95"], "regression_mechanism": "Materialized complex correlated EXISTS/NOT EXISTS logic into independent CTEs (multi_warehouse_orders, returned_multi_warehouse_orders). The original EXISTS clauses were tightly correlated and evaluated together. Decoupling them into CTEs severed their cardinality relationship, causing 4x+ join estimate errors."}
