# Plan A â€” Latest-date parameterisation (H1)
#
# Consolidates repeated (SELECT MAX(calendar_date) FROM X) scalar subqueries
# into a single v_latest_dates view, then replaces each occurrence.

plan_id: latest_date_parametrise_v1
dialect: duckdb
description: >
  Replace per-statement scalar MAX(calendar_date) subqueries with references
  to a single v_latest_dates view.  Removes repeated scans, improves plan
  stability, and simplifies downstream rewrites.

preconditions:
  - kind: parse_ok

steps:
  - step_id: A1_insert_latest_dates_view
    op: insert_view_statement
    description: Create v_latest_dates view with one column per source table
    target:
      by_label: "latest_date_filter.household_profile_canvas"
    payload:
      sql_fragment: |
        CREATE OR REPLACE TEMPORARY VIEW v_latest_dates AS
        SELECT
          (SELECT MAX(calendar_date) FROM household_profile_canvas) AS hp_max_date,
          (SELECT MAX(calendar_date) FROM broadband_service_daily)  AS bsd_max_date,
          (SELECT MAX(calendar_date) FROM mobile_service_daily)     AS msd_max_date,
          (SELECT MAX(calendar_date) FROM prepaid_service_daily)    AS psd_max_date,
          (SELECT MAX(calendar_date) FROM account_daily)            AS ad_max_date;
    gates:
      - kind: parse_ok

  - step_id: A2_replace_hp_max
    op: replace_expr_subtree
    description: Replace household_profile_canvas max-date with view ref
    target:
      by_label: "latest_date_filter.household_profile_canvas"
    payload:
      expr_sql: "calendar_date = (SELECT hp_max_date FROM v_latest_dates)"
    gates:
      - kind: parse_ok

  - step_id: A3_replace_bsd_max
    op: replace_expr_subtree
    description: Replace broadband_service_daily max-date with view ref
    target:
      by_label: "latest_date_filter.broadband_service_daily"
    payload:
      expr_sql: "calendar_date = (SELECT bsd_max_date FROM v_latest_dates)"
    gates:
      - kind: parse_ok

  - step_id: A4_replace_msd_max
    op: replace_expr_subtree
    description: Replace mobile_service_daily max-date with view ref
    target:
      by_label: "latest_date_filter.mobile_service_daily"
    payload:
      expr_sql: "calendar_date = (SELECT msd_max_date FROM v_latest_dates)"
    gates:
      - kind: parse_ok

  - step_id: A5_replace_psd_max
    op: replace_expr_subtree
    description: Replace prepaid_service_daily max-date with view ref
    target:
      by_label: "latest_date_filter.prepaid_service_daily"
    payload:
      expr_sql: "calendar_date = (SELECT psd_max_date FROM v_latest_dates)"
    gates:
      - kind: parse_ok

  - step_id: A6_replace_ad_max
    op: replace_expr_subtree
    description: Replace account_daily max-date with view ref
    target:
      by_label: "latest_date_filter.account_daily"
    payload:
      expr_sql: "calendar_date = (SELECT ad_max_date FROM v_latest_dates)"
    gates:
      - kind: parse_ok

postconditions:
  - kind: plan_shape
    args:
      expectation: "no_scalar_subquery_max_calendar_date_remaining"
