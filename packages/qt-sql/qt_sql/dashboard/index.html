<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="refresh" content="10">
<title>QueryTorque Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fff; --bg2: #f8fafc; --bg3: #f1f5f9;
  --brd: #e2e8f0; --brd2: #cbd5e1;
  --t1: #0f172a; --t2: #475569; --t3: #94a3b8;
  --grn: #16a34a; --grn2: #dcfce7; --grn3: #f0fdf4;
  --red: #dc2626; --red2: #fef2f2;
  --amb: #d97706; --amb2: #fffbeb;
  --blu: #2563eb; --blu2: #eff6ff;
  --prp: #7c3aed; --prp2: #f5f3ff;
  --mono: 'DM Mono', 'JetBrains Mono', 'Fira Code', Consolas, monospace;
  --sans: 'DM Sans', -apple-system, system-ui, sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--sans); background: var(--bg2); color: var(--t1);
  line-height: 1.6; -webkit-font-smoothing: antialiased;
}
::selection { background: #dbeafe; }

/* ——— Header ——— */
.header {
  background: var(--bg); border-bottom: 1px solid var(--brd);
  padding: 24px 40px 20px; display: flex; align-items: baseline; gap: 24px; flex-wrap: wrap;
}
.header h1 { font-size: 28px; font-weight: 700; letter-spacing: -.03em; color: var(--t1); }
.header .meta { display: flex; gap: 16px; font-size: 13px; font-family: var(--mono); color: var(--t3); }

/* ——— Summary cards ——— */
.summary { display: flex; gap: 12px; padding: 20px 40px 0; flex-wrap: wrap; }
.stat {
  background: var(--bg); border: 1px solid var(--brd); border-radius: 10px;
  padding: 16px 22px; min-width: 120px; transition: border-color .2s, box-shadow .2s;
}
.stat:hover { border-color: var(--brd2); box-shadow: 0 1px 6px rgba(0,0,0,.025); }
.stat .label {
  font-size: 11px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .1em; text-transform: uppercase; display: block;
}
.stat .value { font-size: 28px; font-weight: 700; margin-top: 4px; display: block; }
.stat.win .value { color: var(--grn); }
.stat.improved .value { color: var(--blu); }
.stat.neutral .value { color: var(--t3); }
.stat.regression .value { color: var(--red); }
.stat.error .value { color: var(--amb); }
.stat.running .value { color: var(--blu); }

/* ——— Filters ——— */
.filters {
  padding: 16px 40px; display: flex; gap: 10px;
  flex-wrap: wrap; align-items: center;
}
.filters label {
  font-size: 13px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .04em; text-transform: uppercase;
}
.filters select, .filters input {
  font-family: var(--sans); font-size: 14px; color: var(--t1);
  background: var(--bg); border: 1px solid var(--brd); border-radius: 6px;
  padding: 6px 12px; outline: none; transition: border-color .15s;
}
.filters select:focus, .filters input:focus {
  border-color: var(--brd2); box-shadow: 0 0 0 3px rgba(148,163,184,.06);
}
.filters input::placeholder { color: var(--t3); }

/* ——— Query cards ——— */
.cards { padding: 0 40px 40px; display: flex; flex-direction: column; gap: 6px; }
.card {
  background: var(--bg); border: 1px solid var(--brd); border-radius: 10px;
  overflow: hidden; transition: border-color .2s, box-shadow .2s;
}
.card:hover { border-color: var(--brd2); box-shadow: 0 1px 6px rgba(0,0,0,.025); }
.card-header {
  display: flex; align-items: center; padding: 12px 18px;
  cursor: pointer; gap: 14px; user-select: none;
}
.card-header .expand-icon {
  color: var(--t3); font-size: 10px; transition: transform 0.2s; width: 14px;
}
.card.open .card-header .expand-icon { transform: rotate(90deg); }
.card-header .qid { font-weight: 600; color: var(--t1); font-size: 15px; min-width: 180px; }
.card-header .qid span { font-family: var(--mono); font-size: 14px; }

/* ——— Badges ——— */
.badge {
  padding: 2px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .06em;
}
.badge.win { background: var(--grn2); color: var(--grn); }
.badge.improved { background: var(--blu2); color: var(--blu); }
.badge.neutral { background: var(--bg3); color: var(--t3); }
.badge.regression { background: var(--red2); color: var(--red); }
.badge.error { background: var(--amb2); color: var(--amb); }
.badge.in_progress, .badge.running { background: var(--blu2); color: var(--blu); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

/* ——— Speedup value ——— */
.speedup {
  font-weight: 700; font-size: 15px; min-width: 60px; text-align: right;
  font-variant-numeric: tabular-nums; font-family: var(--mono);
}
.speedup.fast { color: var(--grn); }
.speedup.slow { color: var(--red); }
.speedup.meh { color: var(--t3); }

.card-header .detail { font-size: 13px; color: var(--t3); font-family: var(--mono); }
.card-header .strategy { color: var(--prp); font-size: 13px; font-family: var(--mono); font-weight: 500; }
.card-header .timing { margin-left: auto; font-size: 13px; color: var(--t3); font-family: var(--mono); }

/* ——— Expanded panel ——— */
.card-body { display: none; border-top: 1px solid var(--brd); padding: 20px; background: var(--bg); }
.card.open .card-body { display: block; }

/* ——— Pipeline timeline ——— */
.timeline { display: flex; flex-direction: column; gap: 6px; margin-bottom: 20px; }
.stage { display: flex; align-items: center; gap: 8px; }
.stage-label {
  font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: .08em;
  color: var(--t3); min-width: 80px; text-align: right; font-family: var(--mono);
}
.stage-bar-wrap { flex: 1; position: relative; height: 24px; background: var(--bg3); border-radius: 6px; }
.stage-bar {
  height: 100%; border-radius: 6px; display: flex; align-items: center;
  padding: 0 10px; font-size: 11px; font-weight: 600; font-family: var(--mono);
  color: #fff; min-width: 40px; position: relative;
}
.stage-bar.parse { background: #06b6d4; }
.stage-bar.data { background: #8b5cf6; opacity: 0.6; }
.stage-bar.analyst { background: #8b5cf6; }
.stage-bar.generate { background: var(--blu); }
.stage-bar.validate { background: #ea580c; }
.stage-bar.explain { background: #06b6d4; opacity: 0.75; }
.stage-bar.retry { background: var(--amb); }
.stage-dur { font-size: 12px; color: var(--t2); margin-left: 6px; min-width: 50px; font-family: var(--mono); }

/* Parallel workers sub-bars */
.parallel-group { display: flex; flex-direction: column; gap: 3px; padding-left: 88px; }
.parallel-group .stage-bar-wrap { height: 18px; }
.parallel-group .stage-bar { height: 18px; font-size: 10px; }
.parallel-group .stage-label { font-size: 10px; min-width: 80px; }
.parallel-group .stage-dur { font-size: 11px; }

/* ——— Worker results table ——— */
.results-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 14px; }
.results-table th {
  background: var(--bg2); color: var(--t3); text-align: left; padding: 8px 12px;
  font-size: 11px; font-family: var(--mono); letter-spacing: .08em;
  text-transform: uppercase; border-bottom: 2px solid var(--brd);
}
.results-table td { padding: 8px 12px; border-bottom: 1px solid var(--brd); vertical-align: top; }
.results-table tbody tr { cursor: pointer; transition: background .1s; }
.results-table tbody tr:hover { background: var(--bg2); }
.results-table tr.best-row { background: var(--grn3); }
.results-table .transforms { font-size: 12px; color: var(--prp); }
.results-table .examples { font-size: 12px; color: var(--t3); }

/* ——— Worker detail (expanded) ——— */
.worker-detail {
  display: none; background: var(--bg2); border: 1px solid var(--brd); border-radius: 8px;
  margin: 6px 0 10px 0; padding: 16px;
}
.worker-detail.open { display: block; }
.worker-detail h4 {
  font-size: 11px; color: var(--t3); margin-bottom: 8px; text-transform: uppercase;
  letter-spacing: .08em; font-family: var(--mono);
}
.worker-detail pre {
  background: #1e1e2e; padding: 16px; border-radius: 8px; overflow-x: auto;
  font-size: 13px; line-height: 1.5; color: #cdd6f4; font-family: var(--mono);
  max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;
}
.worker-detail .error-msg {
  background: var(--red2); border-left: 3px solid var(--red);
  padding: 10px 14px; font-size: 13px; color: var(--red); margin-bottom: 10px;
  border-radius: 0 6px 6px 0;
}
.worker-detail .hint-text { font-size: 13px; color: var(--t2); margin-bottom: 10px; font-style: italic; }

/* ——— Tags ——— */
.tag {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 11px; font-family: var(--mono); margin: 1px 2px;
}
.tag.transform { background: var(--prp2); color: var(--prp); }
.tag.example { background: var(--bg3); color: var(--t3); }

/* ——— Race badge ——— */
.race-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; font-family: var(--mono); }
.race-badge.race { background: var(--blu2); color: var(--blu); }
.race-badge.sequential { background: var(--bg3); color: var(--t3); }

/* ——— Session footer ——— */
.session-footer {
  display: flex; gap: 20px; margin-top: 16px; padding-top: 12px;
  border-top: 1px solid var(--brd); font-size: 13px; color: var(--t3); font-family: var(--mono);
}

/* ——— Empty state ——— */
.empty { text-align: center; padding: 80px 40px; color: var(--t3); }
.empty h2 { font-size: 20px; color: var(--t2); margin-bottom: 8px; }

/* ——— Responsive ——— */
@media (max-width: 768px) {
  .header, .summary, .filters, .cards { padding-left: 20px; padding-right: 20px; }
  .header h1 { font-size: 22px; }
  .card-header { padding: 10px 12px; gap: 8px; }
  .card-header .qid { min-width: 120px; font-size: 13px; }
  .stat { min-width: 100px; padding: 12px 14px; }
  .stat .value { font-size: 22px; }
}
</style>
</head>
<body>

<div class="header">
  <h1 id="title">QueryTorque Dashboard</h1>
  <div class="meta">
    <span id="meta-engine"></span>
    <span id="meta-queries"></span>
    <span id="meta-latest"></span>
  </div>
</div>

<div class="summary" id="summary"></div>

<div class="filters">
  <label>Sort</label>
  <select id="sort-select">
    <option value="qid">Query ID</option>
    <option value="speedup-desc">Speedup (high first)</option>
    <option value="speedup-asc">Speedup (low first)</option>
    <option value="status">Status</option>
    <option value="duration">Duration</option>
  </select>
  <label>Status</label>
  <select id="filter-select">
    <option value="all">All</option>
    <option value="running">RUNNING</option>
    <option value="win">WIN</option>
    <option value="improved">IMPROVED</option>
    <option value="neutral">NEUTRAL</option>
    <option value="regression">REGRESSION</option>
    <option value="error">ERROR</option>
  </select>
  <label>Search</label>
  <input type="text" id="search-input" placeholder="query id, strategy..." size="24">
</div>

<div class="cards" id="cards"></div>

<script>
const DATA = __DASHBOARD_DATA__;

function fmtDuration(s) {
  if (s == null) return '?';
  if (s < 1) return (s * 1000).toFixed(0) + 'ms';
  if (s < 60) return s.toFixed(1) + 's';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return m + 'm' + (sec < 10 ? '0' : '') + sec + 's';
}

function fmtSpeedup(v) {
  if (!v || v === 0) return '\u2014';
  return v.toFixed(2) + 'x';
}

function speedupClass(v) {
  if (!v || v === 0) return 'meh';
  if (v >= 1.05) return 'fast';
  if (v < 0.95) return 'slow';
  return 'meh';
}

function statusClass(s) {
  if (!s) return 'neutral';
  return s.toLowerCase().replace(' ', '');
}

function effectiveStatus(session) {
  if (session.in_progress) return 'RUNNING';
  const sp = session.best_speedup || 0;
  if (sp === 0) {
    const allErr = (session.workers || []).every(w => w.status === 'ERROR');
    if (allErr && (session.workers || []).length > 0) return 'ERROR';
    return 'NEUTRAL';
  }
  if (sp >= 1.5) return 'WIN';
  if (sp >= 1.05) return 'IMPROVED';
  if (sp >= 0.95) return 'NEUTRAL';
  return 'REGRESSION';
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function renderHeader() {
  const d = DATA;
  document.getElementById('title').textContent = 'QueryTorque \u2014 ' + (d.benchmark_name || 'Dashboard');
  document.getElementById('meta-engine').textContent = (d.engine || '').toUpperCase();
  document.getElementById('meta-queries').textContent = (d.sessions || []).length + ' queries';
  document.getElementById('meta-latest').textContent = d.latest_run || '';

  const counts = { running: 0, win: 0, improved: 0, neutral: 0, regression: 0, error: 0 };
  (d.sessions || []).forEach(s => {
    const st = effectiveStatus(s).toLowerCase();
    if (counts[st] !== undefined) counts[st]++;
  });
  const bar = document.getElementById('summary');
  bar.innerHTML = '';
  const labels = { running: 'Running', win: 'Wins', improved: 'Improved', neutral: 'Neutral', regression: 'Regression', error: 'Error' };
  for (const [k, v] of Object.entries(counts)) {
    const div = document.createElement('div');
    div.className = 'stat ' + k;
    div.innerHTML = `<span class="label">${labels[k]}</span><span class="value">${v}</span>`;
    bar.appendChild(div);
  }
}

function stageBarHtml(label, cssClass, durationS, maxDuration) {
  const pct = maxDuration > 0 ? Math.max(3, (durationS / maxDuration) * 100) : 50;
  return `<div class="stage">
    <span class="stage-label">${label}</span>
    <div class="stage-bar-wrap">
      <div class="stage-bar ${cssClass}" style="width:${pct}%">${fmtDuration(durationS)}</div>
    </div>
    <span class="stage-dur">${fmtDuration(durationS)}</span>
  </div>`;
}

function renderTimeline(session) {
  const tl = session.timeline || [];
  if (tl.length === 0) return '<div style="color:var(--t3);font-size:13px;padding:8px 0;">No timeline data (log not found)</div>';

  const maxDur = Math.max(...tl.map(e => e.duration_s || 0), 1);

  let html = '<div class="timeline">';
  for (const ev of tl) {
    const cls = (ev.event || '').toLowerCase().replace(/[^a-z]/g, '');
    let cssClass = 'parse';
    if (cls.includes('data')) cssClass = 'data';
    else if (cls.includes('analyst')) cssClass = 'analyst';
    else if (cls.includes('generate')) cssClass = 'generate';
    else if (cls.includes('validat')) cssClass = 'validate';
    else if (cls.includes('explain')) cssClass = 'explain';
    else if (cls.includes('retry') || cls.includes('snipe')) cssClass = 'retry';

    const detail = ev.details || '';
    html += stageBarHtml(ev.event || '?', cssClass, ev.duration_s || 0, maxDur);
    if (detail) {
      html += `<div style="padding-left:88px;font-size:12px;color:var(--t3);margin-top:-3px;margin-bottom:3px;font-family:var(--mono)">${escapeHtml(detail)}</div>`;
    }

    if (cls.includes('generate') && ev.workers) {
      html += '<div class="parallel-group">';
      for (const w of ev.workers) {
        const wPct = maxDur > 0 ? Math.max(3, ((w.duration_s || 0) / maxDur) * 100) : 20;
        html += `<div class="stage">
          <span class="stage-label">W${w.worker_id}</span>
          <div class="stage-bar-wrap">
            <div class="stage-bar generate" style="width:${wPct}%">${escapeHtml(w.strategy || '?')}</div>
          </div>
          <span class="stage-dur">${fmtDuration(w.duration_s)}</span>
        </div>`;
      }
      html += '</div>';
    }
  }
  html += '</div>';
  return html;
}

function renderWorkerTable(session) {
  const workers = session.workers || [];
  if (workers.length === 0) return '';

  let html = `<table class="results-table">
    <thead><tr>
      <th>Worker</th><th>Strategy</th><th>Speedup</th><th>Status</th>
      <th>Transforms</th><th>Examples</th>
    </tr></thead><tbody>`;

  for (const w of workers) {
    const isBest = w.worker_id === session.best_worker_id;
    const rowClass = isBest ? 'best-row' : '';
    const sp = w.speedup || 0;
    const transforms = (w.transforms || []).map(t => `<span class="tag transform">${escapeHtml(t)}</span>`).join('');
    const examples = (w.examples_used || []).map(e => `<span class="tag example">${escapeHtml(e)}</span>`).join('');

    html += `<tr class="${rowClass}" data-wid="${w.worker_id}" onclick="toggleWorkerDetail(this)">
      <td style="font-weight:600">W${w.worker_id}${isBest ? ' \u2605' : ''}${w.exploratory ? ' <span style="color:var(--amb);font-size:10px;font-weight:700">EXPLORE</span>' : ''}</td>
      <td style="font-family:var(--mono);font-size:13px;color:var(--prp)">${escapeHtml(w.strategy || '?')}</td>
      <td class="speedup ${speedupClass(sp)}">${fmtSpeedup(sp)}</td>
      <td><span class="badge ${statusClass(w.status)}">${w.status || '?'}</span></td>
      <td class="transforms">${transforms || '<span style="color:var(--t3)">\u2014</span>'}</td>
      <td class="examples">${examples || '<span style="color:var(--t3)">\u2014</span>'}</td>
    </tr>
    <tr><td colspan="6" style="padding:0;border:none">
      <div class="worker-detail" id="wd-${session.query_id}-${w.worker_id}">
        ${w.error_message ? `<div class="error-msg">${escapeHtml(w.error_message)}</div>` : ''}
        ${w.hint ? `<div class="hint-text">${escapeHtml(w.hint)}</div>` : ''}
        <h4>Optimized SQL</h4>
        <pre>${escapeHtml(w.optimized_sql || 'No SQL available')}</pre>
      </div>
    </td></tr>`;
  }

  html += '</tbody></table>';
  return html;
}

function toggleWorkerDetail(row) {
  const wid = row.getAttribute('data-wid');
  const card = row.closest('.card');
  const qid = card.getAttribute('data-qid');
  const detail = document.getElementById('wd-' + qid + '-' + wid);
  if (detail) detail.classList.toggle('open');
}

function renderCard(session) {
  const status = effectiveStatus(session);
  const sp = session.best_speedup || 0;
  const strategy = session.best_strategy || '';
  const totalTime = session.total_duration_s;

  const valMode = session.validation_mode || '';
  const raceBadge = valMode ? `<span class="race-badge ${valMode}">${valMode}</span>` : '';
  const baselineMs = session.baseline_ms;
  const baselineStr = baselineMs ? `baseline: ${baselineMs.toFixed(0)}ms` : '';

  const card = document.createElement('div');
  card.className = 'card';
  card.setAttribute('data-qid', session.query_id);
  card.setAttribute('data-status', status.toLowerCase());
  card.setAttribute('data-speedup', sp);
  card.setAttribute('data-duration', totalTime || 0);

  card.innerHTML = `
    <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
      <span class="expand-icon">\u25B6</span>
      <span class="qid"><span>${escapeHtml(session.query_id)}</span></span>
      <span class="badge ${statusClass(status)}">${status}</span>
      <span class="speedup ${speedupClass(sp)}">${sp > 0 ? fmtSpeedup(sp) : '\u2014'}</span>
      <span class="strategy">${escapeHtml(strategy)}</span>
      ${raceBadge}
      <span class="detail">${baselineStr}</span>
      <span class="timing">${totalTime ? fmtDuration(totalTime) : ''} \u00b7 ${session.n_iterations || 0} iter \u00b7 ${session.n_api_calls || 0} calls</span>
    </div>
    <div class="card-body">
      ${renderTimeline(session)}
      ${renderWorkerTable(session)}
      <div class="session-footer">
        <span>Total: ${totalTime ? fmtDuration(totalTime) : '?'}</span>
        <span>Iterations: ${session.n_iterations || 0}</span>
        <span>API calls: ${session.n_api_calls || 0}</span>
        <span>Workers: ${session.total_workers || 0}</span>
        <span>Target: ${session.target_speedup ? session.target_speedup.toFixed(1) + 'x' : '?'}</span>
      </div>
    </div>`;

  return card;
}

function renderAll() {
  renderHeader();

  const container = document.getElementById('cards');
  container.innerHTML = '';

  let sessions = [...(DATA.sessions || [])];
  if (sessions.length === 0) {
    container.innerHTML = '<div class="empty"><h2>No sessions found</h2><p>Run some swarm sessions first.</p></div>';
    return;
  }

  const filter = document.getElementById('filter-select').value;
  if (filter !== 'all') {
    sessions = sessions.filter(s => effectiveStatus(s).toLowerCase() === filter);
  }

  const search = document.getElementById('search-input').value.toLowerCase();
  if (search) {
    sessions = sessions.filter(s =>
      (s.query_id || '').toLowerCase().includes(search) ||
      (s.best_strategy || '').toLowerCase().includes(search)
    );
  }

  const sort = document.getElementById('sort-select').value;
  const statusOrder = { 'WIN': 0, 'IMPROVED': 1, 'NEUTRAL': 2, 'REGRESSION': 3, 'ERROR': 4 };
  sessions.sort((a, b) => {
    switch (sort) {
      case 'speedup-desc': return (b.best_speedup || 0) - (a.best_speedup || 0);
      case 'speedup-asc': return (a.best_speedup || 0) - (b.best_speedup || 0);
      case 'status':
        return (statusOrder[effectiveStatus(a)] || 9) - (statusOrder[effectiveStatus(b)] || 9);
      case 'duration':
        return (b.total_duration_s || 0) - (a.total_duration_s || 0);
      default: return (a.query_id || '').localeCompare(b.query_id || '');
    }
  });

  for (const s of sessions) {
    container.appendChild(renderCard(s));
  }
}

document.getElementById('sort-select').addEventListener('change', renderAll);
document.getElementById('filter-select').addEventListener('change', renderAll);
document.getElementById('search-input').addEventListener('input', renderAll);

renderAll();
</script>
</body>
</html>
