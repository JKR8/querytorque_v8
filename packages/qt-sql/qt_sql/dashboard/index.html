<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="refresh" content="10">
<title>QueryTorque Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* === QueryTorque / Dialect Labs Design System === */
:root {
  --bg: #ffffff;
  --bg-elevated: #f8fafc;
  --bg-subtle: #f1f5f9;
  --border: #e2e8f0;
  --border-subtle: #e2e8f0;
  --t1: #0f172a;
  --t2: #64748b;
  --t3: #94a3b8;
  --green: #059669;
  --green-dim: #065f46;
  --green-bg: #ecfdf5;
  --blue: #2563eb;
  --blue-dim: #1e40af;
  --blue-bg: #eff6ff;
  --amber: #f59e0b;
  --amber-bg: #fffbeb;
  --red: #ef4444;
  --red-bg: #fef2f2;
  --purple: #7c3aed;
  --purple-bg: #f5f3ff;
  --teal: #0d9488;
  --teal-bg: #f0fdfa;
  --mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
  --sans: 'Inter', -apple-system, system-ui, sans-serif;
  --radius: 6px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--sans); background: var(--bg); color: var(--t1);
  line-height: 1.6; -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
::selection { background: #c7d2fe; color: #0f172a; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f8fafc; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* --- Header --- */
.header {
  background: var(--bg); border-bottom: 1px solid var(--border);
  padding: 24px 40px 20px; display: flex; align-items: baseline; gap: 24px; flex-wrap: wrap;
}
.header h1 {
  font-size: 24px; font-weight: 700; letter-spacing: -.03em; color: var(--t1);
}
.header .meta {
  display: flex; gap: 16px; font-size: 13px; font-family: var(--mono); color: var(--t3);
}

/* --- Tab bar --- */
.tab-bar {
  display: flex; gap: 0; padding: 0 40px; background: var(--bg);
  border-bottom: 1px solid var(--border);
}
.tab {
  padding: 10px 20px; font-size: 14px; font-weight: 600; color: var(--t3);
  cursor: pointer; border-bottom: 2px solid transparent; transition: all .2s;
  user-select: none;
}
.tab:hover { color: var(--t2); }
.tab.active { color: var(--t1); border-bottom-color: var(--t1); }

/* --- Section container --- */
.section { padding: 24px 40px; }
.section-title {
  font-size: 11px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .1em; text-transform: uppercase; margin-bottom: 12px; font-weight: 500;
}

/* --- Stat cards --- */
.stat-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; }
.stat-card {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px 20px; min-width: 130px; flex: 1; transition: border-color .2s;
}
.stat-card:hover { border-color: #cbd5e1; }
.stat-card .label {
  font-size: 11px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .08em; text-transform: uppercase; display: block;
}
.stat-card .value {
  font-size: 28px; font-weight: 700; margin-top: 2px; display: block;
  font-variant-numeric: tabular-nums;
}
.stat-card .sub { font-size: 12px; color: var(--t3); font-family: var(--mono); margin-top: 2px; }
.stat-card.green .value { color: var(--green); }
.stat-card.green-accent { border-top: 2px solid var(--green); }
.stat-card.blue .value { color: var(--blue); }
.stat-card.amber .value { color: var(--amber); }
.stat-card.red .value { color: var(--red); }
.stat-card.muted .value { color: var(--t3); }

/* --- Panel cards --- */
.panel {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px;
  padding: 20px 24px; margin-bottom: 16px;
}
.panel-title {
  font-size: 14px; font-weight: 600; color: var(--t1); margin-bottom: 12px;
}

/* --- Pareto bar --- */
.pareto-bar {
  display: flex; height: 32px; border-radius: var(--radius); overflow: hidden;
  background: var(--bg-subtle); margin-bottom: 12px;
}
.pareto-segment {
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; font-family: var(--mono); font-weight: 500; color: #fff;
  transition: opacity .15s; cursor: default; min-width: 2px;
}
.pareto-segment:hover { opacity: .85; }
.pareto-legend {
  font-size: 13px; color: var(--t2); font-family: var(--mono); margin-top: 6px;
}

/* --- Tables --- */
.data-table {
  width: 100%; border-collapse: collapse; font-size: 13px;
}
.data-table th {
  background: var(--bg-subtle); color: var(--t3); text-align: left; padding: 8px 12px;
  font-size: 11px; font-family: var(--mono); letter-spacing: .08em;
  text-transform: uppercase; border-bottom: 1px solid var(--border);
  cursor: pointer; user-select: none; white-space: nowrap;
}
.data-table th:hover { color: var(--t1); }
.data-table td {
  padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: middle;
}
.data-table tbody tr { transition: background .1s; cursor: pointer; }
.data-table tbody tr:hover { background: var(--bg-elevated); }
.data-table tbody tr.expanded { background: var(--bg-subtle); }

/* --- Sortable headers --- */
.sort-arrow { margin-left: 4px; font-size: 9px; }

/* --- Badges --- */
.badge {
  padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .04em; display: inline-block;
}
.badge.win { background: var(--green-bg); color: var(--green); }
.badge.improved { background: var(--blue-bg); color: var(--blue); }
.badge.neutral { background: var(--bg-subtle); color: var(--t3); }
.badge.regression { background: var(--red-bg); color: var(--red); }
.badge.error { background: var(--amber-bg); color: var(--amber); }
.badge.pending { background: var(--bg-subtle); color: var(--t3); }
.badge.in_progress, .badge.running { background: var(--blue-bg); color: var(--blue); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

/* --- Bucket badges --- */
.bucket-badge {
  padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .04em; display: inline-block;
}
.bucket-badge.high { background: var(--red-bg); color: var(--red); }
.bucket-badge.medium { background: var(--amber-bg); color: var(--amber); }
.bucket-badge.low { background: var(--bg-subtle); color: var(--t3); }
.bucket-badge.skip { background: var(--bg-subtle); color: var(--t3); opacity: 0.6; }

/* --- Tags --- */
.tag {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 11px; font-family: var(--mono); margin: 1px 2px;
}
.tag.transform { background: var(--purple-bg); color: var(--purple); }
.tag.gap { background: var(--amber-bg); color: var(--amber); }
.tag.family-a { background: var(--blue-bg); color: var(--blue); }
.tag.family-b { background: var(--green-bg); color: var(--green); }
.tag.family-c { background: var(--amber-bg); color: var(--amber); }
.tag.family-d { background: var(--purple-bg); color: var(--purple); }
.tag.family-e { background: var(--teal-bg); color: var(--teal); }
.tag.family-f { background: var(--red-bg); color: var(--red); }

/* --- Speedup value --- */
.speedup {
  font-weight: 700; font-size: 13px; text-align: right;
  font-variant-numeric: tabular-nums; font-family: var(--mono);
}
.speedup.fast { color: var(--green); }
.speedup.slow { color: var(--red); }
.speedup.meh { color: var(--t3); }

/* --- Tractability --- */
.tract-bar { display: inline-flex; align-items: center; gap: 4px; font-family: var(--mono); }
.tract-dots { display: inline-flex; gap: 2px; }
.tract-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: var(--border); display: inline-block;
}
.tract-dot.filled { background: var(--green); }

/* --- Donut chart --- */
.donut-wrap { display: flex; align-items: center; gap: 20px; }
.donut-svg { width: 100px; height: 100px; }
.donut-legend { font-size: 13px; color: var(--t2); }
.donut-legend span { font-weight: 600; font-family: var(--mono); }

/* --- Waterfall / savings bars --- */
.waterfall-bar {
  display: flex; align-items: center; gap: 8px; margin-bottom: 4px;
  font-size: 12px; font-family: var(--mono);
}
.waterfall-label { min-width: 100px; color: var(--t2); text-align: right; }
.waterfall-track { flex: 1; height: 20px; background: var(--bg-subtle); border-radius: 3px; position: relative; overflow: hidden; }
.waterfall-before {
  position: absolute; top: 0; left: 0; height: 100%; background: var(--t3); opacity: .3;
  border-radius: 3px 0 0 3px;
}
.waterfall-after {
  position: absolute; top: 0; left: 0; height: 100%;
  border-radius: 3px 0 0 3px;
}
.waterfall-after.win { background: var(--green); }
.waterfall-after.improved { background: var(--blue); }
.waterfall-after.neutral { background: var(--t3); opacity: .4; }
.waterfall-after.regression { background: var(--red); }
.waterfall-value { min-width: 70px; font-size: 12px; color: var(--t2); }

/* --- Alert cards --- */
.alert {
  border-radius: var(--radius); padding: 12px 16px; margin-bottom: 8px;
  font-size: 13px; display: flex; align-items: flex-start; gap: 8px;
}
.alert.warning { background: var(--amber-bg); border: 1px solid #fde68a; color: #92400e; }
.alert.danger { background: var(--red-bg); border: 1px solid #fecaca; color: #991b1b; }
.alert-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

/* --- Resource cards --- */
.resource-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
.resource-card {
  background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 12px 14px;
}
.resource-card .rc-label { font-size: 11px; color: var(--t3); font-family: var(--mono); text-transform: uppercase; letter-spacing: .06em; }
.resource-card .rc-value { font-size: 18px; font-weight: 700; color: var(--t1); font-family: var(--mono); margin-top: 2px; }

/* --- Filters --- */
.filters {
  padding: 12px 0; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
}
.filters label {
  font-size: 12px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .04em; text-transform: uppercase;
}
.filters select, .filters input {
  font-family: var(--sans); font-size: 13px; color: var(--t1);
  background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius);
  padding: 5px 10px; outline: none; transition: border-color .15s;
}
.filters select:focus, .filters input:focus {
  border-color: #93c5fd; box-shadow: 0 0 0 3px rgba(147,197,253,.15);
}
.filters input::placeholder { color: var(--t3); }

/* --- Detail panels --- */
.detail-row td { padding: 0 !important; border: none !important; }
.detail-panel {
  display: none; padding: 16px 24px; background: var(--bg);
  border-bottom: 2px solid var(--border);
}
.detail-panel.open { display: block; }
.detail-panel h4 {
  font-size: 11px; color: var(--t3); margin-bottom: 6px; text-transform: uppercase;
  letter-spacing: .08em; font-family: var(--mono);
}
.detail-panel .match-list { display: flex; flex-direction: column; gap: 4px; margin-bottom: 12px; }
.detail-panel .match-item {
  display: flex; align-items: center; gap: 10px; font-size: 13px; font-family: var(--mono);
}
.detail-panel .match-bar {
  height: 5px; border-radius: 3px; background: var(--purple);
  transition: width .3s; min-width: 3px;
}
.detail-panel .match-bar-bg {
  width: 100px; height: 5px; border-radius: 3px; background: var(--bg-subtle);
  position: relative; overflow: hidden;
}

/* --- Swarm cards --- */
.cards { display: flex; flex-direction: column; gap: 6px; }
.card {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px;
  overflow: hidden; transition: border-color .2s;
}
.card:hover { border-color: #cbd5e1; }
.card-header {
  display: flex; align-items: center; padding: 12px 18px;
  cursor: pointer; gap: 14px; user-select: none;
}
.card-header .expand-icon { color: var(--t3); font-size: 10px; transition: transform 0.2s; width: 14px; }
.card.open .card-header .expand-icon { transform: rotate(90deg); }
.card-header .qid { font-weight: 600; color: var(--t1); font-size: 15px; min-width: 180px; }
.card-header .qid span { font-family: var(--mono); font-size: 14px; }
.card-header .detail { font-size: 13px; color: var(--t3); font-family: var(--mono); }
.card-header .strategy { color: var(--purple); font-size: 13px; font-family: var(--mono); font-weight: 500; }
.card-header .timing { margin-left: auto; font-size: 13px; color: var(--t3); font-family: var(--mono); }
.card-body { display: none; border-top: 1px solid var(--border); padding: 20px; background: var(--bg); }
.card.open .card-body { display: block; }

/* --- Pipeline timeline --- */
.timeline { display: flex; flex-direction: column; gap: 5px; margin-bottom: 20px; }
.stage { display: flex; align-items: center; gap: 8px; }
.stage-label {
  font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: .06em;
  color: var(--t3); min-width: 80px; text-align: right; font-family: var(--mono);
}
.stage-bar-wrap { flex: 1; position: relative; height: 22px; background: var(--bg-subtle); border-radius: 4px; }
.stage-bar {
  height: 100%; border-radius: 4px; display: flex; align-items: center;
  padding: 0 8px; font-size: 11px; font-weight: 500; font-family: var(--mono);
  color: #fff; min-width: 36px; position: relative;
}
.stage-bar.parse { background: #0d9488; }
.stage-bar.data { background: #7c3aed; opacity: 0.6; }
.stage-bar.analyst { background: #7c3aed; }
.stage-bar.generate { background: var(--blue); }
.stage-bar.validate { background: #ea580c; }
.stage-bar.explain { background: #0d9488; opacity: 0.75; }
.stage-bar.retry { background: var(--amber); }
.stage-dur { font-size: 12px; color: var(--t2); margin-left: 6px; min-width: 48px; font-family: var(--mono); }

.parallel-group { display: flex; flex-direction: column; gap: 3px; padding-left: 88px; }
.parallel-group .stage-bar-wrap { height: 16px; }
.parallel-group .stage-bar { height: 16px; font-size: 10px; }
.parallel-group .stage-label { font-size: 10px; min-width: 80px; }
.parallel-group .stage-dur { font-size: 11px; }

/* --- Worker table --- */
.results-table { width: 100%; border-collapse: collapse; margin-top: 16px; font-size: 13px; }
.results-table th {
  background: var(--bg-subtle); color: var(--t3); text-align: left; padding: 8px 12px;
  font-size: 11px; font-family: var(--mono); letter-spacing: .08em;
  text-transform: uppercase; border-bottom: 1px solid var(--border);
}
.results-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }
.results-table tbody tr { cursor: pointer; transition: background .1s; }
.results-table tbody tr:hover { background: var(--bg-elevated); }
.results-table tr.best-row { background: var(--green-bg); }

.worker-detail {
  display: none; background: var(--bg-subtle); border: 1px solid var(--border); border-radius: 6px;
  margin: 6px 0 10px 0; padding: 16px;
}
.worker-detail.open { display: block; }
.worker-detail h4 {
  font-size: 11px; color: var(--t3); margin-bottom: 8px; text-transform: uppercase;
  letter-spacing: .08em; font-family: var(--mono);
}
.worker-detail pre {
  background: #f8fafc; border: 1px solid var(--border); padding: 14px; border-radius: 6px; overflow-x: auto;
  font-size: 13px; line-height: 1.6; color: #334155; font-family: var(--mono);
  max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-break: break-word;
}
.worker-detail .error-msg {
  background: var(--red-bg); border-left: 3px solid var(--red);
  padding: 10px 14px; font-size: 13px; color: #991b1b; margin-bottom: 10px;
  border-radius: 0 var(--radius) var(--radius) 0;
}

.race-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; font-family: var(--mono); }
.race-badge.race { background: var(--blue-bg); color: var(--blue); }
.race-badge.sequential { background: var(--bg-subtle); color: var(--t3); }

.session-footer {
  display: flex; gap: 20px; margin-top: 16px; padding-top: 12px;
  border-top: 1px solid var(--border); font-size: 13px; color: var(--t3); font-family: var(--mono);
}

/* --- Run history cards --- */
.run-card {
  background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px;
  padding: 12px 16px; margin-bottom: 6px; font-size: 13px; font-family: var(--mono);
  display: flex; gap: 20px; align-items: center; flex-wrap: wrap;
}
.run-card .run-id { font-weight: 600; color: var(--t1); min-width: 200px; }
.run-card .run-stat { color: var(--t3); }

/* --- Hero stat --- */
.hero-stat {
  text-align: center; padding: 24px; background: var(--bg-elevated);
  border: 1px solid var(--border); border-radius: 8px;
  border-top: 2px solid var(--green);
}
.hero-stat .hero-value {
  font-size: 48px; font-weight: 700; color: var(--green);
  font-variant-numeric: tabular-nums; font-family: var(--mono);
}
.hero-stat .hero-label { font-size: 14px; color: var(--t2); margin-top: 4px; }

/* --- Empty state --- */
.empty { text-align: center; padding: 80px 40px; color: var(--t3); }
.empty h2 { font-size: 18px; color: var(--t2); margin-bottom: 6px; }

/* --- Grid layouts --- */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

/* --- Opportunity Matrix scatter --- */
.scatter-svg { width: 100%; height: 360px; display: block; }
.scatter-dot { cursor: pointer; transition: opacity .15s; stroke: #fff; stroke-width: 1.5; }
.scatter-dot:hover { opacity: 0.7; stroke-width: 2.5; }
.scatter-axis { stroke: var(--border); }
.scatter-tick { font-size: 11px; fill: var(--t3); font-family: var(--mono); }
.scatter-label { font-size: 12px; fill: var(--t2); font-family: var(--mono); }
.scatter-legend {
  display: flex; gap: 16px; justify-content: center; margin-top: 8px;
  font-size: 12px; font-family: var(--mono); color: var(--t3); flex-wrap: wrap;
}
.scatter-legend-dot {
  display: inline-block; width: 10px; height: 10px; border-radius: 50%;
  vertical-align: middle; margin-right: 3px;
}

/* --- Query drawer --- */
.drawer-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.15); z-index: 100;
}
.drawer-overlay.open { display: block; }
.drawer {
  position: fixed; top: 0; right: -520px; width: 500px; height: 100vh;
  background: var(--bg); border-left: 1px solid var(--border);
  box-shadow: -4px 0 24px rgba(0,0,0,.08); z-index: 101;
  transition: right .25s ease; overflow-y: auto;
}
.drawer.open { right: 0; }
.drawer-header {
  display: flex; align-items: center; gap: 12px; padding: 20px 24px;
  border-bottom: 1px solid var(--border); position: sticky; top: 0;
  background: var(--bg); z-index: 1;
}
.drawer-close {
  width: 28px; height: 28px; border: 1px solid var(--border); border-radius: var(--radius);
  background: var(--bg); cursor: pointer; font-size: 16px; color: var(--t3);
  display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.drawer-close:hover { background: var(--bg-subtle); color: var(--t1); }
.drawer-body { padding: 20px 24px; }
.drawer-section { margin-bottom: 20px; }
.drawer-section h4 {
  font-size: 11px; color: var(--t3); text-transform: uppercase; letter-spacing: .08em;
  font-family: var(--mono); margin-bottom: 8px; font-weight: 500;
}
.drawer-context {
  font-size: 12px; color: var(--t3); font-family: var(--mono);
  display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;
}
.drawer-pre {
  background: var(--bg-subtle); border: 1px solid var(--border); padding: 14px;
  border-radius: 6px; overflow-x: auto; font-size: 12px; line-height: 1.5;
  color: #334155; font-family: var(--mono); max-height: 400px; overflow-y: auto;
  white-space: pre-wrap; word-break: break-word;
}

/* --- Engine profile card --- */
.ep-tabs { display: flex; gap: 0; margin-bottom: 12px; border-bottom: 1px solid var(--border); }
.ep-tab {
  padding: 6px 14px; font-size: 12px; font-weight: 600; color: var(--t3);
  cursor: pointer; border-bottom: 2px solid transparent; font-family: var(--mono);
}
.ep-tab:hover { color: var(--t2); }
.ep-tab.active { color: var(--t1); border-bottom-color: var(--t1); }
.ep-gap-row { padding: 8px 0; border-bottom: 1px solid var(--border-subtle); }
.ep-gap-row:last-child { border-bottom: none; }
.ep-gap-id { font-family: var(--mono); font-size: 12px; font-weight: 600; color: var(--t1); }
.ep-gap-meta { font-size: 12px; color: var(--t3); margin-top: 2px; }

/* --- Q-Error barbell --- */
.barbell-row {
  display: flex; align-items: center; gap: 8px; padding: 5px 0;
  font-size: 12px; font-family: var(--mono); border-bottom: 1px solid var(--border-subtle);
  cursor: pointer; transition: background .1s;
}
.barbell-row:hover { background: var(--bg-subtle); }
.barbell-row:last-child { border-bottom: none; }
.barbell-label { min-width: 52px; font-weight: 500; color: var(--t1); }
.barbell-track {
  flex: 1; height: 8px; background: var(--bg-subtle);
  border-radius: 4px; position: relative; overflow: hidden;
}
.barbell-info {
  min-width: 140px; font-size: 11px; color: var(--t3); text-align: right;
  display: flex; align-items: center; gap: 4px; justify-content: flex-end;
}

/* --- Severity badges --- */
.severity-badge {
  display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px;
  font-weight: 600; text-transform: uppercase; letter-spacing: .03em;
}
.severity-badge.catastrophic { background: #fef2f2; color: #dc2626; }
.severity-badge.major { background: #fff7ed; color: #ea580c; }
.severity-badge.moderate { background: #fffbeb; color: #d97706; }
.severity-badge.minor { background: #f0fdf4; color: #16a34a; }
.severity-badge.accurate { background: #f0fdf4; color: #16a34a; }

/* --- Responsive --- */
@media (max-width: 900px) {
  .grid-2, .grid-3 { grid-template-columns: 1fr; }
  .section { padding: 20px 20px; }
  .header { padding: 20px 20px 16px; }
  .tab-bar { padding: 0 20px; }
  .stat-card .value { font-size: 22px; }
  .hero-stat .hero-value { font-size: 36px; }
  .drawer { width: 100%; right: -100%; }
}
</style>
</head>
<body>

<div class="header">
  <h1 id="title">QueryTorque Dashboard</h1>
  <div class="meta">
    <span id="meta-engine"></span>
    <span id="meta-queries"></span>
    <span id="meta-latest"></span>
  </div>
</div>

<div class="tab-bar" id="tab-bar">
  <div class="tab active" data-tab="forensic" onclick="switchTab('forensic')">Forensic</div>
  <div class="tab" data-tab="execution" onclick="switchTab('execution')">Execution</div>
  <div class="tab" data-tab="results" onclick="switchTab('results')">Results</div>
  <div class="tab" data-tab="swarm" onclick="switchTab('swarm')" id="swarm-tab" style="display:none">Swarm</div>
</div>

<!-- ========== FORENSIC TAB ========== -->
<div id="forensic-view" class="tab-view">
  <div class="section">
    <!-- §6.1 Global Health Bar -->
    <div class="stat-row" id="forensic-stats"></div>

    <!-- §6.2 Opportunity Matrix -->
    <div class="panel">
      <div class="panel-title">Opportunity Matrix</div>
      <div id="opp-matrix"></div>
    </div>

    <!-- §6.3 Cost Pareto (enhanced) -->
    <div class="panel">
      <div class="panel-title">Cost Concentration</div>
      <div id="pareto-bar" class="pareto-bar"></div>
      <div id="pareto-legend" class="pareto-legend"></div>
      <div style="margin-top:16px; max-height:400px; overflow-y:auto">
        <table class="data-table" id="cost-table">
          <thead><tr>
            <th>Query</th><th>Runtime</th><th style="text-align:right">% Total</th>
            <th style="text-align:right">Cumul.</th><th>Bucket</th>
            <th>Tract</th><th>Top Transform</th>
          </tr></thead>
          <tbody id="cost-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- §6.4 Engine Profile + §6.5 Q-Error -->
    <div class="grid-2">
      <div class="panel" id="engine-profile-panel" style="display:none">
        <div class="panel-title">Engine Profile</div>
        <div id="engine-profile"></div>
      </div>
      <div class="panel" id="qerror-panel" style="display:none">
        <div class="panel-title" id="qerror-title">Estimation Diagnostics</div>
        <div id="qerror-chart" style="max-height:400px;overflow-y:auto"></div>
      </div>
    </div>

    <!-- §6.7 Pattern Coverage + Bucket Distribution -->
    <div class="grid-2">
      <div class="panel">
        <div class="panel-title">Transform Applicability</div>
        <div id="pattern-donut" class="donut-wrap"></div>
        <div style="margin-top:16px; max-height:260px; overflow-y:auto">
          <table class="data-table" id="pattern-table">
            <thead><tr>
              <th>Transform</th><th style="text-align:right">Queries</th>
              <th>Avg Overlap</th><th>Target Gap</th>
            </tr></thead>
            <tbody id="pattern-tbody"></tbody>
          </table>
        </div>
      </div>
      <div>
        <div class="panel">
          <div class="panel-title">Bucket Distribution</div>
          <div class="stat-row" id="bucket-cards"></div>
        </div>
        <div class="panel" id="resource-panel" style="display:none">
          <div class="panel-title">Resource Profile</div>
          <div class="resource-grid" id="resource-grid"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- §6.6 Per-Query Deep-Dive Drawer -->
<div class="drawer-overlay" id="drawer-overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="query-drawer">
  <div class="drawer-header">
    <button class="drawer-close" onclick="closeDrawer()">&times;</button>
    <div id="drawer-title" style="font-weight:600;font-size:16px"></div>
  </div>
  <div class="drawer-body" id="drawer-body"></div>
</div>

<!-- ========== EXECUTION TAB ========== -->
<div id="execution-view" class="tab-view" style="display:none">
  <div class="section">
    <div class="stat-row" id="exec-stats"></div>

    <!-- Run selector -->
    <div class="filters" id="exec-filters">
      <label>Run</label>
      <select id="exec-run-select"></select>
      <label>Bucket</label>
      <select id="exec-bucket-filter">
        <option value="all">All</option>
        <option value="HIGH">HIGH</option>
        <option value="MEDIUM">MEDIUM</option>
        <option value="LOW">LOW</option>
        <option value="SKIP">SKIP</option>
      </select>
      <label>Status</label>
      <select id="exec-status-filter">
        <option value="all">All</option>
        <option value="win">WIN</option>
        <option value="improved">IMPROVED</option>
        <option value="neutral">NEUTRAL</option>
        <option value="regression">REGRESSION</option>
        <option value="error">ERROR</option>
        <option value="pending">Not run</option>
      </select>
      <label>Search</label>
      <input type="text" id="exec-search" placeholder="query id, transform..." size="20">
    </div>

    <!-- Fleet table -->
    <div style="max-height:600px; overflow-y:auto">
      <table class="data-table" id="fleet-table">
        <thead><tr>
          <th data-sort="query_id">Query <span class="sort-arrow"></span></th>
          <th data-sort="bucket">Bucket <span class="sort-arrow"></span></th>
          <th data-sort="runtime_ms">Runtime <span class="sort-arrow"></span></th>
          <th data-sort="tractability">Tract <span class="sort-arrow"></span></th>
          <th data-sort="top_transform">Top Transform <span class="sort-arrow"></span></th>
          <th data-sort="priority_score">Priority <span class="sort-arrow"></span></th>
          <th data-sort="status">Status <span class="sort-arrow"></span></th>
          <th data-sort="speedup">Speedup <span class="sort-arrow"></span></th>
        </tr></thead>
        <tbody id="fleet-tbody"></tbody>
      </table>
    </div>

    <!-- Run History -->
    <div id="run-history" style="margin-top:20px"></div>
  </div>
</div>

<!-- ========== RESULTS TAB ========== -->
<div id="results-view" class="tab-view" style="display:none">
  <div class="section">
    <!-- Hero savings -->
    <div class="grid-3" id="results-heroes" style="margin-bottom:20px"></div>

    <!-- Status cards -->
    <div class="stat-row" id="results-status-cards"></div>

    <!-- Savings waterfall -->
    <div class="panel">
      <div class="panel-title">Cost Savings Waterfall</div>
      <div id="waterfall" style="max-height:500px; overflow-y:auto"></div>
    </div>

    <!-- Resource Impact + Regressions side by side -->
    <div class="grid-2">
      <div class="panel" id="resource-impact-panel" style="display:none">
        <div class="panel-title">Resource Impact</div>
        <div id="resource-impact"></div>
      </div>

      <div class="panel" id="regressions-panel" style="display:none">
        <div class="panel-title">Regression Alerts</div>
        <div id="regressions"></div>
      </div>
    </div>
  </div>
</div>

<!-- ========== SWARM TAB ========== -->
<div id="swarm-view" class="tab-view" style="display:none">
  <div class="section">
    <div class="stat-row" id="swarm-summary"></div>
    <div class="filters">
      <label>Sort</label>
      <select id="sort-select">
        <option value="qid">Query ID</option>
        <option value="speedup-desc">Speedup (high first)</option>
        <option value="speedup-asc">Speedup (low first)</option>
        <option value="status">Status</option>
        <option value="duration">Duration</option>
      </select>
      <label>Status</label>
      <select id="filter-select">
        <option value="all">All</option>
        <option value="running">RUNNING</option>
        <option value="win">WIN</option>
        <option value="improved">IMPROVED</option>
        <option value="neutral">NEUTRAL</option>
        <option value="regression">REGRESSION</option>
        <option value="error">ERROR</option>
      </select>
      <label>Search</label>
      <input type="text" id="search-input" placeholder="query id, strategy..." size="20">
    </div>
    <div class="cards" id="cards"></div>
  </div>
</div>

<script>
const DATA = __DASHBOARD_DATA__;
const P = DATA.profile || {};
const F = P.forensic || {};
const E = P.execution || {};
const I = P.impact || {};

let currentTab = 'forensic';
let fleetSortCol = 'priority_score';
let fleetSortDir = -1;

// =====================================================
// Utilities
// =====================================================

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function fmtDur(s) {
  if (s == null) return '?';
  if (s < 1) return (s * 1000).toFixed(0) + 'ms';
  if (s < 60) return s.toFixed(1) + 's';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return m + 'm' + (sec < 10 ? '0' : '') + sec + 's';
}

function fmtMs(ms) {
  if (ms == null || ms < 0) return '?';
  if (ms < 1000) return ms.toFixed(0) + 'ms';
  if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
  return (ms / 60000).toFixed(1) + 'min';
}

function fmtPct(v) { return (v * 100).toFixed(1) + '%'; }

function fmtSpeedup(v) {
  if (v == null || v === 0) return '\u2014';
  return v.toFixed(2) + 'x';
}

function speedupClass(v) {
  if (v == null || v === 0) return 'meh';
  if (v >= 1.05) return 'fast';
  if (v < 0.95) return 'slow';
  return 'meh';
}

function statusClass(s) {
  if (!s) return 'pending';
  return s.toLowerCase().replace(' ', '');
}

// Color palette for pareto segments
const PARETO_COLORS = ['#ef4444','#f97316','#f59e0b','#eab308','#84cc16','#22c55e','#14b8a6','#06b6d4','#3b82f6','#8b5cf6'];

// =====================================================
// Tab switching
// =====================================================

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  document.querySelectorAll('.tab-view').forEach(v => v.style.display = 'none');
  const view = document.getElementById(tab + '-view');
  if (view) view.style.display = '';
}

// =====================================================
// FORENSIC TAB
// =====================================================

function renderForensic() {
  // §6.1 Global Health Bar
  const stats = document.getElementById('forensic-stats');
  stats.innerHTML = '';

  const totalQ = F.total_queries || 0;
  const totalMs = F.total_runtime_ms || 0;
  const pc = F.pattern_coverage || {};
  const withDet = pc.queries_with_detection || 0;
  const domPath = F.dominant_pathology || '';
  const oppMs = F.estimated_opportunity_ms || 0;

  const items = [
    { label: 'Queries', value: totalQ, cls: '' },
    { label: 'Total Runtime', value: fmtMs(totalMs), cls: '' },
    { label: 'Detection', value: totalQ > 0 ? Math.round(withDet/totalQ*100) + '%' : '0%', sub: withDet + '/' + totalQ, cls: 'green' },
    { label: 'Opportunity', value: fmtMs(oppMs), sub: 'HIGH + MEDIUM', cls: 'blue' },
  ];
  if (domPath) {
    items.push({ label: 'Pathology', value: domPath, cls: 'amber' });
  }
  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'stat-card' + (it.cls ? ' ' + it.cls : '');
    d.innerHTML = `<span class="label">${it.label}</span><span class="value">${it.value}</span>${it.sub ? `<span class="sub">${it.sub}</span>` : ''}`;
    stats.appendChild(d);
  }

  renderOpportunityMatrix();
  renderParetoBar();
  renderCostTable();
  renderEngineProfile();
  renderQErrorChart();
  renderPatternCoverage();
  renderBucketCards();
  renderResourceProfile();
}

function renderParetoBar() {
  const bar = document.getElementById('pareto-bar');
  const legend = document.getElementById('pareto-legend');
  bar.innerHTML = '';

  // Prefer F.queries (new), fallback to F.cost_concentration (legacy)
  const queries = (F.queries || []).filter(q => q.runtime_ms > 0);
  const bucketColor = { HIGH: '#ef4444', MEDIUM: '#f59e0b', LOW: '#3b82f6', SKIP: '#cbd5e1' };

  if (queries.length > 0) {
    const sorted = [...queries].sort((a, b) => a.cost_rank - b.cost_rank);
    const top = sorted.slice(0, 10);
    const restPct = sorted.slice(10).reduce((s, q) => s + q.pct_of_total, 0);

    top.forEach(q => {
      if (q.pct_of_total < 0.002) return;
      const seg = document.createElement('div');
      seg.className = 'pareto-segment';
      seg.style.width = (q.pct_of_total * 100) + '%';
      seg.style.background = bucketColor[q.bucket] || '#cbd5e1';
      seg.style.cursor = 'pointer';
      seg.title = q.query_id + ': ' + fmtMs(q.runtime_ms) + ' (' + fmtPct(q.pct_of_total) + ')';
      seg.onclick = () => openDrawer(q.query_id);
      if (q.pct_of_total >= 0.03) seg.textContent = q.query_id;
      bar.appendChild(seg);
    });

    if (restPct > 0.001) {
      const seg = document.createElement('div');
      seg.className = 'pareto-segment';
      seg.style.width = (restPct * 100) + '%';
      seg.style.background = '#cbd5e1';
      seg.title = (sorted.length - 10) + ' other queries';
      if (restPct >= 0.05) seg.textContent = (sorted.length - 10) + ' others';
      bar.appendChild(seg);
    }

    const top5Pct = sorted.slice(0, 5).reduce((s, q) => s + q.pct_of_total, 0);
    const top10Pct = sorted.slice(0, 10).reduce((s, q) => s + q.pct_of_total, 0);
    legend.innerHTML = `Top 5 = <strong>${fmtPct(top5Pct)}</strong> of workload &nbsp;|&nbsp; Top 10 = <strong>${fmtPct(top10Pct)}</strong>`;
    return;
  }

  // Legacy fallback
  const cc = F.cost_concentration || [];
  if (cc.length === 0) {
    bar.innerHTML = '<div style="color:var(--t3);font-size:13px;padding:8px">No timing data</div>';
    legend.innerHTML = '';
    return;
  }
  cc.slice(0, 10).forEach((c, i) => {
    if (c.pct_of_total < 0.002) return;
    const seg = document.createElement('div');
    seg.className = 'pareto-segment';
    seg.style.width = (c.pct_of_total * 100) + '%';
    seg.style.background = PARETO_COLORS[i % PARETO_COLORS.length];
    seg.title = c.query_id + ': ' + fmtPct(c.pct_of_total);
    if (c.pct_of_total >= 0.03) seg.textContent = c.query_id;
    bar.appendChild(seg);
  });
  const restPct = cc.slice(10).reduce((s, c) => s + c.pct_of_total, 0);
  if (restPct > 0.001) {
    const seg = document.createElement('div');
    seg.className = 'pareto-segment';
    seg.style.width = (restPct * 100) + '%';
    seg.style.background = '#cbd5e1';
    bar.appendChild(seg);
  }
  legend.innerHTML = '';
}

function renderCostTable() {
  const tbody = document.getElementById('cost-tbody');
  tbody.innerHTML = '';

  // Prefer F.queries (new), fallback to F.cost_concentration (legacy)
  const queries = (F.queries || []).filter(q => q.runtime_ms > 0);
  if (queries.length > 0) {
    const sorted = [...queries].sort((a, b) => a.cost_rank - b.cost_rank);
    for (const q of sorted) {
      const tr = document.createElement('tr');
      tr.style.cursor = 'pointer';
      tr.onclick = () => openDrawer(q.query_id);
      let tractDots = '';
      for (let i = 0; i < 4; i++) {
        tractDots += `<span class="tract-dot${i < q.tractability ? ' filled' : ''}"></span>`;
      }
      tr.innerHTML = `
        <td style="font-family:var(--mono);font-weight:500">${esc(q.query_id)}</td>
        <td style="font-family:var(--mono);text-align:right">${fmtMs(q.runtime_ms)}</td>
        <td style="font-family:var(--mono);text-align:right">${fmtPct(q.pct_of_total)}</td>
        <td style="font-family:var(--mono);text-align:right;color:var(--t3)">${fmtPct(q.cumulative_pct)}</td>
        <td><span class="bucket-badge ${q.bucket.toLowerCase()}">${q.bucket}</span></td>
        <td><div class="tract-dots">${tractDots}</div></td>
        <td>${q.top_transform ? `<span class="tag transform">${esc(q.top_transform)}</span>` : '<span style="color:var(--t3)">--</span>'}</td>
      `;
      tbody.appendChild(tr);
    }
    return;
  }

  // Legacy fallback
  const cc = F.cost_concentration || [];
  for (const c of cc) {
    const tr = document.createElement('tr');
    const patterns = (c.detected_patterns || []).slice(0, 3).map(p => `<span class="tag transform">${esc(p)}</span>`).join('');
    tr.innerHTML = `
      <td style="font-family:var(--mono);font-weight:500">${esc(c.query_id)}</td>
      <td style="font-family:var(--mono);text-align:right">${fmtMs(c.runtime_ms)}</td>
      <td style="font-family:var(--mono);text-align:right">${fmtPct(c.pct_of_total)}</td>
      <td style="font-family:var(--mono);text-align:right;color:var(--t3)">${fmtPct(c.cumulative_pct)}</td>
      <td><span class="bucket-badge ${c.bucket.toLowerCase()}">${c.bucket}</span></td>
      <td></td>
      <td>${patterns || '<span style="color:var(--t3)">--</span>'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function renderPatternCoverage() {
  const pc = F.pattern_coverage || {};
  const donut = document.getElementById('pattern-donut');
  const tbody = document.getElementById('pattern-tbody');

  const withDet = pc.queries_with_detection || 0;
  const withoutDet = pc.queries_without_detection || 0;
  const total = withDet + withoutDet;
  const pct = total > 0 ? (withDet / total) : 0;

  // SVG donut
  const r = 38, cx = 50, cy = 50, circ = 2 * Math.PI * r;
  const filled = circ * pct;
  donut.innerHTML = `
    <svg class="donut-svg" viewBox="0 0 100 100">
      <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--bg-subtle)" stroke-width="10"/>
      <circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="var(--green)" stroke-width="10"
        stroke-dasharray="${filled} ${circ - filled}" stroke-dashoffset="${circ * 0.25}"
        stroke-linecap="round" style="transition: stroke-dasharray .5s"/>
      <text x="${cx}" y="${cy}" text-anchor="middle" dy=".35em"
        font-size="18" font-weight="700" fill="var(--t1)" font-family="var(--mono)">${Math.round(pct*100)}%</text>
    </svg>
    <div class="donut-legend">
      <div><span style="color:var(--green)">${withDet}</span> queries with detected patterns</div>
      <div><span>${withoutDet}</span> no match above 25%${withoutDet > 0 ? ' \u2014 discovery mode' : ''}</div>
    </div>
  `;

  // Transform applicability table
  tbody.innerHTML = '';
  const topP = pc.top_patterns || [];
  for (const p of topP) {
    const tr = document.createElement('tr');
    const overlapPct = Math.round(p.avg_overlap * 100);
    tr.innerHTML = `
      <td><span class="tag transform">${esc(p.pattern_id)}</span></td>
      <td style="font-family:var(--mono);text-align:right">${p.query_count}</td>
      <td>
        <div style="display:flex;align-items:center;gap:6px">
          <div style="width:60px;height:5px;background:var(--bg-subtle);border-radius:3px;overflow:hidden">
            <div style="width:${overlapPct}%;height:100%;background:var(--purple);border-radius:3px"></div>
          </div>
          <span style="font-family:var(--mono);font-size:12px;color:var(--t2)">${overlapPct}%</span>
        </div>
      </td>
      <td>${p.target_gap ? `<span class="tag gap">${esc(p.target_gap)}</span>` : '<span style="color:var(--t3)">--</span>'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function renderBucketCards() {
  const bd = F.bucket_distribution || {};
  const container = document.getElementById('bucket-cards');
  container.innerHTML = '';

  const total = Object.values(bd).reduce((s, v) => s + v, 0);
  const buckets = [
    { key: 'HIGH', cls: 'red', label: 'High' },
    { key: 'MEDIUM', cls: 'amber', label: 'Medium' },
    { key: 'LOW', cls: 'muted', label: 'Low' },
    { key: 'SKIP', cls: 'muted', label: 'Skip' },
  ];

  for (const b of buckets) {
    const count = bd[b.key] || 0;
    const pct = total > 0 ? Math.round(count / total * 100) : 0;
    const d = document.createElement('div');
    d.className = 'stat-card ' + b.cls;
    d.innerHTML = `<span class="label">${b.label}</span><span class="value">${count}</span><span class="sub">${pct}%</span>`;
    container.appendChild(d);
  }
}

function renderResourceProfile() {
  const rp = F.resource_profile;
  if (!rp) return;

  const panel = document.getElementById('resource-panel');
  const grid = document.getElementById('resource-grid');
  panel.style.display = '';

  const items = [
    { label: 'shared_buffers', value: rp.shared_buffers },
    { label: 'work_mem', value: rp.work_mem_default },
    { label: 'parallel_workers', value: rp.max_parallel_workers },
    { label: 'cache_size', value: rp.effective_cache_size },
    { label: 'storage', value: rp.storage_type },
  ];

  grid.innerHTML = '';
  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'resource-card';
    d.innerHTML = `<div class="rc-label">${it.label}</div><div class="rc-value">${it.value}</div>`;
    grid.appendChild(d);
  }
}

// §6.2 Opportunity Matrix (SVG scatter plot)
function renderOpportunityMatrix() {
  const container = document.getElementById('opp-matrix');
  const queries = (F.queries || []).filter(q => q.runtime_ms > 0);

  if (queries.length === 0) {
    container.innerHTML = '<div style="color:var(--t3);font-size:13px;padding:40px;text-align:center">No timing data available for scatter plot</div>';
    return;
  }

  const W = 800, H = 380;
  const ML = 58, MR = 20, MT = 16, MB = 44;
  const PW = W - ML - MR, PH = H - MT - MB;

  const runtimes = queries.map(q => Math.log10(Math.max(1, q.runtime_ms)));
  const xMin = Math.floor(Math.min(...runtimes));
  const xMax = Math.ceil(Math.max(...runtimes));
  const xRange = xMax - xMin || 1;

  function xPos(logMs) { return ML + ((logMs - xMin) / xRange) * PW; }
  function yPos(overlap) { return MT + PH - overlap * PH; }

  const bucketColor = { HIGH: '#ef4444', MEDIUM: '#f59e0b', LOW: '#3b82f6', SKIP: '#94a3b8' };
  const xLabels = { 0: '1ms', 1: '10ms', 2: '100ms', 3: '1s', 4: '10s', 5: '100s' };

  let svg = `<svg class="scatter-svg" viewBox="0 0 ${W} ${H}">`;

  // Grid + tick labels
  for (let x = xMin; x <= xMax; x++) {
    const px = xPos(x);
    svg += `<line x1="${px}" y1="${MT}" x2="${px}" y2="${MT+PH}" stroke="var(--border)" stroke-dasharray="3,3" opacity="0.5"/>`;
    svg += `<text x="${px}" y="${MT+PH+16}" class="scatter-tick" text-anchor="middle">${xLabels[x] || '10^'+x+'ms'}</text>`;
  }
  for (let y = 0; y <= 100; y += 25) {
    const py = yPos(y / 100);
    svg += `<line x1="${ML}" y1="${py}" x2="${ML+PW}" y2="${py}" stroke="var(--border)" stroke-dasharray="3,3" opacity="0.5"/>`;
    svg += `<text x="${ML-6}" y="${py+4}" class="scatter-tick" text-anchor="end">${y}%</text>`;
  }

  // Axis labels
  svg += `<text x="${ML + PW/2}" y="${H-4}" class="scatter-label" text-anchor="middle">Runtime (log scale)</text>`;
  svg += `<text x="12" y="${MT + PH/2}" class="scatter-label" text-anchor="middle" transform="rotate(-90 12 ${MT + PH/2})">Structural Overlap</text>`;

  // Axes
  svg += `<line x1="${ML}" y1="${MT}" x2="${ML}" y2="${MT+PH}" class="scatter-axis"/>`;
  svg += `<line x1="${ML}" y1="${MT+PH}" x2="${ML+PW}" y2="${MT+PH}" class="scatter-axis"/>`;

  // Dots (larger behind for z-order)
  const sorted = [...queries].sort((a, b) => (b.n_matches || 0) - (a.n_matches || 0));
  for (const q of sorted) {
    const cx = xPos(Math.log10(Math.max(1, q.runtime_ms)));
    const cy = yPos(q.top_overlap);
    const r = Math.max(4, Math.min(13, 3 + (q.n_matches || 0) * 2));
    const color = bucketColor[q.bucket] || '#94a3b8';
    svg += `<circle class="scatter-dot" cx="${cx.toFixed(1)}" cy="${cy.toFixed(1)}" r="${r}" fill="${color}" onclick="openDrawer('${q.query_id}')">`;
    svg += `<title>${q.query_id}: ${fmtMs(q.runtime_ms)}, ${Math.round(q.top_overlap*100)}% overlap, ${q.n_matches} matches</title></circle>`;
  }

  svg += '</svg>';
  svg += `<div class="scatter-legend">
    <span><span class="scatter-legend-dot" style="background:#ef4444"></span>HIGH</span>
    <span><span class="scatter-legend-dot" style="background:#f59e0b"></span>MEDIUM</span>
    <span><span class="scatter-legend-dot" style="background:#3b82f6"></span>LOW</span>
    <span><span class="scatter-legend-dot" style="background:#94a3b8"></span>SKIP</span>
    <span style="margin-left:8px;color:var(--t3)">Dot size = matching transforms</span>
  </div>`;

  container.innerHTML = svg;
}

// §6.4 Engine Profile Card
function renderEngineProfile() {
  const ep = F.engine_profile;
  if (!ep) return;

  const panel = document.getElementById('engine-profile-panel');
  const container = document.getElementById('engine-profile');
  panel.style.display = '';

  let html = '<div class="ep-tabs">';
  html += '<div class="ep-tab active" data-ep="gaps" onclick="switchEpTab(this)">Blind Spots (' + (ep.gaps || []).length + ')</div>';
  html += '<div class="ep-tab" data-ep="strengths" onclick="switchEpTab(this)">Strengths (' + (ep.strengths || []).length + ')</div>';
  html += '</div>';

  // Gaps
  html += '<div id="ep-gaps">';
  for (const g of (ep.gaps || [])) {
    const countStyle = g.n_queries_matched > 0 ? 'color:var(--green)' : 'color:var(--t3)';
    html += `<div class="ep-gap-row">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span class="ep-gap-id">${esc(g.id)}</span>
        <span style="font-family:var(--mono);font-size:12px;font-weight:600;${countStyle}">${g.n_queries_matched || 0} queries</span>
      </div>
      ${g.what ? `<div class="ep-gap-meta">${esc(g.what)}</div>` : ''}
      ${g.opportunity ? `<div class="ep-gap-meta" style="color:var(--green-dim)">${esc(g.opportunity)}</div>` : ''}
      ${g.matched_query_ids && g.matched_query_ids.length > 0 ? `<div class="ep-gap-meta" style="font-size:11px;margin-top:4px">${g.matched_query_ids.slice(0,8).map(id => `<span class="tag" style="background:var(--bg-subtle);color:var(--t2);cursor:pointer" onclick="openDrawer('${id}')">${id}</span>`).join(' ')}${g.matched_query_ids.length > 8 ? ` <span style="color:var(--t3)">+${g.matched_query_ids.length - 8} more</span>` : ''}</div>` : ''}
    </div>`;
  }
  html += '</div>';

  // Strengths (hidden by default)
  html += '<div id="ep-strengths" style="display:none">';
  for (const s of (ep.strengths || [])) {
    html += `<div class="ep-gap-row">
      <span class="ep-gap-id">${esc(s.id)}</span>
      ${s.summary ? `<div class="ep-gap-meta">${esc(s.summary)}</div>` : ''}
      ${s.implication ? `<div class="ep-gap-meta" style="font-style:italic">${esc(s.implication)}</div>` : ''}
    </div>`;
  }
  html += '</div>';

  container.innerHTML = html;
}

function switchEpTab(tab) {
  tab.parentElement.querySelectorAll('.ep-tab').forEach(t => t.classList.remove('active'));
  tab.classList.add('active');
  const view = tab.dataset.ep;
  document.getElementById('ep-gaps').style.display = view === 'gaps' ? '' : 'none';
  document.getElementById('ep-strengths').style.display = view === 'strengths' ? '' : 'none';
}

// §6.5 Q-Error Diagnostics
function renderQErrorChart() {
  const queries = (F.queries || []).filter(q => q.qerror && q.qerror.max_q_error > 0);
  if (queries.length === 0) return;

  const panel = document.getElementById('qerror-panel');
  const container = document.getElementById('qerror-chart');
  const title = document.getElementById('qerror-title');
  panel.style.display = '';

  const engine = (DATA.engine || '').toLowerCase();
  title.textContent = engine === 'snowflake' ? 'Operator Flow' : 'Estimation Diagnostics';

  // Sort by max_q_error desc
  queries.sort((a, b) => b.qerror.max_q_error - a.qerror.max_q_error);
  const maxLogQE = Math.max(...queries.map(q => Math.log10(Math.max(2, q.qerror.max_q_error))));

  let html = '';
  for (const q of queries.slice(0, 25)) {
    const qe = q.qerror;
    const barPct = maxLogQE > 0 ? (Math.log10(Math.max(2, qe.max_q_error)) / maxLogQE) * 100 : 0;
    const sevLower = (qe.severity || '').toLowerCase().replace(/_blindness/g, '');
    const barColor = sevLower === 'catastrophic' ? '#ef4444' : sevLower === 'major' ? '#ea580c' : sevLower === 'moderate' ? '#f59e0b' : '#16a34a';

    html += `<div class="barbell-row" onclick="openDrawer('${esc(q.query_id)}')">
      <span class="barbell-label">${esc(q.query_id)}</span>
      <div class="barbell-track">
        <div style="position:absolute;top:0;left:0;height:100%;width:${barPct.toFixed(1)}%;background:${barColor};border-radius:4px;opacity:.6"></div>
      </div>
      <span class="barbell-info">
        <span class="severity-badge ${sevLower}">${esc(qe.severity)}</span>
        ${qe.worst_node ? `<span>${esc(qe.worst_node)}</span>` : ''}
      </span>
    </div>`;
  }

  container.innerHTML = html;
}

// §6.6 Per-Query Deep-Dive Drawer
function openDrawer(queryId) {
  const q = (F.queries || []).find(fq => fq.query_id === queryId);
  if (!q) return;

  document.getElementById('drawer-title').innerHTML =
    `<span style="font-family:var(--mono)">${esc(q.query_id)}</span>` +
    ` <span class="bucket-badge ${q.bucket.toLowerCase()}" style="margin-left:8px">${q.bucket}</span>`;

  let html = '';

  // Pane 1: Summary
  html += `<div class="drawer-section">
    <div style="display:flex;gap:8px;align-items:baseline;flex-wrap:wrap;margin-bottom:6px">
      <span style="font-family:var(--mono);font-size:20px;font-weight:700">${fmtMs(q.runtime_ms)}</span>
      <span style="font-family:var(--mono);font-size:14px;color:var(--t3)">Priority ${q.priority_score.toFixed(1)}</span>
      ${q.qerror && q.qerror.severity ? `<span class="severity-badge ${q.qerror.severity.toLowerCase().replace(/_blindness/g,'')}">${q.qerror.severity}</span>` : ''}
    </div>
    <div class="drawer-context">
      <span>#${q.cost_rank} costliest</span>
      <span>${fmtPct(q.pct_of_total)} of total</span>
      <span>Overlap: ${Math.round(q.top_overlap * 100)}%</span>
      <span>Tract: ${q.tractability}/4</span>
      <span>${q.n_matches} matches</span>
    </div>
  </div>`;

  // Pane 2: Signals
  html += '<div class="drawer-section"><h4>Transform Matches</h4>';
  const matches = q.matched_transforms || [];
  if (matches.length > 0) {
    html += '<div class="match-list">';
    for (const m of matches) {
      const pct = Math.round(m.overlap * 100);
      html += `<div class="match-item">
        <span style="min-width:170px">${esc(m.id)}</span>
        <div class="match-bar-bg"><div class="match-bar" style="width:${pct}%"></div></div>
        <span style="min-width:34px;color:var(--t2);text-align:right">${pct}%</span>
        ${m.gap ? `<span class="tag gap">${esc(m.gap)}</span>` : ''}
        ${m.family ? `<span class="tag family-${m.family.toLowerCase()}">${m.family}</span>` : ''}
      </div>`;
    }
    html += '</div>';
  } else {
    html += '<div style="color:var(--t3);font-size:13px">No transforms matched \u2014 discovery mode candidate</div>';
  }

  // Q-error in drawer
  if (q.qerror && q.qerror.severity) {
    const qe = q.qerror;
    html += '<div style="margin-top:14px"><h4>Estimation Error</h4>';
    html += `<div style="font-size:13px;font-family:var(--mono);color:var(--t2);display:flex;gap:10px;flex-wrap:wrap">
      ${qe.direction ? `<span>${qe.direction}</span>` : ''}
      ${qe.worst_node ? `<span>Worst: ${qe.worst_node}</span>` : ''}
      ${qe.max_q_error > 0 ? `<span>Q-Error: ${qe.max_q_error.toFixed(1)}x</span>` : ''}
      ${qe.locus ? `<span>Locus: ${qe.locus}</span>` : ''}
      ${qe.n_signals ? `<span>${qe.n_signals} signals</span>` : ''}
    </div>`;
    if (qe.pathology_routing) {
      html += `<div style="margin-top:6px">${qe.pathology_routing.split(',').map(p => `<span class="tag gap">${esc(p.trim())}</span>`).join(' ')}</div>`;
    }
    html += '</div>';
  }

  if (q.structural_flags && q.structural_flags.length > 0) {
    html += `<div style="margin-top:14px"><h4>Structural Flags</h4>
      <div>${q.structural_flags.map(f => `<span class="tag transform">${esc(f)}</span>`).join(' ')}</div>
    </div>`;
  }
  html += '</div>';

  // Pane 3: Evidence (EXPLAIN)
  html += `<div class="drawer-section">
    <h4 style="cursor:pointer" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'':'none'">
      Evidence (EXPLAIN) <span style="font-size:10px;color:var(--t3)">click to toggle</span>
    </h4>
    <div style="display:none">`;
  if (q.has_explain && q.explain_text) {
    html += `<pre class="drawer-pre">${esc(q.explain_text)}</pre>`;
  } else {
    html += '<div style="color:var(--t3);font-size:13px;padding:12px">EXPLAIN plan not available</div>';
  }
  html += '</div></div>';

  document.getElementById('drawer-body').innerHTML = html;
  document.getElementById('drawer-overlay').classList.add('open');
  document.getElementById('query-drawer').classList.add('open');
}

function closeDrawer() {
  document.getElementById('drawer-overlay').classList.remove('open');
  document.getElementById('query-drawer').classList.remove('open');
}

// =====================================================
// EXECUTION TAB
// =====================================================

function renderExecution() {
  renderExecStats();
  renderRunSelector();
  renderFleetTable();
  renderRunHistory();
}

function renderExecStats() {
  const stats = document.getElementById('exec-stats');
  stats.innerHTML = '';

  let queries = DATA.fleet_queries || [];
  const runResults = getSelectedRunResults();
  if (runResults) {
    queries = queries.map(q => {
      const rr = runResults[q.query_id];
      return { ...q, status: rr ? rr.status : null, speedup: rr ? rr.speedup : null };
    });
  }
  const buckets = { HIGH: 0, MEDIUM: 0, LOW: 0, SKIP: 0 };
  const statuses = { win: 0, improved: 0, neutral: 0, regression: 0, error: 0 };

  queries.forEach(q => {
    buckets[q.bucket] = (buckets[q.bucket] || 0) + 1;
    const st = (q.status || '').toLowerCase();
    if (statuses[st] !== undefined) statuses[st]++;
  });

  const items = [
    { cls: '', label: 'Queries', value: queries.length },
    { cls: 'green', label: 'Wins', value: statuses.win },
    { cls: 'blue', label: 'Improved', value: statuses.improved },
    { cls: 'muted', label: 'Neutral', value: statuses.neutral },
    { cls: 'red', label: 'Regression', value: statuses.regression },
    { cls: 'amber', label: 'Error', value: statuses.error },
  ];

  for (const it of items) {
    if (it.value === 0 && ['red','amber'].includes(it.cls)) continue;
    const d = document.createElement('div');
    d.className = 'stat-card ' + it.cls;
    d.innerHTML = `<span class="label">${it.label}</span><span class="value">${it.value}</span>`;
    stats.appendChild(d);
  }
}

function renderRunSelector() {
  const sel = document.getElementById('exec-run-select');
  const runs = E.runs || [];
  sel.innerHTML = '<option value="latest">Latest</option>';
  for (const r of runs) {
    const opt = document.createElement('option');
    opt.value = r.run_id;
    opt.textContent = (r.timestamp || r.run_id) + ' (' + r.completed + '/' + r.total_queries + ')';
    sel.appendChild(opt);
  }
}

/** Build a {query_id: {status, speedup}} map for the selected run. */
function getSelectedRunResults() {
  const runId = document.getElementById('exec-run-select').value;
  if (runId === 'latest') return null; // use precomputed fleet_queries values
  const runs = DATA.fleet_runs || [];
  const run = runs.find(r => r.run_id === runId);
  if (!run) return null;
  const map = {};
  for (const r of (run.results || [])) {
    map[r.query_id] = { status: r.status, speedup: r.speedup || 0 };
  }
  return map;
}

function renderFleetTable() {
  let queries = [...(DATA.fleet_queries || [])];
  const runResults = getSelectedRunResults();
  if (runResults) {
    queries = queries.map(q => {
      const rr = runResults[q.query_id];
      return { ...q, status: rr ? rr.status : null, speedup: rr ? rr.speedup : null };
    });
  }
  const tbody = document.getElementById('fleet-tbody');
  tbody.innerHTML = '';

  const bucketFilter = document.getElementById('exec-bucket-filter').value;
  const statusFilter = document.getElementById('exec-status-filter').value;
  const search = document.getElementById('exec-search').value.toLowerCase();

  if (bucketFilter !== 'all') queries = queries.filter(q => q.bucket === bucketFilter);
  if (statusFilter !== 'all') {
    if (statusFilter === 'pending') queries = queries.filter(q => !q.status);
    else queries = queries.filter(q => (q.status || '').toLowerCase() === statusFilter);
  }
  if (search) {
    queries = queries.filter(q =>
      (q.query_id || '').toLowerCase().includes(search) ||
      (q.top_transform || '').toLowerCase().includes(search));
  }

  queries.sort((a, b) => {
    let va = a[fleetSortCol], vb = b[fleetSortCol];
    if (va == null) va = fleetSortDir > 0 ? Infinity : -Infinity;
    if (vb == null) vb = fleetSortDir > 0 ? Infinity : -Infinity;
    if (typeof va === 'string') return fleetSortDir * va.localeCompare(vb);
    return fleetSortDir * (va - vb);
  });

  for (const q of queries) {
    const tr = document.createElement('tr');
    tr.setAttribute('data-qid', q.query_id);
    tr.onclick = () => toggleFleetDetail(q.query_id);

    const maxDots = 4;
    let tractDots = '';
    for (let i = 0; i < maxDots; i++) {
      tractDots += `<span class="tract-dot${i < q.tractability ? ' filled' : ''}"></span>`;
    }

    const statusBadge = q.status
      ? `<span class="badge ${statusClass(q.status)}">${q.status}</span>`
      : '<span style="color:var(--t3);font-size:12px">--</span>';

    tr.innerHTML = `
      <td style="font-family:var(--mono);font-weight:500">${esc(q.query_id)}</td>
      <td><span class="bucket-badge ${q.bucket.toLowerCase()}">${q.bucket}</span></td>
      <td style="font-family:var(--mono);font-size:12px;text-align:right">${fmtMs(q.runtime_ms)}</td>
      <td><div class="tract-bar"><div class="tract-dots">${tractDots}</div><span style="color:var(--t3);font-size:11px">${q.tractability}</span></div></td>
      <td>${q.top_transform ? `<span class="tag transform">${esc(q.top_transform)}</span>` : '<span style="color:var(--t3)">--</span>'}</td>
      <td style="font-family:var(--mono);font-size:12px;text-align:right;color:var(--t2)">${q.priority_score.toFixed(1)}</td>
      <td>${statusBadge}</td>
      <td class="speedup ${speedupClass(q.speedup)}">${fmtSpeedup(q.speedup)}</td>
    `;
    tbody.appendChild(tr);

    const detailTr = document.createElement('tr');
    detailTr.className = 'detail-row';
    detailTr.innerHTML = `<td colspan="8"><div class="detail-panel" id="fleet-detail-${q.query_id}">${renderFleetDetail(q)}</div></td>`;
    tbody.appendChild(detailTr);
  }
}

function renderFleetDetail(q) {
  let html = '';
  const matches = q.ast_matches || [];
  if (matches.length > 0) {
    html += '<h4>AST Detection Matches</h4><div class="match-list">';
    for (const m of matches) {
      const pct = Math.round(m.overlap * 100);
      html += `<div class="match-item">
        <span style="min-width:200px">${esc(m.id)}</span>
        <div class="match-bar-bg"><div class="match-bar" style="width:${pct}%"></div></div>
        <span style="min-width:36px;color:var(--t2)">${pct}%</span>
        ${m.gap ? `<span class="tag gap">${esc(m.gap)}</span>` : ''}
      </div>`;
    }
    html += '</div>';
  } else {
    html += '<h4>AST Detection</h4><div style="font-size:13px;color:var(--t3);margin-bottom:12px">No matches above 25% threshold</div>';
  }

  const llm = q.llm_matches || [];
  if (llm.length > 0) {
    html += '<h4>LLM Classifications</h4><div class="match-list">';
    for (const m of llm) {
      const pct = Math.round((m.confidence || 0) * 100);
      html += `<div class="match-item">
        <span style="min-width:200px">${esc(m.pathology_id || '')} ${esc(m.name || '')}</span>
        <div class="match-bar-bg"><div class="match-bar" style="width:${pct}%;background:var(--amber)"></div></div>
        <span style="min-width:36px;color:var(--t2)">${pct}%</span>
        ${m.transform ? `<span class="tag transform">${esc(m.transform)}</span>` : ''}
      </div>`;
    }
    html += '</div>';
  }

  html += `<h4>Triage</h4>
  <div style="font-size:13px;font-family:var(--mono);color:var(--t2);display:flex;gap:16px;flex-wrap:wrap">
    <span>Bucket: ${q.bucket}</span>
    <span>Runtime: ${fmtMs(q.runtime_ms)}</span>
    <span>Priority: ${q.priority_score.toFixed(1)}</span>
    <span>Max iters: ${q.max_iterations}</span>
    <span>Tractability: ${q.tractability}</span>
    <span>Structural: ${(q.structural_bonus * 100).toFixed(0)}%</span>
  </div>`;
  return html;
}

function toggleFleetDetail(qid) {
  const panel = document.getElementById('fleet-detail-' + qid);
  if (panel) {
    panel.classList.toggle('open');
    const row = panel.closest('tr').previousElementSibling;
    if (row) row.classList.toggle('expanded');
  }
}

function renderRunHistory() {
  const runs = DATA.fleet_runs || [];
  const container = document.getElementById('run-history');
  if (runs.length === 0) { container.innerHTML = ''; return; }

  let html = '<div class="section-title">Run History</div>';
  for (const run of runs.slice().reverse()) {
    const results = run.results || [];
    const wins = results.filter(r => r.status === 'WIN').length;
    const improved = results.filter(r => r.status === 'IMPROVED').length;
    const errors = results.filter(r => r.status === 'ERROR').length;

    html += `<div class="run-card">
      <span class="run-id">${esc(run.run_id)}</span>
      <span class="run-stat">${run.timestamp || ''}</span>
      <span class="run-stat">${run.completed}/${run.total} queries</span>
      <span class="run-stat" style="color:var(--green)">${wins} wins</span>
      <span class="run-stat" style="color:var(--blue)">${improved} improved</span>
      ${errors > 0 ? `<span class="run-stat" style="color:var(--amber)">${errors} errors</span>` : ''}
      ${run.elapsed_seconds ? `<span class="run-stat">${fmtDur(run.elapsed_seconds)}</span>` : ''}
    </div>`;
  }
  container.innerHTML = html;
}

// =====================================================
// RESULTS TAB
// =====================================================

function renderResults() {
  renderResultsHeroes();
  renderResultsStatusCards();
  renderWaterfall();
  renderResourceImpact();
  renderRegressions();
}

function renderResultsHeroes() {
  const container = document.getElementById('results-heroes');
  container.innerHTML = '';

  const savings = I.total_savings_ms || 0;
  const pct = I.total_savings_pct || 0;
  const baseline = I.total_baseline_ms || 0;

  const items = [
    { value: fmtMs(Math.abs(savings)), label: savings >= 0 ? 'Total Runtime Saved' : 'Total Runtime Added', accent: savings >= 0 },
    { value: pct.toFixed(1) + '%', label: 'Cost Reduction', accent: pct > 0 },
    { value: fmtMs(baseline), label: 'Baseline Runtime', accent: false },
  ];

  for (const it of items) {
    const d = document.createElement('div');
    d.className = 'hero-stat' + (it.accent ? '' : '');
    if (it.accent) d.style.borderTopColor = 'var(--green)';
    else d.style.borderTopColor = 'var(--border)';
    d.innerHTML = `
      <div class="hero-value" style="color:${it.accent ? 'var(--green)' : 'var(--t1)'}">${it.value}</div>
      <div class="hero-label">${it.label}</div>
    `;
    container.appendChild(d);
  }
}

function renderResultsStatusCards() {
  const container = document.getElementById('results-status-cards');
  container.innerHTML = '';

  const sc = I.status_counts || {};
  const items = [
    { label: 'Win', value: sc.WIN || 0, cls: 'green' },
    { label: 'Improved', value: sc.IMPROVED || 0, cls: 'blue' },
    { label: 'Neutral', value: sc.NEUTRAL || 0, cls: 'muted' },
    { label: 'Regression', value: sc.REGRESSION || 0, cls: 'red' },
    { label: 'Error', value: sc.ERROR || 0, cls: 'amber' },
  ];

  for (const it of items) {
    if (it.value === 0 && ['red','amber'].includes(it.cls)) continue;
    const d = document.createElement('div');
    d.className = 'stat-card ' + it.cls;
    d.innerHTML = `<span class="label">${it.label}</span><span class="value">${it.value}</span>`;
    container.appendChild(d);
  }
}

function renderWaterfall() {
  const container = document.getElementById('waterfall');
  container.innerHTML = '';

  // Build from cost_concentration + latest_results
  const cc = F.cost_concentration || [];
  const lr = E.latest_results || {};

  // Merge: get baseline from forensic, status+speedup from results
  const entries = [];
  for (const c of cc) {
    const r = lr[c.query_id];
    if (!r || !r.status || r.status === 'UNKNOWN') continue;
    const baseline = c.runtime_ms > 0 ? c.runtime_ms : (r.baseline_ms || 0);
    if (baseline <= 0) continue;
    const optimized = r.speedup > 0 ? baseline / r.speedup : baseline;
    entries.push({
      query_id: c.query_id,
      baseline,
      optimized,
      savings: baseline - optimized,
      status: r.status,
      speedup: r.speedup || 0,
    });
  }

  // Sort by savings descending
  entries.sort((a, b) => b.savings - a.savings);

  if (entries.length === 0) {
    container.innerHTML = '<div style="color:var(--t3);font-size:13px;padding:8px">No execution results available</div>';
    return;
  }

  const maxBaseline = Math.max(...entries.map(e => e.baseline));

  for (const e of entries) {
    const beforeW = (e.baseline / maxBaseline * 100);
    const afterW = (e.optimized / maxBaseline * 100);
    const stCls = e.status.toLowerCase();

    const bar = document.createElement('div');
    bar.className = 'waterfall-bar';
    bar.innerHTML = `
      <span class="waterfall-label">${esc(e.query_id.replace('query_','Q'))}</span>
      <div class="waterfall-track">
        <div class="waterfall-before" style="width:${beforeW}%"></div>
        <div class="waterfall-after ${stCls}" style="width:${afterW}%"></div>
      </div>
      <span class="waterfall-value speedup ${speedupClass(e.speedup)}">${fmtSpeedup(e.speedup)}</span>
    `;
    container.appendChild(bar);
  }
}

function renderResourceImpact() {
  const ri = I.resource_impact;
  const panel = document.getElementById('resource-impact-panel');
  const container = document.getElementById('resource-impact');

  if (!ri || ri.queries_with_set_local === 0) return;
  panel.style.display = '';

  let html = `
    <div class="resource-grid" style="margin-bottom:12px">
      <div class="resource-card">
        <div class="rc-label">SET LOCAL Queries</div>
        <div class="rc-value">${ri.queries_with_set_local}</div>
      </div>
      <div class="resource-card">
        <div class="rc-label">Peak work_mem</div>
        <div class="rc-value">${ri.work_mem_total}</div>
      </div>
      <div class="resource-card">
        <div class="rc-label">work_mem Factor</div>
        <div class="rc-value">${ri.work_mem_peak_factor}x</div>
      </div>
      <div class="resource-card">
        <div class="rc-label">Parallel Workers</div>
        <div class="rc-value">${ri.parallel_workers_total}</div>
      </div>
    </div>
  `;

  for (const w of (ri.warnings || [])) {
    html += `<div class="alert warning"><span class="alert-icon">!</span>${esc(w)}</div>`;
  }
  for (const c of (ri.conflicts || [])) {
    html += `<div class="alert warning"><span class="alert-icon">!</span>${esc(c)}</div>`;
  }

  container.innerHTML = html;
}

function renderRegressions() {
  const regs = I.regressions || [];
  const panel = document.getElementById('regressions-panel');
  const container = document.getElementById('regressions');

  if (regs.length === 0) return;
  panel.style.display = '';

  let html = '';
  for (const r of regs) {
    html += `<div class="alert danger">
      <span class="alert-icon">!</span>
      <div>
        <strong>${esc(r.query_id)}</strong> regressed to
        <span class="speedup slow">${fmtSpeedup(r.speedup)}</span>
        <div style="font-size:12px;margin-top:2px;color:#991b1b">
          Baseline: ${fmtMs(r.baseline_ms)} &rarr; Optimized: ${fmtMs(r.optimized_ms)}
        </div>
      </div>
    </div>`;
  }
  container.innerHTML = html;
}

// =====================================================
// SWARM TAB
// =====================================================

function effectiveStatus(session) {
  if (session.in_progress) return 'RUNNING';
  const sp = session.best_speedup || 0;
  if (sp === 0) {
    const allErr = (session.workers || []).every(w => w.status === 'ERROR');
    if (allErr && (session.workers || []).length > 0) return 'ERROR';
    return 'NEUTRAL';
  }
  if (sp >= 1.5) return 'WIN';
  if (sp >= 1.05) return 'IMPROVED';
  if (sp >= 0.95) return 'NEUTRAL';
  return 'REGRESSION';
}

function renderSwarmSummary() {
  const counts = { running: 0, win: 0, improved: 0, neutral: 0, regression: 0, error: 0 };
  (DATA.sessions || []).forEach(s => {
    const st = effectiveStatus(s).toLowerCase();
    if (counts[st] !== undefined) counts[st]++;
  });
  const bar = document.getElementById('swarm-summary');
  bar.innerHTML = '';
  const labels = { running: 'Running', win: 'Wins', improved: 'Improved', neutral: 'Neutral', regression: 'Regression', error: 'Error' };
  const clsMap = { running: 'blue', win: 'green', improved: 'blue', neutral: 'muted', regression: 'red', error: 'amber' };
  for (const [k, v] of Object.entries(counts)) {
    const d = document.createElement('div');
    d.className = 'stat-card ' + (clsMap[k] || '');
    d.innerHTML = `<span class="label">${labels[k]}</span><span class="value">${v}</span>`;
    bar.appendChild(d);
  }
}

function stageBarHtml(label, cssClass, durationS, maxDuration) {
  const pct = maxDuration > 0 ? Math.max(3, (durationS / maxDuration) * 100) : 50;
  return `<div class="stage">
    <span class="stage-label">${label}</span>
    <div class="stage-bar-wrap">
      <div class="stage-bar ${cssClass}" style="width:${pct}%">${fmtDur(durationS)}</div>
    </div>
    <span class="stage-dur">${fmtDur(durationS)}</span>
  </div>`;
}

function renderTimeline(session) {
  const tl = session.timeline || [];
  if (tl.length === 0) return '<div style="color:var(--t3);font-size:13px;padding:8px 0;">No timeline data</div>';

  const maxDur = Math.max(...tl.map(e => e.duration_s || 0), 1);
  let html = '<div class="timeline">';
  for (const ev of tl) {
    const cls = (ev.event || '').toLowerCase().replace(/[^a-z]/g, '');
    let cssClass = 'parse';
    if (cls.includes('data')) cssClass = 'data';
    else if (cls.includes('analyst')) cssClass = 'analyst';
    else if (cls.includes('generate')) cssClass = 'generate';
    else if (cls.includes('validat')) cssClass = 'validate';
    else if (cls.includes('explain')) cssClass = 'explain';
    else if (cls.includes('retry') || cls.includes('snipe')) cssClass = 'retry';

    html += stageBarHtml(ev.event || '?', cssClass, ev.duration_s || 0, maxDur);
    if (ev.details) {
      html += `<div style="padding-left:88px;font-size:11px;color:var(--t3);margin-top:-2px;margin-bottom:3px;font-family:var(--mono)">${esc(ev.details)}</div>`;
    }
    if (cls.includes('generate') && ev.workers) {
      html += '<div class="parallel-group">';
      for (const w of ev.workers) {
        const wPct = maxDur > 0 ? Math.max(3, ((w.duration_s || 0) / maxDur) * 100) : 20;
        html += `<div class="stage">
          <span class="stage-label">W${w.worker_id}</span>
          <div class="stage-bar-wrap">
            <div class="stage-bar generate" style="width:${wPct}%">${esc(w.strategy || '?')}</div>
          </div>
          <span class="stage-dur">${fmtDur(w.duration_s)}</span>
        </div>`;
      }
      html += '</div>';
    }
  }
  html += '</div>';
  return html;
}

function renderWorkerTable(session) {
  const workers = session.workers || [];
  if (workers.length === 0) return '';

  let html = `<table class="results-table">
    <thead><tr>
      <th>Worker</th><th>Strategy</th><th>Speedup</th><th>Status</th>
      <th>Transforms</th><th>Examples</th>
    </tr></thead><tbody>`;

  for (const w of workers) {
    const isBest = w.worker_id === session.best_worker_id;
    const rowClass = isBest ? 'best-row' : '';
    const sp = w.speedup || 0;
    const transforms = (w.transforms || []).map(t => `<span class="tag transform">${esc(t)}</span>`).join('');
    const examples = (w.examples_used || []).map(e => `<span class="tag" style="background:var(--bg-subtle);color:var(--t3)">${esc(e)}</span>`).join('');

    html += `<tr class="${rowClass}" data-wid="${w.worker_id}" onclick="toggleWorkerDetail(this)">
      <td style="font-weight:600;font-family:var(--mono)">W${w.worker_id}${isBest ? ' \u2605' : ''}${w.exploratory ? ' <span style="color:var(--amber);font-size:10px;font-weight:700">EXPLORE</span>' : ''}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--purple)">${esc(w.strategy || '?')}</td>
      <td class="speedup ${speedupClass(sp)}">${fmtSpeedup(sp)}</td>
      <td><span class="badge ${statusClass(w.status)}">${w.status || '?'}</span></td>
      <td style="font-size:12px">${transforms || '<span style="color:var(--t3)">\u2014</span>'}</td>
      <td style="font-size:12px">${examples || '<span style="color:var(--t3)">\u2014</span>'}</td>
    </tr>
    <tr><td colspan="6" style="padding:0;border:none">
      <div class="worker-detail" id="wd-${session.query_id}-${w.worker_id}">
        ${w.error_message ? `<div class="error-msg">${esc(w.error_message)}</div>` : ''}
        ${w.hint ? `<div style="font-size:13px;color:var(--t2);margin-bottom:10px;font-style:italic">${esc(w.hint)}</div>` : ''}
        <h4>Optimized SQL</h4>
        <pre>${esc(w.optimized_sql || 'No SQL available')}</pre>
      </div>
    </td></tr>`;
  }

  html += '</tbody></table>';
  return html;
}

function toggleWorkerDetail(row) {
  const wid = row.getAttribute('data-wid');
  const card = row.closest('.card');
  const qid = card.getAttribute('data-qid');
  const detail = document.getElementById('wd-' + qid + '-' + wid);
  if (detail) detail.classList.toggle('open');
}

function renderSwarmCard(session) {
  const status = effectiveStatus(session);
  const sp = session.best_speedup || 0;
  const strategy = session.best_strategy || '';
  const totalTime = session.total_duration_s;
  const valMode = session.validation_mode || '';
  const raceBadge = valMode ? `<span class="race-badge ${valMode}">${valMode}</span>` : '';
  const baselineMs = session.baseline_ms;
  const baselineStr = baselineMs ? `baseline: ${baselineMs.toFixed(0)}ms` : '';

  const card = document.createElement('div');
  card.className = 'card';
  card.setAttribute('data-qid', session.query_id);
  card.setAttribute('data-status', status.toLowerCase());
  card.setAttribute('data-speedup', sp);
  card.setAttribute('data-duration', totalTime || 0);

  card.innerHTML = `
    <div class="card-header" onclick="this.parentElement.classList.toggle('open')">
      <span class="expand-icon">\u25B6</span>
      <span class="qid"><span>${esc(session.query_id)}</span></span>
      <span class="badge ${statusClass(status)}">${status}</span>
      <span class="speedup ${speedupClass(sp)}">${sp > 0 ? fmtSpeedup(sp) : '\u2014'}</span>
      <span class="strategy">${esc(strategy)}</span>
      ${raceBadge}
      <span class="detail">${baselineStr}</span>
      <span class="timing">${totalTime ? fmtDur(totalTime) : ''} \u00b7 ${session.n_iterations || 0} iter \u00b7 ${session.n_api_calls || 0} calls</span>
    </div>
    <div class="card-body">
      ${renderTimeline(session)}
      ${renderWorkerTable(session)}
      <div class="session-footer">
        <span>Total: ${totalTime ? fmtDur(totalTime) : '?'}</span>
        <span>Iterations: ${session.n_iterations || 0}</span>
        <span>API calls: ${session.n_api_calls || 0}</span>
        <span>Workers: ${session.total_workers || 0}</span>
        <span>Target: ${session.target_speedup ? session.target_speedup.toFixed(1) + 'x' : '?'}</span>
      </div>
    </div>`;
  return card;
}

function renderSwarmCards() {
  const container = document.getElementById('cards');
  container.innerHTML = '';

  let sessions = [...(DATA.sessions || [])];
  if (sessions.length === 0) {
    container.innerHTML = '<div class="empty"><h2>No swarm sessions found</h2></div>';
    return;
  }

  const filter = document.getElementById('filter-select').value;
  if (filter !== 'all') {
    sessions = sessions.filter(s => effectiveStatus(s).toLowerCase() === filter);
  }

  const search = document.getElementById('search-input').value.toLowerCase();
  if (search) {
    sessions = sessions.filter(s =>
      (s.query_id || '').toLowerCase().includes(search) ||
      (s.best_strategy || '').toLowerCase().includes(search));
  }

  const sort = document.getElementById('sort-select').value;
  const statusOrder = { 'WIN': 0, 'IMPROVED': 1, 'NEUTRAL': 2, 'REGRESSION': 3, 'ERROR': 4 };
  sessions.sort((a, b) => {
    switch (sort) {
      case 'speedup-desc': return (b.best_speedup || 0) - (a.best_speedup || 0);
      case 'speedup-asc': return (a.best_speedup || 0) - (b.best_speedup || 0);
      case 'status': return (statusOrder[effectiveStatus(a)] || 9) - (statusOrder[effectiveStatus(b)] || 9);
      case 'duration': return (b.total_duration_s || 0) - (a.total_duration_s || 0);
      default: return (a.query_id || '').localeCompare(b.query_id || '');
    }
  });

  for (const s of sessions) container.appendChild(renderSwarmCard(s));
}

// =====================================================
// Init
// =====================================================

function renderHeader() {
  const d = DATA;
  document.getElementById('title').textContent = 'QueryTorque \u2014 ' + (d.benchmark_name || 'Dashboard');
  document.getElementById('meta-engine').textContent = (d.engine || '').toUpperCase();

  const nFleet = (d.fleet_queries || []).length;
  const nSwarm = (d.sessions || []).length;
  document.getElementById('meta-queries').textContent =
    nFleet > 0 ? nFleet + ' queries' : nSwarm + ' sessions';
  document.getElementById('meta-latest').textContent = d.latest_run || '';
}

function renderAll() {
  renderHeader();

  const hasFleet = (DATA.fleet_queries || []).length > 0;
  const hasSwarm = (DATA.sessions || []).length > 0;
  const hasProfile = P && F.total_queries > 0;

  // Show swarm tab if swarm data exists
  if (hasSwarm) {
    document.getElementById('swarm-tab').style.display = '';
  }

  // Always render forensic
  renderForensic();

  // Render execution if fleet data exists
  if (hasFleet) {
    renderExecution();
  }

  // Render results
  renderResults();

  // Start on forensic tab
  switchTab('forensic');
}

// Fleet table sorting
document.querySelectorAll('#fleet-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (fleetSortCol === col) fleetSortDir *= -1;
    else {
      fleetSortCol = col;
      fleetSortDir = ['query_id','top_transform','bucket'].includes(col) ? 1 : -1;
    }
    renderFleetTable();
  });
});

// Execution filters
document.getElementById('exec-run-select').addEventListener('change', () => {
  renderExecStats();
  renderFleetTable();
});
document.getElementById('exec-bucket-filter').addEventListener('change', renderFleetTable);
document.getElementById('exec-status-filter').addEventListener('change', renderFleetTable);
document.getElementById('exec-search').addEventListener('input', renderFleetTable);

// Swarm filters
document.getElementById('sort-select').addEventListener('change', renderSwarmCards);
document.getElementById('filter-select').addEventListener('change', renderSwarmCards);
document.getElementById('search-input').addEventListener('input', renderSwarmCards);

renderAll();
</script>
</body>
</html>
