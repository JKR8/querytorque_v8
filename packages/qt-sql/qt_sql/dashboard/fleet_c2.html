<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QueryTorque — Fleet Command Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════
   QueryTorque / Dialect Labs Design System — Light Theme
   ═══════════════════════════════════════════════════════════ */
:root {
  --bg: #ffffff;
  --bg-elevated: #f8fafc;
  --bg-subtle: #f1f5f9;
  --border: #e2e8f0;
  --border-hover: #cbd5e1;
  --t1: #0f172a;
  --t2: #64748b;
  --t3: #94a3b8;
  --green: #059669;
  --green-dim: #065f46;
  --green-bg: #ecfdf5;
  --blue: #2563eb;
  --blue-dim: #1e40af;
  --blue-bg: #eff6ff;
  --amber: #f59e0b;
  --amber-bg: #fffbeb;
  --red: #ef4444;
  --red-bg: #fef2f2;
  --purple: #7c3aed;
  --purple-bg: #f5f3ff;
  --mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
  --sans: 'Inter', -apple-system, system-ui, sans-serif;
  --radius: 6px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--t1);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::selection { background: #c7d2fe; color: #0f172a; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f8fafc; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* ── Header ──────────────────────────────────────────────── */
.header {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.92);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: var(--t1);
}

.logo-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: #2563eb;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-icon svg { width: 16px; height: 16px; }

.logo-text {
  font-family: var(--mono);
  font-size: 15px;
  font-weight: 500;
}

.header-sep {
  width: 1px;
  height: 20px;
  background: var(--border);
}

.header-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--t2);
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
}

.header-meta span { white-space: nowrap; }

.header-config-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--bg);
  color: var(--t2);
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all 0.15s;
}

.header-config-btn:hover {
  color: var(--t1);
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  padding: 4px 12px;
  border-radius: 20px;
}

.status-indicator.triage {
  background: var(--blue-bg);
  color: var(--blue);
}

.status-indicator.running {
  background: var(--green-bg);
  color: var(--green);
}

.status-indicator.paused {
  background: var(--amber-bg);
  color: var(--amber);
}

.status-indicator.done {
  background: var(--green-bg);
  color: var(--green-dim);
}

/* Status dot with pulse */
.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  position: relative;
  display: inline-block;
  flex-shrink: 0;
}

.status-dot.green { background: var(--green); }
.status-dot.blue { background: var(--blue); }
.status-dot.amber { background: var(--amber); }
.status-dot.gray { background: var(--t3); }

.status-dot.pulse::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 50%;
  border: 1px solid currentColor;
  animation: pulse-ring 2s ease-out infinite;
}

.status-dot.green.pulse::after { border-color: var(--green); }
.status-dot.blue.pulse::after { border-color: var(--blue); }

@keyframes pulse-ring {
  0% { transform: scale(1); opacity: 0.4; }
  100% { transform: scale(2.5); opacity: 0; }
}

/* ── Main Container ──────────────────────────────────────── */
.main {
  max-width: 1280px;
  margin: 0 auto;
  padding: 24px 32px 48px;
}

/* ── Section Labels ──────────────────────────────────────── */
.section-label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 12px;
}

/* ── Stat Cards ──────────────────────────────────────────── */
.stat-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  min-width: 120px;
  flex: 1;
  position: relative;
  transition: border-color 0.2s;
}

.stat-card:hover { border-color: var(--border-hover); }

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  border-radius: 8px 8px 0 0;
}

.stat-card.accent-red::before { background: var(--red); }
.stat-card.accent-amber::before { background: var(--amber); }
.stat-card.accent-gray::before { background: var(--t3); }
.stat-card.accent-muted::before { background: var(--border); }
.stat-card.accent-green::before { background: var(--green); }
.stat-card.accent-blue::before { background: var(--blue); }

.stat-card .label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  display: block;
}

.stat-card .value {
  font-family: var(--mono);
  font-size: 26px;
  font-weight: 600;
  margin-top: 2px;
  display: block;
  font-variant-numeric: tabular-nums;
  color: var(--t1);
}

.stat-card .sub {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  margin-top: 2px;
}

.stat-card.green .value { color: var(--green); }
.stat-card.blue .value { color: var(--blue); }
.stat-card.red .value { color: var(--red); }
.stat-card.amber .value { color: var(--amber); }
.stat-card.muted .value { color: var(--t3); }

/* ── Buttons ─────────────────────────────────────────────── */
.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: #ffffff;
  background: #0f172a;
  border: 1px solid #0f172a;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary:hover { background: #1e293b; border-color: #1e293b; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: var(--t2);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  color: var(--t1);
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}

.btn-text {
  font-size: 14px;
  color: var(--t3);
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--sans);
  padding: 10px 16px;
  transition: color 0.2s;
}

.btn-text:hover { color: var(--t1); }

.btn-danger {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: var(--red);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-danger:hover {
  background: var(--red-bg);
  border-color: #fecaca;
}

.actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 24px;
}

/* ── Filters ─────────────────────────────────────────────── */
.filters {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.filter-input {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  outline: none;
  transition: border-color 0.15s;
  min-width: 180px;
}

.filter-input:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.filter-input::placeholder { color: var(--t3); }

.filter-select {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  outline: none;
  cursor: pointer;
  transition: border-color 0.15s;
}

.filter-select:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.filter-check {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--t3);
  cursor: pointer;
}

.filter-check input { cursor: pointer; accent-color: var(--t2); }

/* ── Tables ──────────────────────────────────────────────── */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.data-table th {
  background: var(--bg-subtle);
  color: var(--t3);
  text-align: left;
  padding: 8px 12px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  user-select: none;
}

.data-table th.sortable { cursor: pointer; }
.data-table th.sortable:hover { color: var(--t1); }

.sort-arrow {
  margin-left: 4px;
  font-size: 9px;
  opacity: 0.5;
}

.data-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

.data-table tbody tr { transition: background 0.1s; }
.data-table tbody tr:hover { background: var(--bg-elevated); }

.data-table td.mono {
  font-family: var(--mono);
  font-variant-numeric: tabular-nums;
}

.data-table td.right { text-align: right; }

.data-table td.muted { color: var(--t3); }

/* Row exclude styling */
.data-table tbody tr.excluded {
  opacity: 0.4;
}

.data-table tbody tr.excluded td { text-decoration: line-through; }
.data-table tbody tr.excluded td:first-child { text-decoration: none; }

/* Running row pulse */
.data-table tbody tr.is-running {
  background: rgba(37, 99, 235, 0.03);
}

/* ── Badges ──────────────────────────────────────────────── */
.badge {
  padding: 2px 8px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}

.badge.win { background: var(--green-bg); color: var(--green); }
.badge.improved { background: var(--blue-bg); color: var(--blue); }
.badge.neutral { background: var(--bg-subtle); color: var(--t3); }
.badge.regression { background: var(--red-bg); color: var(--red); }
.badge.error { background: var(--amber-bg); color: var(--amber); }
.badge.queued { background: var(--bg-subtle); color: var(--t3); }

.badge.running {
  background: var(--blue-bg);
  color: var(--blue);
  animation: badge-pulse 2s ease-in-out infinite;
}

@keyframes badge-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.badge.high { background: var(--red-bg); color: var(--red); }
.badge.medium { background: var(--amber-bg); color: var(--amber); }
.badge.low { background: var(--bg-subtle); color: var(--t3); }
.badge.skip { background: var(--bg-subtle); color: var(--t3); opacity: 0.6; }

/* Confidence indicators */
.confidence {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--mono);
  font-size: 12px;
}

.conf-bar {
  display: inline-flex;
  gap: 2px;
}

.conf-seg {
  width: 14px;
  height: 5px;
  border-radius: 2px;
  background: var(--border);
}

.conf-seg.filled { background: var(--green); }
.conf-seg.filled.med { background: var(--amber); }
.conf-seg.filled.low { background: var(--t3); }

/* ── Speedup display ─────────────────────────────────────── */
.speedup {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 13px;
  font-variant-numeric: tabular-nums;
}

.speedup.fast { color: var(--green); }
.speedup.slow { color: var(--red); }
.speedup.meh { color: var(--t3); }

/* ── Two-Column Layout ───────────────────────────────────── */
.split {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 900px) {
  .split { grid-template-columns: 1fr; }
}

/* ── Panel ────────────────────────────────────────────────── */
.panel {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
}

.panel-title {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 12px;
}

/* ── Worker Cards ─────────────────────────────────────────── */
.worker-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  margin-bottom: 6px;
  border-left: 3px solid var(--border);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.worker-card.active {
  border-left-color: var(--green);
  background: var(--green-bg);
}

.worker-card.idle {
  border-left-color: var(--border);
}

.worker-id {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--t2);
  min-width: 24px;
}

.worker-info {
  flex: 1;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
}

.worker-info .query-ref {
  color: var(--t1);
  font-weight: 500;
}

.worker-info .phase-ref {
  color: var(--t3);
}

.worker-time {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  font-variant-numeric: tabular-nums;
}

/* ── Queue List ───────────────────────────────────────────── */
.queue-list {
  list-style: none;
  padding: 0;
}

.queue-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
  border-bottom: 1px solid var(--bg-subtle);
}

.queue-item:last-child { border-bottom: none; }

.queue-rank {
  color: var(--t3);
  min-width: 20px;
  text-align: right;
}

.queue-more {
  font-size: 12px;
  color: var(--t3);
  padding: 6px 0;
}

/* ── Event Log ────────────────────────────────────────────── */
.event-log {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  max-height: 180px;
  overflow-y: auto;
  font-family: var(--mono);
  font-size: 12px;
  padding: 4px 0;
}

.event-entry {
  display: flex;
  gap: 10px;
  padding: 4px 14px;
  line-height: 1.5;
  border-bottom: 1px solid transparent;
}

.event-entry:hover { background: var(--bg-subtle); }

.event-ts { color: var(--t3); min-width: 64px; font-variant-numeric: tabular-nums; }
.event-target { color: var(--t1); font-weight: 500; min-width: 40px; }
.event-msg { color: var(--t2); }
.event-entry.ev-win .event-msg { color: var(--green); }
.event-entry.ev-improved .event-msg { color: var(--blue); }
.event-entry.ev-regression .event-msg { color: var(--red); }
.event-entry.ev-assign .event-msg { color: var(--blue); }
.event-entry.ev-system .event-msg { color: var(--t3); }

/* ── Backend Console (Execution) ───────────────────────────── */
.backend-console-wrap {
  border: 1px solid #111827;
  border-radius: 8px;
  background: #020617;
  overflow: hidden;
}

.backend-console-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-bottom: 1px solid #1f2937;
  background: #0b1220;
  font-family: var(--mono);
  font-size: 11px;
  color: #94a3b8;
}

.backend-console-meta {
  display: flex;
  gap: 10px;
  align-items: center;
}

.backend-console-badge {
  border: 1px solid #334155;
  color: #cbd5e1;
  border-radius: 999px;
  padding: 1px 8px;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.backend-console-badge.live {
  border-color: #065f46;
  color: #34d399;
}

.backend-console {
  max-height: 220px;
  overflow-y: auto;
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.5;
  padding: 6px 10px 10px;
}

.backend-line {
  display: grid;
  grid-template-columns: 68px 56px 68px 1fr;
  gap: 8px;
  padding: 2px 0;
  color: #e2e8f0;
  align-items: baseline;
}

.backend-ts { color: #64748b; }
.backend-lvl { color: #94a3b8; }
.backend-src { color: #93c5fd; text-transform: uppercase; }
.backend-msg { color: #cbd5e1; }
.backend-payload {
  grid-column: 4 / 5;
  color: #94a3b8;
  white-space: pre-wrap;
  word-break: break-word;
}

.backend-line.lvl-out .backend-lvl { color: #22d3ee; }
.backend-line.lvl-in .backend-lvl { color: #a78bfa; }
.backend-line.lvl-warn .backend-lvl { color: #fbbf24; }
.backend-line.lvl-error .backend-lvl { color: #f87171; }
.backend-line.lvl-system .backend-lvl { color: #34d399; }

.backend-console-clear {
  border: 1px solid #334155;
  background: #0f172a;
  color: #cbd5e1;
  border-radius: 4px;
  padding: 2px 8px;
  cursor: pointer;
  font-family: var(--mono);
  font-size: 10px;
}

.backend-console-clear:hover {
  border-color: #475569;
  color: #e2e8f0;
}

.backend-console-empty {
  color: #64748b;
  padding: 4px 0;
}

/* ── Triage Iter Select ───────────────────────────────────── */
.iter-select {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 4px;
  cursor: pointer;
  width: 50px;
  text-align: center;
}

.iter-select:focus {
  border-color: #93c5fd;
  outline: none;
}

/* ── Exclude Checkbox ─────────────────────────────────────── */
.excl-check {
  accent-color: var(--t2);
  cursor: pointer;
  width: 14px;
  height: 14px;
}

/* ── View Transitions ─────────────────────────────────────── */
.view {
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.view.active {
  display: block;
  opacity: 1;
}

.view.fade-in {
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ── Done State ───────────────────────────────────────────── */
.done-hero {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  margin-bottom: 24px;
  position: relative;
}

.done-hero::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--green);
  border-radius: 12px 12px 0 0;
}

.done-headline {
  font-family: var(--mono);
  font-size: 14px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 16px;
}

.done-savings {
  font-family: var(--mono);
  font-size: 48px;
  font-weight: 600;
  color: var(--green);
  margin-bottom: 8px;
  font-variant-numeric: tabular-nums;
}

.done-savings-label {
  font-size: 14px;
  color: var(--t2);
  margin-bottom: 10px;
}

.done-baseline {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  margin-bottom: 22px;
}

.done-stats {
  display: flex;
  justify-content: center;
  gap: 32px;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.done-stats .ds-val {
  font-weight: 600;
  color: var(--t1);
}

.done-stats .ds-green { color: var(--green); }

/* ── Estimate Row ─────────────────────────────────────────── */
.estimate-row {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  margin-bottom: 24px;
  padding: 10px 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.estimate-row span { white-space: nowrap; }

/* ── Workload Pareto Panel ───────────────────────────────── */
.workload-panel {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 16px;
  margin-bottom: 20px;
}

.workload-head {
  display: flex;
  flex-wrap: wrap;
  gap: 12px 20px;
  margin-bottom: 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
}

.workload-kv .wk-label {
  color: var(--t3);
  margin-right: 6px;
}

.workload-kv .wk-val {
  font-weight: 600;
  color: var(--t1);
}

.workload-kv .wk-val.green {
  color: var(--green);
}

.pareto-grid {
  display: grid;
  gap: 6px;
}

.pareto-row {
  display: grid;
  grid-template-columns: 86px 1fr 110px;
  gap: 10px;
  align-items: center;
}

.pareto-label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t2);
}

.pareto-track {
  height: 10px;
  border-radius: 999px;
  background: var(--bg);
  border: 1px solid var(--border);
  overflow: hidden;
}

.pareto-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #10b981);
  border-radius: 999px;
}

.pareto-meta {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  text-align: right;
}

.workload-footnote {
  margin-top: 10px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  line-height: 1.45;
}

/* ── Status Strip (Execution) ─────────────────────────────── */
.status-strip {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
}

.strip-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
}

.strip-progress {
  display: flex;
  align-items: center;
  gap: 16px;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.strip-progress .sp-val {
  font-weight: 600;
  color: var(--t1);
}

.strip-progress .sp-green { color: var(--green); font-weight: 600; }

.strip-cards {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.strip-stat {
  text-align: center;
  min-width: 72px;
  padding: 6px 12px;
  border-radius: var(--radius);
  background: var(--bg);
  border: 1px solid var(--border);
}

.strip-stat .ss-label {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.strip-stat .ss-val {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.strip-stat.ss-green .ss-val { color: var(--green); }
.strip-stat.ss-blue .ss-val { color: var(--blue); }
.strip-stat.ss-muted .ss-val { color: var(--t3); }
.strip-stat.ss-red .ss-val { color: var(--red); }
.strip-stat.ss-amber .ss-val { color: var(--amber); }

.strip-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.strip-controls-left {
  display: flex;
  gap: 8px;
}

.strip-savings {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.strip-savings .sv-amount {
  font-weight: 600;
  color: var(--green);
  font-size: 15px;
}

/* ── Active indicator ─────────────────────────────────────── */
.active-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  display: inline-block;
  animation: active-blink 1.5s ease-in-out infinite;
}

@keyframes active-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ── Table wrapper ────────────────────────────────────────── */
.table-wrap {
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

/* ── Progress bar (fleet) ─────────────────────────────────── */
.fleet-progress {
  height: 4px;
  background: var(--bg-subtle);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 20px;
}

.fleet-progress-fill {
  height: 100%;
  background: var(--green);
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* ── Detail Panel (Per-Query Dropdown) ───────────────────── */
.detail-toggle {
  cursor: pointer;
  user-select: none;
  font-size: 11px;
  color: var(--t3);
  transition: transform 0.2s;
  display: inline-block;
  width: 18px;
  text-align: center;
}

.detail-toggle.open {
  transform: rotate(90deg);
  color: var(--t1);
}

.detail-panel {
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px 16px 48px;
  display: none;
  animation: detail-slide 0.2s ease;
}

.detail-panel.open { display: table-row; }

@keyframes detail-slide {
  from { opacity: 0; }
  to { opacity: 1; }
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px 24px;
}

@media (max-width: 700px) { .detail-grid { grid-template-columns: 1fr; } }

.detail-section {
  min-width: 0;
}

.detail-section-title {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 6px;
}

.detail-kv {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 0;
  font-size: 12px;
  border-bottom: 1px solid var(--bg-subtle);
}

.detail-kv:last-child { border-bottom: none; }

.detail-kv .dk-label {
  color: var(--t3);
  font-family: var(--mono);
  font-size: 11px;
}

.detail-kv .dk-value {
  font-family: var(--mono);
  font-weight: 500;
  font-size: 12px;
}

/* Flag tags */
.flag-tag {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 3px;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  background: var(--bg-subtle);
  color: var(--t2);
  margin: 2px 3px 2px 0;
  letter-spacing: 0.02em;
}

/* Transform match rows */
.transform-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
  border-bottom: 1px solid var(--bg-subtle);
}

.transform-row:last-child { border-bottom: none; }

.transform-name {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--purple);
  font-weight: 500;
  min-width: 140px;
}

.overlap-bar-wrap {
  flex: 1;
  height: 6px;
  background: var(--bg-subtle);
  border-radius: 3px;
  overflow: hidden;
  max-width: 120px;
}

.overlap-bar {
  height: 100%;
  border-radius: 3px;
  background: var(--purple);
  transition: width 0.3s ease;
}

.overlap-pct {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  min-width: 36px;
  text-align: right;
}

.transform-gap {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  letter-spacing: 0.02em;
}

.transform-family {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  color: var(--blue);
  background: var(--blue-bg);
  padding: 0 5px;
  border-radius: 3px;
}

/* Q-error badges */
.qerror-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
}

.qerror-badge.s1 { background: var(--red-bg); color: var(--red); }
.qerror-badge.s2 { background: #fff1f2; color: #e11d48; }
.qerror-badge.s3 { background: var(--amber-bg); color: var(--amber); }
.qerror-badge.s4 { background: var(--blue-bg); color: var(--blue); }
.qerror-badge.s5 { background: var(--green-bg); color: var(--green); }

/* EXPLAIN block */
.explain-pre {
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.5;
  color: var(--t2);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px;
  max-height: 200px;
  overflow-y: auto;
  white-space: pre;
  margin-top: 6px;
}

.explain-toggle {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  cursor: pointer;
  padding: 4px 0;
  user-select: none;
}

.explain-toggle:hover { color: var(--t1); }

/* EXPLAIN bottleneck analysis */
.explain-summary {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t2);
  padding: 8px 12px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  margin-bottom: 8px;
}

.explain-node {
  display: flex;
  align-items: center;
  gap: 8px;
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.4;
  padding: 4px 8px;
  border-left: 3px solid transparent;
  border-radius: 2px;
}

.explain-node:hover { background: var(--bg-elevated); }

.explain-bottleneck {
  border-left-color: var(--red);
  background: var(--red-bg);
}

.explain-bottleneck:hover { background: #fde8e8; }

.explain-node-name {
  min-width: 0;
  flex-shrink: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--t1);
}

.explain-bar {
  width: 80px;
  min-width: 80px;
  height: 8px;
  background: var(--bg-subtle);
  border-radius: 4px;
  overflow: hidden;
}

.explain-bar-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.3s;
}

.explain-bar-fill.low { background: var(--green); }
.explain-bar-fill.mid { background: var(--amber); }
.explain-bar-fill.high { background: var(--red); }

.explain-time {
  min-width: 70px;
  text-align: right;
  color: var(--t2);
  font-variant-numeric: tabular-nums;
}

.explain-accuracy {
  min-width: 50px;
  text-align: right;
  font-variant-numeric: tabular-nums;
}

.explain-accuracy.good { color: var(--green); }
.explain-accuracy.bad { color: var(--red); }

.explain-badge {
  font-size: 9px;
  font-weight: 600;
  color: #fff;
  background: var(--red);
  padding: 1px 5px;
  border-radius: 3px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  flex-shrink: 0;
}

/* ── Tab Bar ──────────────────────────────────────────────── */
.tab-bar {
  display: flex;
  gap: 4px;
  margin-bottom: 24px;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0;
}

.tab-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 20px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  color: var(--t3);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.tab-btn:hover { color: var(--t1); }

.tab-btn.active {
  color: var(--t1);
  border-bottom-color: var(--blue);
}

.tab-btn svg {
  width: 14px;
  height: 14px;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.tab-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 18px;
  height: 18px;
  padding: 0 6px;
  border-radius: 999px;
  background: var(--bg-subtle);
  color: var(--t2);
  font-size: 10px;
  font-weight: 600;
  font-family: var(--mono);
}

/* ── Config Modal ─────────────────────────────────────────── */
.config-modal {
  position: fixed;
  inset: 0;
  z-index: 2000;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 24px;
  background: rgba(15, 23, 42, 0.55);
}

.config-modal.open {
  display: flex;
}

.config-card {
  width: min(840px, 100%);
  max-height: 86vh;
  overflow: auto;
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 24px 60px rgba(15, 23, 42, 0.2);
}

.config-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
  border-bottom: 1px solid var(--border);
}

.config-title {
  font-family: var(--mono);
  font-size: 13px;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  color: var(--t2);
}

.config-close {
  border: none;
  background: none;
  color: var(--t3);
  font-size: 20px;
  cursor: pointer;
  line-height: 1;
}

.config-close:hover { color: var(--t1); }

.config-body {
  padding: 16px 18px 18px;
  display: grid;
  gap: 14px;
}

.config-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

@media (max-width: 820px) {
  .config-grid {
    grid-template-columns: 1fr;
  }
}

.cfg-field {
  display: grid;
  gap: 6px;
}

.cfg-field label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.06em;
  text-transform: uppercase;
}

.cfg-field input,
.cfg-field select {
  width: 100%;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 10px;
  outline: none;
}

.cfg-field input:focus,
.cfg-field select:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.cfg-check {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 2px 2px;
}

.cfg-check input[type="checkbox"] {
  margin-top: 1px;
  width: 16px;
  height: 16px;
  accent-color: #2563eb;
}

.cfg-check label {
  font-size: 12px;
  color: var(--t2);
  line-height: 1.35;
}

.cfg-hint {
  font-size: 12px;
  color: var(--t3);
}

.cfg-tests {
  display: grid;
  gap: 8px;
  padding-top: 2px;
}

.cfg-test-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.cfg-test-status {
  font-family: var(--mono);
  font-size: 11px;
  letter-spacing: 0.04em;
  text-transform: uppercase;
  color: var(--t3);
}

.cfg-test-status.running { color: var(--blue); }
.cfg-test-status.pass { color: var(--green); }
.cfg-test-status.fail { color: var(--red); }

.cfg-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  padding-top: 4px;
}

/* ── Editor View ──────────────────────────────────────────── */
.editor-topbar {
  display: flex;
  align-items: center;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.editor-select {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 8px 12px;
  min-width: 220px;
  cursor: pointer;
  outline: none;
}

.editor-select:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.editor-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  flex: 1;
}

.editor-actions {
  display: flex;
  gap: 8px;
}

.btn-beam {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  font-size: 13px;
  font-weight: 500;
  font-family: var(--sans);
  color: #fff;
  background: var(--blue);
  border: 1px solid var(--blue);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-beam:hover { background: var(--blue-dim); border-color: var(--blue-dim); }
.btn-beam:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-strike {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 18px;
  font-size: 13px;
  font-weight: 500;
  font-family: var(--sans);
  color: var(--t2);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-strike:hover { color: var(--t1); border-color: var(--border-hover); background: var(--bg-elevated); }
.btn-strike:disabled { opacity: 0.5; cursor: not-allowed; }

/* Split Pane */
.editor-split {
  display: flex;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  height: 380px;
  position: relative;
}

.editor-pane {
  flex: 1;
  display: flex;
  min-width: 0;
  position: relative;
}

.editor-pane-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 12px;
  background: #1e1e2e;
  border-bottom: 1px solid #313244;
  font-family: var(--mono);
  font-size: 11px;
  color: #a6adc8;
  letter-spacing: 0.04em;
  text-transform: uppercase;
}

.editor-pane-header button {
  font-family: var(--mono);
  font-size: 10px;
  color: #89b4fa;
  background: none;
  border: 1px solid #45475a;
  border-radius: 3px;
  padding: 2px 8px;
  cursor: pointer;
  transition: all 0.15s;
}

.editor-pane-header button:hover { background: #313244; }

.editor-pane-inner {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
}

.editor-gutter {
  width: 40px;
  min-width: 40px;
  background: #181825;
  color: #585b70;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
  padding: 8px 0;
  text-align: right;
  overflow: hidden;
  user-select: none;
  white-space: pre;
}

.editor-gutter span {
  display: block;
  padding-right: 8px;
}

.editor-textarea {
  flex: 1;
  background: #1e1e2e;
  color: #cdd6f4;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
  padding: 8px 12px;
  border: none;
  outline: none;
  resize: none;
  overflow-y: auto;
  white-space: pre;
  tab-size: 2;
}

.editor-textarea::selection { background: #45475a; }
.editor-textarea::-webkit-scrollbar { width: 6px; }
.editor-textarea::-webkit-scrollbar-track { background: #1e1e2e; }
.editor-textarea::-webkit-scrollbar-thumb { background: #45475a; border-radius: 3px; }

.editor-textarea[readonly] { cursor: default; }

/* Syntax highlighting overlay */
.editor-highlight-wrap {
  position: relative;
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
}

.editor-highlight-wrap .editor-textarea {
  position: relative;
  z-index: 2;
  color: transparent;
  caret-color: #cdd6f4;
  background: transparent;
}

.editor-highlight-wrap .editor-textarea::placeholder {
  color: #585b70;
}

.editor-highlight {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 1;
  pointer-events: none;
  font-family: var(--mono);
  font-size: 12px;
  line-height: 1.6;
  padding: 8px 12px;
  margin: 0;
  background: #1e1e2e;
  color: #cdd6f4;
  white-space: pre;
  overflow-y: auto;
  overflow-x: hidden;
  border: none;
  tab-size: 2;
}

.editor-highlight code {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  background: none;
}

.sql-kw { color: #89b4fa; font-weight: 500; }
.sql-fn { color: #f9e2af; }
.sql-str { color: #a6e3a1; }
.sql-num { color: #fab387; }
.sql-comment { color: #585b70; font-style: italic; }
.sql-op { color: #cba6f7; }

.editor-body {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

/* Divider */
.editor-divider {
  width: 4px;
  background: #313244;
  cursor: col-resize;
  flex-shrink: 0;
  transition: background 0.15s;
}

.editor-divider:hover, .editor-divider.dragging { background: #89b4fa; }

/* Spinner overlay */
.editor-spinner {
  position: absolute;
  inset: 0;
  background: rgba(30, 30, 46, 0.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10;
  border-radius: 8px;
}

.editor-spinner.active { display: flex; }

.editor-spinner-inner {
  text-align: center;
  color: #cdd6f4;
  font-family: var(--mono);
  font-size: 13px;
}

.editor-spinner-ring {
  width: 32px;
  height: 32px;
  border: 3px solid #45475a;
  border-top-color: #89b4fa;
  border-radius: 50%;
  animation: espin 0.8s linear infinite;
  margin: 0 auto 12px;
}

@keyframes espin {
  to { transform: rotate(360deg); }
}

/* Context Panel */
.editor-context {
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-top: 16px;
  overflow: hidden;
}

.editor-context-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  user-select: none;
}

.editor-context-header:hover { background: var(--bg-subtle); }

.editor-context-title {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-weight: 500;
}

.editor-context-toggle {
  font-size: 10px;
  color: var(--t3);
  transition: transform 0.2s;
}

.editor-context-toggle.open { transform: rotate(180deg); }

.editor-context-body {
  max-height: 35vh;
  overflow-y: auto;
  display: none;
}

.editor-context-body.open { display: block; }

.editor-subtabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  background: var(--bg-elevated);
}

.editor-subtab {
  padding: 6px 16px;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  transition: all 0.15s;
}

.editor-subtab:hover { color: var(--t1); }
.editor-subtab.active { color: var(--t1); border-bottom-color: var(--blue); }

.editor-subtab-content {
  display: none;
  padding: 12px 16px;
}

.editor-subtab-content.active { display: block; }

/* Result cards */
.editor-result-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  border-left: 3px solid var(--t3);
  padding: 10px 14px;
  margin-bottom: 6px;
  cursor: pointer;
  transition: all 0.15s;
  display: flex;
  align-items: center;
  gap: 12px;
}

.editor-result-card:hover { border-color: var(--border-hover); background: var(--bg-elevated); }
.editor-result-card.win { border-left-color: var(--green); }
.editor-result-card.improved { border-left-color: var(--blue); }
.editor-result-card.neutral { border-left-color: var(--t3); }
.editor-result-card.regression { border-left-color: var(--red); }

.editor-result-info {
  flex: 1;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
}

.editor-result-info strong {
  color: var(--t1);
  font-weight: 600;
}

.editor-result-timing {
  font-family: var(--mono);
  font-size: 11px;
  font-variant-numeric: tabular-nums;
  text-align: right;
  white-space: nowrap;
}

.editor-result-timing .saved-pos { color: var(--green); }
.editor-result-timing .saved-neg { color: var(--red); }

.editor-step-log {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--bg);
  padding: 8px 10px;
  margin-bottom: 8px;
}

.editor-step {
  display: flex;
  gap: 8px;
  align-items: baseline;
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t2);
  padding: 2px 0;
}

.editor-step.system { color: var(--t2); }
.editor-step.error { color: var(--red); }

.editor-step-ts {
  color: var(--t3);
  min-width: 52px;
  font-variant-numeric: tabular-nums;
}

/* Edit icon in tables */
.edit-icon {
  cursor: pointer;
  color: var(--t3);
  font-size: 13px;
  transition: color 0.15s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  border-radius: 4px;
}

.edit-icon:hover { color: var(--blue); background: var(--blue-bg); }
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     HEADER
     ═══════════════════════════════════════════════════════════ -->
<header class="header">
  <div class="header-left">
    <a class="logo" href="#">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/>
        </svg>
      </div>
      <span class="logo-text">QueryTorque</span>
    </a>
    <div class="header-sep"></div>
    <span class="header-title">Fleet Command Centre</span>
  </div>
  <div class="header-meta">
    <span id="header-benchmark-name">unknown_benchmark</span>
    <span>·</span>
    <span id="header-engine-name">Unknown Engine</span>
    <span>·</span>
    <span id="header-query-count">0 queries</span>
    <span>·</span>
    <span id="header-run-id" style="font-family:var(--mono);color:var(--t3)">run: n/a</span>
    <span>·</span>
    <span id="header-mode" style="font-family:var(--mono);color:var(--t3)">mode: beam</span>
    <span>·</span>
    <span id="header-status-wrap">
      <span class="status-indicator triage" id="header-status">
        <span class="status-dot blue pulse"></span>
        TRIAGE REVIEW
      </span>
    </span>
    <span id="demo-badge" style="display:none;font-family:var(--mono);font-size:11px;font-weight:600;color:#f59e0b;background:#fffbeb;border:1px solid #fde68a;padding:3px 10px;border-radius:4px;letter-spacing:0.06em">DEMO</span>
    <button class="header-config-btn" onclick="openConfigModal()">
      <span>Config</span>
    </button>
    <a href="/help" target="_blank" title="Help &amp; Glossary" style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;border:1px solid var(--border);color:var(--t2);text-decoration:none;font-family:var(--mono);font-size:14px;font-weight:600;margin-left:8px;transition:all .15s" onmouseover="this.style.background='var(--blue-bg)';this.style.borderColor='var(--blue)';this.style.color='var(--blue)'" onmouseout="this.style.background='';this.style.borderColor='var(--border)';this.style.color='var(--t2)'">?</a>
  </div>
</header>

<div class="main">

<!-- ═══════════════════════════════════════════════════════════
     TAB BAR
     ═══════════════════════════════════════════════════════════ -->
<nav class="tab-bar">
  <button class="tab-btn active" data-tab="triage" onclick="switchTab('triage')">
    <svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
    Triage
  </button>
  <button class="tab-btn" data-tab="execution" onclick="switchTab('execution')">
    <svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    Execution
  </button>
  <button class="tab-btn" data-tab="editor" onclick="switchTab('editor')">
    <svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    Editor
  </button>
  <button class="tab-btn" data-tab="done" onclick="switchTab('done')">
    <svg viewBox="0 0 24 24"><path d="M20 7L9 18l-5-5"/></svg>
    Results
    <span class="tab-pill" id="results-count">0</span>
  </button>
</nav>

<!-- ═══════════════════════════════════════════════════════════
     STATE 1: TRIAGE REVIEW
     ═══════════════════════════════════════════════════════════ -->
<div class="view active fade-in" id="view-triage">

  <div class="section-label">Workload Analysis</div>

  <!-- Stat Cards -->
  <div class="stat-row">
    <div class="stat-card accent-red">
      <span class="label">High Impact</span>
      <span class="value" id="triage-high">4</span>
      <span class="sub">5 rounds each</span>
    </div>
    <div class="stat-card accent-amber">
      <span class="label">Medium</span>
      <span class="value" id="triage-med">6</span>
      <span class="sub">3 rounds each</span>
    </div>
    <div class="stat-card accent-gray">
      <span class="label">Low</span>
      <span class="value" id="triage-low">6</span>
      <span class="sub">1 round each</span>
    </div>
    <div class="stat-card accent-muted muted">
      <span class="label">Skip</span>
      <span class="value" id="triage-skip">4</span>
      <span class="sub">&lt;100ms</span>
    </div>
    <div class="stat-card accent-green green">
      <span class="label">Est. Annual Savings</span>
      <span class="value" id="triage-savings">$148,800</span>
      <span class="sub">based on workload analysis</span>
    </div>
  </div>

  <!-- Estimates -->
  <div class="estimate-row">
    <span>Concurrency: <strong>4 workers</strong></span>
    <span>·</span>
    <span>Est. time: <strong>~18 min</strong></span>
    <span>·</span>
    <span>Est. API calls: <strong>~96</strong></span>
    <span>·</span>
    <span>Est. cost: <strong>$1.92</strong> (DeepSeek R1)</span>
  </div>

  <div class="workload-panel">
    <div class="workload-head">
      <div class="workload-kv">
        <span class="wk-label">Estimated Workload Cost</span>
        <span class="wk-val" id="triage-workload-cost">$0</span>
      </div>
      <div class="workload-kv">
        <span class="wk-label">Projected Savings</span>
        <span class="wk-val green" id="triage-projected-savings">$0</span>
      </div>
      <div class="workload-kv">
        <span class="wk-label">Pareto</span>
        <span class="wk-val" id="triage-pareto-8020">--</span>
      </div>
    </div>
    <div class="pareto-grid" id="triage-pareto-bars"></div>
    <div class="workload-footnote" id="triage-assumptions"></div>
  </div>

  <div class="section-label">Deployment Plan</div>

  <!-- Filters -->
  <div class="filters">
    <input type="text" class="filter-input" id="triage-search" placeholder="Search queries...">
    <select class="filter-select" id="triage-bucket-filter">
      <option value="">All buckets</option>
      <option value="HIGH">High Impact</option>
      <option value="MEDIUM">Medium</option>
      <option value="LOW">Low</option>
      <option value="SKIP">Skip</option>
    </select>
    <label class="filter-check">
      <input type="checkbox" id="triage-show-skip"> Show skipped queries
    </label>
  </div>

  <!-- Triage Table -->
  <div class="table-wrap">
    <table class="data-table" id="triage-table">
      <thead>
        <tr>
          <th style="width:36px"></th>
          <th class="sortable" data-sort="query_id">Query</th>
          <th class="sortable" data-sort="runtime_ms" style="text-align:right">Runtime</th>
          <th class="sortable" data-sort="est_annual" style="text-align:right">Est. Annual Cost</th>
          <th>Bucket</th>
          <th style="text-align:center">Rounds</th>
          <th>Top Transform</th>
          <th>Confidence</th>
          <th style="width:36px"></th>
        </tr>
      </thead>
      <tbody id="triage-tbody"></tbody>
    </table>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-primary" id="btn-approve" onclick="approveAndDeploy()">
      Approve &amp; Deploy
    </button>
    <button class="btn-secondary" id="btn-demo-run" onclick="runUiDemo()">
      Run UI Demo
    </button>
    <button class="btn-secondary" onclick="exportPlan()">
      Export Plan
    </button>
    <button class="btn-text">Cancel</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     STATE 2: EXECUTION CONTROL
     ═══════════════════════════════════════════════════════════ -->
<div class="view" id="view-execution">

  <!-- Progress Bar -->
  <div class="fleet-progress">
    <div class="fleet-progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <!-- Status Strip -->
  <div class="status-strip">
    <div class="strip-top">
      <div class="strip-progress">
        <span>Done <span class="sp-val" id="exec-done">0</span>/<span id="exec-total">16</span></span>
        <span>Active <span class="sp-val" id="exec-active">0</span></span>
        <span>Queued <span class="sp-val" id="exec-queued">16</span></span>
      </div>
      <div class="strip-cards">
        <div class="strip-stat ss-green"><div class="ss-label">Wins</div><div class="ss-val" id="exec-wins">0</div></div>
        <div class="strip-stat ss-blue"><div class="ss-label">Improved</div><div class="ss-val" id="exec-improved">0</div></div>
        <div class="strip-stat ss-muted"><div class="ss-label">Neutral</div><div class="ss-val" id="exec-neutral">0</div></div>
        <div class="strip-stat ss-red"><div class="ss-label">Regress</div><div class="ss-val" id="exec-regress">0</div></div>
        <div class="strip-stat ss-amber"><div class="ss-label">Error</div><div class="ss-val" id="exec-errors">0</div></div>
        <div class="strip-stat"><div class="ss-label">Clock</div><div class="ss-val" id="exec-clock">0:00</div></div>
      </div>
    </div>
    <div class="strip-controls">
      <div class="strip-controls-left">
        <button class="btn-secondary" id="btn-pause" onclick="togglePause()">Pause All</button>
      </div>
      <div class="strip-savings">
        Workload Cost: <span class="sv-amount" id="exec-workload-cost">$0</span>
        <span style="margin:0 8px;color:var(--t3)">·</span>
        Projected Savings: <span class="sv-amount" id="exec-savings">$0</span>
        <span style="margin-left:8px;color:var(--t3)">API calls: <span id="exec-api">0</span></span>
      </div>
    </div>
  </div>

  <!-- Split: Query Table + Resources -->
  <div class="split">
    <!-- Left: Query Table -->
    <div>
      <div class="section-label">Queries</div>
      <div class="filters">
        <input type="text" class="filter-input" id="exec-search" placeholder="Search queries..." oninput="renderExecTable()">
        <select class="filter-select" id="exec-status-filter" onchange="renderExecTable()">
          <option value="">All statuses</option>
          <option value="WIN">Win</option>
          <option value="IMPROVED">Improved</option>
          <option value="NEUTRAL">Neutral</option>
          <option value="REGRESSION">Regression</option>
          <option value="RUNNING">Running</option>
          <option value="QUEUED">Queued</option>
        </select>
        <select class="filter-select" id="exec-bucket-filter" onchange="renderExecTable()">
          <option value="">All buckets</option>
          <option value="HIGH">High</option>
          <option value="MEDIUM">Medium</option>
          <option value="LOW">Low</option>
        </select>
      </div>
      <div class="table-wrap">
        <table class="data-table" id="exec-table">
          <thead>
            <tr>
              <th class="sortable" data-esort="query_id">Query</th>
              <th>Status</th>
              <th class="sortable" data-esort="speedup" style="text-align:right">Speedup</th>
              <th>Bucket</th>
              <th>Phase</th>
              <th style="text-align:right">Elapsed</th>
              <th style="text-align:center;width:36px"></th>
              <th style="width:36px"></th>
            </tr>
          </thead>
          <tbody id="exec-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Right: Resources -->
    <div>
      <div class="section-label">Worker Pool</div>
      <div id="worker-pool">
        <div class="worker-card idle" id="wc-1">
          <span class="status-dot gray"></span>
          <span class="worker-id">W1</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-2">
          <span class="status-dot gray"></span>
          <span class="worker-id">W2</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-3">
          <span class="status-dot gray"></span>
          <span class="worker-id">W3</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-4">
          <span class="status-dot gray"></span>
          <span class="worker-id">W4</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
      </div>

      <div class="section-label" style="margin-top:20px">Queue <span id="queue-count" style="color:var(--t3)"></span></div>
      <div class="panel" id="queue-panel" style="padding:8px 14px">
        <ul class="queue-list" id="queue-list"></ul>
      </div>
    </div>
  </div>

  <div class="section-label">Backend Console</div>
  <div class="backend-console-wrap">
    <div class="backend-console-toolbar">
      <div class="backend-console-meta">
        <span class="backend-console-badge" id="backend-console-badge">offline</span>
        <span id="backend-console-meta">0 lines</span>
      </div>
      <button class="backend-console-clear" onclick="clearBackendConsole()" title="Clear console log">Clear</button>
    </div>
    <div class="backend-console" id="backend-console"></div>
  </div>

  <!-- Event Log -->
  <div class="section-label">Event Log</div>
  <div class="event-log" id="event-log"></div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     STATE 3: DONE
     ═══════════════════════════════════════════════════════════ -->
<div class="view" id="view-done">
  <div class="done-hero">
    <div class="done-headline">Fleet Complete</div>
    <div class="done-savings" id="done-savings">$0</div>
    <div class="done-savings-label">estimated annualised savings</div>
    <div class="done-baseline">modeled workload cost: <span id="done-workload-cost">$0</span></div>
    <div class="done-stats">
      <span><span class="ds-val" id="done-total">0</span> queries analysed</span>
      <span><span class="ds-val ds-green" id="done-optimized">0</span> optimized</span>
      <span><span class="ds-val" id="done-regressions">0</span> regressions</span>
      <span>in <span class="ds-val" id="done-time">0:00</span></span>
    </div>
  </div>

  <!-- Final results table -->
  <div class="section-label">Results</div>
  <div class="table-wrap">
    <table class="data-table" id="done-table">
      <thead>
        <tr>
          <th>Query</th>
          <th>Status</th>
          <th style="text-align:right">Speedup</th>
          <th>Bucket</th>
          <th>Transform</th>
          <th style="text-align:right">Annual Savings</th>
        </tr>
      </thead>
      <tbody id="done-tbody"></tbody>
    </table>
  </div>

  <div class="section-label">Confirmed Outcome Log</div>
  <div class="event-log" id="results-log"></div>

  <div class="actions">
    <button class="btn-primary" onclick="exportResults()">Download Report</button>
    <button class="btn-secondary" onclick="location.reload()">New Fleet Run</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     CONFIG MODAL
     ═══════════════════════════════════════════════════════════ -->
<div class="config-modal" id="config-modal" onclick="configModalBackdrop(event)">
  <div class="config-card">
    <div class="config-head">
      <div class="config-title">Run Configuration</div>
      <button class="config-close" onclick="closeConfigModal()" title="Close">&times;</button>
    </div>
    <div class="config-body">
      <div class="config-grid">
        <div class="cfg-field">
          <label for="cfg-engine-profile">Engine Profile</label>
          <select id="cfg-engine-profile" onchange="onEngineProfileChanged()">
            <option value="duckdb">DuckDB</option>
            <option value="postgresql">PostgreSQL</option>
            <option value="snowflake">Snowflake</option>
            <option value="databricks">Databricks</option>
          </select>
        </div>
        <div class="cfg-field">
          <label for="cfg-db-dsn">Database DSN / Path</label>
          <input id="cfg-db-dsn" type="text" placeholder="postgresql://user@host/db or /path/to.duckdb">
        </div>
        <div class="cfg-field">
          <label for="cfg-benchmark-dir">Benchmark / Query Folder</label>
          <input id="cfg-benchmark-dir" type="text" placeholder="/repos/my-benchmark">
        </div>
      </div>

      <div class="config-grid">
        <div class="cfg-field">
          <label for="cfg-source-mode">Source Mode</label>
          <select id="cfg-source-mode" onchange="toggleConfigSourceMode()">
            <option value="local">Local Folder</option>
            <option value="git">Git Repository</option>
          </select>
        </div>
        <div class="cfg-field">
          <label for="cfg-explain-policy">Plan Collection Policy</label>
          <select id="cfg-explain-policy">
            <option value="explain">EXPLAIN only (safe default)</option>
            <option value="explain_analyze_if_allowed">EXPLAIN ANALYZE if allowed</option>
            <option value="explain_analyze_force">Always EXPLAIN ANALYZE</option>
          </select>
        </div>
      </div>

      <div class="cfg-field" id="cfg-local-path-wrap">
        <label for="cfg-local-path">Local Source Path</label>
        <input id="cfg-local-path" type="text" placeholder="/repos/my-app">
      </div>

      <div id="cfg-git-wrap" style="display:none">
        <div class="config-grid">
          <div class="cfg-field">
            <label for="cfg-git-url">Git URL</label>
            <input id="cfg-git-url" type="text" placeholder="https://github.com/org/repo.git">
          </div>
          <div class="cfg-field">
            <label for="cfg-git-branch">Git Branch</label>
            <input id="cfg-git-branch" type="text" placeholder="main">
          </div>
        </div>
      </div>

      <div class="cfg-check">
        <input id="cfg-use-blackboard" type="checkbox" checked>
        <label for="cfg-use-blackboard">
          Use blackboard/beam history for triage scoring and seed SQL execution.
        </label>
      </div>

      <div class="cfg-hint">
        Settings are stored in browser local storage and sent to backend control plane for run context.
      </div>

      <div class="cfg-tests">
        <div class="cfg-test-row">
          <button class="btn-secondary" id="cfg-test-db-btn" onclick="testConfigConnection('db')">Test DB Connection</button>
          <span class="cfg-test-status" id="cfg-test-db-status">not tested</span>
        </div>
        <div class="cfg-test-row">
          <button class="btn-secondary" id="cfg-test-llm-btn" onclick="testConfigConnection('llm')">Test LLM Connection</button>
          <span class="cfg-test-status" id="cfg-test-llm-status">not tested</span>
        </div>
      </div>

      <div class="cfg-actions">
        <button class="btn-secondary" onclick="closeConfigModal()">Cancel</button>
        <button class="btn-primary" onclick="saveConfigSettings()">Save Settings</button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     STATE 4: EDITOR
     ═══════════════════════════════════════════════════════════ -->
<div class="view" id="view-editor">

  <!-- Top Bar -->
  <div class="editor-topbar">
    <select class="editor-select" id="editor-query-select" onchange="editorSelectQuery(this.value)">
      <option value="">Select a query...</option>
    </select>
    <div class="editor-meta" id="editor-meta"></div>
    <select class="editor-select" id="editor-strategy-select" style="min-width:180px" onchange="editorStrategyChanged()">
      <option value="" disabled selected>Select strategy...</option>
    </select>
    <div class="editor-actions">
      <button class="btn-beam" id="btn-beam" onclick="editorFireBeam()" disabled>
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        Fire Beam
      </button>
      <button class="btn-strike" id="btn-strike" onclick="editorFireStrike()" disabled>
        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
        Fire Strike
      </button>
    </div>
  </div>

  <!-- Split Pane: Original + Rewrite -->
  <div class="editor-split" id="editor-split">
    <!-- Left pane: Original SQL (readonly) -->
    <div class="editor-pane" id="editor-pane-left" style="flex:1">
      <div class="editor-pane-inner">
        <div class="editor-pane-header">
          <span>Original SQL</span>
          <button onclick="editorCopyOriginal()" title="Copy to clipboard">Copy</button>
        </div>
        <div class="editor-body">
          <div class="editor-gutter" id="editor-gutter-left"></div>
          <div class="editor-highlight-wrap">
            <pre class="editor-highlight" id="editor-highlight-left"><code></code></pre>
            <textarea class="editor-textarea" id="editor-original" readonly placeholder="Select a query to load SQL..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Divider -->
    <div class="editor-divider" id="editor-divider"></div>

    <!-- Right pane: Rewrite SQL (editable) -->
    <div class="editor-pane" id="editor-pane-right" style="flex:1">
      <div class="editor-pane-inner">
        <div class="editor-pane-header">
          <span>Rewrite SQL</span>
          <button onclick="editorResetRewrite()">Reset to Original</button>
        </div>
        <div class="editor-body">
          <div class="editor-gutter" id="editor-gutter-right"></div>
          <div class="editor-highlight-wrap">
            <pre class="editor-highlight" id="editor-highlight-right"><code></code></pre>
            <textarea class="editor-textarea" id="editor-rewrite" placeholder="Optimized SQL will appear here..."></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- Spinner overlay -->
    <div class="editor-spinner" id="editor-spinner">
      <div class="editor-spinner-inner">
        <div class="editor-spinner-ring"></div>
        <div id="editor-spinner-text">Optimizing...</div>
      </div>
    </div>
  </div>

  <!-- Context Panel -->
  <div class="editor-context">
    <div class="editor-context-header" onclick="toggleEditorContext()">
      <span class="editor-context-title">Query Context</span>
      <span class="editor-context-toggle open" id="editor-ctx-toggle">&#9660;</span>
    </div>
    <div class="editor-context-body open" id="editor-ctx-body">
      <div class="editor-subtabs">
        <button class="editor-subtab active" data-panel="explain" onclick="editorSubTab('explain')">EXPLAIN</button>
        <button class="editor-subtab" data-panel="transforms" onclick="editorSubTab('transforms')">Transforms</button>
        <button class="editor-subtab" data-panel="knowledge" onclick="editorSubTab('knowledge')">Knowledge</button>
        <button class="editor-subtab" data-panel="results" onclick="editorSubTab('results')">Results</button>
      </div>
      <div class="editor-subtab-content active" id="editor-panel-explain">
        <div id="editor-explain-container" style="max-height:25vh;overflow-y:auto">
          <div style="color:var(--t3);font-size:12px;padding:12px">No query selected</div>
        </div>
      </div>
      <div class="editor-subtab-content" id="editor-panel-transforms">
        <div id="editor-transforms-content" style="font-size:12px;color:var(--t3)">No query selected</div>
      </div>
      <div class="editor-subtab-content" id="editor-panel-knowledge">
        <div id="editor-knowledge-content" style="font-size:12px;color:var(--t3)">No query selected</div>
      </div>
      <div class="editor-subtab-content" id="editor-panel-results">
        <div id="editor-results-content" style="font-size:12px;color:var(--t3)">Run an optimization to see results</div>
      </div>
    </div>
  </div>

</div>

</div><!-- /main -->

<!-- ═══════════════════════════════════════════════════════════
     JAVASCRIPT
     ═══════════════════════════════════════════════════════════ -->
<!-- Injected by ws_server.py in live mode; empty in standalone -->
<script type="application/json" id="fleet-data">__FLEET_DATA__</script>

<script>
// ── Data Injection ──────────────────────────────────────────
// When served by ws_server.py, #fleet-data contains real JSON.
// In standalone mode, the placeholder string is detected and mock data is used.
const _MOCK = [
  { id:'q88',  runtime_ms:45200, bucket:'HIGH',   iters:5, transform:'or_to_union',       overlap:0.92, est_annual:54240, outcome:'WIN',        speedup:6.28, out_transform:'or_to_union', sql:'SELECT *\nFROM (\n  SELECT count(*) h8_30_to_9\n  FROM store_sales, household_demographics, time_dim, store\n  WHERE ss_sold_time_sk = time_dim.t_time_sk\n    AND ss_hdemo_sk = household_demographics.hd_demo_sk\n    AND ss_store_sk = s_store_sk\n    AND time_dim.t_hour = 8\n    AND time_dim.t_minute >= 30\n    AND (\n      (household_demographics.hd_dep_count = 3\n       AND household_demographics.hd_vehicle_count <= 3+2)\n      OR\n      (household_demographics.hd_dep_count = 0\n       AND household_demographics.hd_vehicle_count <= 0+2)\n      OR\n      (household_demographics.hd_dep_count = 1\n       AND household_demographics.hd_vehicle_count <= 1+2)\n    )\n    AND store.s_store_name = \'ese\'\n) s1,\n(\n  SELECT count(*) h9_to_9_30\n  FROM store_sales, household_demographics, time_dim, store\n  WHERE ss_sold_time_sk = time_dim.t_time_sk\n    AND ss_hdemo_sk = household_demographics.hd_demo_sk\n    AND ss_store_sk = s_store_sk\n    AND time_dim.t_hour = 9\n    AND time_dim.t_minute < 30\n    AND (\n      (household_demographics.hd_dep_count = 3\n       AND household_demographics.hd_vehicle_count <= 3+2)\n      OR\n      (household_demographics.hd_dep_count = 0\n       AND household_demographics.hd_vehicle_count <= 0+2)\n      OR\n      (household_demographics.hd_dep_count = 1\n       AND household_demographics.hd_vehicle_count <= 1+2)\n    )\n    AND store.s_store_name = \'ese\'\n) s2;',
    detail:{ cost_rank:1, pct_of_total:0.438, cumulative_pct:0.438, structural_flags:['OR_PREDICATE','MULTI_TABLE_SCAN','CORRELATED_SUBQUERY'], transforms:[{id:'or_to_union',overlap:0.92,gap:'CROSS_COLUMN_OR_DECOMPOSITION',family:'D'},{id:'scan_reduce',overlap:0.61,gap:'REDUNDANT_SCAN_ELIMINATION',family:'E'}], qerror:{severity:'S1',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:847.2}, explain:'-> Hash Join  (time=45102.3ms, rows=12847 (est 15))\n  -> Seq Scan on store_sales  (time=31200.1ms, rows=2880404 (est 2880000))\n    filter: (ss_sold_date_sk IS NOT NULL)\n  -> Hash  (time=8901.2ms)\n    -> Bitmap Heap Scan on item  (time=8400.0ms, rows=28847)\n      filter: i_category IN (\'Books\',\'Sports\',\'Music\')'} },
  { id:'q40',  runtime_ms:9800,  bucket:'HIGH',   iters:5, transform:'multi_cte_chain',   overlap:0.81, est_annual:11760, outcome:'WIN',        speedup:3.35, out_transform:'multi_cte_chain',
    detail:{ cost_rank:3, pct_of_total:0.095, cumulative_pct:0.632, structural_flags:['CTE_CHAIN','DATE_FILTER'], transforms:[{id:'multi_cte_chain',overlap:0.81,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'E'},{id:'date_cte_isolate',overlap:0.65,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'A'}], qerror:{severity:'S2',direction:'OVER_EST',worst_node:'Nested Loop',max_q_error:124.5}, explain:'-> Nested Loop  (time=9780.1ms, rows=4521 (est 562000))\n  -> CTE Scan on cte1  (time=4200.0ms, rows=4521)\n  -> Index Scan on date_dim  (time=0.01ms, rows=1 (est 1))'} },
  { id:'q50',  runtime_ms:12300, bucket:'HIGH',   iters:5, transform:'date_cte_isolate',  overlap:0.87, est_annual:14760, outcome:'WIN',        speedup:2.80, out_transform:'date_cte_isolate',
    detail:{ cost_rank:2, pct_of_total:0.119, cumulative_pct:0.557, structural_flags:['DATE_FILTER','MULTI_TABLE_SCAN'], transforms:[{id:'date_cte_isolate',overlap:0.87,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'A'},{id:'pushdown',overlap:0.52,gap:'',family:'A'}], qerror:{severity:'S2',direction:'UNDER_EST',worst_node:'Seq Scan',max_q_error:89.1}, explain:'-> Seq Scan on store_sales  (time=11800.0ms, rows=2880404 (est 28800))\n  filter: ss_sold_date_sk BETWEEN 2451911 AND 2451941'} },
  { id:'q46',  runtime_ms:8100,  bucket:'HIGH',   iters:5, transform:'dim_isolate',       overlap:0.74, est_annual:9720,  outcome:'IMPROVED',   speedup:1.49, out_transform:'dim_isolate',
    detail:{ cost_rank:4, pct_of_total:0.079, cumulative_pct:0.711, structural_flags:['MULTI_JOIN','DIM_LOOKUP'], transforms:[{id:'dim_isolate',overlap:0.74,gap:'',family:'A'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:12.3}, explain:'-> Hash Join  (time=8050.0ms, rows=8421 (est 684))\n  -> Seq Scan on store_sales  (time=5100.0ms, rows=2880404)\n  -> Hash\n    -> Seq Scan on customer_address  (time=120.0ms, rows=50000)'} },
  { id:'q1',   runtime_ms:5700,  bucket:'MEDIUM', iters:3, transform:'decorrelate',       overlap:0.71, est_annual:6840,  outcome:'NEUTRAL',    speedup:1.01, out_transform:'decorrelate',
    detail:{ cost_rank:5, pct_of_total:0.055, cumulative_pct:0.766, structural_flags:['CORRELATED_SUBQUERY'], transforms:[{id:'decorrelate',overlap:0.71,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S4',direction:'OVER_EST',worst_node:'SubPlan',max_q_error:3.2}, explain:'-> Seq Scan on store_returns  (time=5600.0ms, rows=287514)\n  filter: sr_customer_sk IS NOT NULL\n  SubPlan 1\n    -> Aggregate  (time=0.02ms, rows=1 (est 1))'} },
  { id:'q65',  runtime_ms:4200,  bucket:'MEDIUM', iters:3, transform:'pushdown',          overlap:0.68, est_annual:5040,  outcome:'IMPROVED',   speedup:1.49, out_transform:'pushdown',
    detail:{ cost_rank:6, pct_of_total:0.041, cumulative_pct:0.807, structural_flags:['LATE_FILTER'], transforms:[{id:'pushdown',overlap:0.68,gap:'',family:'A'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Seq Scan',max_q_error:18.7}, explain:'-> Seq Scan on store  (time=4100.0ms, rows=120 (est 12))\n  filter: s_state = \'TN\''} },
  { id:'q35',  runtime_ms:3800,  bucket:'MEDIUM', iters:3, transform:'early_filter',      overlap:0.65, est_annual:4560,  outcome:'WIN',        speedup:1.78, out_transform:'early_filter',
    detail:{ cost_rank:7, pct_of_total:0.037, cumulative_pct:0.844, structural_flags:['LATE_FILTER','DATE_FILTER'], transforms:[{id:'early_filter',overlap:0.65,gap:'',family:'A'},{id:'decorrelate',overlap:0.42,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:15.4}, explain:'-> Hash Join  (time=3700.0ms, rows=2841)\n  -> Seq Scan on customer  (time=200.0ms, rows=100000)\n  -> Hash\n    -> Seq Scan on store_sales  (time=3100.0ms, rows=2880404)'} },
  { id:'q80',  runtime_ms:3100,  bucket:'MEDIUM', iters:3, transform:'cte_split',         overlap:0.62, est_annual:3720,  outcome:'NEUTRAL',    speedup:1.02, out_transform:'cte_split',
    detail:{ cost_rank:8, pct_of_total:0.030, cumulative_pct:0.874, structural_flags:['CTE_CHAIN'], transforms:[{id:'cte_split',overlap:0.62,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'E'}], qerror:{severity:'S4',direction:'OVER_EST',worst_node:'CTE Scan',max_q_error:2.8}, explain:'-> CTE Scan on cte1  (time=3000.0ms, rows=24521)\n  -> CTE Scan on cte2  (time=50.0ms, rows=128)'} },
  { id:'q22',  runtime_ms:2900,  bucket:'MEDIUM', iters:3, transform:'',                  overlap:0,    est_annual:3480,  outcome:'WIN',        speedup:2.10, out_transform:'scan_reduce',
    detail:{ cost_rank:9, pct_of_total:0.028, cumulative_pct:0.902, structural_flags:['MULTI_TABLE_SCAN'], transforms:[], qerror:null, explain:'-> Seq Scan on inventory  (time=2800.0ms, rows=11745000)\n  filter: inv_quantity_on_hand BETWEEN 100 AND 500'} },
  { id:'q75',  runtime_ms:2400,  bucket:'MEDIUM', iters:3, transform:'scan_reduce',       overlap:0.55, est_annual:2880,  outcome:'REGRESSION', speedup:0.85, out_transform:'scan_reduce',
    detail:{ cost_rank:10, pct_of_total:0.023, cumulative_pct:0.925, structural_flags:['MULTI_TABLE_SCAN','UNION_BRANCH'], transforms:[{id:'scan_reduce',overlap:0.55,gap:'REDUNDANT_SCAN_ELIMINATION',family:'E'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Append',max_q_error:14.1}, explain:'-> Append  (time=2300.0ms, rows=48291)\n  -> Seq Scan on catalog_sales  (time=1200.0ms, rows=1441548)\n  -> Seq Scan on web_sales  (time=1100.0ms, rows=719384)'} },
  { id:'q42',  runtime_ms:1800,  bucket:'LOW',    iters:1, transform:'dim_isolate',       overlap:0.52, est_annual:2160,  outcome:'WIN',        speedup:2.80, out_transform:'dim_isolate',
    detail:{ cost_rank:11, pct_of_total:0.017, cumulative_pct:0.942, structural_flags:['DIM_LOOKUP'], transforms:[{id:'dim_isolate',overlap:0.52,gap:'',family:'A'}], qerror:{severity:'S4',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:4.1}, explain:'-> Hash Join  (time=1750.0ms, rows=1521)\n  -> Seq Scan on item  (time=50.0ms, rows=18000)\n  -> Hash\n    -> Seq Scan on store_sales  (time=1600.0ms, rows=2880404)'} },
  { id:'q12',  runtime_ms:1200,  bucket:'LOW',    iters:1, transform:'pushdown',          overlap:0.48, est_annual:1440,  outcome:'NEUTRAL',    speedup:1.03, out_transform:'pushdown',
    detail:{ cost_rank:12, pct_of_total:0.012, cumulative_pct:0.954, structural_flags:['LATE_FILTER'], transforms:[{id:'pushdown',overlap:0.48,gap:'',family:'A'}], qerror:{severity:'S5',direction:'OVER_EST',worst_node:'Seq Scan',max_q_error:1.2}, explain:'-> Seq Scan on web_sales  (time=1100.0ms, rows=719384)\n  filter: ws_sold_date_sk IS NOT NULL'} },
  { id:'q31',  runtime_ms:900,   bucket:'LOW',    iters:1, transform:'',                  overlap:0,    est_annual:1080,  outcome:'IMPROVED',   speedup:1.12, out_transform:'early_filter',
    detail:{ cost_rank:13, pct_of_total:0.009, cumulative_pct:0.963, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q55',  runtime_ms:700,   bucket:'LOW',    iters:1, transform:'decorrelate',       overlap:0.44, est_annual:840,   outcome:'NEUTRAL',    speedup:0.99, out_transform:'decorrelate',
    detail:{ cost_rank:14, pct_of_total:0.007, cumulative_pct:0.970, structural_flags:['CORRELATED_SUBQUERY'], transforms:[{id:'decorrelate',overlap:0.44,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S4',direction:'UNDER_EST',worst_node:'SubPlan',max_q_error:2.9}, explain:'-> SubPlan 1\n  -> Aggregate  (time=680.0ms, rows=1 (est 1))'} },
  { id:'q19',  runtime_ms:500,   bucket:'LOW',    iters:1, transform:'',                  overlap:0,    est_annual:600,   outcome:'WIN',        speedup:1.65, out_transform:'pushdown',
    detail:{ cost_rank:15, pct_of_total:0.005, cumulative_pct:0.975, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q67',  runtime_ms:400,   bucket:'LOW',    iters:1, transform:'early_filter',      overlap:0.40, est_annual:480,   outcome:'NEUTRAL',    speedup:1.00, out_transform:'early_filter',
    detail:{ cost_rank:16, pct_of_total:0.004, cumulative_pct:0.979, structural_flags:['LATE_FILTER'], transforms:[{id:'early_filter',overlap:0.40,gap:'',family:'A'}], qerror:{severity:'S5',direction:'OVER_EST',worst_node:'Seq Scan',max_q_error:1.1}, explain:''} },
  { id:'q2',   runtime_ms:80,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:96,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:17, pct_of_total:0.001, cumulative_pct:0.980, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q15',  runtime_ms:60,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:72,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:18, pct_of_total:0.001, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q33',  runtime_ms:40,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:48,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:19, pct_of_total:0.000, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q91',  runtime_ms:20,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:24,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:20, pct_of_total:0.000, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
];

// Fill in placeholder SQL for mock entries that don't have it
for (const m of _MOCK) {
  if (!m.sql) m.sql = `-- ${m.id}\nSELECT *\nFROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\nWHERE d.d_year = 2001\nORDER BY ss.ss_net_profit DESC\nLIMIT 100;`;
}

// Parse injected data from the JSON script tag; fall back to mock if placeholder
let IS_DEMO = false;
function normalizeQueryShape(q, idx = 0) {
  if (!q || typeof q !== 'object') return null;
  const id = q.id || q.query_id || q.queryId || `q_${idx + 1}`;
  const runtimeMs = Number(q.runtime_ms ?? q.runtime ?? -1);
  const overlap = Number(q.overlap ?? q.top_overlap ?? 0);
  const estAnnual = Number(q.est_annual ?? q.est_annual_cost ?? 0);
  const iters = Number(q.iters ?? q.max_iterations ?? q.rounds ?? 1);
  const detail = q.detail || {
    cost_rank: idx + 1,
    pct_of_total: 0,
    cumulative_pct: 0,
    structural_flags: [],
    transforms: Array.isArray(q.transforms)
      ? q.transforms.map(t =>
          typeof t === 'string'
            ? { id: t, overlap: Math.max(0, overlap), gap: '', family: '' }
            : t
        )
      : [],
    qerror: q.qerror || (
      q.q_error
        ? {
            severity: q.q_error_severity || '',
            direction: '',
            worst_node: '',
            max_q_error: Number(q.q_error) || 0,
          }
        : null
    ),
    explain: q.explain || '',
    actual_rows: Number(q.actual_rows ?? 0) || 0,
    timing_source: q.timing_source || '',
  };
  return {
    ...q,
    id,
    query_id: q.query_id || id,
    runtime_ms: Number.isFinite(runtimeMs) ? runtimeMs : -1,
    bucket: q.bucket || 'MEDIUM',
    iters: Number.isFinite(iters) ? iters : 1,
    transform: q.transform || q.top_transform || '',
    overlap: Number.isFinite(overlap) ? overlap : 0,
    est_annual: Number.isFinite(estAnnual) ? estAnnual : 0,
    outcome: q.outcome ?? (q.status && q.status !== 'PENDING' ? q.status : null),
    speedup: q.speedup ?? null,
    out_transform: q.out_transform || q.transform || q.top_transform || '',
    sql: q.sql || '',
    detail,
  };
}

const QUERIES = (() => {
  try {
    const el = document.getElementById('fleet-data');
    const raw = el && el.textContent.trim();
    if (raw && raw !== '__FLEET_' + 'DATA__') {
      const parsed = JSON.parse(raw);
      if (Array.isArray(parsed)) {
        return parsed.map((q, idx) => normalizeQueryShape(q, idx)).filter(Boolean);
      }
    }
  } catch (e) { console.warn('Fleet C2: failed to parse injected data', e); }
  IS_DEMO = true;
  return _MOCK;
})();

const CONFIG_STORAGE_KEY = 'fleet_c2_run_config_v1';
const ENGINE_PROFILES = ['duckdb', 'postgresql', 'snowflake', 'databricks'];
const DEFAULT_RUN_CONFIG = {
  engine_profile: 'duckdb',
  db_dsn: '',
  benchmark_dir: '',
  source_mode: 'local',
  local_path: '',
  git_url: '',
  git_branch: 'main',
  explain_policy: 'explain',
  use_blackboard_history: true,
  engine_setups: {},
};

function defaultEngineSetups() {
  const setups = {};
  for (const engine of ENGINE_PROFILES) {
    setups[engine] = {
      db_dsn: '',
      benchmark_dir: '',
      explain_policy: 'explain',
    };
  }
  return setups;
}

function normalizeRunConfig(input) {
  const cfg = { ...DEFAULT_RUN_CONFIG, ...(input || {}) };
  const profile = ENGINE_PROFILES.includes(cfg.engine_profile) ? cfg.engine_profile : 'duckdb';
  const setups = defaultEngineSetups();
  if (cfg.engine_setups && typeof cfg.engine_setups === 'object') {
    for (const engine of ENGINE_PROFILES) {
      const src = cfg.engine_setups[engine];
      if (src && typeof src === 'object') {
        setups[engine] = {
          db_dsn: String(src.db_dsn || '').trim(),
          benchmark_dir: String(src.benchmark_dir || '').trim(),
          explain_policy: String(src.explain_policy || 'explain').trim() || 'explain',
        };
      }
    }
  }
  // Backfill from legacy flat fields.
  if (!setups[profile].db_dsn && cfg.db_dsn) setups[profile].db_dsn = String(cfg.db_dsn).trim();
  if (!setups[profile].benchmark_dir && cfg.benchmark_dir) setups[profile].benchmark_dir = String(cfg.benchmark_dir).trim();
  if (!setups[profile].explain_policy && cfg.explain_policy) setups[profile].explain_policy = String(cfg.explain_policy).trim();
  return {
    ...cfg,
    engine_profile: profile,
    engine_setups: setups,
    db_dsn: setups[profile].db_dsn,
    benchmark_dir: setups[profile].benchmark_dir,
    explain_policy: setups[profile].explain_policy || 'explain',
    use_blackboard_history: cfg.use_blackboard_history !== false,
  };
}

function loadRunConfig() {
  try {
    const raw = localStorage.getItem(CONFIG_STORAGE_KEY);
    if (!raw) return normalizeRunConfig(DEFAULT_RUN_CONFIG);
    const parsed = JSON.parse(raw);
    return normalizeRunConfig(parsed);
  } catch (e) {
    return normalizeRunConfig(DEFAULT_RUN_CONFIG);
  }
}

let runConfig = loadRunConfig();
let activeRunContext = {
  run_id: '',
  benchmark_name: '',
  engine: '',
  query_count: QUERIES.length,
  mode_summary: 'beam',
  fleet_concurrency: 4,
};

if (IS_DEMO) {
  const badge = document.getElementById('demo-badge');
  if (badge) badge.style.display = 'inline-block';
}

// ── WebSocket Connection ────────────────────────────────────
let ws = null;
let wsConnected = false;
let backendLogs = [];
const BACKEND_LOG_LIMIT = 500;
let pendingConfigSync = null;

function isWsReady() {
  return !!(ws && wsConnected && ws.readyState === WebSocket.OPEN);
}

function isLiveBackendMode() {
  return !IS_DEMO && location.protocol !== 'file:';
}

function connectWebSocket() {
  if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
    return;
  }
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  const url = proto + '//' + location.host + '/ws';
  pushBackendLog(`Connecting to ${url}`, {
    level: 'system',
    lane: 'SYS',
    source: 'socket',
    payload: { url },
  });
  ws = new WebSocket(url);
  updateBackendConsoleStatus();

  ws.onopen = () => {
    wsConnected = true;
    console.log('Fleet C2: WebSocket connected');
    pushBackendLog('WebSocket connected and ready for control traffic.', {
      level: 'system',
      lane: 'SYS',
      source: 'socket',
    });
    updateBackendConsoleStatus();
    if (state === 'running') {
      addEvent('System', 'Connected to backend control plane.', 'system');
    }

    if (awaitingServerStart && pendingApprovePlan && isWsReady()) {
      if (sendWsMessage({ type: 'approve', plan: pendingApprovePlan }, 'fleet')) {
        awaitingServerStart = false;
        pendingApprovePlan = null;
        addEvent('Fleet', 'Approval sent to backend. Waiting for first worker assignment...', 'system');
      }
    }

    if (pendingEditorRequest && isWsReady()) {
      const mode = pendingEditorRequest.type === 'editor_strike' ? 'Strike' : 'Beam';
      if (sendWsMessage(pendingEditorRequest, 'editor')) {
        pushEditorStep(`${mode} request dispatched to backend.`);
        pendingEditorRequest = null;
      }
    }

    if (isWsReady() && (pendingConfigSync || runConfig)) {
      const cfg = pendingConfigSync || runConfig;
      if (sendWsMessage({ type: 'config_update', config: cfg }, 'config')) {
        pendingConfigSync = null;
      }
    }
  };

  ws.onclose = () => {
    wsConnected = false;
    console.log('Fleet C2: WebSocket disconnected, reconnecting in 2s...');
    pushBackendLog('WebSocket disconnected; retry scheduled in 2s.', {
      level: 'warn',
      lane: 'SYS',
      source: 'socket',
    });
    updateBackendConsoleStatus();
    if (state === 'running') {
      addEvent('System', 'Backend connection lost. Reconnecting...', 'error');
    }
    if (editorFiring) {
      pushEditorStep('Connection lost. Reconnecting to backend...', 'error');
    }
    setTimeout(connectWebSocket, 2000);
  };

  ws.onerror = (err) => {
    console.warn('Fleet C2: WebSocket error', err);
    pushBackendLog('WebSocket error raised by browser transport.', {
      level: 'error',
      lane: 'SYS',
      source: 'socket',
      payload: String(err),
    });
    updateBackendConsoleStatus();
  };

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      pushBackendLog(summarizeInboundMessage(msg), {
        level: 'in',
        lane: 'WS IN',
        source: msg.type || 'message',
        payload: sanitizeBackendPayload(msg),
      });
      handleServerMessage(msg);
    } catch (e) {
      console.warn('Fleet C2: bad message', e);
      pushBackendLog('Failed to parse inbound message.', {
        level: 'error',
        lane: 'WS IN',
        source: 'socket',
        payload: String(evt.data || '').slice(0, 300),
      });
    }
  };
}

function handleServerMessage(msg) {
  const type = msg.type;
  const data = msg.data || {};

  if (type === 'triage_data') {
    // Initial triage data (sent on WS connect)
    // QUERIES already populated from injected data
    setRunContext({ query_count: QUERIES.length });
    renderTriageTable();
    updateTriageStats();
  }

  else if (type === 'run_context') {
    setRunContext(data);
    const bench = data.benchmark_name || 'benchmark';
    const engine = titleCaseEngine(data.engine || runConfig.engine_profile);
    const modeTxt = data.mode_summary ? ` · ${data.mode_summary}` : '';
    addEvent('Fleet', `Connected to ${bench} (${engine}) run ${data.run_id || 'n/a'}${modeTxt}`, 'system');
  }

  else if (type === 'event_log') {
    const scope = data.scope || 'fleet';
    const target = data.target || (scope === 'editor' ? 'Editor' : 'Fleet');
    const message = data.msg || '';
    const level = data.level || 'system';
    if (!message) return;
    if (scope === 'editor') {
      pushEditorStep(`${target}: ${message}`, level);
    } else {
      addEvent(target, message, level);
    }
  }

  else if (type === 'query_update') {
    const qid = data.query_id;
    let q = execQueries.find(q => q.id === qid);
    if (!q) {
      const known = QUERIES.find(x => x.id === qid);
      if (known) {
        execQueries.push(known);
        queueOrder.push(qid);
        q = known;
        addEvent('Fleet', `Backend queued ${qid}; added to active run view.`, 'system');
      }
    }
    if (q) {
      const qPos = queueOrder.indexOf(qid);
      if (qPos >= 0) queueOrder.splice(qPos, 1);

      const wIdx = workerState.indexOf(null);
      if (wIdx >= 0 && !workerState.includes(qid)) {
        workerState[wIdx] = qid;
        workerTimers[wIdx] = 0;
        addEvent(`W${wIdx + 1}`, `Assigned ${qid}`, 'assign');
      }
      runningQueryIds.add(qid);
      if (!Number.isFinite(Number(queryStartClockById[qid]))) {
        queryStartClockById[qid] = clockSeconds;
      }

      const phase = data.phase ? String(data.phase) : '';
      if (phase && queryPhaseById[qid] !== phase) {
        queryPhaseById[qid] = phase;
        addEvent(qid, `Phase: ${humanizePhase(phase)}`, 'system');
      }
    }
    renderExecTable();
    renderWorkers();
    renderQueue();
    updateExecStats();
  }

  else if (type === 'query_complete') {
    const qid = data.query_id;
    if (!execQueries.some(q => q.id === qid)) {
      const known = QUERIES.find(x => x.id === qid);
      if (known) execQueries.push(known);
    }

    const status = data.status || 'NEUTRAL';
    const speedupVal = Number(data.speedup);
    const nApiCallsVal = Number(data.n_api_calls);
    completedSet[qid] = {
      status,
      speedup: Number.isFinite(speedupVal) ? speedupVal : 1.0,
      transform: data.transform || '',
      elapsed_s: clockSeconds,
    };
    if (Number.isFinite(nApiCallsVal) && nApiCallsVal >= 0) {
      queryApiCallsById[qid] = nApiCallsVal;
      recomputeApiCallsFromBackend();
    }
    appendResultEntry({
      query_id: qid,
      status,
      speedup: Number.isFinite(speedupVal) ? speedupVal : null,
      transform: data.transform || '',
      source: 'backend',
    });

    const qPos = queueOrder.indexOf(qid);
    if (qPos >= 0) queueOrder.splice(qPos, 1);

    // Free worker
    const wIdx = workerState.indexOf(qid);
    if (wIdx >= 0) {
      workerState[wIdx] = null;
      workerTimers[wIdx] = 0;
      addEvent(`W${wIdx + 1}`, `Freed (${qid} complete)`, 'system');
    }
    runningQueryIds.delete(qid);
    queryPhaseById[qid] = 'done';

    const speedTxt = Number.isFinite(speedupVal) ? ` ${speedupVal.toFixed(2)}x` : '';
    const transformTxt = data.transform ? ` (${data.transform})` : '';
    const apiTxt = Number.isFinite(nApiCallsVal) && nApiCallsVal > 0 ? ` · ${Math.round(nApiCallsVal)} calls` : '';
    addEvent(qid, `${status}${speedTxt}${transformTxt}${apiTxt}`, String(status).toLowerCase());
    renderExecTable();
    renderWorkers();
    renderQueue();
    updateExecStats();
    updateResultsView();

    // Check if all done
    const allDone = execQueries.every(q => completedSet[q.id]);
    if (allDone) {
      clearInterval(clockInterval);
      setTimeout(showDone, 800);
    }
  }

  else if (type === 'fleet_done') {
    addEvent('Fleet', `Run complete (${data.total || Object.keys(completedSet).length} queries). Finalizing scorecard...`, 'system');
    clearInterval(clockInterval);
    clearTimeout(simInterval);
    // Merge any final results
    if (data.results) {
      for (const r of data.results) {
        if (!completedSet[r.query_id]) {
          completedSet[r.query_id] = {
            status: r.status || 'NEUTRAL',
            speedup: r.speedup || 1.0,
            transform: '',
            elapsed_s: clockSeconds,
          };
          appendResultEntry({
            query_id: r.query_id,
            status: r.status || 'NEUTRAL',
            speedup: r.speedup || null,
            transform: '',
            source: 'fleet_done',
          });
        }
        runningQueryIds.delete(r.query_id);
        if (Number.isFinite(Number(r.n_api_calls)) && Number(r.n_api_calls) >= 0) {
          queryApiCallsById[r.query_id] = Number(r.n_api_calls);
        }
      }
    }
    recomputeApiCallsFromBackend();
    updateResultsView();
    setTimeout(showDone, 500);
  }

  else if (type === 'editor_iteration') {
    const patches = data.patches || [];
    const iteration = data.iteration || 1;
    for (const p of patches) {
      editorResults.push({
        id: `iter${iteration}-w${p.worker_id || '?'}`,
        iteration,
        worker_id: p.worker_id,
        speedup: p.speedup || 1.0,
        status: p.status || 'NEUTRAL',
        transform: p.transform || '',
        sql: p.sql || '',
      });
    }
    pushEditorStep(`Iteration ${iteration}: received ${patches.length} candidate(s).`, 'system');
    renderEditorResults();
    document.getElementById('editor-spinner-text').textContent = `Iteration ${iteration}...`;
  }

  else if (type === 'editor_complete') {
    pendingEditorRequest = null;
    editorFiring = false;
    document.getElementById('editor-spinner').classList.remove('active');
    document.getElementById('btn-beam').disabled = false;
    document.getElementById('btn-strike').disabled = false;
    if (data.error) {
      pushEditorStep(`Optimization failed: ${data.error}`, 'error');
    } else {
      const best = Number(data.best_speedup);
      const speedTxt = Number.isFinite(best) ? ` (${best.toFixed(2)}x best)` : '';
      pushEditorStep(`Optimization complete: ${data.status || 'DONE'}${speedTxt}.`, 'system');
    }
    if (data.best_sql) {
      document.getElementById('editor-rewrite').value = data.best_sql;
      updateEditorGutters();
      updateEditorHighlights();
    }
    renderEditorResults();
  }

  else if (type === 'connection_test_result') {
    const target = (data.target === 'llm') ? 'llm' : 'db';
    const ok = !!data.ok;
    const elapsed = Number.isFinite(Number(data.elapsed_ms)) ? Number(data.elapsed_ms) : 0;
    const msg = (data.message || (ok ? 'connection succeeded' : 'connection failed')).trim();
    setConfigTestPending(target, false);
    setConfigTestStatus(target, ok ? 'pass' : 'fail', `${ok ? 'connected' : 'failed'} (${elapsed}ms)`);
    addEvent('Config', `${target.toUpperCase()} test ${ok ? 'passed' : 'failed'}: ${msg}`, ok ? 'system' : 'error');
  }
}

// Auto-connect only when real backend mode is active.
if (isLiveBackendMode()) {
  try { connectWebSocket(); } catch (e) { /* standalone mode */ }
}

// ── State ───────────────────────────────────────────────────
let state = 'triage'; // triage | running | paused | done
let excludedIds = new Set();
let triageSortCol = 'runtime_ms';
let triageSortDir = -1;
let execSortCol = 'query_id';
let execSortDir = 1;
let awaitingServerStart = false;
let pendingApprovePlan = null;
let queryPhaseById = {};
let queryApiCallsById = {};
let queryStartClockById = {};
let runningQueryIds = new Set();
let currentRunMode = 'live'; // live | demo
let demoPlanById = {};

// Execution state
let execQueries = [];    // queries being executed (non-SKIP, non-excluded)
let completedSet = {};   // id → {status, speedup, transform, elapsed_s}
let workerState = [null, null, null, null]; // 4 workers, null = idle
let workerTimers = [0, 0, 0, 0];
let queueOrder = [];     // ids waiting
let clockSeconds = 0;
let clockInterval = null;
let simInterval = null;
let apiCalls = 0;
let isPaused = false;
let eventEntries = [];
let resultEntries = [];  // append-only confirmed query outcomes
let phases = ['Analyzing', 'Optimizing', 'Validating', 'Refining'];
let openDetails = new Set();
let openExplains = new Set();
let plannedSavings = 0; // Fixed estimate from approved triage plan.
let plannedWorkloadCost = 0;
let triageProjectedSavings = 0;
let triageWorkloadCost = 0;

// Editor state
let editorQueryId = '';
let editorContextCollapsed = false;
let editorActiveSubtab = 'explain';
let editorResults = [];
let editorFiring = false;
let editorDividerDragging = false;
let pendingEditorRequest = null;
let editorSteps = [];

// ── Helpers ─────────────────────────────────────────────────
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function titleCaseEngine(engine) {
  const e = String(engine || '').trim().toLowerCase();
  if (!e) return 'Unknown Engine';
  if (e === 'postgres' || e === 'postgresql') return 'PostgreSQL';
  if (e === 'duckdb') return 'DuckDB';
  if (e === 'snowflake') return 'Snowflake';
  if (e === 'databricks') return 'Databricks';
  return e.charAt(0).toUpperCase() + e.slice(1);
}

function humanizePhase(phase) {
  const p = String(phase || '').trim().toLowerCase();
  if (!p) return 'running';
  if (p === 'analyst') return 'analyst';
  if (p === 'workers') return 'worker fanout';
  if (p === 'benchmark') return 'validation/benchmark';
  if (p === 'snipe') return 'compiler/snipe';
  if (p === 'starting') return 'starting';
  if (p === 'done') return 'done';
  if (p === 'error') return 'error';
  return p;
}

function applyRunContextToHeader() {
  const benchmarkEl = document.getElementById('header-benchmark-name');
  const engineEl = document.getElementById('header-engine-name');
  const countEl = document.getElementById('header-query-count');
  const runIdEl = document.getElementById('header-run-id');
  const modeEl = document.getElementById('header-mode');
  if (benchmarkEl) benchmarkEl.textContent = activeRunContext.benchmark_name || 'unknown_benchmark';
  if (engineEl) engineEl.textContent = titleCaseEngine(activeRunContext.engine || runConfig.engine_profile);
  const qCount = Number(activeRunContext.query_count || 0) || QUERIES.length;
  if (countEl) countEl.textContent = `${qCount} quer${qCount === 1 ? 'y' : 'ies'}`;
  if (runIdEl) runIdEl.textContent = `run: ${activeRunContext.run_id || 'n/a'}`;
  if (modeEl) modeEl.textContent = `mode: ${activeRunContext.mode_summary || 'beam'}`;
}

function setRunContext(ctx) {
  if (!ctx || typeof ctx !== 'object') return;
  const benchmarkRaw = String(ctx.benchmark_name || activeRunContext.benchmark_name || '');
  const benchmarkParts = benchmarkRaw.split(/[\\/]/).filter(Boolean);
  const benchmarkName = benchmarkParts.length ? benchmarkParts[benchmarkParts.length - 1] : benchmarkRaw;
  activeRunContext = {
    ...activeRunContext,
    run_id: String(ctx.run_id || activeRunContext.run_id || ''),
    benchmark_name: benchmarkName,
    engine: String(ctx.engine || activeRunContext.engine || ''),
    query_count: Number(ctx.query_count || activeRunContext.query_count || QUERIES.length) || QUERIES.length,
    mode_summary: String(ctx.mode_summary || activeRunContext.mode_summary || 'beam'),
    fleet_concurrency: Number(ctx.fleet_concurrency || activeRunContext.fleet_concurrency || 4) || 4,
  };
  applyRunContextToHeader();
}

function recomputeApiCallsFromBackend() {
  if (!isLiveBackendMode()) return;
  apiCalls = Object.values(queryApiCallsById).reduce((sum, val) => {
    const n = Number(val);
    return sum + (Number.isFinite(n) ? n : 0);
  }, 0);
}

function fmtMs(ms) {
  if (ms < 0) return '--';
  if (ms < 1000) return ms.toFixed(0) + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmtMoney(n) {
  return '$' + Math.round(n).toLocaleString();
}

function parseMoneyTextToNumber(txt) {
  if (!txt) return NaN;
  const cleaned = String(txt).replace(/[^0-9.-]/g, '');
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}

function fmtTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return m + ':' + String(sec).padStart(2, '0');
}

const WORKLOAD_COST_MODEL = {
  cost_per_compute_second_usd: 0.00025,
  daily_frequency_by_bucket: {
    HIGH: 96,
    MEDIUM: 24,
    LOW: 6,
    SKIP: 2,
  },
  potential_savings_by_bucket: {
    HIGH: 0.38,
    MEDIUM: 0.24,
    LOW: 0.12,
    SKIP: 0.0,
  },
};

function clamp(n, lo, hi) {
  return Math.max(lo, Math.min(hi, n));
}

function queryAnnualCostEstimate(q) {
  if (!q) return 0;
  const explicit = Number(q.est_annual);
  if (Number.isFinite(explicit) && explicit > 0) return explicit;

  const runtimeMs = Number(q.runtime_ms);
  if (!Number.isFinite(runtimeMs) || runtimeMs <= 0) return 0;

  const dailyFreq = Number(WORKLOAD_COST_MODEL.daily_frequency_by_bucket[q.bucket] || 0);
  const annualExecs = Math.max(1, dailyFreq) * 365;
  const runtimeSeconds = runtimeMs / 1000;
  let modeledCost = runtimeSeconds * annualExecs * WORKLOAD_COST_MODEL.cost_per_compute_second_usd;

  const rows = Number(q.detail && q.detail.actual_rows);
  if (Number.isFinite(rows) && rows > 0) {
    // Use row count as a light pressure multiplier; cap to avoid runaway estimates.
    const rowScale = clamp(0.85 + (Math.log10(rows + 1) / 5), 0.85, 2.3);
    modeledCost *= rowScale;
  }
  return modeledCost;
}

function queryProjectedSavingsEstimate(q) {
  if (!q || q.bucket === 'SKIP') return 0;

  const explicit = Number(q.est_annual_saved ?? q.est_annual_savings ?? q.annualised_savings);
  if (Number.isFinite(explicit) && explicit >= 0) return explicit;

  const annualCost = queryAnnualCostEstimate(q);
  if (!Number.isFinite(annualCost) || annualCost <= 0) return 0;

  const base = Number(WORKLOAD_COST_MODEL.potential_savings_by_bucket[q.bucket] || 0);
  const overlap = clamp(Number(q.overlap || 0), 0, 1);
  // Confidence-weighted potential from initial forensic overlap.
  const confidenceFactor = 0.65 + (overlap * 0.7);
  const projectedRatio = clamp(base * confidenceFactor, 0, 0.75);
  return annualCost * projectedRatio;
}

function calcEstimatedWorkloadCost(queries) {
  let total = 0;
  for (const q of queries || []) {
    if (!q || q.bucket === 'SKIP') continue;
    total += queryAnnualCostEstimate(q);
  }
  return total;
}

function nowClock() {
  const now = new Date();
  return [now.getHours(), now.getMinutes(), now.getSeconds()]
    .map(n => String(n).padStart(2, '0')).join(':');
}

function appendResultEntry(entry) {
  if (!entry || !entry.query_id) return;
  resultEntries.push({
    ts: nowClock(),
    query_id: entry.query_id,
    status: entry.status || 'NEUTRAL',
    speedup: Number.isFinite(Number(entry.speedup)) ? Number(entry.speedup) : null,
    transform: entry.transform || '',
    source: entry.source || 'runtime',
  });
  if (resultEntries.length > 500) resultEntries = resultEntries.slice(resultEntries.length - 500);
  updateResultsView();
}

function renderDoneTable() {
  const tbody = document.getElementById('done-tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const rows = [...execQueries]
    .map(q => ({ q, r: completedSet[q.id] }))
    .filter(x => !!x.r)
    .sort((a, b) => (b.r.speedup || 0) - (a.r.speedup || 0));

  if (!rows.length) {
    const tr = document.createElement('tr');
    tr.innerHTML = '<td colspan="6" class="muted" style="padding:14px">No confirmed query outcomes yet.</td>';
    tbody.appendChild(tr);
    return;
  }

  for (const row of rows) {
    const q = row.q;
    const r = row.r;
    const annualCost = queryAnnualCostEstimate(q);
    const annualSaved = r.speedup > 1.0 ? annualCost * (1 - 1 / r.speedup) : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono" style="font-weight:500">${esc(q.id)}</td>
      <td>${statusBadge(r.status)}</td>
      <td class="right">${speedupHtml(r.speedup)}</td>
      <td>${bucketBadge(q.bucket)}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--purple)">${r.transform || '--'}</td>
      <td class="mono right" style="color:${annualSaved > 0 ? 'var(--green)' : 'var(--t3)'}">${annualSaved > 0 ? fmtMoney(annualSaved) : '--'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function renderResultsLog() {
  const el = document.getElementById('results-log');
  if (!el) return;
  el.innerHTML = '';
  if (!resultEntries.length) {
    const div = document.createElement('div');
    div.className = 'event-entry ev-system';
    div.innerHTML = '<span class="event-ts">--:--:--</span><span class="event-target">system</span><span class="event-msg">No confirmed outcomes yet.</span>';
    el.appendChild(div);
    return;
  }
  const recent = resultEntries.slice(-120).reverse();
  for (const row of recent) {
    const div = document.createElement('div');
    const statusCls = String(row.status || '').toLowerCase();
    const speedTxt = Number.isFinite(row.speedup) ? ` ${row.speedup.toFixed(2)}x` : '';
    const transformTxt = row.transform ? ` (${row.transform})` : '';
    div.className = 'event-entry ev-' + statusCls;
    div.innerHTML = `
      <span class="event-ts">${esc(row.ts)}</span>
      <span class="event-target">${esc(row.query_id)}</span>
      <span class="event-msg">${esc((row.status || 'NEUTRAL') + speedTxt + transformTxt + ' · ' + row.source)}</span>
    `;
    el.appendChild(div);
  }
}

function updateResultsView() {
  const optimized = Object.values(completedSet).filter(r => r.status === 'WIN' || r.status === 'IMPROVED').length;
  const regress = Object.values(completedSet).filter(r => r.status === 'REGRESSION').length;
  const done = Object.keys(completedSet).length;

  const countEl = document.getElementById('results-count');
  if (countEl) countEl.textContent = String(done);

  const doneSavingsEl = document.getElementById('done-savings');
  if (doneSavingsEl) doneSavingsEl.textContent = fmtMoney(plannedSavings);
  const doneWorkloadEl = document.getElementById('done-workload-cost');
  if (doneWorkloadEl) doneWorkloadEl.textContent = fmtMoney(plannedWorkloadCost);
  const doneTotalEl = document.getElementById('done-total');
  if (doneTotalEl) doneTotalEl.textContent = execQueries.length;
  const doneOptEl = document.getElementById('done-optimized');
  if (doneOptEl) doneOptEl.textContent = optimized;
  const doneRegEl = document.getElementById('done-regressions');
  if (doneRegEl) doneRegEl.textContent = regress;
  const doneTimeEl = document.getElementById('done-time');
  if (doneTimeEl) doneTimeEl.textContent = fmtTime(clockSeconds);

  renderDoneTable();
  renderResultsLog();
}

function confLevel(overlap) {
  if (overlap >= 0.7) return 'high';
  if (overlap >= 0.45) return 'med';
  if (overlap > 0) return 'low';
  return 'none';
}

function confHtml(overlap) {
  const lvl = confLevel(overlap);
  if (lvl === 'none') return '<span style="color:var(--t3)">--</span>';
  const n = lvl === 'high' ? 3 : lvl === 'med' ? 2 : 1;
  const cls = lvl === 'high' ? 'filled' : lvl === 'med' ? 'filled med' : 'filled low';
  let dots = '';
  for (let i = 0; i < 3; i++) {
    dots += `<span class="conf-seg ${i < n ? cls : ''}"></span>`;
  }
  const label = lvl === 'high' ? 'High' : lvl === 'med' ? 'Med' : 'Low';
  return `<span class="confidence"><span class="conf-bar">${dots}</span>${label}</span>`;
}

function toggleDetail(qid) {
  if (openDetails.has(qid)) openDetails.delete(qid);
  else openDetails.add(qid);
  // Re-render whichever table is active
  if (state === 'triage') renderTriageTable();
  else renderExecTable();
}

function toggleExplain(qid) {
  if (openExplains.has(qid)) openExplains.delete(qid);
  else openExplains.add(qid);
  const el = document.getElementById('explain-' + qid);
  if (el) el.style.display = openExplains.has(qid) ? 'block' : 'none';
  const tog = document.getElementById('explain-tog-' + qid);
  if (tog) tog.textContent = openExplains.has(qid) ? '\u25BC Hide EXPLAIN' : '\u25B6 Show EXPLAIN';
}

function renderDetailPanel(q) {
  const d = q.detail;
  if (!d) return '<tr><td colspan="9" class="detail-panel open" style="color:var(--t3);font-size:12px;padding-left:48px">No detail data available</td></tr>';

  let html = '<tr><td colspan="9" class="detail-panel open"><div class="detail-grid">';

  // ── Left column: Cost Context + Structural Flags ──
  html += '<div class="detail-section">';
  html += '<div class="detail-section-title">Cost Context</div>';
  html += `<div class="detail-kv"><span class="dk-label">Rank</span><span class="dk-value">#${d.cost_rank} of ${QUERIES.length}</span></div>`;
  html += `<div class="detail-kv"><span class="dk-label">% of total</span><span class="dk-value">${(d.pct_of_total * 100).toFixed(1)}%</span></div>`;
  html += `<div class="detail-kv"><span class="dk-label">Cumulative</span><span class="dk-value">${(d.cumulative_pct * 100).toFixed(1)}%</span></div>`;

  if (d.structural_flags && d.structural_flags.length > 0) {
    html += '<div class="detail-section-title" style="margin-top:12px">Structural Flags</div>';
    html += '<div>';
    for (const f of d.structural_flags) {
      html += `<span class="flag-tag">${esc(f)}</span>`;
    }
    html += '</div>';
  }

  // Q-Error section
  if (d.qerror) {
    const qe = d.qerror;
    const sevCls = qe.severity.toLowerCase();
    html += '<div class="detail-section-title" style="margin-top:12px">Q-Error Analysis</div>';
    html += `<div class="detail-kv"><span class="dk-label">Severity</span><span class="qerror-badge ${sevCls}">${esc(qe.severity)}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Direction</span><span class="dk-value">${esc(qe.direction.replace('_',' '))}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Worst node</span><span class="dk-value">${esc(qe.worst_node)}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Max q-error</span><span class="dk-value" style="color:${qe.max_q_error > 10 ? 'var(--red)' : 'var(--t1)'}">${qe.max_q_error.toFixed(1)}x</span></div>`;
  }

  html += '</div>';

  // ── Right column: Transform Matches + EXPLAIN ──
  html += '<div class="detail-section">';
  if (d.transforms && d.transforms.length > 0) {
    html += '<div class="detail-section-title">Transform Matches</div>';
    for (const t of d.transforms) {
      html += '<div class="transform-row">';
      html += `<span class="transform-name">${esc(t.id)}</span>`;
      html += `<span class="transform-family">${esc(t.family)}</span>`;
      html += `<div class="overlap-bar-wrap"><div class="overlap-bar" style="width:${Math.round(t.overlap * 100)}%"></div></div>`;
      html += `<span class="overlap-pct">${Math.round(t.overlap * 100)}%</span>`;
      if (t.gap) html += `<span class="transform-gap">${esc(t.gap)}</span>`;
      html += '</div>';
    }
  } else {
    html += '<div class="detail-section-title">Transform Matches</div>';
    html += '<div style="font-size:12px;color:var(--t3)">No structural matches (discovery mode)</div>';
  }

  // EXPLAIN — parsed bottleneck analysis
  if (d.explain) {
    const isOpen = openExplains.has(q.id);
    html += `<div class="explain-toggle" id="explain-tog-${q.id}" onclick="toggleExplain('${q.id}')">${isOpen ? '\u25BC Hide EXPLAIN' : '\u25B6 Show EXPLAIN'}</div>`;
    html += `<div id="explain-${q.id}" style="display:${isOpen ? 'block' : 'none'}">` + renderExplainAnalysis(d.explain) + '</div>';
  }

  html += '</div></div></td></tr>';
  return html;
}

function bucketBadge(bucket) {
  const labels = { HIGH: 'High', MEDIUM: 'Medium', LOW: 'Low', SKIP: 'Skip' };
  return `<span class="badge ${bucket.toLowerCase()}">${labels[bucket] || bucket}</span>`;
}

function statusBadge(status) {
  if (!status) return '';
  const lower = status.toLowerCase();
  let inner = esc(status);
  if (lower === 'running') {
    inner = `<span class="status-dot blue pulse"></span>${inner}`;
  }
  return `<span class="badge ${lower}">${inner}</span>`;
}

function speedupHtml(sp) {
  if (sp == null) return '<span class="speedup meh">--</span>';
  const cls = sp >= 1.1 ? 'fast' : sp < 0.95 ? 'slow' : 'meh';
  return `<span class="speedup ${cls}">${sp.toFixed(2)}x</span>`;
}

function calcEstimatedSavings(queries) {
  let total = 0;
  for (const q of queries || []) {
    total += queryProjectedSavingsEstimate(q);
  }
  return total;
}

function renderParetoPanel(activeQueries) {
  const barsEl = document.getElementById('triage-pareto-bars');
  const summaryEl = document.getElementById('triage-pareto-8020');
  const assumptionsEl = document.getElementById('triage-assumptions');
  if (!barsEl || !summaryEl || !assumptionsEl) return;

  const rows = (activeQueries || [])
    .filter(q => q && q.bucket !== 'SKIP')
    .map(q => ({ id: q.id, cost: queryAnnualCostEstimate(q) }))
    .filter(r => Number.isFinite(r.cost) && r.cost > 0)
    .sort((a, b) => b.cost - a.cost);

  if (!rows.length) {
    summaryEl.textContent = 'No eligible workload cost data yet.';
    barsEl.innerHTML = '<div class="pareto-meta" style="text-align:left">No non-SKIP queries with modeled cost.</div>';
    assumptionsEl.textContent = '';
    return;
  }

  const total = rows.reduce((s, r) => s + r.cost, 0);
  const topN = Math.max(1, Math.ceil(rows.length * 0.2));
  const topShare = rows.slice(0, topN).reduce((s, r) => s + r.cost, 0) / total;

  let cumulative = 0;
  let cutoffCount = rows.length;
  for (let i = 0; i < rows.length; i++) {
    cumulative += rows[i].cost;
    rows[i].cumPct = (cumulative / total) * 100;
    if (cutoffCount === rows.length && rows[i].cumPct >= 80) cutoffCount = i + 1;
  }

  summaryEl.textContent = `Top ${topN} queries = ${(topShare * 100).toFixed(1)}% of workload; ${cutoffCount} queries reach 80%.`;

  const maxBars = 12;
  const view = rows.slice(0, maxBars);
  let html = '';
  for (const row of view) {
    const pct = (row.cost / total) * 100;
    html += `
      <div class="pareto-row">
        <div class="pareto-label">${esc(row.id)}</div>
        <div class="pareto-track"><div class="pareto-fill" style="width:${Math.max(2, pct).toFixed(1)}%"></div></div>
        <div class="pareto-meta">${pct.toFixed(1)}% · cum ${row.cumPct.toFixed(1)}%</div>
      </div>
    `;
  }
  if (rows.length > maxBars) {
    html += `<div class="pareto-meta" style="text-align:left">+${rows.length - maxBars} more queries</div>`;
  }
  barsEl.innerHTML = html;

  assumptionsEl.textContent =
    `Starter model assumptions: HIGH ${WORKLOAD_COST_MODEL.daily_frequency_by_bucket.HIGH}/day, ` +
    `MEDIUM ${WORKLOAD_COST_MODEL.daily_frequency_by_bucket.MEDIUM}/day, ` +
    `LOW ${WORKLOAD_COST_MODEL.daily_frequency_by_bucket.LOW}/day; ` +
    `compute $${(WORKLOAD_COST_MODEL.cost_per_compute_second_usd * 3600).toFixed(2)}/hour; ` +
    `savings potential from initial transform confidence + bucket.`;
}

// ── Triage Rendering ────────────────────────────────────────
function renderTriageTable() {
  const search = document.getElementById('triage-search').value.toLowerCase();
  const bucketF = document.getElementById('triage-bucket-filter').value;
  const showSkip = document.getElementById('triage-show-skip').checked;

  let rows = QUERIES.filter(q => {
    if (!showSkip && q.bucket === 'SKIP') return false;
    if (bucketF && q.bucket !== bucketF) return false;
    if (search && !q.id.includes(search)) return false;
    return true;
  });

  rows.sort((a, b) => {
    let av = a[triageSortCol], bv = b[triageSortCol];
    if (triageSortCol === 'query_id') { av = a.id; bv = b.id; }
    if (triageSortCol === 'est_annual') {
      av = queryAnnualCostEstimate(a);
      bv = queryAnnualCostEstimate(b);
    }
    if (typeof av === 'string') return triageSortDir * av.localeCompare(bv);
    return triageSortDir * ((av || 0) - (bv || 0));
  });

  const tbody = document.getElementById('triage-tbody');
  tbody.innerHTML = '';

  for (const q of rows) {
    const excluded = excludedIds.has(q.id);
    const isOpen = openDetails.has(q.id);
    const tr = document.createElement('tr');
    if (excluded) tr.className = 'excluded';

    const iterOptions = q.bucket === 'SKIP' ? '--' :
      [1,2,3,5].map(n =>
        `<option value="${n}" ${n === q.iters ? 'selected' : ''}>${n}</option>`
      ).join('');

    tr.innerHTML = `
      <td><input type="checkbox" class="excl-check" ${excluded ? 'checked' : ''} data-qid="${q.id}" onchange="toggleExclude(this)"></td>
      <td class="mono" style="font-weight:500;cursor:pointer" onclick="toggleDetail('${q.id}')"><span class="detail-toggle ${isOpen ? 'open' : ''}">\u25B6</span> ${esc(q.id)}</td>
      <td class="mono right">${fmtMs(q.runtime_ms)}</td>
      <td class="mono right">${fmtMoney(queryAnnualCostEstimate(q))}</td>
      <td>${bucketBadge(q.bucket)}</td>
      <td style="text-align:center">${q.bucket === 'SKIP' ? '<span style="color:var(--t3)">--</span>' : `<select class="iter-select" data-qid="${q.id}" onchange="changeIters(this)">${iterOptions}</select>`}</td>
      <td>${q.transform ? `<span style="font-family:var(--mono);font-size:12px;color:var(--purple)">${esc(q.transform)}</span>` : '<span style="color:var(--t3)">--</span>'}</td>
      <td>${confHtml(q.overlap)}</td>
      <td><span class="edit-icon" onclick="openInEditor('${q.id}')" title="Open in Editor">&#9998;</span></td>
    `;
    tbody.appendChild(tr);

    // Detail panel row
    if (isOpen) {
      const detailHtml = renderDetailPanel(q);
      const detailContainer = document.createElement('tr');
      detailContainer.innerHTML = `<td colspan="9" class="detail-panel open" style="display:table-cell">${detailHtml.replace(/<tr><td colspan="9" class="detail-panel open">/, '').replace(/<\/td><\/tr>$/, '')}</td>`;
      tbody.appendChild(detailContainer);
    }
  }

  // Update sort arrows
  document.querySelectorAll('#triage-table th.sortable').forEach(th => {
    const col = th.dataset.sort;
    const existing = th.querySelector('.sort-arrow');
    if (existing) existing.remove();
    if (col === triageSortCol) {
      const arrow = document.createElement('span');
      arrow.className = 'sort-arrow';
      arrow.textContent = triageSortDir === 1 ? '\u25B2' : '\u25BC';
      th.appendChild(arrow);
    }
  });
}

function toggleExclude(el) {
  const qid = el.dataset.qid;
  if (el.checked) excludedIds.add(qid);
  else excludedIds.delete(qid);
  renderTriageTable();
  updateTriageStats();
}

function changeIters(el) {
  const qid = el.dataset.qid;
  const val = parseInt(el.value);
  const q = QUERIES.find(q => q.id === qid);
  if (q) q.iters = val;
  updateTriageStats();
}

function updateTriageStats() {
  const active = QUERIES.filter(q => !excludedIds.has(q.id));
  const high = active.filter(q => q.bucket === 'HIGH').length;
  const med = active.filter(q => q.bucket === 'MEDIUM').length;
  const low = active.filter(q => q.bucket === 'LOW').length;
  const skip = active.filter(q => q.bucket === 'SKIP').length;
  document.getElementById('triage-high').textContent = high;
  document.getElementById('triage-med').textContent = med;
  document.getElementById('triage-low').textContent = low;
  document.getElementById('triage-skip').textContent = skip;

  const totalWorkloadCost = calcEstimatedWorkloadCost(active);
  const totalSavings = calcEstimatedSavings(active);
  triageWorkloadCost = Number.isFinite(totalWorkloadCost) ? totalWorkloadCost : 0;
  triageProjectedSavings = Number.isFinite(totalSavings) ? totalSavings : 0;
  document.getElementById('triage-savings').textContent = fmtMoney(totalSavings);
  const workloadEl = document.getElementById('triage-workload-cost');
  if (workloadEl) workloadEl.textContent = fmtMoney(totalWorkloadCost);
  const projectedEl = document.getElementById('triage-projected-savings');
  if (projectedEl) projectedEl.textContent = fmtMoney(totalSavings);
  renderParetoPanel(active);
}

// Wire triage sort headers
document.querySelectorAll('#triage-table th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (triageSortCol === col) triageSortDir *= -1;
    else { triageSortCol = col; triageSortDir = col === 'query_id' ? 1 : -1; }
    renderTriageTable();
  });
});

// Wire triage filters
document.getElementById('triage-search').addEventListener('input', renderTriageTable);
document.getElementById('triage-bucket-filter').addEventListener('change', renderTriageTable);
document.getElementById('triage-show-skip').addEventListener('change', renderTriageTable);

// ── Execution Rendering ─────────────────────────────────────
function renderExecTable() {
  const search = document.getElementById('exec-search').value.toLowerCase();
  const statusF = document.getElementById('exec-status-filter').value;
  const bucketF = document.getElementById('exec-bucket-filter').value;

  let rows = execQueries.map(q => {
    const r = completedSet[q.id];
    const isRunning = runningQueryIds.has(q.id);
    const wIdx = workerState.indexOf(q.id);
    const startClock = Number(queryStartClockById[q.id]);
    const elapsedClock = Number.isFinite(startClock)
      ? Math.max(0, clockSeconds - startClock)
      : (wIdx >= 0 ? workerTimers[wIdx] : null);
    return {
      ...q,
      exec_status: r ? r.status : (isRunning ? 'RUNNING' : 'QUEUED'),
      exec_speedup: r ? r.speedup : null,
      exec_phase: r ? 'done' : (queryPhaseById[q.id] || (isRunning ? 'starting' : '--')),
      exec_elapsed: r ? r.elapsed_s : (isRunning ? elapsedClock : null),
      worker_id: wIdx >= 0 ? wIdx + 1 : null,
    };
  });

  // Stable phase assignment
  rows.forEach(r => {
    if (r.exec_status === 'RUNNING') {
      const tracked = queryPhaseById[r.id];
      if (tracked) r.exec_phase = tracked;
    }
  });

  if (statusF) rows = rows.filter(r => r.exec_status === statusF);
  if (bucketF) rows = rows.filter(r => r.bucket === bucketF);
  if (search) rows = rows.filter(r => r.id.includes(search));

  // Sort
  rows.sort((a, b) => {
    let av, bv;
    if (execSortCol === 'query_id') { av = a.id; bv = b.id; }
    else if (execSortCol === 'speedup') { av = a.exec_speedup || 0; bv = b.exec_speedup || 0; }
    else { av = a[execSortCol] || 0; bv = b[execSortCol] || 0; }
    if (typeof av === 'string') return execSortDir * av.localeCompare(bv);
    return execSortDir * (av - bv);
  });

  const tbody = document.getElementById('exec-tbody');
  tbody.innerHTML = '';

  for (const r of rows) {
    const tr = document.createElement('tr');
    if (r.exec_status === 'RUNNING') tr.className = 'is-running';
    const isOpen = openDetails.has(r.id);

    const phaseText = r.exec_status === 'RUNNING'
      ? humanizePhase(r.exec_phase)
      : (r.exec_status === 'QUEUED' ? '--' : 'done');

    tr.innerHTML = `
      <td class="mono" style="font-weight:500;cursor:pointer" onclick="toggleDetail('${r.id}')"><span class="detail-toggle ${isOpen ? 'open' : ''}">\u25B6</span> ${esc(r.id)}</td>
      <td>${statusBadge(r.exec_status)}</td>
      <td class="right">${speedupHtml(r.exec_speedup)}</td>
      <td>${bucketBadge(r.bucket)}</td>
      <td class="mono" style="color:var(--t2);font-size:12px">${phaseText}</td>
      <td class="mono right" style="color:var(--t3)">${r.exec_elapsed != null ? fmtTime(r.exec_elapsed) : '--'}</td>
      <td style="text-align:center">${r.exec_status === 'RUNNING' ? '<span class="active-dot"></span>' : ''}</td>
      <td><span class="edit-icon" onclick="openInEditor('${r.id}')" title="Open in Editor">&#9998;</span></td>
    `;
    tbody.appendChild(tr);

    // Detail panel row
    if (isOpen) {
      const origQ = QUERIES.find(q => q.id === r.id);
      if (origQ) {
        const detailHtml = renderDetailPanel(origQ);
        const detailContainer = document.createElement('tr');
        detailContainer.innerHTML = `<td colspan="8" class="detail-panel open" style="display:table-cell">${detailHtml.replace(/<tr><td colspan="9" class="detail-panel open">/, '').replace(/<\/td><\/tr>$/, '')}</td>`;
        tbody.appendChild(detailContainer);
      }
    }
  }
}

function renderWorkers() {
  for (let i = 0; i < 4; i++) {
    const card = document.getElementById('wc-' + (i + 1));
    const qid = workerState[i];
    const dot = card.querySelector('.status-dot');
    const info = card.querySelector('.worker-info');
    const time = card.querySelector('.worker-time');

    if (qid) {
      card.className = 'worker-card active';
      dot.className = 'status-dot green pulse';
      const phase = humanizePhase(queryPhaseById[qid] || 'starting');
      info.innerHTML = `<span class="query-ref">${esc(qid)}</span> <span class="phase-ref">${phase}</span>`;
      time.textContent = fmtTime(workerTimers[i]);
    } else {
      card.className = 'worker-card idle';
      dot.className = 'status-dot gray';
      info.textContent = 'Standby';
      time.textContent = '';
    }
  }
}

function renderQueue() {
  const list = document.getElementById('queue-list');
  const countEl = document.getElementById('queue-count');
  list.innerHTML = '';

  // Derive pending queue from actual state: queries not completed and not on a worker
  const activeSet = new Set(Array.from(runningQueryIds));
  const pending = execQueries
    .filter(q => !completedSet[q.id] && !activeSet.has(q.id))
    .map(q => q.id);

  // In simulation mode, use queueOrder if it has entries
  const displayQueue = queueOrder.length > 0 ? queueOrder : pending;
  countEl.textContent = `(${displayQueue.length} remaining)`;

  const show = displayQueue.slice(0, 6);
  show.forEach((qid, i) => {
    const q = execQueries.find(eq => eq.id === qid);
    const li = document.createElement('li');
    li.className = 'queue-item';
    li.innerHTML = `
      <span class="queue-rank">${i + 1}.</span>
      <span style="font-weight:500">${esc(qid)}</span>
      ${q ? bucketBadge(q.bucket) : ''}
      <span style="color:var(--t3)">${q ? q.iters + ' rnd' : ''}</span>
    `;
    list.appendChild(li);
  });

  if (displayQueue.length > 6) {
    const more = document.createElement('li');
    more.className = 'queue-more';
    more.textContent = `+${displayQueue.length - 6} more`;
    list.appendChild(more);
  }
}

function updateExecStats() {
  const done = Object.keys(completedSet).length;
  const total = execQueries.length;
  const active = runningQueryIds.size;
  // Compute queued from actual state: total minus completed minus active
  const queued = Math.max(0, total - done - active);
  const wins = Object.values(completedSet).filter(r => r.status === 'WIN').length;
  const improved = Object.values(completedSet).filter(r => r.status === 'IMPROVED').length;
  const neutral = Object.values(completedSet).filter(r => r.status === 'NEUTRAL').length;
  const regress = Object.values(completedSet).filter(r => r.status === 'REGRESSION').length;
  const errors = Object.values(completedSet).filter(r => r.status === 'ERROR').length;

  document.getElementById('exec-done').textContent = done;
  document.getElementById('exec-total').textContent = total;
  document.getElementById('exec-active').textContent = active;
  document.getElementById('exec-queued').textContent = queued;
  document.getElementById('exec-wins').textContent = wins;
  document.getElementById('exec-improved').textContent = improved;
  document.getElementById('exec-neutral').textContent = neutral;
  document.getElementById('exec-regress').textContent = regress;
  document.getElementById('exec-errors').textContent = errors;
  document.getElementById('exec-clock').textContent = fmtTime(clockSeconds);
  document.getElementById('exec-api').textContent = apiCalls;

  const workloadCostEl = document.getElementById('exec-workload-cost');
  if (workloadCostEl) workloadCostEl.textContent = fmtMoney(plannedWorkloadCost);
  document.getElementById('exec-savings').textContent = fmtMoney(plannedSavings);

  const pct = total > 0 ? (done / total) * 100 : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
  updateResultsView();
}

function addEvent(target, msg, type) {
  const now = new Date();
  const ts = [now.getHours(), now.getMinutes(), now.getSeconds()]
    .map(n => String(n).padStart(2, '0')).join(':');

  eventEntries.push({ ts, target, msg, type });

  const log = document.getElementById('event-log');
  const div = document.createElement('div');
  div.className = 'event-entry ev-' + (type || 'system');
  div.innerHTML = `
    <span class="event-ts">${ts}</span>
    <span class="event-target">${esc(target)}</span>
    <span class="event-msg">${esc(msg)}</span>
  `;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function summarizeInboundMessage(msg) {
  const type = (msg && msg.type) || 'message';
  const data = (msg && msg.data) || {};
  if (type === 'triage_data') {
    const count = Array.isArray(data.queries) ? data.queries.length : 0;
    return `Received triage_data (${count} queries).`;
  }
  if (type === 'run_context') {
    return `run_context ${data.benchmark_name || '?'} engine=${data.engine || '?'} run=${data.run_id || '?'}`;
  }
  if (type === 'query_update') {
    return `query_update ${data.query_id || '?'} phase=${data.phase || data.status || 'unknown'}`;
  }
  if (type === 'query_complete') {
    const speedTxt = Number.isFinite(Number(data.speedup)) ? ` ${Number(data.speedup).toFixed(2)}x` : '';
    const callsTxt = Number.isFinite(Number(data.n_api_calls)) ? ` calls=${Number(data.n_api_calls)}` : '';
    return `query_complete ${data.query_id || '?'} status=${data.status || '?'}${speedTxt}${callsTxt}`;
  }
  if (type === 'event_log') {
    return `${data.scope || 'fleet'} event: ${data.target || 'system'} ${data.msg || ''}`.trim();
  }
  if (type === 'fleet_done') {
    return `fleet_done total=${data.total || 0}`;
  }
  if (type === 'editor_iteration') {
    const n = Array.isArray(data.patches) ? data.patches.length : 0;
    return `editor_iteration iter=${data.iteration || '?'} patches=${n}`;
  }
  if (type === 'editor_complete') {
    const speedTxt = Number.isFinite(Number(data.best_speedup)) ? ` ${Number(data.best_speedup).toFixed(2)}x` : '';
    return `editor_complete status=${data.status || '?'}${speedTxt}`;
  }
  if (type === 'connection_test_result') {
    const target = (data.target || '?').toUpperCase();
    const outcome = data.ok ? 'pass' : 'fail';
    return `connection_test_result ${target} ${outcome}`;
  }
  return `Received ${type}`;
}

function summarizeOutboundMessage(payload) {
  const type = (payload && payload.type) || 'message';
  if (type === 'approve') {
    const plan = (payload && payload.plan) || {};
    const excluded = Array.isArray(plan.excluded) ? plan.excluded.length : 0;
    const overrides = Array.isArray(plan.overrides) ? plan.overrides.length : 0;
    return `Sending approve (excluded=${excluded}, overrides=${overrides})`;
  }
  if (type === 'pause' || type === 'resume') return `Sending ${type}`;
  if (type === 'editor_beam' || type === 'editor_strike') {
    const qid = payload.query_id || '?';
    const iters = payload.max_iterations || 1;
    const strategy = payload.strategy ? ` strategy=${payload.strategy}` : '';
    return `Sending ${type} query=${qid} iters=${iters}${strategy}`;
  }
  if (type === 'config_update') {
    const cfg = (payload && payload.config) || {};
    const mode = cfg.source_mode || 'local';
    const history = cfg.use_blackboard_history === false ? 'off' : 'on';
    return `Sending config_update mode=${mode} history=${history}`;
  }
  if (type === 'test_connection') {
    const target = (payload && payload.target) || '?';
    return `Sending test_connection target=${target}`;
  }
  return `Sending ${type}`;
}

function sanitizeBackendPayload(payload) {
  if (payload === null || payload === undefined) return null;
  if (typeof payload !== 'object') return payload;
  const type = payload.type;
  if (type === 'triage_data') {
    const count = Array.isArray(payload.data && payload.data.queries) ? payload.data.queries.length : 0;
    return { type: 'triage_data', data: { query_count: count } };
  }
  if (type === 'editor_iteration') {
    const data = payload.data || {};
    const count = Array.isArray(data.patches) ? data.patches.length : 0;
    return { type: 'editor_iteration', data: { ...data, patches: `[${count} patches]` } };
  }
  if (type === 'approve') {
    const plan = (payload && payload.plan) || {};
    const excluded = Array.isArray(plan.excluded) ? plan.excluded : [];
    const overrides = Array.isArray(plan.overrides) ? plan.overrides : [];
    return {
      type: 'approve',
      plan: {
        excluded_count: excluded.length,
        overrides_count: overrides.length,
        excluded_preview: excluded.slice(0, 8),
        overrides_preview: overrides.slice(0, 8).map(o => `${o.id}:${o.iters}`),
      },
    };
  }
  if (type === 'config_update') {
    const cfg = (payload && payload.config) || {};
    return {
      type: 'config_update',
      config: {
        engine_profile: cfg.engine_profile || '',
        source_mode: cfg.source_mode || 'local',
        benchmark_dir: cfg.benchmark_dir || '',
        local_path: cfg.local_path || '',
        git_url: cfg.git_url || '',
        git_branch: cfg.git_branch || '',
        explain_policy: cfg.explain_policy || '',
        use_blackboard_history: cfg.use_blackboard_history !== false,
        db_dsn: maskDsn(cfg.db_dsn || ''),
      },
    };
  }
  if (type === 'test_connection') {
    const cfg = (payload && payload.config) || {};
    return {
      type: 'test_connection',
      target: payload.target || '',
      config: {
        engine_profile: cfg.engine_profile || '',
        source_mode: cfg.source_mode || 'local',
        benchmark_dir: cfg.benchmark_dir || '',
        local_path: cfg.local_path || '',
        git_url: cfg.git_url || '',
        git_branch: cfg.git_branch || '',
        explain_policy: cfg.explain_policy || '',
        use_blackboard_history: cfg.use_blackboard_history !== false,
        db_dsn: maskDsn(cfg.db_dsn || ''),
      },
    };
  }
  if (type === 'connection_test_result') {
    const data = payload.data || {};
    return {
      type: 'connection_test_result',
      data: {
        target: data.target || '',
        ok: !!data.ok,
        message: data.message || '',
        elapsed_ms: data.elapsed_ms || 0,
        details: {
          ...(data.details || {}),
          dsn: maskDsn((data.details && data.details.dsn) || ''),
        },
      },
    };
  }
  return payload;
}

function payloadText(payload) {
  if (payload === null || payload === undefined) return '';
  try {
    const txt = JSON.stringify(payload, null, 2);
    if (txt.length > 450) return txt.slice(0, 450) + '\n...';
    return txt;
  } catch (e) {
    return String(payload);
  }
}

function updateBackendConsoleStatus() {
  const badge = document.getElementById('backend-console-badge');
  const meta = document.getElementById('backend-console-meta');
  if (!badge || !meta) return;

  badge.classList.remove('live');
  let label = 'offline';
  if (!isLiveBackendMode()) {
    label = 'demo';
  } else if (isWsReady()) {
    label = 'live';
    badge.classList.add('live');
  } else if (ws && ws.readyState === WebSocket.CONNECTING) {
    label = 'connecting';
  }
  badge.textContent = label;
  meta.textContent = `${backendLogs.length} line${backendLogs.length === 1 ? '' : 's'}`;
}

function renderBackendConsole() {
  const wrap = document.getElementById('backend-console');
  if (!wrap) return;

  const stick = wrap.scrollTop + wrap.clientHeight >= wrap.scrollHeight - 24;
  if (!backendLogs.length) {
    wrap.innerHTML = '<div class="backend-console-empty">No backend events yet.</div>';
    updateBackendConsoleStatus();
    return;
  }

  let html = '';
  for (const row of backendLogs) {
    const cls = row.level || 'system';
    html += `<div class="backend-line lvl-${esc(cls)}">`;
    html += `<span class="backend-ts">${esc(row.ts)}</span>`;
    html += `<span class="backend-lvl">${esc(row.lane || 'SYS')}</span>`;
    html += `<span class="backend-src">${esc(row.source || 'fleet')}</span>`;
    html += `<span class="backend-msg">${esc(row.msg || '')}</span>`;
    html += '</div>';
    if (row.payload) {
      html += `<div class="backend-line lvl-${esc(cls)}">`;
      html += '<span class="backend-ts"></span><span class="backend-lvl"></span><span class="backend-src"></span>';
      html += `<span class="backend-payload">${esc(row.payload)}</span>`;
      html += '</div>';
    }
  }
  wrap.innerHTML = html;
  if (stick) wrap.scrollTop = wrap.scrollHeight;
  updateBackendConsoleStatus();
}

function pushBackendLog(msg, opts = {}) {
  const now = new Date();
  const ts = [now.getHours(), now.getMinutes(), now.getSeconds()]
    .map(n => String(n).padStart(2, '0')).join(':');
  const row = {
    ts,
    lane: opts.lane || 'SYS',
    source: (opts.source || 'fleet').toUpperCase(),
    msg,
    level: opts.level || 'system',
    payload: payloadText(opts.payload),
  };
  backendLogs.push(row);
  if (backendLogs.length > BACKEND_LOG_LIMIT) {
    backendLogs = backendLogs.slice(backendLogs.length - BACKEND_LOG_LIMIT);
  }
  renderBackendConsole();
}

function clearBackendConsole(notify = true) {
  backendLogs = [];
  renderBackendConsole();
  if (notify) {
    pushBackendLog('Console cleared by user.', { level: 'system', lane: 'SYS', source: 'ui' });
  }
}

function maskDsn(dsn) {
  if (!dsn) return '';
  return String(dsn)
    .replace(/(password=)([^\\s;]+)/ig, '$1***')
    .replace(/:\/\/([^:/\s]+):([^@/\s]+)@/g, '://$1:***@');
}

const pendingConnectionTests = {
  db: false,
  llm: false,
};

function configStatusLabel(status, message) {
  if (message) return message;
  if (status === 'running') return 'testing...';
  if (status === 'pass') return 'connected';
  if (status === 'fail') return 'failed';
  return 'not tested';
}

function setConfigTestStatus(target, status = 'idle', message = '') {
  const statusEl = document.getElementById(`cfg-test-${target}-status`);
  if (!statusEl) return;
  statusEl.classList.remove('running', 'pass', 'fail');
  if (status === 'running' || status === 'pass' || status === 'fail') {
    statusEl.classList.add(status);
  }
  statusEl.textContent = configStatusLabel(status, message);
}

function setConfigTestPending(target, pending) {
  pendingConnectionTests[target] = !!pending;
  const btn = document.getElementById(`cfg-test-${target}-btn`);
  if (btn) btn.disabled = !!pending;
}

function collectConfigFromForm() {
  const engineProfile = (document.getElementById('cfg-engine-profile').value || 'duckdb').trim();
  const dbDsn = (document.getElementById('cfg-db-dsn').value || '').trim();
  const benchmarkDir = (document.getElementById('cfg-benchmark-dir').value || '').trim();
  const explainPolicy = (document.getElementById('cfg-explain-policy').value || 'explain').trim();
  const setups = defaultEngineSetups();
  if (runConfig.engine_setups && typeof runConfig.engine_setups === 'object') {
    for (const engine of ENGINE_PROFILES) {
      const src = runConfig.engine_setups[engine];
      if (src && typeof src === 'object') {
        setups[engine] = {
          db_dsn: String(src.db_dsn || '').trim(),
          benchmark_dir: String(src.benchmark_dir || '').trim(),
          explain_policy: String(src.explain_policy || 'explain').trim() || 'explain',
        };
      }
    }
  }
  setups[engineProfile] = {
    db_dsn: dbDsn,
    benchmark_dir: benchmarkDir,
    explain_policy: explainPolicy,
  };
  return {
    engine_profile: engineProfile,
    engine_setups: setups,
    db_dsn: dbDsn,
    benchmark_dir: benchmarkDir,
    source_mode: (document.getElementById('cfg-source-mode').value || 'local').trim(),
    local_path: (document.getElementById('cfg-local-path').value || '').trim(),
    git_url: (document.getElementById('cfg-git-url').value || '').trim(),
    git_branch: (document.getElementById('cfg-git-branch').value || 'main').trim(),
    explain_policy: explainPolicy,
    use_blackboard_history: !!(document.getElementById('cfg-use-blackboard').checked),
  };
}

function applyEngineProfileToForm(profileKey) {
  const engine = ENGINE_PROFILES.includes(profileKey) ? profileKey : 'duckdb';
  const setups = (runConfig && runConfig.engine_setups) || {};
  const setup = setups[engine] || {};
  document.getElementById('cfg-db-dsn').value = setup.db_dsn || '';
  document.getElementById('cfg-benchmark-dir').value = setup.benchmark_dir || '';
  document.getElementById('cfg-explain-policy').value = setup.explain_policy || runConfig.explain_policy || 'explain';
}

function onEngineProfileChanged() {
  const selected = (document.getElementById('cfg-engine-profile').value || 'duckdb').trim();
  // Persist edits from previous profile before switching.
  const prior = runConfig.engine_profile || 'duckdb';
  if (!runConfig.engine_setups || typeof runConfig.engine_setups !== 'object') {
    runConfig.engine_setups = defaultEngineSetups();
  }
  runConfig.engine_setups[prior] = {
    db_dsn: (document.getElementById('cfg-db-dsn').value || '').trim(),
    benchmark_dir: (document.getElementById('cfg-benchmark-dir').value || '').trim(),
    explain_policy: (document.getElementById('cfg-explain-policy').value || 'explain').trim(),
  };
  runConfig.engine_profile = selected;
  applyEngineProfileToForm(selected);
}

function toggleConfigSourceMode() {
  const mode = document.getElementById('cfg-source-mode').value;
  document.getElementById('cfg-local-path-wrap').style.display = mode === 'local' ? 'grid' : 'none';
  document.getElementById('cfg-git-wrap').style.display = mode === 'git' ? 'block' : 'none';
}

function openConfigModal() {
  const modal = document.getElementById('config-modal');
  runConfig = normalizeRunConfig(runConfig);
  document.getElementById('cfg-engine-profile').value = runConfig.engine_profile || 'duckdb';
  applyEngineProfileToForm(runConfig.engine_profile || 'duckdb');
  document.getElementById('cfg-source-mode').value = runConfig.source_mode || 'local';
  document.getElementById('cfg-local-path').value = runConfig.local_path || '';
  document.getElementById('cfg-git-url').value = runConfig.git_url || '';
  document.getElementById('cfg-git-branch').value = runConfig.git_branch || 'main';
  document.getElementById('cfg-use-blackboard').checked = runConfig.use_blackboard_history !== false;
  setConfigTestPending('db', false);
  setConfigTestPending('llm', false);
  setConfigTestStatus('db', 'idle', 'not tested');
  setConfigTestStatus('llm', 'idle', 'not tested');
  toggleConfigSourceMode();
  modal.classList.add('open');
}

function closeConfigModal() {
  const modal = document.getElementById('config-modal');
  modal.classList.remove('open');
}

function configModalBackdrop(evt) {
  if (evt.target && evt.target.id === 'config-modal') closeConfigModal();
}

function testConfigConnection(target) {
  if (target !== 'db' && target !== 'llm') return;
  if (!isLiveBackendMode()) {
    setConfigTestStatus(target, 'fail', 'backend unavailable in demo mode');
    return;
  }

  const cfg = collectConfigFromForm();
  const payload = { type: 'test_connection', target, config: cfg };
  setConfigTestPending(target, true);
  setConfigTestStatus(target, 'running', 'testing...');

  if (!sendWsMessage(payload, 'config')) {
    setConfigTestPending(target, false);
    setConfigTestStatus(target, 'fail', 'socket not ready');
    return;
  }

  addEvent('Config', `Testing ${target.toUpperCase()} connectivity...`, 'system');
}

function saveConfigSettings() {
  runConfig = normalizeRunConfig(collectConfigFromForm());

  try {
    localStorage.setItem(CONFIG_STORAGE_KEY, JSON.stringify(runConfig));
  } catch (e) {
    pushBackendLog('Failed to persist config in browser localStorage.', {
      level: 'warn',
      lane: 'SYS',
      source: 'config',
      payload: String(e),
    });
  }

  closeConfigModal();
  addEvent('Config', `Saved ${runConfig.source_mode.toUpperCase()} source settings.`, 'system');
  pushBackendLog('Configuration updated from UI.', {
    level: 'system',
    lane: 'SYS',
    source: 'config',
    payload: {
      ...runConfig,
      db_dsn: maskDsn(runConfig.db_dsn),
    },
  });

  const payload = { type: 'config_update', config: runConfig };
  if (!sendWsMessage(payload, 'config')) {
    pendingConfigSync = runConfig;
  }
}

function sendWsMessage(payload, source = 'fleet') {
  if (!isWsReady()) {
    pushBackendLog(`Socket not ready, deferred ${payload && payload.type ? payload.type : 'message'}.`, {
      level: 'warn',
      lane: 'WS OUT',
      source,
      payload: sanitizeBackendPayload(payload),
    });
    return false;
  }

  try {
    ws.send(JSON.stringify(payload));
    pushBackendLog(summarizeOutboundMessage(payload), {
      level: 'out',
      lane: 'WS OUT',
      source,
      payload: sanitizeBackendPayload(payload),
    });
    return true;
  } catch (e) {
    pushBackendLog(`Failed to send ${payload && payload.type ? payload.type : 'message'}.`, {
      level: 'error',
      lane: 'WS OUT',
      source,
      payload: String(e),
    });
    return false;
  }
}

// ── Simulation Engine ───────────────────────────────────────
function approveAndDeploy() {
  approveAndDeployWithMode('auto');
}

function runUiDemo() {
  approveAndDeployWithMode('demo');
}

function buildDemoPlan(queries) {
  // Deterministic status coverage for UI verification.
  const statuses = ['WIN', 'IMPROVED', 'NEUTRAL', 'REGRESSION', 'ERROR'];
  const speedMap = {
    WIN: 1.62,
    IMPROVED: 1.13,
    NEUTRAL: 1.00,
    REGRESSION: 0.86,
    ERROR: null,
  };
  const plan = {};
  for (let i = 0; i < queries.length; i++) {
    const q = queries[i];
    const status = statuses[i % statuses.length];
    const speedup = speedMap[status];
    plan[q.id] = {
      status,
      speedup,
      transform: q.transform || q.out_transform || '',
    };
  }
  return plan;
}

function approveAndDeployWithMode(mode = 'auto') {
  // Build execution list
  execQueries = QUERIES.filter(q => q.bucket !== 'SKIP' && !excludedIds.has(q.id));
  const runLive = isLiveBackendMode() && mode !== 'demo';
  currentRunMode = runLive ? 'live' : 'demo';
  demoPlanById = currentRunMode === 'demo' ? buildDemoPlan(execQueries) : {};
  // Lock execution/results numbers to exactly what user saw in triage.
  const triageSavingsEl = document.getElementById('triage-savings');
  const triageWorkloadEl = document.getElementById('triage-workload-cost');
  const shownSavings = parseMoneyTextToNumber(triageSavingsEl ? triageSavingsEl.textContent : '');
  const shownWorkload = parseMoneyTextToNumber(triageWorkloadEl ? triageWorkloadEl.textContent : '');

  plannedWorkloadCost = Number.isFinite(shownWorkload)
    ? shownWorkload
    : (Number.isFinite(triageWorkloadCost) ? triageWorkloadCost : calcEstimatedWorkloadCost(execQueries));
  plannedSavings = Number.isFinite(shownSavings)
    ? shownSavings
    : (Number.isFinite(triageProjectedSavings) ? triageProjectedSavings : calcEstimatedSavings(execQueries));

  // Priority order: HIGH first (by runtime desc), then MEDIUM, then LOW
  const bucketOrder = { HIGH: 0, MEDIUM: 1, LOW: 2 };
  execQueries.sort((a, b) => {
    const bo = (bucketOrder[a.bucket] || 9) - (bucketOrder[b.bucket] || 9);
    if (bo !== 0) return bo;
    return b.runtime_ms - a.runtime_ms;
  });

  queueOrder = execQueries.map(q => q.id);
  completedSet = {};
  workerState = [null, null, null, null];
  workerTimers = [0, 0, 0, 0];
  clockSeconds = 0;
  apiCalls = 0;
  queryApiCallsById = {};
  queryStartClockById = {};
  runningQueryIds = new Set();
  isPaused = false;
  eventEntries = [];
  resultEntries = [];
  queryPhaseById = {};
  awaitingServerStart = false;
  pendingApprovePlan = null;
  pendingConfigSync = null;

  const fleetWorkers = Math.max(
    1,
    Number(activeRunContext.fleet_concurrency || workerState.length) || workerState.length,
  );
  const planPayload = {
    excluded: Array.from(excludedIds),
    overrides: execQueries.map(q => ({ id: q.id, iters: q.iters })),
    config: runConfig,
  };

  clearBackendConsole(false);
  pushBackendLog(`Run start requested (${execQueries.length} queries, ${fleetWorkers} workers).`, {
    level: 'system',
    lane: 'SYS',
    source: 'fleet',
    payload: {
      selected_queries: execQueries.length,
      excluded_queries: excludedIds.size,
      mode: currentRunMode,
    },
  });

  // Send approval via WebSocket in live mode.
  if (runLive) {
    if (isWsReady()) {
      sendWsMessage({ type: 'approve', plan: planPayload }, 'fleet');
    } else {
      awaitingServerStart = true;
      pendingApprovePlan = planPayload;
      pushBackendLog('Run approval queued until websocket reconnects.', {
        level: 'warn',
        lane: 'SYS',
        source: 'fleet',
        payload: sanitizeBackendPayload({ type: 'approve', plan: planPayload }),
      });
      try { connectWebSocket(); } catch (e) {}
    }
  }

  // Transition views
  state = 'running';
  switchTab('execution');
  updateResultsView();

  // Update header status
  setHeaderStatus('running');

  // Clear log
  document.getElementById('event-log').innerHTML = '';
  addEvent('Fleet', `Started (${execQueries.length} queries, ${fleetWorkers} workers)`, 'system');
  if (runLive) {
    if (awaitingServerStart) addEvent('Fleet', 'WebSocket not ready. Approval queued; reconnecting...', 'system');
    else addEvent('Fleet', 'Approval sent to backend. Waiting for first worker assignment...', 'system');
  } else {
    addEvent('Fleet', 'UI demo run started (local simulation, backend untouched).', 'system');
    setRunContext({ mode_summary: 'beam demo' });
  }

  // Start clock
  clockInterval = setInterval(() => {
    if (isPaused) return;
    clockSeconds++;
    // Tick worker timers
    for (let i = 0; i < 4; i++) {
      if (workerState[i]) workerTimers[i]++;
    }
    updateExecStats();
    renderWorkers();
    renderExecTable();
  }, 1000);

  // Simulation: only run fake completions in demo mode.
  if (!runLive) {
    for (let i = 0; i < 4; i++) assignWorker(i);
    scheduleNextCompletion();
  }

  renderExecTable();
  renderWorkers();
  renderQueue();
  updateExecStats();
}

function assignWorker(workerIdx) {
  if (queueOrder.length === 0) {
    const prevQid = workerState[workerIdx];
    if (prevQid) runningQueryIds.delete(prevQid);
    workerState[workerIdx] = null;
    workerTimers[workerIdx] = 0;
    return;
  }

  const qid = queueOrder.shift();
  const prevQid = workerState[workerIdx];
  if (prevQid) runningQueryIds.delete(prevQid);
  workerState[workerIdx] = qid;
  workerTimers[workerIdx] = 0;
  apiCalls += 4;
  runningQueryIds.add(qid);
  queryStartClockById[qid] = clockSeconds;
  queryPhaseById[qid] = 'workers';

  addEvent(`W${workerIdx + 1}`, `Assigned ${qid}`, 'assign');
  renderQueue();
  renderWorkers();
}

function completeQuery(workerIdx) {
  const qid = workerState[workerIdx];
  if (!qid) return;

  const q = QUERIES.find(q => q.id === qid);
  if (!q) return;

  const demoEntry = demoPlanById[qid] || null;
  const status = demoEntry ? demoEntry.status : (q.outcome || 'NEUTRAL');
  const speedup = demoEntry
    ? (Number.isFinite(Number(demoEntry.speedup)) ? Number(demoEntry.speedup) : null)
    : (q.speedup || 1.0);
  const elapsed = workerTimers[workerIdx];
  queryPhaseById[qid] = 'done';
  runningQueryIds.delete(qid);
  const transformName = demoEntry ? (demoEntry.transform || '') : (q.out_transform || '');

  completedSet[qid] = {
    status,
    speedup: Number.isFinite(Number(speedup)) ? Number(speedup) : 1.0,
    transform: transformName,
    elapsed_s: elapsed,
  };
  appendResultEntry({
    query_id: qid,
    status,
    speedup: Number.isFinite(Number(speedup)) ? Number(speedup) : null,
    transform: transformName,
    source: 'simulation',
  });

  // Log event
  let msg = '';
  if ((status === 'WIN' || status === 'IMPROVED') && Number.isFinite(Number(speedup))) {
    msg = `${status} ${Number(speedup).toFixed(2)}x${transformName ? ` (${transformName})` : ''}`;
  } else if ((status === 'NEUTRAL' || status === 'REGRESSION') && Number.isFinite(Number(speedup))) {
    msg = `${status} ${Number(speedup).toFixed(2)}x`;
  } else if (status === 'ERROR') {
    msg = 'ERROR (simulated validation failure)';
  } else {
    msg = status;
  }

  addEvent(qid, msg, status.toLowerCase());
  addEvent(`W${workerIdx + 1}`, `Freed`, 'system');

  // Assign next
  assignWorker(workerIdx);
  updateExecStats();
  renderExecTable();
  renderWorkers();

  // Check if all done
  const allDone = execQueries.every(q => completedSet[q.id]);
  if (allDone) {
    clearInterval(clockInterval);
    clearTimeout(simInterval);
    setTimeout(showDone, 800);
  } else {
    scheduleNextCompletion();
  }
}

function scheduleNextCompletion() {
  const delay = 3000 + Math.random() * 4000; // 3-7 seconds
  simInterval = setTimeout(() => {
    if (isPaused) { scheduleNextCompletion(); return; }

    // Find a busy worker
    const busyWorkers = workerState.map((w, i) => w ? i : -1).filter(i => i >= 0);
    if (busyWorkers.length === 0) return;

    // Pick the one that's been running longest
    let pick = busyWorkers[0];
    for (const wi of busyWorkers) {
      if (workerTimers[wi] > workerTimers[pick]) pick = wi;
    }
    const activeQid = workerState[pick];
    if (activeQid && queryPhaseById[activeQid] !== 'benchmark') {
      queryPhaseById[activeQid] = 'benchmark';
      renderWorkers();
      renderExecTable();
    }

    completeQuery(pick);
  }, delay);
}

function togglePause() {
  isPaused = !isPaused;
  const btn = document.getElementById('btn-pause');
  if (isPaused) {
    state = 'paused';
    btn.textContent = 'Resume';
    setHeaderStatus('paused');
    addEvent('Fleet', 'Paused', 'system');
    if (currentRunMode === 'live') {
      sendWsMessage({ type: 'pause' }, 'fleet');
    }
  } else {
    state = 'running';
    btn.textContent = 'Pause All';
    setHeaderStatus('running');
    addEvent('Fleet', 'Resumed', 'system');
    if (currentRunMode === 'live') {
      sendWsMessage({ type: 'resume' }, 'fleet');
    }
  }
}

function showDone() {
  state = 'done';
  switchTab('done');

  setHeaderStatus('done');
  updateResultsView();
}

function setHeaderStatus(s) {
  const el = document.getElementById('header-status');
  const labels = { triage: 'TRIAGE REVIEW', running: 'RUNNING', paused: 'PAUSED', done: 'COMPLETE' };
  const dotCls = { triage: 'blue pulse', running: 'green pulse', paused: 'amber', done: 'green' };
  const wrapCls = { triage: 'triage', running: 'running', paused: 'paused', done: 'done' };

  el.className = 'status-indicator ' + wrapCls[s];
  el.innerHTML = `<span class="status-dot ${dotCls[s]}"></span>${labels[s]}`;
}

function exportPlan() {
  const plan = QUERIES.filter(q => !excludedIds.has(q.id) && q.bucket !== 'SKIP').map(q => ({
    query_id: q.id,
    bucket: q.bucket,
    max_iterations: q.iters,
    transform: q.transform,
    est_annual_cost: Math.round(queryAnnualCostEstimate(q)),
  }));

  const blob = new Blob([JSON.stringify({ plan, timestamp: new Date().toISOString() }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_plan.json';
  a.click();
  URL.revokeObjectURL(url);
}

function exportResults() {
  const results = execQueries.map(q => {
    const r = completedSet[q.id] || {};
    const annualCost = queryAnnualCostEstimate(q);
    return {
      query_id: q.id,
      bucket: q.bucket,
      status: r.status || 'SKIPPED',
      speedup: r.speedup || null,
      transform: r.transform || '',
      est_annual_cost: Math.round(annualCost),
      est_annual_saved: r.speedup > 1 ? Math.round(annualCost * (1 - 1/r.speedup)) : 0,
    };
  });

  const blob = new Blob([JSON.stringify({ results, elapsed_seconds: clockSeconds, timestamp: new Date().toISOString() }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_results.json';
  a.click();
  URL.revokeObjectURL(url);
}

// Wire exec sort headers
document.querySelectorAll('#exec-table th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.esort;
    if (execSortCol === col) execSortDir *= -1;
    else { execSortCol = col; execSortDir = col === 'query_id' ? 1 : -1; }
    renderExecTable();
  });
});

// ── Tab Switching ────────────────────────────────────────────
function switchTab(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active', 'fade-in'));
  const target = document.getElementById('view-' + name);
  if (target) target.classList.add('active', 'fade-in');

  document.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.tab === name);
  });
  if (name === 'done') updateResultsView();
}

// ── Editor Functions ─────────────────────────────────────────

// SQL Syntax Highlighting
function highlightSQL(text) {
  if (!text) return '';
  // Escape HTML first
  let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

  // Tokenize with regex — order matters (comments/strings first to avoid keyword matches inside them)
  const tokens = [];
  const re = /--[^\n]*|\/\*[\s\S]*?\*\/|'(?:[^'\\]|\\.)*'|"(?:[^"\\]|\\.)*"|\b\d+(?:\.\d+)?\b|\b[a-zA-Z_]\w*\b|[<>=!]+|[+\-*/%,;().|]/g;

  const SQL_KW = new Set(['SELECT','FROM','WHERE','JOIN','ON','AND','OR','NOT','IN','EXISTS','BETWEEN',
    'LIKE','AS','GROUP','BY','ORDER','HAVING','LIMIT','UNION','ALL','DISTINCT','INSERT','UPDATE','DELETE',
    'CREATE','DROP','ALTER','TABLE','INDEX','WITH','CASE','WHEN','THEN','ELSE','END','IS','NULL','LEFT',
    'RIGHT','INNER','OUTER','CROSS','FULL','COUNT','SUM','AVG','MIN','MAX','OVER','PARTITION','WINDOW',
    'ROWS','RANGE','PRECEDING','FOLLOWING','CURRENT','ROW','ASC','DESC','SET','VALUES','INTO','TRUE',
    'FALSE','CAST','COALESCE','NULLIF','EXCEPT','INTERSECT','RECURSIVE','LATERAL','FETCH','OFFSET',
    'TABLESAMPLE','FILTER','WITHIN','ROLLUP','CUBE','GROUPING','SETS','USING','NATURAL','ANY','SOME',
    'ILIKE','SIMILAR','ARRAY','UNNEST','GENERATE_SERIES','SUBSTRING','TRIM','EXTRACT','DATE','INTERVAL']);
  const SQL_OP = new Set(['<','>','<=','>=','<>','!=','=','||','::','+','-','*','/','%']);

  // Process text char by char to build highlighted output
  let result = '';
  let i = 0;
  const src = text;
  while (i < src.length) {
    // Line comments
    if (src[i] === '-' && src[i+1] === '-') {
      let end = src.indexOf('\n', i);
      if (end === -1) end = src.length;
      result += '<span class="sql-comment">' + escH(src.slice(i, end)) + '</span>';
      i = end;
      continue;
    }
    // Block comments
    if (src[i] === '/' && src[i+1] === '*') {
      let end = src.indexOf('*/', i + 2);
      if (end === -1) end = src.length; else end += 2;
      result += '<span class="sql-comment">' + escH(src.slice(i, end)) + '</span>';
      i = end;
      continue;
    }
    // Strings
    if (src[i] === "'") {
      let j = i + 1;
      while (j < src.length) {
        if (src[j] === "'" && src[j+1] === "'") { j += 2; continue; }
        if (src[j] === "'") { j++; break; }
        j++;
      }
      result += '<span class="sql-str">' + escH(src.slice(i, j)) + '</span>';
      i = j;
      continue;
    }
    // Numbers
    if (/\d/.test(src[i]) && (i === 0 || /[\s,()=<>!+\-*/%;]/.test(src[i-1]))) {
      let j = i;
      while (j < src.length && /[\d.]/.test(src[j])) j++;
      result += '<span class="sql-num">' + escH(src.slice(i, j)) + '</span>';
      i = j;
      continue;
    }
    // Words (keywords or identifiers)
    if (/[a-zA-Z_]/.test(src[i])) {
      let j = i;
      while (j < src.length && /\w/.test(src[j])) j++;
      const word = src.slice(i, j);
      const upper = word.toUpperCase();
      // Check if it's a function call (followed by open paren)
      let k = j;
      while (k < src.length && src[k] === ' ') k++;
      if (k < src.length && src[k] === '(' && !SQL_KW.has(upper)) {
        result += '<span class="sql-fn">' + escH(word) + '</span>';
      } else if (SQL_KW.has(upper)) {
        result += '<span class="sql-kw">' + escH(word) + '</span>';
      } else {
        result += escH(word);
      }
      i = j;
      continue;
    }
    // Operators
    if (src[i] === ':' && src[i+1] === ':') {
      result += '<span class="sql-op">::</span>';
      i += 2;
      continue;
    }
    if (src[i] === '|' && src[i+1] === '|') {
      result += '<span class="sql-op">||</span>';
      i += 2;
      continue;
    }
    if (src[i] === '<' && src[i+1] === '>') {
      result += '<span class="sql-op">&lt;&gt;</span>';
      i += 2;
      continue;
    }
    if (src[i] === '!' && src[i+1] === '=') {
      result += '<span class="sql-op">!=</span>';
      i += 2;
      continue;
    }
    if (src[i] === '<' && src[i+1] === '=') {
      result += '<span class="sql-op">&lt;=</span>';
      i += 2;
      continue;
    }
    if (src[i] === '>' && src[i+1] === '=') {
      result += '<span class="sql-op">&gt;=</span>';
      i += 2;
      continue;
    }
    if (SQL_OP.has(src[i])) {
      result += '<span class="sql-op">' + escH(src[i]) + '</span>';
      i++;
      continue;
    }
    // Default: pass through
    result += escH(src[i]);
    i++;
  }
  return result;
}

function escH(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function updateEditorHighlights() {
  const leftTA = document.getElementById('editor-original');
  const rightTA = document.getElementById('editor-rewrite');
  const leftHL = document.getElementById('editor-highlight-left');
  const rightHL = document.getElementById('editor-highlight-right');

  leftHL.querySelector('code').innerHTML = highlightSQL(leftTA.value) + '\n';
  rightHL.querySelector('code').innerHTML = highlightSQL(rightTA.value) + '\n';
}

function syncHighlightScroll(textarea, highlight) {
  highlight.scrollTop = textarea.scrollTop;
  highlight.scrollLeft = textarea.scrollLeft;
}

// EXPLAIN Bottleneck Analysis — supports PostgreSQL arrow format and DuckDB box-drawing
function renderExplainAnalysis(explainText) {
  if (!explainText) return '<div style="color:var(--t3);font-size:12px;padding:12px">No EXPLAIN data available</div>';

  // Detect DuckDB box-drawing format (contains ┌ or │ characters)
  if (/[┌│└┐┘├┤┬┴┼─]/.test(explainText)) {
    return parseDuckDBExplain(explainText);
  }
  return parsePGExplain(explainText);
}

function parseDuckDBExplain(text) {
  const lines = text.split('\n');
  const nodes = [];
  let totalTime = 0;
  let currentNode = null;

  for (const line of lines) {
    // Node name: line inside box with only UPPER_CASE_NAME (e.g. │     HASH_GROUP_BY     │)
    const nameMatch = line.match(/│\s+([A-Z][A-Z_0-9]+(?:\s+[A-Z_0-9]+)*)\s+│/);
    if (nameMatch && !/rows|est|time|Groups|Aggregates|Order|Conditions|Name|Index|Top:|filter|Scan|Join|QUERY|EXPLAIN|Profiling/i.test(nameMatch[1])) {
      // Skip if it looks like a detail label
      if (/^(LEFT|RIGHT|INNER|OUTER|MARK|SINGLE)$/.test(nameMatch[1])) continue;
      currentNode = { name: nameMatch[1], rows: null, time: null, indent: line.indexOf('│') };
      nodes.push(currentNode);
    }

    // Row count: "539,331 rows" or "100 rows"
    const rowMatch = line.match(/│\s+([\d,]+)\s+rows?\s+│/);
    if (rowMatch && currentNode) {
      currentNode.rows = parseInt(rowMatch[1].replace(/,/g, ''));
    }

    // Time: "(0.38s)" or "(0.00s)"
    const timeMatch = line.match(/│\s+\(([\d.]+)s\)\s+│/);
    if (timeMatch && currentNode) {
      currentNode.time = parseFloat(timeMatch[1]) * 1000; // convert to ms
    }

    // Total time from header: "Total Time: 0.217s"
    const totalMatch = line.match(/Total Time:\s*([\d.]+)s/);
    if (totalMatch) {
      totalTime = parseFloat(totalMatch[1]) * 1000;
    }

    // Filter detail: "filter: ..."
    const filterMatch = line.match(/│\s+(filter:|Join Type:|Top:|Sort Key:)\s*(.*?)\s*│/);
    if (filterMatch && currentNode) {
      if (!currentNode.details) currentNode.details = [];
      currentNode.details.push(filterMatch[1] + ' ' + filterMatch[2]);
    }
  }

  // Filter out overhead nodes with 0 time and 0 rows (PROJECTION, CTE wrappers)
  const meaningful = nodes.filter(n => n.time > 0 || (n.rows && n.rows > 1000));

  if (meaningful.length === 0 && nodes.length === 0) {
    return '<pre class="explain-pre" style="max-height:25vh;font-size:12px">' + escH(text) + '</pre>';
  }

  const displayNodes = meaningful.length > 0 ? meaningful : nodes;
  if (!totalTime && displayNodes.length > 0) {
    totalTime = Math.max(...displayNodes.map(n => n.time || 0));
  }

  const maxTime = Math.max(...displayNodes.map(n => n.time || 0));

  let html = '<div class="explain-summary">';
  html += `Total: <strong>${fmtMs(totalTime)}</strong>`;
  const bottleneck = displayNodes.find(n => n.time === maxTime && n.time > 0 && n.time < totalTime);
  if (bottleneck) {
    html += ` &middot; Bottleneck: <strong style="color:var(--red)">${esc(bottleneck.name)}</strong> (${fmtMs(bottleneck.time)})`;
  }
  html += `  &middot; <span style="color:var(--t3)">${nodes.length} operators</span>`;
  html += '</div>';

  for (const n of displayNodes) {
    const isBottleneck = n.time === maxTime && n.time > 0 && n.time < totalTime;
    const pct = totalTime > 0 && n.time ? (n.time / totalTime) * 100 : 0;
    const barClass = pct > 60 ? 'high' : pct > 25 ? 'mid' : 'low';

    html += `<div class="explain-node${isBottleneck ? ' explain-bottleneck' : ''}" style="padding-left:8px">`;
    html += `<span class="explain-node-name">${esc(n.name)}</span>`;
    if (isBottleneck) html += '<span class="explain-badge">bottleneck</span>';
    if (n.time !== null) {
      html += `<div class="explain-bar"><div class="explain-bar-fill ${barClass}" style="width:${Math.max(2, pct)}%"></div></div>`;
      html += `<span class="explain-time">${fmtMs(n.time)}</span>`;
    }
    if (n.rows !== null) {
      html += `<span class="explain-accuracy" style="color:var(--t3)">${n.rows.toLocaleString()} rows</span>`;
    }
    html += '</div>';
    if (n.details) {
      for (const d of n.details) {
        html += `<div class="explain-node" style="padding-left:20px"><span class="explain-node-name" style="color:var(--t3);font-style:italic;font-size:11px">${esc(d)}</span></div>`;
      }
    }
  }

  return html;
}

function parsePGExplain(text) {
  const lines = text.split('\n').filter(l => l.trim());
  const nodes = [];

  for (const line of lines) {
    const m = line.match(/^(\s*)->?\s*(.+?)\s+\(time=([\d.]+)ms(?:,\s*rows=(\d+)(?:\s*\(est\s+(\d+)\))?)?\)/);
    if (m) {
      nodes.push({
        indent: m[1].length,
        name: m[2],
        time: parseFloat(m[3]),
        rows: m[4] ? parseInt(m[4]) : null,
        est: m[5] ? parseInt(m[5]) : null,
      });
    } else {
      const m2 = line.match(/^(\s*)(filter|Filter|Index Cond|Sort Key|Hash Cond|Merge Cond|Join Filter|Recheck Cond):\s*(.*)/);
      if (m2) {
        nodes.push({
          indent: m2[1].length + 2,
          name: m2[2] + ': ' + m2[3],
          time: 0, rows: null, est: null, isDetail: true,
        });
      }
    }
  }

  if (nodes.length === 0) {
    return '<pre class="explain-pre" style="max-height:25vh">' + escH(text) + '</pre>';
  }

  const maxTime = Math.max(...nodes.filter(n => !n.isDetail).map(n => n.time));
  const totalTime = nodes.length > 0 && !nodes[0].isDetail ? nodes[0].time : maxTime;

  let html = '<div class="explain-summary">';
  html += `Total: <strong>${fmtMs(totalTime)}</strong>`;
  const bottleneck = nodes.find(n => n.time === maxTime && !n.isDetail && n !== nodes[0]);
  if (bottleneck) {
    html += ` &middot; Bottleneck: <strong style="color:var(--red)">${esc(bottleneck.name)}</strong> (${fmtMs(bottleneck.time)})`;
  }
  html += '</div>';

  for (const n of nodes) {
    if (n.isDetail) {
      html += `<div class="explain-node" style="padding-left:${12 + n.indent * 8}px">`;
      html += `<span class="explain-node-name" style="color:var(--t3);font-style:italic">${esc(n.name)}</span>`;
      html += '</div>';
      continue;
    }

    const isBottleneck = n.time === maxTime && n !== nodes[0] && maxTime > 0;
    const pct = totalTime > 0 ? (n.time / totalTime) * 100 : 0;
    const barClass = pct > 60 ? 'high' : pct > 25 ? 'mid' : 'low';

    html += `<div class="explain-node${isBottleneck ? ' explain-bottleneck' : ''}" style="padding-left:${8 + n.indent * 8}px">`;
    html += `<span class="explain-node-name">${esc(n.name)}</span>`;
    if (isBottleneck) html += '<span class="explain-badge">bottleneck</span>';
    html += `<div class="explain-bar"><div class="explain-bar-fill ${barClass}" style="width:${Math.max(2, pct)}%"></div></div>`;
    html += `<span class="explain-time">${fmtMs(n.time)}</span>`;

    if (n.rows !== null && n.est !== null && n.est > 0) {
      const ratio = n.rows / n.est;
      const ratioStr = ratio >= 100 ? Math.round(ratio) + 'x' : ratio >= 10 ? ratio.toFixed(0) + 'x' : ratio.toFixed(1) + 'x';
      const accClass = ratio > 10 || ratio < 0.1 ? 'bad' : 'good';
      html += `<span class="explain-accuracy ${accClass}" title="actual/est = ${n.rows}/${n.est}">${ratioStr}</span>`;
    } else {
      html += '<span class="explain-accuracy"></span>';
    }

    html += '</div>';
  }

  return html;
}

function populateEditorDropdown() {
  const sel = document.getElementById('editor-query-select');
  sel.innerHTML = '<option value="">Select a query...</option>';
  const sorted = [...QUERIES].sort((a, b) => b.runtime_ms - a.runtime_ms);
  for (const q of sorted) {
    const label = `${q.id}  ${fmtMs(q.runtime_ms)}  [${q.bucket}]`;
    const opt = document.createElement('option');
    opt.value = q.id;
    opt.textContent = label;
    sel.appendChild(opt);
  }
}

function editorSelectQuery(qid) {
  editorQueryId = qid;
  const sel = document.getElementById('editor-query-select');
  if (sel.value !== qid) sel.value = qid;

  const q = QUERIES.find(q => q.id === qid);
  if (!q) {
    pendingEditorRequest = null;
    editorSteps = [];
    document.getElementById('editor-original').value = '';
    document.getElementById('editor-rewrite').value = '';
    document.getElementById('editor-meta').innerHTML = '';
    document.getElementById('btn-beam').disabled = true;
    document.getElementById('btn-strike').disabled = true;
    updateEditorGutters();
    updateEditorHighlights();
    updateEditorContext(null);
    populateStrategyDropdown(null);
    return;
  }

  document.getElementById('editor-original').value = q.sql || '';
  document.getElementById('editor-rewrite').value = '';  // Blank until optimization completes
  document.getElementById('btn-beam').disabled = false;
  document.getElementById('btn-strike').disabled = false;

  // Meta strip
  let meta = `<span>${fmtMs(q.runtime_ms)}</span>`;
  meta += ` <span>${bucketBadge(q.bucket)}</span>`;
  if (q.transform) {
    meta += ` <span style="font-family:var(--mono);font-size:11px;color:var(--purple)">${esc(q.transform)} ${Math.round(q.overlap * 100)}%</span>`;
  }
  document.getElementById('editor-meta').innerHTML = meta;

  updateEditorGutters();
  updateEditorHighlights();
  updateEditorContext(q);
  populateStrategyDropdown(q);
  editorResults = [];
  editorSteps = [];
  renderEditorResults();
}

function updateEditorContext(q) {
  // EXPLAIN — render bottleneck analysis
  const explainContainer = document.getElementById('editor-explain-container');
  explainContainer.innerHTML = renderExplainAnalysis(q && q.detail ? q.detail.explain : null);

  // Transforms
  const txEl = document.getElementById('editor-transforms-content');
  if (!q || !q.detail || !q.detail.transforms || q.detail.transforms.length === 0) {
    txEl.innerHTML = '<div style="color:var(--t3)">No structural matches (discovery mode)</div>';
  } else {
    let html = '';
    for (const t of q.detail.transforms) {
      html += '<div class="transform-row">';
      html += `<span class="transform-name">${esc(t.id)}</span>`;
      html += `<span class="transform-family">${esc(t.family)}</span>`;
      html += `<div class="overlap-bar-wrap"><div class="overlap-bar" style="width:${Math.round(t.overlap * 100)}%"></div></div>`;
      html += `<span class="overlap-pct">${Math.round(t.overlap * 100)}%</span>`;
      if (t.gap) html += `<span class="transform-gap">${esc(t.gap)}</span>`;
      html += '</div>';
    }
    txEl.innerHTML = html;
  }

  // Knowledge (structural flags + q-error)
  const knEl = document.getElementById('editor-knowledge-content');
  if (!q || !q.detail) {
    knEl.innerHTML = '<div style="color:var(--t3)">No query selected</div>';
  } else {
    let html = '';
    if (q.detail.structural_flags && q.detail.structural_flags.length > 0) {
      html += '<div style="margin-bottom:8px"><span style="font-family:var(--mono);font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:0.08em">Structural Flags</span><br>';
      for (const f of q.detail.structural_flags) {
        html += `<span class="flag-tag">${esc(f)}</span>`;
      }
      html += '</div>';
    }
    if (q.detail.qerror) {
      const qe = q.detail.qerror;
      const sevCls = qe.severity.toLowerCase();
      html += '<div><span style="font-family:var(--mono);font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:0.08em">Q-Error Analysis</span>';
      html += `<div class="detail-kv"><span class="dk-label">Severity</span><span class="qerror-badge ${sevCls}">${esc(qe.severity)}</span></div>`;
      html += `<div class="detail-kv"><span class="dk-label">Direction</span><span class="dk-value">${esc(qe.direction.replace('_',' '))}</span></div>`;
      html += `<div class="detail-kv"><span class="dk-label">Worst node</span><span class="dk-value">${esc(qe.worst_node)}</span></div>`;
      html += `<div class="detail-kv"><span class="dk-label">Max q-error</span><span class="dk-value" style="color:${qe.max_q_error > 10 ? 'var(--red)' : 'var(--t1)'}">${qe.max_q_error.toFixed(1)}x</span></div>`;
      html += '</div>';
    }
    knEl.innerHTML = html || '<div style="color:var(--t3)">No additional context</div>';
  }
}

function updateEditorGutters() {
  const leftTA = document.getElementById('editor-original');
  const rightTA = document.getElementById('editor-rewrite');
  const leftG = document.getElementById('editor-gutter-left');
  const rightG = document.getElementById('editor-gutter-right');

  const makeGutter = (text) => {
    const lines = (text || '').split('\n').length;
    let html = '';
    for (let i = 1; i <= Math.max(lines, 1); i++) {
      html += `<span>${i}</span>`;
    }
    return html;
  };

  leftG.innerHTML = makeGutter(leftTA.value);
  rightG.innerHTML = makeGutter(rightTA.value);
}

function syncGutterScroll(textarea, gutter) {
  gutter.scrollTop = textarea.scrollTop;
}

function initEditorDivider() {
  const divider = document.getElementById('editor-divider');
  const split = document.getElementById('editor-split');
  const left = document.getElementById('editor-pane-left');
  const right = document.getElementById('editor-pane-right');

  divider.addEventListener('mousedown', (e) => {
    e.preventDefault();
    editorDividerDragging = true;
    divider.classList.add('dragging');
    document.body.style.cursor = 'col-resize';
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mousemove', (e) => {
    if (!editorDividerDragging) return;
    const rect = split.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const pct = (x / rect.width) * 100;
    const clamped = Math.max(20, Math.min(80, pct));
    left.style.flex = 'none';
    right.style.flex = 'none';
    left.style.width = clamped + '%';
    right.style.width = (100 - clamped) + '%';
  });

  document.addEventListener('mouseup', () => {
    if (editorDividerDragging) {
      editorDividerDragging = false;
      divider.classList.remove('dragging');
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
    }
  });
}

function editorSubTab(panel) {
  editorActiveSubtab = panel;
  document.querySelectorAll('.editor-subtab').forEach(b => {
    b.classList.toggle('active', b.dataset.panel === panel);
  });
  document.querySelectorAll('.editor-subtab-content').forEach(c => {
    c.classList.toggle('active', c.id === 'editor-panel-' + panel);
  });
}

function toggleEditorContext() {
  editorContextCollapsed = !editorContextCollapsed;
  document.getElementById('editor-ctx-body').classList.toggle('open', !editorContextCollapsed);
  document.getElementById('editor-ctx-toggle').classList.toggle('open', !editorContextCollapsed);
}

function renderEditorStepLog() {
  if (!editorSteps.length) return '';
  let html = '<div class="editor-step-log">';
  for (const s of editorSteps.slice(-10)) {
    html += `<div class="editor-step ${esc(s.level || 'system')}">`;
    html += `<span class="editor-step-ts">${esc(s.ts)}</span>`;
    html += `<span>${esc(s.msg)}</span>`;
    html += '</div>';
  }
  html += '</div>';
  return html;
}

function pushEditorStep(msg, level = 'system') {
  const now = new Date();
  const ts = [now.getHours(), now.getMinutes(), now.getSeconds()]
    .map(n => String(n).padStart(2, '0')).join(':');
  editorSteps.push({ ts, msg, level });
  if (editorSteps.length > 200) editorSteps.shift();
  if (editorFiring) {
    document.getElementById('editor-spinner-text').textContent = msg;
  }
  renderEditorResults();
}

function dispatchEditorRequest(payload) {
  const mode = payload.type === 'editor_strike' ? 'Strike' : 'Beam';
  if (isWsReady()) {
    const sent = sendWsMessage(payload, 'editor');
    if (sent) {
      pushEditorStep(`${mode} request dispatched to backend.`);
      return true;
    }
  }
  pendingEditorRequest = payload;
  pushEditorStep(`WebSocket not ready. Queued ${mode} request and reconnecting...`, 'error');
  pushBackendLog(`${mode} request queued; reconnecting websocket.`, {
    level: 'warn',
    lane: 'SYS',
    source: 'editor',
    payload: sanitizeBackendPayload(payload),
  });
  try { connectWebSocket(); } catch (e) {}
  return false;
}

function editorFireBeam() {
  if (editorFiring || !editorQueryId) return;
  editorFiring = true;
  editorResults = [];
  editorSteps = [];
  renderEditorResults();
  editorSubTab('results');

  document.getElementById('editor-spinner').classList.add('active');
  document.getElementById('editor-spinner-text').textContent = 'Preparing Beam request...';
  document.getElementById('btn-beam').disabled = true;
  document.getElementById('btn-strike').disabled = true;

  // Use original SQL if rewrite pane is blank
  let sql = document.getElementById('editor-rewrite').value;
  if (!sql.trim()) sql = document.getElementById('editor-original').value;
  pushEditorStep(`Beam requested for ${editorQueryId}.`);

  if (IS_DEMO) {
    pushEditorStep('Demo mode detected. Running local simulation.');
    simulateEditorResults(3);
  } else if (!dispatchEditorRequest({ type: 'editor_beam', query_id: editorQueryId, sql, max_iterations: 3 })) {
    document.getElementById('editor-spinner-text').textContent = 'Connecting to backend...';
  }
}

function editorFireStrike() {
  if (editorFiring || !editorQueryId) return;
  const strategySel = document.getElementById('editor-strategy-select');
  const strategy = strategySel ? strategySel.value : '';

  editorFiring = true;
  editorResults = [];
  editorSteps = [];
  renderEditorResults();
  editorSubTab('results');

  document.getElementById('editor-spinner').classList.add('active');
  document.getElementById('editor-spinner-text').textContent = strategy ? `Preparing Strike: ${strategy}...` : 'Preparing Strike...';
  document.getElementById('btn-beam').disabled = true;
  document.getElementById('btn-strike').disabled = true;

  // Use original SQL if rewrite pane is blank
  let sql = document.getElementById('editor-rewrite').value;
  if (!sql.trim()) sql = document.getElementById('editor-original').value;
  pushEditorStep(`Strike requested for ${editorQueryId}${strategy ? ` (${strategy})` : ''}.`);

  if (IS_DEMO) {
    pushEditorStep('Demo mode detected. Running local simulation.');
    simulateEditorResults(1, strategy);
  } else if (!dispatchEditorRequest({ type: 'editor_strike', query_id: editorQueryId, sql, strategy, max_iterations: 1 })) {
    document.getElementById('editor-spinner-text').textContent = 'Connecting to backend...';
  }
}

function populateStrategyDropdown(q) {
  const sel = document.getElementById('editor-strategy-select');
  sel.innerHTML = '<option value="" disabled selected>Select strategy...</option>';
  if (!q || !q.detail || !q.detail.transforms || q.detail.transforms.length === 0) return;
  for (const t of q.detail.transforms) {
    const opt = document.createElement('option');
    opt.value = t.id;
    const familyBadge = t.family ? ` [${t.family}]` : '';
    opt.textContent = `${t.id}  ${Math.round(t.overlap * 100)}%${familyBadge}`;
    sel.appendChild(opt);
  }
}

function editorStrategyChanged() {
  // Strategy is optional — strike always available when a query is selected
}

function simulateEditorResults(iterations, strategy) {
  const q = QUERIES.find(q => q.id === editorQueryId);
  let iter = 0;
  const defaultTransforms = ['decorrelate', 'pushdown', 'or_to_union', 'date_cte_isolate'];
  const runIter = () => {
    iter++;
    const patches = [];
    for (let w = 1; w <= 4; w++) {
      const sp = 0.8 + Math.random() * 2.5;
      const st = sp >= 1.3 ? 'WIN' : sp >= 1.05 ? 'IMPROVED' : sp >= 0.95 ? 'NEUTRAL' : 'REGRESSION';
      patches.push({
        id: `iter${iter}-w${w}`,
        iteration: iter,
        worker_id: w,
        speedup: Math.round(sp * 100) / 100,
        status: st,
        transform: strategy || defaultTransforms[w - 1],
        sql: (q ? q.sql : '') + `\n-- Rewrite by W${w} iter ${iter}`,
      });
    }
    editorResults.push(...patches);
    pushEditorStep(`Iteration ${iter}: generated ${patches.length} simulated candidates.`, 'system');
    renderEditorResults();
    document.getElementById('editor-spinner-text').textContent = `Iteration ${iter}/${iterations}...`;

    if (iter < iterations) {
      setTimeout(runIter, 2000 + Math.random() * 1500);
    } else {
      editorFiring = false;
      document.getElementById('editor-spinner').classList.remove('active');
      document.getElementById('btn-beam').disabled = false;
      document.getElementById('btn-strike').disabled = false;
      pushEditorStep('Simulation complete.', 'system');

      // Load best into rewrite pane
      const best = [...editorResults].sort((a, b) => b.speedup - a.speedup)[0];
      if (best && best.sql) {
        document.getElementById('editor-rewrite').value = best.sql;
        updateEditorGutters();
        updateEditorHighlights();
      }
    }
  };
  setTimeout(runIter, 1500 + Math.random() * 1000);
}

function renderEditorResults() {
  const container = document.getElementById('editor-results-content');
  const stepLogHtml = renderEditorStepLog();
  if (editorResults.length === 0) {
    const baseText = editorFiring
      ? 'Optimization in progress. Live status appears above.'
      : 'Run an optimization to see results';
    container.innerHTML = `${stepLogHtml}<div style="color:var(--t3)">${baseText}</div>`;
    return;
  }

  const q = QUERIES.find(q => q.id === editorQueryId);
  const baseMs = q ? q.runtime_ms : 0;

  const sorted = [...editorResults].sort((a, b) => b.speedup - a.speedup);
  let html = '';
  for (const r of sorted) {
    const cls = r.speedup >= 1.3 ? 'win' : r.speedup >= 1.05 ? 'improved' : r.speedup >= 0.95 ? 'neutral' : 'regression';
    html += `<div class="editor-result-card ${cls}" onclick="editorLoadPatch('${r.id}')">`;
    html += `<span>${statusBadge(r.status)}</span>`;
    html += `<span>${speedupHtml(r.speedup)}</span>`;
    html += `<div class="editor-result-info"><strong>W${r.worker_id}</strong> iter ${r.iteration}`;
    if (r.transform) html += ` &middot; <span style="color:var(--purple)">${esc(r.transform)}</span>`;
    html += `</div>`;
    if (baseMs > 0) {
      const estMs = baseMs / r.speedup;
      const savedMs = baseMs - estMs;
      const savedCls = savedMs >= 0 ? 'saved-pos' : 'saved-neg';
      const sign = savedMs >= 0 ? '-' : '+';
      html += `<div class="editor-result-timing">${fmtMs(baseMs)} &rarr; ${fmtMs(estMs)} <span class="${savedCls}">${sign}${fmtMs(Math.abs(savedMs))}</span></div>`;
    }
    html += `</div>`;
  }
  container.innerHTML = stepLogHtml + html;

  // Auto-switch to results subtab
  editorSubTab('results');
}

function editorLoadPatch(patchId) {
  const patch = editorResults.find(r => r.id === patchId);
  if (patch && patch.sql) {
    document.getElementById('editor-rewrite').value = patch.sql;
    updateEditorGutters();
    updateEditorHighlights();
  }
}

function openInEditor(qid) {
  switchTab('editor');
  editorSelectQuery(qid);
}

function editorCopyOriginal() {
  const text = document.getElementById('editor-original').value;
  navigator.clipboard.writeText(text).catch(() => {});
}

function editorResetRewrite() {
  const orig = document.getElementById('editor-original').value;
  document.getElementById('editor-rewrite').value = orig;
  updateEditorGutters();
  updateEditorHighlights();
}

// ── Init ────────────────────────────────────────────────────
setRunContext({
  benchmark_name: runConfig.benchmark_dir || activeRunContext.benchmark_name || 'benchmark',
  engine: runConfig.engine_profile || activeRunContext.engine || '',
  query_count: QUERIES.length,
  mode_summary: 'beam',
  fleet_concurrency: 4,
});
renderTriageTable();
updateTriageStats();
populateEditorDropdown();
initEditorDivider();
updateResultsView();
renderBackendConsole();
pushBackendLog(
  isLiveBackendMode()
    ? 'Dashboard boot complete. Waiting for backend websocket events.'
    : 'Dashboard boot complete in demo mode.',
  { level: 'system', lane: 'SYS', source: 'ui' }
);

// Wire editor textarea events
document.getElementById('editor-rewrite').addEventListener('input', function() {
  updateEditorGutters();
  updateEditorHighlights();
});
document.getElementById('editor-original').addEventListener('scroll', function() {
  syncGutterScroll(this, document.getElementById('editor-gutter-left'));
  syncHighlightScroll(this, document.getElementById('editor-highlight-left'));
});
document.getElementById('editor-rewrite').addEventListener('scroll', function() {
  syncGutterScroll(this, document.getElementById('editor-gutter-right'));
  syncHighlightScroll(this, document.getElementById('editor-highlight-right'));
});

// Tab key inserts spaces in rewrite textarea
document.getElementById('editor-rewrite').addEventListener('keydown', function(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = this.selectionStart;
    const end = this.selectionEnd;
    this.value = this.value.substring(0, start) + '  ' + this.value.substring(end);
    this.selectionStart = this.selectionEnd = start + 2;
    updateEditorGutters();
    updateEditorHighlights();
  }
});

document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeConfigModal();
});
</script>
</body>
</html>
