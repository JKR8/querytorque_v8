<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QueryTorque — Fleet Command Centre</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════
   QueryTorque / Dialect Labs Design System — Light Theme
   ═══════════════════════════════════════════════════════════ */
:root {
  --bg: #ffffff;
  --bg-elevated: #f8fafc;
  --bg-subtle: #f1f5f9;
  --border: #e2e8f0;
  --border-hover: #cbd5e1;
  --t1: #0f172a;
  --t2: #64748b;
  --t3: #94a3b8;
  --green: #059669;
  --green-dim: #065f46;
  --green-bg: #ecfdf5;
  --blue: #2563eb;
  --blue-dim: #1e40af;
  --blue-bg: #eff6ff;
  --amber: #f59e0b;
  --amber-bg: #fffbeb;
  --red: #ef4444;
  --red-bg: #fef2f2;
  --purple: #7c3aed;
  --purple-bg: #f5f3ff;
  --mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
  --sans: 'Inter', -apple-system, system-ui, sans-serif;
  --radius: 6px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--sans);
  background: var(--bg);
  color: var(--t1);
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

::selection { background: #c7d2fe; color: #0f172a; }
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: #f8fafc; }
::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

/* ── Header ──────────────────────────────────────────────── */
.header {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.92);
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 8px;
  text-decoration: none;
  color: var(--t1);
}

.logo-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  background: #2563eb;
  display: flex;
  align-items: center;
  justify-content: center;
}

.logo-icon svg { width: 16px; height: 16px; }

.logo-text {
  font-family: var(--mono);
  font-size: 15px;
  font-weight: 500;
}

.header-sep {
  width: 1px;
  height: 20px;
  background: var(--border);
}

.header-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--t2);
}

.header-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
}

.header-meta span { white-space: nowrap; }

.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 500;
  padding: 4px 12px;
  border-radius: 20px;
}

.status-indicator.triage {
  background: var(--blue-bg);
  color: var(--blue);
}

.status-indicator.running {
  background: var(--green-bg);
  color: var(--green);
}

.status-indicator.paused {
  background: var(--amber-bg);
  color: var(--amber);
}

.status-indicator.done {
  background: var(--green-bg);
  color: var(--green-dim);
}

/* Status dot with pulse */
.status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  position: relative;
  display: inline-block;
  flex-shrink: 0;
}

.status-dot.green { background: var(--green); }
.status-dot.blue { background: var(--blue); }
.status-dot.amber { background: var(--amber); }
.status-dot.gray { background: var(--t3); }

.status-dot.pulse::after {
  content: '';
  position: absolute;
  inset: -3px;
  border-radius: 50%;
  border: 1px solid currentColor;
  animation: pulse-ring 2s ease-out infinite;
}

.status-dot.green.pulse::after { border-color: var(--green); }
.status-dot.blue.pulse::after { border-color: var(--blue); }

@keyframes pulse-ring {
  0% { transform: scale(1); opacity: 0.4; }
  100% { transform: scale(2.5); opacity: 0; }
}

/* ── Main Container ──────────────────────────────────────── */
.main {
  max-width: 1280px;
  margin: 0 auto;
  padding: 24px 32px 48px;
}

/* ── Section Labels ──────────────────────────────────────── */
.section-label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 12px;
}

/* ── Stat Cards ──────────────────────────────────────────── */
.stat-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  min-width: 120px;
  flex: 1;
  position: relative;
  transition: border-color 0.2s;
}

.stat-card:hover { border-color: var(--border-hover); }

.stat-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  border-radius: 8px 8px 0 0;
}

.stat-card.accent-red::before { background: var(--red); }
.stat-card.accent-amber::before { background: var(--amber); }
.stat-card.accent-gray::before { background: var(--t3); }
.stat-card.accent-muted::before { background: var(--border); }
.stat-card.accent-green::before { background: var(--green); }
.stat-card.accent-blue::before { background: var(--blue); }

.stat-card .label {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.06em;
  text-transform: uppercase;
  display: block;
}

.stat-card .value {
  font-family: var(--mono);
  font-size: 26px;
  font-weight: 600;
  margin-top: 2px;
  display: block;
  font-variant-numeric: tabular-nums;
  color: var(--t1);
}

.stat-card .sub {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  margin-top: 2px;
}

.stat-card.green .value { color: var(--green); }
.stat-card.blue .value { color: var(--blue); }
.stat-card.red .value { color: var(--red); }
.stat-card.amber .value { color: var(--amber); }
.stat-card.muted .value { color: var(--t3); }

/* ── Buttons ─────────────────────────────────────────────── */
.btn-primary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 24px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: #ffffff;
  background: #0f172a;
  border: 1px solid #0f172a;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-primary:hover { background: #1e293b; border-color: #1e293b; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-secondary {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: var(--t2);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-secondary:hover {
  color: var(--t1);
  border-color: var(--border-hover);
  background: var(--bg-elevated);
}

.btn-text {
  font-size: 14px;
  color: var(--t3);
  background: none;
  border: none;
  cursor: pointer;
  font-family: var(--sans);
  padding: 10px 16px;
  transition: color 0.2s;
}

.btn-text:hover { color: var(--t1); }

.btn-danger {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  font-family: var(--sans);
  color: var(--red);
  background: transparent;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
}

.btn-danger:hover {
  background: var(--red-bg);
  border-color: #fecaca;
}

.actions {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-top: 24px;
}

/* ── Filters ─────────────────────────────────────────────── */
.filters {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
  margin-bottom: 12px;
}

.filter-input {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  outline: none;
  transition: border-color 0.15s;
  min-width: 180px;
}

.filter-input:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.filter-input::placeholder { color: var(--t3); }

.filter-select {
  font-family: var(--sans);
  font-size: 13px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 6px 12px;
  outline: none;
  cursor: pointer;
  transition: border-color 0.15s;
}

.filter-select:focus {
  border-color: #93c5fd;
  box-shadow: 0 0 0 3px rgba(147,197,253,0.15);
}

.filter-check {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--t3);
  cursor: pointer;
}

.filter-check input { cursor: pointer; accent-color: var(--t2); }

/* ── Tables ──────────────────────────────────────────────── */
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.data-table th {
  background: var(--bg-subtle);
  color: var(--t3);
  text-align: left;
  padding: 8px 12px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
  user-select: none;
}

.data-table th.sortable { cursor: pointer; }
.data-table th.sortable:hover { color: var(--t1); }

.sort-arrow {
  margin-left: 4px;
  font-size: 9px;
  opacity: 0.5;
}

.data-table td {
  padding: 8px 12px;
  border-bottom: 1px solid var(--border);
  vertical-align: middle;
}

.data-table tbody tr { transition: background 0.1s; }
.data-table tbody tr:hover { background: var(--bg-elevated); }

.data-table td.mono {
  font-family: var(--mono);
  font-variant-numeric: tabular-nums;
}

.data-table td.right { text-align: right; }

.data-table td.muted { color: var(--t3); }

/* Row exclude styling */
.data-table tbody tr.excluded {
  opacity: 0.4;
}

.data-table tbody tr.excluded td { text-decoration: line-through; }
.data-table tbody tr.excluded td:first-child { text-decoration: none; }

/* Running row pulse */
.data-table tbody tr.is-running {
  background: rgba(37, 99, 235, 0.03);
}

/* ── Badges ──────────────────────────────────────────────── */
.badge {
  padding: 2px 8px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  white-space: nowrap;
}

.badge.win { background: var(--green-bg); color: var(--green); }
.badge.improved { background: var(--blue-bg); color: var(--blue); }
.badge.neutral { background: var(--bg-subtle); color: var(--t3); }
.badge.regression { background: var(--red-bg); color: var(--red); }
.badge.error { background: var(--amber-bg); color: var(--amber); }
.badge.queued { background: var(--bg-subtle); color: var(--t3); }

.badge.running {
  background: var(--blue-bg);
  color: var(--blue);
  animation: badge-pulse 2s ease-in-out infinite;
}

@keyframes badge-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.badge.high { background: var(--red-bg); color: var(--red); }
.badge.medium { background: var(--amber-bg); color: var(--amber); }
.badge.low { background: var(--bg-subtle); color: var(--t3); }
.badge.skip { background: var(--bg-subtle); color: var(--t3); opacity: 0.6; }

/* Confidence indicators */
.confidence {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-family: var(--mono);
  font-size: 12px;
}

.conf-bar {
  display: inline-flex;
  gap: 2px;
}

.conf-seg {
  width: 14px;
  height: 5px;
  border-radius: 2px;
  background: var(--border);
}

.conf-seg.filled { background: var(--green); }
.conf-seg.filled.med { background: var(--amber); }
.conf-seg.filled.low { background: var(--t3); }

/* ── Speedup display ─────────────────────────────────────── */
.speedup {
  font-family: var(--mono);
  font-weight: 600;
  font-size: 13px;
  font-variant-numeric: tabular-nums;
}

.speedup.fast { color: var(--green); }
.speedup.slow { color: var(--red); }
.speedup.meh { color: var(--t3); }

/* ── Two-Column Layout ───────────────────────────────────── */
.split {
  display: grid;
  grid-template-columns: 1fr 340px;
  gap: 20px;
  margin-bottom: 20px;
}

@media (max-width: 900px) {
  .split { grid-template-columns: 1fr; }
}

/* ── Panel ────────────────────────────────────────────────── */
.panel {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
}

.panel-title {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 12px;
}

/* ── Worker Cards ─────────────────────────────────────────── */
.worker-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 14px;
  margin-bottom: 6px;
  border-left: 3px solid var(--border);
  transition: all 0.3s;
  display: flex;
  align-items: center;
  gap: 10px;
}

.worker-card.active {
  border-left-color: var(--green);
  background: var(--green-bg);
}

.worker-card.idle {
  border-left-color: var(--border);
}

.worker-id {
  font-family: var(--mono);
  font-size: 12px;
  font-weight: 600;
  color: var(--t2);
  min-width: 24px;
}

.worker-info {
  flex: 1;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
}

.worker-info .query-ref {
  color: var(--t1);
  font-weight: 500;
}

.worker-info .phase-ref {
  color: var(--t3);
}

.worker-time {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  font-variant-numeric: tabular-nums;
}

/* ── Queue List ───────────────────────────────────────────── */
.queue-list {
  list-style: none;
  padding: 0;
}

.queue-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t2);
  border-bottom: 1px solid var(--bg-subtle);
}

.queue-item:last-child { border-bottom: none; }

.queue-rank {
  color: var(--t3);
  min-width: 20px;
  text-align: right;
}

.queue-more {
  font-size: 12px;
  color: var(--t3);
  padding: 6px 0;
}

/* ── Event Log ────────────────────────────────────────────── */
.event-log {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  max-height: 180px;
  overflow-y: auto;
  font-family: var(--mono);
  font-size: 12px;
  padding: 4px 0;
}

.event-entry {
  display: flex;
  gap: 10px;
  padding: 4px 14px;
  line-height: 1.5;
  border-bottom: 1px solid transparent;
}

.event-entry:hover { background: var(--bg-subtle); }

.event-ts { color: var(--t3); min-width: 64px; font-variant-numeric: tabular-nums; }
.event-target { color: var(--t1); font-weight: 500; min-width: 40px; }
.event-msg { color: var(--t2); }
.event-entry.ev-win .event-msg { color: var(--green); }
.event-entry.ev-improved .event-msg { color: var(--blue); }
.event-entry.ev-regression .event-msg { color: var(--red); }
.event-entry.ev-assign .event-msg { color: var(--blue); }
.event-entry.ev-system .event-msg { color: var(--t3); }

/* ── Triage Iter Select ───────────────────────────────────── */
.iter-select {
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t1);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 2px 4px;
  cursor: pointer;
  width: 50px;
  text-align: center;
}

.iter-select:focus {
  border-color: #93c5fd;
  outline: none;
}

/* ── Exclude Checkbox ─────────────────────────────────────── */
.excl-check {
  accent-color: var(--t2);
  cursor: pointer;
  width: 14px;
  height: 14px;
}

/* ── View Transitions ─────────────────────────────────────── */
.view {
  display: none;
  opacity: 0;
  transition: opacity 0.4s ease;
}

.view.active {
  display: block;
  opacity: 1;
}

.view.fade-in {
  animation: fadeIn 0.5s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ── Done State ───────────────────────────────────────────── */
.done-hero {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 40px;
  text-align: center;
  margin-bottom: 24px;
  position: relative;
}

.done-hero::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--green);
  border-radius: 12px 12px 0 0;
}

.done-headline {
  font-family: var(--mono);
  font-size: 14px;
  color: var(--t3);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: 16px;
}

.done-savings {
  font-family: var(--mono);
  font-size: 48px;
  font-weight: 600;
  color: var(--green);
  margin-bottom: 8px;
  font-variant-numeric: tabular-nums;
}

.done-savings-label {
  font-size: 14px;
  color: var(--t2);
  margin-bottom: 24px;
}

.done-stats {
  display: flex;
  justify-content: center;
  gap: 32px;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.done-stats .ds-val {
  font-weight: 600;
  color: var(--t1);
}

.done-stats .ds-green { color: var(--green); }

/* ── Estimate Row ─────────────────────────────────────────── */
.estimate-row {
  display: flex;
  align-items: center;
  gap: 16px;
  flex-wrap: wrap;
  font-family: var(--mono);
  font-size: 12px;
  color: var(--t3);
  margin-bottom: 24px;
  padding: 10px 16px;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius);
}

.estimate-row span { white-space: nowrap; }

/* ── Status Strip (Execution) ─────────────────────────────── */
.status-strip {
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px 20px;
  margin-bottom: 20px;
}

.strip-top {
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 12px;
  margin-bottom: 12px;
}

.strip-progress {
  display: flex;
  align-items: center;
  gap: 16px;
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.strip-progress .sp-val {
  font-weight: 600;
  color: var(--t1);
}

.strip-progress .sp-green { color: var(--green); font-weight: 600; }

.strip-cards {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.strip-stat {
  text-align: center;
  min-width: 72px;
  padding: 6px 12px;
  border-radius: var(--radius);
  background: var(--bg);
  border: 1px solid var(--border);
}

.strip-stat .ss-label {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

.strip-stat .ss-val {
  font-family: var(--mono);
  font-size: 20px;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}

.strip-stat.ss-green .ss-val { color: var(--green); }
.strip-stat.ss-blue .ss-val { color: var(--blue); }
.strip-stat.ss-muted .ss-val { color: var(--t3); }
.strip-stat.ss-red .ss-val { color: var(--red); }
.strip-stat.ss-amber .ss-val { color: var(--amber); }

.strip-controls {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  padding-top: 12px;
  border-top: 1px solid var(--border);
}

.strip-controls-left {
  display: flex;
  gap: 8px;
}

.strip-savings {
  font-family: var(--mono);
  font-size: 13px;
  color: var(--t2);
}

.strip-savings .sv-amount {
  font-weight: 600;
  color: var(--green);
  font-size: 15px;
}

/* ── Active indicator ─────────────────────────────────────── */
.active-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  display: inline-block;
  animation: active-blink 1.5s ease-in-out infinite;
}

@keyframes active-blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

/* ── Table wrapper ────────────────────────────────────────── */
.table-wrap {
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

/* ── Progress bar (fleet) ─────────────────────────────────── */
.fleet-progress {
  height: 4px;
  background: var(--bg-subtle);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 20px;
}

.fleet-progress-fill {
  height: 100%;
  background: var(--green);
  border-radius: 2px;
  transition: width 0.5s ease;
}

/* ── Detail Panel (Per-Query Dropdown) ───────────────────── */
.detail-toggle {
  cursor: pointer;
  user-select: none;
  font-size: 11px;
  color: var(--t3);
  transition: transform 0.2s;
  display: inline-block;
  width: 18px;
  text-align: center;
}

.detail-toggle.open {
  transform: rotate(90deg);
  color: var(--t1);
}

.detail-panel {
  background: var(--bg-elevated);
  border-bottom: 1px solid var(--border);
  padding: 16px 20px 16px 48px;
  display: none;
  animation: detail-slide 0.2s ease;
}

.detail-panel.open { display: table-row; }

@keyframes detail-slide {
  from { opacity: 0; }
  to { opacity: 1; }
}

.detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px 24px;
}

@media (max-width: 700px) { .detail-grid { grid-template-columns: 1fr; } }

.detail-section {
  min-width: 0;
}

.detail-section-title {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-weight: 500;
  margin-bottom: 6px;
}

.detail-kv {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 0;
  font-size: 12px;
  border-bottom: 1px solid var(--bg-subtle);
}

.detail-kv:last-child { border-bottom: none; }

.detail-kv .dk-label {
  color: var(--t3);
  font-family: var(--mono);
  font-size: 11px;
}

.detail-kv .dk-value {
  font-family: var(--mono);
  font-weight: 500;
  font-size: 12px;
}

/* Flag tags */
.flag-tag {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 3px;
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 500;
  background: var(--bg-subtle);
  color: var(--t2);
  margin: 2px 3px 2px 0;
  letter-spacing: 0.02em;
}

/* Transform match rows */
.transform-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 4px 0;
  font-size: 12px;
  border-bottom: 1px solid var(--bg-subtle);
}

.transform-row:last-child { border-bottom: none; }

.transform-name {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--purple);
  font-weight: 500;
  min-width: 140px;
}

.overlap-bar-wrap {
  flex: 1;
  height: 6px;
  background: var(--bg-subtle);
  border-radius: 3px;
  overflow: hidden;
  max-width: 120px;
}

.overlap-bar {
  height: 100%;
  border-radius: 3px;
  background: var(--purple);
  transition: width 0.3s ease;
}

.overlap-pct {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  min-width: 36px;
  text-align: right;
}

.transform-gap {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--t3);
  letter-spacing: 0.02em;
}

.transform-family {
  font-family: var(--mono);
  font-size: 10px;
  font-weight: 600;
  color: var(--blue);
  background: var(--blue-bg);
  padding: 0 5px;
  border-radius: 3px;
}

/* Q-error badges */
.qerror-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 4px;
  font-family: var(--mono);
  font-size: 11px;
  font-weight: 600;
}

.qerror-badge.s1 { background: var(--red-bg); color: var(--red); }
.qerror-badge.s2 { background: #fff1f2; color: #e11d48; }
.qerror-badge.s3 { background: var(--amber-bg); color: var(--amber); }
.qerror-badge.s4 { background: var(--blue-bg); color: var(--blue); }
.qerror-badge.s5 { background: var(--green-bg); color: var(--green); }

/* EXPLAIN block */
.explain-pre {
  font-family: var(--mono);
  font-size: 11px;
  line-height: 1.5;
  color: var(--t2);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 10px 12px;
  max-height: 200px;
  overflow-y: auto;
  white-space: pre;
  margin-top: 6px;
}

.explain-toggle {
  font-family: var(--mono);
  font-size: 11px;
  color: var(--t3);
  cursor: pointer;
  padding: 4px 0;
  user-select: none;
}

.explain-toggle:hover { color: var(--t1); }
</style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════
     HEADER
     ═══════════════════════════════════════════════════════════ -->
<header class="header">
  <div class="header-left">
    <a class="logo" href="#">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/>
        </svg>
      </div>
      <span class="logo-text">QueryTorque</span>
    </a>
    <div class="header-sep"></div>
    <span class="header-title">Fleet Command Centre</span>
  </div>
  <div class="header-meta">
    <span>duckdb_tpcds</span>
    <span>·</span>
    <span>DuckDB</span>
    <span>·</span>
    <span>20 queries</span>
    <span>·</span>
    <span id="header-status-wrap">
      <span class="status-indicator triage" id="header-status">
        <span class="status-dot blue pulse"></span>
        TRIAGE REVIEW
      </span>
    </span>
  </div>
</header>

<div class="main">

<!-- ═══════════════════════════════════════════════════════════
     STATE 1: TRIAGE REVIEW
     ═══════════════════════════════════════════════════════════ -->
<div class="view active fade-in" id="view-triage">

  <div class="section-label">Workload Analysis</div>

  <!-- Stat Cards -->
  <div class="stat-row">
    <div class="stat-card accent-red">
      <span class="label">High Impact</span>
      <span class="value" id="triage-high">4</span>
      <span class="sub">5 rounds each</span>
    </div>
    <div class="stat-card accent-amber">
      <span class="label">Medium</span>
      <span class="value" id="triage-med">6</span>
      <span class="sub">3 rounds each</span>
    </div>
    <div class="stat-card accent-gray">
      <span class="label">Low</span>
      <span class="value" id="triage-low">6</span>
      <span class="sub">1 round each</span>
    </div>
    <div class="stat-card accent-muted muted">
      <span class="label">Skip</span>
      <span class="value" id="triage-skip">4</span>
      <span class="sub">&lt;100ms</span>
    </div>
    <div class="stat-card accent-green green">
      <span class="label">Est. Annual Savings</span>
      <span class="value" id="triage-savings">$148,800</span>
      <span class="sub">based on workload analysis</span>
    </div>
  </div>

  <!-- Estimates -->
  <div class="estimate-row">
    <span>Concurrency: <strong>4 workers</strong></span>
    <span>·</span>
    <span>Est. time: <strong>~18 min</strong></span>
    <span>·</span>
    <span>Est. API calls: <strong>~96</strong></span>
    <span>·</span>
    <span>Est. cost: <strong>$1.92</strong> (DeepSeek R1)</span>
  </div>

  <div class="section-label">Deployment Plan</div>

  <!-- Filters -->
  <div class="filters">
    <input type="text" class="filter-input" id="triage-search" placeholder="Search queries...">
    <select class="filter-select" id="triage-bucket-filter">
      <option value="">All buckets</option>
      <option value="HIGH">High Impact</option>
      <option value="MEDIUM">Medium</option>
      <option value="LOW">Low</option>
      <option value="SKIP">Skip</option>
    </select>
    <label class="filter-check">
      <input type="checkbox" id="triage-show-skip"> Show skipped queries
    </label>
  </div>

  <!-- Triage Table -->
  <div class="table-wrap">
    <table class="data-table" id="triage-table">
      <thead>
        <tr>
          <th style="width:36px"></th>
          <th class="sortable" data-sort="query_id">Query</th>
          <th class="sortable" data-sort="runtime_ms" style="text-align:right">Runtime</th>
          <th class="sortable" data-sort="est_annual" style="text-align:right">Est. Annual Cost</th>
          <th>Bucket</th>
          <th style="text-align:center">Rounds</th>
          <th>Top Transform</th>
          <th>Confidence</th>
        </tr>
      </thead>
      <tbody id="triage-tbody"></tbody>
    </table>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-primary" id="btn-approve" onclick="approveAndDeploy()">
      Approve &amp; Deploy
    </button>
    <button class="btn-secondary" onclick="exportPlan()">
      Export Plan
    </button>
    <button class="btn-text">Cancel</button>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     STATE 2: EXECUTION CONTROL
     ═══════════════════════════════════════════════════════════ -->
<div class="view" id="view-execution">

  <!-- Progress Bar -->
  <div class="fleet-progress">
    <div class="fleet-progress-fill" id="progress-fill" style="width:0%"></div>
  </div>

  <!-- Status Strip -->
  <div class="status-strip">
    <div class="strip-top">
      <div class="strip-progress">
        <span>Done <span class="sp-val" id="exec-done">0</span>/<span id="exec-total">16</span></span>
        <span>Active <span class="sp-val" id="exec-active">0</span></span>
        <span>Queued <span class="sp-val" id="exec-queued">16</span></span>
      </div>
      <div class="strip-cards">
        <div class="strip-stat ss-green"><div class="ss-label">Wins</div><div class="ss-val" id="exec-wins">0</div></div>
        <div class="strip-stat ss-blue"><div class="ss-label">Improved</div><div class="ss-val" id="exec-improved">0</div></div>
        <div class="strip-stat ss-muted"><div class="ss-label">Neutral</div><div class="ss-val" id="exec-neutral">0</div></div>
        <div class="strip-stat ss-red"><div class="ss-label">Regress</div><div class="ss-val" id="exec-regress">0</div></div>
        <div class="strip-stat ss-amber"><div class="ss-label">Error</div><div class="ss-val" id="exec-errors">0</div></div>
        <div class="strip-stat"><div class="ss-label">Clock</div><div class="ss-val" id="exec-clock">0:00</div></div>
      </div>
    </div>
    <div class="strip-controls">
      <div class="strip-controls-left">
        <button class="btn-secondary" id="btn-pause" onclick="togglePause()">Pause All</button>
      </div>
      <div class="strip-savings">
        Annualised Savings: <span class="sv-amount" id="exec-savings">$0</span>
        <span style="margin-left:8px;color:var(--t3)">API calls: <span id="exec-api">0</span></span>
      </div>
    </div>
  </div>

  <!-- Split: Query Table + Resources -->
  <div class="split">
    <!-- Left: Query Table -->
    <div>
      <div class="section-label">Queries</div>
      <div class="filters">
        <input type="text" class="filter-input" id="exec-search" placeholder="Search queries..." oninput="renderExecTable()">
        <select class="filter-select" id="exec-status-filter" onchange="renderExecTable()">
          <option value="">All statuses</option>
          <option value="WIN">Win</option>
          <option value="IMPROVED">Improved</option>
          <option value="NEUTRAL">Neutral</option>
          <option value="REGRESSION">Regression</option>
          <option value="RUNNING">Running</option>
          <option value="QUEUED">Queued</option>
        </select>
        <select class="filter-select" id="exec-bucket-filter" onchange="renderExecTable()">
          <option value="">All buckets</option>
          <option value="HIGH">High</option>
          <option value="MEDIUM">Medium</option>
          <option value="LOW">Low</option>
        </select>
      </div>
      <div class="table-wrap">
        <table class="data-table" id="exec-table">
          <thead>
            <tr>
              <th class="sortable" data-esort="query_id">Query</th>
              <th>Status</th>
              <th class="sortable" data-esort="speedup" style="text-align:right">Speedup</th>
              <th>Bucket</th>
              <th>Phase</th>
              <th style="text-align:right">Elapsed</th>
              <th style="text-align:center;width:36px"></th>
            </tr>
          </thead>
          <tbody id="exec-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Right: Resources -->
    <div>
      <div class="section-label">Worker Pool</div>
      <div id="worker-pool">
        <div class="worker-card idle" id="wc-1">
          <span class="status-dot gray"></span>
          <span class="worker-id">W1</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-2">
          <span class="status-dot gray"></span>
          <span class="worker-id">W2</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-3">
          <span class="status-dot gray"></span>
          <span class="worker-id">W3</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
        <div class="worker-card idle" id="wc-4">
          <span class="status-dot gray"></span>
          <span class="worker-id">W4</span>
          <span class="worker-info">Standby</span>
          <span class="worker-time"></span>
        </div>
      </div>

      <div class="section-label" style="margin-top:20px">Queue <span id="queue-count" style="color:var(--t3)"></span></div>
      <div class="panel" id="queue-panel" style="padding:8px 14px">
        <ul class="queue-list" id="queue-list"></ul>
      </div>
    </div>
  </div>

  <!-- Event Log -->
  <div class="section-label">Event Log</div>
  <div class="event-log" id="event-log"></div>
</div>

<!-- ═══════════════════════════════════════════════════════════
     STATE 3: DONE
     ═══════════════════════════════════════════════════════════ -->
<div class="view" id="view-done">
  <div class="done-hero">
    <div class="done-headline">Fleet Complete</div>
    <div class="done-savings" id="done-savings">$0</div>
    <div class="done-savings-label">estimated annualised savings</div>
    <div class="done-stats">
      <span><span class="ds-val" id="done-total">0</span> queries analysed</span>
      <span><span class="ds-val ds-green" id="done-optimized">0</span> optimized</span>
      <span><span class="ds-val" id="done-regressions">0</span> regressions</span>
      <span>in <span class="ds-val" id="done-time">0:00</span></span>
    </div>
  </div>

  <!-- Final results table -->
  <div class="section-label">Results</div>
  <div class="table-wrap">
    <table class="data-table" id="done-table">
      <thead>
        <tr>
          <th>Query</th>
          <th>Status</th>
          <th style="text-align:right">Speedup</th>
          <th>Bucket</th>
          <th>Transform</th>
          <th style="text-align:right">Annual Savings</th>
        </tr>
      </thead>
      <tbody id="done-tbody"></tbody>
    </table>
  </div>

  <div class="actions">
    <button class="btn-primary" onclick="exportResults()">Download Report</button>
    <button class="btn-secondary" onclick="location.reload()">New Fleet Run</button>
  </div>
</div>

</div><!-- /main -->

<!-- ═══════════════════════════════════════════════════════════
     JAVASCRIPT
     ═══════════════════════════════════════════════════════════ -->
<script>
// ── Mock Data ───────────────────────────────────────────────
const QUERIES = [
  { id:'q88',  runtime_ms:45200, bucket:'HIGH',   iters:5, transform:'or_to_union',       overlap:0.92, est_annual:54240, outcome:'WIN',        speedup:6.28, out_transform:'or_to_union',
    detail:{ cost_rank:1, pct_of_total:0.438, cumulative_pct:0.438, structural_flags:['OR_PREDICATE','MULTI_TABLE_SCAN','CORRELATED_SUBQUERY'], transforms:[{id:'or_to_union',overlap:0.92,gap:'CROSS_COLUMN_OR_DECOMPOSITION',family:'D'},{id:'scan_reduce',overlap:0.61,gap:'REDUNDANT_SCAN_ELIMINATION',family:'E'}], qerror:{severity:'S1',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:847.2}, explain:'-> Hash Join  (time=45102.3ms, rows=12847 (est 15))\n  -> Seq Scan on store_sales  (time=31200.1ms, rows=2880404 (est 2880000))\n    filter: (ss_sold_date_sk IS NOT NULL)\n  -> Hash  (time=8901.2ms)\n    -> Bitmap Heap Scan on item  (time=8400.0ms, rows=28847)\n      filter: i_category IN (\'Books\',\'Sports\',\'Music\')'} },
  { id:'q40',  runtime_ms:9800,  bucket:'HIGH',   iters:5, transform:'multi_cte_chain',   overlap:0.81, est_annual:11760, outcome:'WIN',        speedup:3.35, out_transform:'multi_cte_chain',
    detail:{ cost_rank:3, pct_of_total:0.095, cumulative_pct:0.632, structural_flags:['CTE_CHAIN','DATE_FILTER'], transforms:[{id:'multi_cte_chain',overlap:0.81,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'E'},{id:'date_cte_isolate',overlap:0.65,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'A'}], qerror:{severity:'S2',direction:'OVER_EST',worst_node:'Nested Loop',max_q_error:124.5}, explain:'-> Nested Loop  (time=9780.1ms, rows=4521 (est 562000))\n  -> CTE Scan on cte1  (time=4200.0ms, rows=4521)\n  -> Index Scan on date_dim  (time=0.01ms, rows=1 (est 1))'} },
  { id:'q50',  runtime_ms:12300, bucket:'HIGH',   iters:5, transform:'date_cte_isolate',  overlap:0.87, est_annual:14760, outcome:'WIN',        speedup:2.80, out_transform:'date_cte_isolate',
    detail:{ cost_rank:2, pct_of_total:0.119, cumulative_pct:0.557, structural_flags:['DATE_FILTER','MULTI_TABLE_SCAN'], transforms:[{id:'date_cte_isolate',overlap:0.87,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'A'},{id:'pushdown',overlap:0.52,gap:'',family:'A'}], qerror:{severity:'S2',direction:'UNDER_EST',worst_node:'Seq Scan',max_q_error:89.1}, explain:'-> Seq Scan on store_sales  (time=11800.0ms, rows=2880404 (est 28800))\n  filter: ss_sold_date_sk BETWEEN 2451911 AND 2451941'} },
  { id:'q46',  runtime_ms:8100,  bucket:'HIGH',   iters:5, transform:'dim_isolate',       overlap:0.74, est_annual:9720,  outcome:'IMPROVED',   speedup:1.49, out_transform:'dim_isolate',
    detail:{ cost_rank:4, pct_of_total:0.079, cumulative_pct:0.711, structural_flags:['MULTI_JOIN','DIM_LOOKUP'], transforms:[{id:'dim_isolate',overlap:0.74,gap:'',family:'A'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:12.3}, explain:'-> Hash Join  (time=8050.0ms, rows=8421 (est 684))\n  -> Seq Scan on store_sales  (time=5100.0ms, rows=2880404)\n  -> Hash\n    -> Seq Scan on customer_address  (time=120.0ms, rows=50000)'} },
  { id:'q1',   runtime_ms:5700,  bucket:'MEDIUM', iters:3, transform:'decorrelate',       overlap:0.71, est_annual:6840,  outcome:'NEUTRAL',    speedup:1.01, out_transform:'decorrelate',
    detail:{ cost_rank:5, pct_of_total:0.055, cumulative_pct:0.766, structural_flags:['CORRELATED_SUBQUERY'], transforms:[{id:'decorrelate',overlap:0.71,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S4',direction:'OVER_EST',worst_node:'SubPlan',max_q_error:3.2}, explain:'-> Seq Scan on store_returns  (time=5600.0ms, rows=287514)\n  filter: sr_customer_sk IS NOT NULL\n  SubPlan 1\n    -> Aggregate  (time=0.02ms, rows=1 (est 1))'} },
  { id:'q65',  runtime_ms:4200,  bucket:'MEDIUM', iters:3, transform:'pushdown',          overlap:0.68, est_annual:5040,  outcome:'IMPROVED',   speedup:1.49, out_transform:'pushdown',
    detail:{ cost_rank:6, pct_of_total:0.041, cumulative_pct:0.807, structural_flags:['LATE_FILTER'], transforms:[{id:'pushdown',overlap:0.68,gap:'',family:'A'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Seq Scan',max_q_error:18.7}, explain:'-> Seq Scan on store  (time=4100.0ms, rows=120 (est 12))\n  filter: s_state = \'TN\''} },
  { id:'q35',  runtime_ms:3800,  bucket:'MEDIUM', iters:3, transform:'early_filter',      overlap:0.65, est_annual:4560,  outcome:'WIN',        speedup:1.78, out_transform:'early_filter',
    detail:{ cost_rank:7, pct_of_total:0.037, cumulative_pct:0.844, structural_flags:['LATE_FILTER','DATE_FILTER'], transforms:[{id:'early_filter',overlap:0.65,gap:'',family:'A'},{id:'decorrelate',overlap:0.42,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:15.4}, explain:'-> Hash Join  (time=3700.0ms, rows=2841)\n  -> Seq Scan on customer  (time=200.0ms, rows=100000)\n  -> Hash\n    -> Seq Scan on store_sales  (time=3100.0ms, rows=2880404)'} },
  { id:'q80',  runtime_ms:3100,  bucket:'MEDIUM', iters:3, transform:'cte_split',         overlap:0.62, est_annual:3720,  outcome:'NEUTRAL',    speedup:1.02, out_transform:'cte_split',
    detail:{ cost_rank:8, pct_of_total:0.030, cumulative_pct:0.874, structural_flags:['CTE_CHAIN'], transforms:[{id:'cte_split',overlap:0.62,gap:'CROSS_CTE_PREDICATE_BLINDNESS',family:'E'}], qerror:{severity:'S4',direction:'OVER_EST',worst_node:'CTE Scan',max_q_error:2.8}, explain:'-> CTE Scan on cte1  (time=3000.0ms, rows=24521)\n  -> CTE Scan on cte2  (time=50.0ms, rows=128)'} },
  { id:'q22',  runtime_ms:2900,  bucket:'MEDIUM', iters:3, transform:'',                  overlap:0,    est_annual:3480,  outcome:'WIN',        speedup:2.10, out_transform:'scan_reduce',
    detail:{ cost_rank:9, pct_of_total:0.028, cumulative_pct:0.902, structural_flags:['MULTI_TABLE_SCAN'], transforms:[], qerror:null, explain:'-> Seq Scan on inventory  (time=2800.0ms, rows=11745000)\n  filter: inv_quantity_on_hand BETWEEN 100 AND 500'} },
  { id:'q75',  runtime_ms:2400,  bucket:'MEDIUM', iters:3, transform:'scan_reduce',       overlap:0.55, est_annual:2880,  outcome:'REGRESSION', speedup:0.85, out_transform:'scan_reduce',
    detail:{ cost_rank:10, pct_of_total:0.023, cumulative_pct:0.925, structural_flags:['MULTI_TABLE_SCAN','UNION_BRANCH'], transforms:[{id:'scan_reduce',overlap:0.55,gap:'REDUNDANT_SCAN_ELIMINATION',family:'E'}], qerror:{severity:'S3',direction:'UNDER_EST',worst_node:'Append',max_q_error:14.1}, explain:'-> Append  (time=2300.0ms, rows=48291)\n  -> Seq Scan on catalog_sales  (time=1200.0ms, rows=1441548)\n  -> Seq Scan on web_sales  (time=1100.0ms, rows=719384)'} },
  { id:'q42',  runtime_ms:1800,  bucket:'LOW',    iters:1, transform:'dim_isolate',       overlap:0.52, est_annual:2160,  outcome:'WIN',        speedup:2.80, out_transform:'dim_isolate',
    detail:{ cost_rank:11, pct_of_total:0.017, cumulative_pct:0.942, structural_flags:['DIM_LOOKUP'], transforms:[{id:'dim_isolate',overlap:0.52,gap:'',family:'A'}], qerror:{severity:'S4',direction:'UNDER_EST',worst_node:'Hash Join',max_q_error:4.1}, explain:'-> Hash Join  (time=1750.0ms, rows=1521)\n  -> Seq Scan on item  (time=50.0ms, rows=18000)\n  -> Hash\n    -> Seq Scan on store_sales  (time=1600.0ms, rows=2880404)'} },
  { id:'q12',  runtime_ms:1200,  bucket:'LOW',    iters:1, transform:'pushdown',          overlap:0.48, est_annual:1440,  outcome:'NEUTRAL',    speedup:1.03, out_transform:'pushdown',
    detail:{ cost_rank:12, pct_of_total:0.012, cumulative_pct:0.954, structural_flags:['LATE_FILTER'], transforms:[{id:'pushdown',overlap:0.48,gap:'',family:'A'}], qerror:{severity:'S5',direction:'OVER_EST',worst_node:'Seq Scan',max_q_error:1.2}, explain:'-> Seq Scan on web_sales  (time=1100.0ms, rows=719384)\n  filter: ws_sold_date_sk IS NOT NULL'} },
  { id:'q31',  runtime_ms:900,   bucket:'LOW',    iters:1, transform:'',                  overlap:0,    est_annual:1080,  outcome:'IMPROVED',   speedup:1.12, out_transform:'early_filter',
    detail:{ cost_rank:13, pct_of_total:0.009, cumulative_pct:0.963, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q55',  runtime_ms:700,   bucket:'LOW',    iters:1, transform:'decorrelate',       overlap:0.44, est_annual:840,   outcome:'NEUTRAL',    speedup:0.99, out_transform:'decorrelate',
    detail:{ cost_rank:14, pct_of_total:0.007, cumulative_pct:0.970, structural_flags:['CORRELATED_SUBQUERY'], transforms:[{id:'decorrelate',overlap:0.44,gap:'CORRELATED_SUBQUERY_PARALYSIS',family:'B'}], qerror:{severity:'S4',direction:'UNDER_EST',worst_node:'SubPlan',max_q_error:2.9}, explain:'-> SubPlan 1\n  -> Aggregate  (time=680.0ms, rows=1 (est 1))'} },
  { id:'q19',  runtime_ms:500,   bucket:'LOW',    iters:1, transform:'',                  overlap:0,    est_annual:600,   outcome:'WIN',        speedup:1.65, out_transform:'pushdown',
    detail:{ cost_rank:15, pct_of_total:0.005, cumulative_pct:0.975, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q67',  runtime_ms:400,   bucket:'LOW',    iters:1, transform:'early_filter',      overlap:0.40, est_annual:480,   outcome:'NEUTRAL',    speedup:1.00, out_transform:'early_filter',
    detail:{ cost_rank:16, pct_of_total:0.004, cumulative_pct:0.979, structural_flags:['LATE_FILTER'], transforms:[{id:'early_filter',overlap:0.40,gap:'',family:'A'}], qerror:{severity:'S5',direction:'OVER_EST',worst_node:'Seq Scan',max_q_error:1.1}, explain:''} },
  { id:'q2',   runtime_ms:80,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:96,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:17, pct_of_total:0.001, cumulative_pct:0.980, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q15',  runtime_ms:60,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:72,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:18, pct_of_total:0.001, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q33',  runtime_ms:40,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:48,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:19, pct_of_total:0.000, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
  { id:'q91',  runtime_ms:20,    bucket:'SKIP',   iters:0, transform:'',                  overlap:0,    est_annual:24,    outcome:null,         speedup:null, out_transform:'',
    detail:{ cost_rank:20, pct_of_total:0.000, cumulative_pct:0.981, structural_flags:[], transforms:[], qerror:null, explain:''} },
];

// ── State ───────────────────────────────────────────────────
let state = 'triage'; // triage | running | paused | done
let excludedIds = new Set();
let triageSortCol = 'runtime_ms';
let triageSortDir = -1;
let execSortCol = 'query_id';
let execSortDir = 1;

// Execution state
let execQueries = [];    // queries being executed (non-SKIP, non-excluded)
let completedSet = {};   // id → {status, speedup, transform, elapsed_s}
let workerState = [null, null, null, null]; // 4 workers, null = idle
let workerTimers = [0, 0, 0, 0];
let queueOrder = [];     // ids waiting
let clockSeconds = 0;
let clockInterval = null;
let simInterval = null;
let apiCalls = 0;
let isPaused = false;
let eventEntries = [];
let phases = ['Analyzing', 'Optimizing', 'Validating', 'Refining'];
let openDetails = new Set();
let openExplains = new Set();

// ── Helpers ─────────────────────────────────────────────────
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function fmtMs(ms) {
  if (ms < 0) return '--';
  if (ms < 1000) return ms.toFixed(0) + 'ms';
  return (ms / 1000).toFixed(1) + 's';
}

function fmtMoney(n) {
  return '$' + Math.round(n).toLocaleString();
}

function fmtTime(s) {
  const m = Math.floor(s / 60);
  const sec = s % 60;
  return m + ':' + String(sec).padStart(2, '0');
}

function confLevel(overlap) {
  if (overlap >= 0.7) return 'high';
  if (overlap >= 0.45) return 'med';
  if (overlap > 0) return 'low';
  return 'none';
}

function confHtml(overlap) {
  const lvl = confLevel(overlap);
  if (lvl === 'none') return '<span style="color:var(--t3)">--</span>';
  const n = lvl === 'high' ? 3 : lvl === 'med' ? 2 : 1;
  const cls = lvl === 'high' ? 'filled' : lvl === 'med' ? 'filled med' : 'filled low';
  let dots = '';
  for (let i = 0; i < 3; i++) {
    dots += `<span class="conf-seg ${i < n ? cls : ''}"></span>`;
  }
  const label = lvl === 'high' ? 'High' : lvl === 'med' ? 'Med' : 'Low';
  return `<span class="confidence"><span class="conf-bar">${dots}</span>${label}</span>`;
}

function toggleDetail(qid) {
  if (openDetails.has(qid)) openDetails.delete(qid);
  else openDetails.add(qid);
  // Re-render whichever table is active
  if (state === 'triage') renderTriageTable();
  else renderExecTable();
}

function toggleExplain(qid) {
  if (openExplains.has(qid)) openExplains.delete(qid);
  else openExplains.add(qid);
  const el = document.getElementById('explain-' + qid);
  if (el) el.style.display = openExplains.has(qid) ? 'block' : 'none';
  const tog = document.getElementById('explain-tog-' + qid);
  if (tog) tog.textContent = openExplains.has(qid) ? '\u25BC Hide EXPLAIN' : '\u25B6 Show EXPLAIN';
}

function renderDetailPanel(q) {
  const d = q.detail;
  if (!d) return '<tr><td colspan="8" class="detail-panel open" style="color:var(--t3);font-size:12px;padding-left:48px">No detail data available</td></tr>';

  let html = '<tr><td colspan="8" class="detail-panel open"><div class="detail-grid">';

  // ── Left column: Cost Context + Structural Flags ──
  html += '<div class="detail-section">';
  html += '<div class="detail-section-title">Cost Context</div>';
  html += `<div class="detail-kv"><span class="dk-label">Rank</span><span class="dk-value">#${d.cost_rank} of ${QUERIES.length}</span></div>`;
  html += `<div class="detail-kv"><span class="dk-label">% of total</span><span class="dk-value">${(d.pct_of_total * 100).toFixed(1)}%</span></div>`;
  html += `<div class="detail-kv"><span class="dk-label">Cumulative</span><span class="dk-value">${(d.cumulative_pct * 100).toFixed(1)}%</span></div>`;

  if (d.structural_flags && d.structural_flags.length > 0) {
    html += '<div class="detail-section-title" style="margin-top:12px">Structural Flags</div>';
    html += '<div>';
    for (const f of d.structural_flags) {
      html += `<span class="flag-tag">${esc(f)}</span>`;
    }
    html += '</div>';
  }

  // Q-Error section
  if (d.qerror) {
    const qe = d.qerror;
    const sevCls = qe.severity.toLowerCase();
    html += '<div class="detail-section-title" style="margin-top:12px">Q-Error Analysis</div>';
    html += `<div class="detail-kv"><span class="dk-label">Severity</span><span class="qerror-badge ${sevCls}">${esc(qe.severity)}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Direction</span><span class="dk-value">${esc(qe.direction.replace('_',' '))}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Worst node</span><span class="dk-value">${esc(qe.worst_node)}</span></div>`;
    html += `<div class="detail-kv"><span class="dk-label">Max q-error</span><span class="dk-value" style="color:${qe.max_q_error > 10 ? 'var(--red)' : 'var(--t1)'}">${qe.max_q_error.toFixed(1)}x</span></div>`;
  }

  html += '</div>';

  // ── Right column: Transform Matches + EXPLAIN ──
  html += '<div class="detail-section">';
  if (d.transforms && d.transforms.length > 0) {
    html += '<div class="detail-section-title">Transform Matches</div>';
    for (const t of d.transforms) {
      html += '<div class="transform-row">';
      html += `<span class="transform-name">${esc(t.id)}</span>`;
      html += `<span class="transform-family">${esc(t.family)}</span>`;
      html += `<div class="overlap-bar-wrap"><div class="overlap-bar" style="width:${Math.round(t.overlap * 100)}%"></div></div>`;
      html += `<span class="overlap-pct">${Math.round(t.overlap * 100)}%</span>`;
      if (t.gap) html += `<span class="transform-gap">${esc(t.gap)}</span>`;
      html += '</div>';
    }
  } else {
    html += '<div class="detail-section-title">Transform Matches</div>';
    html += '<div style="font-size:12px;color:var(--t3)">No structural matches (discovery mode)</div>';
  }

  // EXPLAIN
  if (d.explain) {
    const isOpen = openExplains.has(q.id);
    html += `<div class="explain-toggle" id="explain-tog-${q.id}" onclick="toggleExplain('${q.id}')">${isOpen ? '\u25BC Hide EXPLAIN' : '\u25B6 Show EXPLAIN'}</div>`;
    html += `<pre class="explain-pre" id="explain-${q.id}" style="display:${isOpen ? 'block' : 'none'}">${esc(d.explain)}</pre>`;
  }

  html += '</div></div></td></tr>';
  return html;
}

function bucketBadge(bucket) {
  const labels = { HIGH: 'High', MEDIUM: 'Medium', LOW: 'Low', SKIP: 'Skip' };
  return `<span class="badge ${bucket.toLowerCase()}">${labels[bucket] || bucket}</span>`;
}

function statusBadge(status) {
  if (!status) return '';
  const lower = status.toLowerCase();
  let inner = esc(status);
  if (lower === 'running') {
    inner = `<span class="status-dot blue pulse"></span>${inner}`;
  }
  return `<span class="badge ${lower}">${inner}</span>`;
}

function speedupHtml(sp) {
  if (sp == null) return '<span class="speedup meh">--</span>';
  const cls = sp >= 1.1 ? 'fast' : sp < 0.95 ? 'slow' : 'meh';
  return `<span class="speedup ${cls}">${sp.toFixed(2)}x</span>`;
}

function calcSavings(queries) {
  let total = 0;
  for (const q of queries) {
    const r = completedSet[q.id];
    if (r && r.speedup > 1.0) {
      const fraction = 1 - (1 / r.speedup);
      total += q.est_annual * fraction;
    }
  }
  return total;
}

// ── Triage Rendering ────────────────────────────────────────
function renderTriageTable() {
  const search = document.getElementById('triage-search').value.toLowerCase();
  const bucketF = document.getElementById('triage-bucket-filter').value;
  const showSkip = document.getElementById('triage-show-skip').checked;

  let rows = QUERIES.filter(q => {
    if (!showSkip && q.bucket === 'SKIP') return false;
    if (bucketF && q.bucket !== bucketF) return false;
    if (search && !q.id.includes(search)) return false;
    return true;
  });

  rows.sort((a, b) => {
    let av = a[triageSortCol], bv = b[triageSortCol];
    if (triageSortCol === 'query_id') { av = a.id; bv = b.id; }
    if (typeof av === 'string') return triageSortDir * av.localeCompare(bv);
    return triageSortDir * ((av || 0) - (bv || 0));
  });

  const tbody = document.getElementById('triage-tbody');
  tbody.innerHTML = '';

  for (const q of rows) {
    const excluded = excludedIds.has(q.id);
    const isOpen = openDetails.has(q.id);
    const tr = document.createElement('tr');
    if (excluded) tr.className = 'excluded';

    const iterOptions = q.bucket === 'SKIP' ? '--' :
      [1,2,3,5].map(n =>
        `<option value="${n}" ${n === q.iters ? 'selected' : ''}>${n}</option>`
      ).join('');

    tr.innerHTML = `
      <td><input type="checkbox" class="excl-check" ${excluded ? 'checked' : ''} data-qid="${q.id}" onchange="toggleExclude(this)"></td>
      <td class="mono" style="font-weight:500;cursor:pointer" onclick="toggleDetail('${q.id}')"><span class="detail-toggle ${isOpen ? 'open' : ''}">\u25B6</span> ${esc(q.id)}</td>
      <td class="mono right">${fmtMs(q.runtime_ms)}</td>
      <td class="mono right">${fmtMoney(q.est_annual)}</td>
      <td>${bucketBadge(q.bucket)}</td>
      <td style="text-align:center">${q.bucket === 'SKIP' ? '<span style="color:var(--t3)">--</span>' : `<select class="iter-select" data-qid="${q.id}" onchange="changeIters(this)">${iterOptions}</select>`}</td>
      <td>${q.transform ? `<span style="font-family:var(--mono);font-size:12px;color:var(--purple)">${esc(q.transform)}</span>` : '<span style="color:var(--t3)">--</span>'}</td>
      <td>${confHtml(q.overlap)}</td>
    `;
    tbody.appendChild(tr);

    // Detail panel row
    if (isOpen) {
      const detailHtml = renderDetailPanel(q);
      const detailContainer = document.createElement('tr');
      detailContainer.innerHTML = `<td colspan="8" class="detail-panel open" style="display:table-cell">${detailHtml.replace(/<tr><td colspan="8" class="detail-panel open">/, '').replace(/<\/td><\/tr>$/, '')}</td>`;
      tbody.appendChild(detailContainer);
    }
  }

  // Update sort arrows
  document.querySelectorAll('#triage-table th.sortable').forEach(th => {
    const col = th.dataset.sort;
    const existing = th.querySelector('.sort-arrow');
    if (existing) existing.remove();
    if (col === triageSortCol) {
      const arrow = document.createElement('span');
      arrow.className = 'sort-arrow';
      arrow.textContent = triageSortDir === 1 ? '\u25B2' : '\u25BC';
      th.appendChild(arrow);
    }
  });
}

function toggleExclude(el) {
  const qid = el.dataset.qid;
  if (el.checked) excludedIds.add(qid);
  else excludedIds.delete(qid);
  renderTriageTable();
  updateTriageStats();
}

function changeIters(el) {
  const qid = el.dataset.qid;
  const val = parseInt(el.value);
  const q = QUERIES.find(q => q.id === qid);
  if (q) q.iters = val;
  updateTriageStats();
}

function updateTriageStats() {
  const active = QUERIES.filter(q => !excludedIds.has(q.id));
  const high = active.filter(q => q.bucket === 'HIGH').length;
  const med = active.filter(q => q.bucket === 'MEDIUM').length;
  const low = active.filter(q => q.bucket === 'LOW').length;
  const skip = active.filter(q => q.bucket === 'SKIP').length;
  document.getElementById('triage-high').textContent = high;
  document.getElementById('triage-med').textContent = med;
  document.getElementById('triage-low').textContent = low;
  document.getElementById('triage-skip').textContent = skip;

  const totalCalls = active.reduce((s, q) => s + q.iters * (q.bucket !== 'SKIP' ? 4 : 0), 0);
  const totalSavings = active.filter(q => q.bucket !== 'SKIP').reduce((s, q) => s + q.est_annual * 0.3, 0);
  document.getElementById('triage-savings').textContent = fmtMoney(totalSavings);
}

// Wire triage sort headers
document.querySelectorAll('#triage-table th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.sort;
    if (triageSortCol === col) triageSortDir *= -1;
    else { triageSortCol = col; triageSortDir = col === 'query_id' ? 1 : -1; }
    renderTriageTable();
  });
});

// Wire triage filters
document.getElementById('triage-search').addEventListener('input', renderTriageTable);
document.getElementById('triage-bucket-filter').addEventListener('change', renderTriageTable);
document.getElementById('triage-show-skip').addEventListener('change', renderTriageTable);

// ── Execution Rendering ─────────────────────────────────────
function renderExecTable() {
  const search = document.getElementById('exec-search').value.toLowerCase();
  const statusF = document.getElementById('exec-status-filter').value;
  const bucketF = document.getElementById('exec-bucket-filter').value;

  let rows = execQueries.map(q => {
    const r = completedSet[q.id];
    const wIdx = workerState.indexOf(q.id);
    return {
      ...q,
      exec_status: r ? r.status : (wIdx >= 0 ? 'RUNNING' : 'QUEUED'),
      exec_speedup: r ? r.speedup : null,
      exec_phase: r ? 'Done' : (wIdx >= 0 ? phases[Math.floor(Math.random() * 4)] : '--'),
      exec_elapsed: r ? r.elapsed_s : (wIdx >= 0 ? workerTimers[wIdx] : null),
      worker_id: wIdx >= 0 ? wIdx + 1 : null,
    };
  });

  // Stable phase assignment
  rows.forEach(r => {
    if (r.exec_status === 'RUNNING') {
      if (!r._phase) r._phase = phases[Math.min(Math.floor((r.exec_elapsed || 0) / 8), 3)];
      r.exec_phase = r._phase;
    }
  });

  if (statusF) rows = rows.filter(r => r.exec_status === statusF);
  if (bucketF) rows = rows.filter(r => r.bucket === bucketF);
  if (search) rows = rows.filter(r => r.id.includes(search));

  const tbody = document.getElementById('exec-tbody');
  tbody.innerHTML = '';

  for (const r of rows) {
    const tr = document.createElement('tr');
    if (r.exec_status === 'RUNNING') tr.className = 'is-running';
    const isOpen = openDetails.has(r.id);

    const phaseText = r.exec_status === 'RUNNING'
      ? phases[Math.min(Math.floor((r.exec_elapsed || 0) / 8), 3)]
      : (r.exec_status === 'QUEUED' ? '--' : 'Done');

    tr.innerHTML = `
      <td class="mono" style="font-weight:500;cursor:pointer" onclick="toggleDetail('${r.id}')"><span class="detail-toggle ${isOpen ? 'open' : ''}">\u25B6</span> ${esc(r.id)}</td>
      <td>${statusBadge(r.exec_status)}</td>
      <td class="right">${speedupHtml(r.exec_speedup)}</td>
      <td>${bucketBadge(r.bucket)}</td>
      <td class="mono" style="color:var(--t2);font-size:12px">${phaseText}</td>
      <td class="mono right" style="color:var(--t3)">${r.exec_elapsed != null ? fmtTime(r.exec_elapsed) : '--'}</td>
      <td style="text-align:center">${r.exec_status === 'RUNNING' ? '<span class="active-dot"></span>' : ''}</td>
    `;
    tbody.appendChild(tr);

    // Detail panel row
    if (isOpen) {
      const origQ = QUERIES.find(q => q.id === r.id);
      if (origQ) {
        const detailHtml = renderDetailPanel(origQ);
        const detailContainer = document.createElement('tr');
        detailContainer.innerHTML = `<td colspan="7" class="detail-panel open" style="display:table-cell">${detailHtml.replace(/<tr><td colspan="8" class="detail-panel open">/, '').replace(/<\/td><\/tr>$/, '')}</td>`;
        tbody.appendChild(detailContainer);
      }
    }
  }
}

function renderWorkers() {
  for (let i = 0; i < 4; i++) {
    const card = document.getElementById('wc-' + (i + 1));
    const qid = workerState[i];
    const dot = card.querySelector('.status-dot');
    const info = card.querySelector('.worker-info');
    const time = card.querySelector('.worker-time');

    if (qid) {
      card.className = 'worker-card active';
      dot.className = 'status-dot green pulse';
      const phase = phases[Math.min(Math.floor(workerTimers[i] / 8), 3)];
      info.innerHTML = `<span class="query-ref">${esc(qid)}</span> <span class="phase-ref">${phase}</span>`;
      time.textContent = fmtTime(workerTimers[i]);
    } else {
      card.className = 'worker-card idle';
      dot.className = 'status-dot gray';
      info.textContent = 'Standby';
      time.textContent = '';
    }
  }
}

function renderQueue() {
  const list = document.getElementById('queue-list');
  const countEl = document.getElementById('queue-count');
  list.innerHTML = '';
  countEl.textContent = `(${queueOrder.length} remaining)`;

  const show = queueOrder.slice(0, 6);
  show.forEach((qid, i) => {
    const q = execQueries.find(eq => eq.id === qid);
    const li = document.createElement('li');
    li.className = 'queue-item';
    li.innerHTML = `
      <span class="queue-rank">${i + 1}.</span>
      <span style="font-weight:500">${esc(qid)}</span>
      ${q ? bucketBadge(q.bucket) : ''}
      <span style="color:var(--t3)">${q ? q.iters + ' rnd' : ''}</span>
    `;
    list.appendChild(li);
  });

  if (queueOrder.length > 6) {
    const more = document.createElement('li');
    more.className = 'queue-more';
    more.textContent = `+${queueOrder.length - 6} more`;
    list.appendChild(more);
  }
}

function updateExecStats() {
  const done = Object.keys(completedSet).length;
  const total = execQueries.length;
  const active = workerState.filter(w => w !== null).length;
  const queued = queueOrder.length;
  const wins = Object.values(completedSet).filter(r => r.status === 'WIN').length;
  const improved = Object.values(completedSet).filter(r => r.status === 'IMPROVED').length;
  const neutral = Object.values(completedSet).filter(r => r.status === 'NEUTRAL').length;
  const regress = Object.values(completedSet).filter(r => r.status === 'REGRESSION').length;
  const errors = Object.values(completedSet).filter(r => r.status === 'ERROR').length;

  document.getElementById('exec-done').textContent = done;
  document.getElementById('exec-total').textContent = total;
  document.getElementById('exec-active').textContent = active;
  document.getElementById('exec-queued').textContent = queued;
  document.getElementById('exec-wins').textContent = wins;
  document.getElementById('exec-improved').textContent = improved;
  document.getElementById('exec-neutral').textContent = neutral;
  document.getElementById('exec-regress').textContent = regress;
  document.getElementById('exec-errors').textContent = errors;
  document.getElementById('exec-clock').textContent = fmtTime(clockSeconds);
  document.getElementById('exec-api').textContent = apiCalls;

  const savings = calcSavings(execQueries);
  document.getElementById('exec-savings').textContent = fmtMoney(savings);

  const pct = total > 0 ? (done / total) * 100 : 0;
  document.getElementById('progress-fill').style.width = pct + '%';
}

function addEvent(target, msg, type) {
  const now = new Date();
  const ts = [now.getHours(), now.getMinutes(), now.getSeconds()]
    .map(n => String(n).padStart(2, '0')).join(':');

  eventEntries.push({ ts, target, msg, type });

  const log = document.getElementById('event-log');
  const div = document.createElement('div');
  div.className = 'event-entry ev-' + (type || 'system');
  div.innerHTML = `
    <span class="event-ts">${ts}</span>
    <span class="event-target">${esc(target)}</span>
    <span class="event-msg">${esc(msg)}</span>
  `;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ── Simulation Engine ───────────────────────────────────────
function approveAndDeploy() {
  // Build execution list
  execQueries = QUERIES.filter(q => q.bucket !== 'SKIP' && !excludedIds.has(q.id));

  // Priority order: HIGH first (by runtime desc), then MEDIUM, then LOW
  const bucketOrder = { HIGH: 0, MEDIUM: 1, LOW: 2 };
  execQueries.sort((a, b) => {
    const bo = (bucketOrder[a.bucket] || 9) - (bucketOrder[b.bucket] || 9);
    if (bo !== 0) return bo;
    return b.runtime_ms - a.runtime_ms;
  });

  queueOrder = execQueries.map(q => q.id);
  completedSet = {};
  workerState = [null, null, null, null];
  workerTimers = [0, 0, 0, 0];
  clockSeconds = 0;
  apiCalls = 0;
  isPaused = false;
  eventEntries = [];

  // Transition views
  document.getElementById('view-triage').classList.remove('active', 'fade-in');
  const execView = document.getElementById('view-execution');
  execView.classList.add('active', 'fade-in');

  // Update header status
  setHeaderStatus('running');

  // Clear log
  document.getElementById('event-log').innerHTML = '';
  addEvent('Fleet', `Started (${execQueries.length} queries, 4 workers)`, 'system');

  // Assign initial workers
  for (let i = 0; i < 4; i++) assignWorker(i);

  // Start clock
  clockInterval = setInterval(() => {
    if (isPaused) return;
    clockSeconds++;
    // Tick worker timers
    for (let i = 0; i < 4; i++) {
      if (workerState[i]) workerTimers[i]++;
    }
    updateExecStats();
    renderWorkers();
    renderExecTable();
  }, 1000);

  // Simulation: complete a query every 4-7 seconds
  scheduleNextCompletion();

  renderExecTable();
  renderWorkers();
  renderQueue();
  updateExecStats();
}

function assignWorker(workerIdx) {
  if (queueOrder.length === 0) {
    workerState[workerIdx] = null;
    workerTimers[workerIdx] = 0;
    return;
  }

  const qid = queueOrder.shift();
  workerState[workerIdx] = qid;
  workerTimers[workerIdx] = 0;
  apiCalls += 4;

  addEvent(`W${workerIdx + 1}`, `Assigned ${qid}`, 'assign');
  renderQueue();
  renderWorkers();
}

function completeQuery(workerIdx) {
  const qid = workerState[workerIdx];
  if (!qid) return;

  const q = QUERIES.find(q => q.id === qid);
  if (!q) return;

  const status = q.outcome || 'NEUTRAL';
  const speedup = q.speedup || 1.0;
  const elapsed = workerTimers[workerIdx];

  completedSet[qid] = {
    status,
    speedup,
    transform: q.out_transform,
    elapsed_s: elapsed,
  };

  // Log event
  let msg = '';
  if (status === 'WIN') msg = `WIN ${speedup.toFixed(2)}x (${q.out_transform})`;
  else if (status === 'IMPROVED') msg = `IMPROVED ${speedup.toFixed(2)}x (${q.out_transform})`;
  else if (status === 'NEUTRAL') msg = `NEUTRAL ${speedup.toFixed(2)}x`;
  else if (status === 'REGRESSION') msg = `REGRESSION ${speedup.toFixed(2)}x`;
  else msg = status;

  addEvent(qid, msg, status.toLowerCase());
  addEvent(`W${workerIdx + 1}`, `Freed`, 'system');

  // Assign next
  assignWorker(workerIdx);
  updateExecStats();
  renderExecTable();
  renderWorkers();

  // Check if all done
  const allDone = execQueries.every(q => completedSet[q.id]);
  if (allDone) {
    clearInterval(clockInterval);
    clearTimeout(simInterval);
    setTimeout(showDone, 800);
  } else {
    scheduleNextCompletion();
  }
}

function scheduleNextCompletion() {
  const delay = 3000 + Math.random() * 4000; // 3-7 seconds
  simInterval = setTimeout(() => {
    if (isPaused) { scheduleNextCompletion(); return; }

    // Find a busy worker
    const busyWorkers = workerState.map((w, i) => w ? i : -1).filter(i => i >= 0);
    if (busyWorkers.length === 0) return;

    // Pick the one that's been running longest
    let pick = busyWorkers[0];
    for (const wi of busyWorkers) {
      if (workerTimers[wi] > workerTimers[pick]) pick = wi;
    }

    completeQuery(pick);
  }, delay);
}

function togglePause() {
  isPaused = !isPaused;
  const btn = document.getElementById('btn-pause');
  if (isPaused) {
    btn.textContent = 'Resume';
    setHeaderStatus('paused');
    addEvent('Fleet', 'Paused', 'system');
  } else {
    btn.textContent = 'Pause All';
    setHeaderStatus('running');
    addEvent('Fleet', 'Resumed', 'system');
  }
}

function showDone() {
  document.getElementById('view-execution').classList.remove('active', 'fade-in');
  const doneView = document.getElementById('view-done');
  doneView.classList.add('active', 'fade-in');

  setHeaderStatus('done');

  const savings = calcSavings(execQueries);
  const optimized = Object.values(completedSet).filter(r => r.status === 'WIN' || r.status === 'IMPROVED').length;
  const regress = Object.values(completedSet).filter(r => r.status === 'REGRESSION').length;

  document.getElementById('done-savings').textContent = fmtMoney(savings);
  document.getElementById('done-total').textContent = execQueries.length;
  document.getElementById('done-optimized').textContent = optimized;
  document.getElementById('done-regressions').textContent = regress;
  document.getElementById('done-time').textContent = fmtTime(clockSeconds);

  // Render done table
  const tbody = document.getElementById('done-tbody');
  tbody.innerHTML = '';

  const sorted = [...execQueries].sort((a, b) => {
    const ra = completedSet[a.id], rb = completedSet[b.id];
    return (rb ? rb.speedup : 0) - (ra ? ra.speedup : 0);
  });

  for (const q of sorted) {
    const r = completedSet[q.id];
    if (!r) continue;

    const annualSaved = r.speedup > 1.0 ? q.est_annual * (1 - 1/r.speedup) : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono" style="font-weight:500">${esc(q.id)}</td>
      <td>${statusBadge(r.status)}</td>
      <td class="right">${speedupHtml(r.speedup)}</td>
      <td>${bucketBadge(q.bucket)}</td>
      <td style="font-family:var(--mono);font-size:12px;color:var(--purple)">${r.transform || '--'}</td>
      <td class="mono right" style="color:${annualSaved > 0 ? 'var(--green)' : 'var(--t3)'}">${annualSaved > 0 ? fmtMoney(annualSaved) : '--'}</td>
    `;
    tbody.appendChild(tr);
  }
}

function setHeaderStatus(s) {
  const el = document.getElementById('header-status');
  const labels = { triage: 'TRIAGE REVIEW', running: 'RUNNING', paused: 'PAUSED', done: 'COMPLETE' };
  const dotCls = { triage: 'blue pulse', running: 'green pulse', paused: 'amber', done: 'green' };
  const wrapCls = { triage: 'triage', running: 'running', paused: 'paused', done: 'done' };

  el.className = 'status-indicator ' + wrapCls[s];
  el.innerHTML = `<span class="status-dot ${dotCls[s]}"></span>${labels[s]}`;
}

function exportPlan() {
  const plan = QUERIES.filter(q => !excludedIds.has(q.id) && q.bucket !== 'SKIP').map(q => ({
    query_id: q.id,
    bucket: q.bucket,
    max_iterations: q.iters,
    transform: q.transform,
    est_annual_cost: q.est_annual,
  }));

  const blob = new Blob([JSON.stringify({ plan, timestamp: new Date().toISOString() }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_plan.json';
  a.click();
  URL.revokeObjectURL(url);
}

function exportResults() {
  const results = execQueries.map(q => {
    const r = completedSet[q.id] || {};
    return {
      query_id: q.id,
      bucket: q.bucket,
      status: r.status || 'SKIPPED',
      speedup: r.speedup || null,
      transform: r.transform || '',
      est_annual_cost: q.est_annual,
      est_annual_saved: r.speedup > 1 ? Math.round(q.est_annual * (1 - 1/r.speedup)) : 0,
    };
  });

  const blob = new Blob([JSON.stringify({ results, elapsed_seconds: clockSeconds, timestamp: new Date().toISOString() }, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fleet_results.json';
  a.click();
  URL.revokeObjectURL(url);
}

// Wire exec sort headers
document.querySelectorAll('#exec-table th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const col = th.dataset.esort;
    if (execSortCol === col) execSortDir *= -1;
    else { execSortCol = col; execSortDir = col === 'query_id' ? 1 : -1; }
    renderExecTable();
  });
});

// ── Init ────────────────────────────────────────────────────
renderTriageTable();
updateTriageStats();
</script>
</body>
</html>
