WITH filtered_d1 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_moy = 4
      AND d_year = 2000
), filtered_d2 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_moy BETWEEN 4 AND 10
      AND d_year = 2000
), filtered_d3 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_moy BETWEEN 4 AND 10
      AND d_year = 2000
), store_sales_prefetch AS (
    SELECT 
        ss.ss_customer_sk,
        ss.ss_item_sk,
        ss.ss_ticket_number,
        ss.ss_store_sk,
        ss.ss_net_profit,
        i.i_item_id,
        i.i_item_desc,
        s.s_store_id,
        s.s_store_name
    FROM store_sales ss
    JOIN filtered_d1 d1 ON ss.ss_sold_date_sk = d1.d_date_sk
    JOIN item i ON ss.ss_item_sk = i.i_item_sk
    JOIN store s ON ss.ss_store_sk = s.s_store_sk
), store_returns_prefetch AS (
    SELECT 
        sr.sr_customer_sk,
        sr.sr_item_sk,
        sr.sr_ticket_number,
        sr.sr_net_loss,
        ss.i_item_id,
        ss.i_item_desc,
        ss.s_store_id,
        ss.s_store_name,
        ss.ss_net_profit
    FROM store_returns sr
    JOIN filtered_d2 d2 ON sr.sr_returned_date_sk = d2.d_date_sk
    JOIN store_sales_prefetch ss 
        ON sr.sr_customer_sk = ss.ss_customer_sk
       AND sr.sr_item_sk = ss.ss_item_sk
       AND sr.sr_ticket_number = ss.ss_ticket_number
), catalog_sales_prefetch AS (
    SELECT 
        cs.cs_net_profit,
        sr.i_item_id,
        sr.i_item_desc,
        sr.s_store_id,
        sr.s_store_name,
        sr.ss_net_profit,
        sr.sr_net_loss
    FROM catalog_sales cs
    JOIN filtered_d3 d3 ON cs.cs_sold_date_sk = d3.d_date_sk
    JOIN store_returns_prefetch sr 
        ON cs.cs_bill_customer_sk = sr.sr_customer_sk
       AND cs.cs_item_sk = sr.sr_item_sk
)
SELECT 
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name,
    SUM(ss_net_profit) AS store_sales_profit,
    SUM(sr_net_loss) AS store_returns_loss,
    SUM(cs_net_profit) AS catalog_sales_profit
FROM catalog_sales_prefetch
GROUP BY 
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name
ORDER BY 
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name
LIMIT 100;

-- Changes: Applied aggressive multi-fact prefetch by creating CTEs for filtered date dimensions, then progressively joining each fact table (store_sales → store_returns → catalog_sales) while carrying forward the necessary columns for final aggregation.
-- Expected speedup: 2-3x by reducing fact table scans through early filtering and pre-joining.