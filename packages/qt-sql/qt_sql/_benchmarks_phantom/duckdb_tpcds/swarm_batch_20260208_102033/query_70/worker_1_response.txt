```sql
WITH date_filtered AS (
  SELECT d_date_sk
  FROM date_dim
  WHERE d_month_seq BETWEEN 1213 AND 1213 + 11
),
store_sales_agg AS (
  SELECT 
    store.s_state,
    store.s_county,
    SUM(store_sales.ss_net_profit) AS state_county_profit
  FROM store_sales
  JOIN date_filtered ON date_filtered.d_date_sk = store_sales.ss_sold_date_sk
  JOIN store ON store.s_store_sk = store_sales.ss_store_sk
  GROUP BY store.s_state, store.s_county
),
state_ranking AS (
  SELECT s_state
  FROM (
    SELECT 
      s_state,
      RANK() OVER (PARTITION BY s_state ORDER BY SUM(state_county_profit) DESC) AS ranking
    FROM store_sales_agg
    GROUP BY s_state
  ) AS tmp1
  WHERE ranking <= 5
),
filtered_store_sales_agg AS (
  SELECT s_state, s_county, state_county_profit
  FROM store_sales_agg
  WHERE s_state IN (SELECT s_state FROM state_ranking)
)
SELECT
  total_sum,
  s_state,
  s_county,
  lochierarchy,
  rank_within_parent
FROM (
  SELECT
    SUM(state_county_profit) AS total_sum,
    s_state,
    s_county,
    GROUPING(s_state) + GROUPING(s_county) AS lochierarchy,
    RANK() OVER (
      PARTITION BY GROUPING(s_state) + GROUPING(s_county),
                   CASE WHEN GROUPING(s_county) = 0 THEN s_state END
      ORDER BY SUM(state_county_profit) DESC
    ) AS rank_within_parent
  FROM filtered_store_sales_agg
  GROUP BY ROLLUP (s_state, s_county)
) AS t
ORDER BY
  lochierarchy DESC,
  CASE WHEN lochierarchy = 0 THEN s_state END,
  rank_within_parent
LIMIT 100
```

**Changes**: Created materialized CTEs to pre-filter date_dim, pre-aggregate store_sales by state/county, compute state ranking from the pre-aggregated data, then filter before the expensive ROLLUP and window function.

**Expected speedup**: ~1.5-2x by reducing join sizes early and avoiding recomputation of the date filter and state ranking subquery.