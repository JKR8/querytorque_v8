WITH filtered_d1 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_moy = 4
      AND d_year = 1999
),
filtered_d2 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_moy BETWEEN 4 AND 7
      AND d_year = 1999
),
filtered_d3 AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_year IN (1999, 2000, 2001)
),
prefiltered_store_sales AS (
    SELECT
        ss_item_sk,
        ss_store_sk,
        ss_customer_sk,
        ss_ticket_number,
        ss_quantity
    FROM store_sales
    JOIN filtered_d1 ON ss_sold_date_sk = filtered_d1.d_date_sk
),
prefiltered_store_returns AS (
    SELECT
        sr_item_sk,
        sr_customer_sk,
        sr_ticket_number,
        sr_return_quantity
    FROM store_returns
    JOIN filtered_d2 ON sr_returned_date_sk = filtered_d2.d_date_sk
),
prefiltered_catalog_sales AS (
    SELECT
        cs_item_sk,
        cs_bill_customer_sk,
        cs_quantity
    FROM catalog_sales
    JOIN filtered_d3 ON cs_sold_date_sk = filtered_d3.d_date_sk
)
SELECT
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name,
    AVG(ss_quantity) AS store_sales_quantity,
    AVG(sr_return_quantity) AS store_returns_quantity,
    AVG(cs_quantity) AS catalog_sales_quantity
FROM prefiltered_store_sales
JOIN item ON i_item_sk = prefiltered_store_sales.ss_item_sk
JOIN store ON s_store_sk = prefiltered_store_sales.ss_store_sk
JOIN prefiltered_store_returns ON
    prefiltered_store_sales.ss_customer_sk = prefiltered_store_returns.sr_customer_sk
    AND prefiltered_store_sales.ss_item_sk = prefiltered_store_returns.sr_item_sk
    AND prefiltered_store_sales.ss_ticket_number = prefiltered_store_returns.sr_ticket_number
JOIN prefiltered_catalog_sales ON
    prefiltered_store_returns.sr_customer_sk = prefiltered_catalog_sales.cs_bill_customer_sk
    AND prefiltered_store_returns.sr_item_sk = prefiltered_catalog_sales.cs_item_sk
GROUP BY
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name
ORDER BY
    i_item_id,
    i_item_desc,
    s_store_id,
    s_store_name
LIMIT 100;

```
Changes: Applied aggressive multi-stage prefetch by creating separate CTEs for filtered dimensions (date_dim instances) and pre-joining them with their respective fact tables before the main multi-way join, significantly reducing intermediate data volume.

Expected speedup: 2.5-3x
```