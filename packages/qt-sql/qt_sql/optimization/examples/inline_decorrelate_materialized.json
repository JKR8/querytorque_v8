{
  "id": "inline_decorrelate_materialized",
  "name": "Inline Correlated Subquery to Materialized CTEs",
  "description": "Convert inline correlated scalar subquery (WHERE col > SELECT avg(...) WHERE key = outer.key) into 3 MATERIALIZED CTEs: dimension filter, date-filtered fact, per-key threshold. JOIN threshold instead of per-row subquery.",
  "benchmark_queries": [
    "Q32",
    "Q92"
  ],
  "verified_speedup": "timeout_rescue (>300x)",
  "example": {
    "opportunity": "DECORRELATE + EARLY_FILTER + DATE_CTE_ISOLATE",
    "input_slice": "[flat_from_clause]:\nSELECT sum(cs_ext_discount_amt) AS \"excess discount amount\"\nFROM catalog_sales, item, date_dim\nWHERE (i_manufact_id IN (...) OR i_manager_id BETWEEN ...)\n  AND i_item_sk = cs_item_sk\n  AND d_date BETWEEN ... AND ... + interval '90 day'\n  AND d_date_sk = cs_sold_date_sk\n  AND cs_ext_discount_amt > (\n      SELECT 1.3 * avg(cs_ext_discount_amt)\n      FROM catalog_sales, date_dim\n      WHERE cs_item_sk = i_item_sk  -- CORRELATED\n        AND d_date BETWEEN ... AND ...\n        AND d_date_sk = cs_sold_date_sk\n        AND cs_list_price BETWEEN ... AND ...\n  )",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "inline_decorrelate_materialized",
          "nodes": {
            "filtered_items": "SELECT i_item_sk FROM item WHERE i_manufact_id IN (...) OR i_manager_id BETWEEN ...",
            "date_filtered_sales": "SELECT cs.cs_item_sk, cs.cs_ext_discount_amt, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs JOIN date_dim d ON d.d_date_sk = cs.cs_sold_date_sk WHERE d.d_date BETWEEN ... AND ... + interval '90 day'",
            "item_avg_discount": "SELECT dfs.cs_item_sk, 1.3 * avg(dfs.cs_ext_discount_amt) AS threshold FROM date_filtered_sales dfs JOIN filtered_items fi ON fi.i_item_sk = dfs.cs_item_sk WHERE dfs.cs_list_price BETWEEN ... GROUP BY dfs.cs_item_sk",
            "main_query": "SELECT sum(dfs.cs_ext_discount_amt) FROM date_filtered_sales dfs JOIN item_avg_discount iad ON iad.cs_item_sk = dfs.cs_item_sk WHERE dfs.cs_ext_discount_amt > iad.threshold ORDER BY 1 LIMIT 100"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation result",
            "same ordering"
          ],
          "expected_speedup": ">300x (timeout rescue)",
          "risk": "low"
        }
      ]
    },
    "key_insight": "When WHERE has an inline correlated scalar subquery that re-scans the fact table per outer row, decompose into 3 MATERIALIZED CTEs: (1) dimension key filter, (2) date-filtered fact scan (shared between threshold and final), (3) per-key GROUP BY threshold. JOIN threshold in final query. CRITICAL on PostgreSQL: use AS MATERIALIZED to prevent CTE inlining."
  },
  "original_sql": "select  sum(cs_ext_discount_amt)  as \"excess discount amount\"\nfrom\n   catalog_sales\n   ,item\n   ,date_dim\nwhere\n(i_manufact_id in (1, 78, 97, 516, 521)\nor i_manager_id BETWEEN 25 and 54)\nand i_item_sk = cs_item_sk\nand d_date between '1999-03-07' and\n        cast('1999-03-07' as date) + interval '90 day'\nand d_date_sk = cs_sold_date_sk\nand cs_ext_discount_amt\n     > (\n         select\n            1.3 * avg(cs_ext_discount_amt)\n         from\n            catalog_sales\n           ,date_dim\n         where\n              cs_item_sk = i_item_sk\n          and d_date between '1999-03-07' and\n                             cast('1999-03-07' as date) + interval '90 day'\n          and d_date_sk = cs_sold_date_sk\n          and cs_list_price between 16 and 45\n          and cs_sales_price / cs_list_price BETWEEN 63 * 0.01 AND 83 * 0.01\n      )\norder by sum(cs_ext_discount_amt)\nlimit 100;",
  "optimized_sql": "WITH filtered_items AS MATERIALIZED (\n    SELECT i_item_sk\n    FROM item\n    WHERE i_manufact_id IN (1, 78, 97, 516, 521)\n       OR i_manager_id BETWEEN 25 AND 54\n),\ndate_filtered_sales AS MATERIALIZED (\n    SELECT cs.cs_item_sk, cs.cs_ext_discount_amt,\n           cs.cs_list_price, cs.cs_sales_price\n    FROM catalog_sales cs\n    JOIN date_dim d ON d.d_date_sk = cs.cs_sold_date_sk\n    WHERE d.d_date BETWEEN '1999-03-07' AND cast('1999-03-07' as date) + interval '90 day'\n),\nitem_avg_discount AS MATERIALIZED (\n    SELECT dfs.cs_item_sk,\n           1.3 * avg(dfs.cs_ext_discount_amt) AS threshold\n    FROM date_filtered_sales dfs\n    JOIN filtered_items fi ON fi.i_item_sk = dfs.cs_item_sk\n    WHERE dfs.cs_list_price BETWEEN 16 AND 45\n      AND dfs.cs_sales_price / dfs.cs_list_price BETWEEN 63 * 0.01 AND 83 * 0.01\n    GROUP BY dfs.cs_item_sk\n)\nSELECT sum(dfs.cs_ext_discount_amt) AS \"excess discount amount\"\nFROM date_filtered_sales dfs\nJOIN item_avg_discount iad ON iad.cs_item_sk = dfs.cs_item_sk\nWHERE dfs.cs_ext_discount_amt > iad.threshold\nORDER BY 1\nLIMIT 100;",
  "optimized_source": "manual",
  "benchmark_query_num": 32
}
