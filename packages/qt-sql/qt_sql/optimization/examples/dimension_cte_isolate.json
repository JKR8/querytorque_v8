{
  "id": "dimension_cte_isolate",
  "name": "Dimension CTE Isolation",
  "description": "Pre-filter ALL dimension tables into CTEs before joining with fact table, not just date_dim",
  "benchmark_queries": ["Q26"],
  "verified_speedup": "1.93x",
  "example": {
    "opportunity": "DIMENSION CTE ISOLATION",
    "input_slice": "SELECT i_item_id, avg(cs_quantity) agg1, avg(cs_list_price) agg2, avg(cs_coupon_amt) agg3, avg(cs_sales_price) agg4\nFROM catalog_sales, customer_demographics, date_dim, item, promotion\nWHERE cs_sold_date_sk = d_date_sk AND cs_item_sk = i_item_sk\n  AND cs_bill_cdemo_sk = cd_demo_sk AND cs_promo_sk = p_promo_sk\n  AND cd_gender = 'M' AND cd_marital_status = 'S' AND cd_education_status = 'College'\n  AND (p_channel_email = 'N' OR p_channel_event = 'N') AND d_year = 2000\nGROUP BY i_item_id ORDER BY i_item_id LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "dimension_cte_isolate",
        "nodes": {
          "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
          "filtered_customer_demographics": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'S' AND cd_education_status = 'College'",
          "filtered_promotions": "SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'N' OR p_channel_event = 'N'",
          "joined_facts": "SELECT cs_item_sk, cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price FROM catalog_sales AS cs JOIN filtered_dates AS fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN filtered_customer_demographics AS fcd ON cs.cs_bill_cdemo_sk = fcd.cd_demo_sk JOIN filtered_promotions AS fp ON cs.cs_promo_sk = fp.p_promo_sk",
          "main_query": "SELECT i_item_id, AVG(cs_quantity) AS agg1, AVG(cs_list_price) AS agg2, AVG(cs_coupon_amt) AS agg3, AVG(cs_sales_price) AS agg4 FROM joined_facts AS jf JOIN item AS i ON jf.cs_item_sk = i.i_item_sk GROUP BY i_item_id ORDER BY i_item_id LIMIT 100"
        },
        "invariants_kept": ["same result rows", "same ordering", "same column output"],
        "expected_speedup": "1.90x",
        "risk": "low"
      }]
    },
    "key_insight": "Pre-filter EACH dimension table into its own CTE returning only the surrogate key. This reduces the cardinality of subsequent joins. Works best when dimension filters are highly selective."
  }
}
