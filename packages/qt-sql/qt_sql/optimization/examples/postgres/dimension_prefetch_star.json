{
  "id": "pg_dimension_prefetch_star",
  "name": "Dimension Pre-filter with Explicit JOINs (PostgreSQL)",
  "description": "On multi-channel UNION queries with comma-separated implicit joins, pre-filter dimension tables (date, item, promotion) into CTEs and convert to explicit JOIN syntax. PostgreSQL's optimizer gets better cardinality estimates and join ordering from explicit JOINs with pre-materialized small dimension results.",
  "engine": "postgresql",
  "benchmark": "DSB SF10",
  "benchmark_queries": ["DSB Q080_multi"],
  "verified_speedup": "3.32x",
  "transforms": ["date_cte_isolate", "early_filter"],
  "example": {
    "opportunity": "DIMENSION_PREFETCH_STAR",
    "input_slice": "with ssr as\n (select s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n  from store_sales left outer join store_returns on\n       (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n     date_dim, store, item, promotion\n where ss_sold_date_sk = d_date_sk\n   and d_date between '1998-08-23' and '1998-08-23'::date + interval '30 day'\n   and ss_store_sk = s_store_sk\n   and ss_item_sk = i_item_sk\n   and i_current_price > 50\n   and ss_promo_sk = p_promo_sk\n   and p_channel_email = 'Y' and p_channel_tv = 'Y'\n   and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'Y'\n   and ss_wholesale_cost BETWEEN 63 AND 78\n   and i_category IN ('Jewelry', 'Music')\n group by s_store_id)\n-- ... csr and wsr CTEs similar ...\nselect channel, id, sum(sales), sum(returns), sum(profit)\nfrom (...) x group by rollup(channel, id) order by channel, id limit 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "date_cte_isolate + early_filter",
        "nodes": {
          "filtered_date": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-23' AS DATE) AND CAST('1998-08-23' AS DATE) + INTERVAL '30 DAY'",
          "filtered_item": "SELECT i_item_sk FROM item WHERE i_current_price > 50 AND i_category IN ('Jewelry', 'Music')",
          "filtered_promotion": "SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'Y'",
          "ssr": "SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) INNER JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN store ON ss_store_sk = s_store_sk INNER JOIN filtered_item ON ss_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON ss_promo_sk = filtered_promotion.p_promo_sk WHERE ss_wholesale_cost BETWEEN 63 AND 78 GROUP BY s_store_id"
        },
        "invariants_kept": ["same result rows", "same aggregation", "same ROLLUP"],
        "expected_speedup": "3.3x",
        "risk": "low"
      }]
    },
    "key_insight": "Pre-filtering dimension tables (date: 30 days from 73K, item: 2 categories, promotion: 5 boolean filters) into CTEs creates tiny hash tables. Converting comma joins to explicit INNER JOIN gives PostgreSQL's optimizer better join-order freedom and cardinality estimates. Even partial transformation (one UNION branch) helps when that branch dominates runtime.",
    "pattern_detection": "Look for multi-channel queries (store/catalog/web) using comma-separated implicit joins with shared dimension filters (date range, item category, promotion flags). These queries benefit from extracting shared dimension filters into CTEs and converting to explicit JOINs."
  }
}
