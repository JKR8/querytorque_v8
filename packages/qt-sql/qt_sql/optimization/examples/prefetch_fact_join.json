{
  "id": "prefetch_fact_join",
  "name": "Prefetch Fact Join",
  "description": "Pre-filter dimension table into CTE, then pre-join with fact table in second CTE before joining other dimensions",
  "benchmark_queries": ["Q63"],
  "verified_speedup": "3.77x",
  "example": {
    "opportunity": "PREFETCH FACT JOIN",
    "input_slice": "SELECT * FROM (\n  SELECT i_manager_id, sum(ss_sales_price) sum_sales,\n    avg(sum(ss_sales_price)) OVER (PARTITION BY i_manager_id) avg_monthly_sales\n  FROM item, store_sales, date_dim, store\n  WHERE ss_item_sk = i_item_sk AND ss_sold_date_sk = d_date_sk AND ss_store_sk = s_store_sk\n    AND d_month_seq IN (1200,1201,1202,1203,1204,1205,1206,1207,1208,1209,1210,1211)\n    AND ((i_category IN ('Books','Children','Electronics') AND i_class IN ('personal','portable','reference','self-help') AND i_brand IN (...))\n      OR (i_category IN ('Women','Music','Men') AND i_class IN ('accessories','classical','fragrances','pants') AND i_brand IN (...)))\n  GROUP BY i_manager_id, d_moy\n) AS tmp1\nWHERE CASE WHEN avg_monthly_sales > 0 THEN ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1\nORDER BY i_manager_id, avg_monthly_sales, sum_sales LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "prefetch_fact_join",
        "nodes": {
          "filtered_dates": "SELECT d_date_sk, d_moy FROM date_dim WHERE d_month_seq IN (1200, 1201, 1202, 1203, 1204, 1205, 1206, 1207, 1208, 1209, 1210, 1211)",
          "filtered_sales": "SELECT ss_item_sk, ss_store_sk, ss_sales_price, d_moy FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk",
          "main_query": "SELECT * FROM (SELECT i_manager_id, SUM(ss_sales_price) AS sum_sales, AVG(SUM(ss_sales_price)) OVER (PARTITION BY i_manager_id) AS avg_monthly_sales FROM item JOIN filtered_sales ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk WHERE ((i_category IN ('Books', 'Children', 'Electronics') AND i_class IN ('personal', 'portable', 'reference', 'self-help') AND i_brand IN (...)) OR (i_category IN ('Women', 'Music', 'Men') AND i_class IN ('accessories', 'classical', 'fragrances', 'pants') AND i_brand IN (...))) GROUP BY i_manager_id, d_moy) AS tmp1 WHERE CASE WHEN avg_monthly_sales > 0 THEN ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1 ORDER BY i_manager_id, avg_monthly_sales, sum_sales LIMIT 100"
        },
        "invariants_kept": ["same result rows", "same ordering", "same column output"],
        "expected_speedup": "3.77x",
        "risk": "low"
      }]
    },
    "key_insight": "First CTE filters the dimension (date_dim). Second CTE pre-joins this with the fact table (store_sales). This creates a smaller intermediate result before joining with other dimension tables. The pre-join materializes the filtered fact rows, making subsequent joins faster."
  }
}
