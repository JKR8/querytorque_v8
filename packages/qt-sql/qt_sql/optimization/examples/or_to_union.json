{
  "id": "or_to_union",
  "name": "OR to UNION ALL",
  "description": "Split OR conditions on different columns into UNION ALL branches for better index usage",
  "benchmark_queries": ["Q15"],
  "verified_speedup": "3.17x",
  "example": {
    "opportunity": "OR_TO_UNION + EARLY_FILTER",
    "input_slice": "[main_query]:\nSELECT ca_zip, sum(cs_sales_price)\nFROM catalog_sales, customer, customer_address, date_dim\nWHERE cs_bill_customer_sk = c_customer_sk\n  AND c_current_addr_sk = ca_address_sk\n  AND (substr(ca_zip,1,5) IN ('85669', '86197', '88274', '83405', '86475')\n       OR ca_state IN ('CA','WA','GA')\n       OR cs_sales_price > 500)\n  AND cs_sold_date_sk = d_date_sk\n  AND d_qoy = 1 AND d_year = 2001\nGROUP BY ca_zip ORDER BY ca_zip LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "or_to_union",
        "nodes": {
          "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_qoy = 1 AND d_year = 2001",
          "filtered_sales": "SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE substr(ca_zip,1,5) IN ('85669', '86197', '88274', '83405', '86475', '85392', '85460', '80348', '81792') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('CA','WA','GA') UNION ALL SELECT cs_sales_price, ca_zip FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE cs_sales_price > 500",
          "main_query": "SELECT ca_zip, SUM(cs_sales_price) FROM filtered_sales GROUP BY ca_zip ORDER BY ca_zip LIMIT 100"
        },
        "invariants_kept": ["output columns unchanged", "same rows after aggregation"],
        "expected_speedup": "2.98x",
        "risk": "low"
      }]
    },
    "key_insight": "Each OR branch becomes a separate query with focused predicates. Date filter is extracted as CTE and joined into each branch.",
    "when_not_to_use": "Do not split OR when all branches filter the SAME column on the same table (e.g., t_hour >= 8 OR t_hour <= 17). This duplicates the entire fact table scan for each branch with no selectivity benefit. Only apply when OR conditions span DIFFERENT tables or fundamentally different column families. Also never split into more than 3 UNION branches â€” each branch rescans the fact table. Caused 0.59x on Q90 (same-column time range split doubled fact scans) and historically 0.23x-0.41x on queries with 9+ UNION branches."
  }
}
