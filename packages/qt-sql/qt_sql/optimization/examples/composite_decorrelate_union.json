{
  "id": "composite_decorrelate_union",
  "name": "Decorrelate EXISTS + OR-to-UNION Composite",
  "description": "Decorrelate multiple correlated EXISTS subqueries into pre-materialized DISTINCT customer CTEs with a shared date filter, and replace OR(EXISTS a, EXISTS b) with UNION of key sets",
  "benchmark_queries": ["Q35"],
  "verified_speedup": "2.42x",
  "example": {
    "opportunity": "DECORRELATE + DATE_CTE_ISOLATE + OR_TO_UNION",
    "input_slice": "[main_query]:\nSELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, count(*) cnt1, ...\nFROM customer c, customer_address ca, customer_demographics\nWHERE c.c_current_addr_sk = ca.ca_address_sk\n  AND cd_demo_sk = c.c_current_cdemo_sk\n  AND EXISTS (SELECT * FROM store_sales, date_dim\n              WHERE c.c_customer_sk = ss_customer_sk\n              AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND d_qoy < 4)\n  AND (EXISTS (SELECT * FROM web_sales, date_dim\n               WHERE c.c_customer_sk = ws_bill_customer_sk\n               AND ws_sold_date_sk = d_date_sk AND d_year = 2001 AND d_qoy < 4)\n       OR EXISTS (SELECT * FROM catalog_sales, date_dim\n                  WHERE c.c_customer_sk = cs_ship_customer_sk\n                  AND cs_sold_date_sk = d_date_sk AND d_year = 2001 AND d_qoy < 4))\nGROUP BY ... ORDER BY ... LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "decorrelate",
        "nodes": {
          "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4",
          "store_customers": "SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk",
          "web_customers": "SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk",
          "catalog_customers": "SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk",
          "web_or_catalog_customers": "SELECT ws_bill_customer_sk AS customer_sk FROM web_customers UNION SELECT cs_ship_customer_sk AS customer_sk FROM catalog_customers",
          "main_query": "SELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers AS sc ON c.c_customer_sk = sc.ss_customer_sk JOIN web_or_catalog_customers AS wcc ON c.c_customer_sk = wcc.customer_sk GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100"
        },
        "invariants_kept": ["same result rows", "same ordering", "same column output"],
        "expected_speedup": "2.40x",
        "risk": "low"
      }]
    },
    "key_insight": "Three-part composite: (1) Extract shared date filter into CTE (all 3 EXISTS use same d_year/d_qoy). (2) Decorrelate each EXISTS into SELECT DISTINCT customer_sk joined with filtered_dates. (3) Replace OR(EXISTS web, EXISTS catalog) with UNION of customer key CTEs. The EXISTS->JOIN conversion works because the main query only needs to know IF a customer exists, which DISTINCT + JOIN achieves. The UNION replaces OR logic at the set level."
  }
}
