{
  "id": "date_cte_isolate",
  "name": "Date CTE Isolation",
  "description": "Extract date filtering into a separate CTE to enable predicate pushdown and reduce scans",
  "benchmark_queries": ["Q6", "Q11"],
  "verified_speedup": "4.00x",
  "example": {
    "opportunity": "DATE_CTE_ISOLATE + CATEGORY_AVG",
    "input_slice": "[main_query]:\nSELECT a.ca_state state, count(*) cnt\nFROM customer_address a, customer c, store_sales s, date_dim d, item i\nWHERE a.ca_address_sk = c.c_current_addr_sk\n  AND c.c_customer_sk = s.ss_customer_sk\n  AND s.ss_sold_date_sk = d.d_date_sk\n  AND s.ss_item_sk = i.i_item_sk\n  AND d.d_month_seq = (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2000 AND d_moy = 1)\n  AND i.i_current_price > 1.2 * (SELECT avg(j.i_current_price) FROM item j WHERE j.i_category = i.i_category)\nGROUP BY a.ca_state HAVING count(*) >= 10\nORDER BY cnt, a.ca_state LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "date_cte_isolate",
        "nodes": {
          "target_month": "SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2000 AND d_moy = 1",
          "category_avg_price": "SELECT i_category, AVG(i_current_price) * 1.2 AS avg_threshold FROM item GROUP BY i_category",
          "filtered_dates": "SELECT d_date_sk FROM date_dim JOIN target_month ON d_month_seq = target_month.d_month_seq",
          "filtered_sales": "SELECT ss_customer_sk, ss_item_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk",
          "main_query": "SELECT a.ca_state AS state, COUNT(*) AS cnt FROM customer_address a JOIN customer c ON a.ca_address_sk = c.c_current_addr_sk JOIN filtered_sales s ON c.c_customer_sk = s.ss_customer_sk JOIN item i ON s.ss_item_sk = i.i_item_sk JOIN category_avg_price cap ON i.i_category = cap.i_category WHERE i.i_current_price > cap.avg_threshold GROUP BY a.ca_state HAVING COUNT(*) >= 10 ORDER BY cnt, a.ca_state LIMIT 100"
        },
        "invariants_kept": ["same result rows", "same ordering", "same column output", "same grouping and aggregation"],
        "expected_speedup": "2.0x",
        "risk": "low"
      }]
    },
    "key_insight": "Extract date month_seq subquery into CTE. Extract category average into separate CTE with GROUP BY. Join instead of correlated subquery. This allows each CTE to be scanned once."
  }
}
