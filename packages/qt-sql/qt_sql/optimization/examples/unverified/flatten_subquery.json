{
  "id": "flatten_subquery",
  "name": "Flatten Subquery to JOIN",
  "description": "Convert EXISTS/IN subqueries to equivalent JOINs",
  "benchmark_queries": [],
  "verified_speedup": "1.3-2.0x",
  "example": {
    "opportunity": "FLATTEN_SUBQUERY",
    "input_slice": "[main_query]:\nSELECT c_customer_id, c_first_name, c_last_name\nFROM customer\nWHERE c_customer_sk IN (\n  SELECT ss_customer_sk FROM store_sales\n  WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2000)\n)",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "flatten_subquery",
        "nodes": {
          "target_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
          "active_customers": "SELECT DISTINCT ss_customer_sk FROM store_sales JOIN target_dates ON ss_sold_date_sk = d_date_sk",
          "main_query": "SELECT c.c_customer_id, c.c_first_name, c.c_last_name FROM customer c JOIN active_customers ac ON c.c_customer_sk = ac.ss_customer_sk"
        },
        "invariants_kept": ["same result rows", "same columns"],
        "expected_speedup": "1.5x",
        "risk": "low"
      }]
    },
    "key_insight": "IN subquery becomes a JOIN. Nested IN becomes chained CTEs. DISTINCT ensures no duplicates from the semi-join semantics."
  }
}
