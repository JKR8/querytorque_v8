{
  "id": "materialize_cte",
  "name": "Materialize Repeated Subquery",
  "description": "Extract repeated subquery patterns into a CTE to avoid recomputation",
  "benchmark_queries": ["Q95"],
  "verified_speedup": "1.37x",
  "example": {
    "opportunity": "MATERIALIZE_CTE",
    "input_slice": "[main_query]:\nSELECT COUNT(DISTINCT ws_order_number) AS order_count,\n       SUM(ws_ext_ship_cost) AS total_shipping\nFROM web_sales ws1, date_dim, customer_address, web_site\nWHERE d_date BETWEEN '2000-03-01' AND '2000-05-01'\n  AND ws1.ws_ship_date_sk = d_date_sk\n  AND ws1.ws_ship_addr_sk = ca_address_sk\n  AND ca_state = 'IL'\n  AND ws1.ws_web_site_sk = web_site_sk\n  AND web_company_name = 'pri'\n  AND EXISTS (SELECT * FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n  AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number)",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "materialize_cte",
        "nodes": {
          "multi_warehouse_orders": "SELECT DISTINCT ws_order_number FROM web_sales ws1 WHERE EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)",
          "returned_orders": "SELECT DISTINCT wr_order_number FROM web_returns",
          "main_query": "SELECT COUNT(DISTINCT ws_order_number) AS order_count, SUM(ws_ext_ship_cost) AS total_shipping FROM web_sales ws1 JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk JOIN multi_warehouse_orders mwo ON ws1.ws_order_number = mwo.ws_order_number LEFT JOIN returned_orders ro ON ws1.ws_order_number = ro.wr_order_number WHERE d_date BETWEEN '2000-03-01' AND '2000-05-01' AND ca_state = 'IL' AND web_company_name = 'pri' AND ro.wr_order_number IS NULL"
        },
        "invariants_kept": ["same result rows", "same aggregation"],
        "expected_speedup": "1.8x",
        "risk": "low"
      }]
    },
    "key_insight": "Extract the EXISTS subquery into a CTE that finds multi-warehouse orders ONCE. Extract returned orders into another CTE. Join instead of nested EXISTS checks.",
    "when_not_to_use": "NEVER convert EXISTS or NOT EXISTS subqueries into materialized CTEs when the EXISTS is used as a filter (not a data source). EXISTS uses semi-join short-circuiting — the database stops scanning as soon as one match is found. Materializing into a CTE forces a full scan of the subquery table, destroying this optimization. Caused 0.14x on Q16 (7x slowdown — EXISTS on catalog_sales materialized into full CTE scan) and 0.54x on Q95 (EXISTS on web_sales forced full materialization)."
  }
}
