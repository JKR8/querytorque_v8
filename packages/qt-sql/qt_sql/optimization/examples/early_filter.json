{
  "id": "early_filter",
  "name": "Early Dimension Filter",
  "description": "Filter dimension tables FIRST, then join to fact tables to reduce expensive joins",
  "benchmark_queries": ["Q93", "Q11"],
  "verified_speedup": "4.00x",
  "example": {
    "opportunity": "EARLY_FILTER",
    "input_slice": "[main_query]:\nSELECT ss_customer_sk, SUM(act_sales) AS sumsales\nFROM (SELECT ss.ss_customer_sk, CASE WHEN sr.sr_return_quantity IS NOT NULL\n        THEN (ss.ss_quantity - sr.sr_return_quantity) * ss.ss_sales_price\n        ELSE ss.ss_quantity * ss.ss_sales_price END AS act_sales\n      FROM store_sales ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk\n      JOIN reason r ON sr.sr_reason_sk = r.r_reason_sk\n      WHERE r.r_reason_desc = 'duplicate purchase') t\nGROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100",
    "output": {
      "rewrite_sets": [{
        "id": "rs_01",
        "transform": "early_filter",
        "nodes": {
          "filtered_reason": "SELECT r_reason_sk FROM reason WHERE r_reason_desc = 'duplicate purchase'",
          "filtered_returns": "SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN filtered_reason ON sr_reason_sk = r_reason_sk",
          "main_query": "SELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM (SELECT ss.ss_customer_sk, CASE WHEN NOT fr.sr_return_quantity IS NULL THEN (ss.ss_quantity - fr.sr_return_quantity) * ss.ss_sales_price ELSE (ss.ss_quantity * ss.ss_sales_price) END AS act_sales FROM store_sales ss JOIN filtered_returns fr ON (fr.sr_item_sk = ss.ss_item_sk AND fr.sr_ticket_number = ss.ss_ticket_number)) AS t GROUP BY ss_customer_sk ORDER BY sumsales, ss_customer_sk LIMIT 100"
        },
        "invariants_kept": ["output columns unchanged", "grain preserved", "same result rows"],
        "expected_speedup": "2.71x",
        "risk": "low"
      }]
    },
    "key_insight": "Filter dimension table (reason) FIRST, then join to fact. Reduces returns to only 'duplicate purchase' before expensive store_sales join."
  }
}
