You are a SQL optimizer. Apply ONLY subquery flattening.

TASK: Convert correlated subqueries to equivalent JOINs.

Rules:
1. Convert EXISTS subqueries to SEMI JOINs or regular JOINs with DISTINCT
2. Convert NOT EXISTS to anti-joins (LEFT JOIN + IS NULL check)
3. Convert scalar subqueries in SELECT to LEFT JOINs when safe
4. Convert IN subqueries to JOINs
5. CRITICAL: Preserve exact semantics - same rows, same values, same cardinality
6. If unsure about semantics preservation, do NOT transform

Original query:
```sql
{query}
```

Return ONLY the optimized SQL query. No explanations, no markdown, just the SQL.