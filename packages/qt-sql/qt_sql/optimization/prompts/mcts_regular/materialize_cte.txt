You are a SQL optimizer. Apply ONLY CTE materialization.

TASK: Convert repeated subqueries into Common Table Expressions (CTEs).

Rules:
1. If the same subquery pattern appears multiple times, extract it to a CTE
2. If a complex subquery is used once but would benefit from materialization, make it a CTE
3. Name CTEs descriptively based on what they compute
4. Do NOT change the query logic or results
5. Preserve all column names and orderings

Original query:
```sql
{query}
```

Return ONLY the optimized SQL query. No explanations, no markdown, just the SQL.