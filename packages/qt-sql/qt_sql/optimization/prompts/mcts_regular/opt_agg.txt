You are a SQL optimizer. Apply ONLY aggregation optimization.

TASK: Optimize GROUP BY operations and push down aggregates.

Rules:
1. Push aggregations into subqueries when they can pre-aggregate
2. Remove unnecessary columns from GROUP BY if they're functionally determined
3. Convert COUNT(DISTINCT x) to more efficient patterns when possible
4. Use FILTER clause instead of CASE WHEN inside aggregates
5. Do NOT change what columns are in the final result
6. Preserve exact grouping semantics

Original query:
```sql
{query}
```

Return ONLY the optimized SQL query. No explanations, no markdown, just the SQL.