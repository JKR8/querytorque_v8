# DSPy SQLDagOptimizer Signature
# Mode: DAG (node-level rewrites)
# File: packages/qt-sql/qt_sql/optimization/dspy_optimizer.py

class SQLDagOptimizer(dspy.Signature):
    """Optimize SQL by rewriting specific DAG nodes.

    Instead of rewriting the entire SQL, output targeted rewrites
    for specific nodes (CTEs, subqueries, main_query).
    """

    # INPUTS
    query_dag: str = dspy.InputField(
        desc="DAG structure showing nodes (CTEs, subqueries, main_query) and their dependencies"
    )
    node_sql: str = dspy.InputField(
        desc="SQL for each node in the DAG"
    )
    execution_plan: str = dspy.InputField(
        desc="Execution plan showing operator costs and row counts"
    )
    optimization_hints: str = dspy.InputField(
        desc="Detected optimization opportunities with rewrite patterns",
        default=""
    )
    constraints: str = dspy.InputField(
        desc="Model and DB-specific constraints",
        default=""
    )

    # OUTPUTS
    rewrites: str = dspy.OutputField(
        desc='JSON object: {"node_id": "new SELECT statement", ...} for nodes to rewrite. Only include nodes you are changing.'
    )
    explanation: str = dspy.OutputField(
        desc="What was optimized and why"
    )

# NOTES:
# - Better for large queries (less token usage)
# - Preserves unchanged parts exactly
# - Returns JSON with targeted node rewrites
# - Uses DAG-format few-shot examples
