# DSPy SQLDagOptimizerWithFeedback Signature
# Mode: DAG + Retry (after validation failure)
# File: packages/qt-sql/qt_sql/optimization/dspy_optimizer.py

class SQLDagOptimizerWithFeedback(dspy.Signature):
    """Retry DAG optimization with a DIFFERENT strategy after failure."""

    # INPUTS
    query_dag: str = dspy.InputField(
        desc="DAG structure showing nodes and dependencies"
    )
    node_sql: str = dspy.InputField(
        desc="SQL for each node in the DAG"
    )
    execution_plan: str = dspy.InputField(
        desc="Execution plan showing operator costs"
    )
    optimization_hints: str = dspy.InputField(
        desc="Detected optimization opportunities with rewrite patterns",
        default=""
    )
    constraints: str = dspy.InputField(
        desc="Model and DB-specific constraints",
        default=""
    )
    previous_rewrites: str = dspy.InputField(
        desc="Previous rewrites that FAILED - try a different approach"
    )
    failure_reason: str = dspy.InputField(
        desc="Why the previous attempt failed"
    )

    # OUTPUTS
    rewrites: str = dspy.OutputField(
        desc='JSON object with DIFFERENT rewrites. Return {} to keep original.'
    )
    explanation: str = dspy.OutputField(
        desc="What different approach you tried"
    )

# NOTES:
# - Used after initial DAG optimization fails validation
# - Explicitly told what NOT to do (previous_rewrites)
# - Can return {} to keep original if no safe alternative
