# DSPy SQLOptimizerWithFeedback Signature
# Mode: Normal + Retry (after validation failure)
# File: packages/qt-sql/qt_sql/optimization/dspy_optimizer.py

class SQLOptimizerWithFeedback(dspy.Signature):
    """Optimize SQL query using a DIFFERENT strategy after a failed attempt."""

    # INPUTS
    original_query: str = dspy.InputField(
        desc="The original SQL query to optimize"
    )
    execution_plan: str = dspy.InputField(
        desc="Parsed execution plan showing operator costs and row counts"
    )
    row_estimates: str = dspy.InputField(
        desc="Table scan statistics: table name, rows scanned, filter status"
    )
    optimization_hints: str = dspy.InputField(
        desc="Detected optimization opportunities with rewrite patterns",
        default=""
    )
    constraints: str = dspy.InputField(
        desc="Model and DB-specific constraints to follow",
        default=""
    )
    previous_attempt: str = dspy.InputField(
        desc="Previous optimization that FAILED - do NOT repeat this approach"
    )
    failure_reason: str = dspy.InputField(
        desc="Why it failed (e.g. wrong row count)"
    )

    # OUTPUTS
    optimized_query: str = dspy.OutputField(
        desc="A DIFFERENT optimization using a different strategy. If unsure, return the original query unchanged."
    )
    optimization_rationale: str = dspy.OutputField(
        desc="What different approach you tried"
    )

# NOTES:
# - Used after initial optimization fails validation
# - Explicitly told what NOT to do (previous_attempt)
# - Can return original query if no safe alternative found
