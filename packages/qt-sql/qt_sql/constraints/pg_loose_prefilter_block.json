{
  "id": "PG_LOOSE_PREFILTER_BLOCK",
  "severity": "MEDIUM",
  "description": "Do not pre-filter a fact table into a CTE with a UNION/OR superset filter when the actual WHERE clause has correlated conditions. However, a fact table CTE with a simple range filter IS beneficial when the query has expensive non-equi joins (quantity comparisons, date arithmetic) that dominate cost.",
  "failure_rate": "1/2 queries: 1 regression (0.79x), 1 win (2.68x)",
  "observed_failures": [
    {
      "query": "DSB Q013_agg",
      "speedup": "0.79x",
      "original": "store_sales joined with 5 dims, correlated OR predicates on price/profit ranges",
      "rewrite": "filtered_ss CTE with union of all price/profit ranges (loose filter), then join dims",
      "problem": "Loose CTE filter is a superset of correlated OR conditions. CTE fence blocks dimension predicate pushdown."
    }
  ],
  "observed_wins": [
    {
      "query": "DSB Q072_agg",
      "speedup": "2.68x",
      "original": "catalog_sales joined with inventory (non-equi: inv_quantity < cs_quantity), 3x date_dim, item, cd, hd",
      "rewrite": "MATERIALIZED CTEs for all dims + fact table (cs_wholesale_cost BETWEEN 34 AND 54)",
      "why_it_worked": "Non-equi joins (quantity comparison, week_seq correlation) dominate cost. Reducing fact table by ~70% before these joins shrinks the search space. The CTE fence cost is negligible vs the non-equi join savings."
    }
  ],
  "constraint_rules": [
    {
      "rule": "NO_FACT_CTE_WITH_CORRELATED_OR",
      "description": "Do not pre-filter fact tables into CTEs when the WHERE clause has correlated OR conditions",
      "rationale": "OR conditions create complex predicate interactions that the optimizer handles better inline. A union of all OR branches is a superset that materializes too many rows."
    },
    {
      "rule": "FACT_CTE_OK_WITH_NON_EQUI_JOINS",
      "description": "A fact table CTE with a simple range filter IS beneficial when the query has expensive non-equi joins (e.g., quantity < quantity, date arithmetic comparisons)",
      "rationale": "Non-equi joins cannot use hash/merge join efficiently. Reducing input size before these joins has outsized impact. The CTE fence cost is negligible compared to non-equi join savings."
    }
  ],
  "prompt_instruction": "POSTGRESQL RULE: Do NOT pre-filter fact tables into CTEs when the WHERE has correlated OR conditions (the union/superset filter materializes too many rows, 0.79x regression). BUT DO pre-filter fact tables when the query has expensive non-equi joins (quantity comparisons, date arithmetic) - reducing the fact table before these joins is highly effective (2.68x win on Q072).",
  "dialect": "postgresql"
}
