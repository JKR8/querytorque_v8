{
  "id": "REMOVE_REPLACED_CTES",
  "severity": "HIGH",
  "description": "When creating replacement CTEs, always remove the original CTEs from the WITH clause. Leaving dead/unused CTEs causes unnecessary materialization overhead.",
  "failure_rate": "Contributed to 0.49x and 0.68x regressions",
  "observed_failures": [
    {
      "query": "Q31",
      "regression": "0.49x (99ms -> 201ms)",
      "problem": "Created new store_sales_agg and web_sales_agg CTEs but left the original ss and ws CTEs in the WITH clause. Both old and new CTEs coexist, wasting materialization.",
      "type": "DEAD_CTE_OVERHEAD"
    },
    {
      "query": "Q74",
      "regression": "0.68x (493ms -> 724ms)",
      "problem": "Created 4 new year-specific CTEs but left the original year_total, year_total_store, year_total_web CTEs. Total of 8 CTEs instead of 4.",
      "type": "DEAD_CTE_OVERHEAD"
    }
  ],
  "constraint_rules": [
    {
      "rule": "REPLACE_NOT_APPEND",
      "description": "When your rewrite replaces a CTE with a new version, the original CTE node must be removed or overwritten. Do not define both the old and new CTE."
    }
  ],
  "prompt_instruction": "When creating replacement CTEs, overwrite the original by using the same node_id in your rewrite_sets, or ensure the original is removed from the WITH clause. Every CTE in the final query should be actively used \u2014 dead CTEs still get materialized and waste resources (caused 0.49x on Q31, 0.68x on Q74)."
}
