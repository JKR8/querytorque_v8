{
  "id": "PG_OR_TO_UNION_BLOCK",
  "severity": "CRITICAL",
  "description": "Avoid or_to_union on PostgreSQL when OR branches share the same fact table joins. PostgreSQL often handles OR via BitmapOr index scans in a single pass, while UNION ALL can force separate fact-table scans.",
  "failure_rate": "2/2 queries regressed severely (0.21x-0.26x)",
  "observed_failures": [
    {
      "query": "DSB Q085_agg",
      "speedup": "0.21x",
      "original": "7-table join with 2 nested OR blocks (demographics + geography)",
      "rewrite": "3 UNION ALL branches, each repeating the full 7-table join",
      "problem": "3x scans of web_sales + web_returns fact tables. Original did 1 scan with BitmapOr."
    },
    {
      "query": "DSB Q091_spj_spj",
      "speedup": "0.26x",
      "original": "7-table join with 2-branch OR on demographics",
      "rewrite": "7 CTEs + 2 branch data CTEs + UNION ALL",
      "problem": "Over-decomposed into 7+ CTEs. Doubled catalog_returns scan. CTE materialization overhead."
    }
  ],
  "constraint_rules": [
    {
      "rule": "BLOCK_ON_POSTGRESQL",
      "description": "Default block: do not use or_to_union on PostgreSQL without explicit EXPLAIN evidence",
      "rationale": "PostgreSQL BitmapOr often handles OR predicates in a single scan. Use OR\u2192UNION only when EXPLAIN evidence shows OR blocks index usage and UNION branches become index scans."
    },
    {
      "rule": "SHARED_FACT_TABLE_CHECK",
      "description": "If all OR branches scan the same fact table with same joins, never split to UNION",
      "rationale": "The only valid case for OR\u2192UNION is when branches reference different tables or indexes."
    }
  ],
  "when_or_to_union_helps_on_pg": [
    "When OR branches reference different tables or different indexes and EXPLAIN confirms indexable UNION branches",
    "When baseline OR path forces sequential scans and UNION enables index scans per branch"
  ],
  "when_or_to_union_hurts_on_pg": [
    "Always when branches share the same fact table (web_sales, store_sales, catalog_sales)",
    "Always when OR is on filter predicates (demographics, geography)",
    "Always when combined with CTE over-decomposition"
  ],
  "prompt_instruction": "POSTGRESQL RULE: Avoid OR\u2192UNION by default. PostgreSQL often handles OR conditions efficiently via BitmapOr index scans in a single pass. Only use OR\u2192UNION when EXPLAIN evidence shows OR blocks index usage and UNION branches become index scans. Otherwise keep the original OR structure.",
  "dialect": "postgresql"
}
