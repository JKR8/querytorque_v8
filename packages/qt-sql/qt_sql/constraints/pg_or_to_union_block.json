{
  "id": "PG_OR_TO_UNION_BLOCK",
  "severity": "CRITICAL",
  "description": "NEVER apply or_to_union on PostgreSQL when OR branches share the same fact table joins. PostgreSQL handles OR via BitmapOr index scans in a single pass. UNION ALL forces N separate fact table scans.",
  "failure_rate": "2/2 queries regressed severely (0.21x-0.26x)",
  "observed_failures": [
    {
      "query": "DSB Q085_agg",
      "speedup": "0.21x",
      "original": "7-table join with 2 nested OR blocks (demographics + geography)",
      "rewrite": "3 UNION ALL branches, each repeating the full 7-table join",
      "problem": "3x scans of web_sales + web_returns fact tables. Original did 1 scan with BitmapOr."
    },
    {
      "query": "DSB Q091_spj_spj",
      "speedup": "0.26x",
      "original": "7-table join with 2-branch OR on demographics",
      "rewrite": "7 CTEs + 2 branch data CTEs + UNION ALL",
      "problem": "Over-decomposed into 7+ CTEs. Doubled catalog_returns scan. CTE materialization overhead."
    }
  ],
  "constraint_rules": [
    {
      "rule": "BLOCK_ON_POSTGRESQL",
      "description": "Do not use or_to_union transform on PostgreSQL databases",
      "rationale": "PostgreSQL BitmapOr handles OR predicates in a single scan. UNION ALL always causes multi-scan regression."
    },
    {
      "rule": "SHARED_FACT_TABLE_CHECK",
      "description": "If all OR branches scan the same fact table with same joins, never split to UNION",
      "rationale": "The only valid case for OR\u2192UNION is when branches reference different tables or indexes."
    }
  ],
  "when_or_to_union_helps_on_pg": [
    "Almost never on PostgreSQL",
    "Only when OR branches reference completely different tables"
  ],
  "when_or_to_union_hurts_on_pg": [
    "Always when branches share the same fact table (web_sales, store_sales, catalog_sales)",
    "Always when OR is on filter predicates (demographics, geography)",
    "Always when combined with CTE over-decomposition"
  ],
  "prompt_instruction": "POSTGRESQL RULE: NEVER use OR\u2192UNION on PostgreSQL. PostgreSQL handles OR conditions efficiently via BitmapOr index scans in a single pass. Converting OR to UNION ALL forces multiple scans of fact tables and causes catastrophic regressions (0.21x-0.26x observed on DSB benchmark). Keep the original OR structure.",
  "dialect": "postgresql"
}
