{
  "id": "PREFETCH_MULTI_FACT_CHAIN",
  "severity": "MEDIUM",
  "overridable": true,
  "description": "Prefer limiting cascading fact-table CTEs to 2. Each additional CTE materializes a large intermediate result.",
  "observed_failures": [
    {
      "query": "Q4",
      "regression": "0.78x",
      "problem": "3 cascading fact-table CTEs (store_sales -> catalog_sales -> web_sales) created excessive intermediate materialization.",
      "type": "FACT_CHAIN_OVERHEAD"
    }
  ],
  "constraint_rules": [
    {
      "rule": "PREFER_2_OR_FEWER_FACT_CTES",
      "description": "When pre-joining fact tables with filtered dimensions in CTEs, 2 cascading fact CTEs is safe. A third adds risk of excessive materialization."
    }
  ],
  "override_conditions": [
    "Each fact CTE has highly selective filters (<5% of rows survive), keeping intermediate sizes small",
    "The 3rd CTE reads from a dimension-filtered result, not a raw fact table",
    "The query already has 3+ separate fact table scans in baseline \u2014 chaining cannot be worse"
  ],
  "prompt_instruction": "DEFAULT: Limit to 2 cascading fact-table CTEs. A 3rd CTE caused 0.78x on Q4 from excessive materialization. HOWEVER: if each CTE applies highly selective filters (<5% row survival), the intermediate results stay small. The exploration worker MAY try a 3-CTE chain if filters are selective and baseline already has 3+ separate scans."
}
