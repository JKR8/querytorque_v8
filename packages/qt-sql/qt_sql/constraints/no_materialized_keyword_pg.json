{
  "id": "NO_MATERIALIZED_KEYWORD_PG",
  "severity": "HIGH",
  "description": "On PostgreSQL, do not add the AS MATERIALIZED keyword to CTEs unless a gold example explicitly uses it. PG 12+ already materializes CTEs referenced more than once. Adding AS MATERIALIZED on small CTEs prevents the optimizer from inlining them, adding temp-table I/O overhead.",
  "failure_rate": "Caused 0.69x regression on Q080",
  "observed_failures": [
    {
      "query": "Q080_multi",
      "regression": "0.69x (57ms -> 83ms)",
      "broken_rewrite": "filtered_date AS MATERIALIZED (SELECT d_date_sk FROM date_dim WHERE ...)",
      "problem": "MATERIALIZED keyword forced temp-table spill for tiny CTEs (30 rows), adding overhead that exceeded filtering benefit.",
      "type": "UNNECESSARY_MATERIALIZATION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "NO_EXPLICIT_MATERIALIZED",
      "description": "Do not add the AS MATERIALIZED keyword. Write plain CTEs: 'name AS (SELECT ...)'. PostgreSQL will materialize them automatically when beneficial."
    }
  ],
  "prompt_instruction": "Do NOT use the AS MATERIALIZED keyword on CTEs. Write plain CTEs: 'name AS (SELECT ...)'. PostgreSQL automatically materializes CTEs when beneficial. Forcing materialization on small dimension CTEs (< 1000 rows) adds temp-table I/O overhead that causes regressions (0.69x observed). The proven gold examples use plain CTEs without MATERIALIZED.",
  "dialect": "postgresql"
}
