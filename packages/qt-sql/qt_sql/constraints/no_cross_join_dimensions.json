{
  "id": "NO_CROSS_JOIN_DIMENSIONS",
  "severity": "HIGH",
  "overridable": true,
  "description": "Avoid CROSS JOINing dimension tables into a single CTE. The Cartesian product can explode row counts and prevent index use on fact tables.",
  "failure_rate": "Caused 0.0076x regression on Q080 (132x slower) when 3 dimensions were cross-joined",
  "observed_failures": [
    {
      "query": "Q080_multi",
      "regression": "0.0076x (57ms -> 7500ms)",
      "broken_rewrite": "filtered_dims AS (SELECT d_date_sk, i_item_sk, p_promo_sk FROM date_dim CROSS JOIN item CROSS JOIN promotion WHERE ...)",
      "problem": "CROSS JOIN created 120K-row CTE (30 \u00d7 200 \u00d7 20), then 3-key join prevented index use on fact tables.",
      "type": "CROSS_JOIN_DIMENSION_EXPLOSION"
    }
  ],
  "constraint_rules": [
    {
      "rule": "PREFER_SEPARATE_DIMENSION_CTES",
      "description": "Each dimension table should generally be its own CTE with its own filter. Combining via CROSS JOIN risks Cartesian explosion."
    }
  ],
  "override_conditions": [
    "Only 2 dimensions are joined (not 3+) AND the product is <1000 rows",
    "The dimensions share a foreign key (not a true Cartesian \u2014 it's a filtered JOIN)",
    "The combined CTE replaces N separate semi-joins with 1 multi-key join on the fact table"
  ],
  "prompt_instruction": "DEFAULT: Keep each dimension as a SEPARATE CTE (filtered_date, filtered_item, etc.). Cross-joining 3 dimensions caused 0.0076x on Q080 (30\u00d7200\u00d720 = 120K rows). HOWEVER: joining exactly 2 small dimensions (<1000 row product) via a foreign key (not Cartesian) may be acceptable if it reduces total join count on the fact table. The exploration worker MAY attempt a 2-dimension join with size estimate. Never cross-join 3+ dimensions."
}
