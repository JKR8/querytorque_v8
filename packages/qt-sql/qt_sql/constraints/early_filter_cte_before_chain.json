{
  "id": "EARLY_FILTER_CTE_BEFORE_CHAIN",
  "severity": "MEDIUM",
  "description": "Early filter CTEs must be referenced by the main query chain. An orphaned CTE that pre-filters data but is never joined back into the main query wastes materialization effort.",
  "observed_failures": [
    {
      "query": "multiple",
      "problem": "Early filter CTEs were created but not referenced in subsequent JOINs, resulting in wasted CTE materialization plus the original unfiltered joins remaining.",
      "type": "ORPHANED_FILTER_CTE"
    }
  ],
  "constraint_rules": [
    {
      "rule": "FILTER_CTE_MUST_BE_REFERENCED",
      "description": "Every early_filter CTE must be referenced by at least one downstream CTE or the main query. If a filter CTE is created, the original unfiltered table reference must be replaced with the CTE reference."
    }
  ],
  "prompt_instruction": "When creating an early_filter CTE, ensure it is actually referenced in the main query chain. The original unfiltered table reference must be replaced with the CTE reference. Do not create CTEs that filter a table if the main query still joins the original unfiltered table \u2014 this adds overhead without benefit."
}
