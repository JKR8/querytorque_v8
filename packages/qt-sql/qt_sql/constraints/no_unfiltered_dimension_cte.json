{
  "id": "NO_UNFILTERED_DIMENSION_CTE",
  "severity": "HIGH",
  "description": "Never create a 'filtered' dimension CTE that has no WHERE clause. A CTE that selects all rows from a dimension table is pure materialization overhead with zero filtering benefit.",
  "failure_rate": "Caused 0.85x regression on Q67",
  "observed_failures": [
    {
      "query": "Q67",
      "regression": "0.85x (4509ms -> 5291ms)",
      "broken_rewrite": "filtered_stores AS (SELECT s_store_sk, s_store_id FROM store), filtered_items AS (SELECT i_item_sk, i_category, i_class, i_brand, i_product_name FROM item)",
      "problem": "Both CTEs select ALL rows - no WHERE clause, no filtering. Pure overhead.",
      "type": "UNFILTERED_DIMENSION_CTE"
    }
  ],
  "constraint_rules": [
    {
      "rule": "CTE_MUST_FILTER",
      "description": "Every dimension CTE you create MUST have a WHERE clause that reduces the row count. If a dimension table has no filter to apply, do NOT extract it into a CTE."
    },
    {
      "rule": "COLUMN_PROJECTION_IS_NOT_FILTERING",
      "description": "Selecting a subset of columns (SELECT a, b FROM table) is NOT filtering. The CTE still materializes all rows. Only a WHERE clause reduces rows."
    }
  ],
  "prompt_instruction": "Every CTE you create must include a WHERE clause that actually reduces row count. Selecting fewer columns is not filtering \u2014 the CTE still materializes every row. If a dimension table has no predicate to push down, leave it as a direct join in the main query instead of wrapping it in a CTE."
}
