<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PostgreSQL DSB Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #fff; --bg2: #f8fafc; --bg3: #f1f5f9; --brd: #e2e8f0; --brd2: #cbd5e1;
  --t1: #0f172a; --t2: #475569; --t3: #94a3b8;
  --grn: #16a34a; --grn2: #dcfce7;
  --red: #dc2626; --red2: #fef2f2;
  --amb: #d97706; --amb2: #fffbeb;
  --blu: #2563eb; --blu2: #eff6ff;
  --pur: #7c3aed; --pur2: #f5f3ff;
  --mono: 'DM Mono', monospace;
  --sans: 'DM Sans', -apple-system, system-ui, sans-serif;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: var(--sans); background: var(--bg); color: var(--t1);
  padding: 32px 40px; line-height: 1.6; -webkit-font-smoothing: antialiased;
}
::selection { background: #dbeafe; }

h1 {
  font-size: 28px; font-weight: 700; letter-spacing: -.03em;
  color: var(--t1); margin-bottom: 2px;
}
.subtitle {
  font-size: 15px; color: var(--t2); margin-bottom: 28px;
}
.subtitle span { font-family: var(--mono); font-size: 13px; color: var(--t3); }

/* --- tabs --- */
.tabs {
  display: flex; gap: 0; margin-bottom: 28px; border-bottom: 2px solid var(--brd);
}
.tab {
  padding: 10px 20px; font-family: var(--mono); font-size: 13px;
  letter-spacing: .04em; text-transform: uppercase; color: var(--t3);
  cursor: pointer; border-bottom: 2px solid transparent;
  margin-bottom: -2px; transition: color .15s, border-color .15s;
  user-select: none;
}
.tab:hover { color: var(--t2); }
.tab.active { color: var(--t1); border-bottom-color: var(--blu); font-weight: 500; }

/* --- summary cards --- */
.summary { display: flex; gap: 12px; margin-bottom: 28px; flex-wrap: wrap; }
.stat {
  background: var(--bg); border: 1px solid var(--brd); border-radius: 10px;
  padding: 16px 22px; min-width: 120px; transition: border-color .2s, box-shadow .2s;
}
.stat:hover { border-color: var(--brd2); box-shadow: 0 1px 6px rgba(0,0,0,.025); }
.stat .label {
  font-size: 11px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .1em; text-transform: uppercase; display: block;
}
.stat .value { font-size: 28px; font-weight: 700; margin-top: 4px; display: block; }
.stat.win .value { color: var(--grn); }
.stat.improved .value { color: var(--blu); }
.stat.neutral .value { color: var(--t3); }
.stat.regression .value { color: var(--red); }
.stat.error .value { color: var(--amb); }
.stat.avg .value { color: var(--t1); }
.stat.cfg .value { color: var(--pur); }

/* --- filters --- */
.filters {
  margin-bottom: 20px; display: flex; gap: 10px;
  flex-wrap: wrap; align-items: center;
}
.filters label {
  font-size: 13px; font-family: var(--mono); color: var(--t3);
  letter-spacing: .04em; text-transform: uppercase;
}
.filters select, .filters input {
  font-family: var(--sans); font-size: 14px; color: var(--t1);
  background: var(--bg); border: 1px solid var(--brd); border-radius: 6px;
  padding: 6px 12px; outline: none; transition: border-color .15s;
}
.filters select:focus, .filters input:focus {
  border-color: var(--brd2); box-shadow: 0 0 0 3px rgba(148,163,184,.06);
}
.filters input::placeholder { color: var(--t3); }

/* --- table --- */
.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 14px; }
th {
  background: var(--bg2); color: var(--t3); text-align: left;
  padding: 10px 12px; border-bottom: 2px solid var(--brd);
  font-size: 11px; font-family: var(--mono); letter-spacing: .08em;
  text-transform: uppercase; cursor: pointer; user-select: none; white-space: nowrap;
}
th:hover { color: var(--t1); }
th .arrow { font-size: 9px; margin-left: 4px; }
td { padding: 10px 12px; border-bottom: 1px solid var(--brd); white-space: nowrap; }
tr:hover td { background: var(--bg2); }
tbody tr { transition: background .1s; }

.status-WIN { color: var(--grn); font-weight: 600; }
.status-IMPROVED { color: var(--blu); }
.status-NEUTRAL { color: var(--t3); }
.status-REGRESSION { color: var(--red); }
.status-error, .status-parse_error, .status-wrong_results, .status-ERROR, .status-PARSE_ERROR, .status-WRONG_RESULTS, .status-FAIL, .status-fail { color: var(--amb); }

.speedup { font-weight: 600; font-variant-numeric: tabular-nums; font-family: var(--mono); }
.speedup-high { color: var(--grn); }
.speedup-mid { color: var(--blu); }
.speedup-low { color: var(--t2); }
.speedup-reg { color: var(--red); }

.ms { font-variant-numeric: tabular-nums; font-family: var(--mono); color: var(--t2); }
.transform { color: #7c3aed; font-family: var(--mono); font-size: 12px; }
.source { color: var(--t3); font-size: 13px; }
.source-analyst {
  color: #7c3aed; font-weight: 600; font-family: var(--mono); font-size: 13px;
}
.rows-yes { color: var(--grn); }
.rows-no { color: var(--red); font-weight: 700; }
.num { text-align: right; }

/* --- config-specific --- */
.cfg-status { font-family: var(--mono); font-size: 12px; font-weight: 500; }
.cfg-CONFIG_WIN { color: var(--grn); }
.cfg-CONFIG_IMPROVED { color: var(--blu); }
.cfg-CONFIG_NEUTRAL { color: var(--t3); }
.cfg-CONFIG_REGRESSION { color: var(--red); }
.cfg-NO_BOTTLENECK { color: var(--t3); font-style: italic; }
.cfg-ERROR { color: var(--amb); }

.cfg-params { font-family: var(--mono); font-size: 11px; color: var(--t2); max-width: 220px; white-space: normal; line-height: 1.4; }
.cfg-rules { font-family: var(--mono); font-size: 11px; color: var(--pur); }

.best-variant { font-family: var(--mono); font-size: 12px; font-weight: 600; }
.best-rewrite-config { color: var(--pur); }
.best-rewrite { color: var(--blu); }
.best-original { color: var(--t3); }

.additive { font-family: var(--mono); font-variant-numeric: tabular-nums; }
.additive-high { color: var(--grn); font-weight: 600; }
.additive-mid { color: var(--blu); }
.additive-low { color: var(--t3); }
.additive-reg { color: var(--red); }

/* --- detail row --- */
.detail-row td { background: var(--bg3); padding: 12px 14px; border-bottom: 2px solid var(--brd); }
.detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 8px 24px; }
.detail-grid .d-label { font-size: 11px; font-family: var(--mono); color: var(--t3); text-transform: uppercase; letter-spacing: .05em; }
.detail-grid .d-value { font-size: 14px; font-family: var(--mono); color: var(--t1); }

#updated {
  font-size: 12px; font-family: var(--mono); color: var(--t3);
  margin-top: 20px; letter-spacing: .02em;
}

@media (max-width: 768px) {
  body { padding: 20px 16px; }
  h1 { font-size: 22px; }
  table { font-size: 12px; }
  th, td { padding: 8px 6px; }
  .stat { min-width: 90px; padding: 12px 14px; }
  .stat .value { font-size: 22px; }
}
</style>
</head>
<body>

<h1>PostgreSQL DSB SF10 Leaderboard</h1>
<div class="subtitle" id="subtitle">Loading...</div>

<div class="tabs" id="tabs">
  <div class="tab active" data-view="rewrite">SQL Rewrite</div>
  <div class="tab" data-view="config">Config Tuning</div>
  <div class="tab" data-view="combined">Combined View</div>
</div>

<div class="summary" id="summary"></div>

<div class="filters">
  <label>Status</label>
  <select id="statusFilter">
    <option value="all">All</option>
    <option value="WIN">WIN</option>
    <option value="IMPROVED">IMPROVED</option>
    <option value="NEUTRAL">NEUTRAL</option>
    <option value="REGRESSION">REGRESSION</option>
    <option value="error">ERROR</option>
  </select>
  <label id="cfgFilterLabel" style="display:none">Config</label>
  <select id="cfgFilter" style="display:none">
    <option value="all">All</option>
    <option value="CONFIG_WIN">CONFIG_WIN</option>
    <option value="CONFIG_IMPROVED">CONFIG_IMPROVED</option>
    <option value="CONFIG_NEUTRAL">CONFIG_NEUTRAL</option>
    <option value="CONFIG_REGRESSION">CONFIG_REGRESSION</option>
    <option value="NO_BOTTLENECK">NO_BOTTLENECK</option>
  </select>
  <label>Runtime</label>
  <select id="runtimeFilter">
    <option value="0">Any</option>
    <option value="100">100ms+</option>
    <option value="500">500ms+</option>
    <option value="1000">1s+</option>
  </select>
  <label>Search</label>
  <input type="text" id="search" placeholder="query, transform, config rule..." size="24">
</div>

<div class="table-wrap">
<table>
  <thead id="thead">
  </thead>
  <tbody id="tbody"></tbody>
</table>
</div>

<div id="updated"></div>

<script>
let DATA = null;
let sortCol = 'speedup';
let sortAsc = false;
let currentView = 'rewrite';
let expandedRow = null;

const HEADERS = {
  rewrite: [
    { col: 'rank', label: '#', cls: '' },
    { col: 'query_id', label: 'Query', cls: '' },
    { col: 'status', label: 'Status', cls: '' },
    { col: 'speedup', label: 'Speedup', cls: 'num' },
    { col: 'original_ms', label: 'Orig (ms)', cls: 'num' },
    { col: 'optimized_ms', label: 'Opt (ms)', cls: 'num' },
    { col: 'rows_match', label: 'Rows', cls: '' },
    { col: 'transforms', label: 'Transform', cls: '' },
    { col: 'source', label: 'Source', cls: '' },
  ],
  config: [
    { col: 'rank', label: '#', cls: '' },
    { col: 'query_id', label: 'Query', cls: '' },
    { col: 'config_status', label: 'Config Status', cls: '' },
    { col: 'config_additive', label: 'Additive', cls: 'num' },
    { col: 'config_ms', label: 'Config (ms)', cls: 'num' },
    { col: 'config_rewrite_ms', label: 'Rewrite (ms)', cls: 'num' },
    { col: 'config_original_ms', label: 'Orig (ms)', cls: 'num' },
    { col: 'config_rules', label: 'Rules', cls: '' },
    { col: 'config_params', label: 'SET LOCAL Params', cls: '' },
    { col: 'config_best_variant', label: 'Best', cls: '' },
  ],
  combined: [
    { col: 'rank', label: '#', cls: '' },
    { col: 'query_id', label: 'Query', cls: '' },
    { col: 'status', label: 'Rewrite', cls: '' },
    { col: 'speedup', label: 'Rw Spd', cls: 'num' },
    { col: 'config_status', label: 'Config', cls: '' },
    { col: 'config_additive', label: 'Additive', cls: 'num' },
    { col: 'config_speedup', label: 'Rw+Cfg Spd', cls: 'num' },
    { col: 'config_best_variant', label: 'Best', cls: '' },
    { col: 'original_ms', label: 'Orig (ms)', cls: 'num' },
    { col: 'transforms', label: 'Transform', cls: '' },
    { col: 'config_rules', label: 'Config Rules', cls: '' },
  ]
};

async function load() {
  /* Try sf10 first (has config data), fall back to base leaderboard */
  for (const file of ['leaderboard_sf10.json', 'leaderboard.json']) {
    try {
      const resp = await fetch(file, { cache: 'no-store' });
      if (!resp.ok) continue;
      DATA = await resp.json();
      if (DATA.config_summary) break;   /* prefer the one with config data */
    } catch (e) { continue; }
  }

  if (!DATA) {
    document.getElementById('subtitle').innerHTML = '<span style="color:var(--red)">Failed to load leaderboard JSON. Serve via local web server.</span>';
    return;
  }

  renderAll();
}

function renderAll() {
  renderSubtitle();
  renderSummary();
  renderHeaders();
  renderTable();
  renderUpdated();
}

function renderSubtitle() {
  const cs = DATA.config_summary;
  const cfgNote = cs ? ` &middot; <span>${cs.total_configured} config-tuned</span>` : '';
  document.getElementById('subtitle').innerHTML =
    `<span>${DATA.queries.length} queries</span> &middot; Engine: ${DATA.engine || 'postgresql'} &middot; SF${DATA.scale_factor || 10}${cfgNote} &middot; <span>PG 14.3</span>`;
}

function renderSummary() {
  const q = DATA.queries;
  const el = document.getElementById('summary');

  if (currentView === 'config') {
    const cs = DATA.config_summary || {};
    el.innerHTML = [
      mkStat('Config Win', cs.config_wins || 0, 'win'),
      mkStat('Improved', cs.config_improved || 0, 'improved'),
      mkStat('Neutral', cs.config_neutral || 0, 'neutral'),
      mkStat('Regression', cs.config_regression || 0, 'regression'),
      mkStat('Error', cs.config_errors || 0, 'error'),
      mkStat('No Bottleneck', q.filter(x => x.config_status === 'NO_BOTTLENECK').length, 'neutral'),
      mkStat('Avg Additive', (cs.avg_config_additive || 0).toFixed(2) + 'x', 'cfg'),
    ].join('');
  } else {
    const wins = q.filter(x => x.speedup >= 1.10 && !isError(x)).length;
    const improved = q.filter(x => x.speedup >= 1.05 && x.speedup < 1.10 && !isError(x)).length;
    const neutral = q.filter(x => x.speedup >= 0.95 && x.speedup < 1.05 && !isError(x)).length;
    const regression = q.filter(x => x.speedup > 0 && x.speedup < 0.95 && !isError(x)).length;
    const errors = q.filter(x => isError(x)).length;
    const validSpeeds = q.filter(x => x.speedup > 0 && !isError(x)).map(x => x.speedup);
    const avg = validSpeeds.length ? (validSpeeds.reduce((a,b)=>a+b,0)/validSpeeds.length) : 0;

    const cards = [
      mkStat('Wins', wins, 'win'),
      mkStat('Improved', improved, 'improved'),
      mkStat('Neutral', neutral, 'neutral'),
      mkStat('Regression', regression, 'regression'),
      mkStat('Error', errors, 'error'),
      mkStat('Avg Speedup', avg.toFixed(2) + 'x', 'avg'),
    ];

    if (currentView === 'combined' && DATA.config_summary) {
      const cs = DATA.config_summary;
      cards.push(mkStat('Cfg Wins', cs.config_wins || 0, 'cfg'));
      cards.push(mkStat('Avg Additive', (cs.avg_config_additive || 0).toFixed(2) + 'x', 'cfg'));
    }

    el.innerHTML = cards.join('');
  }
}

function mkStat(label, value, cls) {
  return `<div class="stat ${cls}"><span class="label">${label}</span><span class="value">${value}</span></div>`;
}

function isError(q) {
  const status = String(q.status || '').toUpperCase();
  return ['ERROR', 'PARSE_ERROR', 'WRONG_RESULTS', 'FAIL'].includes(status);
}

function qnum(qid) {
  const m = String(qid).match(/(\d+)/);
  return m ? parseInt(m[1], 10) : 9999;
}

function renderHeaders() {
  const headers = HEADERS[currentView];
  const tr = document.createElement('tr');
  headers.forEach(h => {
    const th = document.createElement('th');
    th.dataset.col = h.col;
    if (h.cls) th.className = h.cls;
    th.textContent = h.label;
    if (h.col === sortCol) {
      const span = document.createElement('span');
      span.className = 'arrow';
      span.textContent = sortAsc ? ' \u25B2' : ' \u25BC';
      th.appendChild(span);
    }
    th.addEventListener('click', () => {
      if (h.col === sortCol) sortAsc = !sortAsc;
      else { sortCol = h.col; sortAsc = false; }
      renderHeaders();
      renderTable();
    });
    tr.appendChild(th);
  });
  document.getElementById('thead').innerHTML = '';
  document.getElementById('thead').appendChild(tr);

  /* show/hide config filter */
  const showCfg = currentView !== 'rewrite';
  document.getElementById('cfgFilter').style.display = showCfg ? '' : 'none';
  document.getElementById('cfgFilterLabel').style.display = showCfg ? '' : 'none';
}

function getFiltered() {
  let q = [...DATA.queries];
  const sf = document.getElementById('statusFilter').value;
  const cf = document.getElementById('cfgFilter').value;
  const rf = parseInt(document.getElementById('runtimeFilter').value);
  const search = document.getElementById('search').value.toLowerCase().trim();

  if (sf !== 'all') {
    if (sf === 'error') q = q.filter(x => isError(x));
    else q = q.filter(x => x.status === sf);
  }
  if (cf !== 'all' && currentView !== 'rewrite') {
    q = q.filter(x => (x.config_status || 'NO_BOTTLENECK') === cf);
  }
  if (rf > 0) q = q.filter(x => (x.original_ms || 0) >= rf);
  if (search) q = q.filter(x =>
    x.query_id.toLowerCase().includes(search) ||
    (x.transforms || []).join(' ').toLowerCase().includes(search) ||
    (x.source || '').toLowerCase().includes(search) ||
    (x.config_rules || []).join(' ').toLowerCase().includes(search) ||
    formatParams(x.config_params).toLowerCase().includes(search)
  );
  return q;
}

function sortVal(q, col) {
  if (col === 'query_id' || col === 'rank') return qnum(q.query_id);
  if (col === 'transforms') return (q.transforms || []).join(',');
  if (col === 'config_rules') return (q.config_rules || []).join(',');
  if (col === 'config_params') return formatParams(q.config_params);
  if (col === 'config_best_variant') return q.config_best_variant || '';
  if (['source', 'status', 'config_status'].includes(col)) return q[col] || '';
  if (col === 'rows_match') return q.rows_match ? 1 : 0;
  return q[col] || 0;
}

function renderTable() {
  let q = getFiltered();

  q.sort((a, b) => {
    const va = sortVal(a, sortCol);
    const vb = sortVal(b, sortCol);
    if (typeof va === 'string') return sortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
    return sortAsc ? va - vb : vb - va;
  });

  expandedRow = null;
  const rows = q.map((r, i) => renderRow(r, i)).join('');
  document.getElementById('tbody').innerHTML = rows;

  /* click to expand detail */
  document.querySelectorAll('tr[data-qid]').forEach(tr => {
    tr.addEventListener('click', () => toggleDetail(tr));
  });
}

function renderRow(r, i) {
  if (currentView === 'rewrite') return renderRewriteRow(r, i);
  if (currentView === 'config') return renderConfigRow(r, i);
  return renderCombinedRow(r, i);
}

function renderRewriteRow(r, i) {
  const sp = r.speedup || 0;
  const spClass = sp >= 1.5 ? 'speedup-high' : sp >= 1.1 ? 'speedup-mid' : sp >= 0.95 ? 'speedup-low' : 'speedup-reg';
  const origMs = r.original_ms ? fmtMs(r.original_ms) : '\u2014';
  const optMs = r.optimized_ms ? fmtMs(r.optimized_ms) : '\u2014';
  const rowsClass = r.rows_match === true ? 'rows-yes' : r.rows_match === false ? 'rows-no' : '';
  const rowsText = r.rows_match === true ? '\u2713' : r.rows_match === false ? 'NO' : '\u2014';
  const transforms = (r.transforms || []).join(', ') || '\u2014';
  const srcClass = (r.source || '').includes('analyst') ? 'source-analyst' : 'source';

  return `<tr data-qid="${r.query_id}">
    <td class="num" style="color:var(--t3);font-size:13px">${i+1}</td>
    <td style="font-weight:600">${r.query_id}</td>
    <td class="status-${r.status}">${r.status}</td>
    <td class="num speedup ${spClass}">${sp > 0 ? fmtSpd(sp) : '\u2014'}</td>
    <td class="num ms">${origMs}</td>
    <td class="num ms">${optMs}</td>
    <td class="${rowsClass}" style="text-align:center">${rowsText}</td>
    <td class="transform">${transforms}</td>
    <td class="${srcClass}">${r.source || '\u2014'}</td>
  </tr>`;
}

function renderConfigRow(r, i) {
  const cs = r.config_status || 'NO_BOTTLENECK';
  const ca = r.config_additive;
  const caClass = !ca ? 'additive-low' : ca >= 1.1 ? 'additive-high' : ca >= 1.05 ? 'additive-mid' : ca < 0.95 ? 'additive-reg' : 'additive-low';
  const rules = (r.config_rules || []).join(', ') || '\u2014';
  const params = formatParams(r.config_params);
  const bv = r.config_best_variant || '\u2014';
  const bvClass = bv === 'rewrite+config' ? 'best-rewrite-config' : bv === 'rewrite' ? 'best-rewrite' : 'best-original';

  return `<tr data-qid="${r.query_id}">
    <td class="num" style="color:var(--t3);font-size:13px">${i+1}</td>
    <td style="font-weight:600">${r.query_id}</td>
    <td class="cfg-status cfg-${cs}">${cs.replace('CONFIG_','')}</td>
    <td class="num additive ${caClass}">${ca ? fmtSpd(ca) : '\u2014'}</td>
    <td class="num ms">${r.config_ms ? fmtMs(r.config_ms) : '\u2014'}</td>
    <td class="num ms">${r.config_rewrite_ms ? fmtMs(r.config_rewrite_ms) : '\u2014'}</td>
    <td class="num ms">${r.config_original_ms ? fmtMs(r.config_original_ms) : '\u2014'}</td>
    <td class="cfg-rules">${rules}</td>
    <td class="cfg-params">${params}</td>
    <td class="best-variant ${bvClass}">${fmtVariant(bv)}</td>
  </tr>`;
}

function renderCombinedRow(r, i) {
  const sp = r.speedup || 0;
  const spClass = sp >= 1.5 ? 'speedup-high' : sp >= 1.1 ? 'speedup-mid' : sp >= 0.95 ? 'speedup-low' : 'speedup-reg';
  const cs = r.config_status || 'NO_BOTTLENECK';
  const ca = r.config_additive;
  const caClass = !ca ? 'additive-low' : ca >= 1.1 ? 'additive-high' : ca >= 1.05 ? 'additive-mid' : ca < 0.95 ? 'additive-reg' : 'additive-low';
  const csp = r.config_speedup;
  const cspClass = !csp ? 'speedup-low' : csp >= 1.5 ? 'speedup-high' : csp >= 1.1 ? 'speedup-mid' : csp >= 0.95 ? 'speedup-low' : 'speedup-reg';
  const bv = r.config_best_variant || '\u2014';
  const bvClass = bv === 'rewrite+config' ? 'best-rewrite-config' : bv === 'rewrite' ? 'best-rewrite' : 'best-original';
  const transforms = (r.transforms || []).join(', ') || '\u2014';
  const rules = (r.config_rules || []).join(', ') || '\u2014';
  const origMs = r.original_ms ? fmtMs(r.original_ms) : '\u2014';

  return `<tr data-qid="${r.query_id}">
    <td class="num" style="color:var(--t3);font-size:13px">${i+1}</td>
    <td style="font-weight:600">${r.query_id}</td>
    <td class="status-${r.status}">${r.status}</td>
    <td class="num speedup ${spClass}">${sp > 0 ? fmtSpd(sp) : '\u2014'}</td>
    <td class="cfg-status cfg-${cs}">${cs.replace('CONFIG_','')}</td>
    <td class="num additive ${caClass}">${ca ? fmtSpd(ca) : '\u2014'}</td>
    <td class="num speedup ${cspClass}">${csp ? fmtSpd(csp) : '\u2014'}</td>
    <td class="best-variant ${bvClass}">${fmtVariant(bv)}</td>
    <td class="num ms">${origMs}</td>
    <td class="transform">${transforms}</td>
    <td class="cfg-rules">${rules}</td>
  </tr>`;
}

function toggleDetail(tr) {
  const qid = tr.dataset.qid;
  const existing = tr.nextElementSibling;
  if (existing && existing.classList.contains('detail-row')) {
    existing.remove();
    expandedRow = null;
    return;
  }
  /* remove any open detail */
  document.querySelectorAll('.detail-row').forEach(r => r.remove());

  const q = DATA.queries.find(x => x.query_id === qid);
  if (!q) return;
  expandedRow = qid;

  const detail = document.createElement('tr');
  detail.className = 'detail-row';
  const cols = HEADERS[currentView].length;
  const td = document.createElement('td');
  td.colSpan = cols;
  td.innerHTML = buildDetail(q);
  detail.appendChild(td);
  tr.after(detail);
}

function buildDetail(q) {
  const items = [];

  /* rewrite info */
  items.push(dItem('Query ID', q.query_id));
  items.push(dItem('Rewrite Status', q.status));
  items.push(dItem('Rewrite Speedup', q.speedup ? fmtSpd(q.speedup) : '\u2014'));
  items.push(dItem('Orig (ms)', q.original_ms ? fmtMs(q.original_ms) : '\u2014'));
  items.push(dItem('Opt (ms)', q.optimized_ms ? fmtMs(q.optimized_ms) : '\u2014'));
  items.push(dItem('Rows Match', q.rows_match === true ? 'Yes' : q.rows_match === false ? 'NO' : '\u2014'));
  items.push(dItem('Transforms', (q.transforms || []).join(', ') || '\u2014'));
  items.push(dItem('Source', q.source || '\u2014'));
  items.push(dItem('Worker', q.worker != null ? '#' + q.worker : '\u2014'));

  /* config info */
  if (q.config_status && q.config_status !== 'NO_BOTTLENECK') {
    items.push(dItem('Config Status', q.config_status));
    items.push(dItem('Config Additive', q.config_additive ? fmtSpd(q.config_additive) : '\u2014'));
    items.push(dItem('Config Speedup', q.config_speedup ? fmtSpd(q.config_speedup) : '\u2014'));
    items.push(dItem('Config (ms)', q.config_ms ? fmtMs(q.config_ms) : '\u2014'));
    items.push(dItem('Rewrite (ms) [cfg run]', q.config_rewrite_ms ? fmtMs(q.config_rewrite_ms) : '\u2014'));
    items.push(dItem('Orig (ms) [cfg run]', q.config_original_ms ? fmtMs(q.config_original_ms) : '\u2014'));
    items.push(dItem('Config Rules', (q.config_rules || []).join(', ')));
    items.push(dItem('SET LOCAL', formatParams(q.config_params)));
    items.push(dItem('Best Variant', q.config_best_variant || '\u2014'));
  } else if (q.config_status === 'NO_BOTTLENECK') {
    items.push(dItem('Config', 'No bottleneck detected in EXPLAIN'));
  }

  /* timing history */
  if (q.original_times) items.push(dItem('Orig Times', q.original_times.map(t => fmtMs(t)).join(', ')));
  if (q.optimized_times) items.push(dItem('Opt Times', q.optimized_times.map(t => fmtMs(t)).join(', ')));

  if (q.baseline_note) items.push(dItem('Note', q.baseline_note));

  return `<div class="detail-grid">${items.join('')}</div>`;
}

function dItem(label, value) {
  return `<div><div class="d-label">${label}</div><div class="d-value">${value}</div></div>`;
}

function formatParams(params) {
  if (!params || typeof params !== 'object') return '\u2014';
  const entries = Object.entries(params);
  if (!entries.length) return '\u2014';
  return entries.map(([k,v]) => `${k}=${v}`).join('; ');
}

function fmtMs(ms) {
  if (ms >= 100000) return (ms / 1000).toFixed(0) + 's';
  if (ms >= 10000) return (ms / 1000).toFixed(1) + 's';
  if (ms >= 1000) return (ms / 1000).toFixed(2) + 's';
  return ms.toFixed(0);
}

function fmtSpd(sp) {
  if (sp >= 100) return sp.toFixed(0) + 'x';
  if (sp >= 10) return sp.toFixed(1) + 'x';
  return sp.toFixed(2) + 'x';
}

function fmtVariant(bv) {
  if (bv === 'rewrite+config') return 'rw+cfg';
  if (bv === 'rewrite') return 'rewrite';
  if (bv === 'original') return 'orig';
  return bv;
}

function renderUpdated() {
  if (DATA.updated_at) {
    const dt = new Date(DATA.updated_at);
    const valid = !Number.isNaN(dt.getTime());
    document.getElementById('updated').textContent = valid
      ? 'Updated ' + dt.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric', hour:'2-digit', minute:'2-digit'})
      : 'Updated ' + DATA.updated_at;
  } else {
    document.getElementById('updated').textContent = '';
  }
}

/* Tab clicks */
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    currentView = tab.dataset.view;
    /* reset sort to sensible default per view */
    if (currentView === 'config') { sortCol = 'config_additive'; sortAsc = false; }
    else if (currentView === 'combined') { sortCol = 'config_speedup'; sortAsc = false; }
    else { sortCol = 'speedup'; sortAsc = false; }
    renderSummary();
    renderHeaders();
    renderTable();
  });
});

document.getElementById('statusFilter').addEventListener('change', renderTable);
document.getElementById('cfgFilter').addEventListener('change', renderTable);
document.getElementById('runtimeFilter').addEventListener('change', renderTable);
document.getElementById('search').addEventListener('input', renderTable);

load();
</script>
</body>
</html>
