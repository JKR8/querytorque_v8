{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering selective dimensions into CTEs before joining with WEB_SALES can reduce I/O by compounding selectivity early, especially given repeated scans of the large fact table.",
  "reasoning_trace": [
    "WEB_SALES is scanned twice at 461 GB each; reducing its scan size is critical.",
    "All dimension tables have selective filters that can be pushed into prefetch CTEs.",
    "Joining prefetched dimensions with the fact table preserves all original WHERE semantics."
  ],
  "target_ir": "Each selective dimension becomes a prefetched CTE; WEB_SALES joins these CTEs instead of raw dimension tables.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["web_sales_prefetch"],
        "outputs": ["order count", "total shipping cost", "total net profit"],
        "changed": true,
        "sql": "SELECT COUNT(DISTINCT ws_order_number) AS \"order count\", SUM(ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws_net_profit) AS \"total net profit\" FROM web_sales_prefetch"
      },
      {
        "node_id": "web_sales_prefetch",
        "parent_node_id": "final_select",
        "sources": ["web_sales_ws1", "date_dim_prefetch", "customer_address_prefetch", "web_site_prefetch"],
        "outputs": ["ws_order_number", "ws_ext_ship_cost", "ws_net_profit"],
        "changed": true,
        "sql": "SELECT ws1.ws_order_number, ws1.ws_ext_ship_cost, ws1.ws_net_profit FROM web_sales_ws1 ws1 JOIN date_dim_prefetch d ON ws1.ws_ship_date_sk = d.d_date_sk JOIN customer_address_prefetch ca ON ws1.ws_ship_addr_sk = ca.ca_address_sk JOIN web_site_prefetch web ON ws1.ws_web_site_sk = web.web_site_sk WHERE ws1.ws_list_price BETWEEN 253 AND 282 AND EXISTS (SELECT 1 FROM web_sales_ws2 ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT 1 FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (8, 18, 20, 23, 41))"
      },
      {
        "node_id": "web_sales_ws1",
        "parent_node_id": "web_sales_prefetch",
        "sources": ["web_sales"],
        "outputs": ["ws_ship_date_sk", "ws_ship_addr_sk", "ws_web_site_sk", "ws_warehouse_sk", "ws_order_number", "ws_list_price", "ws_ext_ship_cost", "ws_net_profit"],
        "changed": true,
        "sql": "SELECT ws_ship_date_sk, ws_ship_addr_sk, ws_web_site_sk, ws_warehouse_sk, ws_order_number, ws_list_price, ws_ext_ship_cost, ws_net_profit FROM web_sales"
      },
      {
        "node_id": "web_sales_ws2",
        "parent_node_id": "web_sales_prefetch",
        "sources": ["web_sales"],
        "outputs": ["ws_order_number", "ws_warehouse_sk"],
        "changed": true,
        "sql": "SELECT ws_order_number, ws_warehouse_sk FROM web_sales"
      },
      {
        "node_id": "date_dim_prefetch",
        "parent_node_id": "web_sales_prefetch",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1999-10-01' AND CAST('1999-10-01' AS DATE) + INTERVAL '60 DAY'"
      },
      {
        "node_id": "customer_address_prefetch",
        "parent_node_id": "web_sales_prefetch",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state FROM customer_address WHERE ca_state IN ('MO','MT','OK','SC','TX','WI')"
      },
      {
        "node_id": "web_site_prefetch",
        "parent_node_id": "web_sales_prefetch",
        "sources": ["web_site"],
        "outputs": ["web_site_sk", "web_gmt_offset"],
        "changed": true,
        "sql": "SELECT web_site_sk, web_gmt_offset FROM web_site WHERE web_gmt_offset >= -5"
      }
    ]
  }
}