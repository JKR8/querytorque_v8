{
  "probe_id": "p0",
  "transform_id": "prefetch_fact_join",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Building a staged CTE chain that filters dimensions early and joins them with fact tables can reduce scan volume and improve performance by pushing down predicates.",
  "reasoning_trace": [
    "Assigned transform targets building a CTE chain to filter dimensions early and join with fact tables.",
    "The original query has full scans on large fact tables due to lack of early filtering.",
    "Staged join pipeline allows better cardinality estimates and earlier row reduction."
  ],
  "target_ir": "CTE chain filters dimensions first, then joins with fact tables to reduce scan volume.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_facts"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": false
      },
      {
        "node_id": "filtered_facts",
        "parent_node_id": "final_select",
        "sources": ["dim_filtered", "store_sales", "store_returns", "web_sales"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "WITH dim_filtered AS (\n  SELECT \n    d1.d_date AS start_date,\n    d2.d_date AS end_date,\n    i_item_sk,\n    ca_address_sk,\n    hd_demo_sk\n  FROM date_dim d1\n  JOIN date_dim d2 ON d2.d_date BETWEEN d1.d_date AND DATEADD(day, 90, d1.d_date)\n  JOIN item ON i_category IN ('Children', 'Home', 'Women')\n  JOIN customer_address ON ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')\n  JOIN household_demographics ON hd_income_band_sk BETWEEN 8 AND 14 AND hd_buy_potential = '501-1000'\n  WHERE d1.d_year = 2000\n),\nss_filtered AS (\n  SELECT \n    ss_customer_sk,\n    ss_item_sk,\n    ss_ticket_number\n  FROM store_sales\n  JOIN dim_filtered df ON ss_item_sk = df.i_item_sk\n  WHERE (ss_sales_price / ss_list_price) BETWEEN 0.76 AND 0.96\n),\nsr_filtered AS (\n  SELECT \n    sr_item_sk,\n    sr_ticket_number,\n    sr_returned_date_sk\n  FROM store_returns\n  JOIN ss_filtered ss ON ss.ss_item_sk = sr_item_sk AND ss.ss_ticket_number = sr_ticket_number\n),\nws_filtered AS (\n  SELECT \n    ws_sold_date_sk,\n    ws_item_sk,\n    ws_bill_customer_sk\n  FROM web_sales\n  JOIN sr_filtered sr ON sr.sr_item_sk = ws_item_sk\n  JOIN dim_filtered df ON ws_sold_date_sk BETWEEN df.start_date AND df.end_date\n)\nSELECT \n  c.c_customer_sk,\n  c.c_first_name,\n  c.c_last_name,\n  COUNT(*) AS cnt\nFROM customer c\nJOIN ss_filtered ss ON c.c_customer_sk = ss.ss_customer_sk\nJOIN sr_filtered sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number\nJOIN ws_filtered ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk\nJOIN dim_filtered df ON sr.sr_returned_date_sk = df.d1_date_sk\nGROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name\nORDER BY cnt"
      }
    ]
  }
}