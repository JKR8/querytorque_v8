{
  "iteration": 0,
  "n_api_calls": 13,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 13,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 1.25,
  "best_patch_id": "p01",
  "best_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) select  sum(sales)\n from (select cs_quantity*cs_list_price sales\n       from catalog_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and cs_sold_date_sk = d_date_sk\n         and cs_item_sk in (select item_sk from frequent_ss_items)\n         and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and cs_wholesale_cost BETWEEN 26 AND 36\n         and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1999 and d_moy=5) and (select max(d_date_sk) from date_dim where d_year=1999 and d_moy=5)\n      union all\n      select ws_quantity*ws_list_price sales\n       from web_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and ws_sold_date_sk = d_date_sk\n         and ws_item_sk in (select item_sk from frequent_ss_items)\n         and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and ws_wholesale_cost BETWEEN 26 AND 36\n         and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1999 and d_moy=5) and (select max(d_date_sk) from date_dim where d_year=1999 and d_moy=5)) tmp2\n limit 100;",
  "patches": [
    {
      "patch_id": "p07",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Extract shared date_dim filter (d_year=1999, d_moy=5) into CTE for both catalog_sales and web_sales union branches."
    },
    {
      "patch_id": "p11",
      "family": "B",
      "transform": "sf_shared_scan_decorrelate",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Alternative decorrelation using shared scan: create CTE with store_sales aggregates needed for both max_store_sales and best_ss_customer."
    },
    {
      "patch_id": "p09",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.4,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (with filtered_dates as (select d_date_sk from date_dim where d_year = 1999),\nitem_filtered as (select i_item_sk, substring(i_item_desc,1,30) as itemdesc from item where i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men','Music','Sports'))\nselect f.itemdesc, f.i_item_sk item_sk, d.d_date solddate, count(*) cnt\nfrom store_sales ss\njoin filtered_dates fd on ss.ss_sold_date_sk = fd.d_date_sk\njoin item_filtered f on ss.ss_item_sk = f.i_item_sk\ngroup by f.itemdesc, f.i_item_sk, d.d_date\nhaving count(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Stage join pipeline: filter date_dim first, join with store_sales to reduce rows early, then join with item/customer."
    },
    {
      "patch_id": "p05",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.7,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH store_sales_early_agg AS (SELECT ss_item_sk, ss_sold_date_sk, COUNT(*) AS ss_count FROM store_sales GROUP BY ss_item_sk, ss_sold_date_sk), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales_early_agg ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate store_sales by ss_item_sk, ss_sold_date_sk before joining with item and date_dim in frequent_ss_items CTE."
    },
    {
      "patch_id": "p06",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "with filtered_date_dim as (select d_date_sk, d_date, d_year, d_moy from date_dim where d_year = 1999) , frequent_ss_items as (select substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt from store_sales ,filtered_date_dim ,item where ss_sold_date_sk = d_date_sk and ss_item_sk = i_item_sk and d_year = 1999 and i_manager_id BETWEEN 44 and 63 AND i_category IN ('Men', 'Music', 'Sports') group by substring(i_item_desc,1,30),i_item_sk,d_date having count(*) >4), max_store_sales as (select max(csales) tpcds_cmax from (select c_customer_sk,sum(ss_quantity*ss_sales_price) csales from store_sales ,customer ,filtered_date_dim where ss_customer_sk = c_customer_sk and ss_sold_date_sk = d_date_sk and d_year = 1999 and ss_wholesale_cost BETWEEN 26 AND 36 group by c_customer_sk) tmp1), best_ss_customer as (select c_customer_sk,sum(ss_quantity*ss_sales_price) ssales from store_sales ,customer ,filtered_date_dim where ss_customer_sk = c_customer_sk and c_birth_year BETWEEN 1987 AND 1993 and d_year = 1999 group by c_customer_sk having sum(ss_quantity*ss_sales_price) > (95/100.0) * (select * from max_store_sales)) select sum(sales) from (select cs_quantity*cs_list_price sales from catalog_sales ,filtered_date_dim where d_year = 1999 and d_moy = 5 and cs_sold_date_sk = d_date_sk and cs_item_sk in (select item_sk from frequent_ss_items) and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer) and cs_wholesale_cost BETWEEN 26 AND 36 union all select ws_quantity*ws_list_price sales from web_sales ,filtered_date_dim where d_year = 1999 and d_moy = 5 and ws_sold_date_sk = d_date_sk and ws_item_sk in (select item_sk from frequent_ss_items) and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer) and ws_wholesale_cost BETWEEN 26 AND 36) tmp2 limit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered date_dim (d_year=1999) as CTE and reuse across all queries to avoid repeated scans."
    },
    {
      "patch_id": "p02",
      "family": "B",
      "transform": "sf_inline_decorrelate",
      "relevance_score": 0.8,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (WITH customer_sales AS (\n  SELECT\n    c_customer_sk,\n    SUM(ss_quantity * ss_sales_price) AS ssales\n  FROM\n    store_sales\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE\n    d_year = 1999\n    AND ss_wholesale_cost BETWEEN 26 AND 36\n  GROUP BY\n    c_customer_sk\n),\ncustomer_threshold AS (\n  SELECT\n    MAX(ssales) * 0.95 AS threshold\n  FROM\n    customer_sales\n)\nSELECT\n  cs.c_customer_sk,\n  cs.ssales\nFROM\n  customer_sales cs\n  CROSS JOIN customer_threshold ct\nWHERE\n  cs.ssales > ct.threshold\n  AND cs.c_customer_sk IN (\n    SELECT c_customer_sk\n    FROM customer\n    WHERE c_birth_year BETWEEN 1987 AND 1993\n  )) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Decompose correlated scalar subquery in best_ss_customer HAVING clause into 3 CTEs: shared store_sales scan, per-customer aggregate threshold, filtered main query."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 1.25,
      "semantic_passed": true,
      "error": null,
      "original_ms": 270.2,
      "patch_ms": 216.9,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) select  sum(sales)\n from (select cs_quantity*cs_list_price sales\n       from catalog_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and cs_sold_date_sk = d_date_sk\n         and cs_item_sk in (select item_sk from frequent_ss_items)\n         and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and cs_wholesale_cost BETWEEN 26 AND 36\n         and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1999 and d_moy=5) and (select max(d_date_sk) from date_dim where d_year=1999 and d_moy=5)\n      union all\n      select ws_quantity*ws_list_price sales\n       from web_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and ws_sold_date_sk = d_date_sk\n         and ws_item_sk in (select item_sk from frequent_ss_items)\n         and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and ws_wholesale_cost BETWEEN 26 AND 36\n         and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1999 and d_moy=5) and (select max(d_date_sk) from date_dim where d_year=1999 and d_moy=5)) tmp2\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN range derived from date_dim filters (d_year=1999, d_moy=5) to catalog_sales and web_sales scans in UNION ALL branches."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1999) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1999) GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1999) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1999) GROUP BY c_customer_sk) tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk WHERE c_birth_year BETWEEN 1987 AND 1993 AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1999) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1999) GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Push date_sk BETWEEN range to all store_sales scans in CTEs using same date_dim filter (d_year=1999)."
    },
    {
      "patch_id": "p10",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.35,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), item_filtered AS (SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men','Music','Sports')), customer_filtered AS (SELECT c_customer_sk FROM customer WHERE c_birth_year BETWEEN 1987 AND 1993), frequent_ss_items AS (WITH item_filtered AS (SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men','Music','Sports')) SELECT substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN item_filtered ON ss_item_sk = item_filtered.i_item_sk WHERE d_year = 1999 GROUP BY substring(i_item_desc,1,30),i_item_sk,d_date HAVING count(*) >4), best_ss_customer AS (WITH customer_filtered AS (SELECT c_customer_sk FROM customer WHERE c_birth_year BETWEEN 1987 AND 1993) SELECT c_customer_sk,sum(ss_quantity*ss_sales_price) ssales FROM store_sales JOIN customer_filtered ON ss_customer_sk = customer_filtered.c_customer_sk GROUP BY c_customer_sk HAVING sum(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter item and customer tables into CTEs returning only surrogate keys before joining with store_sales."
    },
    {
      "patch_id": "p08",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.45,
      "status": "WIN",
      "speedup": 1.22,
      "semantic_passed": true,
      "error": null,
      "original_ms": 270.2,
      "patch_ms": 221.9,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), single_pass_agg AS (SELECT c.c_customer_sk, SUM(ss.ss_quantity * ss.ss_sales_price) AS csales, MAX(SUM(ss.ss_quantity * ss.ss_sales_price)) OVER () AS tpcds_cmax FROM store_sales ss JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 AND ss.ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c.c_customer_sk), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1999 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 26 AND 36) AS tmp2 LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate max_store_sales and best_ss_customer aggregations into single store_sales scan with CASE expressions."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "channel_bitmap_aggregation",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate three store_sales scans (frequent_ss_items, max_store_sales, best_ss_customer) into single scan with conditional aggregation."
    },
    {
      "patch_id": "p12",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.3,
      "status": "IMPROVED",
      "speedup": 1.1,
      "semantic_passed": true,
      "error": null,
      "original_ms": 270.2,
      "patch_ms": 246.3,
      "output_sql": "with frequent_ss_items as\n (select substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt\n  from store_sales\n  INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  INNER JOIN item ON ss_item_sk = i_item_sk\n  where d_year = 1999\n    and i_manager_id BETWEEN 44 and 63\n     AND i_category IN ('Men', 'Music', 'Sports')\n  group by substring(i_item_desc,1,30),i_item_sk,d_date\n  having count(*) >4),\n max_store_sales as\n (select max(csales) tpcds_cmax\n  from (select c_customer_sk,sum(ss_quantity*ss_sales_price) csales\n        from store_sales\n        INNER JOIN customer ON ss_customer_sk = c_customer_sk\n        INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n        where d_year = 1999\n         and ss_wholesale_cost BETWEEN 26 AND 36\n        group by c_customer_sk) tmp1),\n best_ss_customer as\n (select c_customer_sk,sum(ss_quantity*ss_sales_price) ssales\n  from store_sales\n  INNER JOIN customer ON ss_customer_sk = c_customer_sk\n  where c_birth_year BETWEEN 1987 AND 1993\n  group by c_customer_sk\n  having sum(ss_quantity*ss_sales_price) > (95/100.0) * (select\n  *\nfrom\n max_store_sales))\n  select  sum(sales)\n from (select cs_quantity*cs_list_price sales\n       from catalog_sales\n       INNER JOIN date_dim ON cs_sold_date_sk = d_date_sk\n       where d_year = 1999\n         and d_moy = 5\n         and cs_item_sk in (select item_sk from frequent_ss_items)\n         and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and cs_wholesale_cost BETWEEN 26 AND 36\n      union all\n      select ws_quantity*ws_list_price sales\n       from web_sales\n       INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk\n       where d_year = 1999\n         and d_moy = 5\n         and ws_item_sk in (select item_sk from frequent_ss_items)\n         and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and ws_wholesale_cost BETWEEN 26 AND 36) tmp2\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit INNER JOIN syntax for clarity and potential optimizer hints."
    }
  ],
  "explains": {
    "p01": "GlobalStats | 301185 | 298673 | 5102311021056\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 1999) AND (DATE_DIM.D_MOY = 5)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 1999) AND (DATE_D",
    "p08": "GlobalStats | 301183 | 298877 | 5105824844800\n1 | 0 | Result | MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))\n1 | 1 | [0] | Aggregate | aggExprs: [MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))]\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE)))))], groupKeys: [CUSTOMER.C_CUSTOMER_SK]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE",
    "p12": "GlobalStats | 301183 | 298877 | 5105824844800\n1 | 0 | Result | MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))\n1 | 1 | [0] | Aggregate | aggExprs: [MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))]\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE)))))], groupKeys: [CUSTOMER.C_CUSTOMER_SK]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE"
  }
}