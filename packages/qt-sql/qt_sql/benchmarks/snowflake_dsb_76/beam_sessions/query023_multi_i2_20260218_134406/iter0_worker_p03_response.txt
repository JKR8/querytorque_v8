{
  "probe_id": "channel_bitmap_aggregation",
  "transform_id": "channel_bitmap_aggregation",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Consolidating three scans of STORE_SALES into one using conditional aggregation preserves all output semantics while reducing I/O pressure.",
  "reasoning_trace": [
    "Assigned transform targets consolidation of repeated STORE_SALES scans using CASE-based aggregation.",
    "All three CTEs (frequent_ss_items, max_store_sales, best_ss_customer) scan STORE_SALES with overlapping filters.",
    "Conditional aggregation with CASE WHEN allows single-pass computation of all required metrics.",
    "Grouping sets or bitmap flags can encode per-CTE aggregation logic without duplicating scans."
  ],
  "target_ir": "Single STORE_SALES scan with CASE-based aggregation replacing three separate scans.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["catalog_sales", "date_dim", "web_sales", "best_ss_customer", "frequent_ss_items"],
        "outputs": ["SUM(sales)"],
        "changed": false
      },
      {
        "node_id": "frequent_ss_items",
        "parent_node_id": "final_select",
        "sources": ["store_sales_agg"],
        "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
        "changed": true,
        "sql": "SELECT itemdesc, item_sk, solddate, cnt FROM store_sales_agg WHERE freq_flag = 1"
      },
      {
        "node_id": "max_store_sales",
        "parent_node_id": "best_ss_customer",
        "sources": ["store_sales_agg"],
        "outputs": ["tpcds_cmax"],
        "changed": true,
        "sql": "SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, csales FROM store_sales_agg WHERE max_flag = 1) tmp1"
      },
      {
        "node_id": "best_ss_customer",
        "parent_node_id": "final_select",
        "sources": ["store_sales_agg", "max_store_sales"],
        "outputs": ["c_customer_sk", "ssales"],
        "changed": true,
        "sql": "SELECT c_customer_sk, ssales FROM store_sales_agg WHERE best_flag = 1 AND ssales > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)"
      },
      {
        "node_id": "store_sales_agg",
        "parent_node_id": null,
        "sources": ["store_sales", "date_dim", "item", "customer"],
        "outputs": [
          "itemdesc",
          "item_sk",
          "solddate",
          "cnt",
          "c_customer_sk",
          "csales",
          "ssales",
          "freq_flag",
          "max_flag",
          "best_flag"
        ],
        "changed": true,
        "sql": "WITH base_joins AS (\n  SELECT \n    ss.*, \n    i.*, \n    d.*, \n    c.*\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\n  JOIN item i ON ss.ss_item_sk = i.i_item_sk\n  LEFT JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\n  WHERE d.d_year = 1999\n    AND i.i_manager_id BETWEEN 44 AND 63\n    AND i.i_category IN ('Men', 'Music', 'Sports')\n    AND ss.ss_wholesale_cost BETWEEN 26 AND 36\n    AND (c.c_birth_year BETWEEN 1987 AND 1993 OR c.c_birth_year IS NULL)\n)\nSELECT\n  SUBSTRING(i_item_desc, 1, 30) AS itemdesc,\n  i_item_sk AS item_sk,\n  d_date AS solddate,\n  COUNT(*) AS cnt,\n  c_customer_sk,\n  SUM(CASE WHEN ss_customer_sk IS NOT NULL THEN ss_quantity * ss_sales_price ELSE 0 END) AS csales,\n  SUM(CASE WHEN ss_customer_sk IS NOT NULL THEN ss_quantity * ss_sales_price ELSE 0 END) AS ssales,\n  CASE WHEN i_item_sk IS NOT NULL THEN 1 ELSE 0 END AS freq_flag,\n  CASE WHEN c_customer_sk IS NOT NULL THEN 1 ELSE 0 END AS max_flag,\n  CASE WHEN c_customer_sk IS NOT NULL AND c_birth_year BETWEEN 1987 AND 1993 THEN 1 ELSE 0 END AS best_flag\nFROM base_joins\nGROUP BY \n  SUBSTRING(i_item_desc, 1, 30), \n  i_item_sk, \n  d_date, \n  c_customer_sk"
      }
    ]
  }
}