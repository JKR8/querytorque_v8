{
  "iteration": 0,
  "n_api_calls": 6,
  "beam_cost_usd": 0.02102225,
  "beam_cost_priced_calls": 6,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 60284,
    "completion_tokens": 18081,
    "total_tokens": 78365,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 12288,
    "reasoning_tokens": 11521
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 183.7,
      "patch_ms": 195.0,
      "output_sql": "WITH inv AS (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and d_moy in (5,6)\n        and inv_quantity_on_hand between 791 and 991\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_date_sk between (select min(d_date_sk) from date_dim where d_year=2002 and d_moy in (5,6)) and (select max(d_date_sk) from date_dim where d_year=2002 and d_moy in (5,6))\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv AS inv1, inv AS inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 5 + 1 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add date_sk BETWEEN range derived from date_dim filters (d_year=2002, d_moy in (5,6)) to the inventory scan to enable micro-partition pruning on inv_date_sk."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.7,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 183.7,
      "patch_ms": 195.2,
      "output_sql": "WITH inv AS (with item_filtered as (select i_item_sk from item where i_category IN ('Shoes', 'Sports') and i_manager_id BETWEEN 42 and 61), warehouse_filtered as (select w_warehouse_sk, w_warehouse_name from warehouse), date_dim_filtered as (select d_date_sk, d_moy from date_dim where d_year=2002 and d_moy in (5,6)) select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stdev,mean, case mean when 0 then null else stdev/mean end cov from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean from inventory ,item_filtered ,warehouse_filtered ,date_dim_filtered where inv_item_sk = i_item_sk and inv_warehouse_sk = w_warehouse_sk and inv_date_sk = d_date_sk and inv_quantity_on_hand between 791 and 991 group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo where case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv AS inv1, inv AS inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 5 + 1 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter dimension tables (item, warehouse, date_dim) into separate CTEs to create small hash tables before joining with inventory, reducing the fact scan rows."
    },
    {
      "patch_id": "p04",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.55,
      "status": "NEUTRAL",
      "speedup": 0.98,
      "semantic_passed": true,
      "error": null,
      "original_ms": 183.7,
      "patch_ms": 186.7,
      "output_sql": "WITH inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) stdev, avg(inv_quantity_on_hand) mean FROM inventory inv INNER JOIN item i ON inv.inv_item_sk = i.i_item_sk INNER JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk INNER JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv.inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv AS inv1, inv AS inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 5 + 1 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate inventory data by inv_item_sk, inv_warehouse_sk, inv_date_sk before joining with dimension tables to reduce row count early, while preserving dimension filter semantics."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "self_join_decomposition",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 183.7,
      "patch_ms": 194.8,
      "output_sql": "WITH inv5 AS (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_quantity_on_hand between 791 and 991\n        and d_moy = 5\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1), inv6 AS (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_quantity_on_hand between 791 and 991\n        and d_moy = 6\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1) select inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov\n        ,inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov\nfrom inv5 inv1,inv6 inv2\nwhere inv1.i_item_sk = inv2.i_item_sk\n  and inv1.w_warehouse_sk =  inv2.w_warehouse_sk\norder by inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov\n        ,inv2.d_moy,inv2.mean, inv2.cov;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Split the CTE 'inv' into two separate CTEs, 'inv5' for d_moy=5 and 'inv6' for d_moy=6, embedding the month filters early in their definitions to avoid materializing the full CTE."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 5 missing, 10 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH inv_conditional AS (SELECT w.w_warehouse_sk, i.i_item_sk, AVG(CASE WHEN d.d_moy = 5 THEN inv.inv_quantity_on_hand END) as mean_5, STDDEV_SAMP(CASE WHEN d.d_moy = 5 THEN inv.inv_quantity_on_hand END) as stdev_5, CASE WHEN mean_5 = 0 THEN NULL ELSE stdev_5 / mean_5 END as cov_5, AVG(CASE WHEN d.d_moy = 6 THEN inv.inv_quantity_on_hand END) as mean_6, STDDEV_SAMP(CASE WHEN d.d_moy = 6 THEN inv.inv_quantity_on_hand END) as stdev_6, CASE WHEN mean_6 = 0 THEN NULL ELSE stdev_6 / mean_6 END as cov_6 FROM inventory inv JOIN item i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy IN (5, 6) AND i.i_category IN ('Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 61 AND inv.inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w.w_warehouse_sk, i.i_item_sk HAVING mean_5 IS NOT NULL AND mean_6 IS NOT NULL) SELECT w_warehouse_sk as inv1_w_warehouse_sk, i_item_sk as inv1_i_item_sk, 5 as inv1_d_moy, mean_5 as inv1_mean, cov_5 as inv1_cov, w_warehouse_sk as inv2_w_warehouse_sk, i_item_sk as inv2_i_item_sk, 6 as inv2_d_moy, mean_6 as inv2_mean, cov_6 as inv2_cov FROM inv_conditional WHERE mean_5 IS NOT NULL AND mean_6 IS NOT NULL AND cov_5 > 1 AND cov_6 > 1 ORDER BY inv1_w_warehouse_sk, inv1_i_item_sk, inv1_d_moy, inv1_mean, inv1_cov, inv2_d_moy, inv2_mean, inv2_cov;",
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 285 | 285 | 3688981504\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 2002) AND (DATE_DIM.D_MOY IN 5 IN 6)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 2002) AND (DATE_DIM.",
    "p03": "GlobalStats | 283 | 283 | 3684704256\n1 | 0 | Result | INV1.W_WAREHOUSE_SK, INV1.I_ITEM_SK, INV1.D_MOY, INV1.MEAN, INV1.COV, INV2.W_WAREHOUSE_SK, INV2.I_ITEM_SK, INV2.D_MOY, INV2.MEAN, INV2.COV\n1 | 1 | [0] | Sort | INV1.W_WAREHOUSE_SK ASC NULLS LAST, INV1.I_ITEM_SK ASC NULLS LAST, INV1.D_MOY ASC NULLS LAST, INV1.MEAN ASC NULLS LAST, INV1.COV ASC NULLS LAST, INV2.D_MOY ASC NULLS LAST, INV2.MEAN ASC NULLS LAST, INV2.COV ASC NULLS LAST\n1 | 2 | [1] | InnerJoin | joinKey: (INV1.I_ITEM_SK = INV2.I_ITEM",
    "p04": "GlobalStats | 283 | 283 | 3684704256\n1 | 0 | Result | INV1.W_WAREHOUSE_SK, INV1.I_ITEM_SK, INV1.D_MOY, INV1.MEAN, INV1.COV, INV2.W_WAREHOUSE_SK, INV2.I_ITEM_SK, INV2.D_MOY, INV2.MEAN, INV2.COV\n1 | 1 | [0] | Sort | INV1.W_WAREHOUSE_SK ASC NULLS LAST, INV1.I_ITEM_SK ASC NULLS LAST, INV1.D_MOY ASC NULLS LAST, INV1.MEAN ASC NULLS LAST, INV1.COV ASC NULLS LAST, INV2.D_MOY ASC NULLS LAST, INV2.MEAN ASC NULLS LAST, INV2.COV ASC NULLS LAST\n1 | 2 | [1] | InnerJoin | joinKey: (INV1.I_ITEM_SK = INV2.I_ITEM",
    "p02": "GlobalStats | 566 | 566 | 7369408512\n1 | 0 | Result | WAREHOUSE.W_WAREHOUSE_SK, ITEM.I_ITEM_SK, DATE_DIM.D_MOY, SCALED_ROUND_INT_DIVIDE(SUM(SUM(SUM(SUM_INTERNAL(INVENTORY.INV_QUANTITY_ON_HAND, COUNT(*))))), COUNT(COUNT(COUNT(COUNT_INTERNAL(INVENTORY.INV_QUANTITY_ON_HAND, COUNT(*)))))), CASE SCALED_ROUND_INT_DIVIDE(SUM(SUM(SUM(SUM_INTERNAL(INVENTORY.INV_QUANTITY_ON_HAND, COUNT(*))))), COUNT(COUNT(COUNT(COUNT_INTERNAL(INVENTORY.INV_QUANTITY_ON_HAND, COUNT(*)))))) WHEN 0 THEN null ELSE (SQRT(TO_DOU"
  }
}