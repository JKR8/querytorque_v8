[
  {
    "plan_id": "compile_p01_fixed",
    "dialect": "snowflake",
    "confidence": 0.5,
    "based_on": "p01",
    "strategy": "Explicit JOINs with early filtering of selective dimensions, fixing column reference errors.",
    "hypothesis": "Probe p01 failed due to syntax error (invalid identifier). Correcting column references and ensuring all dimension filters are applied early may reduce join volume. This attempt uses explicit JOINs to guide join order and pre-filters promotion, customer_address (ad2 only), and customer_demographics.",
    "expected_explain_delta": "Earlier filter application on selective dimensions, potentially reducing rows flowing into the large star-join.",
    "target_ir": "Rewrite cross_sales node with explicit JOINs and filtered dimension CTEs, preserving original grouping and aggregation.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["cross_sales"],
          "outputs": ["product_name", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "cnt", "s11", "s21", "s31", "s12", "s22", "s32", "syear", "cnt"],
          "changed": false
        },
        {
          "node_id": "cross_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "cs_ui", "date_dim", "store", "customer", "customer_demographics", "promotion", "household_demographics", "customer_address", "income_band", "item"],
          "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
          "changed": true,
          "sql": "WITH cs_ui AS (SELECT cs_item_sk, SUM(cs_ext_list_price) AS sale, SUM(cr_refunded_cash + cr_reversed_charge + cr_store_credit) AS refund FROM catalog_sales, catalog_returns WHERE cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY cs_item_sk HAVING SUM(cs_ext_list_price) > 2 * SUM(cr_refunded_cash + cr_reversed_charge + cr_store_credit)), filtered_promo AS (SELECT * FROM promotion WHERE p_channel_email = 'N' AND p_channel_tv = 'Y' AND p_channel_radio = 'N'), filtered_ad2 AS (SELECT * FROM customer_address WHERE ca_state IN ('IA','IL','TX')), filtered_cd1 AS (SELECT * FROM customer_demographics WHERE cd_marital_status IN ('M', 'M', 'U') AND cd_education_status IN ('Unknown', 'Advanced Degree', 'College')), filtered_cd2 AS (SELECT * FROM customer_demographics WHERE cd_marital_status IN ('M', 'M', 'U') AND cd_education_status IN ('Unknown', 'Advanced Degree', 'College')) SELECT i_product_name product_name, i_item_sk item_sk, s_store_name store_name, s_zip store_zip, ad1.ca_street_number b_street_number, ad1.ca_street_name b_street_name, ad1.ca_city b_city, ad1.ca_zip b_zip, ad2.ca_street_number c_street_number, ad2.ca_street_name c_street_name, ad2.ca_city c_city, ad2.ca_zip c_zip, d1.d_year as syear, d2.d_year as fsyear, d3.d_year s2year, COUNT(*) cnt, SUM(ss_wholesale_cost) s1, SUM(ss_list_price) s2, SUM(ss_coupon_amt) s3 FROM store_sales JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number JOIN cs_ui ON ss_item_sk = cs_ui.cs_item_sk JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON c_first_sales_date_sk = d2.d_date_sk JOIN date_dim d3 ON c_first_shipto_date_sk = d3.d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN filtered_cd1 cd1 ON ss_cdemo_sk = cd1.cd_demo_sk JOIN filtered_cd2 cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk JOIN filtered_promo p ON ss_promo_sk = p_promo_sk JOIN household_demographics hd1 ON ss_hdemo_sk = hd1.hd_demo_sk JOIN household_demographics hd2 ON c_current_hdemo_sk = hd2.hd_demo_sk JOIN customer_address ad1 ON ss_addr_sk = ad1.ca_address_sk JOIN filtered_ad2 ad2 ON c_current_addr_sk = ad2.ca_address_sk JOIN income_band ib1 ON hd1.hd_income_band_sk = ib1.ib_income_band_sk JOIN income_band ib2 ON hd2.hd_income_band_sk = ib2.ib_income_band_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd1.cd_marital_status <> cd2.cd_marital_status AND i_current_price BETWEEN 26 AND 26 + 10 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_product_name, i_item_sk, s_store_name, s_zip, ad1.ca_street_number, ad1.ca_street_name, ad1.ca_city, ad1.ca_zip, ad2.ca_street_number, ad2.ca_street_name, ad2.ca_city, ad2.ca_zip, d1.d_year, d2.d_year, d3.d_year"
        },
        {
          "node_id": "cs_ui",
          "parent_node_id": "cross_sales",
          "sources": ["catalog_sales", "catalog_returns"],
          "outputs": ["cs_item_sk", "sale", "refund"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02_fixed",
    "dialect": "snowflake",
    "confidence": 0.4,
    "based_on": "p02",
    "strategy": "Date filter pushdown for d1 (syear) combined with explicit JOINs, avoiding regression by preserving original join semantics.",
    "hypothesis": "Probe p02 showed regression (0.88x) but may have been due to incomplete filtering or join order. This attempt pushes the date filter on d1 (syear) into a filtered CTE and uses explicit JOINs, aiming to reduce fact-table scan volume while maintaining correctness.",
    "expected_explain_delta": "Filtered date_dim CTE reduces rows joined to store_sales, potentially enabling partition pruning on date key.",
    "target_ir": "Add filtered_d1 CTE and rewrite cross_sales with explicit JOINs, keeping other dimensions unfiltered to avoid semantic drift.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["cross_sales"],
          "outputs": ["product_name", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "cnt", "s11", "s21", "s31", "s12", "s22", "s32", "syear", "cnt"],
          "changed": false
        },
        {
          "node_id": "cross_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "cs_ui", "date_dim", "store", "customer", "customer_demographics", "promotion", "household_demographics", "customer_address", "income_band", "item"],
          "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
          "changed": true,
          "sql": "WITH cs_ui AS (SELECT cs_item_sk, SUM(cs_ext_list_price) AS sale, SUM(cr_refunded_cash + cr_reversed_charge + cr_store_credit) AS refund FROM catalog_sales, catalog_returns WHERE cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY cs_item_sk HAVING SUM(cs_ext_list_price) > 2 * SUM(cr_refunded_cash + cr_reversed_charge + cr_store_credit)), filtered_d1 AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (1998, 1999)) SELECT i_product_name product_name, i_item_sk item_sk, s_store_name store_name, s_zip store_zip, ad1.ca_street_number b_street_number, ad1.ca_street_name b_street_name, ad1.ca_city b_city, ad1.ca_zip b_zip, ad2.ca_street_number c_street_number, ad2.ca_street_name c_street_name, ad2.ca_city c_city, ad2.ca_zip c_zip, d1.d_year as syear, d2.d_year as fsyear, d3.d_year s2year, COUNT(*) cnt, SUM(ss_wholesale_cost) s1, SUM(ss_list_price) s2, SUM(ss_coupon_amt) s3 FROM store_sales JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number JOIN cs_ui ON ss_item_sk = cs_ui.cs_item_sk JOIN filtered_d1 d1 ON ss_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON c_first_sales_date_sk = d2.d_date_sk JOIN date_dim d3 ON c_first_shipto_date_sk = d3.d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_demographics cd1 ON ss_cdemo_sk = cd1.cd_demo_sk JOIN customer_demographics cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk JOIN promotion p ON ss_promo_sk = p_promo_sk JOIN household_demographics hd1 ON ss_hdemo_sk = hd1.hd_demo_sk JOIN household_demographics hd2 ON c_current_hdemo_sk = hd2.hd_demo_sk JOIN customer_address ad1 ON ss_addr_sk = ad1.ca_address_sk JOIN customer_address ad2 ON c_current_addr_sk = ad2.ca_address_sk JOIN income_band ib1 ON hd1.hd_income_band_sk = ib1.ib_income_band_sk JOIN income_band ib2 ON hd2.hd_income_band_sk = ib2.ib_income_band_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd1.cd_marital_status <> cd2.cd_marital_status AND i_current_price BETWEEN 26 AND 26 + 10 AND p_channel_email = 'N' AND p_channel_tv = 'Y' AND p_channel_radio = 'N' AND ad2.ca_state IN ('IA','IL','TX') AND ss_wholesale_cost BETWEEN 35 AND 55 AND cd1.cd_marital_status IN ('M', 'M', 'U') AND cd1.cd_education_status IN ('Unknown', 'Advanced Degree', 'College') AND cd2.cd_marital_status IN ('M', 'M', 'U') AND cd2.cd_education_status IN ('Unknown', 'Advanced Degree', 'College') GROUP BY i_product_name, i_item_sk, s_store_name, s_zip, ad1.ca_street_number, ad1.ca_street_name, ad1.ca_city, ad1.ca_zip, ad2.ca_street_number, ad2.ca_street_name, ad2.ca_city, ad2.ca_zip, d1.d_year, d2.d_year, d3.d_year"
        },
        {
          "node_id": "cs_ui",
          "parent_node_id": "cross_sales",
          "sources": ["catalog_sales", "catalog_returns"],
          "outputs": ["cs_item_sk", "sale", "refund"],
          "changed": false
        }
      ]
    }
  }
]