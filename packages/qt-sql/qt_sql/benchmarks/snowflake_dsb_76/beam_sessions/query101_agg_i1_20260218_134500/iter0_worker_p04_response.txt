{
  "probe_id": "scout_001",
  "transform_id": "multi_dimension_prefetch",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs reduces fact table scan size by building small hash tables first. This aligns with Snowflake's strength in predicate pushdown and join-filter optimization.",
  "reasoning_trace": [
    "Assigned transform targets prefetch of selective dimensions before large fact joins.",
    "CTEs for each dimension preserve filter selectivity and allow early pruning.",
    "Join order may shift to use smaller hash tables, reducing I/O on fact scans.",
    "No semantic drift as all filters and join conditions are preserved."
  ],
  "target_ir": "Each dimension table (d1, d2, item, customer, customer_address, household_demographics) becomes a CTE with its selective filter applied.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["prefetch_d1", "prefetch_d2", "prefetch_item", "prefetch_customer", "prefetch_ca", "prefetch_hd", "store_sales", "store_returns", "web_sales"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "WITH prefetch_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998),\n     prefetch_d2 AS (SELECT d_date_sk, d_date FROM date_dim d2 JOIN prefetch_d1 d1 ON d2.d_date BETWEEN d1.d_date AND DATEADD(day, 90, d1.d_date)),\n     prefetch_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music')),\n     prefetch_customer AS (SELECT c_customer_sk, c_current_addr_sk, c_current_hdemo_sk, c_first_name, c_last_name FROM customer WHERE c_customer_sk IS NOT NULL AND c_current_hdemo_sk IS NOT NULL),\n     prefetch_ca AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX')),\n     prefetch_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 7 AND 13 AND hd_buy_potential = '0-500')\nSELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt\nFROM store_sales ss\nJOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk\nJOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk\nJOIN prefetch_d1 d1 ON sr.sr_returned_date_sk = d1.d_date_sk\nJOIN prefetch_d2 d2 ON ws.ws_sold_date_sk = d2.d_date_sk\nJOIN prefetch_item i ON ss.ss_item_sk = i.i_item_sk\nJOIN prefetch_customer c ON ss.ss_customer_sk = c.c_customer_sk\nJOIN prefetch_ca ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN prefetch_hd hd ON c.c_current_hdemo_sk = hd.hd_demo_sk\nWHERE (ss.ss_sales_price / ss.ss_list_price) BETWEEN 0.35 AND 0.55\nGROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name\nORDER BY cnt"
      },
      {
        "node_id": "prefetch_d1",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "prefetch_d2",
        "parent_node_id": "final_select",
        "sources": ["date_dim", "prefetch_d1"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "prefetch_item",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk"],
        "changed": false
      },
      {
        "node_id": "prefetch_customer",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_current_addr_sk", "c_current_hdemo_sk", "c_first_name", "c_last_name"],
        "changed": false
      },
      {
        "node_id": "prefetch_ca",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": false
      },
      {
        "node_id": "prefetch_hd",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk"],
        "changed": false
      },
      {
        "node_id": "store_sales",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ss_item_sk", "ss_customer_sk", "ss_ticket_number", "ss_list_price", "ss_sales_price"],
        "changed": false
      },
      {
        "node_id": "store_returns",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["sr_returned_date_sk", "sr_item_sk", "sr_ticket_number"],
        "changed": false
      },
      {
        "node_id": "web_sales",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ws_sold_date_sk", "ws_item_sk", "ws_bill_customer_sk"],
        "changed": false
      }
    ]
  }
}