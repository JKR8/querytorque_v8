{
  "probe_id": "sf_sk_pushdown_multi_fact",
  "transform_id": "sf_sk_pushdown_multi_fact",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Introducing a CTE to precompute the date_sk range from date_dim and applying it as a filter on store_sales will enable micro-partition pruning and reduce I/O.",
  "reasoning_trace": [
    "Identified repeated full scans on STORE_SALES due to lack of direct date_sk filtering.",
    "Introduced a CTE to compute valid date_sk range based on d_month_seq.",
    "Applied the computed date_sk range to both subqueries referencing STORE_SALES."
  ],
  "target_ir": "Added date_sk_range CTE and filtered store_sales by that range in all relevant subqueries.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store", "item", "sb", "sc"],
        "outputs": ["s_store_name", "i_item_desc", "revenue", "i_current_price", "i_wholesale_cost", "i_brand"],
        "changed": true,
        "sql": "WITH date_sk_range AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1195 AND 1206\n),\nsb AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM (\n    SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n    FROM store_sales\n    WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_sk_range)\n      AND ss_sales_price / ss_list_price BETWEEN 0.38 AND 0.48\n    GROUP BY ss_store_sk, ss_item_sk\n  ) sa\n  GROUP BY ss_store_sk\n),\nsc AS (\n  SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n  FROM store_sales\n  WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_sk_range)\n    AND ss_sales_price / ss_list_price BETWEEN 0.38 AND 0.48\n  GROUP BY ss_store_sk, ss_item_sk\n)\nSELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand\nFROM store, item, sb, sc\nWHERE sb.ss_store_sk = sc.ss_store_sk\n  AND sc.revenue <= 0.1 * sb.ave\n  AND s_store_sk = sc.ss_store_sk\n  AND i_item_sk = sc.ss_item_sk\n  AND i_manager_id BETWEEN 80 AND 84\n  AND s_state IN ('IA','IL','NC')\nORDER BY s_store_name, i_item_desc\nLIMIT 100"
      }
    ]
  }
}