[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.8,
    "based_on": "p03",
    "strategy": "Push date_sk range derived from d_year=2002 into web_sales scan to enable micro-partition pruning.",
    "hypothesis": "WIN probe p03 showed 1.21x speedup by adding explicit date_sk range condition, allowing Snowflake to prune partitions earlier. This addresses the largest hotspot (WEB_SALES scan) by pushing the date filter into the fact table scan.",
    "expected_explain_delta": "Filter on ws_sold_date_sk appears earlier in plan, reducing WEB_SALES scan bytes.",
    "target_ir": "Add derived date range predicate to WHERE clause.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["SUBSTRING(r_reason_desc, 1, 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "select  substring(r_reason_desc,1,20)\n       ,avg(ws_quantity)\n       ,avg(wr_refunded_cash)\n       ,avg(wr_fee)\n from web_sales, web_returns, web_page, customer_demographics cd1,\n      customer_demographics cd2, customer_address, date_dim, reason\n where ws_web_page_sk = wp_web_page_sk\n   and ws_item_sk = wr_item_sk\n   and ws_order_number = wr_order_number\n   and ws_sold_date_sk = d_date_sk and d_year = 2002\n   and cd1.cd_demo_sk = wr_refunded_cdemo_sk\n   and cd2.cd_demo_sk = wr_returning_cdemo_sk\n   and ca_address_sk = wr_refunded_addr_sk\n   and r_reason_sk = wr_reason_sk\n   and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=2002)\n                            and (select max(d_date_sk) from date_dim where d_year=2002)\n   and\n   (\n    (\n     cd1.cd_marital_status = 'S'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = 'Primary'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 100.00 and 150.00\n    )\n   or\n    (\n     cd1.cd_marital_status = 'M'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = 'Secondary'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 50.00 and 100.00\n    )\n   or\n    (\n     cd1.cd_marital_status = 'U'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = '2 yr Degree'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 150.00 and 200.00\n    )\n   )\n   and\n   (\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('KY', 'NC', 'SD')\n     and ws_net_profit between 100 and 200\n    )\n    or\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('AR', 'GA', 'IN')\n     and ws_net_profit between 150 and 300\n    )\n    or\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('KS', 'OH', 'VA')\n     and ws_net_profit between 50 and 250\n    )\n   )\ngroup by r_reason_desc\norder by substring(r_reason_desc,1,20)\n        ,avg(ws_quantity)\n        ,avg(wr_refunded_cash)\n        ,avg(wr_fee)\nlimit 100;"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.6,
    "based_on": "p05,p08",
    "strategy": "Pre-filter dimension tables into CTEs to reduce join cardinality and push filters early.",
    "hypothesis": "Failed probe p05 attempted dimension isolation but had syntax errors; corrected version pre-filters date_dim, customer_demographics, customer_address, and reason to reduce rows before joining with large fact tables. This may reduce join pressure and enable better join order.",
    "expected_explain_delta": "Dimension scans become smaller; join filters may be pushed down earlier.",
    "target_ir": "Introduce CTEs for filtered dimensions and rewrite joins explicitly.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_dim_filtered", "cd1_filtered", "cd2_filtered", "ca_filtered", "reason_filtered", "web_sales", "web_returns", "web_page"],
          "outputs": ["SUBSTRING(r_reason_desc, 1, 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "WITH date_dim_filtered AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 2002\n),\ncd1_filtered AS (\n  SELECT cd_demo_sk, cd_marital_status, cd_education_status\n  FROM customer_demographics\n  WHERE cd_marital_status IN ('S', 'M', 'U')\n    AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')\n),\ncd2_filtered AS (\n  SELECT cd_demo_sk, cd_marital_status, cd_education_status\n  FROM customer_demographics\n  WHERE cd_marital_status IN ('S', 'M', 'U')\n    AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')\n),\nca_filtered AS (\n  SELECT ca_address_sk, ca_state, ca_country\n  FROM customer_address\n  WHERE ca_country = 'United States'\n    AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')\n),\nreason_filtered AS (\n  SELECT r_reason_sk, r_reason_desc\n  FROM reason\n)\nSELECT substring(rf.r_reason_desc, 1, 20),\n       avg(ws.ws_quantity),\n       avg(wr.wr_refunded_cash),\n       avg(wr.wr_fee)\nFROM web_sales ws\nJOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk\n                    AND ws.ws_order_number = wr.wr_order_number\nJOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\nJOIN date_dim_filtered d ON ws.ws_sold_date_sk = d.d_date_sk\nJOIN cd1_filtered cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\nJOIN cd2_filtered cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\nJOIN ca_filtered ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk\nJOIN reason_filtered rf ON rf.r_reason_sk = wr.wr_reason_sk\nWHERE (\n      (cd1.cd_marital_status = 'S'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = 'Primary'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n      OR\n      (cd1.cd_marital_status = 'M'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = 'Secondary'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n      OR\n      (cd1.cd_marital_status = 'U'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = '2 yr Degree'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n      )\n  AND (\n      (ca.ca_country = 'United States'\n       AND ca.ca_state IN ('KY', 'NC', 'SD')\n       AND ws.ws_net_profit BETWEEN 100 AND 200)\n      OR\n      (ca.ca_country = 'United States'\n       AND ca.ca_state IN ('AR', 'GA', 'IN')\n       AND ws.ws_net_profit BETWEEN 150 AND 300)\n      OR\n      (ca.ca_country = 'United States'\n       AND ca.ca_state IN ('KS', 'OH', 'VA')\n       AND ws.ws_net_profit BETWEEN 50 AND 250)\n      )\nGROUP BY rf.r_reason_desc\nORDER BY substring(rf.r_reason_desc, 1, 20),\n         avg(ws.ws_quantity),\n         avg(wr.wr_refunded_cash),\n         avg(wr.wr_fee)\nLIMIT 100;"
        },
        {
          "node_id": "date_dim_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        },
        {
          "node_id": "cd1_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status