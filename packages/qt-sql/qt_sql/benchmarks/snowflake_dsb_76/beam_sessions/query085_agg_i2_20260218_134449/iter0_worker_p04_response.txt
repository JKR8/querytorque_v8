{
  "probe_id": "p01",
  "transform_id": "or_to_union",
  "family": "D",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Splitting the OR condition on customer_address and ws_net_profit into three UNION ALL branches enables better predicate pushdown and partition pruning per branch.",
  "reasoning_trace": [
    "Assigned transform targets OR conditions in the WHERE clause that block efficient join planning.",
    "Three distinct state/profit combinations allow separate focused scans with strong predicate pushdown.",
    "Each branch retains all required tables and filters, preserving row semantics and avoiding duplication."
  ],
  "target_ir": "Main query becomes a UNION ALL of three branches, each with a single state list and profit range; final aggregation and limit preserved.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["union_branches"],
        "outputs": ["substring(r_reason_desc,1,20)", "avg(ws_quantity)", "avg(wr_refunded_cash)", "avg(wr_fee)"],
        "changed": false
      },
      {
        "node_id": "union_branches",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
        "changed": true,
        "sql": "SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee\nFROM (\n  SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee\n  FROM web_sales ws\n  JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number\n  JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\n  JOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk\n  JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\n  JOIN reason r ON r.r_reason_sk = wr.wr_reason_sk\n  WHERE d.d_year = 2002\n    AND ca.ca_country = 'United States'\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n    AND (\n      (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n      OR\n      (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n      OR\n      (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n    )\n    AND ca.ca_state IN ('KY', 'NC', 'SD')\n    AND ws.ws_net_profit BETWEEN 100 AND 200\n\n  UNION ALL\n\n  SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee\n  FROM web_sales ws\n  JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number\n  JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\n  JOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk\n  JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\n  JOIN reason r ON r.r_reason_sk = wr.wr_reason_sk\n  WHERE d.d_year = 2002\n    AND ca.ca_country = 'United States'\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n    AND (\n      (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n      OR\n      (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n      OR\n      (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n    )\n    AND ca.ca_state IN ('AR', 'GA', 'IN')\n    AND ws.ws_net_profit BETWEEN 150 AND 300\n\n  UNION ALL\n\n  SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee\n  FROM web_sales ws\n  JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number\n  JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\n  JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\n  JOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk\n  JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\n  JOIN reason r ON r.r_reason_sk = wr.wr_reason_sk\n  WHERE d.d_year = 2002\n    AND ca.ca_country = 'United States'\n    AND cd1.cd_marital_status = cd2.cd_marital_status\n    AND cd1.cd_education_status = cd2.cd_education_status\n    AND (\n      (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n      OR\n      (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n      OR\n      (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n    )\n    AND ca.ca_state IN ('KS', 'OH', 'VA')\n    AND ws.ws_net_profit BETWEEN 50 AND 250\n) AS subquery"
      }
    ]
  }
}