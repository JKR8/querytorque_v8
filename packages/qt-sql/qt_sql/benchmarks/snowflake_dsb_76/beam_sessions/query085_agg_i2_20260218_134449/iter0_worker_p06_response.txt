{
  "probe_id": "scout_1",
  "transform_id": "prefetch_fact_join",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Staged filtering of dimensions followed by early join with fact tables reduces intermediate row counts and enables better pruning.",
  "reasoning_trace": [
    "Date filter on d_year=2002 can be pushed into web_sales and web_returns scans via CTEs.",
    "Customer demographics and address filters are applied early to reduce join size.",
    "Final aggregation and select remain unchanged to preserve output semantics."
  ],
  "target_ir": "Introduce CTEs for filtered dimensions and early fact joins; preserve final aggregation.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["aggregated_results"],
        "outputs": ["SUBSTRING(r_reason_desc, 1, 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
        "changed": false
      },
      {
        "node_id": "aggregated_results",
        "parent_node_id": "final_select",
        "sources": ["filtered_joined_data"],
        "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
        "changed": true,
        "sql": "SELECT r.r_reason_desc, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee FROM filtered_joined_data"
      },
      {
        "node_id": "filtered_joined_data",
        "parent_node_id": "aggregated_results",
        "sources": ["web_sales_filtered", "web_returns_filtered", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
        "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
        "changed": true,
        "sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002),\nweb_sales_filtered AS (SELECT * FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_filtered)),\nweb_returns_filtered AS (SELECT * FROM web_returns WHERE wr_returned_date_sk IN (SELECT d_date_sk FROM date_filtered))\nSELECT r.r_reason_desc, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee\nFROM web_sales_filtered ws\nJOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number\nJOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\nJOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\nJOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\nJOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk\nJOIN reason r ON r.r_reason_sk = wr.wr_reason_sk\nWHERE (\n  (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n  OR\n  (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n  OR\n  (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n)\nAND (\n  (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200)\n  OR\n  (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300)\n  OR\n  (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250)\n)"
      }
    ]
  }
}