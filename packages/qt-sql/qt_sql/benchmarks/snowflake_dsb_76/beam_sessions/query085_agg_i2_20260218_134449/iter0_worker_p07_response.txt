{
  "probe_id": "scout_dimension_cte_isolate",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating dimension filters into CTEs preserves join keys and allows Snowflake to materialize small filtered results for efficient hash joins.",
  "reasoning_trace": [
    "Assigned transform targets dimension tables with existing filters that can be isolated into CTEs.",
    "Each dimension table (date_dim, customer_demographics, customer_address, reason) has selective WHERE clauses suitable for early filtering.",
    "CTE isolation avoids duplicating large scans and preserves all required join relationships and output semantics."
  ],
  "target_ir": "Dimension tables become filtered CTEs; fact joins remain unchanged but now reference filtered CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["web_sales", "web_returns", "web_page", "cd1_filtered", "cd2_filtered", "ca_filtered", "d_filtered", "r_filtered"],
        "outputs": ["SUBSTRING(r_reason_desc, 1, 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
        "changed": true,
        "sql": "SELECT SUBSTRING(r.r_reason_desc, 1, 20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) FROM web_sales ws, web_returns wr, web_page wp, cd1_filtered cd1, cd2_filtered cd2, ca_filtered ca, d_filtered d, r_filtered r WHERE ws.ws_web_page_sk = wp.wp_web_page_sk AND ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number AND ws.ws_sold_date_sk = d.d_date_sk AND cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr.wr_returning_cdemo_sk AND ca.ca_address_sk = wr.wr_refunded_addr_sk AND r.r_reason_sk = wr.wr_reason_sk AND ((cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)) AND (((ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250))) GROUP BY r.r_reason_desc ORDER BY SUBSTRING(r.r_reason_desc, 1, 20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) LIMIT 100"
      },
      {
        "node_id": "d_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
      },
      {
        "node_id": "cd1_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
      },
      {
        "node_id": "cd2_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
      },
      {
        "node_id": "ca_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state", "ca_country"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state, ca_country FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')"
      },
      {
        "node_id": "r_filtered",
        "parent_node_id": "final_select",
        "sources": ["reason"],
        "outputs": ["r_reason_sk", "r_reason_desc"],
        "changed": true,
        "sql": "SELECT r_reason_sk, r_reason_desc FROM reason"
      },
      {
        "node_id": "web_sales",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ws_sold_date_sk", "ws_item_sk", "ws_web_page_sk", "ws_order_number", "ws_quantity", "ws_sales_price", "ws_net_profit"],
        "changed": false
      },
      {
        "node_id": "web_returns",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["wr_item_sk", "wr_refunded_cdemo_sk", "wr_refunded_addr_sk", "wr_returning_cdemo_sk", "wr_reason_sk", "wr_order_number", "wr_fee", "wr_refunded_cash"],
        "changed": false
      },
      {
        "node_id": "web_page",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["wp_web_page_sk"],
        "changed": false
      }
    ]
  }
}