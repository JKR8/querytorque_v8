[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p03,p08",
    "strategy": "Date range pushdown via CTE to enable micro-partition pruning on web_sales scan.",
    "hypothesis": "Probes p03 (WIN) and p08 (IMPROVED) showed speedup by pushing date filter into fact scans. Adding explicit date_sk range condition may prune micro-partitions earlier, addressing the largest hotspot (460GB web_sales scan). Residual OR conditions remain as join filters due to semantic risks.",
    "expected_explain_delta": "Filter on ws_sold_date_sk appears before web_sales scan, reducing partitions read; join structure unchanged.",
    "target_ir": "Add date_range CTE and modify final_select WHERE clause.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_range", "web_sales", "web_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
          "outputs": ["SUBSTRING(r_reason_desc, 1, 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "WITH date_range AS (\n  SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk\n  FROM date_dim\n  WHERE d_year = 2002\n)\nSELECT substring(r_reason_desc,1,20),\n       avg(ws_quantity),\n       avg(wr_refunded_cash),\n       avg(wr_fee)\nFROM web_sales, web_returns, web_page, customer_demographics cd1,\n     customer_demographics cd2, customer_address, date_dim, reason, date_range\nWHERE ws_web_page_sk = wp_web_page_sk\n  AND ws_item_sk = wr_item_sk\n  AND ws_order_number = wr_order_number\n  AND ws_sold_date_sk = d_date_sk\n  AND d_year = 2002\n  AND cd1.cd_demo_sk = wr_refunded_cdemo_sk\n  AND cd2.cd_demo_sk = wr_returning_cdemo_sk\n  AND ca_address_sk = wr_refunded_addr_sk\n  AND r_reason_sk = wr_reason_sk\n  AND ws_sold_date_sk BETWEEN date_range.min_sk AND date_range.max_sk\n  AND (\n    (\n     cd1.cd_marital_status = 'S'\n     AND cd1.cd_marital_status = cd2.cd_marital_status\n     AND cd1.cd_education_status = 'Primary'\n     AND cd1.cd_education_status = cd2.cd_education_status\n     AND ws_sales_price BETWEEN 100.00 AND 150.00\n    )\n   OR\n    (\n     cd1.cd_marital_status = 'M'\n     AND cd1.cd_marital_status = cd2.cd_marital_status\n     AND cd1.cd_education_status = 'Secondary'\n     AND cd1.cd_education_status = cd2.cd_education_status\n     AND ws_sales_price BETWEEN 50.00 AND 100.00\n    )\n   OR\n    (\n     cd1.cd_marital_status = 'U'\n     AND cd1.cd_marital_status = cd2.cd_marital_status\n     AND cd1.cd_education_status = '2 yr Degree'\n     AND cd1.cd_education_status = cd2.cd_education_status\n     AND ws_sales_price BETWEEN 150.00 AND 200.00\n    )\n   )\n   AND (\n    (\n     ca_country = 'United States'\n     AND ca_state IN ('KY', 'NC', 'SD')\n     AND ws_net_profit BETWEEN 100 AND 200\n    )\n    OR\n    (\n     ca_country = 'United States'\n     AND ca_state IN ('AR', 'GA', 'IN')\n     AND ws_net_profit BETWEEN 150 AND 300\n    )\n    OR\n    (\n     ca_country = 'United States'\n     AND ca_state IN ('KS', 'OH', 'VA')\n     AND ws_net_profit BETWEEN 50 AND 250\n    )\n   )\nGROUP BY r_reason_desc\nORDER BY substring(r_reason_desc,1,20),\n         avg(ws_quantity),\n         avg(wr_refunded_cash),\n         avg(wr_fee)\nLIMIT 100"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["min_sk", "max_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk FROM date_dim WHERE d_year = 2002"
        }
      ]
    }
  }
]