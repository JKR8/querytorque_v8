{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering date_dim, item, and warehouse into CTEs before joining with pre-aggregated fact improves join order and cardinality estimates.",
  "reasoning_trace": [
    "Assigned transform targets prefetch of selective dimensions to improve join planning.",
    "Dimension filters are preserved and pushed into dedicated CTEs.",
    "Join order now starts with smaller dimension scans, reducing intermediate row count."
  ],
  "target_ir": "date_dim, item, warehouse become prefetched CTEs; catalog_sales aggregation becomes a separate CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["sales_agg", "dim_date_prefetch", "dim_item_prefetch", "dim_warehouse_prefetch"],
        "outputs": ["w_state", "i_item_id", "sales_before", "sales_after"],
        "changed": true,
        "sql": "SELECT w.w_state, i.i_item_id, sales_before, sales_after FROM sales_agg s JOIN dim_warehouse_prefetch w ON s.w_warehouse_sk = w.w_warehouse_sk JOIN dim_item_prefetch i ON s.i_item_sk = i.i_item_sk JOIN dim_date_prefetch d ON s.d_date_sk = d.d_date_sk ORDER BY w_state, i_item_id LIMIT 100"
      },
      {
        "node_id": "sales_agg",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "catalog_returns"],
        "outputs": ["w_warehouse_sk", "i_item_sk", "d_date_sk", "sales_before", "sales_after"],
        "changed": true,
        "sql": "SELECT cs.cs_warehouse_sk AS w_warehouse_sk, cs.cs_item_sk AS i_item_sk, cs.cs_sold_date_sk AS d_date_sk, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_date BETWEEN (CAST('2002-02-19' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-19' AS DATE) + INTERVAL '30 day') AND cs.cs_wholesale_cost BETWEEN 42 AND 61 AND cr.cr_reason_sk = 33 GROUP BY cs.cs_warehouse_sk, cs.cs_item_sk, cs.cs_sold_date_sk"
      },
      {
        "node_id": "dim_date_prefetch",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '2002-01-20' AND '2002-03-21'"
      },
      {
        "node_id": "dim_item_prefetch",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_item_id"],
        "changed": true,
        "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Jewelry' AND i_manager_id BETWEEN 61 AND 100"
      },
      {
        "node_id": "dim_warehouse_prefetch",
        "parent_node_id": "final_select",
        "sources": ["warehouse"],
        "outputs": ["w_warehouse_sk", "w_state"],
        "changed": true,
        "sql": "SELECT w_warehouse_sk, w_state FROM warehouse"
      }
    ]
  }
}