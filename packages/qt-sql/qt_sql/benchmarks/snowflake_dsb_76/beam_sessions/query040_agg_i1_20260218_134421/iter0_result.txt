{
  "iteration": 0,
  "n_api_calls": 3,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 3,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 1.21,
  "best_patch_id": "p03",
  "best_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales inner join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
  "patches": [
    {
      "patch_id": "p07",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.5,
      "status": "NEUTRAL",
      "speedup": 1.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.8,
      "patch_ms": 169.7,
      "output_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push date_sk range into fact scan using scalar subqueries, similar to p01 but using UNION ALL pattern (though query has no UNION)."
    },
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "IMPROVED",
      "speedup": 1.07,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.8,
      "patch_ms": 158.9,
      "output_sql": "WITH pre_aggregate AS (SELECT cs.cs_item_sk, cs.cs_order_number, cs.cs_warehouse_sk, cs.cs_sold_date_sk, SUM(cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0)) AS net_price FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cs.cs_wholesale_cost BETWEEN 42 AND 61 AND (cr.cr_reason_sk = 33 OR cr.cr_reason_sk IS NULL) GROUP BY cs.cs_item_sk, cs.cs_order_number, cs.cs_warehouse_sk, cs.cs_sold_date_sk) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate catalog_sales and catalog_returns by (cs_item_sk, cs_order_number, cs_warehouse_sk, cs_sold_date_sk) before joining with dimensions."
    },
    {
      "patch_id": "p05",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.5,
      "status": "NEUTRAL",
      "speedup": 1.04,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.8,
      "patch_ms": 163.2,
      "output_sql": "WITH date_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-19' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-19' AS DATE) + INTERVAL '30 day')), main_query AS (SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-19' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-19' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM date_filtered d JOIN catalog_sales cs ON cs.cs_sold_date_sk = d.d_date_sk JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE i.i_category = 'Jewelry' AND i.i_manager_id BETWEEN 61 AND 100 AND cs.cs_wholesale_cost BETWEEN 42 AND 61 AND cr.cr_reason_sk = 33 GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit JOIN syntax and isolate date_dim filter into CTE."
    },
    {
      "patch_id": "p06",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.6,
      "status": "IMPROVED",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.8,
      "patch_ms": 161.5,
      "output_sql": "WITH aggregated_sales AS (SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON (cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk) JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN item i ON i.i_item_sk = cs.cs_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_date BETWEEN (CAST('2002-02-19' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-19' AS DATE) + INTERVAL '30 day') AND i.i_category = 'Jewelry' AND i.i_manager_id BETWEEN 61 AND 100 AND cs.cs_wholesale_cost BETWEEN 42 AND 61 AND cr.cr_reason_sk = 33 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate two-stage aggregation into single GROUP BY with conditional sums directly."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": null,
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Add explicit cs_sold_date_sk BETWEEN range derived from date_dim filter to CATALOG_SALES scan predicate."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.9,
      "status": "WIN",
      "speedup": 1.21,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.8,
      "patch_ms": 140.3,
      "output_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales inner join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert LEFT OUTER JOIN catalog_returns to INNER JOIN since cr_reason_sk=33 filter eliminates NULL rows."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH sales_agg AS (SELECT cs.cs_warehouse_sk AS w_warehouse_sk, cs.cs_item_sk AS i_item_sk, cs.cs_sold_date_sk AS d_date_sk, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-19' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_date BETWEEN (CAST('2002-02-19' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-19' AS DATE) + INTERVAL '30 day') AND cs.cs_wholesale_cost BETWEEN 42 AND 61 AND cr.cr_reason_sk = 33 GROUP BY cs.cs_warehouse_sk, cs.cs_item_sk, cs.cs_sold_date_sk), dim_date_prefetch AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '2002-01-20' AND '2002-03-21'), dim_item_prefetch AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Jewelry' AND i_manager_id BETWEEN 61 AND 100), dim_warehouse_prefetch AS (SELECT w_warehouse_sk, w_state FROM warehouse) SELECT w.w_state, i.i_item_id, sales_before, sales_after FROM sales_agg s JOIN dim_warehouse_prefetch w ON s.w_warehouse_sk = w.w_warehouse_sk JOIN dim_item_prefetch i ON s.i_item_sk = i.i_item_sk JOIN dim_date_prefetch d ON s.d_date_sk = d.d_date_sk ORDER BY w_state, i_item_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim, item, warehouse into separate CTEs and join with pre-aggregated fact CTE."
    },
    {
      "patch_id": "p08",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.45,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": null,
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-19' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-19' as date) - interval '30 day')\n                and (cast ('2002-02-19' as date) + interval '30 day') \n and i_category  = 'Jewelry'\n and i_manager_id between 61 and 100\n and cs_wholesale_cost between 42 and 61\n and cr_reason_sk = 33\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered date_dim keys in a CTE to potentially improve join performance."
    }
  ],
  "explains": {
    "p07": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p02": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p05": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p06": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p03": "GlobalStats | 59685 | 59685 | 1006176229376\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-19', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | "
  }
}