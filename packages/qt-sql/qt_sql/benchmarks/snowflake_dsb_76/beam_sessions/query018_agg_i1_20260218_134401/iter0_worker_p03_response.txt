{
  "probe_id": "scout_dimension_cte_isolate",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating filtered dimension tables into CTEs reduces repeated scan costs and enables Snowflake to optimize join planning with small hash tables.",
  "reasoning_trace": [
    "Assigned transform targets dimension tables for CTE isolation while preserving all filters and join keys.",
    "Each dimension CTE includes only required surrogate keys and strict filters, ensuring minimal row output.",
    "Join structure remains unchanged; only source nodes shift from table scans to CTE references."
  ],
  "target_ir": "date_dim, item, customer_demographics, customer, and customer_address become filtered CTEs; catalog_sales joins unchanged.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["agg_result"],
        "outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"],
        "changed": false
      },
      {
        "node_id": "agg_result",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "date_dim_cte", "item_cte", "customer_demographics_cte", "customer_cte", "customer_address_cte"],
        "outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"],
        "changed": true,
        "sql": "SELECT i.i_item_id, ca.ca_country, ca.ca_state, ca.ca_county, AVG(CAST(cs.cs_quantity AS DECIMAL(12,2))) AS agg1, AVG(CAST(cs.cs_list_price AS DECIMAL(12,2))) AS agg2, AVG(CAST(cs.cs_coupon_amt AS DECIMAL(12,2))) AS agg3, AVG(CAST(cs.cs_sales_price AS DECIMAL(12,2))) AS agg4, AVG(CAST(cs.cs_net_profit AS DECIMAL(12,2))) AS agg5, AVG(CAST(c.c_birth_year AS DECIMAL(12,2))) AS agg6 FROM catalog_sales cs JOIN date_dim_cte d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item_cte i ON cs.cs_item_sk = i.i_item_sk JOIN customer_demographics_cte cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN customer_cte c ON cs.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address_cte ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cs.cs_wholesale_cost BETWEEN 41 AND 46 GROUP BY ROLLUP (i.i_item_id, ca.ca_country, ca.ca_state, ca.ca_county) ORDER BY ca.ca_country, ca.ca_state, ca.ca_county, i.i_item_id LIMIT 100"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "agg_result",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998"
      },
      {
        "node_id": "item_cte",
        "parent_node_id": "agg_result",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_item_id"],
        "changed": true,
        "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Sports'"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "agg_result",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = 'College'"
      },
      {
        "node_id": "customer_cte",
        "parent_node_id": "agg_result",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_current_addr_sk", "c_birth_year"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_month = 2"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "agg_result",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state", "ca_county"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_country, ca_state, ca_county FROM customer_address WHERE ca_state IN ('AR', 'NY', 'TX')"
      }
    ]
  }
}