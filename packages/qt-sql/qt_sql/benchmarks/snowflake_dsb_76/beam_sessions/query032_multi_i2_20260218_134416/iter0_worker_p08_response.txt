{
  "probe_id": "scout_001",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Materializing a filtered date_dim CTE will allow reuse across both the outer query and the correlated subquery, reducing I/O by eliminating one full scan of date_dim.",
  "reasoning_trace": [
    "Two scans of DATE_DIM detected in execution plan at [1.10] and [1.21].",
    "Both scans apply identical filter: d_date between '2001-02-23' and cast('2001-02-23' as date) + interval '90 day'.",
    "Creating a CTE for this filtered date range enables reuse and reduces redundant I/O."
  ],
  "target_ir": "Introduce CTE `filtered_date_range` to encapsulate date_dim scan; replace both inline date_dim references with CTE reference.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["main_query"],
        "outputs": ["excess discount amount"],
        "changed": false
      },
      {
        "node_id": "main_query",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "item", "filtered_date_range"],
        "outputs": ["excess discount amount"],
        "changed": true,
        "sql": "WITH filtered_date_range AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_date BETWEEN '2001-02-23' AND DATEADD(day, 90, '2001-02-23')\n)\nSELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\"\nFROM catalog_sales, item, filtered_date_range\nWHERE (i_manufact_id IN (184, 307, 365, 560, 681)\n       OR i_manager_id BETWEEN 42 AND 71)\n  AND i_item_sk = cs_item_sk\n  AND d_date_sk = cs_sold_date_sk\n  AND cs_ext_discount_amt > (\n    SELECT 1.3 * AVG(cs_ext_discount_amt)\n    FROM catalog_sales, filtered_date_range\n    WHERE cs_item_sk = i_item_sk\n      AND d_date_sk = cs_sold_date_sk\n      AND cs_list_price BETWEEN 115 AND 144\n      AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41\n  )\nORDER BY SUM(cs_ext_discount_amt)\nLIMIT 100"
      }
    ]
  }
}