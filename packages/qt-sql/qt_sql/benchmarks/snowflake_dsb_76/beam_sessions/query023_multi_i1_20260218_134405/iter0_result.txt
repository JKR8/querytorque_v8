{
  "iteration": 0,
  "n_api_calls": 12,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 12,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 2.62,
  "best_patch_id": "p02",
  "best_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (WITH max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) tmp1) SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
  "patches": [
    {
      "patch_id": "p09",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.45,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Isolate date_dim filter (d_year=1998) into a CTE returning only d_date_sk, then join with store_sales in all three contexts."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "WIN",
      "speedup": 2.28,
      "semantic_passed": true,
      "error": null,
      "original_ms": 579.7,
      "patch_ms": 253.7,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (WITH preagg_store_sales AS (SELECT ss_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales WHERE ss_wholesale_cost BETWEEN 11 AND 21 AND ss_sold_date_sk IS NOT NULL AND ss_customer_sk IS NOT NULL GROUP BY ss_customer_sk) SELECT MAX(csales) tpcds_cmax FROM (SELECT c_customer_sk, csales FROM preagg_store_sales ps JOIN customer c ON ps.ss_customer_sk = c.c_customer_sk JOIN date_dim d ON ps.ss_customer_sk = ps.ss_customer_sk AND d.d_year = 1998) tmp1), best_ss_customer AS (WITH preagg_store_sales AS (SELECT ss_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales WHERE ss_customer_sk IS NOT NULL GROUP BY ss_customer_sk) SELECT c.c_customer_sk, ps.ssales FROM preagg_store_sales ps JOIN customer c ON ps.ss_customer_sk = c.c_customer_sk WHERE c.c_birth_year BETWEEN 1934 AND 1940 AND ps.ssales > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate store_sales by customer_sk before joining with customer in max_store_sales and best_ss_customer CTEs."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.88,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1998) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1998) GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1998) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1998) GROUP BY c_customer_sk) tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk WHERE c_birth_year BETWEEN 1934 AND 1940 AND ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 1998) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 1998) GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Push date_sk BETWEEN derived from d_year=1998 into all store_sales scans (three CTEs) via explicit join condition."
    },
    {
      "patch_id": "p06",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.55,
      "status": "WIN",
      "speedup": 2.14,
      "semantic_passed": true,
      "error": null,
      "original_ms": 579.7,
      "patch_ms": 270.3,
      "output_sql": "WITH frequent_ss_items AS (WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998), filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports')) SELECT substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt FROM store_sales, filtered_date_dim, filtered_item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk GROUP BY substring(i_item_desc,1,30),i_item_sk,d_date HAVING count(*) > 4), max_store_sales AS (WITH filtered_date_dim_2 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998), filtered_customer AS (SELECT c_customer_sk FROM customer WHERE c_birth_year BETWEEN 1934 AND 1940) SELECT max(csales) tpcds_cmax FROM (SELECT c_customer_sk,sum(ss_quantity*ss_sales_price) csales FROM store_sales, filtered_customer, filtered_date_dim_2 WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) tmp1), best_ss_customer AS (WITH filtered_customer AS (SELECT c_customer_sk FROM customer WHERE c_birth_year BETWEEN 1934 AND 1940) SELECT c_customer_sk,sum(ss_quantity*ss_sales_price) ssales FROM store_sales, filtered_customer WHERE ss_customer_sk = c_customer_sk GROUP BY c_customer_sk HAVING sum(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim, item, and customer into separate CTEs before joining with store_sales to reduce fact scan rows via early key reduction."
    },
    {
      "patch_id": "p02",
      "family": "B",
      "transform": "sf_inline_decorrelate",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 2.62,
      "semantic_passed": true,
      "error": null,
      "original_ms": 579.7,
      "patch_ms": 221.4,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (WITH max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) tmp1) SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Decorrelate scalar subquery (max_store_sales) in best_ss_customer by extracting threshold into a separate CTE and joining via key."
    },
    {
      "patch_id": "p08",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998), filtered_item AS (SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports')) SELECT substring(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, count(*) cnt FROM store_sales JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk JOIN filtered_item ON ss_item_sk = i_item_sk JOIN item ON i_item_sk = ss_item_sk JOIN date_dim ON d_date_sk = ss_sold_date_sk WHERE d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Stage join pipeline: filter date_dim and item first, join with store_sales to produce frequent_ss_items keyset, then join with customer for best_ss_customer."
    },
    {
      "patch_id": "p10",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.4,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create shared date_dim CTE for catalog_sales and web_sales UNION branches to avoid redundant date_dim scans."
    },
    {
      "patch_id": "p07",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), merged_store_sales_agg AS (select c_customer_sk,\n       sum(ss_quantity*ss_sales_price) as csales,\n       case when c_birth_year BETWEEN 1934 AND 1940 then sum(ss_quantity*ss_sales_price) else null end as ssales,\n       case when sum(ss_quantity*ss_sales_price) > (0.95 * max(sum(ss_quantity*ss_sales_price)) over ()) then 1 else 0 end as is_best_customer\nfrom store_sales\n    ,customer\n    ,date_dim\nwhere ss_customer_sk = c_customer_sk\n  and ss_sold_date_sk = d_date_sk\n  and d_year = 1998\n  and ss_wholesale_cost BETWEEN 11 AND 21\ngroup by c_customer_sk, c_birth_year) select  sum(sales)\nfrom (select cs_quantity*cs_list_price sales\n      from catalog_sales\n          ,date_dim\n      where d_year = 1998\n        and d_moy = 10\n        and cs_sold_date_sk = d_date_sk\n        and cs_item_sk in (select item_sk from frequent_ss_items)\n        and cs_bill_customer_sk in (select c_customer_sk from merged_store_sales_agg where is_best_customer = 1)\n        and cs_wholesale_cost BETWEEN 11 AND 21\n     union all\n     select ws_quantity*ws_list_price sales\n      from web_sales\n          ,date_dim\n      where d_year = 1998\n        and d_moy = 10\n        and ws_sold_date_sk = d_date_sk\n        and ws_item_sk in (select item_sk from frequent_ss_items)\n        and ws_bill_customer_sk in (select c_customer_sk from merged_store_sales_agg where is_best_customer = 1)\n        and ws_wholesale_cost BETWEEN 11 AND 21) tmp2\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate multiple store_sales aggregations (max_store_sales and best_ss_customer) into a single CTE that computes both csales and ssales per customer."
    },
    {
      "patch_id": "p05",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.7,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH frequent_ss_items AS (WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc,1,30), i_item_sk, d_date HAVING COUNT(*) > 4) SELECT * FROM frequent_ss_items), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (WITH best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)) SELECT * FROM best_ss_customer) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize frequent_ss_items and best_ss_customer CTEs to avoid recomputation (each referenced twice)."
    },
    {
      "patch_id": "p12",
      "family": "B",
      "transform": "sf_shared_scan_decorrelate",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create shared store_sales CTE for max_store_sales and best_ss_customer to avoid scanning store_sales twice for same filters."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.9,
      "status": "WIN",
      "speedup": 2.6,
      "semantic_passed": true,
      "error": null,
      "original_ms": 579.7,
      "patch_ms": 222.9,
      "output_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) select  sum(sales)\n from (select cs_quantity*cs_list_price sales\n       from catalog_sales\n           ,date_dim\n       where d_year = 1998\n         and d_moy = 10\n         and cs_sold_date_sk = d_date_sk\n         and cs_item_sk in (select item_sk from frequent_ss_items)\n         and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and cs_wholesale_cost BETWEEN 11 AND 21\n         and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1998 and d_moy=10) and (select max(d_date_sk) from date_dim where d_year=1998 and d_moy=10)\n      union all\n      select ws_quantity*ws_list_price sales\n       from web_sales\n           ,date_dim\n       where d_year = 1998\n         and d_moy = 10\n         and ws_sold_date_sk = d_date_sk\n         and ws_item_sk in (select item_sk from frequent_ss_items)\n         and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and ws_wholesale_cost BETWEEN 11 AND 21\n         and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_year=1998 and d_moy=10) and (select max(d_date_sk) from date_dim where d_year=1998 and d_moy=10)) tmp2\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push date_sk BETWEEN derived from date_dim filters (d_year=1998, d_moy=10) into catalog_sales and web_sales scans in the UNION ALL branches of final_select."
    },
    {
      "patch_id": "p11",
      "family": "C",
      "transform": "channel_bitmap_aggregation",
      "relevance_score": 0.35,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH merged_sales AS (SELECT cs_quantity * cs_list_price AS sales, 'catalog' AS channel FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 1998 AND d_moy = 10 AND cs_wholesale_cost BETWEEN 11 AND 21 AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) UNION ALL SELECT ws_quantity * ws_list_price AS sales, 'web' AS channel FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 1998 AND d_moy = 10 AND ws_wholesale_cost BETWEEN 11 AND 21 AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)), frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)) SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales, date_dim WHERE d_year = 1998 AND d_moy = 10 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) AS tmp2 LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate catalog_sales and web_sales UNION branches into a single scan with channel labeling and conditional aggregation."
    }
  ],
  "explains": {
    "p03": "GlobalStats | 301183 | 296571 | 5066529012224\n1 | 0 | Result | MAX(MAX(MAX(MAX(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))\n1 | 1 | [0] | Aggregate | aggExprs: [MAX(MAX(MAX(MAX(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))]\n1 | 2 | [1] | Aggregate | aggExprs: [MAX(MAX(MAX(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE)))))]\n1 | 3 | [2] | CartesianJoin\n1 | 4 | [3] | Aggregate | groupKeys: [1]\n1 | 5 | [4] | Filter | D.D_YEAR = 1998\n1 | 6 | [5] ",
    "p06": "GlobalStats | 301183 | 296571 | 5066529012224\n1 | 0 | Result | MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))\n1 | 1 | [0] | Aggregate | aggExprs: [MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))]\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE)))))], groupKeys: [CUSTOMER.C_CUSTOMER_SK]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE",
    "p02": "GlobalStats | 301183 | 298877 | 5105824844800\n1 | 0 | Result | MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))\n1 | 1 | [0] | Aggregate | aggExprs: [MAX(SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE))))))]\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE_SALES.SS_SALES_PRICE)))))], groupKeys: [CUSTOMER.C_CUSTOMER_SK]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(SUM((STORE_SALES.SS_QUANTITY) * (STORE",
    "p01": "GlobalStats | 301185 | 298673 | 5102311021056\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 10)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_"
  }
}