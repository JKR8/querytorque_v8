{
  "probe_id": "p05",
  "transform_id": "early_filter",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Introducing CTEs to pre-filter CUSTOMER_ADDRESS and INCOME_BAND reduces data flow into large table scans, preserving all output semantics while enabling earlier pruning.",
  "reasoning_trace": [
    "Assigned transform targets early application of CA_CITY and IB bounds in CTEs.",
    "Pre-filtering CUSTOMER_ADDRESS and INCOME_BAND aligns with analyst hypothesis and engine strengths.",
    "CTEs are single-use and inline-friendly per G_SF_CTE_REUSE_RULE:PASS.",
    "No function wrapping of filter keys preserves micro-partition pruning."
  ],
  "target_ir": "Introduce ca_filtered and ib_filtered CTEs; join with remaining tables preserving original order and filters.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["ca_filtered", "ib_filtered", "customer", "customer_demographics", "household_demographics", "store_returns"],
        "outputs": ["customer_id", "customername"],
        "changed": true,
        "sql": "select  c_customer_id as customer_id\n       , coalesce(c_last_name,'') || ', ' || coalesce(c_first_name,'') as customername\n from customer\n     ,customer_address ca_filtered\n     ,customer_demographics\n     ,household_demographics\n     ,income_band ib_filtered\n     ,store_returns\n where ca_city = 'Jackson'\n   and c_current_addr_sk = ca_address_sk\n   and ib_lower_bound >= 23567\n   and ib_upper_bound <= 23567 + 50000\n   and ib_income_band_sk = hd_income_band_sk\n   and cd_demo_sk = c_current_cdemo_sk\n   and hd_demo_sk = c_current_hdemo_sk\n   and sr_cdemo_sk = cd_demo_sk\n order by c_customer_id\n limit 100"
      },
      {
        "node_id": "ca_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_city"],
        "changed": true,
        "sql": "select ca_address_sk, ca_city from customer_address where ca_city = 'Jackson'"
      },
      {
        "node_id": "ib_filtered",
        "parent_node_id": "final_select",
        "sources": ["income_band"],
        "outputs": ["ib_income_band_sk", "ib_lower_bound", "ib_upper_bound"],
        "changed": true,
        "sql": "select ib_income_band_sk, ib_lower_bound, ib_upper_bound from income_band where ib_lower_bound >= 23567 and ib_upper_bound <= 23567 + 50000"
      }
    ]
  }
}