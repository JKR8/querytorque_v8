{
  "probe_id": "p01",
  "transform_id": "sf_sk_pushdown_multi_fact",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Adding explicit date_sk BETWEEN predicates on store_sales and store_returns based on d2 date filter will enable micro-partition pruning and reduce scan pressure.",
  "reasoning_trace": [
    "Assigned transform targets predicate pushdown to reduce fact table scan size.",
    "Date filter d2.d_year=1999 and d2.d_moy=7 is selective and can be used to derive a date range.",
    "Derived date range is applied as BETWEEN predicate on ss_sold_date_sk and sr_returned_date_sk."
  ],
  "target_ir": "CTE 'date_range' computes d2 date bounds; store_sales and store_returns scans gain BETWEEN filters on date_sk columns.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_store_sales", "filtered_store_returns", "store", "d1", "d2"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "select \n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nfrom\n   filtered_store_sales\n  ,filtered_store_returns\n  ,store\n  ,d1\n  ,d2\nwhere\n    d2.d_year = 1999\nand d2.d_moy  = 7\nand ss_ticket_number = sr_ticket_number\nand ss_item_sk = sr_item_sk\nand ss_sold_date_sk   = d1.d_date_sk\nand sr_returned_date_sk   = d2.d_date_sk\nand ss_customer_sk = sr_customer_sk\nand ss_store_sk = s_store_sk\nand d1.d_date between (d2.d_date - interval '120 day')\n               and d2.d_date\ngroup by\n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\norder by s_store_name\n        ,s_company_id\n        ,s_street_number\n        ,s_street_name\n        ,s_street_type\n        ,s_suite_number\n        ,s_city\n        ,s_county\n        ,s_state\n        ,s_zip\nlimit 100"
      },
      {
        "node_id": "date_range",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
      },
      {
        "node_id": "filtered_store_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_range"],
        "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_customer_sk", "ss_store_sk", "ss_ticket_number"],
        "changed": true,
        "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, ss_ticket_number FROM store_sales WHERE ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_range) AND (SELECT MAX(d_date_sk) FROM date_range)"
      },
      {
        "node_id": "filtered_store_returns",
        "parent_node_id": "final_select",
        "sources": ["store_returns", "date_range"],
        "outputs": ["sr_returned_date_sk", "sr_item_sk", "sr_customer_sk", "sr_ticket_number"],
        "changed": true,
        "sql": "SELECT sr_returned_date_sk, sr_item_sk, sr_customer_sk, sr_ticket_number FROM store_returns WHERE sr_returned_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_range) AND (SELECT MAX(d_date_sk) FROM date_range)"
      },
      {
        "node_id": "d1",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      },
      {
        "node_id": "d2",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "store",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip"],
        "changed": false
      }
    ]
  }
}