{
  "iteration": 0,
  "n_api_calls": 3,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 2,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.75,
      "status": "REGRESSION",
      "speedup": 0.93,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.7,
      "patch_ms": 168.3,
      "output_sql": "WITH date_range_2000 AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2000), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns JOIN date_range_2000 ON sr_returned_date_sk BETWEEN date_range_2000.min_date_sk AND date_range_2000.max_date_sk WHERE sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add an explicit range on sr_returned_date_sk based on d_year=2000 by pre-computing min and max d_date_sk in a CTE and using it in the store_returns scan within the customer_total_return CTE."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "sf_inline_decorrelate",
      "relevance_score": 0.9,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.7,
      "patch_ms": 178.2,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk\n,sr_store_sk AS ctr_store_sk\n,sr_reason_sk AS ctr_reason_sk\n,SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return\nFROM store_returns\n,date_dim\nWHERE sr_returned_date_sk = d_date_sk\nAND d_year =2000\nAND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174\nGROUP BY sr_customer_sk\n,sr_store_sk, sr_reason_sk), avg_store_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) AS avg_total_return\nFROM customer_total_return\nGROUP BY ctr_store_sk), store_threshold AS (SELECT ctr_store_sk AS st_store_sk, avg_total_return * 1.2 AS threshold\nFROM avg_store_return), filtered_customers AS (SELECT ctr1.*\nFROM customer_total_return ctr1\nJOIN store_threshold st ON ctr1.ctr_store_sk = st.st_store_sk\nWHERE ctr1.ctr_total_return > st.threshold\nAND ctr1.ctr_reason_sk BETWEEN 17 AND 20) SELECT c_customer_id\nFROM filtered_customers ctr1\n,store\n,customer\n,customer_demographics\nWHERE s_store_sk = ctr1.ctr_store_sk\nAND s_state IN ('IA', 'KY', 'NE')\nAND ctr1.ctr_customer_sk = c_customer_sk\nAND c_current_cdemo_sk = cd_demo_sk\nAND cd_marital_status IN ('S', 'S')\nAND cd_education_status IN ('4 yr Degree', '4 yr Degree')\nAND cd_gender = 'M'\nAND c_birth_month = 4\nAND c_birth_year BETWEEN 1987 AND 1993\nORDER BY c_customer_id\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Decompose the correlated scalar subquery into three CTEs: a shared scan of customer_total_return, a per-store_sk threshold CTE computing avg(ctr_total_return)*1.2, and a filtered main query joining with the threshold."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.6,
      "status": "NEUTRAL",
      "speedup": 0.97,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.7,
      "patch_ms": 160.9,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND sr_reason_sk BETWEEN 17 AND 20 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push the filter ctr1.ctr_reason_sk BETWEEN 17 AND 20 into the CTE customer_total_return definition by adding sr_reason_sk BETWEEN 17 AND 20 to the WHERE clause, reducing rows early in the aggregation."
    },
    {
      "patch_id": "p03",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.81,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.7,
      "patch_ms": 193.0,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the CTE customer_total_return using Snowflake's MATERIALIZE hint or a temporary table to avoid recomputation since it is referenced multiple times (as ctr1 and ctr2)."
    }
  ],
  "explains": {
    "p02": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK)\n1 | 5 | [4] | Filter | STORE.S_STATE IN 'IA' IN 'KY' IN 'NE'\n1 | 6 |",
    "p01": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK), joinFilter: (CTR1.CTR_TOTAL_RETURN) > (((SUM(CUSTOMER_TOTAL_RETURN.",
    "p04": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK)\n1 | 5 | [4] | Filter | STORE.S_STATE IN 'IA' IN 'KY' IN 'NE'\n1 | 6 |",
    "p03": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK)\n1 | 5 | [4] | Filter | STORE.S_STATE IN 'IA' IN 'KY' IN 'NE'\n1 | 6 |"
  }
}