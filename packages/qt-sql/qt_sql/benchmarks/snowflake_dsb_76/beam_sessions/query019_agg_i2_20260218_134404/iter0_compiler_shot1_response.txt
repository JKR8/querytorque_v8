[
  {
    "plan_id": "compile_p01",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Date filter pushdown into fact scan via IN subquery to enable micro-partition pruning.",
    "hypothesis": "Probe p01 (1.72x) directly targets primary hotspot by pushing date_dim filter into store_sales scan, enabling Snowflake micro-partition pruning on ss_sold_date_sk.",
    "expected_explain_delta": "Store_sales scan shows reduced partitions; date_dim join becomes redundant or filter pushdown appears.",
    "target_ir": "Replace store_sales scan with filtered CTE, keep final_select join structure.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_dim", "ss_scan_with_pushdown", "item", "customer", "customer_address", "store"],
          "outputs": ["brand_id", "brand", "i_manufact_id", "i_manufact", "ext_price"],
          "changed": true,
          "sql": "SELECT i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact, SUM(ss.ss_ext_sales_price) AS ext_price FROM date_dim d, ss_scan_with_pushdown ss, item i, customer c, customer_address ca, store s WHERE d.d_date_sk = ss.ss_sold_date_sk AND ss.ss_item_sk = i.i_item_sk AND ss.ss_customer_sk = c.c_customer_sk AND c.c_current_addr_sk = ca.ca_address_sk AND ss.ss_store_sk = s.s_store_sk AND i.i_category = 'Shoes' AND d.d_year = 1999 AND d.d_moy = 2 AND SUBSTRING(ca.ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5) AND ca.ca_state = 'KS' AND c.c_birth_month = 2 GROUP BY i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact ORDER BY ext_price DESC, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact LIMIT 100"
        },
        {
          "node_id": "ss_scan_with_pushdown",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_customer_sk", "ss_store_sk", "ss_wholesale_cost", "ss_ext_sales_price"],
          "changed": true,
          "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, ss_wholesale_cost, ss_ext_sales_price FROM store_sales WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 2) AND ss_wholesale_cost BETWEEN 76 AND 96"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02",
    "dialect": "snowflake",
    "confidence": 0.80,
    "based_on": "p02",
    "strategy": "Early aggregation to reduce rows before dimension joins.",
    "hypothesis": "Probe p02 (1.51x) addresses secondary aggregation hotspot by pre-aggregating store_sales before joins, reducing intermediate row volume entering the join pipeline.",
    "expected_explain_delta": "Multiple aggregation stages collapse; fewer rows flow through join operators.",
    "target_ir": "Replace store_sales scan with pre-aggregated CTE, keep final_select join structure.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_dim", "ss_preagg", "item", "customer", "customer_address", "store"],
          "outputs": ["brand_id", "brand", "i_manufact_id", "i_manufact", "ext_price"],
          "changed": true,
          "sql": "SELECT i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact, SUM(ss.ss_ext_sales_price) AS ext_price FROM date_dim d, ss_preagg ss, item i, customer c, customer_address ca, store s WHERE d.d_date_sk = ss.ss_sold_date_sk AND ss.ss_item_sk = i.i_item_sk AND ss.ss_customer_sk = c.c_customer_sk AND c.c_current_addr_sk = ca.ca_address_sk AND ss.ss_store_sk = s.s_store_sk AND i.i_category = 'Shoes' AND d.d_year = 1999 AND d.d_moy = 2 AND SUBSTRING(ca.ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5) AND ca.ca_state = 'KS' AND c.c_birth_month = 2 GROUP BY i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact ORDER BY ext_price DESC, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact LIMIT 100"
        },
        {
          "node_id": "ss_preagg",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_customer_sk", "ss_store_sk", "ss_ext_sales_price"],
          "changed": true,
          "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price FROM store_sales WHERE ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p04",
    "dialect": "snowflake",
    "confidence": 0.83,
    "based_on": "p04",
    "strategy": "Explicit join syntax with selective dimension ordering.",
    "hypothesis": "Probe p04 (1.66x) converts implicit comma joins to explicit INNER JOIN and reorders joins to place selective dimensions early, improving join filter pushdown and cost-based join ordering.",
    "expected_explain_delta": "Join order changes; filter predicates may push deeper into join tree.",
    "target_ir": "Rewrite final_select with explicit joins and reordered join sequence.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_dim", "store_sales", "item", "customer", "customer_address", "store"],
          "outputs": ["brand_id", "brand", "i_manufact_id", "i_manufact", "ext_price"],
          "changed": true,
          "sql": "SELECT i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact, SUM(ss.ss_ext_sales_price) AS ext_price FROM date_dim d INNER JOIN store_sales ss ON d.d_date_sk = ss.ss_sold_date_sk INNER JOIN item i ON ss.ss_item_sk = i.i_item_sk INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN store s ON ss.ss_store_sk = s.s_store_sk WHERE i.i_category = 'Shoes' AND d.d_year = 1999 AND d.d_moy = 2 AND SUBSTRING(ca.ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5) AND ca.ca_state = 'KS' AND c.c_birth_month = 2 AND ss.ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact ORDER BY ext_price DESC, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact LIMIT 100"
        }
      ]
    }
  }
]