{
  "probe_id": "p03",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs reduces their scan size and creates small hash tables for efficient joins with the large fact table.",
  "reasoning_trace": [
    "Assigned transform targets early filtering of dimension tables to reduce I/O.",
    "Each dimension table has selective filters that can be pushed into dedicated CTEs.",
    "CTEs will contain only required surrogate keys, minimizing memory and network transfer.",
    "Join order may improve as smaller hash tables are built before probing the large fact table."
  ],
  "target_ir": "Each dimension table is isolated into a CTE with selective WHERE clauses; final query joins CTEs with fact table.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "date_dim_cte", "item_cte", "customer_cte", "customer_address_cte", "store_cte"],
        "outputs": ["brand_id", "brand", "i_manufact_id", "i_manufact", "ext_price"],
        "changed": true,
        "sql": "WITH date_dim_cte AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 1999 AND d_moy = 2\n),\nitem_cte AS (\n  SELECT i_item_sk, i_brand_id, i_brand, i_manufact_id, i_manufact\n  FROM item\n  WHERE i_category = 'Shoes'\n),\ncustomer_cte AS (\n  SELECT c_customer_sk, c_current_addr_sk\n  FROM customer\n  WHERE c_birth_month = 2\n),\ncustomer_address_cte AS (\n  SELECT ca_address_sk\n  FROM customer_address\n  WHERE ca_state = 'KS'\n),\nstore_cte AS (\n  SELECT s_store_sk, s_zip\n  FROM store\n)\nSELECT  i.i_brand_id AS brand_id, i.i_brand AS brand, i.i_manufact_id, i.i_manufact,\n        SUM(ss.ss_ext_sales_price) AS ext_price\nFROM store_sales ss\nJOIN date_dim_cte d ON ss.ss_sold_date_sk = d.d_date_sk\nJOIN item_cte i ON ss.ss_item_sk = i.i_item_sk\nJOIN customer_cte c ON ss.ss_customer_sk = c.c_customer_sk\nJOIN customer_address_cte ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN store_cte s ON ss.ss_store_sk = s.s_store_sk\nWHERE SUBSTRING(ca_zip, 1, 5) <> SUBSTRING(s.s_zip, 1, 5)\n  AND ss.ss_wholesale_cost BETWEEN 76 AND 96\ngroup by i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact\norder by ext_price desc, i.i_brand, i.i_brand_id, i.i_manufact_id, i.i_manufact\nlimit 100"
      },
      {
        "node_id": "store_sales",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_customer_sk", "ss_store_sk", "ss_wholesale_cost", "ss_ext_sales_price"],
        "changed": true,
        "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, ss_wholesale_cost, ss_ext_sales_price FROM store_sales"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": false
      },
      {
        "node_id": "item_cte",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_brand_id", "i_brand", "i_manufact_id", "i_manufact"],
        "changed": false
      },
      {
        "node_id": "customer_cte",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_current_addr_sk"],
        "changed": false
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": false
      },
      {
        "node_id": "store_cte",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_zip"],
        "changed": false
      }
    ]
  }
}