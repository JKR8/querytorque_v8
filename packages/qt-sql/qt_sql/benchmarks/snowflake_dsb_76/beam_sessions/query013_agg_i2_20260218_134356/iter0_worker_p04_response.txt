{
  "probe_id": "p12",
  "transform_id": "early_filter",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs reduces redundant scans and enables early pruning. Each dimension is filtered to only required keys and attributes before joining with STORE_SALES.",
  "reasoning_trace": [
    "Assigned transform targets early filtering of all dimension tables to reduce redundant scans.",
    "CTEs for each dimension table contain only surrogate keys and needed attributes, enabling efficient broadcast joins.",
    "Join filters remain intact; no semantic drift occurs as all original conditions are preserved.",
    "No unfiltered large CTEs introduced, satisfying analyst do-not-do constraints."
  ],
  "target_ir": "Each dimension table becomes a small filtered CTE; STORE_SALES joins these CTEs instead of raw tables.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_store_sales", "store_cte", "customer_demographics_cte", "household_demographics_cte", "customer_address_cte", "date_dim_cte"],
        "outputs": ["AVG(ss_quantity)", "AVG(ss_ext_sales_price)", "AVG(ss_ext_wholesale_cost)", "SUM(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM filtered_store_sales JOIN store_cte ON s_store_sk = ss_store_sk JOIN customer_demographics_cte ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics_cte ON hd_demo_sk = ss_hdemo_sk JOIN customer_address_cte ON ca_address_sk = ss_addr_sk JOIN date_dim_cte ON d_date_sk = ss_sold_date_sk"
      },
      {
        "node_id": "filtered_store_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales"],
        "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost", "ss_store_sk", "ss_cdemo_sk", "ss_hdemo_sk", "ss_addr_sk", "ss_sold_date_sk"],
        "changed": true,
        "sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_store_sk, ss_cdemo_sk, ss_hdemo_sk, ss_addr_sk, ss_sold_date_sk FROM store_sales"
      },
      {
        "node_id": "store_cte",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": true,
        "sql": "SELECT s_store_sk FROM store"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M','S','W') AND cd_education_status IN ('2 yr Degree','Primary')"
      },
      {
        "node_id": "household_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_dep_count"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3,1)"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA','KY','SD','AR','IN','VA','KS','OH','SD')"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_year FROM date_dim WHERE d_year = 2001"
      }
    ]
  }
}