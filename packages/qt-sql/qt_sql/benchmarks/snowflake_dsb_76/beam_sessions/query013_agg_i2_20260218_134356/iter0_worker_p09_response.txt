{
  "probe_id": "scout_1",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating dimension filters into CTEs reduces data movement and enables early pruning before joining with the large STORE_SALES table.",
  "reasoning_trace": [
    "Assigned transform targets dimension filtering to reduce join input size.",
    "Each dimension table is filtered on selective predicates and returns only required keys.",
    "New CTEs preserve all original WHERE conditions and join compatibility."
  ],
  "target_ir": "Each dimension table becomes a CTE with selective filters; STORE_SALES joins unchanged but now probes smaller hash tables.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales_filtered"],
        "outputs": ["AVG(ss_quantity)", "AVG(ss_ext_sales_price)", "AVG(ss_ext_wholesale_cost)", "SUM(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM store_sales_filtered"
      },
      {
        "node_id": "store_sales_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_cte", "customer_demographics_cte", "household_demographics_cte", "customer_address_cte", "date_dim_cte"],
        "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost"],
        "changed": true,
        "sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales ss JOIN store_cte s ON ss.ss_store_sk = s.s_store_sk JOIN date_dim_cte d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_demographics_cte cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN household_demographics_cte hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN customer_address_cte ca ON ss.ss_addr_sk = ca.ca_address_sk WHERE ( (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250) )"
      },
      {
        "node_id": "store_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": true,
        "sql": "SELECT s_store_sk FROM store"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M','S','W') AND cd_education_status IN ('2 yr Degree','Primary')"
      },
      {
        "node_id": "household_demographics_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_dep_count"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3,1)"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA','KY','SD','AR','IN','VA','KS','OH','SD')"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_year FROM date_dim WHERE d_year = 2001"
      }
    ]
  }
}