{
  "probe_id": "scout_001",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Materializing the filtered store_sales scan into a CTE reduces repeated scanning in the aggregation stack and may improve caching behavior in Snowflake.",
  "reasoning_trace": [
    "Assigned transform targets materialization of the store_sales scan to avoid repeated access.",
    "Node contract requires preservation of all filters and necessary columns for downstream joins.",
    "CTE insertion preserves WHERE semantics and allows reuse without duplicating scan cost."
  ],
  "target_ir": "store_sales scan moved into a CTE named 'filtered_store_sales'; root query references the CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_store_sales", "store", "customer_demographics", "household_demographics", "customer_address", "date_dim"],
        "outputs": ["AVG(ss_quantity)", "AVG(ss_ext_sales_price)", "AVG(ss_ext_wholesale_cost)", "SUM(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM filtered_store_sales ss, store s, customer_demographics cd, household_demographics hd, customer_address ca, date_dim d WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ((ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price between 100.00 and 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price between 50.00 and 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price between 150.00 and 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state in ('GA', 'KY', 'SD') AND ss_net_profit between 100 and 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state in ('AR', 'IN', 'VA') AND ss_net_profit between 150 and 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state in ('KS', 'OH', 'SD') AND ss_net_profit between 50 and 250))"
      },
      {
        "node_id": "filtered_store_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales"],
        "outputs": ["ss_sold_date_sk", "ss_cdemo_sk", "ss_hdemo_sk", "ss_addr_sk", "ss_store_sk", "ss_quantity", "ss_sales_price", "ss_ext_sales_price", "ss_ext_wholesale_cost", "ss_net_profit"],
        "changed": true,
        "sql": "WITH filtered_store_sales AS (SELECT * FROM store_sales WHERE ss_sales_price BETWEEN 50 AND 200 AND ss_net_profit BETWEEN 50 AND 300) SELECT * FROM filtered_store_sales"
      }
    ]
  }
}