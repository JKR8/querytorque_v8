{
  "probe_id": "scout_lane_materialize_cte",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Materializing the filtered join of web_sales and web_returns with date and demographic filters into a CTE reduces repeated subtree scans and enables reuse in downstream aggregations.",
  "reasoning_trace": [
    "Assigned transform targets the dominant I/O sources: web_sales (460GB) and web_returns (39GB).",
    "The current plan shows repeated scans and complex OR filters applied late, preventing effective pruning.",
    "Materializing the filtered fact join into a CTE aligns with Snowflake's CTE reuse and predicate pushdown strengths.",
    "Node contract requires preserving all filters and necessary columns for final aggregation; this is maintained."
  ],
  "target_ir": "Introduce a CTE named 'filtered_web_sales_returns' that encapsulates the join of web_sales and web_returns with all applicable filters. Reference this CTE in the main query.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_web_sales_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
        "outputs": ["substring(r_reason_desc,1,20)", "avg(ws_quantity)", "avg(wr_refunded_cash)", "avg(wr_fee)"],
        "changed": true,
        "sql": "SELECT substring(r.r_reason_desc,1,20)\n       ,avg(f.ws_quantity)\n       ,avg(f.wr_refunded_cash)\n       ,avg(f.wr_fee)\nFROM filtered_web_sales_returns f\nJOIN web_page wp ON f.ws_web_page_sk = wp.wp_web_page_sk\nJOIN customer_demographics cd1 ON cd1.cd_demo_sk = f.wr_refunded_cdemo_sk\nJOIN customer_demographics cd2 ON cd2.cd_demo_sk = f.wr_returning_cdemo_sk\nJOIN customer_address ca ON ca.ca_address_sk = f.wr_refunded_addr_sk\nJOIN date_dim d ON d.d_date_sk = f.ws_sold_date_sk\nJOIN reason r ON r.r_reason_sk = f.wr_reason_sk\nGROUP BY r.r_reason_desc\nORDER BY substring(r.r_reason_desc,1,20)\n        ,avg(f.ws_quantity)\n        ,avg(f.wr_refunded_cash)\n        ,avg(f.wr_fee)\nLIMIT 100"
      },
      {
        "node_id": "filtered_web_sales_returns",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "web_returns"],
        "outputs": [
          "ws_quantity",
          "wr_refunded_cash",
          "wr_fee",
          "ws_web_page_sk",
          "wr_refunded_cdemo_sk",
          "wr_returning_cdemo_sk",
          "wr_refunded_addr_sk",
          "ws_sold_date_sk",
          "wr_reason_sk"
        ],
        "changed": true,
        "sql": "WITH filtered_web_sales_returns AS (\n  SELECT ws.ws_quantity,\n         wr.wr_refunded_cash,\n         wr.wr_fee,\n         ws.ws_web_page_sk,\n         wr.wr_refunded_cdemo_sk,\n         wr.wr_returning_cdemo_sk,\n         wr.wr_refunded_addr_sk,\n         ws.ws_sold_date_sk,\n         wr.wr_reason_sk\n  FROM web_sales ws\n  JOIN web_returns wr\n    ON ws.ws_item_sk = wr.wr_item_sk\n   AND ws.ws_order_number = wr.wr_order_number\n  JOIN date_dim d\n    ON ws.ws_sold_date_sk = d.d_date_sk\n  JOIN customer_demographics cd1\n    ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk\n  JOIN customer_demographics cd2\n    ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk\n  WHERE d.d_year = 2000\n    AND (\n      (cd1.cd_marital_status = 'S'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = 'College'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 100.00 AND 150.00)\n      OR\n      (cd1.cd_marital_status = 'W'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = 'Unknown'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 50.00 AND 100.00)\n      OR\n      (cd1.cd_marital_status = 'M'\n       AND cd1.cd_marital_status = cd2.cd_marital_status\n       AND cd1.cd_education_status = 'Secondary'\n       AND cd1.cd_education_status = cd2.cd_education_status\n       AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)\n    )\n    AND (\n      (ca_country = 'United States'\n       AND ca_state IN ('NC', 'PA', 'TX')\n       AND ws_net_profit BETWEEN 100 AND 200)\n      OR\n      (ca_country = 'United States'\n       AND ca_state IN ('AR', 'CO', 'NY')\n       AND ws_net_profit BETWEEN 150 AND 300)\n      OR\n      (ca_country = 'United States'\n       AND ca_state IN ('IA', 'IL', 'TX')\n       AND ws_net_profit BETWEEN 50 AND 250)\n    )\n)"
      }
    ]
  }
}