{
  "probe_id": "scout_single_pass_aggregation",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Consolidating five conditional SUM(CASE...) expressions into a single aggregation with bucket index improves aggregation efficiency while preserving output semantics.",
  "reasoning_trace": [
    "Assigned transform targets aggregation logic consolidation.",
    "Original query computes five separate conditional sums over the same fact table scan.",
    "Rewrite introduces a single-pass bucketing step followed by pivot in outer query.",
    "Grouping keys and final projection remain unchanged to preserve output contract."
  ],
  "target_ir": "Inner aggregation computes bucket index and count; outer query pivots to final columns.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["pivot_buckets"],
        "outputs": [
          "SUBSTRING(w_warehouse_name, 1, 20)",
          "sm_type",
          "cc_name",
          "\"30 days\"",
          "\"31-60 days\"",
          "\"61-90 days\"",
          "\"91-120 days\"",
          "\">120 days\""
        ],
        "changed": true,
        "sql": "SELECT SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name, \"30 days\", \"31-60 days\", \"61-90 days\", \"91-120 days\", \">120 days\" FROM pivot_buckets ORDER BY SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name LIMIT 100"
      },
      {
        "node_id": "pivot_buckets",
        "parent_node_id": "final_select",
        "sources": ["bucketed_aggregation"],
        "outputs": [
          "SUBSTRING(w_warehouse_name, 1, 20)",
          "sm_type",
          "cc_name",
          "\"30 days\"",
          "\"31-60 days\"",
          "\"61-90 days\"",
          "\"91-120 days\"",
          "\">120 days\""
        ],
        "changed": true,
        "sql": "SELECT SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name, IFF(bucket_id = 0, bucket_count, 0) AS \"30 days\", IFF(bucket_id = 1, bucket_count, 0) AS \"31-60 days\", IFF(bucket_id = 2, bucket_count, 0) AS \"61-90 days\", IFF(bucket_id = 3, bucket_count, 0) AS \"91-120 days\", IFF(bucket_id = 4, bucket_count, 0) AS \">120 days\" FROM bucketed_aggregation"
      },
      {
        "node_id": "bucketed_aggregation",
        "parent_node_id": "pivot_buckets",
        "sources": ["catalog_sales", "warehouse", "ship_mode", "call_center", "date_dim"],
        "outputs": [
          "SUBSTRING(w_warehouse_name, 1, 20)",
          "sm_type",
          "cc_name",
          "bucket_id",
          "bucket_count"
        ],
        "changed": true,
        "sql": "SELECT SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name, IFF((cs_ship_date_sk - cs_sold_date_sk) <= 30, 0, IFF((cs_ship_date_sk - cs_sold_date_sk) > 30 AND (cs_ship_date_sk - cs_sold_date_sk) <= 60, 1, IFF((cs_ship_date_sk - cs_sold_date_sk) > 60 AND (cs_ship_date_sk - cs_sold_date_sk) <= 90, 2, IFF((cs_ship_date_sk - cs_sold_date_sk) > 90 AND (cs_ship_date_sk - cs_sold_date_sk) <= 120, 3, IFF((cs_ship_date_sk - cs_sold_date_sk) > 120, 4, NULL))))) AS bucket_id, COUNT(*) AS bucket_count FROM catalog_sales, warehouse, ship_mode, call_center, date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23 AND cs_ship_date_sk = d_date_sk AND cs_warehouse_sk = w_warehouse_sk AND cs_ship_mode_sk = sm_ship_mode_sk AND cs_call_center_sk = cc_call_center_sk AND cs_list_price BETWEEN 244 AND 273 AND sm_type = 'LIBRARY' AND cc_class = 'medium' AND w_gmt_offset = -5 GROUP BY SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name, bucket_id"
      }
    ]
  }
}