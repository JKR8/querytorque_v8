[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.7,
    "based_on": "p04",
    "strategy": "Convert comma joins to explicit INNER JOINs to unlock cost‑based reordering and predicate pushdown.",
    "hypothesis": "p04 failed with a syntax error (invalid identifier 'W_STATE'); corrected join condition fixes the error and allows the optimizer to reorder joins and push filters earlier.",
    "expected_explain_delta": "Join order may change; filter pushdown to store_sales and web_sales scans expected.",
    "target_ir": "Change final_select join shape to explicit INNER JOINs with corrected join predicate for store–warehouse state equality.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "cd_gender",
            "cd_marital_status",
            "cd_education_status",
            "hd_vehicle_count",
            "cnt"
          ],
          "changed": true,
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM store_sales INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk INNER JOIN date_dim d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk INNER JOIN web_sales ON web_sales.ws_item_sk = item.i_item_sk AND web_sales.ws_bill_customer_sk = customer.c_customer_sk INNER JOIN date_dim d2 ON web_sales.ws_sold_date_sk = d2.d_date_sk INNER JOIN inventory ON inventory.inv_item_sk = store_sales.ss_item_sk AND inventory.inv_date_sk = store_sales.ss_sold_date_sk AND inventory.inv_warehouse_sk = web_sales.ws_warehouse_sk INNER JOIN warehouse ON web_sales.ws_warehouse_sk = warehouse.w_warehouse_sk INNER JOIN store ON store.s_state = warehouse.w_state INNER JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk INNER JOIN household_demographics ON customer.c_current_hdemo_sk = household_demographics.hd_demo_sk INNER JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk WHERE d1.d_year = 1998 AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day') AND inventory.inv_quantity_on_hand >= store_sales.ss_quantity AND item.i_category IN ('Men', 'Shoes', 'Sports') AND item.i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98) AND customer_address.ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA') AND web_sales.ws_wholesale_cost BETWEEN 76 AND 96 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.6,
    "based_on": "p01,p03",
    "strategy": "Pre‑filter dimensions and compute date‑sk range in CTEs to prune fact‑table micro‑partitions early.",
    "hypothesis": "Unaddressed hotspot: store_sales (1.2TB) and web_sales (460GB) scans lack date‑sk pushdown. A date_range CTE derived from d1.d_year=1998 and d2.d_date BETWEEN … enables direct join on sold_date_sk, reducing I/O. Dimension filters are isolated in separate CTEs.",
    "expected_explain_delta": "Store_sales and web_sales scans should show reduced partitions/bytes; date_dim and dimension filters appear earlier.",
    "target_ir": "Add date_range, filtered_item, filtered_customer_address, filtered_store, filtered_warehouse CTEs; rewrite final_select to join through CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "cd_gender",
            "cd_marital_status",
            "cd_education_status",
            "hd_vehicle_count",
            "cnt"
          ],
          "changed": true,
          "sql": "WITH date_range AS (SELECT d1.d_date_sk AS d1_date_sk, d2.d_date_sk AS d2_date_sk FROM date_dim d1 JOIN date_dim d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day') WHERE d1.d_year = 1998), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)), filtered_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')), filtered_store AS (SELECT s_state FROM store), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM store_sales JOIN date_range ON store_sales.ss_sold_date_sk = date_range.d1_date_sk JOIN filtered_item i ON store_sales.ss_item_sk = i.i_item_sk JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk JOIN web_sales ON web_sales.ws_item_sk = i.i_item_sk AND web_sales.ws_bill_customer_sk = customer.c_customer_sk JOIN date_range dr2 ON web_sales.ws_sold_date_sk = dr2.d2_date_sk JOIN inventory ON inventory.inv_item_sk = store_sales.ss_item_sk AND inventory.inv_date_sk = store_sales.ss_sold_date_sk AND inventory.inv_warehouse_sk = web_sales.ws_warehouse_sk JOIN filtered_warehouse w ON web_sales.ws_warehouse_sk = w.w_warehouse_sk JOIN filtered_store s ON s.s_state = w.w_state JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk JOIN household_demographics ON customer.c_current_hdemo_sk = household_demographics.hd_demo_sk JOIN filtered_customer_address ca ON customer.c_current_addr_sk = ca.ca_address_sk WHERE inventory.inv_quantity_on_hand >= store_sales.ss_quantity AND web_sales.ws_wholesale_cost BETWEEN 76 AND 96 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt"
        }
      ]
    }
  }
]