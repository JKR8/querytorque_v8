{
  "probe_id": "p02",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating the most selective dimension (CUSTOMER_ADDRESS) into a CTE returning only CA_ADDRESS_SK for 'Mount Vernon' enables early pruning of STORE_RETURNS via semi-join or join-filter pushdown.",
  "reasoning_trace": [
    "Assigned transform targets CUSTOMER_ADDRESS as the most selective dimension with a strong filter (ca_city = 'Mount Vernon').",
    "Creating a CTE that returns only CA_ADDRESS_SK reduces data movement and enables efficient join with CUSTOMER.",
    "Join order can now start with the filtered customer set, improving downstream pruning opportunities."
  ],
  "target_ir": "customer_address_cte returns CA_ADDRESS_SK; customer joins with it; other dimensions follow; STORE_RETURNS is last.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_filtered", "customer_address_cte", "customer_demographics", "household_demographics", "income_band", "store_returns"],
        "outputs": ["customer_id", "customername"],
        "changed": true,
        "sql": "select  c_customer_id as customer_id\n       , coalesce(c_last_name,'') || ', ' || coalesce(c_first_name,'') as customername\n from customer_filtered c\n     ,customer_address_cte ca\n     ,customer_demographics cd\n     ,household_demographics hd\n     ,income_band ib\n     ,store_returns sr\n where c.c_current_addr_sk = ca.ca_address_sk\n   and ib.ib_lower_bound   >=  40374\n   and ib.ib_upper_bound   <=  90374\n   and ib.ib_income_band_sk = hd.hd_income_band_sk\n   and cd.cd_demo_sk = c.c_current_cdemo_sk\n   and hd.hd_demo_sk = c.c_current_hdemo_sk\n   and sr.sr_cdemo_sk = cd.cd_demo_sk\n order by c_customer_id\n limit 100"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": true,
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Mount Vernon'"
      },
      {
        "node_id": "customer_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_id", "c_first_name", "c_last_name", "c_current_addr_sk", "c_current_cdemo_sk", "c_current_hdemo_sk"],
        "changed": true,
        "sql": "SELECT c_customer_id, c_first_name, c_last_name, c_current_addr_sk, c_current_cdemo_sk, c_current_hdemo_sk FROM customer"
      },
      {
        "node_id": "customer_demographics",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics"
      },
      {
        "node_id": "household_demographics",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_income_band_sk"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_income_band_sk FROM household_demographics"
      },
      {
        "node_id": "income_band",
        "parent_node_id": "final_select",
        "sources": ["income_band"],
        "outputs": ["ib_income_band_sk", "ib_lower_bound", "ib_upper_bound"],
        "changed": true,
        "sql": "SELECT ib_income_band_sk, ib_lower_bound, ib_upper_bound FROM income_band"
      },
      {
        "node_id": "store_returns",
        "parent_node_id": "final_select",
        "sources": ["store_returns"],
        "outputs": ["sr_cdemo_sk"],
        "changed": true,
        "sql": "SELECT sr_cdemo_sk FROM store_returns"
      }
    ]
  }
}