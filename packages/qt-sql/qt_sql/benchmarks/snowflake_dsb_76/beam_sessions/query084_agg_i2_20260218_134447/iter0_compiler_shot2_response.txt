[
  {
    "plan_id": "compile_p03",
    "dialect": "snowflake",
    "confidence": 0.8,
    "based_on": "p03",
    "strategy": "Convert comma-joins to explicit INNER JOIN syntax to improve predicate propagation.",
    "hypothesis": "WIN probe p03 shows 1.14x speedup by converting comma-joins to explicit INNER JOIN while preserving original join order and filters. This syntactic change may unlock better predicate pushdown in Snowflake's optimizer.",
    "expected_explain_delta": "Same join topology but with explicit INNER JOIN operators, potentially enabling better filter propagation.",
    "target_ir": "Update final_select to use explicit INNER JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "customer_address", "customer_demographics", "household_demographics", "income_band", "store_returns"],
          "outputs": ["customer_id", "customername"],
          "changed": true,
          "sql": "SELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk INNER JOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk INNER JOIN income_band ib ON ib.ib_income_band_sk = hd.hd_income_band_sk INNER JOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk WHERE ca.ca_city = 'Mount Vernon' AND ib.ib_lower_bound >= 40374 AND ib.ib_upper_bound <= 90374 ORDER BY c.c_customer_id LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_cte_prefilter",
    "dialect": "snowflake",
    "confidence": 0.65,
    "based_on": "p01,p02,p04",
    "strategy": "Pre-filter dimension keys into CTE to enable micro-partition pruning on STORE_RETURNS scan.",
    "hypothesis": "Failed probes p01, p02, p04 attempted dimension pre-filtering but had syntax errors. This safe version isolates filtered dimension keys (customer_demographics) to push cd_demo_sk filter into STORE_RETURNS scan, targeting the 124GB residual hotspot.",
    "expected_explain_delta": "STORE_RETURNS scan should show reduced partitions via pushed-down semi-join on cd_demo_sk from pre-filtered dimension CTE.",
    "target_ir": "Add filtered_dims CTE and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_dims", "store_returns"],
          "outputs": ["customer_id", "customername"],
          "changed": true,
          "sql": "SELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM filtered_dims c INNER JOIN store_returns sr ON sr.sr_cdemo_sk = c.cd_demo_sk ORDER BY c.c_customer_id LIMIT 100"
        },
        {
          "node_id": "filtered_dims",
          "parent_node_id": "final_select",
          "sources": ["customer", "customer_address", "customer_demographics", "household_demographics", "income_band"],
          "outputs": ["c_customer_id", "c_first_name", "c_last_name", "cd_demo_sk"],
          "changed": true,
          "sql": "SELECT c.c_customer_id, c.c_first_name, c.c_last_name, cd.cd_demo_sk FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk INNER JOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk INNER JOIN income_band ib ON ib.ib_income_band_sk = hd.hd_income_band_sk WHERE ca.ca_city = 'Mount Vernon' AND ib.ib_lower_bound >= 40374 AND ib.ib_upper_bound <= 90374"
        }
      ]
    }
  }
]