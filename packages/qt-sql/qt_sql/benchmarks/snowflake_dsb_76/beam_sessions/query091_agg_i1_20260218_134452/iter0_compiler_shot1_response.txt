[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.7,
    "based_on": "p01,p02",
    "strategy": "Date pushdown via range predicate and early aggregation.",
    "hypothesis": "Push date filter to fact table via date_sk range derived from DATE_DIM, then pre‑aggregate by join keys. Removes the need for a join with DATE_DIM and prunes micro‑partitions on CATALOG_RETURNS early.",
    "expected_explain_delta": "Eliminate DATE_DIM join and push date filter to fact table scan; reduce fact table rows via pre‑aggregation before dimension joins.",
    "target_ir": "Add date_range and preagg_catalog_returns nodes, remove date_dim join.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_range", "preagg_catalog_returns", "call_center", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH date_range AS (SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2), preagg_catalog_returns AS (SELECT cr_call_center_sk, cr_returning_customer_sk, SUM(cr_net_loss) AS cr_net_loss FROM catalog_returns WHERE cr_returned_date_sk BETWEEN (SELECT min_sk FROM date_range) AND (SELECT max_sk FROM date_range) GROUP BY cr_call_center_sk, cr_returning_customer_sk) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM call_center, preagg_catalog_returns, customer, customer_address, customer_demographics, household_demographics WHERE cr_call_center_sk = cc_call_center_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '1001-5000%' AND ca_gmt_offset = -7 GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["min_sk", "max_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2"
        },
        {
          "node_id": "preagg_catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "date_range"],
          "outputs": ["cr_call_center_sk", "cr_returning_customer_sk", "cr_net_loss"],
          "changed": true,
          "sql": "SELECT cr_call_center_sk, cr_returning_customer_sk, SUM(cr_net_loss) AS cr_net_loss FROM catalog_returns WHERE cr_returned_date_sk BETWEEN (SELECT min_sk FROM date_range) AND (SELECT max_sk FROM date_range) GROUP BY cr_call_center_sk, cr_returning_customer_sk"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.8,
    "based_on": "p02",
    "strategy": "Early aggregation after date filter join.",
    "hypothesis": "Pre‑aggregate CATALOG_RETURNS after joining with filtered DATE_DIM, reducing rows before joining with other dimensions. Probe p02 showed neutral speedup (1.04x) and is semantically safe.",
    "expected_explain_delta": "Reduce fact table rows via pre‑aggregation before dimension joins; keep DATE_DIM join in pre‑aggregation step.",
    "target_ir": "Add preagg_catalog_returns node, keep date_dim join in pre‑aggregation.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["preagg_catalog_returns", "call_center", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH preagg_catalog_returns AS (SELECT cr.cr_call_center_sk, cr.cr_returning_customer_sk, SUM(cr.cr_net_loss) AS cr_net_loss FROM catalog_returns cr JOIN date_dim d ON cr.cr_returned_date_sk = d.d_date_sk WHERE d.d_year = 1998 AND d.d_moy = 2 GROUP BY cr.cr_call_center_sk, cr.cr_returning_customer_sk) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM call_center, preagg_catalog_returns, customer, customer_address, customer_demographics, household_demographics WHERE cr_call_center_sk = cc_call_center_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '1001-5000%' AND ca_gmt_offset = -7 GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "preagg_catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "date_dim"],
          "outputs": ["cr_call_center_sk", "cr_returning_customer_sk", "cr_net_loss"],
          "changed": true,
          "sql": "SELECT cr.cr_call_center_sk, cr.cr_returning_customer_sk, SUM(cr.cr_net_loss) AS cr_net_loss FROM catalog_returns cr JOIN date_dim d ON cr.cr_returned_date_sk = d.d_date_sk WHERE d.d_year = 1998 AND d.d_moy = 2 GROUP BY cr.cr_call_center_sk, cr.cr_returning_customer_sk"
        }
      ]
    }
  }
]