{
  "probe_id": "p03",
  "transform_id": "prefetch_fact_join",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs reduces the working set early and allows the fact table scan to benefit from join-filter pushdown.",
  "reasoning_trace": [
    "Assigned transform targets prefetching dimensions to reduce fact-table scan size.",
    "All dimension tables are small and already pruned; filtering them early is safe.",
    "Join-filter pushdown in Snowflake supports early pruning when dimensions are staged.",
    "No semantic drift introduced; all original filters and join conditions preserved."
  ],
  "target_ir": "Dimension tables filtered into CTEs, joined into a single prefetch CTE, which is then joined with the fact table.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["prefetch_dims", "catalog_returns"],
        "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
        "changed": true,
        "sql": "SELECT cc.cc_call_center_id AS Call_Center, cc.cc_name AS Call_Center_Name, cc.cc_manager AS Manager, SUM(cr.cr_net_loss) AS Returns_Loss FROM catalog_returns cr JOIN prefetch_dims pd ON cr.cr_call_center_sk = pd.cc_call_center_sk AND cr.cr_returned_date_sk = pd.d_date_sk AND cr.cr_returning_customer_sk = pd.c_customer_sk WHERE pd.d_year = 1998 AND pd.d_moy = 2 AND ((pd.cd_marital_status = 'M' AND pd.cd_education_status = 'Unknown') OR (pd.cd_marital_status = 'W' AND pd.cd_education_status = 'Advanced Degree')) AND pd.hd_buy_potential LIKE '1001-5000%' AND pd.ca_gmt_offset = -7 GROUP BY cc.cc_call_center_id, cc.cc_name, cc.cc_manager, pd.cd_marital_status, pd.cd_education_status ORDER BY SUM(cr.cr_net_loss) DESC"
      },
      {
        "node_id": "prefetch_dims",
        "parent_node_id": "final_select",
        "sources": ["date_dim", "customer", "customer_address", "customer_demographics", "household_demographics", "call_center"],
        "outputs": ["cc_call_center_sk", "d_date_sk", "c_customer_sk", "d_year", "d_moy", "cd_marital_status", "cd_education_status", "hd_buy_potential", "ca_gmt_offset"],
        "changed": true,
        "sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_year, d_moy FROM date_dim WHERE d_year = 1998 AND d_moy = 2), filtered_customer_demographics AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')), filtered_household_demographics AS (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential LIKE '1001-5000%'), filtered_customer_address AS (SELECT ca_address_sk, ca_gmt_offset FROM customer_address WHERE ca_gmt_offset = -7), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk, c_current_hdemo_sk, c_current_addr_sk FROM customer WHERE c_current_cdemo_sk IS NOT NULL AND c_current_hdemo_sk IS NOT NULL), filtered_call_center AS (SELECT cc_call_center_sk, cc_call_center_id, cc_name, cc_manager FROM call_center) SELECT cc.cc_call_center_sk, d.d_date_sk, c.c_customer_sk, d.d_year, d.d_moy, cd.cd_marital_status, cd.cd_education_status, hd.hd_buy_potential, ca.ca_gmt_offset FROM filtered_call_center cc JOIN filtered_date_dim d ON TRUE JOIN filtered_customer c ON TRUE JOIN filtered_customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN filtered_household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk JOIN filtered_customer_address ca ON ca.ca_address_sk = c.c_current_addr_sk"
      },
      {
        "node_id": "catalog_returns",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["cr_returned_date_sk", "cr_returning_customer_sk", "cr_call_center_sk", "cr_net_loss"],
        "changed": true,
        "sql": "SELECT cr_returned_date_sk, cr_returning_customer_sk, cr_call_center_sk, cr_net_loss FROM catalog_returns"
      }
    ]
  }
}