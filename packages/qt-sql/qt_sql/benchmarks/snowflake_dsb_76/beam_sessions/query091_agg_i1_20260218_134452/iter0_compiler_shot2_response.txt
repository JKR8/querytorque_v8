[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Date range pushdown to fact table scan.",
    "hypothesis": "Primary hotspot is the full scan of CATALOG_RETURNS (82.5 GB). Push date filter (d_year=1998, d_moy=2) into the fact table by pre‑computing the date_sk range, eliminating the join with DATE_DIM and pruning micro‑partitions early.",
    "expected_explain_delta": "Eliminate join with DATE_DIM and filter CATALOG_RETURNS by cr_returned_date_sk range, reducing scan from 82.5 GB to a fraction.",
    "target_ir": "Add date_range and filtered_catalog_returns nodes, update final_select to use filtered_catalog_returns and remove DATE_DIM.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_catalog_returns", "call_center", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "SELECT cc_call_center_id Call_Center, cc_name Call_Center_Name, cc_manager Manager, SUM(cr_net_loss) Returns_Loss FROM call_center, filtered_catalog_returns, customer, customer_address, customer_demographics, household_demographics WHERE cr_call_center_sk = cc_call_center_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND ( (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '1001-5000%' AND ca_gmt_offset = -7 GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "filtered_catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "date_range"],
          "outputs": ["cr_call_center_sk", "cr_returning_customer_sk", "cr_net_loss"],
          "changed": true,
          "sql": "SELECT cr_call_center_sk, cr_returning_customer_sk, cr_net_loss FROM catalog_returns WHERE cr_returned_date_sk BETWEEN (SELECT min_sk FROM date_range) AND (SELECT max_sk FROM date_range)"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "filtered_catalog_returns",
          "sources": ["date_dim"],
          "outputs": ["min_sk", "max_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.80,
    "based_on": "p01,p02",
    "strategy": "Date range pushdown plus early aggregation.",
    "hypothesis": "Combine date range pushdown with early aggregation by join keys (cr_call_center_sk, cr_returning_customer_sk) to reduce rows before joining with dimensions, addressing both scan and aggregation hotspots.",
    "expected_explain_delta": "Eliminate join with DATE_DIM, filter CATALOG_RETURNS by date range, and reduce rows before dimension joins.",
    "target_ir": "Add date_range and aggregated_catalog_returns nodes, update final_select to use aggregated_catalog_returns and remove DATE_DIM.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["aggregated_catalog_returns", "call_center", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "SELECT cc_call_center_id Call_Center, cc_name Call_Center_Name, cc_manager Manager, SUM(cr_net_loss) Returns_Loss FROM call_center, aggregated_catalog_returns, customer, customer_address, customer_demographics, household_demographics WHERE cr_call_center_sk = cc_call_center_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND ( (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '1001-5000%' AND ca_gmt_offset = -7 GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "aggregated_catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "date_range"],
          "outputs": ["cr_call_center_sk", "cr_returning_customer_sk", "cr_net_loss"],
          "changed": true,
          "sql": "SELECT cr_call_center_sk, cr_returning_customer_sk, SUM(cr_net_loss) AS cr_net_loss FROM catalog_returns WHERE cr_returned_date_sk BETWEEN (SELECT min_sk FROM date_range) AND (SELECT max_sk FROM date_range) GROUP BY cr_call_center_sk, cr_returning_customer_sk"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "aggregated_catalog_returns",
          "sources": ["date_dim"],
          "outputs": ["min_sk", "max_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2"
        }
      ]
    }
  }
]