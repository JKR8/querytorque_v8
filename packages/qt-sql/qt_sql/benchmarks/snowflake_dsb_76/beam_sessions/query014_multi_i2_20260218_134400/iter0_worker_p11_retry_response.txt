{
  "probe_id": "p11",
  "transform_id": "self_join_decomposition",
  "family": "F",
  "status": "failed",
  "failure_reason": "Execution failure due to warehouse suspension during SQL scheduling; rewrite structure is valid but could not be validated.",
  "partial_work": {
    "attempted_approach": "Decomposed cross_items CTE into per-channel filtered CTEs (ss_items, cs_items, ws_items) joined on item keys to reduce fact-table scan redundancy.",
    "blocking_issue": "Warehouse 'COMPUTE_WH' was suspended while SQL was waiting to be scheduled. SQL execution canceled.",
    "hypothesis_still_valid": true
  },
  "dialect": "snowflake",
  "hypothesis": "Decomposing the cross_items CTE into per-channel filtered CTEs avoids repeated fact-table scans and enables better pruning via embedded date filters.",
  "reasoning_trace": [
    "cross_items CTE performs three full fact-table scans (store_sales, catalog_sales, web_sales) under intersecting filters.",
    "Each channel shares common item and date filters that can be pushed into isolated CTEs.",
    "Replacing INTERSECT with explicit inner joins on item keys preserves output semantics while enabling reuse."
  ],
  "target_ir": "cross_items rewritten as three filtered channel CTEs joined on item keys; final_select remains unchanged.",
  "verification": {
    "executable": false,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "item", "date_dim", "avg_sales", "cross_items"],
        "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
        "changed": false
      },
      {
        "node_id": "avg_sales",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["average_sales"],
        "changed": false
      },
      {
        "node_id": "cross_items",
        "parent_node_id": "final_select",
        "sources": ["ss_items", "cs_items", "ws_items"],
        "outputs": ["ss_item_sk"],
        "changed": true,
        "sql": "WITH ss_items AS (SELECT iss.i_item_sk FROM store_sales, item iss, date_dim d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 1999 + 2 AND iss.i_category IN ('Electronics', 'Shoes', 'Sports') AND iss.i_manager_id BETWEEN 42 AND 51 AND ss_wholesale_cost BETWEEN 76 AND 96), cs_items AS (SELECT ics.i_item_sk FROM catalog_sales, item ics, date_dim d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 1999 + 2 AND ics.i_category IN ('Electronics', 'Shoes', 'Sports') AND ics.i_manager_id BETWEEN 42 AND 51 AND cs_wholesale_cost BETWEEN 76 AND 96), ws_items AS (SELECT iws.i_item_sk FROM web_sales, item iws, date_dim d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND d3.d_year BETWEEN 1999 AND 1999 + 2 AND iws.i_category IN ('Electronics', 'Shoes', 'Sports') AND iws.i_manager_id BETWEEN 42 AND 51 AND ws_wholesale_cost BETWEEN 76 AND 96) SELECT ss.i_item_sk AS ss_item_sk FROM ss_items ss INNER JOIN cs_items cs ON ss.i_item_sk = cs.i_item_sk INNER JOIN ws_items ws ON ss.i_item_sk = ws.i_item_sk"
      }
    ]
  }
}