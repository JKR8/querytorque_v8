{
  "probe_id": "scout_dimension_cte_isolate",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs returning only surrogate keys enables early pruning and smaller hash tables for join operations.",
  "reasoning_trace": [
    "Assigned transform targets early dimension filtering to reduce fact-table scan pressure.",
    "Each dimension CTE isolates surrogate keys with WHERE clauses matching original filters.",
    "Final SELECT joins CTEs with store_sales preserving all original join conditions and output semantics."
  ],
  "target_ir": "Five CTEs added for each dimension table; final_select joins them with store_sales.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales_filtered", "date_dim_cte", "customer_demographics_cte", "household_demographics_cte", "customer_address_cte", "store_cte"],
        "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales_filtered JOIN store_cte ON s_store_sk = ss_store_sk JOIN customer_demographics_cte ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics_cte ON hd_demo_sk = ss_hdemo_sk JOIN customer_address_cte ON ca_address_sk = ss_addr_sk JOIN date_dim_cte ON d_date_sk = ss_sold_date_sk"
      },
      {
        "node_id": "store_sales_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales"],
        "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost", "ss_store_sk", "ss_cdemo_sk", "ss_hdemo_sk", "ss_addr_sk", "ss_sold_date_sk"],
        "changed": true,
        "sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_store_sk, ss_cdemo_sk, ss_hdemo_sk, ss_addr_sk, ss_sold_date_sk FROM store_sales WHERE ss_store_sk IS NOT NULL AND ss_cdemo_sk IS NOT NULL AND ss_hdemo_sk IS NOT NULL AND ss_sold_date_sk IS NOT NULL AND ss_addr_sk IS NOT NULL"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('M', 'S', 'W') AND cd_education_status IN ('2 yr Degree', 'Primary')"
      },
      {
        "node_id": "household_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk"],
        "changed": true,
        "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": true,
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH')"
      },
      {
        "node_id": "store_cte",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": true,
        "sql": "SELECT s_store_sk FROM store"
      }
    ]
  }
}