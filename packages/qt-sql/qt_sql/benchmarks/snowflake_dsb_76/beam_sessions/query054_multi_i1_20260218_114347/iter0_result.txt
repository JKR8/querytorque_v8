{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.05161542,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 109970,
    "completion_tokens": 20491,
    "total_tokens": 130461,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 10510
  },
  "best_speedup": 1.11,
  "best_patch_id": "p01",
  "best_sql": "WITH my_customers AS (select distinct c_customer_sk, c_current_addr_sk from ( select cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost from catalog_sales where cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) and (select max(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) union all select ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost from web_sales where ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) and (select max(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) ) cs_or_ws_sales, item, date_dim, customer where sold_date_sk = d_date_sk and item_sk = i_item_sk and i_category = 'Electronics' and i_class = 'personal' and c_customer_sk = cs_or_ws_sales.customer_sk and d_moy = 1 and d_year = 1998 and wholesale_cost BETWEEN 35 AND 65 and c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "date_cte_isolate",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_sks AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales, item, customer, date_sks WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_sks, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = date_sks.d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND date_dim.d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": false,
      "description": "[qwen:deepseek/deepseek-chat] Extract date_dim filtering into a separate CTE to materialize date_sks once."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 1.11,
      "semantic_passed": true,
      "error": null,
      "original_ms": 173.5,
      "patch_ms": 155.7,
      "output_sql": "WITH my_customers AS (select distinct c_customer_sk, c_current_addr_sk from ( select cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost from catalog_sales where cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) and (select max(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) union all select ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost from web_sales where ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) and (select max(d_date_sk) from date_dim where d_moy = 1 and d_year = 1998) ) cs_or_ws_sales, item, date_dim, customer where sold_date_sk = d_date_sk and item_sk = i_item_sk and i_category = 'Electronics' and i_class = 'personal' and c_customer_sk = cs_or_ws_sales.customer_sk and d_moy = 1 and d_year = 1998 and wholesale_cost BETWEEN 35 AND 65 and c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:deepseek/deepseek-chat] Push date_sk BETWEEN predicate into both catalog_sales and web_sales branches of the UNION ALL."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.6,
      "status": "NEUTRAL",
      "speedup": 1.03,
      "semantic_passed": true,
      "error": null,
      "original_ms": 173.5,
      "patch_ms": 169.1,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE i_category = 'Electronics' AND i_class = 'personal'), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales, filtered_item fi, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = fi.i_item_sk AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:deepseek/deepseek-chat] Materialize the filtered item table once."
    },
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Row count: orig=100, patch=0",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH shared_dimension AS (SELECT d_date_sk, i_item_sk FROM date_dim JOIN item ON date_dim.d_date_sk = item.i_item_sk WHERE i_category = 'Electronics' AND i_class = 'personal' AND d_moy = 1 AND d_year = 1998), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales JOIN shared_dimension sd ON cs_or_ws_sales.sold_date_sk = sd.d_date_sk AND cs_or_ws_sales.item_sk = sd.i_item_sk JOIN customer ON c_customer_sk = cs_or_ws_sales.customer_sk WHERE wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": false,
      "description": "[qwen:deepseek/deepseek-chat] Extract shared dimension filters into a single CTE."
    },
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "IMPROVED",
      "speedup": 1.06,
      "semantic_passed": true,
      "error": null,
      "original_ms": 173.5,
      "patch_ms": 163.2,
      "output_sql": "WITH my_customers AS (WITH filtered_sales AS (\n  SELECT cs_bill_customer_sk AS customer_sk, cs_sold_date_sk AS sold_date_sk, cs_item_sk AS item_sk\n  FROM catalog_sales\n  WHERE cs_wholesale_cost BETWEEN 35 AND 65\n  UNION ALL\n  SELECT ws_bill_customer_sk AS customer_sk, ws_sold_date_sk AS sold_date_sk, ws_item_sk AS item_sk\n  FROM web_sales\n  WHERE ws_wholesale_cost BETWEEN 35 AND 65\n),\nvalid_customers AS (\n  SELECT DISTINCT fs.customer_sk\n  FROM filtered_sales fs\n  JOIN date_dim d ON fs.sold_date_sk = d.d_date_sk\n  JOIN item i ON fs.item_sk = i.i_item_sk\n  WHERE d.d_moy = 1\n    AND d.d_year = 1998\n    AND i.i_category = 'Electronics'\n    AND i.i_class = 'personal'\n)\nSELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk\nFROM valid_customers vc\nJOIN customer c ON c.c_customer_sk = vc.customer_sk\nWHERE c.c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[reasoner:deepseek/deepseek-v3.2] Pre-aggregate catalog_sales and web_sales by customer_sk before joining with other tables."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.78,
      "semantic_passed": true,
      "error": null,
      "original_ms": 142.5,
      "patch_ms": 183.8,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales WHERE cs_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_moy = 1 AND d_year = 1998) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_moy = 1 AND d_year = 1998) UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales WHERE ws_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_moy = 1 AND d_year = 1998) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_moy = 1 AND d_year = 1998)) cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 155745 | 153233 | 2596910891008\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p04": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p02": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "compile_p1": "GlobalStats | 155745 | 153233 | 2596910891008\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND"
  }
}