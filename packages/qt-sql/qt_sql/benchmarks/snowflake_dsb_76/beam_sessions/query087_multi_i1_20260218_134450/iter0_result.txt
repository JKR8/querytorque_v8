{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.02355396,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 66512,
    "completion_tokens": 22904,
    "total_tokens": 89416,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 22208,
    "reasoning_tokens": 14142
  },
  "best_speedup": 1.11,
  "best_patch_id": "p03",
  "best_sql": "select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ss_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ss_wholesale_cost BETWEEN 35 AND 45\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and cs_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and cs_wholesale_cost BETWEEN 35 AND 45\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ws_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ws_wholesale_cost BETWEEN 35 AND 45\n         )\n) cool_cust;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "D",
      "transform": "intersect_to_exists",
      "relevance_score": 0.55,
      "status": "WIN",
      "speedup": 1.11,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.5,
      "patch_ms": 152.7,
      "output_sql": "select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ss_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ss_wholesale_cost BETWEEN 35 AND 45\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and cs_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and cs_wholesale_cost BETWEEN 35 AND 45\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ws_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ws_wholesale_cost BETWEEN 35 AND 45\n         )\n) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Rewrite EXCEPT operations using NOT EXISTS with joins to avoid full materialization and leverage semi-join optimizations."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "NEUTRAL",
      "speedup": 0.96,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.5,
      "patch_ms": 175.8,
      "output_sql": "select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ss_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ss_wholesale_cost BETWEEN 35 AND 45\n         and ss_sold_date_sk between (select min(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11) and (select max(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11)\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and cs_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and cs_wholesale_cost BETWEEN 35 AND 45\n         and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11) and (select max(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11)\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1214 and 1214+11\n         and ws_list_price between 242 and 271\n         and c_birth_year BETWEEN 1955 AND 1961\n         and ws_wholesale_cost BETWEEN 35 AND 45\n         and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11) and (select max(d_date_sk) from date_dim where d_month_seq between 1214 and 1214+11)\n         )\n) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add date_sk BETWEEN predicate derived from d_month_seq range to each fact table scan in the subqueries to enable micro-partition pruning."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Node `filtered_date_dim` missing parent_node_id",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH ss_query AS (SELECT DISTINCT c.c_last_name, c.c_first_name, dd.d_date\nFROM store_sales ss\nINNER JOIN filtered_date_dim dd ON ss.ss_sold_date_sk = dd.d_date_sk\nINNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\nWHERE ss.ss_list_price BETWEEN 242 AND 271\n  AND c.c_birth_year BETWEEN 1955 AND 1961\n  AND ss.ss_wholesale_cost BETWEEN 35 AND 45), cs_query AS (SELECT DISTINCT c.c_last_name, c.c_first_name, dd.d_date\nFROM catalog_sales cs\nINNER JOIN filtered_date_dim dd ON cs.cs_sold_date_sk = dd.d_date_sk\nINNER JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk\nWHERE cs.cs_list_price BETWEEN 242 AND 271\n  AND c.c_birth_year BETWEEN 1955 AND 1961\n  AND cs.cs_wholesale_cost BETWEEN 35 AND 45), ws_query AS (SELECT DISTINCT c.c_last_name, c.c_first_name, dd.d_date\nFROM web_sales ws\nINNER JOIN filtered_date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk\nINNER JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk\nWHERE ws.ws_list_price BETWEEN 242 AND 271\n  AND c.c_birth_year BETWEEN 1955 AND 1961\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 45), cool_cust AS (WITH filtered_date_dim AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1214 AND 1214 + 11\n)\nSELECT DISTINCT c_last_name, c_first_name, d_date\nFROM ss_query\nEXCEPT\nSELECT DISTINCT c_last_name, c_first_name, d_date\nFROM cs_query\nEXCEPT\nSELECT DISTINCT c_last_name, c_first_name, d_date\nFROM ws_query) SELECT COUNT(*) FROM cool_cust;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated joins to explicit INNER JOIN syntax and pre-filter date_dim into a CTE to improve join planning and reduce dimension scan redundancy."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.45,
      "status": "NEUTRAL",
      "speedup": 0.96,
      "semantic_passed": true,
      "error": null,
      "original_ms": 169.5,
      "patch_ms": 175.9,
      "output_sql": "WITH store_sales_set AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales, date_dim, customer\n  WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    AND store_sales.ss_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1214 AND 1214+11\n    AND ss_list_price BETWEEN 242 AND 271\n    AND c_birth_year BETWEEN 1955 AND 1961\n    AND ss_wholesale_cost BETWEEN 35 AND 45\n),\ncatalog_sales_set AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales, date_dim, customer\n  WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n    AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1214 AND 1214+11\n    AND cs_list_price BETWEEN 242 AND 271\n    AND c_birth_year BETWEEN 1955 AND 1961\n    AND cs_wholesale_cost BETWEEN 35 AND 45\n),\nweb_sales_set AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales, date_dim, customer\n  WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk\n    AND web_sales.ws_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1214 AND 1214+11\n    AND ws_list_price BETWEEN 242 AND 271\n    AND c_birth_year BETWEEN 1955 AND 1961\n    AND ws_wholesale_cost BETWEEN 35 AND 45\n)\nSELECT COUNT(*)\nFROM (\n  SELECT * FROM store_sales_set\n  EXCEPT\n  SELECT * FROM catalog_sales_set\n  EXCEPT\n  SELECT * FROM web_sales_set\n) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the distinct sets from each subquery into CTEs to avoid recomputation and share results if needed, though subqueries are independent."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.86,
      "semantic_passed": true,
      "error": null,
      "original_ms": 186.1,
      "patch_ms": 217.0,
      "output_sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) ss_set WHERE NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND d.d_date = ss_set.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND d.d_date = ss_set.d_date);",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.85,
      "semantic_passed": true,
      "error": null,
      "original_ms": 186.1,
      "patch_ms": 219.7,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11) SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, fd.d_date FROM store_sales ss JOIN filtered_date fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) ss_set WHERE NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN filtered_date fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND fd.d_date = ss_set.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN filtered_date fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND fd.d_date = ss_set.d_date);",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p03": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Generator | 0",
    "p01": "GlobalStats | 2 | 2 | 4277248\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_MONTH_SEQ >= 1214) AND (DATE_DIM.D_MONTH_SEQ <= 1225)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_MONTH_SEQ | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_MONTH_SEQ >= 1214) AND (DA",
    "p04": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Generator | 0",
    "compile_p1": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Generator | 0",
    "compile_p2": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Generator | 0"
  }
}