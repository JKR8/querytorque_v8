[  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p03",
    "strategy": "Convert EXCEPT chain to NOT EXISTS with correlation on output columns to leverage anti-join optimizations.",
    "hypothesis": "Probe p03 indicated potential for EXCEPT rewrite, but transform mismatch prevented application. Rewriting to NOT EXISTS targets the set operation hotspot by avoiding materialization of large distinct sets and using Snowflake's efficient anti-joins.",
    "expected_explain_delta": "EXCEPT operators replaced with anti-joins, reducing intermediate materialization and potentially enabling better join planning.",
    "target_ir": "Change final_select from EXCEPT operations to correlated NOT EXISTS subqueries.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) ss_set WHERE NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND d.d_date = ss_set.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND d.d_date = ss_set.d_date)"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.65,
    "based_on": "p02",
    "strategy": "Add filtered date_dim CTE to share dimension scan and combine with NOT EXISTS rewrite for anti-joins.",
    "hypothesis": "Probe p02 failed due to structural issues but hypothesized date_dim scan reduction. This attempt corrects the tree structure and integrates NOT EXISTS to address both dimension redundancy and set operation materialization.",
    "expected_explain_delta": "Date_dim scanned once via CTE, and EXCEPT operators replaced with anti-joins, reducing scan volume and intermediate data.",
    "target_ir": "Introduce filtered_date node for date_dim pre-filtering and update final_select to use NOT EXISTS with CTE reference.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "filtered_date",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_date", "store_sales", "customer", "catalog_sales", "web_sales"],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, fd.d_date FROM store_sales ss JOIN filtered_date fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) ss_set WHERE NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN filtered_date fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND fd.d_date = ss_set.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN filtered_date fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c.c_last_name = ss_set.c_last_name AND c.c_first_name = ss_set.c_first_name AND fd.d_date = ss_set.d_date)"
        }
      ]
    }
  }
]