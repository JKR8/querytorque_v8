[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p04",
    "strategy": "Shared dimension CTEs to avoid repeated scans of customer and date_dim.",
    "hypothesis": "Winning probe p04 (1.13x) showed that scanning customer and date_dim once via CTEs reduces I/O and compute. The original plan scans each dimension three times; this addresses that secondary hotspot.",
    "expected_explain_delta": "Fewer scans of CUSTOMER and DATE_DIM tables, reduced aggregate work for dimension filtering.",
    "target_ir": "Introduce filtered_customer and filtered_date CTEs, reuse them in each salesâ€‘channel branch.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["cool_cust"],
          "outputs": ["*"],
          "changed": true,
          "sql": "WITH filtered_customer AS (\n  SELECT c_customer_sk, c_first_name, c_last_name\n  FROM customer\n  WHERE c_birth_year BETWEEN 1968 AND 1974\n),\nfiltered_date AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1213 AND 1224\n),\nstore_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales, filtered_date, filtered_customer\n  WHERE store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n    AND store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n    AND ss_list_price BETWEEN 168 AND 197\n    AND ss_wholesale_cost BETWEEN 76 AND 86\n),\ncatalog_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales, filtered_date, filtered_customer\n  WHERE catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n    AND catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n    AND cs_list_price BETWEEN 168 AND 197\n    AND cs_wholesale_cost BETWEEN 76 AND 86\n),\nweb_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales, filtered_date, filtered_customer\n  WHERE web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n    AND web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n    AND ws_list_price BETWEEN 168 AND 197\n    AND ws_wholesale_cost BETWEEN 76 AND 86\n),\ncool_cust AS (\n  (SELECT * FROM store_branch)\n  EXCEPT\n  (SELECT * FROM catalog_branch)\n  EXCEPT\n  (SELECT * FROM web_branch)\n)\nSELECT COUNT(*) FROM cool_cust"
        },
        {
          "node_id": "cool_cust",
          "parent_node_id": "final_select",
          "sources": ["store_branch", "catalog_branch", "web_branch"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "(SELECT * FROM store_branch) EXCEPT (SELECT * FROM catalog_branch) EXCEPT (SELECT * FROM web_branch)"
        },
        {
          "node_id": "store_branch",
          "parent_node_id": "cool_cust",
          "sources": ["filtered_customer", "filtered_date", "store_sales"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales, filtered_date, filtered_customer WHERE store_sales.ss_sold_date_sk = filtered_date.d_date_sk AND store_sales.ss_customer_sk = filtered_customer.c_customer_sk AND ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86"
        },
        {
          "node_id": "catalog_branch",
          "parent_node_id": "cool_cust",
          "sources": ["filtered_customer", "filtered_date", "catalog_sales"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales, filtered_date, filtered_customer WHERE catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk AND catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk AND cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86"
        },
        {
          "node_id": "web_branch",
          "parent_node_id": "cool_cust",
          "sources": ["filtered_customer", "filtered_date", "web_sales"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales, filtered_date, filtered_customer WHERE web_sales.ws_sold_date_sk = filtered_date.d_date_sk AND web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk AND ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86"
        },
        {
          "node_id": "filtered_customer",
          "parent_node_id": "store_branch",
          "sources": ["customer"],
          "outputs": ["c_customer_sk", "c_first_name", "c_last_name"],
          "changed": true,
          "sql": "SELECT c_customer_sk, c_first_name, c_last_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974"
        },
        {
          "node_id": "filtered_date",
          "parent_node_id": "store_branch",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224"
        }
      ]
    }
  }
]