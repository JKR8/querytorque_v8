{
  "probe_id": "p04",
  "transform_id": "shared_dimension_multi_channel",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Shared customer and date filters can be extracted into reusable CTEs to reduce redundant scans across store, catalog, and web sales branches.",
  "reasoning_trace": [
    "Three branches of EXCEPT each scan customer and date_dim with identical filters.",
    "Creating shared CTEs for filtered customer and date data aligns with node_contract requirements.",
    "Each sales branch joins once to these shared CTEs, preserving join semantics and output columns.",
    "CTE reuse is safe because all filters are preserved and no new pruning risks are introduced."
  ],
  "target_ir": "Two new CTEs (filtered_customer, filtered_date) are created and referenced in place of repeated base scans in each sales branch.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cool_cust"],
        "outputs": ["count(*)"],
        "changed": true,
        "sql": "select count(*) from cool_cust"
      },
      {
        "node_id": "cool_cust",
        "parent_node_id": "final_select",
        "sources": ["store_branch", "catalog_branch", "web_branch"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "(select distinct c_last_name, c_first_name, d_date from store_branch) except (select distinct c_last_name, c_first_name, d_date from catalog_branch) except (select distinct c_last_name, c_first_name, d_date from web_branch)"
      },
      {
        "node_id": "store_branch",
        "parent_node_id": "cool_cust",
        "sources": ["store_sales", "filtered_date", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "select distinct c_last_name, c_first_name, d_date from store_sales, filtered_date, filtered_customer where store_sales.ss_sold_date_sk = filtered_date.d_date_sk and store_sales.ss_customer_sk = filtered_customer.c_customer_sk and ss_list_price between 168 and 197 and ss_wholesale_cost BETWEEN 76 AND 86"
      },
      {
        "node_id": "catalog_branch",
        "parent_node_id": "cool_cust",
        "sources": ["catalog_sales", "filtered_date", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "select distinct c_last_name, c_first_name, d_date from catalog_sales, filtered_date, filtered_customer where catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk and catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk and cs_list_price between 168 and 197 and cs_wholesale_cost BETWEEN 76 AND 86"
      },
      {
        "node_id": "web_branch",
        "parent_node_id": "cool_cust",
        "sources": ["web_sales", "filtered_date", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "select distinct c_last_name, c_first_name, d_date from web_sales, filtered_date, filtered_customer where web_sales.ws_sold_date_sk = filtered_date.d_date_sk and web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk and ws_list_price between 168 and 197 and ws_wholesale_cost BETWEEN 76 AND 86"
      },
      {
        "node_id": "filtered_customer",
        "parent_node_id": "store_branch",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name"],
        "changed": true,
        "sql": "select c_customer_sk, c_first_name, c_last_name from customer where c_birth_year BETWEEN 1968 AND 1974"
      },
      {
        "node_id": "filtered_date",
        "parent_node_id": "store_branch",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "select d_date_sk, d_date from date_dim where d_month_seq between 1213 and 1224"
      }
    ]
  }
}