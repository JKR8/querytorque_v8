{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.03241908,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 85502,
    "completion_tokens": 17114,
    "total_tokens": 102616,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 38656,
    "reasoning_tokens": 7724
  },
  "best_speedup": 1.13,
  "best_patch_id": "p01",
  "best_sql": "select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ss_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ss_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and cs_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and cs_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ws_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ws_wholesale_cost BETWEEN 76 AND 86\n         )\n) cool_cust;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.75,
      "status": "WIN",
      "speedup": 1.13,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 158.2,
      "output_sql": "select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ss_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ss_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and cs_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and cs_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ws_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ws_wholesale_cost BETWEEN 76 AND 86\n         )\n) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN range predicate derived from `d_month_seq between 1213 and 1213+11` to each fact table's WHERE clause (store_sales.ss_sold_date_sk, catalog_sales.cs_sold_date_sk, web_sales.ws_sold_date_sk)."
    },
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.55,
      "status": "IMPROVED",
      "speedup": 1.06,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 170.1,
      "output_sql": "WITH cool_cust AS (with sales_data as (\n  select 'store' as channel, ss_customer_sk as customer_sk, ss_sold_date_sk as sold_date_sk, ss_list_price, ss_wholesale_cost\n  from store_sales\n  where ss_list_price between 168 and 197 and ss_wholesale_cost between 76 and 86\n  union all\n  select 'catalog' as channel, cs_bill_customer_sk as customer_sk, cs_sold_date_sk as sold_date_sk, cs_list_price, cs_wholesale_cost\n  from catalog_sales\n  where cs_list_price between 168 and 197 and cs_wholesale_cost between 76 and 86\n  union all\n  select 'web' as channel, ws_bill_customer_sk as customer_sk, ws_sold_date_sk as sold_date_sk, ws_list_price, ws_wholesale_cost\n  from web_sales\n  where ws_list_price between 168 and 197 and ws_wholesale_cost between 76 and 86\n)\nselect distinct c.c_last_name, c.c_first_name, d.d_date\nfrom sales_data s\njoin date_dim d on s.sold_date_sk = d.d_date_sk\njoin customer c on s.customer_sk = c.c_customer_sk\nwhere d.d_month_seq between 1213 and 1224\n  and c.c_birth_year between 1968 and 1974\nexcept\nselect distinct c.c_last_name, c.c_first_name, d.d_date\nfrom catalog_sales cs\njoin date_dim d on cs.cs_sold_date_sk = d.d_date_sk\njoin customer c on cs.cs_bill_customer_sk = c.c_customer_sk\nwhere d.d_month_seq between 1213 and 1224\n  and cs_list_price between 168 and 197\n  and c.c_birth_year between 1968 and 1974\n  and cs_wholesale_cost between 76 and 86\nexcept\nselect distinct c.c_last_name, c.c_first_name, d.d_date\nfrom web_sales ws\njoin date_dim d on ws.ws_sold_date_sk = d.d_date_sk\njoin customer c on ws.ws_bill_customer_sk = c.c_customer_sk\nwhere d.d_month_seq between 1213 and 1224\n  and ws_list_price between 168 and 197\n  and c.c_birth_year between 1968 and 1974\n  and ws_wholesale_cost between 76 and 86) select count(*) from cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate the three separate fact+dimension scans into a single CTE that labels the sales channel, then aggregate once to produce the distinct sets needed for the EXCEPT operation."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.5,
      "status": "WIN",
      "speedup": 1.13,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 158.4,
      "output_sql": "WITH filtered_customer AS (select c_customer_sk, c_first_name, c_last_name from customer where c_birth_year BETWEEN 1968 AND 1974), filtered_date AS (select d_date_sk, d_date from date_dim where d_month_seq between 1213 and 1224), store_branch AS (select distinct c_last_name, c_first_name, d_date from store_sales, filtered_date, filtered_customer where store_sales.ss_sold_date_sk = filtered_date.d_date_sk and store_sales.ss_customer_sk = filtered_customer.c_customer_sk and ss_list_price between 168 and 197 and ss_wholesale_cost BETWEEN 76 AND 86), catalog_branch AS (select distinct c_last_name, c_first_name, d_date from catalog_sales, filtered_date, filtered_customer where catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk and catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk and cs_list_price between 168 and 197 and cs_wholesale_cost BETWEEN 76 AND 86), web_branch AS (select distinct c_last_name, c_first_name, d_date from web_sales, filtered_date, filtered_customer where web_sales.ws_sold_date_sk = filtered_date.d_date_sk and web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk and ws_list_price between 168 and 197 and ws_wholesale_cost BETWEEN 76 AND 86), cool_cust AS ((select distinct c_last_name, c_first_name, d_date from store_branch) except (select distinct c_last_name, c_first_name, d_date from catalog_branch) except (select distinct c_last_name, c_first_name, d_date from web_branch)) select count(*) from cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Create a single CTE for the filtered customer data (birth_year) and a single CTE for the filtered date data (month_seq). Join these once to each sales fact table in the respective subqueries."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "multi_date_range_cte",
      "relevance_score": 0.45,
      "status": "REGRESSION",
      "speedup": 0.95,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 189.9,
      "output_sql": "WITH ss_subquery AS (SELECT DISTINCT c.c_last_name, c.c_first_name, fd.d_date FROM store_sales ss JOIN date_dim fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE fd.d_month_seq BETWEEN 1213 AND 1224 AND ss.ss_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974), cs_subquery AS (SELECT DISTINCT c.c_last_name, c.c_first_name, fd.d_date FROM catalog_sales cs JOIN date_dim fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE fd.d_month_seq BETWEEN 1213 AND 1224 AND cs.cs_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974), ws_subquery AS (SELECT DISTINCT c.c_last_name, c.c_first_name, fd.d_date FROM web_sales ws JOIN date_dim fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE fd.d_month_seq BETWEEN 1213 AND 1224 AND ws.ws_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974), cool_cust AS (WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224) SELECT c_last_name, c_first_name, d_date FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales ss JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974 EXCEPT SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales cs JOIN filtered_dates fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974 EXCEPT SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales ws JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 168 AND 197 AND c.c_birth_year BETWEEN 1968 AND 1974)) select count(*)\nfrom ((select distinct c_last_name, c_first_name, d_date\n       from store_sales, date_dim, customer\n       where store_sales.ss_sold_date_sk = date_dim.d_date_sk\n         and store_sales.ss_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ss_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ss_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from catalog_sales, date_dim, customer\n       where catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n         and catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and cs_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and cs_wholesale_cost BETWEEN 76 AND 86\n         )\n       except\n      (select distinct c_last_name, c_first_name, d_date\n       from web_sales, date_dim, customer\n       where web_sales.ws_sold_date_sk = date_dim.d_date_sk\n         and web_sales.ws_bill_customer_sk = customer.c_customer_sk\n         and d_month_seq between 1213 and 1213+11\n         and ws_list_price between 168 and 197\n         and c_birth_year BETWEEN 1968 AND 1974\n         and ws_wholesale_cost BETWEEN 76 AND 86\n         )\n) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter the date_dim table for the required month range into a tiny CTE and join it to each fact table subquery."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 210.7,
      "patch_ms": 223.2,
      "output_sql": "WITH filtered_customer AS (\n  SELECT c_customer_sk, c_first_name, c_last_name\n  FROM customer\n  WHERE c_birth_year BETWEEN 1968 AND 1974\n),\nfiltered_date AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1213 AND 1224\n),\nstore_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales, filtered_date, filtered_customer\n  WHERE store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n    AND store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n    AND ss_list_price BETWEEN 168 AND 197\n    AND ss_wholesale_cost BETWEEN 76 AND 86\n),\ncatalog_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales, filtered_date, filtered_customer\n  WHERE catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n    AND catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n    AND cs_list_price BETWEEN 168 AND 197\n    AND cs_wholesale_cost BETWEEN 76 AND 86\n),\nweb_branch AS (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales, filtered_date, filtered_customer\n  WHERE web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n    AND web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n    AND ws_list_price BETWEEN 168 AND 197\n    AND ws_wholesale_cost BETWEEN 76 AND 86\n),\ncool_cust AS (\n  (SELECT * FROM store_branch)\n  EXCEPT\n  (SELECT * FROM catalog_branch)\n  EXCEPT\n  (SELECT * FROM web_branch)\n)\nSELECT COUNT(*) FROM cool_cust;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 156005 | 155799 | 2640056983040\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Aggregate | groupKeys: [CUSTOMER.C_LAST_NAME, CUSTOMER.C_FIRST_NAME, DATE_DIM.D_DATE]\n1 | 3 | [2] | Aggregate | groupKeys: [CUSTOMER.C_LAST_NAME, CUSTOMER.C_FIRST_NAME, DATE_DIM.D_DATE]\n1 | 4 | [3] | AntiJoin | joinKey: (CUSTOMER.C_FIRST_NAME = CUSTOMER.C_FIRST_NAME) AND (CUSTOMER.C_LAST_NAME = CUSTOMER.C_LAST_NAME) AND (DATE_DIM.D_DATE = DATE_DIM.D_DATE)\n1 | 5 | [",
    "p02": "GlobalStats | 238506 | 235788 | 3981902010880\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Aggregate | groupKeys: [C.C_LAST_NAME, C.C_FIRST_NAME, D.D_DATE]\n1 | 3 | [2] | Aggregate | groupKeys: [C.C_LAST_NAME, C.C_FIRST_NAME, D.D_DATE]\n1 | 4 | [3] | AntiJoin | joinKey: (C.C_FIRST_NAME = C.C_FIRST_NAME) AND (C.C_LAST_NAME = C.C_LAST_NAME) AND (D.D_DATE = D.D_DATE)\n1 | 5 | [4] | Aggregate | groupKeys: [C.C_FIRST_NAME, C.C_LAST_NAME, D.D_DATE]\n1 | 6 | [5] | ",
    "p04": "GlobalStats | 155481 | 155481 | 2638913729536\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Aggregate | groupKeys: [FILTERED_CUSTOMER.C_LAST_NAME, FILTERED_CUSTOMER.C_FIRST_NAME, FILTERED_DATE.D_DATE]\n1 | 3 | [2] | Aggregate | groupKeys: [FILTERED_CUSTOMER.C_LAST_NAME, FILTERED_CUSTOMER.C_FIRST_NAME, FILTERED_DATE.D_DATE]\n1 | 4 | [3] | AntiJoin | joinKey: (FILTERED_CUSTOMER.C_FIRST_NAME = FILTERED_CUSTOMER.C_FIRST_NAME) AND (FILTERED_CUSTOMER.C_LAST_NAME ",
    "p03": "GlobalStats | 156005 | 155799 | 2640056983040\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Aggregate | groupKeys: [CUSTOMER.C_LAST_NAME, CUSTOMER.C_FIRST_NAME, DATE_DIM.D_DATE]\n1 | 3 | [2] | Aggregate | groupKeys: [CUSTOMER.C_LAST_NAME, CUSTOMER.C_FIRST_NAME, DATE_DIM.D_DATE]\n1 | 4 | [3] | AntiJoin | joinKey: (CUSTOMER.C_FIRST_NAME = CUSTOMER.C_FIRST_NAME) AND (CUSTOMER.C_LAST_NAME = CUSTOMER.C_LAST_NAME) AND (DATE_DIM.D_DATE = DATE_DIM.D_DATE)\n1 | 5 | [",
    "compile_p1": "GlobalStats | 155481 | 155481 | 2638913729536\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Aggregate | groupKeys: [FILTERED_CUSTOMER.C_LAST_NAME, FILTERED_CUSTOMER.C_FIRST_NAME, FILTERED_DATE.D_DATE]\n1 | 3 | [2] | Aggregate | groupKeys: [FILTERED_CUSTOMER.C_LAST_NAME, FILTERED_CUSTOMER.C_FIRST_NAME, FILTERED_DATE.D_DATE]\n1 | 4 | [3] | AntiJoin | joinKey: (FILTERED_CUSTOMER.C_FIRST_NAME = FILTERED_CUSTOMER.C_FIRST_NAME) AND (FILTERED_CUSTOMER.C_LAST_NAME "
  }
}