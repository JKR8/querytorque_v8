{
  "iteration": 0,
  "n_api_calls": 12,
  "beam_cost_usd": 0.05954331,
  "beam_cost_priced_calls": 12,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 104581,
    "completion_tokens": 36276,
    "total_tokens": 140857,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 41344,
    "reasoning_tokens": 22680
  },
  "best_speedup": 1.12,
  "best_patch_id": "p01",
  "best_sql": "WITH d1_date_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 1999) select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk AND inv_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range))\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk AND d1.d_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range))\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '>10000'\n  and d1.d_year = 1999\n  and cd_marital_status = 'S'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Men', 'Shoes', 'Sports')\n  and cs_wholesale_cost BETWEEN 76 AND 96\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `date_dim_d1`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate catalog_sales by item, warehouse, and week_seq before joining with dimensions, preserving all necessary join keys and aggregates"
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 1.12,
      "semantic_passed": true,
      "error": null,
      "original_ms": 168.8,
      "patch_ms": 150.3,
      "output_sql": "WITH d1_date_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 1999) select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk AND inv_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range))\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk AND d1.d_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range))\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '>10000'\n  and d1.d_year = 1999\n  and cd_marital_status = 'S'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Men', 'Shoes', 'Sports')\n  and cs_wholesale_cost BETWEEN 76 AND 96\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN filters to catalog_sales and inventory joins by computing date_sk ranges from date_dim filters before the main query"
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Unchanged node `warehouse` must omit sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the inventory-catalog_sales join with date filters as a CTE to avoid recomputing the non-equi join multiple times"
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `catalog_sales`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create CTEs for all selective dimension filters (customer_demographics, household_demographics, item, warehouse, promotion) before joining to fact tables"
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.87,
      "semantic_passed": true,
      "error": null,
      "original_ms": 173.1,
      "patch_ms": 199.2,
      "output_sql": "WITH d1_date_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 1999) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) promo, COUNT(*) total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk AND inv_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range)) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk AND d1.d_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range)) JOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 day' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "NEUTRAL",
      "speedup": 1.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 173.1,
      "patch_ms": 172.5,
      "output_sql": "WITH d1_date_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 1999) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk AND inv_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range)) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk AND d1.d_date_sk BETWEEN (SELECT min_date_sk FROM d1_date_range) AND (SELECT max_date_sk FROM d1_date_range)) JOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 day' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | ITEM.I_ITEM_DESC, WAREHOUSE.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, ITEM.I_ITEM_DESC ASC NULLS LAST, WAREHOUSE.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0",
    "compile_p1": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | ITEM.I_ITEM_DESC, WAREHOUSE.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, ITEM.I_ITEM_DESC ASC NULLS LAST, WAREHOUSE.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0"
  }
}