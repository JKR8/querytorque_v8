{
  "probe_id": "scout_1",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Selective filters on customer_demographics, household_demographics, and customer_address can be pre-materialized into a single CTE to improve join planning and reduce repeated scans of the large store_sales table.",
  "reasoning_trace": [
    "Assigned transform targets prefetching selective dimension filters into a single CTE.",
    "Dimension tables (customer_demographics, household_demographics, customer_address) have strong selective filters that can be evaluated early.",
    "Pre-materializing these filters into a CTE allows Snowflake to optimize join order and reduce fact table scan size.",
    "The new CTE preserves all original WHERE conditions and maintains join semantics with store_sales."
  ],
  "target_ir": "A new CTE named 'dimension_filters' is introduced to prefetch selective dimension keys, which is then joined with store_sales to reduce scan size.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["fact_join_with_dimensions"],
        "outputs": ["AVG(ss_quantity)", "AVG(ss_ext_sales_price)", "AVG(ss_ext_wholesale_cost)", "SUM(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM fact_join_with_dimensions"
      },
      {
        "node_id": "fact_join_with_dimensions",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "dimension_filters", "store", "date_dim"],
        "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost"],
        "changed": true,
        "sql": "SELECT ss.ss_quantity, ss.ss_ext_sales_price, ss.ss_ext_wholesale_cost FROM store_sales ss JOIN dimension_filters df ON ss.ss_cdemo_sk = df.cd_demo_sk AND ss.ss_hdemo_sk = df.hd_demo_sk AND ss.ss_addr_sk = df.ca_address_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN date_dim dd ON ss.ss_sold_date_sk = dd.d_date_sk WHERE dd.d_year = 2001"
      },
      {
        "node_id": "dimension_filters",
        "parent_node_id": "fact_join_with_dimensions",
        "sources": ["customer_demographics", "household_demographics", "customer_address"],
        "outputs": ["cd_demo_sk", "hd_demo_sk", "ca_address_sk"],
        "changed": true,
        "sql": "WITH customer_demographics_filtered AS (SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR (cd_marital_status = 'U' AND cd_education_status = 'College') OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown')), household_demographics_filtered AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)), customer_address_filtered AS (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND (ca_state IN ('CO', 'NC', 'TX') OR ca_state IN ('AR', 'NY', 'TX') OR ca_state IN ('IA', 'IL', 'NC'))) SELECT cd.cd_demo_sk, hd.hd_demo_sk, ca.ca_address_sk FROM customer_demographics_filtered cd, household_demographics_filtered hd, customer_address_filtered ca"
      },
      {
        "node_id": "store",
        "parent_node_id": "fact_join_with_dimensions",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": false
      },
      {
        "node_id": "date_dim",
        "parent_node_id": "fact_join_with_dimensions",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year"],
        "changed": false
      }
    ]
  }
}