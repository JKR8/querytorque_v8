{
  "probe_id": "scout_dimension_cte_isolate",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering dimension tables into CTEs returning only surrogate keys reduces I/O and creates smaller hash tables for faster joins in Snowflake.",
  "reasoning_trace": [
    "Assigned transform targets early selection of dimension tables to reduce probe table size.",
    "Each dimension (customer_demographics, household_demographics, customer_address) has selective filters that can be pushed into CTEs.",
    "CTEs return only surrogate keys to minimize data movement and memory usage.",
    "Join semantics and filter conditions are preserved in the final query structure."
  ],
  "target_ir": "New CTEs for each dimension table with selective filters; main query joins CTEs with store_sales.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "store", "customer_demographics_cte", "household_demographics_cte", "customer_address_cte", "date_dim"],
        "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "select avg(ss_quantity)\n,avg(ss_ext_sales_price)\n,avg(ss_ext_wholesale_cost)\n,sum(ss_ext_wholesale_cost)\nfrom store_sales\n   ,store\n   ,customer_demographics_cte\n   ,household_demographics_cte\n   ,customer_address_cte\n   ,date_dim\nwhere s_store_sk = ss_store_sk\nand  ss_sold_date_sk = d_date_sk and d_year = 2001\nand((ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'M'\nand cd_education_status = '2 yr Degree'\nand ss_sales_price between 100.00 and 150.00\nand hd_dep_count = 3\n   )or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'U'\nand cd_education_status = 'College'\nand ss_sales_price between 50.00 and 100.00\nand hd_dep_count = 1\n   ) or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'S'\nand cd_education_status = 'Unknown'\nand ss_sales_price between 150.00 and 200.00\nand hd_dep_count = 1\n   ))\nand((ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('CO', 'NC', 'TX')\nand ss_net_profit between 100 and 200\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('AR', 'NY', 'TX')\nand ss_net_profit between 150 and 300\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('IA', 'IL', 'NC')\nand ss_net_profit between 50 and 250\n   ))\n;"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M', 'U', 'S') AND cd_education_status IN ('2 yr Degree', 'College', 'Unknown')"
      },
      {
        "node_id": "household_demographics_cte",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_dep_count"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (1, 3)"
      },
      {
        "node_id": "customer_address_cte",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state", "ca_country"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state, ca_country FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX', 'AR', 'NY', 'IA', 'IL')"
      },
      {
        "node_id": "date_dim",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year"],
        "changed": false
      },
      {
        "node_id": "store",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": false
      },
      {
        "node_id": "store_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales"],
        "outputs": ["ss_sold_date_sk", "ss_cdemo_sk", "ss_hdemo_sk", "ss_addr_sk", "ss_store_sk", "ss_quantity", "ss_sales_price", "ss_ext_sales_price", "ss_ext_wholesale_cost", "ss_net_profit"],
        "changed": false
      }
    ]
  }
}