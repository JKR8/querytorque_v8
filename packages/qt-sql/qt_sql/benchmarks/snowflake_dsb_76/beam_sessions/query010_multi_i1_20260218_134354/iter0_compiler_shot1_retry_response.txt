[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.65,
    "based_on": "p01,p03",
    "strategy": "Push date_sk and item_sk filters into fact scans via derived CTEs, preserving EXISTS semantics.",
    "hypothesis": "Primary hotspot is full fact table scans without date_sk pruning. Introducing filtered CTEs for date_dim and item allows predicate pushdown into fact joins while maintaining original EXISTS logic and respecting Snowflake's EXISTS protection guard.",
    "expected_explain_delta": "Fact table scans (store_sales, catalog_sales, web_sales) should show reduced partitions/bytes via microâ€‘partition pruning on sold_date_sk and item_sk ranges.",
    "target_ir": "Add date_filtered and item_filtered CTEs; rewrite EXISTS subqueries to join these CTEs directly.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
          "changed": true,
          "sql": "WITH date_filtered AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11\n),\nitem_filtered AS (\n  SELECT i_item_sk\n  FROM item\n  WHERE i_category IN ('Children', 'Electronics', 'Music')\n    AND i_manager_id BETWEEN 66 AND 75\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  COUNT(*) cnt1,\n  cd_purchase_estimate,\n  COUNT(*) cnt2,\n  cd_credit_rating,\n  COUNT(*) cnt3,\n  cd_dep_count,\n  COUNT(*) cnt4,\n  cd_dep_employed_count,\n  COUNT(*) cnt5,\n  cd_dep_college_count,\n  COUNT(*) cnt6\nFROM\n  customer c,\n  customer_address ca,\n  customer_demographics\nWHERE\n  c.c_current_addr_sk = ca.ca_address_sk\n  AND ca_county IN ('Grays Harbor County','Kootenai County','Pike County','Thomas County','Uinta County')\n  AND c.c_birth_month IN (1, 5)\n  AND cd_demo_sk = c.c_current_cdemo_sk\n  AND cd_marital_status IN ('U', 'U', 'M')\n  AND cd_education_status IN ('College', 'Primary', '2 yr Degree')\n  AND cd_gender = 'M'\n  AND EXISTS (\n    SELECT 1\n    FROM store_sales ss\n    INNER JOIN date_filtered df ON ss.ss_sold_date_sk = df.d_date_sk\n    INNER JOIN item_filtered it ON ss.ss_item_sk = it.i_item_sk\n    WHERE c.c_customer_sk = ss.ss_customer_sk\n      AND ss.ss_sales_price / ss.ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n  )\n  AND (\n    EXISTS (\n      SELECT 1\n      FROM web_sales ws\n      INNER JOIN date_filtered df ON ws.ws_sold_date_sk = df.d_date_sk\n      INNER JOIN item_filtered it ON ws.ws_item_sk = it.i_item_sk\n      WHERE c.c_customer_sk = ws.ws_bill_customer_sk\n        AND ws.ws_sales_price / ws.ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n    )\n    OR\n    EXISTS (\n      SELECT 1\n      FROM catalog_sales cs\n      INNER JOIN date_filtered df ON cs.cs_sold_date_sk = df.d_date_sk\n      INNER JOIN item_filtered it ON cs.cs_item_sk = it.i_item_sk\n      WHERE c.c_customer_sk = cs.cs_ship_customer_sk\n        AND cs.cs_sales_price / cs.cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n    )\n  )\nGROUP BY\n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY\n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100"
        }
      ]
    }
  }
]