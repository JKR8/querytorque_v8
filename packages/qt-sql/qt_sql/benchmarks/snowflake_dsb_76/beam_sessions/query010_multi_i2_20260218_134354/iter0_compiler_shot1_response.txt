[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.65,
    "based_on": "p01",
    "strategy": "Push date_sk range predicate into fact table scans via derived tables, preserving EXISTS semantics.",
    "hypothesis": "Primary hotspot is 2.6TB of fact scans without date_sk predicate. p01 regression suggests CTE fences blocked pruning; inline derived tables may allow Snowflake's join filter pushdown while preserving correlation.",
    "expected_explain_delta": "Fact table scans (store_sales, catalog_sales, web_sales) show date_sk range filter applied before scan, reducing I/O volume.",
    "target_ir": "Replace each EXISTS subquery with derived table joining fact and date_dim early, keeping correlation intact.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
          "changed": true,
          "sql": "select \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3,\n  cd_dep_count,\n  count(*) cnt4,\n  cd_dep_employed_count,\n  count(*) cnt5,\n  cd_dep_college_count,\n  count(*) cnt6\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  ca_county in ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County') and\n  c.c_birth_month in (4, 5) and\n  cd_demo_sk = c.c_current_cdemo_sk\n  and cd_marital_status in ('U', 'S', 'U')\n  and cd_education_status in ('College', 'Secondary', 'College')\n  and cd_gender = 'M' and\n  exists (select *\n          from (select ss_customer_sk, ss_item_sk, ss_list_price, ss_sales_price\n                from store_sales\n                join date_dim on ss_sold_date_sk = d_date_sk\n                where d_year = 1999 and d_moy between 5 and 5+3\n               ) ss, item\n          where c.c_customer_sk = ss_customer_sk and\n                ss_item_sk = i_item_sk and\n                i_category in ('Children', 'Home', 'Women')\n                and ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n                and i_manager_id BETWEEN 91 and 100\n                ) and\n   (exists (select *\n            from (select ws_bill_customer_sk, ws_item_sk, ws_list_price, ws_sales_price\n                  from web_sales\n                  join date_dim on ws_sold_date_sk = d_date_sk\n                  where d_year = 1999 and d_moy between 5 and 5+3\n                 ) ws, item\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_item_sk = i_item_sk and\n                  i_category in ('Children', 'Home', 'Women')\n                  and i_manager_id BETWEEN 91 and 100\n                  and ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n                  ) or\n    exists (select *\n            from (select cs_ship_customer_sk, cs_item_sk, cs_list_price, cs_sales_price\n                  from catalog_sales\n                  join date_dim on cs_sold_date_sk = d_date_sk\n                  where d_year = 1999 and d_moy between 5 and 5+3\n                 ) cs, item\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_item_sk = i_item_sk and\n                  i_category in ('Children', 'Home', 'Women')\n                  and i_manager_id BETWEEN 91 and 100\n                  and cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n                  ))\n group by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n order by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\nlimit 100;"
        }
      ]
    }
  }
]