[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p01",
    "strategy": "Push date filters into UNION ALL branches for micro-partition pruning.",
    "hypothesis": "Predicate pushdown into catalog_sales and web_sales scans can reduce I/O via micro-partition pruning. Although p01 showed a regression, structural benefits remain if applied cleanly without nested CTEs.",
    "expected_explain_delta": "Fact-table scans show narrower partition reads after predicate pushdown.",
    "target_ir": "Introduce filtered sales CTEs and update my_customers source graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["segments"],
          "outputs": ["segment", "num_customers", "segment_base"],
          "changed": false
        },
        {
          "node_id": "segments",
          "parent_node_id": "final_select",
          "sources": ["my_revenue"],
          "outputs": ["segment"],
          "changed": false
        },
        {
          "node_id": "my_revenue",
          "parent_node_id": "segments",
          "sources": ["my_customers", "store_sales", "customer_address", "store", "date_dim"],
          "outputs": ["c_customer_sk", "revenue"],
          "changed": false
        },
        {
          "node_id": "my_customers",
          "parent_node_id": "my_revenue",
          "sources": ["cs_filtered", "item", "date_dim", "customer"],
          "outputs": ["c_customer_sk", "c_current_addr_sk"],
          "changed": false
        },
        {
          "node_id": "cs_filtered",
          "parent_node_id": "my_customers",
          "sources": ["catalog_sales", "web_sales", "date_dim"],
          "outputs": ["sold_date_sk", "customer_sk", "item_sk", "wholesale_cost"],
          "changed": true,
          "sql": "SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_moy = 1 AND d_year = 1998 AND cs_wholesale_cost BETWEEN 35 AND 65 UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_moy = 1 AND d_year = 1998 AND ws_wholesale_cost BETWEEN 35 AND 65"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.68,
    "based_on": "p03",
    "strategy": "Precompute scalar subquery range values to avoid repeated execution.",
    "hypothesis": "Decomposing the d_month_seq subqueries into a precomputed CTE avoids repeated scalar evaluation. This pattern aligns with sf_inline_decorrelate even if prior attempt failed due to syntax.",
    "expected_explain_delta": "Subquery operators disappear and replaced with static range join.",
    "target_ir": "Add month_seq_range CTE and update my_revenue filter predicates.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["segments"],
          "outputs": ["segment", "num_customers", "segment_base"],
          "changed": false
        },
        {
          "node_id": "segments",
          "parent_node_id": "final_select",
          "sources": ["my_revenue"],
          "outputs": ["segment"],
          "changed": false
        },
        {
          "node_id": "my_revenue",
          "parent_node_id": "segments",
          "sources": ["my_customers", "store_sales", "customer_address", "store", "date_dim", "month_seq_range"],
          "outputs": ["c_customer_sk", "revenue"],
          "changed": true,
          "sql": "SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim, month_seq_range WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN month_seq_range.start_seq AND month_seq_range.end_seq GROUP BY c_customer_sk"
        },
        {
          "node_id": "month_seq_range",
          "parent_node_id": "my_revenue",
          "sources": ["date_dim"],
          "outputs": ["start_seq", "end_seq"],
          "changed": true,
          "sql": "SELECT (d_month_seq + 1) AS start_seq, (d_month_seq + 3) AS end_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 1 LIMIT 1"
        },
        {
          "node_id": "my_customers",
          "parent_node_id": "my_revenue",
          "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
          "outputs": ["c_customer_sk", "c_current_addr_sk"],
          "changed": false
        }
      ]
    }
  }
]