{
  "probe_id": "p12",
  "transform_id": "self_join_decomposition",
  "family": "F",
  "status": "failed",
  "failure_reason": "Execution error: Object 'WSS' does not exist or not authorized. The original CTE 'wss' was removed but still referenced in downstream nodes.",
  "partial_work": {
    "attempted_approach": "Decomposed the 'wss' CTE into two filtered CTEs (wss1 and wss2) to enable early pruning.",
    "blocking_issue": "The final_select node still references the original 'wss' CTE which no longer exists, causing a compilation error.",
    "hypothesis_still_valid": false
  },
  "dialect": "snowflake",
  "hypothesis": "Decomposing the self-joined 'wss' CTE with embedded filters should reduce I/O by enabling micro-partition pruning on store_sales.",
  "reasoning_trace": [
    "The original 'wss' CTE is scanned twice with different filters, suggesting an opportunity for decomposition.",
    "Splitting 'wss' into two CTEs (wss1 and wss2) with embedded month filters allows early pruning of store_sales.",
    "However, the final_select node still references the original 'wss' CTE, which causes a compilation error."
  ],
  "target_ir": "wss CTE split into wss1 and wss2, each with embedded date filters; final_select references both new CTEs instead of the original wss.",
  "verification": {
    "executable": false,
    "no_missing_tables": true,
    "alias_consistent": false,
    "no_orphan_scans": false,
    "semantics_preserved": false,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["wss1", "wss2", "store", "date_dim"],
        "outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_sales1 / sun_sales2", "mon_sales1 / mon_sales2", "tue_sales1 / tue_sales2", "wed_sales1 / wed_sales2", "thu_sales1 / thu_sales2", "fri_sales1 / fri_sales2", "sat_sales1 / sat_sales2"],
        "changed": true,
        "sql": "SELECT s_store_name1, s_store_id1, d_week_seq1, sun_sales1 / sun_sales2, mon_sales1 / mon_sales2, tue_sales1 / tue_sales2, wed_sales1 / wed_sales2, thu_sales1 / thu_sales2, fri_sales1 / fri_sales2, sat_sales1 / sat_sales2 FROM (SELECT s_store_name AS s_store_name1, wss1.d_week_seq AS d_week_seq1, s_store_id AS s_store_id1, sun_sales AS sun_sales1, mon_sales AS mon_sales1, tue_sales AS tue_sales1, wed_sales AS wed_sales1, thu_sales AS thu_sales1, fri_sales AS fri_sales1, sat_sales AS sat_sales1 FROM wss1, store, date_dim AS d WHERE d.d_week_seq = wss1.d_week_seq AND ss_store_sk = s_store_sk AND d_month_seq BETWEEN 1187 AND 1187 + 11 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'NC', 'NY', 'PA', 'TX')) AS y, (SELECT s_store_name AS s_store_name2, wss2.d_week_seq AS d_week_seq2, s_store_id AS s_store_id2, sun_sales AS sun_sales2, mon_sales AS mon_sales2, tue_sales AS tue_sales2, wed_sales AS wed_sales2, thu_sales AS thu_sales2, fri_sales AS fri_sales2, sat_sales AS sat_sales2 FROM wss2, store, date_dim AS d WHERE d.d_week_seq = wss2.d_week_seq AND ss_store_sk = s_store_sk AND d_month_seq BETWEEN 1187 + 12 AND 1187 + 23 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'NC', 'NY', 'PA', 'TX')) AS x WHERE s_store_id1 = s_store_id2 AND d_week_seq1 = d_week_seq2 - 52 ORDER BY s_store_name1, s_store_id1, d_week_seq1 LIMIT 100"
      },
      {
        "node_id": "wss1",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim"],
        "outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
        "changed": true,
        "sql": "SELECT d_week_seq, ss_store_sk, SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales, date_dim WHERE d_date_sk = ss_sold_date_sk AND ss_sales_price / ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01 AND d_month_seq BETWEEN 1187 AND 1187 + 11 GROUP BY d_week_seq, ss_store_sk"
      },
      {
        "node_id": "wss2",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim"],
        "outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
        "changed": true,
        "sql": "SELECT d_week_seq, ss_store_sk, SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales, date_dim WHERE d_date_sk = ss_sold_date_sk AND ss_sales_price / ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01 AND d_month_seq BETWEEN 1187 + 12 AND 1187 + 23 GROUP BY d_week_seq, ss_store_sk"
      }
    ]
  }
}