[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p02",
    "strategy": "Aggregate pushdown to reduce fact table rows before joining to dimensions.",
    "hypothesis": "Probe p02 (WIN, 1.17x) pre‑aggregates store_sales by all dimension foreign keys, cutting join cardinality early. No semantic drift because foreign‑key joins preserve rollup granularity. Residual hotspot reduced by ~80% (aggregate shrinks 1.2TB scan).",
    "expected_explain_delta": "Store_sales scan followed by aggregate before joins; reduced rows flow into later rollup.",
    "target_ir": "Add store_sales_agg CTE and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales_agg", "date_dim", "customer_demographics", "store", "item"],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "SELECT i_item_id,\n       s_state,\n       grouping(s_state) g_state,\n       avg(ss_quantity) agg1,\n       avg(ss_list_price) agg2,\n       avg(ss_coupon_amt) agg3,\n       avg(ss_sales_price) agg4\nFROM store_sales_agg ssa\nJOIN date_dim d ON ssa.ss_sold_date_sk = d.d_date_sk\nJOIN customer_demographics cd ON ssa.ss_cdemo_sk = cd.cd_demo_sk\nJOIN store s ON ssa.ss_store_sk = s.s_store_sk\nJOIN item i ON ssa.ss_item_sk = i.i_item_sk\nWHERE cd_gender = 'M'\n  AND cd_marital_status = 'W'\n  AND cd_education_status = 'Secondary'\n  AND d_year = 1999\n  AND s_state = 'OH'\n  AND i_category = 'Music'\nGROUP BY ROLLUP (i_item_id, s_state)\nORDER BY i_item_id, s_state\nLIMIT 100"
        },
        {
          "node_id": "store_sales_agg",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_store_sk", "ss_cdemo_sk", "ss_sold_date_sk", "sum_ss_quantity", "count_ss_quantity", "sum_ss_list_price", "count_ss_list_price", "sum_ss_coupon_amt", "count_ss_coupon_amt", "sum_ss_sales_price", "count_ss_sales_price"],
          "changed": true,
          "sql": "SELECT ss_item_sk,\n       ss_store_sk,\n       ss_cdemo_sk,\n       ss_sold_date_sk,\n       SUM(ss_quantity) AS sum_ss_quantity,\n       COUNT(ss_quantity) AS count_ss_quantity,\n       SUM(ss_list_price) AS sum_ss_list_price,\n       COUNT(ss_list_price) AS count_ss_list_price,\n       SUM(ss_coupon_amt) AS sum_ss_coupon_amt,\n       COUNT(ss_coupon_amt) AS count_ss_coupon_amt,\n       SUM(ss_sales_price) AS sum_ss_sales_price,\n       COUNT(ss_sales_price) AS count_ss_sales_price\nFROM store_sales\nWHERE ss_sold_date_sk IS NOT NULL\n  AND ss_cdemo_sk IS NOT NULL\n  AND ss_store_sk IS NOT NULL\n  AND ss_item_sk IS NOT NULL\nGROUP BY ss_item_sk, ss_store_sk, ss_cdemo_sk, ss_sold_date_sk"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p03",
    "strategy": "Multi‑dimension prefetch to push filters early and prune fact join.",
    "hypothesis": "Probe p03 (WIN, 1.17x) isolates each dimension filter into a CTE, enabling predicate pushdown and reducing join cardinality. No semantic drift; all filters are preserved and join keys remain unchanged.",
    "expected_explain_delta": "Dimension tables scanned first with filters; fact table joined to pre‑filtered dimension CTEs, reducing intermediate rows.",
    "target_ir": "Add four dimension CTEs and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "date_dim_filtered", "customer_demographics_filtered", "store_filtered", "item_filtered"],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "SELECT i_item_id,\n       s_state,\n       grouping(s_state) g_state,\n       avg(ss_quantity) agg1,\n       avg(ss_list_price) agg2,\n       avg(ss_coupon_amt) agg3,\n       avg(ss_sales_price) agg4\nFROM store_sales ss\nJOIN date_dim_filtered d ON ss.ss_sold_date_sk = d.d_date_sk\nJOIN customer_demographics_filtered cd ON ss.ss_cdemo_sk = cd.cd_demo_sk\nJOIN store_filtered s ON ss.ss_store_sk = s.s_store_sk\nJOIN item_filtered i ON ss.ss_item_sk = i.i_item_sk\nGROUP BY ROLLUP (i_item_id, s_state)\nORDER BY i_item_id, s_state\nLIMIT 100"
        },
        {
          "node_id": "date_dim_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "customer_demographics_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'W' AND cd_education_status = 'Secondary'"
        },
        {
          "node_id": "store_filtered",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk", "s_state"],
          "changed": true,
          "sql": "SELECT s_store_sk, s_state FROM store WHERE s_state = 'OH'"
        },
        {
          "node_id": "item_filtered",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_id"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Music'"
        }
      ]
    }
  }
]