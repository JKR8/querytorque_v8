{
  "iteration": 0,
  "n_api_calls": 9,
  "beam_cost_usd": 0.02846654,
  "beam_cost_priced_calls": 9,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 89464,
    "completion_tokens": 22761,
    "total_tokens": 112225,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 26368,
    "reasoning_tokens": 13458
  },
  "best_speedup": 1.08,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_ctr_total_return FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk AND ctr1.ctr_total_return > sa.avg_ctr_total_return, store, customer, customer_demographics WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IL', 'KY', 'TX') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
  "patches": [
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 151.9,
      "patch_ms": 161.6,
      "output_sql": "WITH store_returns_preagg AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, sr_returned_date_sk, sr_return_quantity, sr_return_amt, sr_return_amt_inc_tax FROM store_returns), customer_total_return AS (SELECT sr.sr_customer_sk AS ctr_customer_sk, sr.sr_store_sk AS ctr_store_sk, sr.sr_reason_sk AS ctr_reason_sk, SUM(sr.sr_return_amt_inc_tax) AS ctr_total_return FROM store_returns_preagg sr JOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr.sr_customer_sk, sr.sr_store_sk, sr.sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IL', 'KY', 'TX') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011aggregate store_returns by store_sk before joining with date_dim and applying the ratio condition, then aggregate by customer_sk, store_sk, reason_sk in the CTE."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "sf_inline_decorrelate",
      "relevance_score": 0.85,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Row count: orig=9, patch=12",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH shared_scan AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, sr_return_amt_inc_tax\nFROM store_returns sr\nJOIN date_dim d ON sr_returned_date_sk = d_date_sk\nWHERE d_year = 2002\n  AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167), threshold AS (SELECT sr_store_sk AS ctr_store_sk, AVG(sr_return_amt_inc_tax) * 1.2 AS avg_ctr_total_return\nFROM shared_scan\nGROUP BY sr_store_sk), decorrelated_main AS (SELECT ss.sr_customer_sk AS ctr_customer_sk,\n       ss.sr_store_sk AS ctr_store_sk,\n       ss.sr_reason_sk AS ctr_reason_sk,\n       SUM(ss.sr_return_amt_inc_tax) AS ctr_total_return\nFROM shared_scan ss\nJOIN threshold t ON ss.sr_store_sk = t.ctr_store_sk\nGROUP BY ss.sr_customer_sk, ss.sr_store_sk, ss.sr_reason_sk\nHAVING SUM(ss.sr_return_amt_inc_tax) > MAX(t.avg_ctr_total_return)) SELECT c_customer_id\nFROM decorrelated_main dm\nJOIN store s ON s_store_sk = dm.ctr_store_sk\nJOIN customer c ON dm.ctr_customer_sk = c_customer_sk\nJOIN customer_demographics cd ON c_current_cdemo_sk = cd_demo_sk\nWHERE dm.ctr_reason_sk BETWEEN 43 AND 46\n  AND s_state IN ('IL', 'KY', 'TX')\n  AND cd_marital_status IN ('M', 'M')\n  AND cd_education_status IN ('Advanced Degree', 'College')\n  AND cd_gender = 'F'\n  AND c_birth_month = 2\n  AND c_birth_year BETWEEN 1965 AND 1971\nORDER BY c_customer_id\nLIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Decompose correlated scalar subquery into 3 CTEs: (1) shared scan of store_returns with date_dim filter and ratio condition, (2) per-store_sk average threshold, (3) filtered main query joining threshold CTE."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.4,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 151.9,
      "patch_ms": 164.8,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IL', 'KY', 'TX') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011filter the dimension tables (store, customer, customer_demographics) into CTEs and join them with the customer_total_return CTE earlier in the final_select."
    },
    {
      "patch_id": "p03",
      "family": "B",
      "transform": "sf_shared_scan_decorrelate",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Unchanged node `store` must omit sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create a shared\u2011scan CTE for store_returns joined with date_dim, then derive two aggregates from it: one for the three\u2011column grouping (customer, store, reason) and one for the per\u2011store average threshold."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "IMPROVED",
      "speedup": 1.08,
      "semantic_passed": true,
      "error": null,
      "original_ms": 197.4,
      "patch_ms": 182.5,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_ctr_total_return FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk AND ctr1.ctr_total_return > sa.avg_ctr_total_return, store, customer, customer_demographics WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IL', 'KY', 'TX') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 197.4,
      "patch_ms": 214.7,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_avg_threshold AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN store_avg_threshold sat ON ctr1.ctr_store_sk = sat.ctr_store_sk AND ctr1.ctr_total_return > sat.avg_threshold JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK)\n1 | 5 | [4] | Filter | STORE.S_STATE IN 'IL' IN 'KY' IN 'TX'\n1 | 6 |",
    "p04": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK)\n1 | 5 | [4] | Filter | STORE.S_STATE IN 'IL' IN 'KY' IN 'TX'\n1 | 6 |",
    "compile_p1": "GlobalStats | 7334 | 7334 | 127101705728\n1 | 0 | Result | CUSTOMER.C_CUSTOMER_ID\n1 | 1 | [0] | SortWithLimit | sortKey: [CUSTOMER.C_CUSTOMER_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | InnerJoin | joinKey: (CUSTOMER.C_CURRENT_CDEMO_SK = CUSTOMER_DEMOGRAPHICS.CD_DEMO_SK)\n1 | 3 | [2] | InnerJoin | joinKey: (CTR1.CTR_CUSTOMER_SK = CUSTOMER.C_CUSTOMER_SK)\n1 | 4 | [3] | InnerJoin | joinKey: (STORE.S_STORE_SK = CTR1.CTR_STORE_SK), joinFilter: (CTR1.CTR_TOTAL_RETURN) > (((SUM(CUSTOMER_TOTAL_RETURN."
  }
}