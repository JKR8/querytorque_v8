[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p01,p03",
    "strategy": "Decorrelation via pre‑aggregated store‑level thresholds, preserving original grouping and filter semantics.",
    "hypothesis": "Original plan shows correlated per‑store AVG rescanning aggregated CTE. Winning decorrelation pattern from Snowflake evidence (sf_inline_decorrelate) can be adapted safely by computing store‑level thresholds from the same base scan and joining before final filtering.",
    "expected_explain_delta": "Correlated scalar aggregate subquery replaced with a single‑scan CTE of store‑level averages; join‑filter on store_sk remains.",
    "target_ir": "Replace correlated subquery with a separate CTE that computes store‑level average thresholds, then join in final_select.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "store_avg_threshold", "store", "customer", "customer_demographics"],
          "outputs": ["c_customer_id"],
          "changed": true,
          "sql": "SELECT c_customer_id FROM customer_total_return ctr1 JOIN store_avg_threshold sat ON ctr1.ctr_store_sk = sat.ctr_store_sk AND ctr1.ctr_total_return > sat.avg_threshold JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100"
        },
        {
          "node_id": "store_avg_threshold",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_store_sk", "avg_threshold"],
          "changed": true,
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "date_dim"],
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
          "changed": false
        }
      ]
    }
  }
]