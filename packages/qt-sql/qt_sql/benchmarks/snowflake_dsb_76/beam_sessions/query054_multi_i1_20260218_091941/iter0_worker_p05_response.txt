{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering selective dimension tables (customer_address, store, date_dim) into dedicated CTEs reduces fact table scan size and improves join efficiency.",
  "reasoning_trace": [
    "Assigned transform targets multi-dimension prefetch where selective filters exist on customer_address, store, and date_dim.",
    "Current plan shows repeated scans of large fact tables without early filtering.",
    "Introducing pre-filtered CTEs for dimensions aligns with Snowflake's pruning and join-filter pushdown strengths."
  ],
  "target_ir": "Introduce pre-filtered CTEs for customer_address, store, and date_dim before joining with store_sales.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["segments"],
        "outputs": ["segment", "num_customers", "segment_base"],
        "changed": false
      },
      {
        "node_id": "segments",
        "parent_node_id": "final_select",
        "sources": ["my_revenue"],
        "outputs": ["segment"],
        "changed": false
      },
      {
        "node_id": "my_revenue",
        "parent_node_id": "segments",
        "sources": ["my_customers", "store_sales", "customer_address_prefiltered", "store_prefiltered", "date_dim_prefiltered"],
        "outputs": ["c_customer_sk", "revenue"],
        "changed": true,
        "sql": "SELECT c_customer_sk, sum(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address_prefiltered, store_prefiltered, date_dim_prefiltered WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk"
      },
      {
        "node_id": "my_customers",
        "parent_node_id": "my_revenue",
        "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
        "outputs": ["c_customer_sk", "c_current_addr_sk"],
        "changed": false
      },
      {
        "node_id": "customer_address_prefiltered",
        "parent_node_id": "my_revenue",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_county", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_county, ca_state FROM customer_address WHERE ca_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND ca_county IS NOT NULL AND ca_state IS NOT NULL"
      },
      {
        "node_id": "store_prefiltered",
        "parent_node_id": "my_revenue",
        "sources": ["store"],
        "outputs": ["s_county", "s_state"],
        "changed": true,
        "sql": "SELECT s_county, s_state FROM store WHERE s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND s_county IS NOT NULL AND s_state IS NOT NULL"
      },
      {
        "node_id": "date_dim_prefiltered",
        "parent_node_id": "my_revenue",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_month_seq"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1)"
      }
    ]
  }
}