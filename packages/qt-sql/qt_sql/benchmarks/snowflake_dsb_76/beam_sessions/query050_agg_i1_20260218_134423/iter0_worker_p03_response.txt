{
  "probe_id": "scout_lane_multi_dimension_prefetch",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-filtering d1 and d2 into narrow CTEs before joining to fact tables reduces I/O and enables early pruning of store_sales and store_returns.",
  "reasoning_trace": [
    "Assigned transform targets multi-dimension prefetch to reduce fact-table scan pressure.",
    "Date_dim filters are selective and can be isolated into CTEs to enable micro-partition pruning.",
    "Join filters on d1.d_date can push into store_sales scan when d1 is pre-filtered."
  ],
  "target_ir": "d1 and d2 become CTEs with only required columns; fact tables join to these narrow CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["main_query"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": false
      },
      {
        "node_id": "main_query",
        "parent_node_id": "final_select",
        "sources": ["store_sales_prefetch", "store_returns_prefetch", "store", "d1_prefetch", "d2_prefetch"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "WITH d2_prefetch AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_year = 2000\n    AND d_moy = 8\n),\n\nd1_prefetch AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim d2\n  JOIN d2_prefetch ON d2.d_date_sk = d2_prefetch.d_date_sk\n  JOIN date_dim d1 ON d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date\n)\n\nSELECT \n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nfrom\n   store_sales_prefetch\n  ,store_returns_prefetch\n  ,store\n  ,d1_prefetch\n  ,d2_prefetch\nwhere\n    ss_ticket_number = sr_ticket_number\nand ss_item_sk = sr_item_sk\nand ss_sold_date_sk   = d1_prefetch.d_date_sk\nand sr_returned_date_sk   = d2_prefetch.d_date_sk\nand ss_customer_sk = sr_customer_sk\nand ss_store_sk = s_store_sk\ngroup by\n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\norder by s_store_name\n        ,s_company_id\n        ,s_street_number\n        ,s_street_name\n        ,s_street_type\n        ,s_suite_number\n        ,s_city\n        ,s_county\n        ,s_state\n        ,s_zip\nlimit 100"
      },
      {
        "node_id": "store_sales_prefetch",
        "parent_node_id": "main_query",
        "sources": ["store_sales"],
        "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_customer_sk", "ss_store_sk", "ss_ticket_number"],
        "changed": true,
        "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, ss_ticket_number\nFROM store_sales\nWHERE ss_sold_date_sk IS NOT NULL\n  AND ss_customer_sk IS NOT NULL\n  AND ss_store_sk IS NOT NULL"
      },
      {
        "node_id": "store_returns_prefetch",
        "parent_node_id": "main_query",
        "sources": ["store_returns"],
        "outputs": ["sr_returned_date_sk", "sr_item_sk", "sr_customer_sk", "sr_ticket_number"],
        "changed": true,
        "sql": "SELECT sr_returned_date_sk, sr_item_sk, sr_customer_sk, sr_ticket_number\nFROM store_returns\nWHERE sr_returned_date_sk IS NOT NULL\n  AND sr_customer_sk IS NOT NULL"
      },
      {
        "node_id": "d2_prefetch",
        "parent_node_id": "main_query",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "d1_prefetch",
        "parent_node_id": "main_query",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "store",
        "parent_node_id": "main_query",
        "sources": [],
        "outputs": ["s_store_sk", "s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip"],
        "changed": false
      }
    ]
  }
}