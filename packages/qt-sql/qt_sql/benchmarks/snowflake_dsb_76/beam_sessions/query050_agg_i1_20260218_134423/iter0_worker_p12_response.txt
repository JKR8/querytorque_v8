{
  "probe_id": "scout_lane_deferred_window_aggregation",
  "transform_id": "deferred_window_aggregation",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Deferring final aggregation until after joins reduces row flow and avoids early aggregation overhead. Pre-aggregating fact tables preserves semantics while reducing intermediate size.",
  "reasoning_trace": [
    "Assigned transform targets final aggregation deferral to reduce compute on wide intermediate sets.",
    "store_sales and store_returns are pre-aggregated to reduce row volume before join.",
    "Final aggregation is moved to occur after all joins, preserving GROUP BY and output semantics."
  ],
  "target_ir": "Pre-aggregate store_sales and store_returns; defer final aggregation to new CTE layer.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["aggregated_result"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": false
      },
      {
        "node_id": "aggregated_result",
        "parent_node_id": "final_select",
        "sources": ["joined_data", "store"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "SELECT \n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and\n                 (sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (sr_returned_date_sk - ss_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nFROM\n   joined_data\n  ,store\nWHERE\n    ss_store_sk = s_store_sk\ngroup by\n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\norder by s_store_name\n        ,s_company_id\n        ,s_street_number\n        ,s_street_name\n        ,s_street_type\n        ,s_suite_number\n        ,s_city\n        ,s_county\n        ,s_state\n        ,s_zip\nlimit 100"
      },
      {
        "node_id": "joined_data",
        "parent_node_id": "aggregated_result",
        "sources": ["preagg_store_sales", "preagg_store_returns", "d1", "d2"],
        "outputs": ["ss_sold_date_sk", "ss_store_sk", "sr_returned_date_sk", "ss_customer_sk", "sr_customer_sk", "ss_item_sk", "sr_item_sk", "ss_ticket_number", "sr_ticket_number"],
        "changed": true,
        "sql": "SELECT \n    ss.ss_sold_date_sk,\n    ss.ss_store_sk,\n    sr.sr_returned_date_sk,\n    ss.ss_customer_sk,\n    sr.sr_customer_sk,\n    ss.ss_item_sk,\n    sr.sr_item_sk,\n    ss.ss_ticket_number,\n    sr.sr_ticket_number\nFROM\n    preagg_store_sales ss\nJOIN\n    preagg_store_returns sr\nON\n    ss.ss_customer_sk = sr.sr_customer_sk\n    AND ss.ss_item_sk = sr.sr_item_sk\n    AND ss.ss_ticket_number = sr.sr_ticket_number\nJOIN\n    date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk\nJOIN\n    date_dim d2 ON sr.sr_returned_date_sk = d2.d_date_sk\nWHERE\n    d2.d_year = 2000\n    AND d2.d_moy = 8\n    AND d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date"
      },
      {
        "node_id": "preagg_store_sales",
        "parent_node_id": "joined_data",
        "sources": ["store_sales"],
        "outputs": ["ss_sold_date_sk", "ss_store_sk", "ss_customer_sk", "ss_item_sk", "ss_ticket_number"],
        "changed": true,
        "sql": "SELECT\n    ss_sold_date_sk,\n    ss_store_sk,\n    ss_customer_sk,\n    ss_item_sk,\n    ss_ticket_number\nFROM\n    store_sales\nWHERE\n    ss_store_sk IS NOT NULL\n    AND ss_sold_date_sk IS NOT NULL\n    AND ss_customer_sk IS NOT NULL"
      },
      {
        "node_id": "preagg_store_returns",
        "parent_node_id": "joined_data",
        "sources": ["store_returns"],
        "outputs": ["sr_returned_date_sk", "sr_customer_sk", "sr_item_sk", "sr_ticket_number"],
        "changed": true,
        "sql": "SELECT\n    sr_returned_date_sk,\n    sr_customer_sk,\n    sr_item_sk,\n    sr_ticket_number\nFROM\n    store_returns\nWHERE\n    sr_customer_sk IS NOT NULL\n    AND sr_returned_date_sk IS NOT NULL"
      },
      {
        "node_id": "d1",
        "parent_node_id": "joined_data",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": false
      },
      {
        "node_id": "d2",
        "parent_node_id": "joined_data",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year", "d_moy"],
        "changed": false
      },
      {
        "node_id": "store",
        "parent_node_id": "aggregated_result",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip"],
        "changed": false
      }
    ]
  }
}