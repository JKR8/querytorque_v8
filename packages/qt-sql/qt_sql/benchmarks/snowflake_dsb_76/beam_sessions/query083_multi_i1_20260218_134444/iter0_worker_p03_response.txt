{
  "probe_id": "scout_1",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-aggregating each fact table (store_returns, catalog_returns, web_returns) by item_sk and date_sk before joining with dimensions reduces row volume into expensive dimension joins while preserving output semantics.",
  "reasoning_trace": [
    "Assigned transform targets early aggregation of fact tables to reduce join input size.",
    "Each fact table scan shows full partition access despite date constraints, indicating predicate pushdown failure due to subquery correlation.",
    "Grouping keys (item_sk, date_sk) align with downstream join keys enabling safe pushdown without semantic drift.",
    "Item-level filters (i_category, i_manager_id) remain after aggregation but are applied once per item rather than per fact-row."
  ],
  "target_ir": "Each fact CTE (sr_items, cr_items, wr_items) becomes a two-stage operation: early aggregate on item_sk/date_sk, then joined with item/dimensions.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["sr_items", "cr_items", "wr_items"],
        "outputs": ["item_id", "sr_item_qty", "sr_dev", "cr_item_qty", "cr_dev", "wr_item_qty", "wr_dev", "average"],
        "changed": false
      },
      {
        "node_id": "sr_items",
        "parent_node_id": "final_select",
        "sources": ["store_returns_agg", "item", "date_dim"],
        "outputs": ["item_id", "sr_item_qty"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM (SELECT sr_item_sk, sr_returned_date_sk, SUM(sr_return_quantity) AS sr_return_quantity FROM store_returns WHERE sr_return_amt / sr_return_quantity BETWEEN 237 AND 266 AND sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY sr_item_sk, sr_returned_date_sk) sr_agg JOIN item ON sr_agg.sr_item_sk = i_item_sk JOIN date_dim ON sr_agg.sr_returned_date_sk = d_date_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))) WHERE i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 GROUP BY i_item_id"
      },
      {
        "node_id": "cr_items",
        "parent_node_id": "final_select",
        "sources": ["catalog_returns_agg", "item", "date_dim"],
        "outputs": ["item_id", "cr_item_qty"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM (SELECT cr_item_sk, cr_returned_date_sk, SUM(cr_return_quantity) AS cr_return_quantity FROM catalog_returns WHERE cr_return_amount / cr_return_quantity BETWEEN 237 AND 266 AND cr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY cr_item_sk, cr_returned_date_sk) cr_agg JOIN item ON cr_agg.cr_item_sk = i_item_sk JOIN date_dim ON cr_agg.cr_returned_date_sk = d_date_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))) WHERE i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 GROUP BY i_item_id"
      },
      {
        "node_id": "wr_items",
        "parent_node_id": "final_select",
        "sources": ["web_returns_agg", "item", "date_dim"],
        "outputs": ["item_id", "wr_item_qty"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM (SELECT wr_item_sk, wr_returned_date_sk, SUM(wr_return_quantity) AS wr_return_quantity FROM web_returns WHERE wr_return_amt / wr_return_quantity BETWEEN 237 AND 266 AND wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY wr_item_sk, wr_returned_date_sk) wr_agg JOIN item ON wr_agg.wr_item_sk = i_item_sk JOIN date_dim ON wr_agg.wr_returned_date_sk = d_date_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))) WHERE i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 GROUP BY i_item_id"
      }
    ]
  }
}