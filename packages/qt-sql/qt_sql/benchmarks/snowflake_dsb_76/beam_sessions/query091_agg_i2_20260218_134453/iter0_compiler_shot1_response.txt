[  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Push date_sk range filter into fact scan using min/max surrogate key derived from filtered date_dim.",
    "hypothesis": "Primary hotspot is full CATALOG_RETURNS scan (82.5 GB) without date pruning. Probe p01 (2.15x) proves explicit date_sk range filter enables micro‑partition pruning, addressing PREDICATE_TRANSITIVITY_FAILURE gap.",
    "expected_explain_delta": "CATALOG_RETURNS scan shows reduced partitions and bytes; date_sk range filter appears before join.",
    "target_ir": "Add date_sk_range CTE and inject cr_returned_date_sk BETWEEN predicate into final_select.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_sk_range", "call_center", "catalog_returns", "date_dim", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH date_sk_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM call_center, catalog_returns, date_dim, customer, customer_address, customer_demographics, household_demographics, date_sk_range WHERE cr_call_center_sk = cc_call_center_sk AND cr_returned_date_sk = d_date_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND d_year = 2001 AND d_moy = 12 AND ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '>10000%' AND ca_gmt_offset = -6 AND cr_returned_date_sk BETWEEN date_sk_range.min_date_sk AND date_sk_range.max_date_sk GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "date_sk_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["min_date_sk", "max_date_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.80,
    "based_on": "p01,p03",
    "strategy": "Combine date_sk range pushdown with early aggregation to reduce both scan I/O and join cardinality.",
    "hypothesis": "Secondary amplification from nested aggregates can be mitigated by pre‑aggregating filtered fact rows. Probe p03 (2.15x) shows early aggregation safe; merging with p01's range filter reduces input to aggregation.",
    "expected_explain_delta": "CATALOG_RETURNS scan pruned by date_sk range, then aggregated before dimension joins, reducing downstream aggregation stages.",
    "target_ir": "Add date_sk_range and agg_catalog_returns CTEs; rewrite final_select to join aggregated fact.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["agg_catalog_returns", "call_center", "date_dim", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH date_sk_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12), agg_catalog_returns AS (SELECT cr_returning_customer_sk, cr_call_center_sk, cr_returned_date_sk, SUM(cr_net_loss) AS cr_net_loss FROM catalog_returns, date_sk_range WHERE cr_call_center_sk IS NOT NULL AND cr_returning_customer_sk IS NOT NULL AND cr_returned_date_sk BETWEEN date_sk_range.min_date_sk AND date_sk_range.max_date_sk GROUP BY cr_returning_customer_sk, cr_call_center_sk, cr_returned_date_sk) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM agg_catalog_returns, call_center, date_dim, customer, customer_address, customer_demographics, household_demographics WHERE cr_call_center_sk = cc_call_center_sk AND cr_returned_date_sk = d_date_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND d_year = 2001 AND d_moy = 12 AND ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '>10000%' AND ca_gmt_offset = -6 GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        },
        {
          "node_id": "date_sk_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["min_date_sk", "max_date_sk"],
          "changed": true,
          "sql": "SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12"
        },
        {
          "node_id": "agg_catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["date_sk_range", "catalog_returns"],
          "outputs": ["cr_returning_customer_sk", "cr_call_center_sk", "cr_returned_date_sk", "cr_net_loss"],
          "changed": true,
          "sql": "SELECT cr_returning_customer_sk, cr_call_center_sk, cr_returned_date_sk, SUM(cr_net_loss) AS cr_net_loss FROM catalog_returns, date_sk_range WHERE cr_call_center_sk IS NOT NULL AND cr_returning_customer_sk IS NOT NULL AND cr_returned_date_sk BETWEEN date_sk_range.min_date_sk AND date_sk_range.max_date_sk GROUP BY cr_returning_customer_sk, cr_call_center_sk, cr_returned_date_sk"
        }
      ]
    }
  }
]