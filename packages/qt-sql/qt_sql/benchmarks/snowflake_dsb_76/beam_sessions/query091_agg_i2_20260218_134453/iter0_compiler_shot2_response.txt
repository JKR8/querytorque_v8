[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Date range pushdown to prune fact micro-partitions.",
    "hypothesis": "Primary hotspot is 82.5 GB catalog_returns scan without date_sk pruning. Adding explicit cr_returned_date_sk BETWEEN filter derived from filtered date_dim directly targets predicate transitivity failure.",
    "expected_explain_delta": "Catalog_returns scan with date_sk range filter, reducing I/O from 82.5 GB to a fraction.",
    "target_ir": "Add date_sk_range CTE and push date_sk range into catalog_returns scan.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["call_center", "catalog_returns", "date_dim", "customer", "customer_address", "customer_demographics", "household_demographics", "date_sk_range"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH date_sk_range AS (SELECT MIN(d_date_sk) AS min_date_sk, MAX(d_date_sk) AS max_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM call_center, catalog_returns, date_dim, customer, customer_address, customer_demographics, household_demographics, date_sk_range WHERE cr_call_center_sk = cc_call_center_sk AND cr_returned_date_sk = d_date_sk AND cr_returning_customer_sk = c_customer_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND ca_address_sk = c_current_addr_sk AND d_year = 2001 AND d_moy = 12 AND ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')) AND hd_buy_potential LIKE '>10000%' AND ca_gmt_offset = -6 AND cr_returned_date_sk BETWEEN date_sk_range.min_date_sk AND date_sk_range.max_date_sk GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.80,
    "based_on": "p02",
    "strategy": "Dimension isolation to simplify join graph and enable storage pruning.",
    "hypothesis": "Isolating dimension filters into CTEs encourages predicate pushdown and reduces fact scan I/O. All dimension tables are fully pruned (parts=1/1), so CTE overhead is minimal.",
    "expected_explain_delta": "Catalog_returns scan with pushed predicates from dimension CTEs, reducing I/O.",
    "target_ir": "Create CTEs for each dimension table with filters applied, then join with catalog_returns.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_returns", "date_dim_cte", "customer_cte", "customer_address_cte", "customer_demographics_cte", "household_demographics_cte", "call_center_cte"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH date_dim_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_moy = 12), customer_cte AS (SELECT c_customer_sk, c_current_cdemo_sk, c_current_hdemo_sk, c_current_addr_sk FROM customer), customer_address_cte AS (SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -6), customer_demographics_cte AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')), household_demographics_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential LIKE '>10000%'), call_center_cte AS (SELECT cc_call_center_sk, cc_call_center_id, cc_name, cc_manager FROM call_center) SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM catalog_returns, date_dim_cte, customer_cte, customer_address_cte, customer_demographics_cte, household_demographics_cte, call_center_cte WHERE cr_returned_date_sk = d_date_sk AND cr_returning_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND c_current_hdemo_sk = hd_demo_sk AND c_current_addr_sk = ca_address_sk AND cr_call_center_sk = cc_call_center_sk GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC"
        }
      ]
    }
  }
]