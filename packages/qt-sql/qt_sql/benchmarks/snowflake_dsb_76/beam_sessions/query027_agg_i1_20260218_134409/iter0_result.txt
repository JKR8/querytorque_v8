{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 7,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 1.07,
  "best_patch_id": "p04",
  "best_sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), fact_prefetch AS (SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_cdemo_sk, ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price FROM store_sales ss JOIN date_filtered d ON ss.ss_sold_date_sk = d.d_date_sk), joined_dims AS (SELECT i.i_item_id, s.s_state, f.ss_quantity, f.ss_list_price, f.ss_coupon_amt, f.ss_sales_price FROM fact_prefetch f JOIN item i ON f.ss_item_sk = i.i_item_sk JOIN store s ON f.ss_store_sk = s.s_store_sk JOIN customer_demographics cd ON f.ss_cdemo_sk = cd.cd_demo_sk WHERE i.i_category = 'Sports' AND s.s_state = 'IA' AND cd.cd_gender = 'F' AND cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Primary'), agg_result AS (SELECT i_item_id, s_state, ss_quantity, ss_list_price, ss_coupon_amt, ss_sales_price FROM joined_dims) SELECT i_item_id, s_state, grouping(s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM agg_result GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100;",
  "patches": [
    {
      "patch_id": "p10",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.38,
      "status": "NEUTRAL",
      "speedup": 0.98,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 180.9,
      "output_sql": "SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN store ON ss_store_sk = s_store_sk INNER JOIN item ON ss_item_sk = i_item_sk INNER JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports' GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert the implicit comma\u2011join pattern to explicit INNER JOIN syntax while preserving the same join order and filters."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_dim_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), store_cte AS (SELECT s_store_sk FROM store WHERE s_state = 'IA'), item_cte AS (SELECT i_item_sk FROM item WHERE i_category = 'Sports'), customer_demographics_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary'), store_sales_filtered AS (SELECT ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price, i.i_item_id, s.s_state\nFROM store_sales ss\nJOIN date_dim_cte d ON ss.ss_sold_date_sk = d.d_date_sk\nJOIN store_cte s ON ss.ss_store_sk = s.s_store_sk\nJOIN item_cte i ON ss.ss_item_sk = i.i_item_sk\nJOIN customer_demographics_cte cd ON ss.ss_cdemo_sk = cd.cd_demo_sk) select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales_filtered\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011filter each dimension table into a CTE returning only its surrogate key, then join those CTEs with store_sales."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.88,
      "status": "NEUTRAL",
      "speedup": 1.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 174.7,
      "output_sql": "WITH store_sales_scan AS (SELECT ss_sold_date_sk, ss_item_sk, ss_cdemo_sk, ss_store_sk, ss_quantity, ss_list_price, ss_sales_price, ss_coupon_amt FROM store_sales WHERE ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 2002) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2002)) select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales, customer_demographics, date_dim, store, item\nwhere ss_sold_date_sk = d_date_sk and\n      ss_item_sk = i_item_sk and\n      ss_store_sk = s_store_sk and\n      ss_cdemo_sk = cd_demo_sk and\n      cd_gender = 'F' and\n      cd_marital_status = 'M' and\n      cd_education_status = 'Primary' and\n      d_year = 2002 and\n      s_state = 'IA' and\n     i_category  = 'Sports'\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN range derived from d_year=2002 to the STORE_SALES scan predicate, preserving all existing joins and filters."
    },
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "multi_date_range_cte",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create a CTE with the exact date_sk range for d_year=2002 and join it directly with store_sales, then join other dimensions."
    },
    {
      "patch_id": "p11",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.35,
      "status": "NEUTRAL",
      "speedup": 0.98,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 181.3,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), joined_data AS (SELECT ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price, i.i_item_id, s.s_state FROM store_sales ss JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE cd.cd_gender = 'F' AND cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Primary' AND s.s_state = 'IA' AND i.i_category = 'Sports'), agg_result AS (SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM joined_data GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100) select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales, customer_demographics, date_dim, store, item\nwhere ss_sold_date_sk = d_date_sk and\n      ss_item_sk = i_item_sk and\n      ss_store_sk = s_store_sk and\n      ss_cdemo_sk = cd_demo_sk and\n      cd_gender = 'F' and\n      cd_marital_status = 'M' and\n      cd_education_status = 'Primary' and\n      d_year = 2002 and\n      s_state = 'IA' and\n     i_category  = 'Sports'\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Combine date\u2011filter CTE isolation with explicit JOIN syntax, creating a tiny date\u2011key CTE and joining it early with store_sales."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.52,
      "status": "IMPROVED",
      "speedup": 1.07,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 165.9,
      "output_sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), fact_prefetch AS (SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_cdemo_sk, ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price FROM store_sales ss JOIN date_filtered d ON ss.ss_sold_date_sk = d.d_date_sk), joined_dims AS (SELECT i.i_item_id, s.s_state, f.ss_quantity, f.ss_list_price, f.ss_coupon_amt, f.ss_sales_price FROM fact_prefetch f JOIN item i ON f.ss_item_sk = i.i_item_sk JOIN store s ON f.ss_store_sk = s.s_store_sk JOIN customer_demographics cd ON f.ss_cdemo_sk = cd.cd_demo_sk WHERE i.i_category = 'Sports' AND s.s_state = 'IA' AND cd.cd_gender = 'F' AND cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Primary'), agg_result AS (SELECT i_item_id, s_state, ss_quantity, ss_list_price, ss_coupon_amt, ss_sales_price FROM joined_dims) SELECT i_item_id, s_state, grouping(s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM agg_result GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Build a staged CTE chain: filter date_dim, join with store_sales to reduce rows, then join remaining dimensions."
    },
    {
      "patch_id": "p09",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.4,
      "status": "NEUTRAL",
      "speedup": 0.96,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 185.1,
      "output_sql": "WITH filtered_sales AS (SELECT ss_quantity, ss_list_price, ss_coupon_amt, ss_sales_price, i_item_id, s_state FROM store_sales JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports') SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM filtered_sales GROUP BY ROLLUP (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the filtered fact\u2011dimension join result (store_sales + date_dim + store + item + customer_demographics) in a CTE, then perform rollup aggregation on that CTE."
    },
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "NEUTRAL",
      "speedup": 0.99,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 178.5,
      "output_sql": "WITH preagg_store_sales AS (SELECT ss_item_sk, ss_sold_date_sk, ss_cdemo_sk, ss_store_sk, SUM(ss_quantity) AS sum_ss_quantity, COUNT(ss_quantity) AS count_ss_quantity, SUM(ss_list_price) AS sum_ss_list_price, COUNT(ss_list_price) AS count_ss_list_price, SUM(ss_coupon_amt) AS sum_ss_coupon_amt, COUNT(ss_coupon_amt) AS count_ss_coupon_amt, SUM(ss_sales_price) AS sum_ss_sales_price, COUNT(ss_sales_price) AS count_ss_sales_price FROM store_sales GROUP BY ss_item_sk, ss_sold_date_sk, ss_cdemo_sk, ss_store_sk) select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales, customer_demographics, date_dim, store, item\nwhere ss_sold_date_sk = d_date_sk and\n      ss_item_sk = i_item_sk and\n      ss_store_sk = s_store_sk and\n      ss_cdemo_sk = cd_demo_sk and\n      cd_gender = 'F' and\n      cd_marital_status = 'M' and\n      cd_education_status = 'Primary' and\n      d_year = 2002 and\n      s_state = 'IA' and\n     i_category  = 'Sports'\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011aggregate STORE_SALES by ss_item_sk, ss_sold_date_sk, ss_cdemo_sk, ss_store_sk before joining with dimensions, preserving all aggregates needed for final rollup."
    },
    {
      "patch_id": "p08",
      "family": "D",
      "transform": "rollup_to_union_windowing",
      "relevance_score": 0.42,
      "status": "REGRESSION",
      "speedup": 0.76,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 233.1,
      "output_sql": "WITH filtered_joined_data AS (SELECT i.i_item_id, s.s_state, ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price FROM store_sales ss JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE cd.cd_gender = 'F' AND cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Primary' AND d.d_year = 2002 AND s.s_state = 'IA' AND i.i_category = 'Sports'), agg_item_state AS (SELECT i_item_id, s_state, 0 as g_state, AVG(ss_quantity) as agg1, AVG(ss_list_price) as agg2, AVG(ss_coupon_amt) as agg3, AVG(ss_sales_price) as agg4 FROM filtered_joined_data GROUP BY i_item_id, s_state), agg_item AS (SELECT i_item_id, AVG(ss_quantity) as agg1, AVG(ss_list_price) as agg2, AVG(ss_coupon_amt) as agg3, AVG(ss_sales_price) as agg4 FROM filtered_joined_data GROUP BY i_item_id), agg_total AS (SELECT AVG(ss_quantity) as agg1, AVG(ss_list_price) as agg2, AVG(ss_coupon_amt) as agg3, AVG(ss_sales_price) as agg4 FROM filtered_joined_data), rollup_union AS (SELECT i_item_id, s_state, g_state, agg1, agg2, agg3, agg4 FROM agg_item_state UNION ALL SELECT i_item_id, NULL as s_state, 1 as g_state, agg1, agg2, agg3, agg4 FROM agg_item UNION ALL SELECT NULL as i_item_id, NULL as s_state, 1 as g_state, agg1, agg2, agg3, agg4 FROM agg_total ORDER BY i_item_id, s_state LIMIT 100) select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales, customer_demographics, date_dim, store, item\nwhere ss_sold_date_sk = d_date_sk and\n      ss_item_sk = i_item_sk and\n      ss_store_sk = s_store_sk and\n      ss_cdemo_sk = cd_demo_sk and\n      cd_gender = 'F' and\n      cd_marital_status = 'M' and\n      cd_education_status = 'Primary' and\n      d_year = 2002 and\n      s_state = 'IA' and\n     i_category  = 'Sports'\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Replace GROUP BY ROLLUP with explicit UNION ALL of three aggregation levels (item+state, item only, total) using window functions to compute aggregates."
    },
    {
      "patch_id": "p07",
      "family": "D",
      "transform": "rollup_to_union_windowing",
      "relevance_score": 0.45,
      "status": "NEUTRAL",
      "speedup": 0.96,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 185.9,
      "output_sql": "WITH unioned_rollup AS (SELECT i_item_id, s_state, 0 AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM store_sales JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports' GROUP BY i_item_id, s_state UNION ALL SELECT i_item_id, NULL AS s_state, 1 AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM store_sales JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports' GROUP BY i_item_id UNION ALL SELECT NULL AS i_item_id, NULL AS s_state, 1 AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM store_sales JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports') select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales, customer_demographics, date_dim, store, item\nwhere ss_sold_date_sk = d_date_sk and\n      ss_item_sk = i_item_sk and\n      ss_store_sk = s_store_sk and\n      ss_cdemo_sk = cd_demo_sk and\n      cd_gender = 'F' and\n      cd_marital_status = 'M' and\n      cd_education_status = 'Primary' and\n      d_year = 2002 and\n      s_state = 'IA' and\n     i_category  = 'Sports'\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Replace GROUP BY ROLLUP with explicit UNION ALL of three levels (item+state, item only, total) using window functions to compute aggregates."
    },
    {
      "patch_id": "p06",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.48,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing `tree` object",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH store_sales_agg AS (SELECT ss_item_sk, ss_store_sk, AVG(ss_quantity) agg1, AVG(ss_list_price) agg2, AVG(ss_coupon_amt) agg3, AVG(ss_sales_price) agg4 FROM store_sales JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 GROUP BY ss_item_sk, ss_store_sk) SELECT i_item_id, s_state, grouping(s_state) g_state, agg1, agg2, agg3, agg4 FROM store_sales_agg JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE s_state = 'IA' AND i_category = 'Sports' GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate the nested aggregate stages into a single CTE that computes all required sums and counts in one pass over store_sales."
    },
    {
      "patch_id": "p12",
      "family": "F",
      "transform": "self_join_decomposition",
      "relevance_score": 0.32,
      "status": "IMPROVED",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 177.6,
      "patch_ms": 168.8,
      "output_sql": "WITH filtered_joined_data AS (SELECT ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price, i.i_item_id, s.s_state FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk WHERE cd.cd_gender = 'F' AND cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Primary' AND d.d_year = 2002 AND s.s_state = 'IA' AND i.i_category = 'Sports'), group_item_state AS (SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM filtered_joined_data GROUP BY i_item_id, s_state), group_item_only AS (SELECT i_item_id, NULL AS s_state, 1 AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM filtered_joined_data GROUP BY i_item_id), group_total AS (SELECT NULL AS i_item_id, NULL AS s_state, 1 AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM filtered_joined_data), unioned_results AS (SELECT * FROM group_item_state UNION ALL SELECT * FROM group_item_only UNION ALL SELECT * FROM group_total) SELECT i_item_id, s_state, g_state, agg1, agg2, agg3, agg4 FROM unioned_results ORDER BY i_item_id, s_state LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Split the query into separate CTEs for each rollup level (item+state, item only, total) to avoid rollup complexity, then UNION ALL."
    }
  ],
  "explains": {
    "p10": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p01": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p11": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p04": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | I.I_ITEM_ID, S.S_STATE, GROUPING_ID(S.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(SS.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(SS.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(SS.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(SS.SS_LIST_PRICE, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(SS.SS_COUP",
    "p09": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p02": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p08": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p07": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | ITEM.I_ITEM_ID, STORE.S_STATE, GROUPING_ID(STORE.S_STATE), SCALED_ROUND_INT_DIVIDE(SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*))), COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_QUANTITY, COUNT(*))), COUNT(*)))), (SUM(SUM_INTERNAL(SUM(SUM_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*)))) / (COUNT(COUNT_INTERNAL(COUNT(COUNT_INTERNAL(STORE_SALES.SS_LIST_PRICE, COUNT(*))), COUNT(*))))",
    "p12": "GlobalStats | 72723 | 70417 | 1212661790720\n1 | 0 | Result | UNION_ALL(FILTERED_JOINED_DATA.I_ITEM_ID, FILTERED_JOINED_DATA.I_ITEM_ID, null), UNION_ALL(FILTERED_JOINED_DATA.S_STATE, null, null), UNIONED_RESULTS.G_STATE, UNION_ALL(SCALED_ROUND_INT_DIVIDE(SUM(FILTERED_JOINED_DATA.SS_QUANTITY), COUNT(FILTERED_JOINED_DATA.SS_QUANTITY)), SCALED_ROUND_INT_DIVIDE(SUM(FILTERED_JOINED_DATA.SS_QUANTITY), COUNT(FILTERED_JOINED_DATA.SS_QUANTITY)), SCALED_ROUND_INT_DIVIDE(SUM(FILTERED_JOINED_DATA.SS_QUANTITY"
  }
}