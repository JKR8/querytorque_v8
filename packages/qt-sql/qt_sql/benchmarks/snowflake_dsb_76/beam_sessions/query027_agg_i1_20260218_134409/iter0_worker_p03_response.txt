{
  "probe_id": "scout_dimension_cte_isolate",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating dimension filters into CTEs returning only surrogate keys may improve join-filter pushdown and reduce fact-table scan size.",
  "reasoning_trace": [
    "Assigned transform targets early dimension filtering to reduce fact scan pressure.",
    "Each dimension CTE is filtered and projected to only its join key, preserving row semantics.",
    "Final join structure remains unchanged, preserving all output columns and grouping."
  ],
  "target_ir": "Five CTEs added for each dimension table, returning only surrogate keys; fact join rewritten to reference CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales_filtered"],
        "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
        "changed": true,
        "sql": "select  i_item_id,\n        s_state, grouping(s_state) g_state,\n        avg(ss_quantity) agg1,\n        avg(ss_list_price) agg2,\n        avg(ss_coupon_amt) agg3,\n        avg(ss_sales_price) agg4\nfrom store_sales_filtered\n group by rollup (i_item_id, s_state)\n order by i_item_id\n         ,s_state\n limit 100"
      },
      {
        "node_id": "store_sales_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim_cte", "store_cte", "item_cte", "customer_demographics_cte"],
        "outputs": ["ss_quantity", "ss_list_price", "ss_coupon_amt", "ss_sales_price", "i_item_id", "s_state"],
        "changed": true,
        "sql": "SELECT ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price, i.i_item_id, s.s_state\nFROM store_sales ss\nJOIN date_dim_cte d ON ss.ss_sold_date_sk = d.d_date_sk\nJOIN store_cte s ON ss.ss_store_sk = s.s_store_sk\nJOIN item_cte i ON ss.ss_item_sk = i.i_item_sk\nJOIN customer_demographics_cte cd ON ss.ss_cdemo_sk = cd.cd_demo_sk"
      },
      {
        "node_id": "date_dim_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
      },
      {
        "node_id": "store_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": true,
        "sql": "SELECT s_store_sk FROM store WHERE s_state = 'IA'"
      },
      {
        "node_id": "item_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["item"],
        "outputs": ["i_item_sk"],
        "changed": true,
        "sql": "SELECT i_item_sk FROM item WHERE i_category = 'Sports'"
      },
      {
        "node_id": "customer_demographics_cte",
        "parent_node_id": "store_sales_filtered",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary'"
      }
    ]
  }
}