[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.6,
    "based_on": "p02,p03",
    "strategy": "Pre-filter selective dimensions and date dimensions into CTEs to enable early micro‑partition pruning, then join facts with explicit predicate placement.",
    "hypothesis": "Original plan likely scans catalog_sales and inventory before applying dimension filters. This rewrite pushes item, customer_demographics, household_demographics and date‑dim filters into CTEs, allowing Snowflake to prune micro‑partitions earlier. The fix corrects p02's missing d_date column and ensures all predicates are preserved.",
    "expected_explain_delta": "Fact‑table scans should show reduced partitions/bytes; dimension tables scanned once; join order may change to reflect filtered CTEs.",
    "target_ir": "Replace base fact‑and‑dimension joins with CTE‑based pre‑filtering, preserving all original predicates and left‑join semantics.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH filtered_item AS (\n  SELECT i_item_sk, i_item_desc\n  FROM item\n  WHERE i_category IN ('Children', 'Jewelry', 'Men')\n),\nfiltered_cd AS (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status = 'U'\n    AND cd_dep_count BETWEEN 9 AND 11\n),\nfiltered_hd AS (\n  SELECT hd_demo_sk\n  FROM household_demographics\n  WHERE hd_buy_potential = '>10000'\n),\nfiltered_d1 AS (\n  SELECT d_date_sk, d_week_seq, d_date\n  FROM date_dim\n  WHERE d_year = 1998\n),\nfiltered_d2 AS (\n  SELECT d_date_sk, d_week_seq\n  FROM date_dim\n),\nfiltered_d3 AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n)\nSELECT\n  i.i_item_desc,\n  w.w_warehouse_name,\n  d1.d_week_seq,\n  SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo,\n  SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo,\n  COUNT(*) AS total_cnt\nFROM catalog_sales cs\nJOIN filtered_d1 d1 ON cs.cs_sold_date_sk = d1.d_date_sk\nJOIN filtered_d3 d3 ON cs.cs_ship_date_sk = d3.d_date_sk\nJOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk\nJOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk\nJOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk\nJOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk\nJOIN filtered_d2 d2 ON inv.inv_date_sk = d2.d_date_sk\nJOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\nLEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk\nLEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number\nWHERE cs.cs_wholesale_cost BETWEEN 35 AND 55\n  AND inv.inv_quantity_on_hand < cs.cs_quantity\n  AND d1.d_week_seq = d2.d_week_seq\n  AND d3.d_date > d1.d_date + INTERVAL '3 day'\nGROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nLIMIT 100"
        }
      ]
    }
  }
]