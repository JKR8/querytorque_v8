{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.02872999,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 89639,
    "completion_tokens": 27121,
    "total_tokens": 116760,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 37632,
    "reasoning_tokens": 14434
  },
  "best_speedup": 1.02,
  "best_patch_id": "p04",
  "best_sql": "WITH preagg_catalog_sales AS (SELECT cs_item_sk, cs_sold_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk, SUM(cs_quantity) AS sum_cs_quantity, COUNT(*) AS count_rows FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY cs_item_sk, cs_sold_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk) select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk)\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk)\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '>10000'\n  and d1.d_year = 1998\n  and cd_marital_status = 'U'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Children', 'Jewelry', 'Men')\n  and cs_wholesale_cost BETWEEN 35 AND 55\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
  "patches": [
    {
      "patch_id": "p04",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "NEUTRAL",
      "speedup": 1.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 139.0,
      "patch_ms": 136.2,
      "output_sql": "WITH preagg_catalog_sales AS (SELECT cs_item_sk, cs_sold_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk, SUM(cs_quantity) AS sum_cs_quantity, COUNT(*) AS count_rows FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY cs_item_sk, cs_sold_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk) select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk)\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk)\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '>10000'\n  and d1.d_year = 1998\n  and cd_marital_status = 'U'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Children', 'Jewelry', 'Men')\n  and cs_wholesale_cost BETWEEN 35 AND 55\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011aggregate catalog_sales by (cs_item_sk, cs_sold_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk) before joining to dimensions, then final aggregate by dimension columns."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 139.0,
      "patch_ms": 150.8,
      "output_sql": "select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom catalog_sales\njoin inventory on (cs_item_sk = inv_item_sk)\njoin warehouse on (w_warehouse_sk=inv_warehouse_sk)\njoin item on (i_item_sk = cs_item_sk)\njoin customer_demographics on (cs_bill_cdemo_sk = cd_demo_sk)\njoin household_demographics on (cs_bill_hdemo_sk = hd_demo_sk)\njoin date_dim d1 on (cs_sold_date_sk = d1.d_date_sk)\njoin date_dim d2 on (inv_date_sk = d2.d_date_sk)\njoin date_dim d3 on (cs_ship_date_sk = d3.d_date_sk)\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nwhere d1.d_week_seq = d2.d_week_seq\n  and inv_quantity_on_hand < cs_quantity\n  and d3.d_date > d1.d_date + interval '3 day'\n  and hd_buy_potential = '>10000'\n  and d1.d_year = 1998\n  and cd_marital_status = 'U'\n  and cd_dep_count between 9 and 11\n  and i_category IN ('Children', 'Jewelry', 'Men')\n  and cs_wholesale_cost BETWEEN 35 AND 55\n  and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_year = 1998) and (select max(d_date_sk) from date_dim where d_year = 1998)\n  and inv_date_sk between (select min(d_date_sk) from date_dim where d_year = 1998) and (select max(d_date_sk) from date_dim where d_year = 1998)\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN range to catalog_sales and inventory using d1.d_year=1998, d2.d_week_seq = d1.d_week_seq, and d3.d_date > d1.d_date + interval '3 days' to prune micro\u2011partitions."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.55,
      "status": "NEUTRAL",
      "speedup": 0.97,
      "semantic_passed": true,
      "error": null,
      "original_ms": 139.0,
      "patch_ms": 143.0,
      "output_sql": "WITH filtered_catalog_sales AS (\n  SELECT *\n  FROM catalog_sales\n  JOIN date_dim d1 ON cs_sold_date_sk = d1.d_date_sk\n  JOIN item ON i_item_sk = cs_item_sk\n  JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk\n  JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk\n  WHERE d1.d_year = 1998\n    AND cd_marital_status = 'U'\n    AND cd_dep_count BETWEEN 9 AND 11\n    AND i_category IN ('Children', 'Jewelry', 'Men')\n    AND cs_wholesale_cost BETWEEN 35 AND 55\n),\nfiltered_inventory AS (\n  SELECT *\n  FROM inventory\n  JOIN date_dim d2 ON inv_date_sk = d2.d_date_sk\n  WHERE d2.d_year = 1998\n)\nSELECT  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nFROM filtered_catalog_sales\nJOIN filtered_inventory ON (cs_item_sk = inv_item_sk AND inv_quantity_on_hand < cs_quantity)\nJOIN warehouse ON (w_warehouse_sk=inv_warehouse_sk)\nJOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk)\nJOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk)\nJOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk)\nLEFT OUTER JOIN promotion ON (cs_promo_sk=p_promo_sk)\nLEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\nWHERE d1.d_week_seq = d2.d_week_seq\n  AND d3.d_date > d1.d_date + interval '3 day'\n  AND hd_buy_potential = '>10000'\nGROUP BY i_item_desc,w_warehouse_name,d1.d_week_seq\nORDER BY total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Stage\u2011reduce both sides of the non\u2011equi join: create CTEs for filtered catalog_sales and filtered inventory, then join them on inv_quantity_on_hand < cs_quantity."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: 000904 (42000): 01c27c6c-3205-67d8-0002-fcfe0002133a: SQL compilation error: error line 50 at position 73\ninvalid identifier 'D1.D_DATE'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH joined_facts_and_dims AS (WITH prefetch_item AS (\n  SELECT i_item_sk, i_item_desc\n  FROM item\n  WHERE i_category IN ('Children', 'Jewelry', 'Men')\n),\n\nprefetch_cd AS (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status = 'U'\n    AND cd_dep_count BETWEEN 9 AND 11\n),\n\nprefetch_hd AS (\n  SELECT hd_demo_sk\n  FROM household_demographics\n  WHERE hd_buy_potential = '>10000'\n),\n\nprefetch_d1 AS (\n  SELECT d_date_sk, d_week_seq\n  FROM date_dim\n  WHERE d_year = 1998\n),\n\nprefetch_d2 AS (\n  SELECT d_date_sk, d_week_seq\n  FROM date_dim\n),\n\nprefetch_d3 AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n)\n\nSELECT\n  i.i_item_desc,\n  w.w_warehouse_name,\n  d1.d_week_seq,\n  cs.cs_promo_sk,\n  cs.cs_wholesale_cost\nFROM catalog_sales cs\nJOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk\nJOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk\nJOIN prefetch_item i ON i.i_item_sk = cs.cs_item_sk\nJOIN prefetch_cd cd ON cd.cd_demo_sk = cs.cs_bill_cdemo_sk\nJOIN prefetch_hd hd ON hd.hd_demo_sk = cs.cs_bill_hdemo_sk\nJOIN prefetch_d1 d1 ON d1.d_date_sk = cs.cs_sold_date_sk\nJOIN prefetch_d2 d2 ON d2.d_date_sk = inv.inv_date_sk AND d1.d_week_seq = d2.d_week_seq\nJOIN prefetch_d3 d3 ON d3.d_date_sk = cs.cs_ship_date_sk AND d3.d_date > d1.d_date + interval '3 day'\nWHERE inv.inv_quantity_on_hand < cs.cs_quantity\n  AND cs.cs_wholesale_cost BETWEEN 35 AND 55) select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom joined_facts_and_dims\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011filter selective dimensions (item, customer_demographics, household_demographics, date_dim d1, d2, d3) into separate CTEs before joining to catalog_sales and inventory, compounding selectivity."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.81,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 221.2,
      "output_sql": "WITH filtered_item AS (\n  SELECT i_item_sk, i_item_desc\n  FROM item\n  WHERE i_category IN ('Children', 'Jewelry', 'Men')\n),\nfiltered_cd AS (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status = 'U'\n    AND cd_dep_count BETWEEN 9 AND 11\n),\nfiltered_hd AS (\n  SELECT hd_demo_sk\n  FROM household_demographics\n  WHERE hd_buy_potential = '>10000'\n),\nfiltered_d1 AS (\n  SELECT d_date_sk, d_week_seq, d_date\n  FROM date_dim\n  WHERE d_year = 1998\n),\nfiltered_d2 AS (\n  SELECT d_date_sk, d_week_seq\n  FROM date_dim\n),\nfiltered_d3 AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n)\nSELECT\n  i.i_item_desc,\n  w.w_warehouse_name,\n  d1.d_week_seq,\n  SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo,\n  SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo,\n  COUNT(*) AS total_cnt\nFROM catalog_sales cs\nJOIN filtered_d1 d1 ON cs.cs_sold_date_sk = d1.d_date_sk\nJOIN filtered_d3 d3 ON cs.cs_ship_date_sk = d3.d_date_sk\nJOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk\nJOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk\nJOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk\nJOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk\nJOIN filtered_d2 d2 ON inv.inv_date_sk = d2.d_date_sk\nJOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\nLEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk\nLEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number\nWHERE cs.cs_wholesale_cost BETWEEN 35 AND 55\n  AND inv.inv_quantity_on_hand < cs.cs_quantity\n  AND d1.d_week_seq = d2.d_week_seq\n  AND d3.d_date > d1.d_date + INTERVAL '3 day'\nGROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 179.5,
      "patch_ms": 204.9,
      "output_sql": "WITH filtered_cs AS (SELECT cs.cs_item_sk, cs.cs_quantity, cs.cs_sold_date_sk, cs.cs_promo_sk, cs.cs_bill_cdemo_sk, cs.cs_bill_hdemo_sk, cs.cs_ship_date_sk, cs.cs_order_number, i.i_item_desc, d1.d_week_seq, d1.d_date FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN customer_demographics cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN date_dim d1 ON cs.cs_sold_date_sk = d1.d_date_sk WHERE d1.d_year = 1998 AND cd.cd_marital_status = 'U' AND cd.cd_dep_count BETWEEN 9 AND 11 AND i.i_category IN ('Children', 'Jewelry', 'Men') AND cs.cs_wholesale_cost BETWEEN 35 AND 55 AND hd.hd_buy_potential = '>10000'), filtered_inv AS (SELECT inv.inv_item_sk, inv.inv_warehouse_sk, inv.inv_quantity_on_hand, inv.inv_date_sk, d2.d_week_seq AS inv_week_seq FROM inventory inv JOIN date_dim d2 ON inv.inv_date_sk = d2.d_date_sk) SELECT filtered_cs.i_item_desc, w.w_warehouse_name, filtered_cs.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_cs JOIN filtered_inv ON filtered_cs.cs_item_sk = filtered_inv.inv_item_sk AND filtered_inv.inv_quantity_on_hand < filtered_cs.cs_quantity AND filtered_cs.d_week_seq = filtered_inv.inv_week_seq JOIN warehouse w ON filtered_inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim d3 ON filtered_cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion p ON filtered_cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns cr ON filtered_cs.cs_item_sk = cr.cr_item_sk AND cr.cr_order_number = filtered_cs.cs_order_number WHERE d3.d_date > filtered_cs.d_date + INTERVAL '3 day' GROUP BY filtered_cs.i_item_desc, w.w_warehouse_name, filtered_cs.d_week_seq ORDER BY total_cnt DESC, filtered_cs.i_item_desc, w.w_warehouse_name, filtered_cs.d_week_seq LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p04": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | ITEM.I_ITEM_DESC, WAREHOUSE.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, ITEM.I_ITEM_DESC ASC NULLS LAST, WAREHOUSE.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0",
    "p01": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | ITEM.I_ITEM_DESC, WAREHOUSE.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, ITEM.I_ITEM_DESC ASC NULLS LAST, WAREHOUSE.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0",
    "p03": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | ITEM.I_ITEM_DESC, WAREHOUSE.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(PROMOTION.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, ITEM.I_ITEM_DESC ASC NULLS LAST, WAREHOUSE.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0",
    "compile_p1": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | I.I_ITEM_DESC, W.W_WAREHOUSE_NAME, D1.D_WEEK_SEQ, SUM(CASE_FLATTENED(P.P_PROMO_SK IS NULL, 1, 0)), SUM(CASE_FLATTENED(P.P_PROMO_SK IS NOT NULL, 1, 0)), COUNT(*)\n1 | 1 | [0] | SortWithLimit | sortKey: [COUNT(*) DESC NULLS FIRST, I.I_ITEM_DESC ASC NULLS LAST, W.W_WAREHOUSE_NAME ASC NULLS LAST, D1.D_WEEK_SEQ ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Generator | 0"
  }
}