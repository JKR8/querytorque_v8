{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.01875778,
  "beam_cost_priced_calls": 7,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 58497,
    "completion_tokens": 16303,
    "total_tokens": 74800,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 19520,
    "reasoning_tokens": 7867
  },
  "best_speedup": 1.09,
  "best_patch_id": "p01",
  "best_sql": "SELECT COUNT(*) FROM (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales, date_dim, customer\n  WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    AND store_sales.ss_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND ss_list_price BETWEEN 241 AND 300\n    AND ss_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales, date_dim, customer\n  WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n    AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND cs_list_price BETWEEN 241 AND 300\n    AND cs_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales, date_dim, customer\n  WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk\n    AND web_sales.ws_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND ws_list_price BETWEEN 241 AND 300\n    AND ws_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n) hot_cust\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "IMPROVED",
      "speedup": 1.09,
      "semantic_passed": true,
      "error": null,
      "original_ms": 140.6,
      "patch_ms": 128.8,
      "output_sql": "SELECT COUNT(*) FROM (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales, date_dim, customer\n  WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    AND store_sales.ss_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND ss_list_price BETWEEN 241 AND 300\n    AND ss_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales, date_dim, customer\n  WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n    AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND cs_list_price BETWEEN 241 AND 300\n    AND cs_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales, date_dim, customer\n  WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk\n    AND web_sales.ws_bill_customer_sk = customer.c_customer_sk\n    AND d_month_seq BETWEEN 1207 AND 1218\n    AND c_birth_month IN (2, 3, 4, 10)\n    AND ws_list_price BETWEEN 241 AND 300\n    AND ws_wholesale_cost BETWEEN 76 AND 96\n    AND date_dim.d_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218)\n) hot_cust\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Add explicit date_sk BETWEEN predicate to each fact-table join condition by precomputing date_sk range from date_dim filter (d_month_seq BETWEEN 1207 AND 1218)."
    },
    {
      "patch_id": "p03",
      "family": "D",
      "transform": "intersect_to_exists",
      "relevance_score": 0.75,
      "status": "NEUTRAL",
      "speedup": 0.99,
      "semantic_passed": true,
      "error": null,
      "original_ms": 140.6,
      "patch_ms": 141.4,
      "output_sql": "WITH hot_cust AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\nFROM store_sales ss\nJOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\nJOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\nWHERE d.d_month_seq BETWEEN 1207 AND 1207 + 11\n  AND c.c_birth_month IN (2, 3, 4, 10)\n  AND ss.ss_list_price BETWEEN 241 AND 300\n  AND ss.ss_wholesale_cost BETWEEN 76 AND 96\n  AND EXISTS (\n    SELECT 1\n    FROM catalog_sales cs\n    JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk\n    JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk\n    WHERE d2.d_month_seq BETWEEN 1207 AND 1207 + 11\n      AND c2.c_birth_month IN (2, 3, 4, 10)\n      AND cs.cs_list_price BETWEEN 241 AND 300\n      AND cs.cs_wholesale_cost BETWEEN 76 AND 96\n      AND c2.c_customer_sk = c.c_customer_sk\n      AND d2.d_date = d.d_date\n  )\n  AND EXISTS (\n    SELECT 1\n    FROM web_sales ws\n    JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk\n    JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk\n    WHERE d3.d_month_seq BETWEEN 1207 AND 1207 + 11\n      AND c3.c_birth_month IN (2, 3, 4, 10)\n      AND ws.ws_list_price BETWEEN 241 AND 300\n      AND ws.ws_wholesale_cost BETWEEN 76 AND 96\n      AND c3.c_customer_sk = c.c_customer_sk\n      AND d3.d_date = d.d_date\n  )\nLIMIT 100) select count(*) from hot_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Replace INTERSECT with EXISTS subqueries to avoid materializing full distinct sets; use first branch as base and add EXISTS clauses for other channels."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM (SELECT c_last_name, c_first_name, d_date FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2, 3, 4, 10) AND ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96 AND d_date_sk BETWEEN 2451545 AND 2451910 UNION ALL SELECT c_last_name, c_first_name, d_date FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2, 3, 4, 10) AND cs_list_price BETWEEN 241 AND 300 AND cs_wholesale_cost BETWEEN 76 AND 96 AND d_date_sk BETWEEN 2451545 AND 2451910 UNION ALL SELECT c_last_name, c_first_name, d_date FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2, 3, 4, 10) AND ws_list_price BETWEEN 241 AND 300 AND ws_wholesale_cost BETWEEN 76 AND 96 AND d_date_sk BETWEEN 2451545 AND 2451910) hot_cust) LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Push date_sk range into each branch by converting INTERSECT branches to UNION ALL with precomputed date_sk range, then deduplicate after union."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.6,
      "status": "NEUTRAL",
      "speedup": 0.99,
      "semantic_passed": true,
      "error": null,
      "original_ms": 140.6,
      "patch_ms": 142.3,
      "output_sql": "WITH shared_dimensions AS (SELECT d.d_date_sk, c.c_customer_sk FROM date_dim d, customer c WHERE d.d_month_seq BETWEEN 1207 AND 1218 AND c.c_birth_month IN (2,3,4,10)), channel_1 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN shared_dimensions sd ON ss.ss_sold_date_sk = sd.d_date_sk AND ss.ss_customer_sk = sd.c_customer_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 241 AND 300 AND ss.ss_wholesale_cost BETWEEN 76 AND 96), channel_2 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales cs JOIN shared_dimensions sd ON cs.cs_sold_date_sk = sd.d_date_sk AND cs.cs_bill_customer_sk = sd.c_customer_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 241 AND 300 AND cs.cs_wholesale_cost BETWEEN 76 AND 96), channel_3 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales ws JOIN shared_dimensions sd ON ws.ws_sold_date_sk = sd.d_date_sk AND ws.ws_bill_customer_sk = sd.c_customer_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 241 AND 300 AND ws.ws_wholesale_cost BETWEEN 76 AND 96), intersect_result AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_1 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_2 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_3) SELECT COUNT(*) FROM intersect_result;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim and customer into a single CTE and reuse it across all three channel subqueries to avoid repeated dimension scans."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.82,
      "semantic_passed": true,
      "error": null,
      "original_ms": 151.6,
      "patch_ms": 185.6,
      "output_sql": "WITH date_sk_range AS (\n  SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1207 AND 1218\n)\nSELECT COUNT(*)\nFROM (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM store_sales, date_dim, customer\n    WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk\n      AND store_sales.ss_customer_sk = customer.c_customer_sk\n      AND d_month_seq BETWEEN 1207 AND 1218\n      AND c_birth_month IN (2, 3, 4, 10)\n      AND ss_list_price BETWEEN 241 AND 300\n      AND ss_wholesale_cost BETWEEN 76 AND 96\n      AND date_dim.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n  INTERSECT\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM catalog_sales, date_dim, customer\n    WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n      AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n      AND d_month_seq BETWEEN 1207 AND 1218\n      AND c_birth_month IN (2, 3, 4, 10)\n      AND cs_list_price BETWEEN 241 AND 300\n      AND cs_wholesale_cost BETWEEN 76 AND 96\n      AND date_dim.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n  INTERSECT\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM web_sales, date_dim, customer\n    WHERE web_sales.ws_sold_date_sk = date_dim.d_date_sk\n      AND web_sales.ws_bill_customer_sk = customer.c_customer_sk\n      AND d_month_seq BETWEEN 1207 AND 1218\n      AND c_birth_month IN (2, 3, 4, 10)\n      AND ws_list_price BETWEEN 241 AND 300\n      AND ws_wholesale_cost BETWEEN 76 AND 96\n      AND date_dim.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n) hot_cust\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "NEUTRAL",
      "speedup": 1.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 151.6,
      "patch_ms": 149.3,
      "output_sql": "WITH date_sk_range AS (\n  SELECT MIN(d_date_sk) AS min_sk, MAX(d_date_sk) AS max_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1207 AND 1218\n)\nSELECT COUNT(*)\nFROM (\n  SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\n  JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\n  WHERE d.d_month_seq BETWEEN 1207 AND 1218\n    AND c.c_birth_month IN (2, 3, 4, 10)\n    AND ss.ss_list_price BETWEEN 241 AND 300\n    AND ss.ss_wholesale_cost BETWEEN 76 AND 96\n    AND d.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n    AND EXISTS (\n      SELECT 1\n      FROM catalog_sales cs\n      JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk\n      JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk\n      WHERE d2.d_month_seq BETWEEN 1207 AND 1218\n        AND c2.c_birth_month IN (2, 3, 4, 10)\n        AND cs.cs_list_price BETWEEN 241 AND 300\n        AND cs.cs_wholesale_cost BETWEEN 76 AND 96\n        AND d2.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n        AND c2.c_customer_sk = c.c_customer_sk\n        AND d2.d_date = d.d_date\n    )\n    AND EXISTS (\n      SELECT 1\n      FROM web_sales ws\n      JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk\n      JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk\n      WHERE d3.d_month_seq BETWEEN 1207 AND 1218\n        AND c3.c_birth_month IN (2, 3, 4, 10)\n        AND ws.ws_list_price BETWEEN 241 AND 300\n        AND ws.ws_wholesale_cost BETWEEN 76 AND 96\n        AND d3.d_date_sk BETWEEN (SELECT min_sk FROM date_sk_range) AND (SELECT max_sk FROM date_sk_range)\n        AND c3.c_customer_sk = c.c_customer_sk\n        AND d3.d_date = d.d_date\n    )\n) hot_cust\nLIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 2 | 2 | 4277248\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_MONTH_SEQ >= 1207) AND (DATE_DIM.D_MONTH_SEQ <= 1218)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_MONTH_SEQ | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_MONTH_SEQ >= 1207) AND (DA",
    "p03": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Limit | rowCount: 100\n1 | 3 | [2] | Generator | 0",
    "p02": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Aggregate | aggExprs: [COUNT(*)]\n1 | 2 | [1] | Generator | 0",
    "compile_p1": "GlobalStats | 2 | 2 | 4277248\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK), MAX(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_MONTH_SEQ >= 1207) AND (DATE_DIM.D_MONTH_SEQ <= 1218)\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_MONTH_SEQ | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK), MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1]",
    "compile_p2": "GlobalStats | 0 | 0 | 0\n1 | 0 | Result | COUNT(*)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [COUNT(*)]\n1 | 3 | [2] | Generator | 0"
  }
}