{
  "probe_id": "scout_001",
  "transform_id": "channel_bitmap_aggregation",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Consolidating three separate fact table scans into a single UNION ALL with channel flags reduces I/O and enables efficient conditional aggregation while preserving all output semantics.",
  "reasoning_trace": [
    "Assigned transform targets repeated fact scans with identical filters â€” ideal candidate for channel bitmap consolidation.",
    "UNION ALL with CASE-based channel flags avoids EXISTS materialization and aligns with Snowflake's efficient semi-join handling.",
    "Grouping by customer_sk with channel flags preserves original EXISTS/NOT EXISTS multiplicity and join semantics."
  ],
  "target_ir": "Three separate fact scans replaced by one UNION ALL scan with channel flags; downstream joins simplified to filter on aggregated flags.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_flags", "customer", "customer_address", "customer_demographics"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
        "changed": false
      },
      {
        "node_id": "customer_flags",
        "parent_node_id": "final_select",
        "sources": ["channel_scan_union"],
        "outputs": ["c_customer_sk", "has_store", "has_web", "has_catalog"],
        "changed": true,
        "sql": "SELECT c_customer_sk, MAX(has_store) AS has_store, MAX(has_web) AS has_web, MAX(has_catalog) AS has_catalog FROM channel_scan_union GROUP BY c_customer_sk"
      },
      {
        "node_id": "channel_scan_union",
        "parent_node_id": "customer_flags",
        "sources": ["store_sales", "catalog_sales", "web_sales", "date_dim"],
        "outputs": ["c_customer_sk", "has_store", "has_web", "has_catalog"],
        "changed": true,
        "sql": "SELECT ss_customer_sk AS c_customer_sk, TRUE AS has_store, FALSE AS has_web, FALSE AS has_catalog FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5 AND ss_list_price BETWEEN 52 AND 141 UNION ALL SELECT cs_ship_customer_sk AS c_customer_sk, FALSE AS has_store, FALSE AS has_web, TRUE AS has_catalog FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5 AND cs_list_price BETWEEN 52 AND 141 UNION ALL SELECT ws_bill_customer_sk AS c_customer_sk, FALSE AS has_store, TRUE AS has_web, FALSE AS has_catalog FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5 AND ws_list_price BETWEEN 52 AND 141"
      },
      {
        "node_id": "customer",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["c_customer_sk", "c_current_addr_sk", "c_current_cdemo_sk"],
        "changed": false
      },
      {
        "node_id": "customer_address",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ca_address_sk", "ca_state"],
        "changed": false
      },
      {
        "node_id": "customer_demographics",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["cd_demo_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"],
        "changed": false
      }
    ]
  }
}