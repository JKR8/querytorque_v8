{
  "probe_id": "p03",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Isolating dimension filters into CTEs reduces build-side size for hash joins and may improve optimizer cardinality estimates.",
  "reasoning_trace": [
    "Assigned transform targets early filtering of dimension tables to reduce join build side sizes.",
    "Each dimension table is filtered by selective predicates and contributes only surrogate keys and grouping columns.",
    "CTEs are named to avoid conflicts and include only required columns per node_contract.",
    "No unfiltered CTEs created; all filters preserved from original query."
  ],
  "target_ir": "Five CTEs added for date_dim, item, customer_demographics, customer, and customer_address with selective filters and key-only projections.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["catalog_sales", "customer_demographics_filtered", "customer_filtered", "customer_address_filtered", "date_dim_filtered", "item_filtered"],
        "outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"],
        "changed": true,
        "sql": "WITH date_dim_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999),\n     item_filtered AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Music'),\n     customer_demographics_filtered AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = '4 yr Degree'),\n     customer_filtered AS (SELECT c_customer_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_month = 12),\n     customer_address_filtered AS (SELECT ca_address_sk, ca_country, ca_state, ca_county FROM customer_address WHERE ca_state IN ('AR','IN','VA'))\nselect  i_item_id,\n        ca_country,\n        ca_state,\n        ca_county,\n        avg( cast(cs_quantity as decimal(12,2))) agg1,\n        avg( cast(cs_list_price as decimal(12,2))) agg2,\n        avg( cast(cs_coupon_amt as decimal(12,2))) agg3,\n        avg( cast(cs_sales_price as decimal(12,2))) agg4,\n        avg( cast(cs_net_profit as decimal(12,2))) agg5,\n        avg( cast(c_birth_year as decimal(12,2))) agg6\nfrom catalog_sales, customer_demographics_filtered, customer_filtered, customer_address_filtered, date_dim_filtered, item_filtered\nwhere cs_sold_date_sk = date_dim_filtered.d_date_sk and\n      cs_item_sk = item_filtered.i_item_sk and\n      cs_bill_cdemo_sk = customer_demographics_filtered.cd_demo_sk and\n      cs_bill_customer_sk = customer_filtered.c_customer_sk and\n      customer_filtered.c_current_addr_sk = customer_address_filtered.ca_address_sk and\n      cs_wholesale_cost BETWEEN 5 AND 10\ngroup by rollup (item_filtered.i_item_id, customer_address_filtered.ca_country, customer_address_filtered.ca_state, customer_address_filtered.ca_county)\norder by customer_address_filtered.ca_country,\n        customer_address_filtered.ca_state,\n        customer_address_filtered.ca_county,\n\titem_filtered.i_item_id\nlimit 100;"
      },
      {
        "node_id": "date_dim_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": false
      },
      {
        "node_id": "item_filtered",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_item_id"],
        "changed": false
      },
      {
        "node_id": "customer_demographics_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": false
      },
      {
        "node_id": "customer_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_current_addr_sk", "c_birth_year"],
        "changed": false
      },
      {
        "node_id": "customer_address_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state", "ca_county"],
        "changed": false
      }
    ]
  }
}