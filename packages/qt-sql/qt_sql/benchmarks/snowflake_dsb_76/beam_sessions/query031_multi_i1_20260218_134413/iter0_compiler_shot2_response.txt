[
  {
    "plan_id": "compile_pivot",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "",
    "strategy": "Pivot CTEs to eliminate self-joins and reduce repeated scans.",
    "hypothesis": "Original plan scans large fact tables once per CTE, then self-joins CTEs for three quarters. Pivoting the CTEs to produce one row per (ca_county, d_year) with three quarter columns eliminates self-joins and reduces CTE materialization overhead. Date filters are pushed into CTEs for pruning.",
    "expected_explain_delta": "Eliminates 5 self-joins (ss1-ss3, ws1-ws3) and reduces CTE scans from 6 to 2. Fact table scans may benefit from earlier date filter pushdown.",
    "target_ir": "Replace ss and ws CTEs with pivoted versions; rewrite final_select as a single join between pivoted CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss_pivot", "ws_pivot"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": true,
          "sql": "SELECT ss_pivot.ca_county, ss_pivot.d_year, CASE WHEN ws_pivot.web_sales_q1 > 0 THEN ws_pivot.web_sales_q2 / ws_pivot.web_sales_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN ss_pivot.store_sales_q1 > 0 THEN ss_pivot.store_sales_q2 / ss_pivot.store_sales_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN ws_pivot.web_sales_q2 > 0 THEN ws_pivot.web_sales_q3 / ws_pivot.web_sales_q2 ELSE NULL END AS web_q2_q3_increase, CASE WHEN ss_pivot.store_sales_q2 > 0 THEN ss_pivot.store_sales_q3 / ss_pivot.store_sales_q2 ELSE NULL END AS store_q2_q3_increase FROM ss_pivot JOIN ws_pivot ON ss_pivot.ca_county = ws_pivot.ca_county AND ss_pivot.d_year = ws_pivot.d_year WHERE CASE WHEN ws_pivot.web_sales_q1 > 0 THEN ws_pivot.web_sales_q2 / ws_pivot.web_sales_q1 ELSE NULL END > CASE WHEN ss_pivot.store_sales_q1 > 0 THEN ss_pivot.store_sales_q2 / ss_pivot.store_sales_q1 ELSE NULL END AND CASE WHEN ws_pivot.web_sales_q2 > 0 THEN ws_pivot.web_sales_q3 / ws_pivot.web_sales_q2 ELSE NULL END > CASE WHEN ss_pivot.store_sales_q2 > 0 THEN ss_pivot.store_sales_q3 / ss_pivot.store_sales_q2 ELSE NULL END ORDER BY ss_pivot.d_year"
        },
        {
          "node_id": "ss_pivot",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_year", "store_sales_q1", "store_sales_q2", "store_sales_q3"],
          "changed": true,
          "sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q3 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN item ON ss_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
        },
        {
          "node_id": "ws_pivot",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_year", "web_sales_q1", "web_sales_q2", "web_sales_q3"],
          "changed": true,
          "sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q3 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk JOIN item ON ws_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
        }
      ]
    }
  }
]