[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.65,
    "based_on": "p01,p02",
    "strategy": "Single-pass conditional aggregation to eliminate self-joins and reduce fact table scans.",
    "hypothesis": "Probes p01 (date_sk pushdown) and p02 (consolidation) regressed but show the primary hotspot is repeated fact table scans for quarters. Residual gap: 100% of original scan volume remains unaddressed. This rewrite consolidates quarter scans into single-pass conditional aggregates, eliminating self-joins while preserving semantics.",
    "expected_explain_delta": "Eliminate multiple fact table scans and self-joins, replaced by single scan and aggregate per fact table.",
    "target_ir": "Replace ss and ws CTEs with single-pass conditional aggregates (ss_agg, ws_agg) and update final_select to compute ratios from aggregated columns.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss_agg", "ws_agg"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": true,
          "sql": "SELECT ss.ca_county, ss.d_year, CASE WHEN ws.web_sales_q1 > 0 THEN ws.web_sales_q2 / ws.web_sales_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN ss.store_sales_q1 > 0 THEN ss.store_sales_q2 / ss.store_sales_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN ws.web_sales_q2 > 0 THEN ws.web_sales_q3 / ws.web_sales_q2 ELSE NULL END AS web_q2_q3_increase, CASE WHEN ss.store_sales_q2 > 0 THEN ss.store_sales_q3 / ss.store_sales_q2 ELSE NULL END AS store_q2_q3_increase FROM ss_agg ss JOIN ws_agg ws ON ss.ca_county = ws.ca_county AND ss.d_year = ws.d_year WHERE CASE WHEN ws.web_sales_q1 > 0 THEN ws.web_sales_q2 / ws.web_sales_q1 ELSE NULL END > CASE WHEN ss.store_sales_q1 > 0 THEN ss.store_sales_q2 / ss.store_sales_q1 ELSE NULL END AND CASE WHEN ws.web_sales_q2 > 0 THEN ws.web_sales_q3 / ws.web_sales_q2 ELSE NULL END > CASE WHEN ss.store_sales_q2 > 0 THEN ss.store_sales_q3 / ss.store_sales_q2 ELSE NULL END ORDER BY ss.d_year"
        },
        {
          "node_id": "ss_agg",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_year", "store_sales_q1", "store_sales_q2", "store_sales_q3"],
          "changed": true,
          "sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS store_sales_q3 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN item ON ss_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
        },
        {
          "node_id": "ws_agg",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_year", "web_sales_q1", "web_sales_q2", "web_sales_q3"],
          "changed": true,
          "sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price ELSE 0 END) AS web_sales_q3 FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk JOIN item ON ws_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
        }
      ]
    }
  }
]