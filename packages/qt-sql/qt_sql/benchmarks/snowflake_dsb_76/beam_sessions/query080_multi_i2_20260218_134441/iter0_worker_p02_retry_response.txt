{
  "probe_id": "p02",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-aggregating each fact table (store_sales, catalog_sales, web_sales) by their respective join keys before joining with dimensions reduces row flow into downstream operators while preserving all filters and aggregate semantics.",
  "reasoning_trace": [
    "Assigned transform targets early aggregation of fact tables to reduce join amplification.",
    "Each CTE (ssr, csr, wsr) groups by a key compatible with downstream join keys, enabling safe pushdown.",
    "All WHERE filters are preserved in rewritten nodes to maintain semantic equivalence.",
    "LEFT OUTER JOINs and COALESCE-based return/profit logic are retained to comply with do_not_do constraints."
  ],
  "target_ir": "Each fact table is pre-aggregated on join keys before dimension joins in ssr, csr, wsr CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "ssr",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "date_dim", "store", "item", "promotion"],
        "outputs": ["store_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "WITH pre_agg_store AS (SELECT ss_item_sk, ss_store_sk, ss_ticket_number, SUM(ss_ext_sales_price) AS sales, SUM(coalesce(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - coalesce(sr_net_loss, 0)) AS profit FROM store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 day') AND ss_wholesale_cost BETWEEN 21 AND 36 GROUP BY ss_item_sk, ss_store_sk, ss_ticket_number) SELECT s_store_id AS store_id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM pre_agg_store JOIN store ON pre_agg_store.ss_store_sk = s_store_sk JOIN item ON pre_agg_store.ss_item_sk = i_item_sk JOIN promotion ON pre_agg_store.ss_promo_sk = p_promo_sk WHERE i_current_price > 50 AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY s_store_id"
      },
      {
        "node_id": "csr",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "catalog_returns", "date_dim", "catalog_page", "item", "promotion"],
        "outputs": ["catalog_page_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "WITH pre_agg_catalog AS (SELECT cs_item_sk, cs_order_number, cs_catalog_page_sk, SUM(cs_ext_sales_price) AS sales, SUM(coalesce(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - coalesce(cr_net_loss, 0)) AS profit FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number) WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 day') AND cs_wholesale_cost BETWEEN 21 AND 36 GROUP BY cs_item_sk, cs_order_number, cs_catalog_page_sk) SELECT cp_catalog_page_id AS catalog_page_id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM pre_agg_catalog JOIN catalog_page ON pre_agg_catalog.cs_catalog_page_sk = cp_catalog_page_sk JOIN item ON pre_agg_catalog.cs_item_sk = i_item_sk JOIN promotion ON pre_agg_catalog.cs_promo_sk = p_promo_sk WHERE i_current_price > 50 AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY cp_catalog_page_id"
      },
      {
        "node_id": "wsr",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "web_returns", "date_dim", "web_site", "item", "promotion"],
        "outputs": ["web_site_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "WITH pre_agg_web AS (SELECT ws_item_sk, ws_order_number, ws_web_site_sk, SUM(ws_ext_sales_price) AS sales, SUM(coalesce(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - coalesce(wr_net_loss, 0)) AS profit FROM web_sales LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 day') AND ws_wholesale_cost BETWEEN 21 AND 36 GROUP BY ws_item_sk, ws_order_number, ws_web_site_sk) SELECT web_site_id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM pre_agg_web JOIN web_site ON pre_agg_web.ws_web_site_sk = web_site_sk JOIN item ON pre_agg_web.ws_item_sk = i_item_sk JOIN promotion ON pre_agg_web.ws_promo_sk = p_promo_sk WHERE i_current_price > 50 AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY web_site_id"
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["ssr", "csr", "wsr"],
        "outputs": ["channel", "id", "sales", "returns", "profit"],
        "changed": false
      }
    ]
  }
}