{
  "probe_id": "p12",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "The customer_address table is scanned twice with different filters. Materializing it into a CTE can reduce I/O by enabling reuse and avoiding repeated base table scans.",
  "reasoning_trace": [
    "Assigned transform targets CUSTOMER_ADDRESS scan duplication in CTE and final SELECT contexts.",
    "Both scans apply different filters but share the same base table, making CTE reuse beneficial.",
    "New CTE preserves all required columns and allows selective projection in downstream nodes.",
    "Change aligns with Snowflake's multi-ref CTE reuse optimization when semantics are preserved."
  ],
  "target_ir": "customer_address becomes a shared CTE; both final_select and customer_total_return reference it.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_total_return", "customer_address_filtered", "customer"],
        "outputs": ["c_customer_id", "c_salutation", "c_first_name", "c_last_name", "c_preferred_cust_flag", "c_birth_day", "c_birth_month", "c_birth_year", "c_birth_country", "c_login", "c_email_address", "c_last_review_date", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag ,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address ,c_last_review_date,ctr_total_return FROM customer_total_return ctr1 ,customer_address_filtered ca ,customer WHERE ctr1.ctr_total_return > (SELECT avg(ctr_total_return)*1.2 FROM customer_total_return ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca.ca_address_sk = c_current_addr_sk AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag ,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address ,c_last_review_date,ctr_total_return LIMIT 100"
      },
      {
        "node_id": "customer_total_return",
        "parent_node_id": "final_select",
        "sources": ["web_returns", "date_dim", "customer_address_filtered", "item"],
        "outputs": ["ctr_customer_sk", "ctr_state", "ctr_reason_sk", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT wr_returning_customer_sk AS ctr_customer_sk ,ca_state AS ctr_state ,wr_reason_sk AS ctr_reason_sk ,SUM(wr_return_amt) AS ctr_total_return FROM web_returns ,date_dim ,customer_address_filtered ,item WHERE wr_returned_date_sk = d_date_sk AND d_year = 2002 AND wr_returning_addr_sk = ca_address_sk AND wr_item_sk = i_item_sk AND i_manager_id BETWEEN 68 AND 77 AND wr_return_amt / wr_return_quantity BETWEEN 242 AND 271 GROUP BY wr_returning_customer_sk ,ca_state, wr_reason_sk"
      },
      {
        "node_id": "customer_address_filtered",
        "parent_node_id": null,
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state FROM customer_address"
      }
    ]
  }
}