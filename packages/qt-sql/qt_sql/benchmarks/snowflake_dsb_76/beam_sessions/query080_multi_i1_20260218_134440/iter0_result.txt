{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.03032622,
  "beam_cost_priced_calls": 7,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 93637,
    "completion_tokens": 19519,
    "total_tokens": 113156,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 28032,
    "reasoning_tokens": 5758
  },
  "best_speedup": 1.08,
  "best_patch_id": "p03",
  "best_sql": "WITH ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price, SUM(ss_net_profit) AS ss_net_profit FROM store_sales WHERE ss_wholesale_cost BETWEEN 23 AND 38 GROUP BY ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk) ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY s_store_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk, SUM(cs_ext_sales_price) AS cs_ext_sales_price, SUM(cs_net_profit) AS cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 23 AND 38 GROUP BY cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk) cs LEFT JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN catalog_page cp ON cs.cs_catalog_page_sk = cp.cp_catalog_page_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY cp_catalog_page_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk, SUM(ws_ext_sales_price) AS ws_ext_sales_price, SUM(ws_net_profit) AS ws_net_profit FROM web_sales WHERE ws_wholesale_cost BETWEEN 23 AND 38 GROUP BY ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk) ws LEFT JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_site w ON ws.ws_web_site_sk = w.web_site_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 246.0,
      "patch_ms": 261.8,
      "output_sql": "WITH ssr AS (select  s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n from store_sales left outer join store_returns on\n        (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n    date_dim,\n    store,\n    item,\n    promotion\nwhere ss_sold_date_sk = d_date_sk\n      and d_date between cast('1998-08-29' as date)\n                 and cast('1998-08-29' as date) + interval '30 day'\n      and ss_store_sk = s_store_sk\n      and ss_item_sk = i_item_sk\n      and i_current_price > 50\n      and ss_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ss_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\n      and ss_sold_date_sk between (select min(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day') and (select max(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day')\ngroup by s_store_id), csr AS (select  cp_catalog_page_id as catalog_page_id,\n         sum(cs_ext_sales_price) as sales,\n         sum(coalesce(cr_return_amount, 0)) as returns,\n         sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n from catalog_sales left outer join catalog_returns on\n        (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),\n    date_dim,\n    catalog_page,\n    item,\n    promotion\nwhere cs_sold_date_sk = d_date_sk\n      and d_date between cast('1998-08-29' as date)\n                 and cast('1998-08-29' as date) + interval '30 day'\n       and cs_catalog_page_sk = cp_catalog_page_sk\n      and cs_item_sk = i_item_sk\n      and i_current_price > 50\n      and cs_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and cs_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\n      and cs_sold_date_sk between (select min(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day') and (select max(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day')\ngroup by cp_catalog_page_id), wsr AS (select  web_site_id,\n         sum(ws_ext_sales_price) as sales,\n         sum(coalesce(wr_return_amt, 0)) as returns,\n         sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n from web_sales left outer join web_returns on\n        (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),\n    date_dim,\n    web_site,\n    item,\n    promotion\nwhere ws_sold_date_sk = d_date_sk\n      and d_date between cast('1998-08-29' as date)\n                 and cast('1998-08-29' as date) + interval '30 day'\n       and ws_web_site_sk = web_site_sk\n      and ws_item_sk = i_item_sk\n      and i_current_price > 50\n      and ws_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ws_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\n      and ws_sold_date_sk between (select min(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day') and (select max(d_date_sk) from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day')\ngroup by web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push date_sk range derived from date_dim filter (d_date BETWEEN '1998-08-29' AND '1998-09-28') into each fact table scan (store_sales.ss_sold_date_sk, catalog_sales.cs_sold_date_sk, web_sales.ws_sold_date_sk) within the UNION ALL branches."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.6,
      "status": "IMPROVED",
      "speedup": 1.07,
      "semantic_passed": true,
      "error": null,
      "original_ms": 246.0,
      "patch_ms": 230.0,
      "output_sql": "WITH ssr AS (select  s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n from store_sales\n inner join date_dim on ss_sold_date_sk = d_date_sk\n left outer join store_returns on\n        (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n    store,\n    item,\n    promotion\nwhere d_date between cast('1998-08-29' as date)\n           and cast('1998-08-29' as date) + interval '30 day'\n      and ss_store_sk = s_store_sk\n      and ss_item_sk = i_item_sk\n      and i_current_price > 50\n      and ss_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ss_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by s_store_id), csr AS (select  cp_catalog_page_id as catalog_page_id,\n         sum(cs_ext_sales_price) as sales,\n         sum(coalesce(cr_return_amount, 0)) as returns,\n         sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n from catalog_sales\n inner join date_dim on cs_sold_date_sk = d_date_sk\n left outer join catalog_returns on\n        (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),\n    catalog_page,\n    item,\n    promotion\nwhere cs_sold_date_sk = d_date_sk\n      and d_date between cast('1998-08-29' as date)\n           and cast('1998-08-29' as date) + interval '30 day'\n      and cs_catalog_page_sk = cp_catalog_page_sk\n      and cs_item_sk = i_item_sk\n      and i_current_price > 50\n      and cs_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and cs_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by cp_catalog_page_id), wsr AS (select  web_site_id,\n         sum(ws_ext_sales_price) as sales,\n         sum(coalesce(wr_return_amt, 0)) as returns,\n         sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n from web_sales\n inner join date_dim on ws_sold_date_sk = d_date_sk\n left outer join web_returns on\n        (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),\n    web_site,\n    item,\n    promotion\nwhere ws_sold_date_sk = d_date_sk\n      and d_date between cast('1998-08-29' as date)\n           and cast('1998-08-29' as date) + interval '30 day'\n      and ws_web_site_sk = web_site_sk\n      and ws_item_sk = i_item_sk\n      and i_current_price > 50\n      and ws_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ws_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push date_sk range into each fact table scan using explicit JOIN syntax (converting comma joins to INNER JOIN) to reinforce predicate transitivity."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "IMPROVED",
      "speedup": 1.08,
      "semantic_passed": true,
      "error": null,
      "original_ms": 246.0,
      "patch_ms": 227.4,
      "output_sql": "WITH ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price, SUM(ss_net_profit) AS ss_net_profit FROM store_sales WHERE ss_wholesale_cost BETWEEN 23 AND 38 GROUP BY ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk) ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY s_store_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk, SUM(cs_ext_sales_price) AS cs_ext_sales_price, SUM(cs_net_profit) AS cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 23 AND 38 GROUP BY cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk) cs LEFT JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN catalog_page cp ON cs.cs_catalog_page_sk = cp.cp_catalog_page_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY cp_catalog_page_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk, SUM(ws_ext_sales_price) AS ws_ext_sales_price, SUM(ws_net_profit) AS ws_net_profit FROM web_sales WHERE ws_wholesale_cost BETWEEN 23 AND 38 GROUP BY ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk) ws LEFT JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_site w ON ws.ws_web_site_sk = w.web_site_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate each fact table (store_sales, catalog_sales, web_sales) by the join key (ss_store_sk, cs_catalog_page_sk, ws_web_site_sk) and date key before joining dimensions, preserving all necessary metrics for later coalesce."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.93,
      "semantic_passed": true,
      "error": null,
      "original_ms": 246.0,
      "patch_ms": 264.5,
      "output_sql": "WITH filtered_date_dim AS (select d_date_sk, d_date from date_dim where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day'), filtered_item AS (select i_item_sk, i_current_price, i_category from item where i_current_price > 50 and i_category IN ('Children', 'Sports')), filtered_promotion AS (select p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event from promotion where p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N'), ssr AS (select  s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n from store_sales left outer join store_returns on\n        (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number),\n    filtered_date_dim,\n    store,\n    filtered_item,\n    filtered_promotion\nwhere ss_sold_date_sk = d_date_sk\n      and ss_store_sk = s_store_sk\n      and ss_item_sk = i_item_sk\n      and i_current_price > 50\n      and ss_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ss_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by s_store_id), csr AS (select  cp_catalog_page_id as catalog_page_id,\n         sum(cs_ext_sales_price) as sales,\n         sum(coalesce(cr_return_amount, 0)) as returns,\n         sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n from catalog_sales left outer join catalog_returns on\n        (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number),\n    filtered_date_dim,\n    catalog_page,\n    filtered_item,\n    filtered_promotion\nwhere cs_sold_date_sk = d_date_sk\n      and cs_catalog_page_sk = cp_catalog_page_sk\n      and cs_item_sk = i_item_sk\n      and i_current_price > 50\n      and cs_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and cs_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by cp_catalog_page_id), wsr AS (select  web_site_id,\n         sum(ws_ext_sales_price) as sales,\n         sum(coalesce(wr_return_amt, 0)) as returns,\n         sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n from web_sales left outer join web_returns on\n        (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number),\n    filtered_date_dim,\n    web_site,\n    filtered_item,\n    filtered_promotion\nwhere ws_sold_date_sk = d_date_sk\n      and ws_web_site_sk = web_site_sk\n      and ws_item_sk = i_item_sk\n      and i_current_price > 50\n      and ws_promo_sk = p_promo_sk\n      and p_channel_email = 'N'\n      and p_channel_tv = 'N'\n      and p_channel_radio = 'N'\n      and p_channel_press = 'N'\n      and p_channel_event = 'N'\n      and ws_wholesale_cost BETWEEN 23 AND 38\n      and i_category IN ('Children', 'Sports')\ngroup by web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter shared dimension tables (date_dim, item, promotion) into a single CTE per dimension, then reference them in each channel CTE (ssr, csr, wsr) to avoid repeated scans."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.89,
      "semantic_passed": true,
      "error": null,
      "original_ms": 191.2,
      "patch_ms": 215.6,
      "output_sql": "WITH ssr AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price, SUM(ss_net_profit) AS ss_net_profit FROM store_sales WHERE ss_wholesale_cost BETWEEN 23 AND 38 GROUP BY ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk) ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY s_store_id), csr AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk, SUM(cs_ext_sales_price) AS cs_ext_sales_price, SUM(cs_net_profit) AS cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 23 AND 38 GROUP BY cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk) cs LEFT JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN catalog_page cp ON cs.cs_catalog_page_sk = cp.cp_catalog_page_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY cp_catalog_page_id), wsr AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk, SUM(ws_ext_sales_price) AS ws_ext_sales_price, SUM(ws_net_profit) AS ws_net_profit FROM web_sales WHERE ws_wholesale_cost BETWEEN 23 AND 38 GROUP BY ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk) ws LEFT JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_site w ON ws.ws_web_site_sk = w.web_site_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 191.2,
      "patch_ms": 216.7,
      "output_sql": "WITH ssr AS (select  s_store_id as store_id, sum(ss_ext_sales_price) as sales, sum(coalesce(sr_return_amt, 0)) as returns, sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit from store_sales inner join date_dim on ss_sold_date_sk = d_date_sk left outer join store_returns on (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number), store, item, promotion where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and ss_store_sk = s_store_sk and ss_item_sk = i_item_sk and i_current_price > 50 and ss_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and ss_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by s_store_id), csr AS (select  cp_catalog_page_id as catalog_page_id, sum(cs_ext_sales_price) as sales, sum(coalesce(cr_return_amount, 0)) as returns, sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit from catalog_sales inner join date_dim on cs_sold_date_sk = d_date_sk left outer join catalog_returns on (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number), catalog_page, item, promotion where cs_sold_date_sk = d_date_sk and d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and cs_catalog_page_sk = cp_catalog_page_sk and cs_item_sk = i_item_sk and i_current_price > 50 and cs_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and cs_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by cp_catalog_page_id), wsr AS (select  web_site_id, sum(ws_ext_sales_price) as sales, sum(coalesce(wr_return_amt, 0)) as returns, sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit from web_sales inner join date_dim on ws_sold_date_sk = d_date_sk left outer join web_returns on (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number), web_site, item, promotion where ws_sold_date_sk = d_date_sk and d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and ws_web_site_sk = web_site_sk and ws_item_sk = i_item_sk and i_current_price > 50 and ws_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and ws_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by web_site_id) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) AS x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 169354 | 166842 | 2840299356160\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_DATE >= '1998-08-29') AND (DATE_DIM.D_DATE <= '1998-09-28')\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_DATE | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_DATE >= '",
    "p04": "GlobalStats | 169352 | 169352 | 2883109012480\n1 | 0 | Result | X.CHANNEL, X.ID, SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_EXT_SALES_PRICE))), SUM(CATALOG_SALES.CS_EXT_SALES_PRICE), SUM(SUM(SUM(WEB_SALES.WS_EXT_SALES_PRICE))))), SUM(UNION_ALL(SUM(SUM(SUM(IFNULL(STORE_RETURNS.SR_RETURN_AMT, 0)))), SUM(IFNULL(CATALOG_RETURNS.CR_RETURN_AMOUNT, 0)), SUM(SUM(SUM(IFNULL(WEB_RETURNS.WR_RETURN_AMT, 0)))))), SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_NET_PROFIT - (IFNULL(STORE_RETURNS.SR_NET_LOSS, 0))))), SU",
    "p03": "GlobalStats | 169352 | 166840 | 2840295078912\n1 | 0 | Result | X.CHANNEL, X.ID, SUM(UNION_ALL(SUM(SUM(SUM(SUM(STORE_SALES.SS_EXT_SALES_PRICE)))), SUM(SUM(CATALOG_SALES.CS_EXT_SALES_PRICE)), SUM(SUM(SUM(SUM(WEB_SALES.WS_EXT_SALES_PRICE)))))), SUM(UNION_ALL(SUM(SUM(SUM(IFNULL(SR.SR_RETURN_AMT, 0)))), SUM(IFNULL(CR.CR_RETURN_AMOUNT, 0)), SUM(SUM(SUM(IFNULL(WR.WR_RETURN_AMT, 0)))))), SUM(UNION_ALL(SUM(SUM(SUM((SUM(STORE_SALES.SS_NET_PROFIT)) - (IFNULL(SR.SR_NET_LOSS, 0))))), SUM((SUM(CATALOG_SALES.C",
    "p02": "GlobalStats | 169344 | 166832 | 2840243007488\n1 | 0 | Result | X.CHANNEL, X.ID, SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_EXT_SALES_PRICE))), SUM(CATALOG_SALES.CS_EXT_SALES_PRICE), SUM(SUM(SUM(WEB_SALES.WS_EXT_SALES_PRICE))))), SUM(UNION_ALL(SUM(SUM(SUM(IFNULL(STORE_RETURNS.SR_RETURN_AMT, 0)))), SUM(IFNULL(CATALOG_RETURNS.CR_RETURN_AMOUNT, 0)), SUM(SUM(SUM(IFNULL(WEB_RETURNS.WR_RETURN_AMT, 0)))))), SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_NET_PROFIT - (IFNULL(STORE_RETURNS.SR_NET_LOSS, 0))))), SU",
    "compile_p1": "GlobalStats | 169352 | 166840 | 2840295078912\n1 | 0 | Result | X.CHANNEL, X.ID, SUM(UNION_ALL(SUM(SUM(SUM(SUM(STORE_SALES.SS_EXT_SALES_PRICE)))), SUM(SUM(CATALOG_SALES.CS_EXT_SALES_PRICE)), SUM(SUM(SUM(SUM(WEB_SALES.WS_EXT_SALES_PRICE)))))), SUM(UNION_ALL(SUM(SUM(SUM(IFNULL(SR.SR_RETURN_AMT, 0)))), SUM(IFNULL(CR.CR_RETURN_AMOUNT, 0)), SUM(SUM(SUM(IFNULL(WR.WR_RETURN_AMT, 0)))))), SUM(UNION_ALL(SUM(SUM(SUM((SUM(STORE_SALES.SS_NET_PROFIT)) - (IFNULL(SR.SR_NET_LOSS, 0))))), SUM((SUM(CATALOG_SALES.C",
    "compile_p2": "GlobalStats | 169352 | 169352 | 2883109012480\n1 | 0 | Result | X.CHANNEL, X.ID, SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_EXT_SALES_PRICE))), SUM(CATALOG_SALES.CS_EXT_SALES_PRICE), SUM(SUM(SUM(WEB_SALES.WS_EXT_SALES_PRICE))))), SUM(UNION_ALL(SUM(SUM(SUM(IFNULL(STORE_RETURNS.SR_RETURN_AMT, 0)))), SUM(IFNULL(CATALOG_RETURNS.CR_RETURN_AMOUNT, 0)), SUM(SUM(SUM(IFNULL(WEB_RETURNS.WR_RETURN_AMT, 0)))))), SUM(UNION_ALL(SUM(SUM(SUM(STORE_SALES.SS_NET_PROFIT - (IFNULL(STORE_RETURNS.SR_NET_LOSS, 0))))), SU"
  }
}