[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p03",
    "strategy": "Early fact aggregation before dimension joins to reduce rows.",
    "hypothesis": "Probe p03 showed 1.08x speedup by pre-aggregating fact tables (store_sales, catalog_sales, web_sales) by join keys before joining dimensions, reducing rows early while preserving semantics.",
    "expected_explain_delta": "Fact table scans replaced by aggregate subqueries; join operators process fewer rows.",
    "target_ir": "Change ssr, csr, wsr to pre-aggregate fact tables and then join dimensions.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["wsr", "ssr", "csr"],
          "outputs": ["channel", "id", "sales", "returns", "profit"],
          "changed": false
        },
        {
          "node_id": "ssr",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "date_dim", "store", "item", "promotion"],
          "outputs": ["store_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price, SUM(ss_net_profit) AS ss_net_profit FROM store_sales WHERE ss_wholesale_cost BETWEEN 23 AND 38 GROUP BY ss_store_sk, ss_item_sk, ss_ticket_number, ss_promo_sk, ss_sold_date_sk) ss LEFT JOIN store_returns sr ON ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN promotion p ON ss.ss_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY s_store_id"
        },
        {
          "node_id": "csr",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "catalog_returns", "date_dim", "catalog_page", "item", "promotion"],
          "outputs": ["catalog_page_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk, SUM(cs_ext_sales_price) AS cs_ext_sales_price, SUM(cs_net_profit) AS cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 23 AND 38 GROUP BY cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_promo_sk, cs_sold_date_sk) cs LEFT JOIN catalog_returns cr ON cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN catalog_page cp ON cs.cs_catalog_page_sk = cp.cp_catalog_page_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY cp_catalog_page_id"
        },
        {
          "node_id": "wsr",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "date_dim", "web_site", "item", "promotion"],
          "outputs": ["web_site_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk, SUM(ws_ext_sales_price) AS ws_ext_sales_price, SUM(ws_net_profit) AS ws_net_profit FROM web_sales WHERE ws_wholesale_cost BETWEEN 23 AND 38 GROUP BY ws_web_site_sk, ws_item_sk, ws_order_number, ws_promo_sk, ws_sold_date_sk) ws LEFT JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_site w ON ws.ws_web_site_sk = w.web_site_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk WHERE d.d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 day' AND i_current_price > 50 AND p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Children', 'Sports') GROUP BY web_site_id"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.70,
    "based_on": "p04",
    "strategy": "Explicit INNER JOIN for date_dim to encourage predicate pushdown.",
    "hypothesis": "Probe p04 showed 1.07x speedup by converting comma joins to explicit INNER JOIN on date_dim, which may improve predicate pushdown and join ordering.",
    "expected_explain_delta": "Join operators may reorder; date filter may push into fact scans more effectively.",
    "target_ir": "Change comma joins to explicit INNER JOIN on date_dim and left outer join on returns in ssr, csr, wsr.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["wsr", "ssr", "csr"],
          "outputs": ["channel", "id", "sales", "returns", "profit"],
          "changed": false
        },
        {
          "node_id": "ssr",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "date_dim", "store", "item", "promotion"],
          "outputs": ["store_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "select  s_store_id as store_id, sum(ss_ext_sales_price) as sales, sum(coalesce(sr_return_amt, 0)) as returns, sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit from store_sales inner join date_dim on ss_sold_date_sk = d_date_sk left outer join store_returns on (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number), store, item, promotion where d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and ss_store_sk = s_store_sk and ss_item_sk = i_item_sk and i_current_price > 50 and ss_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and ss_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by s_store_id"
        },
        {
          "node_id": "csr",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "catalog_returns", "date_dim", "catalog_page", "item", "promotion"],
          "outputs": ["catalog_page_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "select  cp_catalog_page_id as catalog_page_id, sum(cs_ext_sales_price) as sales, sum(coalesce(cr_return_amount, 0)) as returns, sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit from catalog_sales inner join date_dim on cs_sold_date_sk = d_date_sk left outer join catalog_returns on (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number), catalog_page, item, promotion where cs_sold_date_sk = d_date_sk and d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and cs_catalog_page_sk = cp_catalog_page_sk and cs_item_sk = i_item_sk and i_current_price > 50 and cs_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and cs_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by cp_catalog_page_id"
        },
        {
          "node_id": "wsr",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "date_dim", "web_site", "item", "promotion"],
          "outputs": ["web_site_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "select  web_site_id, sum(ws_ext_sales_price) as sales, sum(coalesce(wr_return_amt, 0)) as returns, sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit from web_sales inner join date_dim on ws_sold_date_sk = d_date_sk left outer join web_returns on (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number), web_site, item, promotion where ws_sold_date_sk = d_date_sk and d_date between cast('1998-08-29' as date) and cast('1998-08-29' as date) + interval '30 day' and ws_web_site_sk = web_site_sk and ws_item_sk = i_item_sk and i_current_price > 50 and ws_promo_sk = p_promo_sk and p_channel_email = 'N' and p_channel_tv = 'N' and p_channel_radio = 'N' and p_channel_press = 'N' and p_channel_event = 'N' and ws_wholesale_cost BETWEEN 23 AND 38 and i_category IN ('Children', 'Sports') group by web_site_id"
        }
      ]
    }
  }
]