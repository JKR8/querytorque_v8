{
  "iteration": 0,
  "n_api_calls": 17,
  "beam_cost_usd": 0.076258,
  "beam_cost_priced_calls": 17,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 181670,
    "completion_tokens": 36105,
    "total_tokens": 217775,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 26841,
    "reasoning_tokens": 15416
  },
  "best_speedup": 1.66,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998) UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998)) cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.92,
      "status": "IMPROVED",
      "speedup": 1.09,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 161.2,
      "output_sql": "WITH my_customers AS (select distinct c_customer_sk, c_current_addr_sk from (select cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost from catalog_sales where cs_sold_date_sk in (select d_date_sk from date_dim where d_moy = 1 and d_year = 1998) union all select ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost from web_sales where ws_sold_date_sk in (select d_date_sk from date_dim where d_moy = 1 and d_year = 1998)) cs_or_ws_sales, item, date_dim, customer where sold_date_sk = d_date_sk and item_sk = i_item_sk and i_category = 'Electronics' and i_class = 'personal' and c_customer_sk = cs_or_ws_sales.customer_sk and d_moy = 1 and d_year = 1998 and wholesale_cost BETWEEN 35 AND 65 and c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Push explicit date_sk range predicates into both UNION ALL branches to enable micro-partition pruning on CATALOG_SALES and WEB_SALES"
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.88,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: 002028 (42601): 01c27ba5-3205-66c8-0002-fcfe0001c0de: SQL compilation error:\nambiguous column name 'D_DATE_SK'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), date_bound_start AS (select distinct d_date_sk from date_dim where d_year = 1998 and d_moy = 1), date_bound_end AS (select distinct d_date_sk from date_dim where d_year = 1998 and d_moy = 3), my_revenue AS (select c_customer_sk,\n       sum(ss_ext_sales_price) as revenue\nfrom   my_customers,\n       store_sales,\n       customer_address,\n       store,\n       date_dim,\n       date_bound_start,\n       date_bound_end\nwhere  c_current_addr_sk = ca_address_sk\n       and ca_county = s_county\n       and ca_state = s_state\n       and ss_sold_date_sk = d_date_sk\n       and c_customer_sk = ss_customer_sk\n       and ss_wholesale_cost BETWEEN 35 AND 65\n       and s_state in ('AR','CO','IA'\n                   ,'IL','KY','NC'\n                   ,'NM','NY','PA'\n                   ,'TX')\n       and d_month_seq between (select distinct d_month_seq+1\n                                from   date_dim where d_year = 1998 and d_moy = 1)\n                          and  (select distinct d_month_seq+3\n                                from   date_dim where d_year = 1998 and d_moy = 1)\n       and ss_sold_date_sk between date_bound_start.d_date_sk and date_bound_end.d_date_sk\n group by c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": false,
      "description": "[qwen:qwen/qwen3-coder] Add explicit SS_SOLD_DATE_SK range predicate to STORE_SALES scan to enable micro-partition pruning"
    },
    {
      "patch_id": "p07",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.65,
      "status": "NEUTRAL",
      "speedup": 1.04,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 170.0,
      "output_sql": "WITH filtered_date_dim AS (select d_date_sk, d_moy, d_year from date_dim where d_moy = 1 and d_year = 1998), my_customers AS (select distinct c_customer_sk, c_current_addr_sk from ( select cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost from catalog_sales union all select ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost from web_sales ) cs_or_ws_sales, item, filtered_date_dim, customer where sold_date_sk = d_date_sk and item_sk = i_item_sk and i_category = 'Electronics' and i_class = 'personal' and c_customer_sk = cs_or_ws_sales.customer_sk and d_moy = 1 and d_year = 1998 and wholesale_cost BETWEEN 35 AND 65 and c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Extract shared DATE_DIM filter into one CTE and reference it from both CATALOG_SALES and WEB_SALES branches"
    },
    {
      "patch_id": "p10",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_customers_items AS (SELECT c.c_customer_sk, i.i_item_sk FROM customer c, item i WHERE i.i_category = 'Electronics' AND i.i_class = 'personal' AND c.c_birth_year BETWEEN 1928 AND 1941), my_customers AS (SELECT DISTINCT cs_or_ws_sales.customer_sk AS c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk FROM web_sales) cs_or_ws_sales JOIN filtered_customers_items f ON cs_or_ws_sales.customer_sk = f.c_customer_sk AND cs_or_ws_sales.item_sk = f.i_item_sk JOIN date_dim d ON cs_or_ws_sales.sold_date_sk = d.d_date_sk JOIN customer c ON cs_or_ws_sales.customer_sk = c.c_customer_sk WHERE d.d_moy = 1 AND d.d_year = 1998 AND c.c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": false,
      "description": "[qwen:qwen/qwen3-coder] Apply CUSTOMER and ITEM filters earlier in the pipeline before UNION ALL to reduce fact table scan size"
    },
    {
      "patch_id": "p09",
      "family": "A",
      "transform": "date_cte_isolate",
      "relevance_score": 0.55,
      "status": "NEUTRAL",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 168.6,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), date_seq AS (select distinct d_month_seq+1 as start_month, d_month_seq+3 as end_month\nfrom   date_dim \nwhere  d_moy = 1\n       and d_year = 1998), my_revenue AS (select c_customer_sk,\n       sum(ss_ext_sales_price) as revenue\nfrom   my_customers,\n       store_sales,\n       customer_address,\n       store,\n       date_dim,\n       date_seq\nwhere  c_current_addr_sk = ca_address_sk\n       and ca_county = s_county\n       and ca_state = s_state\n       and ss_sold_date_sk = d_date_sk\n       and c_customer_sk = ss_customer_sk\n       and ss_wholesale_cost BETWEEN 35 AND 65\n       and s_state in ('AR','CO','IA'\n                   ,'IL','KY','NC'\n                   ,'NM','NY','PA'\n                   ,'TX')\n       and d_month_seq between (select start_month from date_seq)\n                          and  (select end_month from date_seq)\ngroup by c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Isolate DATE_DIM filter for d_month_seq calculation into separate CTE to avoid repeated scans"
    },
    {
      "patch_id": "p08",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.6,
      "status": "IMPROVED",
      "speedup": 1.09,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 162.5,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Materialize my_customers CTE to avoid recomputation in my_revenue join path"
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.78,
      "status": "NEUTRAL",
      "speedup": 1.01,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 174.8,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk, i_category, i_class FROM item WHERE i_category = 'Electronics' AND i_class = 'personal'), filtered_customer AS (SELECT c_customer_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_year BETWEEN 1928 AND 1941), my_customers AS (SELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales, filtered_item i, date_dim d, filtered_customer c WHERE sold_date_sk = d.d_date_sk AND item_sk = i.i_item_sk AND i.i_category = 'Electronics' AND i.i_class = 'personal' AND c.c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c.c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Pre-filter ITEM and CUSTOMER dimensions into separate CTEs to create small hash tables for faster fact table probing"
    },
    {
      "patch_id": "p06",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.68,
      "status": "NEUTRAL",
      "speedup": 1.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 176.4,
      "patch_ms": 177.0,
      "output_sql": "WITH filtered_item AS (select i_item_sk\nfrom item\nwhere i_category = 'Electronics'\n  and i_class = 'personal'), filtered_date AS (select d_date_sk\nfrom date_dim\nwhere d_moy = 1\n  and d_year = 1998), filtered_customer AS (select c_customer_sk, c_current_addr_sk\nfrom customer\nwhere c_birth_year BETWEEN 1928 AND 1941), prefetch_sales AS (with filtered_item as (\n select i_item_sk\n from item\n where i_category = 'Electronics'\n   and i_class = 'personal'\n),\nfiltered_date as (\n select d_date_sk\n from date_dim\n where d_moy = 1\n   and d_year = 1998\n),\nfiltered_customer as (\n select c_customer_sk, c_current_addr_sk\n from customer\n where c_birth_year BETWEEN 1928 AND 1941\n)\nselect cs_sold_date_sk as sold_date_sk,\n       cs_bill_customer_sk as customer_sk,\n       cs_item_sk as item_sk,\n       cs_wholesale_cost as wholesale_cost\nfrom catalog_sales, filtered_item, filtered_date\nwhere cs_item_sk = filtered_item.i_item_sk\n  and cs_sold_date_sk = filtered_date.d_date_sk\n  and cs_wholesale_cost BETWEEN 35 AND 65\nunion all\nselect ws_sold_date_sk as sold_date_sk,\n       ws_bill_customer_sk as customer_sk,\n       ws_item_sk as item_sk,\n       ws_wholesale_cost as wholesale_cost\nfrom web_sales, filtered_item, filtered_date\nwhere ws_item_sk = filtered_item.i_item_sk\n  and ws_sold_date_sk = filtered_date.d_date_sk\n  and ws_wholesale_cost BETWEEN 35 AND 65), my_customers AS (select distinct c.c_customer_sk\n       , c.c_current_addr_sk\nfrom prefetch_sales cs_or_ws_sales,\n     filtered_item i,\n     filtered_date d,\n     filtered_customer c\nwhere   cs_or_ws_sales.sold_date_sk = d.d_date_sk\n        and cs_or_ws_sales.item_sk = i.i_item_sk\n        and c.c_customer_sk = cs_or_ws_sales.customer_sk\n        and cs_or_ws_sales.wholesale_cost BETWEEN 35 AND 65), my_revenue AS (select c_customer_sk,\n       sum(ss_ext_sales_price) as revenue\nfrom   my_customers,\n       store_sales,\n       customer_address,\n       store,\n       date_dim\nwhere  c_current_addr_sk = ca_address_sk\n       and ca_county = s_county\n       and ca_state = s_state\n       and ss_sold_date_sk = d_date_sk\n       and c_customer_sk = ss_customer_sk\n       and ss_wholesale_cost BETWEEN 35 AND 65\n       and s_state in ('AR','CO','IA'\n                   ,'IL','KY','NC'\n                   ,'NM','NY','PA'\n                   ,'TX')\n       and d_month_seq between (select distinct d_month_seq+1\n                                from   date_dim where d_year = 1998 and d_moy = 1)\n                          and  (select distinct d_month_seq+3\n                                from   date_dim where d_year = 1998 and d_moy = 1)\ngroup by c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[qwen:qwen/qwen3-coder] Build a CTE chain that progressively reduces data - first filter dimensions, then pre-join with fact tables"
    },
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.72,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Missing SQL for tree node `cs_or_ws_sales`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[qwen:qwen/qwen3-coder] Pre-filter all selective dimensions (ITEM, CUSTOMER, DATE_DIM, STORE) into CTEs before joining with fact tables"
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.85,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: 000904 (42000): 01c27ba5-3205-66c8-0002-fcfe0001c0e2: SQL compilation error: error line 1 at position 1,358\ninvalid identifier 'SS_SOLD_DATE_SK'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), store_sales_agg AS (SELECT ss_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_wholesale_cost BETWEEN 35 AND 65 AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY ss_customer_sk), my_revenue AS (SELECT c_customer_sk, SUM(revenue) AS revenue FROM my_customers, store_sales_agg, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": false,
      "description": "[reasoner:deepseek/deepseek-v3.2] Pre-aggregate STORE_SALES by customer key before joining with customer dimensions to reduce join input size"
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.66,
      "semantic_passed": true,
      "error": null,
      "original_ms": 253.7,
      "patch_ms": 152.9,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998) UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998)) cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.42,
      "semantic_passed": true,
      "error": null,
      "original_ms": 253.7,
      "patch_ms": 178.9,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_moy, d_year FROM date_dim WHERE d_moy = 1 AND d_year = 1998), date_seq AS (SELECT DISTINCT d_month_seq+1 AS start_month, d_month_seq+3 AS end_month FROM date_dim WHERE d_moy = 1 AND d_year = 1998), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales, item, filtered_date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim, date_seq WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN (SELECT start_month FROM date_seq) AND (SELECT end_month FROM date_seq) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.45,
      "semantic_passed": true,
      "error": null,
      "original_ms": 253.7,
      "patch_ms": 175.2,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998) UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998)) cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.5,
      "semantic_passed": true,
      "error": null,
      "original_ms": 253.7,
      "patch_ms": 169.1,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_moy, d_year FROM date_dim WHERE d_moy = 1 AND d_year = 1998), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk sold_date_sk, cs_bill_customer_sk customer_sk, cs_item_sk item_sk, cs_wholesale_cost wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk sold_date_sk, ws_bill_customer_sk customer_sk, ws_item_sk item_sk, ws_wholesale_cost wholesale_cost FROM web_sales) cs_or_ws_sales, item, filtered_date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim, (SELECT DISTINCT d_month_seq+1 AS start_month, d_month_seq+3 AS end_month FROM date_dim WHERE d_moy = 1 AND d_year = 1998) date_seq WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN date_seq.start_month AND date_seq.end_month GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 155745 | 153233 | 2596910891008\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p07": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p09": "GlobalStats | 155744 | 153232 | 2596908752384\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1, DATE_DIM.D_MONTH_SEQ + 3]\n1 | 4 | [3] | Filter | (DATE_DIM.D_MOY = 1) AND (DATE_DIM.D_YEAR = 1998)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1, DATE_DIM.D_MONTH_SEQ + 3]",
    "p08": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p04": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "p06": "GlobalStats | 155743 | 153231 | 2596906613760\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "compile_p1": "GlobalStats | 155745 | 153233 | 2596910891008\n1 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 1\n1 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 1]\n1 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND (DATE_DIM.D_MOY = 1)\n1 | 5 | [4] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_MONTH_SEQ, D_YEAR, D_MOY | 1 | 1 | 2138624\n2 | 0 | Result | DATE_DIM.D_MONTH_SEQ + 3\n2 | 3 | [2] | Aggregate | groupKeys: [DATE_DIM.D_MONTH_SEQ + 3]\n2 | 4 | [3] | Filter | (DATE_DIM.D_YEAR = 1998) AND",
    "compile_p2": "GlobalStats | 155742 | 155536 | 2636200307712\n1 | 0 | Result | (SUM(SUM(SUM(SUM(SUM_INTERNAL(SUM(STORE_SALES.SS_EXT_SALES_PRICE), COUNT(*))))))) / 50, COUNT(*), ((SUM(SUM(SUM(SUM(SUM_INTERNAL(SUM(STORE_SALES.SS_EXT_SALES_PRICE), COUNT(*))))))) / 50) * 50\n1 | 1 | [0] | SortWithLimit | sortKey: [(MY_REVENUE.REVENUE) / 50 ASC NULLS LAST, COUNT(*) ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [COUNT(*)], groupKeys: [(SUM(SUM(SUM(SUM(SUM_INTERNAL(SUM(STORE_SALES.SS_EXT_SALES_PRIC"
  }
}