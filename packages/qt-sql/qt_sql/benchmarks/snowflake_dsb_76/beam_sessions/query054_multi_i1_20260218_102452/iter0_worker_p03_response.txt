{
  "probe_id": "aggregate_pushdown_probe",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "snowflake",
  "hypothesis": "Pre-aggregating STORE_SALES with date filter before joining reduces the number of rows scanned and processed in the join with customer dimensions, addressing the hotspot of repeated large fact table scans without effective partition pruning.",
  "reasoning_trace": [
    "Execution plan snippet shows STORE_SALES scan with 70412 partitions and 1.2TB data volume, indicating high scan pressure.",
    "Pre-aggregation by ss_customer_sk with ss_wholesale_cost and date_dim filters reduces rows early, aligning with aggregate_pushdown transform objective.",
    "Join with my_customers and other dimensions after aggregation minimizes row amplification while preserving semantics and node contract requirements."
  ],
  "target_ir": "Updated my_revenue to join through pre-aggregated store_sales_agg CTE, which aggregates STORE_SALES by customer key with filters before dimensional joins, reducing input size to customer join path.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "my_customers",
        "parent_node_id": "my_revenue",
        "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
        "outputs": ["c_customer_sk", "c_current_addr_sk"],
        "changed": false
      },
      {
        "node_id": "store_sales_agg",
        "parent_node_id": "my_revenue",
        "sources": ["store_sales", "date_dim"],
        "outputs": ["ss_customer_sk", "revenue"],
        "changed": true,
        "sql": "SELECT ss_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_wholesale_cost BETWEEN 35 AND 65 AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY ss_customer_sk"
      },
      {
        "node_id": "my_revenue",
        "parent_node_id": "segments",
        "sources": ["my_customers", "store_sales_agg", "customer_address", "store"],
        "outputs": ["c_customer_sk", "revenue"],
        "changed": true,
        "sql": "SELECT mc.c_customer_sk, MAX(ssa.revenue) AS revenue FROM my_customers mc JOIN store_sales_agg ssa ON mc.c_customer_sk = ssa.ss_customer_sk JOIN customer_address ca ON mc.c_current_addr_sk = ca.ca_address_sk JOIN store s ON ca.ca_county = s.s_county AND ca.ca_state = s.s_state WHERE s.s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') GROUP BY mc.c_customer_sk"
      },
      {
        "node_id": "segments",
        "parent_node_id": "final_select",
        "sources": ["my_revenue"],
        "outputs": ["segment"],
        "changed": false
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["segments"],
        "outputs": ["segment", "num_customers", "segment_base"],
        "changed": false
      }
    ]
  }
}