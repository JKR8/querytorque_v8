{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.01843583,
  "beam_cost_priced_calls": 7,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 64215,
    "completion_tokens": 13793,
    "total_tokens": 78008,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 23552,
    "reasoning_tokens": 7614
  },
  "best_speedup": 1.03,
  "best_patch_id": "compile_p1",
  "best_sql": "SELECT \n   COUNT(DISTINCT ws_order_number) AS \"order count\",\n   SUM(ws_ext_ship_cost) AS \"total shipping cost\",\n   SUM(ws_net_profit) AS \"total net profit\"\nFROM\n   web_sales ws1,\n   date_dim,\n   customer_address,\n   web_site\nWHERE\n    d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day'\n    AND ws1.ws_ship_date_sk = d_date_sk\n    AND ws1.ws_ship_addr_sk = ca_address_sk\n    AND ca_state IN ('CA','MI','OH','SD','TX','VA')\n    AND ws1.ws_web_site_sk = web_site_sk\n    AND web_gmt_offset >= -5\n    AND ws1.ws_list_price BETWEEN 237 AND 266\n    AND ws1.ws_ship_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day')\n                                 AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day')\n    AND EXISTS (SELECT *\n                FROM web_sales ws2\n                WHERE ws1.ws_order_number = ws2.ws_order_number\n                  AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n    AND NOT EXISTS (SELECT *\n                    FROM web_returns wr1\n                    WHERE ws1.ws_order_number = wr1.wr_order_number\n                      AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69))\nORDER BY COUNT(DISTINCT ws_order_number)\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.75,
      "status": "REGRESSION",
      "speedup": 0.91,
      "semantic_passed": true,
      "error": null,
      "original_ms": 155.4,
      "patch_ms": 170.0,
      "output_sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '2002-9-01' and\n           cast('2002-9-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('CA','MI','OH'\n            ,'SD' ,'TX' ,'VA')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 237 and 266\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (7, 25, 26, 52, 69)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate WEB_SALES by ws_order_number before joining with dimensions, reducing join cardinality."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '2002-9-01' and\n           cast('2002-9-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('CA','MI','OH'\n            ,'SD' ,'TX' ,'VA')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 237 and 266\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk\n              and ws2.ws_ship_date_sk between 2452521 and 2452581)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (7, 25, 26, 52, 69)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Add explicit ws_ship_date_sk BETWEEN range derived from date_dim filter to main WEB_SALES scan and EXISTS branch WEB_SALES scan."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "sf_sk_pushdown_union_all",
      "relevance_score": 0.65,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": null,
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '2002-9-01' and\n           cast('2002-9-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('CA','MI','OH'\n            ,'SD' ,'TX' ,'VA')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 237 and 266\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (7, 25, 26, 52, 69)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Push date_sk range into EXISTS subquery by converting EXISTS to UNION ALL branches with explicit date range filter, then aggregate to remove duplicates."
    },
    {
      "patch_id": "p04",
      "family": "C",
      "transform": "channel_bitmap_aggregation",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.8,
      "semantic_passed": true,
      "error": null,
      "original_ms": 155.4,
      "patch_ms": 194.3,
      "output_sql": "WITH web_sales_labeled AS (SELECT ws.ws_order_number, ws.ws_ext_ship_cost, ws.ws_net_profit, 1 AS is_main, CASE WHEN EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws.ws_order_number = ws2.ws_order_number AND ws.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT 1 FROM web_returns wr1 WHERE ws.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) THEN 1 ELSE 0 END AS is_exists FROM web_sales ws JOIN date_dim d ON ws.ws_ship_date_sk = d.d_date_sk JOIN customer_address ca ON ws.ws_ship_addr_sk = ca_address_sk JOIN web_site w ON ws.ws_web_site_sk = w.web_site_sk WHERE d.d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day' AND ca_state IN ('CA','MI','OH','SD','TX','VA') AND w.web_gmt_offset >= -5 AND ws.ws_list_price BETWEEN 237 AND 266), aggregated_web_sales AS (SELECT COUNT(DISTINCT CASE WHEN is_main = 1 THEN ws_order_number END) AS \"order count\", SUM(CASE WHEN is_main = 1 THEN ws_ext_ship_cost END) AS \"total shipping cost\", SUM(CASE WHEN is_main = 1 THEN ws_net_profit END) AS \"total net profit\" FROM web_sales_labeled WHERE (is_main = 1 OR is_exists = 1)) select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '2002-9-01' and\n           cast('2002-9-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('CA','MI','OH'\n            ,'SD' ,'TX' ,'VA')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 237 and 266\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (7, 25, 26, 52, 69)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate two WEB_SALES scans into single scan with CASE labeling for main vs EXISTS branch, enabling single-pass fact table read."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "NEUTRAL",
      "speedup": 1.03,
      "semantic_passed": true,
      "error": null,
      "original_ms": 185.4,
      "patch_ms": 180.8,
      "output_sql": "SELECT \n   COUNT(DISTINCT ws_order_number) AS \"order count\",\n   SUM(ws_ext_ship_cost) AS \"total shipping cost\",\n   SUM(ws_net_profit) AS \"total net profit\"\nFROM\n   web_sales ws1,\n   date_dim,\n   customer_address,\n   web_site\nWHERE\n    d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day'\n    AND ws1.ws_ship_date_sk = d_date_sk\n    AND ws1.ws_ship_addr_sk = ca_address_sk\n    AND ca_state IN ('CA','MI','OH','SD','TX','VA')\n    AND ws1.ws_web_site_sk = web_site_sk\n    AND web_gmt_offset >= -5\n    AND ws1.ws_list_price BETWEEN 237 AND 266\n    AND ws1.ws_ship_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day')\n                                 AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day')\n    AND EXISTS (SELECT *\n                FROM web_sales ws2\n                WHERE ws1.ws_order_number = ws2.ws_order_number\n                  AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n    AND NOT EXISTS (SELECT *\n                    FROM web_returns wr1\n                    WHERE ws1.ws_order_number = wr1.wr_order_number\n                      AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69))\nORDER BY COUNT(DISTINCT ws_order_number)\nLIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p03": "GlobalStats | 57705 | 57705 | 962010804224\n1 | 0 | Result | COUNT(DISTINCT WS1.WS_ORDER_NUMBER), SUM(WS1.WS_EXT_SHIP_COST), SUM(WS1.WS_NET_PROFIT)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [COUNT(DISTINCT WS1.WS_ORDER_NUMBER), SUM(WS1.WS_EXT_SHIP_COST), SUM(WS1.WS_NET_PROFIT)]\n1 | 3 | [2] | SemiJoin | joinKey: (WS1.WS_ORDER_NUMBER = WS2.WS_ORDER_NUMBER), joinFilter: WS1.WS_WAREHOUSE_SK <> WS2.WS_WAREHOUSE_SK\n1 | 4 | [3] | AntiJoin | joinKey: (WS1.WS_ORDER_NUMBER = W",
    "p04": "GlobalStats | 57705 | 57705 | 962010804224\n1 | 0 | Result | COUNT(DISTINCT WS1.WS_ORDER_NUMBER), SUM(WS1.WS_EXT_SHIP_COST), SUM(WS1.WS_NET_PROFIT)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [COUNT(DISTINCT WS1.WS_ORDER_NUMBER), SUM(WS1.WS_EXT_SHIP_COST), SUM(WS1.WS_NET_PROFIT)]\n1 | 3 | [2] | SemiJoin | joinKey: (WS1.WS_ORDER_NUMBER = WS2.WS_ORDER_NUMBER), joinFilter: WS1.WS_WAREHOUSE_SK <> WS2.WS_WAREHOUSE_SK\n1 | 4 | [3] | AntiJoin | joinKey: (WS1.WS_ORDER_NUMBER = W",
    "compile_p1": "GlobalStats | 57707 | 57707 | 962015081472\n1 | 0 | Result | MIN(DATE_DIM.D_DATE_SK)\n1 | 1 | [0] | Aggregate | aggExprs: [MIN(DATE_DIM.D_DATE_SK)]\n1 | 2 | [1] | Filter | (DATE_DIM.D_DATE >= '2002-09-01') AND (DATE_DIM.D_DATE <= '2002-10-31')\n1 | 3 | [2] | TableScan | SNOWFLAKE_SAMPLE_DATA.TPCDS_SF10TCL.DATE_DIM | D_DATE_SK, D_DATE | 1 | 1 | 2138624\n2 | 0 | Result | MAX(DATE_DIM.D_DATE_SK)\n2 | 1 | [0] | Aggregate | aggExprs: [MAX(DATE_DIM.D_DATE_SK)]\n2 | 2 | [1] | Filter | (DATE_DIM.D_DATE >= '200"
  }
}