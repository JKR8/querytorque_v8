{
  "probe_id": "p12",
  "transform_id": "materialize_cte",
  "family": "E",
  "dialect": "snowflake",
  "hypothesis": "The CTE customer_total_return is scanned twice due to a correlated subquery referencing it. Materializing it can prevent redundant computation and improve performance.",
  "reasoning_trace": [
    "Assigned transform targets CTE materialization to avoid double scan from main and subquery paths.",
    "The execution plan shows repeated access to the CTE via WithReference nodes (1.11 and 1.13).",
    "Node contract requires preserving all CTE columns and row semantics, which is maintained by using the same SELECT list.",
    "The materialization is implemented by adding a Snowflake-specific hint /*+ MATERIALIZE */ to the CTE definition."
  ],
  "target_ir": "customer_total_return CTE is hinted for materialization to prevent double scan; final_select remains unchanged.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "dag": {
    "order": ["customer_total_return", "final_select"],
    "final_node_id": "final_select",
    "nodes": [
      {
        "node_id": "customer_total_return",
        "deps": [],
        "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
        "changed": true,
        "sql": "with customer_total_return as (select /*+ MATERIALIZE */ sr_customer_sk as ctr_customer_sk ,sr_store_sk as ctr_store_sk ,sr_reason_sk as ctr_reason_sk ,sum(SR_RETURN_AMT_INC_TAX) as ctr_total_return from store_returns ,date_dim where sr_returned_date_sk = d_date_sk and d_year =2002 and sr_return_amt / sr_return_quantity between 108 and 167 group by sr_customer_sk ,sr_store_sk, sr_reason_sk) select * from customer_total_return"
      },
      {
        "node_id": "final_select",
        "deps": ["customer_total_return"],
        "outputs": ["c_customer_id"],
        "changed": false
      }
    ]
  }
}