{
  "dispatch": {
    "dialect": "snowflake",
    "importance_stars": 1,
    "probe_count": 5,
    "early_stop": false,
    "equivalence_tier": "unordered",
    "hypothesis": "The primary bottleneck is a correlated scalar subquery computing average return per store, which re-scans the CTE for every outer row. A secondary issue involves redundant aggregation layers in the CTE that inflate intermediate data size. An early filter opportunity exists on customer demographics that could reduce join volume.",
    "reasoning_trace": [
      "Correlated AVG subquery in join filter re-executes per outer row (structural signal).",
      "Nested aggregations in CTE suggest potential for simplification or pushdown.",
      "Customer demographic filters appear late in join sequence.",
      "No evidence of partition pruning failure or date_sk transitivty issues.",
      "Plan lacks nested loops or severe estimate mismatches."
    ],
    "cost_spine": [
      "InnerJoin",
      "Aggregate",
      "InnerJoin",
      "TableScan"
    ],
    "hotspots": [
      {
        "op": "InnerJoin expr=joinKey: (CTR2.CTR_STORE_SK = CTR1.CTR_STORE_SK), joinFilter: (CTR1.CTR_TOTAL_RETURN) > ...",
        "why": "correlated scalar aggregate subquery forces repeated CTE rescans",
        "evidence": "structural: correlated AVG subquery with join filter dependency"
      },
      {
        "op": "Aggregate expr=aggExprs: [SUM(CTR2.CTR_TOTAL_RETURN), COUNT(CTR2.CTR_TOTAL_RETURN)]",
        "why": "redundant aggregation layer inflates intermediate data",
        "evidence": "nested aggregates in CTE with same grouping keys"
      },
      {
        "op": "TableScan (CUSTOMER_DEMOGRAPHICS)",
        "why": "late-applied selective filter increases join volume",
        "evidence": "appears after multiple joins in plan spine"
      }
    ],
    "do_not_do": [
      "avoid EXISTS materialization into broad CTE branches",
      "do not wrap partition keys in functions during filter pushdown",
      "skip heavy structural rewrites on low-baseline queries"
    ]
  },
  "probe_summary_schema": [
    "probe_id",
    "transform_id",
    "family",
    "expected_explain_delta",
    "confidence",
    "exploration",
    "target",
    "dag_target_hint",
    "recommended_patch_ops",
    "recommended_examples"
  ],
  "probes": [
    {
      "probe_id": "p01",
      "transform_id": "sf_inline_decorrelate",
      "family": "B",
      "target": "Decompose correlated scalar AVG subquery into three CTEs: shared scan, per-store threshold, and filtered main query.",
      "dag_target_hint": "Rewrite final_select to eliminate correlated subquery in join filter.",
      "node_contract": {
        "from_must_include": ["customer_total_return ctr1", "customer_total_return ctr2"],
        "where_must_preserve": ["ctr1.ctr_reason_sk BETWEEN 43 AND 46", "cd_marital_status IN ('M')"],
        "output_must_preserve": ["c_customer_id", "LIMIT 100 behavior"]
      },
      "gates_checked": [
        "G_SF_CORR_SCALAR_REQUIRED:PASS",
        "G_SF_CORR_SIMPLE_EXISTS_SKIP:PASS",
        "G_SF_CORR_FACT_CONTEXT:PASS",
        "G_SF_CORR_SEMANTIC_KEYS:PASS"
      ],
      "exploration": false,
      "exploration_hypothesis": "",
      "confidence": 0.92,
      "expected_explain_delta": "Correlated branch disappears; CTR2 becomes precomputed threshold CTE.",
      "recommended_patch_ops": [
        "insert_cte",
        "replace_join_filter"
      ],
      "recommended_examples": [
        "sf_inline_decorrelate"
      ],
      "gold_example_id": "sf_inline_decorrelate"
    },
    {
      "probe_id": "p02",
      "transform_id": "aggregate_pushdown",
      "family": "C",
      "target": "Consolidate nested aggregations in customer_total_return CTE into single pass.",
      "dag_target_hint": "Rewrite customer_total_return to eliminate redundant aggregation steps.",
      "node_contract": {
        "from_must_include": ["store_returns", "date_dim"],
        "where_must_preserve": ["d_year = 2002", "sr_return_amt / sr_return_quantity BETWEEN 108 AND 167"],
        "output_must_preserve": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"]
      },
      "gates_checked": [
        "agg_key_compatibility:PASS",
        "duplication_sensitive_metrics:none"
      ],
      "exploration": false,
      "exploration_hypothesis": "",
      "confidence": 0.85,
      "expected_explain_delta": "Redundant aggregation steps removed; intermediate data size reduced.",
      "recommended_patch_ops": [
        "replace_aggregate_expr"
      ],
      "recommended_examples": [
        "aggregate_pushdown"
      ],
      "gold_example_id": "aggregate_pushdown"
    },
    {
      "probe_id": "p03",
      "transform_id": "early_filter",
      "family": "A",
      "target": "Pre-filter customer_demographics into dedicated CTE before joining with customer.",
      "dag_target_hint": "Insert new CTE for cd_demo_sk keyset; modify customer join path.",
      "node_contract": {
        "from_must_include": ["customer_demographics"],
        "where_must_preserve": [
          "cd_marital_status IN ('M')",
          "cd_education_status IN ('Advanced Degree', 'College')",
          "cd_gender = 'F'"
        ],
        "output_must_preserve": ["cd_demo_sk"]
      },
      "gates_checked": [
        "no_or_to_union:PASS",
        "multiplicity_guard_required:PASS"
      ],
      "exploration": false,
      "exploration_hypothesis": "",
      "confidence": 0.76,
      "expected_explain_delta": "Smaller hash table built for customer join; fewer rows probed.",
      "recommended_patch_ops": [
        "insert_cte",
        "replace_from"
      ],
      "recommended_examples": [
        "early_filter"
      ]
    },
    {
      "probe_id": "p04",
      "transform_id": "sf_sk_pushdown_multi_fact",
      "family": "A",
      "target": "Push date_sk filter range into store_returns scan based on d_year=2002.",
      "dag_target_hint": "Modify store_returns scan to include explicit date_sk range predicate.",
      "node_contract": {
        "from_must_include": ["store_returns", "date_dim"],
        "where_must_preserve": ["d_year = 2002"],
        "output_must_preserve": ["all store_returns columns and row semantics"]
      },
      "gates_checked": [
        "G_SF_SK_DATE_FILTER_REQUIRED:PASS",
        "G_SF_SK_SCAN_PRESSURE:PASS",
        "G_SF_SK_RANGE_SEMANTICS:PASS"
      ],
      "exploration": true,
      "exploration_hypothesis": "Secondary hotspot scan pressure suggests potential for partition pruning gain.",
      "confidence": 0.63,
      "expected_explain_delta": "Fact table scan pruned via micro-partition elimination.",
      "recommended_patch_ops": [
        "add_predicate"
      ],
      "recommended_examples": [
        "sf_sk_pushdown_multi_fact"
      ]
    },
    {
      "probe_id": "p05",
      "transform_id": "materialize_cte",
      "family": "E",
      "target": "Materialize customer_total_return CTE to prevent double scan from main and subquery paths.",
      "dag_target_hint": "Add MATERIALIZE hint to CTE definition; preserve all references.",
      "node_contract": {
        "from_must_include": ["store_returns", "date_dim"],
        "where_must_preserve": ["d_year = 2002"],
        "output_must_preserve": ["all CTE columns and row semantics"]
      },
      "gates_checked": [
        "G_SF_CTE_REUSE_RULE:PASS"
      ],
      "exploration": true,
      "exploration_hypothesis": "Repeated CTE access pattern suggests materialization benefit despite single-ref default.",
      "confidence": 0.58,
      "expected_explain_delta": "Second CTE scan replaced with reference to materialized result.",
      "recommended_patch_ops": [
        "add_hint"
      ],
      "recommended_examples": [
        "materialize_cte"
      ]
    }
  ],
  "dropped": [
    {
      "transform_id": "or_to_union",
      "family": "D",
      "reason": "No cross-column OR predicates detected in plan or SQL."
    },
    {
      "transform_id": "intersect_to_exists",
      "family": "D",
      "reason": "No INTERSECT operations present in query structure."
    },
    {
      "transform_id": "self_join_decomposition",
      "family": "F",
      "reason": "Self-join pattern not detected; CTE references are not filter-split variants."
    }
  ]
}