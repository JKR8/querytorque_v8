{
  "probe_id": "shared_dimension_multi_channel",
  "transform_id": "shared_dimension_multi_channel",
  "family": "A",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Creating shared filtered CTEs for date_dim and item reduces redundant scans across UNION branches while preserving all output semantics.",
  "reasoning_trace": [
    "Assigned transform targets shared dimension filtering across channels.",
    "Three UNION branches scan date_dim and item with identical filters.",
    "Shared CTEs for filtered date_dim and item can be referenced in each branch.",
    "All join conditions and WHERE clauses are preserved in rewritten branches."
  ],
  "target_ir": "Add two new CTEs: filtered_date_dim and filtered_item. Replace inline scans in UNION branches with references to these CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["all_sales"],
        "outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"],
        "changed": false
      },
      {
        "node_id": "all_sales",
        "parent_node_id": "final_select",
        "sources": ["filtered_date_dim", "filtered_item", "catalog_sales", "catalog_returns", "store_sales", "store_returns", "web_sales", "web_returns"],
        "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
        "changed": true,
        "sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk, d_year\n  FROM date_dim\n  WHERE d_year IN (1998, 1999)\n),\nfiltered_item AS (\n  SELECT i_item_sk, i_brand_id, i_class_id, i_category_id, i_manufact_id\n  FROM item\n  WHERE i_category = 'Home'\n),\nsales_detail AS (\n  SELECT d_year,\n         i_brand_id,\n         i_class_id,\n         i_category_id,\n         i_manufact_id,\n         cs_quantity - COALESCE(cr_return_quantity, 0) AS sales_cnt,\n         cs_ext_sales_price - COALESCE(cr_return_amount, 0.0) AS sales_amt\n  FROM catalog_sales\n  JOIN filtered_item ON i_item_sk = cs_item_sk\n  JOIN filtered_date_dim ON d_date_sk = cs_sold_date_sk\n  LEFT JOIN catalog_returns ON (cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk)\n  WHERE cs_sales_price / cs_list_price BETWEEN 34 * 0.01 AND 54 * 0.01\n    AND cr_reason_sk IN (7, 25, 26, 52, 69)\n  UNION ALL\n  SELECT d_year,\n         i_brand_id,\n         i_class_id,\n         i_category_id,\n         i_manufact_id,\n         ss_quantity - COALESCE(sr_return_quantity, 0) AS sales_cnt,\n         ss_ext_sales_price - COALESCE(sr_return_amt, 0.0) AS sales_amt\n  FROM store_sales\n  JOIN filtered_item ON i_item_sk = ss_item_sk\n  JOIN filtered_date_dim ON d_date_sk = ss_sold_date_sk\n  LEFT JOIN store_returns ON (ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk)\n  WHERE ss_sales_price / ss_list_price BETWEEN 34 * 0.01 AND 54 * 0.01\n    AND sr_reason_sk IN (7, 25, 26, 52, 69)\n  UNION ALL\n  SELECT d_year,\n         i_brand_id,\n         i_class_id,\n         i_category_id,\n         i_manufact_id,\n         ws_quantity - COALESCE(wr_return_quantity, 0) AS sales_cnt,\n         ws_ext_sales_price - COALESCE(wr_return_amt, 0.0) AS sales_amt\n  FROM web_sales\n  JOIN filtered_item ON i_item_sk = ws_item_sk\n  JOIN filtered_date_dim ON d_date_sk = ws_sold_date_sk\n  LEFT JOIN web_returns ON (ws_order_number = wr_order_number AND ws_item_sk = wr_item_sk)\n  WHERE ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 54 * 0.01\n    AND wr_reason_sk IN (7, 25, 26, 52, 69)\n)\nSELECT d_year,\n       i_brand_id,\n       i_class_id,\n       i_category_id,\n       i_manufact_id,\n       SUM(sales_cnt) AS sales_cnt,\n       SUM(sales_amt) AS sales_amt\nFROM sales_detail\nGROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id"
      },
      {
        "node_id": "filtered_date_dim",
        "parent_node_id": "all_sales",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year"],
        "changed": false
      },
      {
        "node_id": "filtered_item",
        "parent_node_id": "all_sales",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id"],
        "changed": false
      }
    ]
  }
}