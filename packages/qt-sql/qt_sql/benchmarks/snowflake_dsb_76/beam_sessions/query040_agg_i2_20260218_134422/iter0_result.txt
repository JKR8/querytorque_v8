{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 4,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p07",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.45,
      "status": "REGRESSION",
      "speedup": 0.57,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.3,
      "patch_ms": 275.0,
      "output_sql": "WITH date_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), main_query AS (SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs INNER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk INNER JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk INNER JOIN item i ON cs.cs_item_sk = i.i_item_sk INNER JOIN date_filtered df ON cs.cs_sold_date_sk = df.d_date_sk WHERE i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND cs.cs_wholesale_cost BETWEEN 68 AND 87 AND cr.cr_reason_sk = 40 GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-20' as date) - interval '30 day')\n                and (cast ('2002-02-20' as date) + interval '30 day') \n and i_category  = 'Shoes'\n and i_manager_id between 42 and 81\n and cs_wholesale_cost between 68 and 87\n and cr_reason_sk = 40\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated joins to explicit JOIN syntax and isolate date_dim filter into a CTE to create a small hash table for date_sk join."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: 001100 (42601): 01c27cce-3205-67d4-0002-fcfe000263f6: SQL compilation error:\n'CATALOG_SALES' is an invalid Recursive CTE",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_item AS (select i_item_sk, i_item_id, i_category, i_manager_id from item where i_category = 'Shoes' and i_manager_id between 42 and 81), filtered_date_dim AS (select d_date_sk, d_date from date_dim where d_date between '2002-01-21' and '2002-03-22'), filtered_warehouse AS (select w_warehouse_sk, w_state from warehouse), catalog_sales AS (select cs_sold_date_sk, cs_warehouse_sk, cs_item_sk, cs_order_number, cs_wholesale_cost, cs_sales_price from catalog_sales), catalog_returns AS (select cr_item_sk, cr_reason_sk, cr_order_number, cr_refunded_cash from catalog_returns where cr_reason_sk = 40) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,filtered_warehouse\n  ,filtered_item\n  ,filtered_date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-20' as date) - interval '30 day')\n                and (cast ('2002-02-20' as date) + interval '30 day') \n and i_category  = 'Shoes'\n and i_manager_id between 42 and 81\n and cs_wholesale_cost between 68 and 87\n and cr_reason_sk = 40 \n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter dimension tables (item, date_dim, warehouse) into CTEs before joining with catalog_sales to reduce probe side of join."
    },
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `catalog_sales`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create CTEs for filtered item, date_dim, and warehouse, then join them together before joining with catalog_sales to create a small composite dimension keyset."
    },
    {
      "patch_id": "p06",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.5,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH keyset AS (SELECT i.i_item_sk, d.d_date_sk, w.w_warehouse_sk FROM item i, date_dim d, warehouse w WHERE i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND d.d_date BETWEEN '2002-01-21'::DATE AND '2002-03-22'::DATE), joined_facts AS (SELECT k.i_item_sk, k.d_date_sk, k.w_warehouse_sk, cs.cs_sales_price, cr.cr_refunded_cash FROM keyset k JOIN catalog_sales cs ON k.i_item_sk = cs.cs_item_sk AND k.d_date_sk = cs.cs_sold_date_sk AND k.w_warehouse_sk = cs.cs_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk AND cr.cr_reason_sk = 40 WHERE cs.cs_wholesale_cost BETWEEN 68 AND 87), aggregated_result AS (SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (d.d_date < '2002-02-20'::DATE) THEN j.cs_sales_price - COALESCE(j.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (d.d_date >= '2002-02-20'::DATE) THEN j.cs_sales_price - COALESCE(j.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM joined_facts j JOIN item i ON j.i_item_sk = i.i_item_sk JOIN date_dim d ON j.d_date_sk = d.d_date_sk JOIN warehouse w ON j.w_warehouse_sk = w.w_warehouse_sk GROUP BY w.w_state, i.i_item_id) SELECT w_state, i_item_id, sales_before, sales_after FROM aggregated_result ORDER BY w_state, i_item_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Build a CTE chain: filter item, date_dim, warehouse; join them into a keyset; then join keyset with catalog_sales and catalog_returns."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.53,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.3,
      "patch_ms": 296.2,
      "output_sql": "WITH preagg_sales_returns AS (SELECT cs.cs_item_sk, cs.cs_sold_date_sk, cs.cs_warehouse_sk, cr.cr_reason_sk, SUM(cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0)) AS net_sales FROM catalog_sales cs LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cs.cs_wholesale_cost BETWEEN 68 AND 87 GROUP BY cs.cs_item_sk, cs.cs_sold_date_sk, cs.cs_warehouse_sk, cr.cr_reason_sk), joined_dims_and_preagg AS (SELECT w.w_state, i.i_item_id, d.d_date, preagg.net_sales FROM preagg_sales_returns preagg JOIN item i ON preagg.cs_item_sk = i.i_item_sk JOIN date_dim d ON preagg.cs_sold_date_sk = d.d_date_sk JOIN warehouse w ON preagg.cs_warehouse_sk = w.w_warehouse_sk WHERE i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND d.d_date BETWEEN '2002-01-21' AND '2002-03-22' AND preagg.cr_reason_sk = 40), final_aggregation AS (SELECT w_state, i_item_id, SUM(CASE WHEN d_date < '2002-02-20' THEN net_sales ELSE 0 END) AS sales_before, SUM(CASE WHEN d_date >= '2002-02-20' THEN net_sales ELSE 0 END) AS sales_after FROM joined_dims_and_preagg GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100) select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-20' as date) - interval '30 day')\n                and (cast ('2002-02-20' as date) + interval '30 day') \n and i_category  = 'Shoes'\n and i_manager_id between 42 and 81\n and cs_wholesale_cost between 68 and 87\n and cr_reason_sk = 40\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate catalog_sales and catalog_returns by (cs_item_sk, cs_sold_date_sk, cs_warehouse_sk) before joining with item and date_dim, then join dimensions and aggregate by w_state and i_item_id."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `warehouse`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Convert LEFT JOIN catalog_returns to INNER JOIN because WHERE cr_reason_sk=40 eliminates NULL rows, preserving semantics and potentially improving join order."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "sf_sk_pushdown_multi_fact",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.55,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.3,
      "patch_ms": 282.2,
      "output_sql": "select \n   w_state\n  ,i_item_id\n  ,sum(case when (cast(d_date as date) < cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_before\n  ,sum(case when (cast(d_date as date) >= cast ('2002-02-20' as date))\n \t\tthen cs_sales_price - coalesce(cr_refunded_cash,0) else 0 end) as sales_after\n from\n   catalog_sales left outer join catalog_returns on\n       (cs_order_number = cr_order_number\n        and cs_item_sk = cr_item_sk)\n  ,warehouse\n  ,item\n  ,date_dim\n where\n i_item_sk          = cs_item_sk\n and cs_warehouse_sk    = w_warehouse_sk\n and cs_sold_date_sk    = d_date_sk\n and d_date between  (cast ('2002-02-20' as date) - interval '30 day')\n                and (cast ('2002-02-20' as date) + interval '30 day') \n and i_category  = 'Shoes'\n and i_manager_id between 42 and 81\n and cs_wholesale_cost between 68 and 87\n and cr_reason_sk = 40\n group by\n    w_state,i_item_id\n order by w_state,i_item_id\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push date_sk BETWEEN derived from date_dim filter into CATALOG_SALES and CATALOG_RETURNS scans via explicit join syntax to enable micro-partition pruning."
    },
    {
      "patch_id": "p08",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.45,
      "status": "REGRESSION",
      "speedup": 0.57,
      "semantic_passed": true,
      "error": null,
      "original_ms": 156.3,
      "patch_ms": 273.5,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk, i_item_id, i_category, i_manager_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81), filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse), filtered_catalog_data AS (SELECT cs_sold_date_sk, cs_warehouse_sk, cs_item_sk, cs_order_number, cs_wholesale_cost, cs_sales_price FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87) SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_data cs LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk, filtered_warehouse w, filtered_item i, filtered_date_dim d WHERE i.i_item_sk = cs.cs_item_sk AND cs.cs_warehouse_sk = w.w_warehouse_sk AND cs.cs_sold_date_sk = d.d_date_sk AND d.d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day') AND i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND cs.cs_wholesale_cost BETWEEN 68 AND 87 AND cr.cr_reason_sk = 40 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Isolate each dimension table (item, date_dim, warehouse) into separate CTEs with filters applied, then join with fact tables."
    }
  ],
  "explains": {
    "p07": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p03": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p01": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CATALOG_RETURNS.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | ",
    "p08": "GlobalStats | 59685 | 59484 | 1002742855168\n1 | 0 | Result | WAREHOUSE.W_STATE, ITEM.I_ITEM_ID, SUM(CASE_FLATTENED((DATE_DIM.D_DATE) < '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CR.CR_REFUNDED_CASH, 0)), 0)), SUM(CASE_FLATTENED((DATE_DIM.D_DATE) >= '2002-02-20', (CATALOG_SALES.CS_SALES_PRICE) - (IFNULL(CR.CR_REFUNDED_CASH, 0)), 0))\n1 | 1 | [0] | SortWithLimit | sortKey: [WAREHOUSE.W_STATE ASC NULLS LAST, ITEM.I_ITEM_ID ASC NULLS LAST], rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs"
  }
}