[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "sf_inline_decorrelate",
    "hypothesis": "Winning probe p01 decorrelates the correlated scalar subquery by sharing the fact table scan via CTE, eliminating repeated I/O on catalog_sales. This addresses the primary hotspot (1.8TB repeated scan) with proven 1.06x speedup.",
    "expected_explain_delta": "Correlated subquery loop removed; single scan of catalog_sales with date and item filters, followed by aggregate and join.",
    "target_ir": "Add shared_scan_cs and threshold_per_item CTE nodes, update final_select to join them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["shared_scan_cs", "threshold_per_item"],
          "outputs": ["excess discount amount"],
          "changed": true,
          "sql": "SELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\" FROM shared_scan_cs cs JOIN threshold_per_item t ON cs.cs_item_sk = t.cs_item_sk WHERE cs.cs_ext_discount_amt > t.threshold ORDER BY SUM(cs.cs_ext_discount_amt) LIMIT 100"
        },
        {
          "node_id": "shared_scan_cs",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_dim", "item"],
          "outputs": ["cs_item_sk", "cs_sold_date_sk", "cs_ext_discount_amt", "cs_list_price", "cs_sales_price"],
          "changed": true,
          "sql": "SELECT cs.cs_item_sk, cs.cs_sold_date_sk, cs.cs_ext_discount_amt, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE d.d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100)"
        },
        {
          "node_id": "threshold_per_item",
          "parent_node_id": "final_select",
          "sources": ["shared_scan_cs"],
          "outputs": ["cs_item_sk", "threshold"],
          "changed": true,
          "sql": "SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM shared_scan_cs WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43 GROUP BY cs_item_sk"
        }
      ]
    }
  }
]