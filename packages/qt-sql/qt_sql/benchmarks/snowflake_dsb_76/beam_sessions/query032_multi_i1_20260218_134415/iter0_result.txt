{
  "iteration": 0,
  "n_api_calls": 1,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 1.11,
  "best_patch_id": "p01",
  "best_sql": "WITH shared_scan_cs AS (\n  SELECT cs_item_sk, cs_sold_date_sk, cs_ext_discount_amt, cs_list_price, cs_sales_price\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  JOIN item ON cs_item_sk = i_item_sk\n  WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'\n    AND (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100)\n), threshold_per_item AS (\n  SELECT cs_item_sk,\n         1.3 * AVG(cs_ext_discount_amt) AS threshold\n  FROM shared_scan_cs\n  WHERE cs_list_price BETWEEN 108 AND 137\n    AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43\n  GROUP BY cs_item_sk\n)\nSELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\"\nFROM shared_scan_cs cs\nJOIN threshold_per_item t ON cs.cs_item_sk = t.cs_item_sk\nWHERE cs.cs_ext_discount_amt > t.threshold\nORDER BY SUM(cs.cs_ext_discount_amt)\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "sf_inline_decorrelate",
      "relevance_score": 0.9,
      "status": "WIN",
      "speedup": 1.11,
      "semantic_passed": true,
      "error": null,
      "original_ms": 168.4,
      "patch_ms": 151.3,
      "output_sql": "WITH shared_scan_cs AS (\n  SELECT cs_item_sk, cs_sold_date_sk, cs_ext_discount_amt, cs_list_price, cs_sales_price\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  JOIN item ON cs_item_sk = i_item_sk\n  WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'\n    AND (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100)\n), threshold_per_item AS (\n  SELECT cs_item_sk,\n         1.3 * AVG(cs_ext_discount_amt) AS threshold\n  FROM shared_scan_cs\n  WHERE cs_list_price BETWEEN 108 AND 137\n    AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43\n  GROUP BY cs_item_sk\n)\nSELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\"\nFROM shared_scan_cs cs\nJOIN threshold_per_item t ON cs.cs_item_sk = t.cs_item_sk\nWHERE cs.cs_ext_discount_amt > t.threshold\nORDER BY SUM(cs.cs_ext_discount_amt)\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Decompose correlated scalar subquery into 3 CTEs: shared scan of catalog_sales with date and item filters, per-key threshold CTE computing 1.3 * avg(cs_ext_discount_amt), and main query joining with threshold CTE to filter cs_ext_discount_amt > threshold."
    },
    {
      "patch_id": "p04",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 168.4,
      "patch_ms": 191.2,
      "output_sql": "WITH single_pass_agg AS (SELECT cs_ext_discount_amt, 1.3 * AVG(CASE WHEN cs_list_price BETWEEN 108 AND 137 AND (cs_sales_price / cs_list_price) BETWEEN 0.23 AND 0.43 THEN cs_ext_discount_amt END) OVER (PARTITION BY cs_item_sk) AS threshold FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100) AND d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day') SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM single_pass_agg WHERE cs_ext_discount_amt > threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate main query and subquery scans into a single CTE that computes both the sum for filtering and the average threshold in one pass using conditional aggregates (e.g., CASE expressions)."
    },
    {
      "patch_id": "p02",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `date_dim`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Split OR condition on ITEM into UNION ALL branches: one branch for i_manufact_id IN (47, 226, 612, 676, 818) and another for i_manager_id BETWEEN 71 and 100, ensuring join compatibility with catalog_sales."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.5,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 168.4,
      "patch_ms": 190.8,
      "output_sql": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales INNER JOIN item ON i_item_sk = cs_item_sk INNER JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100) AND d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND cs_ext_discount_amt > (SELECT 1.3 * AVG(cs_ext_discount_amt) FROM catalog_sales, date_dim WHERE cs_item_sk = i_item_sk AND d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND d_date_sk = cs_sold_date_sk AND cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01) ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated joins to explicit INNER JOIN syntax with ON clauses: FROM catalog_sales INNER JOIN item ON i_item_sk = cs_item_sk INNER JOIN date_dim ON d_date_sk = cs_sold_date_sk."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.85,
      "semantic_passed": true,
      "error": null,
      "original_ms": 158.6,
      "patch_ms": 187.6,
      "output_sql": "WITH shared_scan_cs AS (SELECT cs.cs_item_sk, cs.cs_sold_date_sk, cs.cs_ext_discount_amt, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE d.d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100)), threshold_per_item AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM shared_scan_cs WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43 GROUP BY cs_item_sk) SELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\" FROM shared_scan_cs cs JOIN threshold_per_item t ON cs.cs_item_sk = t.cs_item_sk WHERE cs.cs_ext_discount_amt > t.threshold ORDER BY SUM(cs.cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.89,
      "semantic_passed": true,
      "error": null,
      "original_ms": 158.6,
      "patch_ms": 178.8,
      "output_sql": "WITH single_pass_agg AS (SELECT cs_ext_discount_amt, 1.3 * AVG(CASE WHEN cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43 THEN cs_ext_discount_amt END) OVER (PARTITION BY cs_item_sk) AS threshold FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100) AND d.d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day') SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM single_pass_agg WHERE cs_ext_discount_amt > threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.75,
      "semantic_passed": true,
      "error": null,
      "original_ms": 158.6,
      "patch_ms": 212.3,
      "output_sql": "WITH shared_scan_cs AS (SELECT cs.cs_item_sk, cs.cs_sold_date_sk, cs.cs_ext_discount_amt, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE d.d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100)), threshold_per_item AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM shared_scan_cs WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43 GROUP BY cs_item_sk) SELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\" FROM shared_scan_cs cs JOIN threshold_per_item t ON cs.cs_item_sk = t.cs_item_sk WHERE cs.cs_ext_discount_amt > t.threshold ORDER BY SUM(cs.cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "GlobalStats | 54925 | 54925 | 923643425792\n1 | 0 | Result | SUM(SUM(SUM(CS.CS_EXT_DISCOUNT_AMT)))\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(CS.CS_EXT_DISCOUNT_AMT)))]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(CS.CS_EXT_DISCOUNT_AMT))]\n1 | 4 | [3] | InnerJoin | joinKey: (SHARED_SCAN_CS.CS_ITEM_SK = CS.CS_ITEM_SK), joinFilter: (CS.CS_EXT_DISCOUNT_AMT) > (1.3 * ((SUM(SHARED_SCAN_CS.CS_EXT_DISCOUNT_AMT)) / (COUNT(SHARED_SCAN_CS.CS_EXT_DISCOUNT_AMT))))\n1 ",
    "p04": "GlobalStats | 54925 | 54925 | 923643425792\n1 | 0 | Result | SUM(CATALOG_SALES.CS_EXT_DISCOUNT_AMT)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(CATALOG_SALES.CS_EXT_DISCOUNT_AMT)]\n1 | 3 | [2] | Filter | (CATALOG_SALES.CS_EXT_DISCOUNT_AMT) > (1.3 * AVG(CASE_FLATTENED(((CATALOG_SALES.CS_LIST_PRICE >= 108) AND (CATALOG_SALES.CS_LIST_PRICE <= 137)) AND ((((CATALOG_SALES.CS_SALES_PRICE) / (CATALOG_SALES.CS_LIST_PRICE)) >= 0.23) AND (((CATALOG_SALES.CS_SALES_PRICE) / (C",
    "p03": "GlobalStats | 109848 | 109848 | 1847263040000\n1 | 0 | Result | SUM(CATALOG_SALES.CS_EXT_DISCOUNT_AMT)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(CATALOG_SALES.CS_EXT_DISCOUNT_AMT)]\n1 | 3 | [2] | Filter | (CATALOG_SALES.CS_EXT_DISCOUNT_AMT) > (1.3 * ((SUM(SUM_INTERNAL(SUM(CATALOG_SALES.CS_EXT_DISCOUNT_AMT), COUNT(*)))) / (NVL(COUNT(COUNT_INTERNAL(COUNT(CATALOG_SALES.CS_EXT_DISCOUNT_AMT), COUNT(*))), 0))))\n1 | 4 | [3] | Aggregate | aggExprs: [SUM(SUM_INTERNAL(SUM(",
    "compile_p1": "GlobalStats | 54925 | 54925 | 923643425792\n1 | 0 | Result | SUM(SUM(SUM(CS.CS_EXT_DISCOUNT_AMT)))\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(SUM(SUM(CS.CS_EXT_DISCOUNT_AMT)))]\n1 | 3 | [2] | Aggregate | aggExprs: [SUM(SUM(CS.CS_EXT_DISCOUNT_AMT))]\n1 | 4 | [3] | InnerJoin | joinKey: (SHARED_SCAN_CS.CS_ITEM_SK = CS.CS_ITEM_SK), joinFilter: (CS.CS_EXT_DISCOUNT_AMT) > (1.3 * ((SUM(SHARED_SCAN_CS.CS_EXT_DISCOUNT_AMT)) / (COUNT(SHARED_SCAN_CS.CS_EXT_DISCOUNT_AMT))))\n1 ",
    "compile_p2": "GlobalStats | 54925 | 54925 | 923643425792\n1 | 0 | Result | SUM(CS.CS_EXT_DISCOUNT_AMT)\n1 | 1 | [0] | Limit | rowCount: 100\n1 | 2 | [1] | Aggregate | aggExprs: [SUM(CS.CS_EXT_DISCOUNT_AMT)]\n1 | 3 | [2] | Filter | (CS.CS_EXT_DISCOUNT_AMT) > (1.3 * AVG(CASE_FLATTENED(((CS.CS_LIST_PRICE >= 108) AND (CS.CS_LIST_PRICE <= 137)) AND ((((CS.CS_SALES_PRICE) / (CS.CS_LIST_PRICE)) >= 0.23) AND (((CS.CS_SALES_PRICE) / (CS.CS_LIST_PRICE)) <= 0.43)), CS.CS_EXT_DISCOUNT_AMT, null)) OVER (PARTITION BY CS.CS_ITE"
  }
}