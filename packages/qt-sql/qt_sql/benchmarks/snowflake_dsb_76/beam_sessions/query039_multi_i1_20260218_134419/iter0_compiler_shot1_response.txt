```json
[
  {
    "plan_id": "compile_p1",
    "dialect": "snowflake",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Self-join decomposition with explicit date_sk range pushdown per month to prune inventory scan and avoid full-year aggregation.",
    "hypothesis": "Splitting the CTE by month reduces aggregation work and intermediate result size, while date_sk range pushdown prunes inventory micro-partitions for each month. Proven by p01 (1.07x) and p02 (1.32x).",
    "expected_explain_delta": "Reduced inventory scan and aggregation operators for non-relevant months removed; join order may change.",
    "target_ir": "Replace single inv CTE with two month‑specific CTEs (inv_2, inv_3), each with date_sk range pushdown; update final_select to join them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "inv_2",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM ( SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND d_moy = 2 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND inv_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy=2) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy=2) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy ) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "inv_3",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM ( SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND d_moy = 3 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND inv_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy=3) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy=3) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy ) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv_2", "inv_3"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": true,
          "sql": "SELECT inv_2.w_warehouse_sk, inv_2.i_item_sk, inv_2.d_moy, inv_2.mean, inv_2.cov, inv_3.w_warehouse_sk, inv_3.i_item_sk, inv_3.d_moy, inv_3.mean, inv_3.cov FROM inv_2, inv_3 WHERE inv_2.i_item_sk = inv_3.i_item_sk AND inv_2.w_warehouse_sk = inv_3.w_warehouse_sk ORDER BY inv_2.w_warehouse_sk, inv_2.i_item_sk, inv_2.d_moy, inv_2.mean, inv_2.cov, inv_3.d_moy, inv_3.mean, inv_3.cov"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "snowflake",
    "confidence": 0.80,
    "based_on": "p02",
    "strategy": "Push date_sk range derived from date_dim filter into inventory scan to enable micro‑partition pruning.",
    "hypothesis": "Explicit date_sk range condition allows Snowflake to prune micro‑partitions in the inventory table, reducing I/O. Proven by p02 (1.32x).",
    "expected_explain_delta": "Reduced inventory scan bytes and partitions.",
    "target_ir": "Add inv_date_sk BETWEEN subquery to inv CTE; final_select unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "inv",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM ( SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND inv_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy IN (2,3)) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year=2002 AND d_moy IN (2,3)) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy ) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p3",
    "dialect": "snowflake",
    "confidence": 0.70,
    "based_on": "p01",
    "strategy": "Split the CTE into two separate CTEs for months 2 and 3, eliminating full‑year aggregation and reducing intermediate result size.",
    "hypothesis": "Aggregating only the required months reduces compute and intermediate data, improving self‑join performance. Proven by p01 (1.07x).",
    "expected_explain_delta": "Aggregation operators only for months 2 and 3, smaller intermediate CTE.",
    "target_ir": "Replace single inv CTE with two month‑specific CTEs (inv_2, inv_3); update final_select to join them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "inv_2",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM ( SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND d_moy = 2 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy ) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "inv_3",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM ( SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND d_moy = 3 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy ) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv_2", "inv_3"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": true,
          "sql": "SELECT inv_2.w_warehouse_sk, inv_2.i_item_sk, inv_2.d_moy, inv_2.mean, inv_2.cov, inv_3.w_warehouse_sk, inv_3.i_item_sk, inv_3.d_moy, inv_3.mean, inv_3.cov FROM inv_2, inv_3 WHERE inv_2.i_item_sk = inv_3.i_item_sk AND inv_2.w_warehouse_sk = inv_3.w_warehouse_sk ORDER BY inv_2.w_warehouse_sk, inv_2.i_item_sk, inv_2.d_moy, inv_2.mean, inv_2.cov, inv_3.d_moy, inv_3.mean, inv_3.cov"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p4",
    "dialect": "snowflake",
    "confidence": 0.75,
    "based_on": "p03,p02",
    "strategy": "Isolate dimension filters into separate CTEs and push date_sk range to inventory scan.",
    "hypothesis": "Pre‑filtering dimensions improves join planning, and date_sk range pushdown prunes inventory micro‑partitions. Proven by p03 (1.14x) and p02 (1.32x).",
    "expected_explain_delta": "Reduced dimension table scans and inventory scan pruning.",
    "target_ir": "Add dimension‑filtering CTEs and date_sk range pushdown to inv CTE; final_select unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "inv",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "WITH item_filtered AS ( SELECT i_item_sk FROM item WHERE i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 ), warehouse_filtered AS ( SELECT w_warehouse_sk, w_warehouse_name FROM warehouse ), date_dim_filtered AS ( SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002 AND d_moy IN (2,3) ) SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy, STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev, AVG(inv.inv_quantity_on_hand) AS mean, CASE WHEN AVG(inv.inv_quantity_on_hand) = 0 THEN NULL ELSE STDDEV_SAMP(inv.inv_quantity_on_hand)/AVG(inv.inv_quantity_on_hand) END AS cov FROM inventory inv JOIN item_filtered i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse_filtered w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim_filtered d ON inv.inv_date_sk = d.d_date_sk WHERE inv.inv_quantity_on_hand BETWEEN 0 AND 200 AND inv.inv_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim_filtered) AND (SELECT MAX(d_date_sk) FROM date_dim_filtered) GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy HAVING CASE WHEN AVG(inv.inv_quantity_on_hand) = 0 THEN 0 ELSE STDDEV_SAMP(inv.inv_quantity_on_hand)/AVG(inv.inv_quantity_on_hand) END > 1"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": false
        }
      ]
    }
  }
]
```