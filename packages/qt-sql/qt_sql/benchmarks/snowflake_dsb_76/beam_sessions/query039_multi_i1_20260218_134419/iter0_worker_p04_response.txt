{
  "probe_id": "scout_1",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Pre-aggregating inventory by inv_item_sk, inv_warehouse_sk, and inv_date_sk before joining with dimensions reduces data volume entering joins and preserves final aggregate semantics.",
  "reasoning_trace": [
    "Assigned transform targets pushing partial aggregation below joins to reduce row count.",
    "Inventory is scanned at 3.6GB scale; early aggregation can significantly reduce intermediate size.",
    "Group keys (inv_item_sk, inv_warehouse_sk, inv_date_sk) align with downstream join keys enabling safe pushdown.",
    "Final statistics (stdev, mean) are recomposed correctly from partial aggregates."
  ],
  "target_ir": "Insert new CTE 'inv_agg' that pre-aggregates inventory; modify 'inv' to join with dimensions post-aggregation.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["inv", "inv"],
        "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
        "changed": false
      },
      {
        "node_id": "inv",
        "parent_node_id": "final_select",
        "sources": ["inv_agg", "item", "warehouse", "date_dim"],
        "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
        "changed": true,
        "sql": "SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n       SQRT((agg.sum_sq - (agg.sum_qty * agg.sum_qty) / agg.cnt)) AS stdev,\n       agg.sum_qty / agg.cnt AS mean,\n       CASE WHEN agg.sum_qty = 0 THEN NULL ELSE SQRT((agg.sum_sq - (agg.sum_qty * agg.sum_qty) / agg.cnt)) / (agg.sum_qty / agg.cnt) END AS cov\nFROM inv_agg agg\nJOIN item i ON agg.inv_item_sk = i.i_item_sk\nJOIN warehouse w ON agg.inv_warehouse_sk = w.w_warehouse_sk\nJOIN date_dim d ON agg.inv_date_sk = d.d_date_sk\nWHERE d.d_year = 2002\n  AND i_category IN ('Jewelry', 'Men')\n  AND i_manager_id BETWEEN 81 AND 100\n  AND agg.sum_qty / agg.cnt BETWEEN 0 AND 200"
      },
      {
        "node_id": "inv_agg",
        "parent_node_id": "inv",
        "sources": ["inventory"],
        "outputs": ["inv_item_sk", "inv_warehouse_sk", "inv_date_sk", "sum_qty", "sum_sq", "cnt"],
        "changed": true,
        "sql": "SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk,\n       SUM(inv_quantity_on_hand) AS sum_qty,\n       SUM(POWER(inv_quantity_on_hand, 2)) AS sum_sq,\n       COUNT(*) AS cnt\nFROM inventory\nWHERE inv_quantity_on_hand BETWEEN 0 AND 200\nGROUP BY inv_item_sk, inv_warehouse_sk, inv_date_sk"
      }
    ]
  }
}