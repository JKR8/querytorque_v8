{
  "probe_id": "scout_001",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "snowflake",
  "hypothesis": "Materializing filtered and aggregated catalog_sales as a CTE reduces repeated scan and aggregation overhead while preserving final output semantics.",
  "reasoning_trace": [
    "Assigned hotspot is catalog_sales scan (1.37) with 920GB volume and no early filtering.",
    "Date filter on d3 (d3.d_moy between 3 and 5, d3.d_year = 1999) can be pushed into catalog_sales scan via CTE.",
    "Pre-aggregation in CTE aligns with existing aggregate node (1.34) and avoids recomputation."
  ],
  "target_ir": "catalog_sales becomes a filtered and pre-aggregated CTE; main query references CTE instead of raw table.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["main_query"],
        "outputs": ["i_item_id", "i_item_desc", "s_store_id", "s_store_name", "store_sales_profit", "store_returns_loss", "catalog_sales_profit"],
        "changed": false
      },
      {
        "node_id": "main_query",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales_materialized", "store_sales", "store_returns", "date_dim d1", "date_dim d2", "date_dim d3", "store", "item"],
        "outputs": ["i_item_id", "i_item_desc", "s_store_id", "s_store_name", "store_sales_profit", "store_returns_loss", "catalog_sales_profit"],
        "changed": true,
        "sql": "select \n i_item_id\n ,i_item_desc\n ,s_store_id\n ,s_store_name\n ,max(ss_net_profit) as store_sales_profit\n ,max(sr_net_loss) as store_returns_loss\n ,max(cs_net_profit) as catalog_sales_profit\n from\n store_sales\n ,store_returns\n ,catalog_sales_materialized cs\n ,date_dim d1\n ,date_dim d2\n ,date_dim d3\n ,store\n ,item\n where\n d1.d_moy = 3\n and d1.d_year = 1999\n and d1.d_date_sk = ss_sold_date_sk\n and i_item_sk = ss_item_sk\n and s_store_sk = ss_store_sk\n and ss_customer_sk = sr_customer_sk\n and ss_item_sk = sr_item_sk\n and ss_ticket_number = sr_ticket_number\n and sr_returned_date_sk = d2.d_date_sk\n and d2.d_moy               between 3 and  3 + 2\n and d2.d_year              = 1999\n and sr_customer_sk = cs.cs_bill_customer_sk\n and sr_item_sk = cs.cs_item_sk\n and cs.cs_sold_date_sk = d3.d_date_sk\n and d3.d_moy               between 3 and  3 + 2\n and d3.d_year              = 1999\n group by\n i_item_id\n ,i_item_desc\n ,s_store_id\n ,s_store_name\n order by\n i_item_id\n ,i_item_desc\n ,s_store_id\n ,s_store_name\n limit 100"
      },
      {
        "node_id": "catalog_sales_materialized",
        "parent_node_id": null,
        "sources": ["catalog_sales", "date_dim"],
        "outputs": ["cs_bill_customer_sk", "cs_item_sk", "cs_sold_date_sk", "cs_net_profit"],
        "changed": true,
        "sql": "select cs_bill_customer_sk, cs_item_sk, cs_sold_date_sk, cs_net_profit from catalog_sales cs join date_dim d on cs.cs_sold_date_sk = d.d_date_sk where d.d_moy between 3 and 5 and d.d_year = 1999"
      }
    ]
  }
}