### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] ctr_all  [~]  (renamed from customer_total_return; added explicit JOIN)
│   ├── SCAN (store_returns, date_dim (explicit JOIN))
│   ├── JOIN (sr_returned_date_sk = d_date_sk) [explicit syntax]
│   ├── FILTER (d_year = 2000) [=]
│   ├── AGG (GROUP BY sr_customer_sk, sr_store_sk) [=]
│   └── OUTPUT (ctr_customer_sk, ctr_store_sk, ctr_total_return) [=]
├── [CTE] store_avg  [+]  (new CTE for precomputed store averages)
│   ├── SCAN (ctr_all)
│   ├── AGG (GROUP BY ctr_store_sk)
│   └── OUTPUT (ctr_store_sk, avg_return)
└── [MAIN] main_query  [~]  (correlated subquery → explicit JOIN)
    ├── SCAN (ctr_all AS ctr1, store, customer, store_avg) [added store_avg]
    ├── JOIN (s_store_sk = ctr1.ctr_store_sk) [explicit]
    ├── JOIN (ctr1.ctr_customer_sk = c_customer_sk) [explicit]
    ├── JOIN (ctr1.ctr_store_sk = store_avg.ctr_store_sk) [new join]
    ├── FILTER (s_state = 'SD') [=]
    ├── FILTER (ctr_total_return > avg_return) [replaced subquery]
    ├── SORT (c_customer_id ASC) [=]
    └── OUTPUT (c_customer_id) [=]
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "snowflake",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "correlated_subquery_to_join",
      "description": "Replaced correlated subquery with precomputed CTE and explicit JOIN",
      "applied_to": ["main_query"]
    },
    {
      "id": "R2",
      "type": "cte_decomposition",
      "description": "Split original CTE into ctr_all and store_avg per target tree",
      "applied_to": ["ctr_all", "store_avg"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "ctr_all": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk",
        "interfaces": {
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_total_return"],
          "consumes": []
        }
      },
      "store_avg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM ctr_all GROUP BY ctr_store_sk",
        "interfaces": {
          "outputs": ["ctr_store_sk", "avg_return"],
          "consumes": ["ctr_all"]
        }
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT c_customer_id FROM ctr_all AS ctr1 JOIN store ON ctr1.ctr_store_sk = store.s_store_sk JOIN customer ON ctr1.ctr_customer_sk = customer.c_customer_sk JOIN store_avg ON ctr1.ctr_store_sk = store_avg.ctr_store_sk WHERE store.s_state = 'SD' AND ctr1.ctr_total_return > store_avg.avg_return ORDER BY c_customer_id LIMIT 100",
        "interfaces": {
          "outputs": ["c_customer_id"],
          "consumes": ["ctr_all", "store_avg"]
        }
      }
    },
    "reconstruction_order": ["ctr_all", "store_avg", "main_query"],
    "assembly_template": "WITH ctr_all AS ({ctr_all}), store_avg AS ({store_avg}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

### Changes and Mechanism
**Changes:**  
1. Decomposed original CTE into `ctr_all` (base aggregates) and `store_avg` (store-level thresholds)
2. Replaced correlated subquery with explicit `JOIN` to precomputed `store_avg` CTE
3. Converted implicit joins to explicit `JOIN` syntax

**Mechanism:**  
The correlated subquery calculating per-store average is precomputed in `store_avg` CTE. The main query joins this CTE using `ctr_store_sk`, eliminating per-row subquery execution. State filtering (`s_state='SD'`) remains in main query to avoid corrupting store averages.

**Expected speedup:**  
High (10-100x). Correlated subquery elimination reduces complexity from O(n²) to O(n) by leveraging small (10-row) `store_avg` CTE. Explicit joins enable better join ordering.