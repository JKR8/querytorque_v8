### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K
    WITH
      date_cte: (SELECT d_date_sk FROM date_dim WHERE d_year=2001 AND d_qoy<4) [~] (new CTE)
      store_sales_cte: (SELECT ss_customer_sk FROM store_sales JOIN date_cte ON ss_sold_date_sk = d_date_sk) [~] (new CTE)
      web_sales_cte: (SELECT ws_bill_customer_sk FROM web_sales JOIN date_cte ON ws_sold_date_sk = d_date_sk) [~] (new CTE)
      catalog_sales_cte: (SELECT cs_ship_customer_sk FROM catalog_sales JOIN date_cte ON cs_sold_date_sk = d_date_sk) [~] (new CTE)
    ├── SCAN (customer AS c, customer_address AS ca, customer_demographics AS cd) [=] 
    ├── JOIN (c.c_current_addr_sk = ca.ca_address_sk) [=]
    ├── JOIN (cd.cd_demo_sk = c.c_current_cdemo_sk) [=]
    ├── FILTER (replaced by CTE conditions) [~]
        - Condition 1: c.c_customer_sk IN (SELECT ss_customer_sk FROM store_sales_cte)
        - Condition 2: (c.c_customer_sk IN (SELECT ws_bill_customer_sk FROM web_sales_cte) OR 
                        c.c_customer_sk IN (SELECT cs_ship_customer_sk FROM catalog_sales_cte))
    ├── AGG (GROUP BY) [=]
    ├── SORT (ca_state ASC, cd_gender ASC, cd_marital_status ASC, cd_dep_count ASC, 
              cd_dep_employed_count ASC, cd_dep_college_count ASC) [=]
    └── OUTPUT (same 18 columns) [=]
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "Snowflake",
  "rewrite_rules": [
    {"id": "R1", "type": "CTE_PREDICATE_CONSOLIDATION", "description": "Consolidate identical date_dim filters into single CTE", "applied_to": ["date_cte"]},
    {"id": "R2", "type": "SEMIJOIN_TO_CTE", "description": "Convert EXISTS subqueries to CTE-based semi-joins", "applied_to": ["store_sales_cte", "web_sales_cte", "catalog_sales_cte"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "store_sales_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ss_customer_sk FROM store_sales JOIN date_cte ON store_sales.ss_sold_date_sk = date_cte.d_date_sk",
        "interfaces": {"outputs": ["ss_customer_sk"], "consumes": ["date_cte"]}
      },
      "web_sales_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws_bill_customer_sk FROM web_sales JOIN date_cte ON web_sales.ws_sold_date_sk = date_cte.d_date_sk",
        "interfaces": {"outputs": ["ws_bill_customer_sk"], "consumes": ["date_cte"]}
      },
      "catalog_sales_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs_ship_customer_sk FROM catalog_sales JOIN date_cte ON catalog_sales.cs_sold_date_sk = date_cte.d_date_sk",
        "interfaces": {"outputs": ["cs_ship_customer_sk"], "consumes": ["date_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT\n  ca_state,\n  cd_gender,\n  cd_marital_status,\n  cd_dep_count,\n  COUNT(*) cnt1,\n  MAX(cd_dep_count),\n  SUM(cd_dep_count),\n  MAX(cd_dep_count),\n  cd_dep_employed_count,\n  COUNT(*) cnt2,\n  MAX(cd_dep_employed_count),\n  SUM(cd_dep_employed_count),\n  MAX(cd_dep_employed_count),\n  cd_dep_college_count,\n  COUNT(*) cnt3,\n  MAX(cd_dep_college_count),\n  SUM(cd_dep_college_count),\n  MAX(cd_dep_college_count)\nFROM customer c\nJOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\nWHERE \n  c.c_customer_sk IN (SELECT ss_customer_sk FROM store_sales_cte)\n  AND (\n    c.c_customer_sk IN (SELECT ws_bill_customer_sk FROM web_sales_cte)\n    OR c.c_customer_sk IN (SELECT cs_ship_customer_sk FROM catalog_sales_cte)\n  )\nGROUP BY \n  ca_state,\n  cd_gender,\n  cd_marital_status,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY \n  ca_state,\n  cd_gender,\n  cd_marital_status,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100",
        "interfaces": {
          "outputs": [
            "ca_state", "cd_gender", "cd_marital_status", "cd_dep_count", "cnt1", 
            "MAX(cd_dep_count)", "SUM(cd_dep_count)", "MAX(cd_dep_count)", 
            "cd_dep_employed_count", "cnt2", "MAX(cd_dep_employed_count)", 
            "SUM(cd_dep_employed_count)", "MAX(cd_dep_employed_count)", 
            "cd_dep_college_count", "cnt3", "MAX(cd_dep_college_count)", 
            "SUM(cd_dep_college_count)", "MAX(cd_dep_college_count)"
          ],
          "consumes": ["store_sales_cte", "web_sales_cte", "catalog_sales_cte"]
        }
      }
    },
    "reconstruction_order": ["date_cte", "store_sales_cte", "web_sales_cte", "catalog_sales_cte", "main_query"],
    "assembly_template": "WITH date_cte AS ({date_cte}),\n     store_sales_cte AS ({store_sales_cte}),\n     web_sales_cte AS ({web_sales_cte}),\n     catalog_sales_cte AS ({catalog_sales_cte})\n{main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": [
    {"name": "output_column_count", "status": "pass", "message": "18 output columns match original"},
    {"name": "date_filter_preserved", "status": "pass", "message": "d_year=2001 AND d_qoy<4 unchanged"}
  ]
}
```

### Mechanism Explanation
**Changes:** Consolidated three identical `date_dim` scans into a single CTE (`date_cte`), preserving the original filters. Converted `EXISTS` subqueries to CTE-based semi-joins using `IN` clauses, maintaining the original `OR` logic between web/catalog sales while preventing duplicates. 

**Expected speedup:** 1.5-2x reduction in execution time by eliminating redundant date_dim scans (3→1) while maintaining semi-join semantics. Snowflake's CTE materialization optimizes repeated access to filtered date keys.