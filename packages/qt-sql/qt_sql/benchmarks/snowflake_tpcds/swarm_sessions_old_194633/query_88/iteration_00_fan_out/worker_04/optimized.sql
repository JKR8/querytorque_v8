WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), sales_time_agg AS (SELECT ss_hdemo_sk, COUNT_IF(t_hour=8 AND t_minute>=30) AS h8_30_to_9, COUNT_IF(t_hour=9 AND t_minute<30) AS h9_to_9_30, COUNT_IF(t_hour=9 AND t_minute>=30) AS h9_30_to_10, COUNT_IF(t_hour=10 AND t_minute<30) AS h10_to_10_30, COUNT_IF(t_hour=10 AND t_minute>=30) AS h10_30_to_11, COUNT_IF(t_hour=11 AND t_minute<30) AS h11_to_11_30, COUNT_IF(t_hour=11 AND t_minute>=30) AS h11_30_to_12, COUNT_IF(t_hour=12 AND t_minute<30) AS h12_to_12_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN time_dim ON ss_sold_time_sk = t_time_sk WHERE ((t_hour=8 AND t_minute>=30) OR (t_hour=9 AND t_minute<30) OR (t_hour=9 AND t_minute>=30) OR (t_hour=10 AND t_minute<30) OR (t_hour=10 AND t_minute>=30) OR (t_hour=11 AND t_minute<30) OR (t_hour=11 AND t_minute>=30) OR (t_hour=12 AND t_minute<30)) GROUP BY ss_hdemo_sk), household_join AS (SELECT SUM(h8_30_to_9) AS h8_30_to_9, SUM(h9_to_9_30) AS h9_to_9_30, SUM(h9_30_to_10) AS h9_30_to_10, SUM(h10_to_10_30) AS h10_to_10_30, SUM(h10_30_to_11) AS h10_30_to_11, SUM(h11_to_11_30) AS h11_to_11_30, SUM(h11_30_to_12) AS h11_30_to_12, SUM(h12_to_12_30) AS h12_to_12_30 FROM sales_time_agg JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk WHERE ((hd_dep_count = -1 AND hd_vehicle_count <= -1+2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4+2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3+2))) SELECT * FROM household_join