### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  (restructured to CTE pipeline)
    ├── CTE: filtered_store  [+]
    │   └── SCAN store
    │       └── FILTER (s_store_name='ese')
    ├── CTE: sales_time_agg  [+]
    │   ├── JOIN (store_sales × filtered_store × time_dim)
    │   ├── FILTER (8 time intervals)
    │   └── AGGREGATE (COUNT_IF per interval) → ss_hdemo_sk
    ├── CTE: household_join  [+]
    │   ├── JOIN (sales_time_agg × household_demographics)
    │   ├── FILTER (household conditions)
    │   └── AGGREGATE (SUM counts)
    └── OUTPUT (*)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "snowflake",
  "rewrite_rules": [
    {"id": "R1", "type": "cte_predicate_fence", "description": "Defer household join to after time/store aggregation", "applied_to": ["filtered_store", "sales_time_agg", "household_join"]},
    {"id": "R2", "type": "aggregate_below_join", "description": "Partial aggregation before dimension join", "applied_to": ["sales_time_agg"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_store": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT s_store_sk FROM store WHERE s_store_name = 'ese'",
        "interfaces": {"outputs": ["s_store_sk"], "consumes": []}
      },
      "sales_time_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_hdemo_sk, COUNT_IF(t_hour=8 AND t_minute>=30) AS h8_30_to_9, COUNT_IF(t_hour=9 AND t_minute<30) AS h9_to_9_30, COUNT_IF(t_hour=9 AND t_minute>=30) AS h9_30_to_10, COUNT_IF(t_hour=10 AND t_minute<30) AS h10_to_10_30, COUNT_IF(t_hour=10 AND t_minute>=30) AS h10_30_to_11, COUNT_IF(t_hour=11 AND t_minute<30) AS h11_to_11_30, COUNT_IF(t_hour=11 AND t_minute>=30) AS h11_30_to_12, COUNT_IF(t_hour=12 AND t_minute<30) AS h12_to_12_30 FROM store_sales JOIN filtered_store ON ss_store_sk = s_store_sk JOIN time_dim ON ss_sold_time_sk = t_time_sk WHERE ((t_hour=8 AND t_minute>=30) OR (t_hour=9 AND t_minute<30) OR (t_hour=9 AND t_minute>=30) OR (t_hour=10 AND t_minute<30) OR (t_hour=10 AND t_minute>=30) OR (t_hour=11 AND t_minute<30) OR (t_hour=11 AND t_minute>=30) OR (t_hour=12 AND t_minute<30)) GROUP BY ss_hdemo_sk",
        "interfaces": {"outputs": ["ss_hdemo_sk", "h8_30_to_9", "h9_to_9_30", "h9_30_to_10", "h10_to_10_30", "h10_30_to_11", "h11_to_11_30", "h11_30_to_12", "h12_to_12_30"], "consumes": ["filtered_store"]}
      },
      "household_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT SUM(h8_30_to_9) AS h8_30_to_9, SUM(h9_to_9_30) AS h9_to_9_30, SUM(h9_30_to_10) AS h9_30_to_10, SUM(h10_to_10_30) AS h10_to_10_30, SUM(h10_30_to_11) AS h10_30_to_11, SUM(h11_to_11_30) AS h11_to_11_30, SUM(h11_30_to_12) AS h11_30_to_12, SUM(h12_to_12_30) AS h12_to_12_30 FROM sales_time_agg JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk WHERE ((hd_dep_count = -1 AND hd_vehicle_count <= -1+2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4+2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3+2))",
        "interfaces": {"outputs": ["h8_30_to_9", "h9_to_9_30", "h9_30_to_10", "h10_to_10_30", "h10_30_to_11", "h11_to_11_30", "h11_30_to_12", "h12_to_12_30"], "consumes": ["sales_time_agg"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT * FROM household_join",
        "interfaces": {"outputs": ["h8_30_to_9", "h9_to_9_30", "h9_30_to_10", "h10_to_10_30", "h10_30_to_11", "h11_to_11_30", "h11_30_to_12", "h12_to_12_30"], "consumes": ["household_join"]}
      }
    },
    "reconstruction_order": ["filtered_store", "sales_time_agg", "household_join", "main_query"],
    "assembly_template": "WITH filtered_store AS ({filtered_store}), sales_time_agg AS ({sales_time_agg}), household_join AS ({household_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Replaced 8 repeated subqueries with single-pass conditional aggregation. Deferred household join until after time/store filtering and partial aggregation.  
Expected speedup: 8x scan reduction + early aggregation → ~90% runtime decrease.