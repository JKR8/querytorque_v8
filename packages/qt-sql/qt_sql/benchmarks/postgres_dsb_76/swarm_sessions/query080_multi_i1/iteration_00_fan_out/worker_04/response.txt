### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_date  [+]
│   ├── SCAN date_dim
│   ├── FILTER (d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 DAY')
│   └── OUTPUT (d_date_sk, d_date)
├── [CTE] filtered_item  [+]
│   ├── SCAN item
│   ├── FILTER (i_current_price > 50 AND i_category IN ('Children', 'Sports'))
│   └── OUTPUT (i_item_sk, i_current_price, i_category)
├── [CTE] filtered_promotion  [+]
│   ├── SCAN promotion
│   ├── FILTER (p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N')
│   └── OUTPUT (p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event)
├── [CTE] ssr_pre  [~]
│   ├── SCAN store_sales
│   ├── FILTER (ss_wholesale_cost BETWEEN 23 AND 38)
│   ├── FILTER (ss_sold_date_sk IN (SELECT d_date_sk FROM filtered_date))
│   ├── FILTER (ss_item_sk IN (SELECT i_item_sk FROM filtered_item))
│   ├── FILTER (ss_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion))
│   └── OUTPUT (ss_store_sk, ss_item_sk, ss_ticket_number, ss_ext_sales_price, ss_net_profit, ss_sold_date_sk, ss_promo_sk)
├── [CTE] ssr  [~]
│   ├── SCAN ssr_pre
│   ├── JOIN (LEFT OUTER) store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)
│   ├── JOIN (INNER) store ON ss_store_sk = s_store_sk
│   ├── AGG (GROUP BY s_store_id)
│   └── OUTPUT (store_id, sales, returns, profit)
├── [CTE] csr_pre  [+]
│   ├── SCAN catalog_sales
│   ├── FILTER (cs_wholesale_cost BETWEEN 23 AND 38)
│   ├── FILTER (cs_sold_date_sk IN (SELECT d_date_sk FROM filtered_date))
│   ├── FILTER (cs_item_sk IN (SELECT i_item_sk FROM filtered_item))
│   ├── FILTER (cs_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion))
│   └── OUTPUT (cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_ext_sales_price, cs_net_profit, cs_sold_date_sk, cs_promo_sk)
├── [CTE] csr  [~]
│   ├── SCAN csr_pre
│   ├── JOIN (LEFT OUTER) catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)
│   ├── JOIN (INNER) catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk
│   ├── AGG (GROUP BY cp_catalog_page_id)
│   └── OUTPUT (catalog_page_id, sales, returns, profit)
├── [CTE] wsr_pre  [+]
│   ├── SCAN web_sales
│   ├── FILTER (ws_wholesale_cost BETWEEN 23 AND 38)
│   ├── FILTER (ws_sold_date_sk IN (SELECT d_date_sk FROM filtered_date))
│   ├── FILTER (ws_item_sk IN (SELECT i_item_sk FROM filtered_item))
│   ├── FILTER (ws_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion))
│   └── OUTPUT (ws_web_site_sk, ws_item_sk, ws_order_number, ws_ext_sales_price, ws_net_profit, ws_sold_date_sk, ws_promo_sk)
├── [CTE] wsr  [~]
│   ├── SCAN wsr_pre
│   ├── JOIN (LEFT OUTER) web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)
│   ├── JOIN (INNER) web_site ON ws_web_site_sk = web_site_sk
│   ├── AGG (GROUP BY web_site_id)
│   └── OUTPUT (web_site_id, sales, returns, profit)
└── [MAIN] main_query  [=]
    ├── SCAN (wsr, ssr, csr)
    ├── AGG (GROUP BY)
    ├── SORT (channel ASC, id ASC)
    └── OUTPUT (channel, id, sales, returns, profit)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "materialized_dimension_ctes", "description": "Extract dimension filters into MATERIALIZED CTEs to avoid repeated scans", "applied_to": ["filtered_date", "filtered_item", "filtered_promotion"]},
    {"id": "R2", "type": "fact_table_prefiltering", "description": "Replace comma-separated implicit joins with IN clause prefiltering using dimension CTEs", "applied_to": ["ssr_pre", "csr_pre", "wsr_pre"]},
    {"id": "R3", "type": "explicit_joins", "description": "Convert comma-separated joins to explicit LEFT/INNER JOIN syntax", "applied_to": ["ssr", "csr", "wsr"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 DAY'",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk, i_current_price, i_category FROM item WHERE i_current_price > 50 AND i_category IN ('Children', 'Sports')",
        "interfaces": {"outputs": ["i_item_sk", "i_current_price", "i_category"], "consumes": []}
      },
      "filtered_promotion": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event FROM promotion WHERE p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N'",
        "interfaces": {"outputs": ["p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio", "p_channel_press", "p_channel_event"], "consumes": []}
      },
      "ssr_pre": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ss_store_sk, ss_item_sk, ss_ticket_number, ss_ext_sales_price, ss_net_profit, ss_sold_date_sk, ss_promo_sk FROM store_sales WHERE ss_wholesale_cost BETWEEN 23 AND 38 AND ss_sold_date_sk IN (SELECT d_date_sk FROM filtered_date) AND ss_item_sk IN (SELECT i_item_sk FROM filtered_item) AND ss_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion)",
        "interfaces": {"outputs": ["ss_store_sk", "ss_item_sk", "ss_ticket_number", "ss_ext_sales_price", "ss_net_profit", "ss_sold_date_sk", "ss_promo_sk"], "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]}
      },
      "ssr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT s_store_id as store_id, SUM(ss_ext_sales_price) as sales, SUM(COALESCE(sr_return_amt, 0)) as returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) as profit FROM ssr_pre LEFT OUTER JOIN store_returns ON (ssr_pre.ss_item_sk = store_returns.sr_item_sk AND ssr_pre.ss_ticket_number = store_returns.sr_ticket_number) INNER JOIN store ON ssr_pre.ss_store_sk = store.s_store_sk GROUP BY s_store_id",
        "interfaces": {"outputs": ["store_id", "sales", "returns", "profit"], "consumes": ["ssr_pre"]}
      },
      "csr_pre": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs_catalog_page_sk, cs_item_sk, cs_order_number, cs_ext_sales_price, cs_net_profit, cs_sold_date_sk, cs_promo_sk FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 23 AND 38 AND cs_sold_date_sk IN (SELECT d_date_sk FROM filtered_date) AND cs_item_sk IN (SELECT i_item_sk FROM filtered_item) AND cs_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion)",
        "interfaces": {"outputs": ["cs_catalog_page_sk", "cs_item_sk", "cs_order_number", "cs_ext_sales_price", "cs_net_profit", "cs_sold_date_sk", "cs_promo_sk"], "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]}
      },
      "csr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cp_catalog_page_id as catalog_page_id, SUM(cs_ext_sales_price) as sales, SUM(COALESCE(cr_return_amount, 0)) as returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) as profit FROM csr_pre LEFT OUTER JOIN catalog_returns ON (csr_pre.cs_item_sk = catalog_returns.cr_item_sk AND csr_pre.cs_order_number = catalog_returns.cr_order_number) INNER JOIN catalog_page ON csr_pre.cs_catalog_page_sk = catalog_page.cp_catalog_page_sk GROUP BY cp_catalog_page_id",
        "interfaces": {"outputs": ["catalog_page_id", "sales", "returns", "profit"], "consumes": ["csr_pre"]}
      },
      "wsr_pre": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws_web_site_sk, ws_item_sk, ws_order_number, ws_ext_sales_price, ws_net_profit, ws_sold_date_sk, ws_promo_sk FROM web_sales WHERE ws_wholesale_cost BETWEEN 23 AND 38 AND ws_sold_date_sk IN (SELECT d_date_sk FROM filtered_date) AND ws_item_sk IN (SELECT i_item_sk FROM filtered_item) AND ws_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion)",
        "interfaces": {"outputs": ["ws_web_site_sk", "ws_item_sk", "ws_order_number", "ws_ext_sales_price", "ws_net_profit", "ws_sold_date_sk", "ws_promo_sk"], "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]}
      },
      "wsr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT web_site_id, SUM(ws_ext_sales_price) as sales, SUM(COALESCE(wr_return_amt, 0)) as returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) as profit FROM wsr_pre LEFT OUTER JOIN web_returns ON (wsr_pre.ws_item_sk = web_returns.wr_item_sk AND wsr_pre.ws_order_number = web_returns.wr_order_number) INNER JOIN web_site ON wsr_pre.ws_web_site_sk = web_site.web_site_sk GROUP BY web_site_id",
        "interfaces": {"outputs": ["web_site_id", "sales", "returns", "profit"], "consumes": ["wsr_pre"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["ssr", "csr", "wsr"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "filtered_promotion", "ssr_pre", "csr_pre", "wsr_pre", "ssr", "csr", "wsr", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), filtered_promotion AS ({filtered_promotion}), ssr_pre AS ({ssr_pre}), ssr AS ({ssr}), csr_pre AS ({csr_pre}), csr AS ({csr}), wsr_pre AS ({wsr_pre}), wsr AS ({wsr}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

Changes: Restructured query using staged reduction with MATERIALIZED CTEs for dimensions and pre-filtered fact tables using IN clauses, then explicit LEFT/INNER JOINs for returns and dimension tables. This avoids repeated dimension table scans and enables parallel scans on fact tables.

Expected speedup: ~2-3x from reduced search space and parallel execution enabled by avoiding CTE materialization on fact tables.