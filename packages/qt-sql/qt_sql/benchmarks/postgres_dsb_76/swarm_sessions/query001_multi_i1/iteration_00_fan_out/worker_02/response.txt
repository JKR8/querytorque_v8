## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] returns_with_store_avg_cte  [~]  Cost: 12% → 15% (adds window function)
│   ├── SCAN (store_returns, date_dim (join)) [=]
│   ├── JOIN (sr_returned_date_sk = d_date_sk) [=]
│   ├── FILTER (d_year = 2002) [=]
│   ├── FILTER (sr_return_amt / sr_return_quantity BETWEEN 108 AND 167) [=]
│   ├── AGG (GROUP BY) [=]
│   ├── WINDOW (AVG(SUM(...)) OVER (PARTITION BY sr_store_sk) * 1.2) [+]
│   └── OUTPUT (ctr_customer_sk, ctr_store_sk, ctr_reason_sk, ctr_total_return, store_avg_threshold) [~]
└── [MAIN] main_query  [~]  Cost: 88% → 85% (removes correlated subquery)
    ├── SCAN (returns_with_store_avg_cte AS ctr1 (join), store (join), customer (join), customer_demographics (join)) [~]
    ├── JOIN (s_store_sk = ctr1.ctr_store_sk) [=]
    ├── JOIN (ctr1.ctr_customer_sk = c_customer_sk) [=]
    ├── JOIN (c_current_cdemo_sk = cd_demo_sk) [=]
    ├── FILTER (ctr1.ctr_total_return > ctr1.store_avg_threshold) [~]
    ├── FILTER (ctr1.ctr_reason_sk BETWEEN 43 AND 46) [=]
    ├── FILTER (+6 more) [=]
    ├── SORT (c_customer_id ASC) [=]
    └── OUTPUT (c_customer_id) [=]
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "pg_self_join_decomposition", "description": "Replace correlated subquery with window function to compute store average threshold in single pass", "applied_to": ["returns_with_store_avg_cte", "main_query"]},
    {"id": "R2", "type": "explicit_join_syntax", "description": "Convert comma joins to explicit INNER JOIN syntax", "applied_to": ["returns_with_store_avg_cte", "main_query"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "returns_with_store_avg_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(sr_return_amt_inc_tax) AS ctr_total_return, AVG(SUM(sr_return_amt_inc_tax)) OVER (PARTITION BY sr_store_sk) * 1.2 AS store_avg_threshold FROM store_returns INNER JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2002 AND CASE WHEN sr_return_quantity > 0 THEN sr_return_amt / sr_return_quantity END BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk",
        "interfaces": {"outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return", "store_avg_threshold"], "consumes": []}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT c_customer_id FROM returns_with_store_avg_cte ctr1 INNER JOIN store ON s_store_sk = ctr1.ctr_store_sk INNER JOIN customer ON c_customer_sk = ctr1.ctr_customer_sk INNER JOIN customer_demographics ON cd_demo_sk = c_current_cdemo_sk WHERE ctr1.ctr_total_return > ctr1.store_avg_threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100",
        "interfaces": {"outputs": ["c_customer_id"], "consumes": ["returns_with_store_avg_cte"]}
      }
    },
    "reconstruction_order": ["returns_with_store_avg_cte", "main_query"],
    "assembly_template": "WITH returns_with_store_avg_cte AS ({returns_with_store_avg_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL work_mem = '16MB'",
    "SET LOCAL hash_mem_multiplier = 2.0",
    "SET LOCAL max_parallel_workers_per_gather = 2",
    "SET LOCAL effective_cache_size = '4GB'"
  ],
  "validation_checks": []
}
```

Changes: Replaced correlated subquery with window function in CTE to compute store average threshold in single pass, eliminating 1,845 subquery executions. Converted comma joins to explicit INNER JOIN syntax.

Expected speedup: 3-4x reduction in execution time by eliminating correlated subquery and enabling single-pass aggregation with window function.