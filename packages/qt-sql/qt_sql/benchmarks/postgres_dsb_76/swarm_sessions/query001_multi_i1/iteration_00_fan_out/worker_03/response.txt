**Modified Logic Tree**

```
QUERY: (single statement)
├── [CTE] filtered_date_cte  [+]
│   ├── SCAN (date_dim)
│   ├── FILTER (d_year = 2002)
│   └── OUTPUT (d_date_sk)
├── [CTE] prefactored_returns_cte  [~] (replaces customer_total_return CTE)
│   ├── SCAN (store_returns)
│   ├── JOIN (filtered_date_cte) ON sr_returned_date_sk = d_date_sk
│   ├── FILTER (sr_return_amt / sr_return_quantity BETWEEN 108 AND 167)
│   ├── AGG (GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk)
│   └── OUTPUT (ctr_customer_sk, ctr_store_sk, ctr_reason_sk, ctr_total_return)
├── [CTE] store_avg_threshold_cte  [+]
│   ├── SCAN (prefactored_returns_cte)
│   ├── AGG (GROUP BY ctr_store_sk)
│   └── OUTPUT (ctr_store_sk, store_avg_threshold)
└── [MAIN] main_query  [~] (explicit joins, no correlated subquery)
    ├── JOIN (prefactored_returns_cte AS ctr1, store_avg_threshold_cte AS th) ON ctr1.ctr_store_sk = th.ctr_store_sk
    ├── JOIN (store) ON ctr1.ctr_store_sk = s_store_sk
    ├── JOIN (customer) ON ctr1.ctr_customer_sk = c_customer_sk
    ├── JOIN (customer_demographics) ON c_current_cdemo_sk = cd_demo_sk
    ├── FILTER (ctr1.ctr_total_return > th.store_avg_threshold)
    ├── FILTER (ctr1.ctr_reason_sk BETWEEN 43 AND 46)
    ├── FILTER (s_state IN ('IL', 'KY', 'TX'))
    ├── FILTER (cd_marital_status IN ('M', 'M'))
    ├── FILTER (cd_education_status IN ('Advanced Degree', 'College'))
    ├── FILTER (cd_gender = 'F')
    ├── FILTER (c_birth_month = 2)
    ├── FILTER (c_birth_year BETWEEN 1965 AND 1971)
    ├── SORT (c_customer_id ASC)
    └── OUTPUT (c_customer_id)
```

**Component Payload JSON**

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "dimension_isolation",
      "description": "Pre-filter date_dim into a CTE to reduce join size",
      "applied_to": ["filtered_date_cte"]
    },
    {
      "id": "R2",
      "type": "explicit_join",
      "description": "Convert comma join to explicit INNER JOIN in prefactored_returns_cte",
      "applied_to": ["prefactored_returns_cte"]
    },
    {
      "id": "R3",
      "type": "correlated_subquery_elimination",
      "description": "Replace correlated subquery with a CTE that computes store averages",
      "applied_to": ["store_avg_threshold_cte", "main_query"]
    },
    {
      "id": "R4",
      "type": "explicit_join",
      "description": "Convert comma joins in main query to explicit INNER JOINs",
      "applied_to": ["main_query"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_date_cte": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002",
          "interfaces": {
            "outputs": ["d_date_sk"],
            "consumes": []
          }
        },
        "prefactored_returns_cte": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns INNER JOIN filtered_date_cte ON store_returns.sr_returned_date_sk = filtered_date_cte.d_date_sk WHERE sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk",
          "interfaces": {
            "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
            "consumes": ["filtered_date_cte"]
          }
        },
        "store_avg_threshold_cte": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS store_avg_threshold FROM prefactored_returns_cte GROUP BY ctr_store_sk",
          "interfaces": {
            "outputs": ["ctr_store_sk", "store_avg_threshold"],
            "consumes": ["prefactored_returns_cte"]
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "modified",
          "sql": "SELECT c_customer_id FROM prefactored_returns_cte AS ctr1 INNER JOIN store_avg_threshold_cte AS th ON ctr1.ctr_store_sk = th.ctr_store_sk INNER JOIN store ON ctr1.ctr_store_sk = store.s_store_sk INNER JOIN customer ON ctr1.ctr_customer_sk = customer.c_customer_sk INNER JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk WHERE ctr1.ctr_total_return > th.store_avg_threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND store.s_state IN ('IL', 'KY', 'TX') AND customer_demographics.cd_marital_status IN ('M', 'M') AND customer_demographics.cd_education_status IN ('Advanced Degree', 'College') AND customer_demographics.cd_gender = 'F' AND customer.c_birth_month = 2 AND customer.c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100",
          "interfaces": {
            "outputs": ["c_customer_id"],
            "consumes": ["prefactored_returns_cte", "store_avg_threshold_cte"]
          }
        }
      },
      "reconstruction_order": ["filtered_date_cte", "prefactored_returns_cte", "store_avg_threshold_cte", "main_query"],
      "assembly_template": "WITH filtered_date_cte AS ({filtered_date_cte}), prefactored_returns_cte AS ({prefactored_returns_cte}), store_avg_threshold_cte AS ({store_avg_threshold_cte}) {main_query}"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL work_mem = '256MB'",
    "SET LOCAL effective_cache_size = '4GB'",
    "SET LOCAL enable_nestloop = off",
    "SET LOCAL max_parallel_workers_per_gather = 2"
  ],
  "validation_checks": []
}
```

**Mechanism & Expected Speedup**
The rewrite eliminates the correlated subquery (executed 1,845 times) by precomputing store averages in a CTE, replaces comma joins with explicit INNER JOINs for better cardinality estimation, and pre-filters the date dimension to create a small hash table. This enables efficient hash joins and parallel execution. Expected speedup: 3–5× due to subquery elimination and better join planning.