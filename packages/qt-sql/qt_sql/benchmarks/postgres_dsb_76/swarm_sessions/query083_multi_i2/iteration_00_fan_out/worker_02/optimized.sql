WITH date_filter_cte AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')), item_filter_cte AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24), unified_returns_cte AS (SELECT returns.channel, ifc.i_item_id, returns.qty FROM (SELECT 'store' AS channel, sr_item_sk AS item_sk, sr_returned_date_sk AS date_sk, sr_return_quantity AS qty FROM store_returns WHERE sr_reason_sk IN (7,18,19,22,36) AND sr_return_amt/sr_return_quantity BETWEEN 253 AND 282 UNION ALL SELECT 'catalog' AS channel, cr_item_sk AS item_sk, cr_returned_date_sk AS date_sk, cr_return_quantity AS qty FROM catalog_returns WHERE cr_reason_sk IN (7,18,19,22,36) AND cr_return_amount/cr_return_quantity BETWEEN 253 AND 282 UNION ALL SELECT 'web' AS channel, wr_item_sk AS item_sk, wr_returned_date_sk AS date_sk, wr_return_quantity AS qty FROM web_returns WHERE wr_reason_sk IN (7,18,19,22,36) AND wr_return_amt/wr_return_quantity BETWEEN 253 AND 282) AS returns INNER JOIN date_filter_cte dfc ON returns.date_sk = dfc.d_date_sk INNER JOIN item_filter_cte ifc ON returns.item_sk = ifc.i_item_sk), pivoted_aggregates AS (SELECT i_item_id AS item_id, SUM(CASE WHEN channel = 'store' THEN qty END) AS sr_item_qty, SUM(CASE WHEN channel = 'catalog' THEN qty END) AS cr_item_qty, SUM(CASE WHEN channel = 'web' THEN qty END) AS wr_item_qty FROM unified_returns_cte GROUP BY i_item_id) SELECT item_id, sr_item_qty, sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS wr_dev, (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average FROM pivoted_aggregates ORDER BY item_id, sr_item_qty LIMIT 100