WITH filtered_date AS MATERIALIZED (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_store AS MATERIALIZED (SELECT s_store_sk FROM store), filtered_cd_hd AS MATERIALIZED (SELECT cd_demo_sk, hd_demo_sk FROM customer_demographics JOIN household_demographics ON 1=1 WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND hd_dep_count = 3) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND hd_dep_count = 1) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND hd_dep_count = 1)), filtered_ca AS MATERIALIZED (SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND (ca_state IN ('GA', 'KY', 'SD') OR ca_state IN ('AR', 'IN', 'VA') OR ca_state IN ('KS', 'OH', 'SD'))), filtered_sales AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_sales_price, ss_net_profit, ss_store_sk, ss_cdemo_sk, ss_hdemo_sk, ss_addr_sk FROM store_sales JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk WHERE (ss_sales_price BETWEEN 50.00 AND 200.00) OR (ss_net_profit BETWEEN 50 AND 300)), sales_or_set1 AS (SELECT DISTINCT fs.ss_quantity, fs.ss_ext_sales_price, fs.ss_ext_wholesale_cost FROM filtered_sales fs JOIN filtered_store s ON fs.ss_store_sk = s.s_store_sk JOIN filtered_cd_hd cdhd ON fs.ss_cdemo_sk = cdhd.cd_demo_sk AND fs.ss_hdemo_sk = cdhd.hd_demo_sk WHERE (cdhd.cd_marital_status = 'M' AND cdhd.cd_education_status = '2 yr Degree' AND cdhd.hd_dep_count = 3 AND fs.ss_sales_price BETWEEN 100.00 AND 150.00) OR (cdhd.cd_marital_status = 'S' AND cdhd.cd_education_status = 'Primary' AND cdhd.hd_dep_count = 1 AND fs.ss_sales_price BETWEEN 50.00 AND 100.00) OR (cdhd.cd_marital_status = 'W' AND cdhd.cd_education_status = 'Primary' AND cdhd.hd_dep_count = 1 AND fs.ss_sales_price BETWEEN 150.00 AND 200.00)), sales_or_set2 AS (SELECT DISTINCT fs.ss_quantity, fs.ss_ext_sales_price, fs.ss_ext_wholesale_cost FROM filtered_sales fs JOIN filtered_store s ON fs.ss_store_sk = s.s_store_sk JOIN filtered_ca ca ON fs.ss_addr_sk = ca.ca_address_sk WHERE (ca.ca_state IN ('GA', 'KY', 'SD') AND fs.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_state IN ('AR', 'IN', 'VA') AND fs.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_state IN ('KS', 'OH', 'SD') AND fs.ss_net_profit BETWEEN 50 AND 250)), combined_sales AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM sales_or_set1 UNION SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM sales_or_set2) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM combined_sales