## Logic Tree Changes

```
[+] filtered_item_cte: Pre-filtered item dimension
[+] filtered_customer_cte: Pre-filtered customer with demographics and address
[+] date_pairs_cte: Pre-computed date pairs for 30-day window in 2001
[+] filtered_web_sales_cte: Web sales with wholesale_cost filter joined with filtered_item
[+] filtered_store_sales_cte: Store sales with inventory, warehouse, store joins and year filter
[~] main_query: Join all pre-filtered CTEs with explicit JOIN conditions
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "pg_dimension_prefetch_star", "description": "Pre-filter all dimension tables into CTEs to create tiny hash tables", "applied_to": ["filtered_item_cte", "filtered_customer_cte"]},
    {"id": "R2", "type": "pg_date_cte_explicit_join", "description": "Materialize date pairs for 30-day window with explicit JOIN syntax", "applied_to": ["date_pairs_cte"]},
    {"id": "R3", "type": "pg_materialized_dimension_fact_prefilter", "description": "Staged reduction for non-equi joins by pre-filtering fact tables", "applied_to": ["filtered_web_sales_cte", "filtered_store_sales_cte"]},
    {"id": "R4", "type": "explicit_join_conversion", "description": "Convert comma joins to explicit JOIN...ON syntax", "applied_to": ["main_query"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_item_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "filtered_customer_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, hd.hd_vehicle_count FROM customer c JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE ca.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')",
        "interfaces": {"outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count"], "consumes": []}
      },
      "date_pairs_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d1.d_date_sk AS d1_date_sk, d2.d_date_sk AS d2_date_sk FROM date_dim d1 JOIN date_dim d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') WHERE d1.d_year = 2001",
        "interfaces": {"outputs": ["d1_date_sk", "d2_date_sk"], "consumes": []}
      },
      "filtered_web_sales_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws.ws_item_sk, ws.ws_bill_customer_sk, ws.ws_sold_date_sk, ws.ws_warehouse_sk FROM web_sales ws JOIN filtered_item_cte fi ON ws.ws_item_sk = fi.i_item_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55",
        "interfaces": {"outputs": ["ws_item_sk", "ws_bill_customer_sk", "ws_sold_date_sk", "ws_warehouse_sk"], "consumes": ["filtered_item_cte"]}
      },
      "filtered_store_sales_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ss.ss_item_sk, ss.ss_customer_sk, ss.ss_sold_date_sk, ss.ss_quantity, inv.inv_warehouse_sk, inv.inv_quantity_on_hand FROM store_sales ss JOIN inventory inv ON ss.ss_item_sk = inv.inv_item_sk AND ss.ss_sold_date_sk = inv.inv_date_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN store s ON w.w_state = s.s_state JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk WHERE inv.inv_quantity_on_hand >= ss.ss_quantity AND d1.d_year = 2001",
        "interfaces": {"outputs": ["ss_item_sk", "ss_customer_sk", "ss_sold_date_sk", "ss_quantity", "inv_warehouse_sk", "inv_quantity_on_hand"], "consumes": []}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM filtered_web_sales_cte fws JOIN filtered_customer_cte fc ON fws.ws_bill_customer_sk = fc.c_customer_sk JOIN date_pairs_cte dp ON fws.ws_sold_date_sk = dp.d2_date_sk JOIN filtered_store_sales_cte fss ON fws.ws_item_sk = fss.ss_item_sk AND fc.c_customer_sk = fss.ss_customer_sk AND dp.d1_date_sk = fss.ss_sold_date_sk AND fws.ws_warehouse_sk = fss.inv_warehouse_sk GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"], "consumes": ["filtered_web_sales_cte", "filtered_customer_cte", "date_pairs_cte", "filtered_store_sales_cte"]}
      }
    },
    "reconstruction_order": ["filtered_item_cte", "filtered_customer_cte", "date_pairs_cte", "filtered_web_sales_cte", "filtered_store_sales_cte", "main_query"],
    "assembly_template": "WITH filtered_item_cte AS ({filtered_item_cte}), filtered_customer_cte AS ({filtered_customer_cte}), date_pairs_cte AS ({date_pairs_cte}), filtered_web_sales_cte AS ({filtered_web_sales_cte}), filtered_store_sales_cte AS ({filtered_store_sales_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": ["SET LOCAL work_mem = '512MB'", "SET LOCAL enable_nestloop = off", "SET LOCAL max_parallel_workers_per_gather = 4"],
  "validation_checks": []
}
```

**Changes**: Staged reduction by pre-filtering all dimensions and fact tables into CTEs before the complex join, converting comma joins to explicit JOIN syntax, and forcing hash joins with increased work_mem.

**Expected speedup**: 2.5-3.0x by reducing the nested-loop penalty on store_sales, enabling parallel scans, and using hash joins for the final combination of pre-filtered results.