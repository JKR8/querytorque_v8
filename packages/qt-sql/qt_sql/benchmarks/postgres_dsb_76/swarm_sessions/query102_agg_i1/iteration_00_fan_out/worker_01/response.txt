## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]  Cost: 100%  Rows: ~660K
    ├── [CTE] filtered_item  [+]  Cost: 0.1%  Rows: 786
    │   └── SCAN (item)
    ├── [CTE] filtered_dates  [+]  Cost: 0.8%  Rows: ~10,950
    │   └── JOIN (date_dim d1 JOIN date_dim d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY'))
    ├── [CTE] filtered_customer  [+]  Cost: 1.2%  Rows: ~25,000
    │   └── JOIN (customer INNER JOIN customer_demographics, household_demographics, customer_address)
    ├── [CTE] filtered_warehouse_store  [+]  Cost: 0.05%  Rows: ~(warehouse × matching stores)
    │   └── JOIN (warehouse INNER JOIN store)
    ├── [CTE] fact_join  [+]  Cost: 97%  Rows: ~660K
    │   ├── JOIN (web_sales INNER JOIN filtered_item)
    │   ├── JOIN (web_sales INNER JOIN filtered_customer)
    │   ├── JOIN (web_sales INNER JOIN filtered_dates)
    │   ├── JOIN (store_sales INNER JOIN filtered_item)
    │   ├── JOIN (store_sales INNER JOIN filtered_customer)
    │   ├── JOIN (inventory INNER JOIN store_sales)
    │   ├── JOIN (inventory INNER JOIN web_sales)
    │   ├── JOIN (web_sales INNER JOIN filtered_warehouse_store)
    │   └── FILTER (ws_wholesale_cost BETWEEN 35 AND 55, inv_quantity_on_hand >= ss_quantity)
    ├── [CTE] aggregation  [+]  Cost: 0.8%  Rows: group count
    │   └── AGG (GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count)
    └── [MAIN_SELECT]  [+]  Cost: 0.1%  Rows: group count
        └── SORT (cnt ASC)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "dimension_prefetch_explicit_join",
      "description": "Convert comma-separated joins to explicit JOIN syntax and pre-filter dimensions into CTEs",
      "applied_to": ["filtered_item", "filtered_dates", "filtered_customer", "filtered_warehouse_store", "fact_join"]
    },
    {
      "id": "R2",
      "type": "cte_structured_aggregation",
      "description": "Break query into logical CTEs matching target tree structure",
      "applied_to": ["filtered_item", "filtered_dates", "filtered_customer", "filtered_warehouse_store", "fact_join", "aggregation", "main_query"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_item": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)",
          "interfaces": {
            "outputs": ["i_item_sk"],
            "consumes": []
          }
        },
        "filtered_dates": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d1.d_date_sk, d1.d_date, d2.d_date_sk FROM date_dim d1 JOIN date_dim d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') WHERE d1.d_year = 2001",
          "interfaces": {
            "outputs": ["d_date_sk", "d_date", "d_date_sk"],
            "consumes": []
          }
        },
        "filtered_customer": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT c_customer_sk, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM customer JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')",
          "interfaces": {
            "outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count"],
            "consumes": []
          }
        },
        "filtered_warehouse_store": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT w_warehouse_sk, w_state FROM warehouse JOIN store ON s_state = w_state",
          "interfaces": {
            "outputs": ["w_warehouse_sk", "w_state"],
            "consumes": []
          }
        },
        "fact_join": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT fc.cd_gender, fc.cd_marital_status, fc.cd_education_status, fc.hd_vehicle_count FROM web_sales ws JOIN filtered_item fi ON ws.ws_item_sk = fi.i_item_sk JOIN filtered_customer fc ON ws.ws_bill_customer_sk = fc.c_customer_sk JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk JOIN store_sales ss ON ss.ss_item_sk = fi.i_item_sk AND ss.ss_customer_sk = fc.c_customer_sk JOIN inventory inv ON inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk AND inv.inv_warehouse_sk = ws.ws_warehouse_sk JOIN filtered_warehouse_store fws ON ws.ws_warehouse_sk = fws.w_warehouse_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55 AND inv.inv_quantity_on_hand >= ss.ss_quantity AND ss.ss_sold_date_sk = fd.d_date_sk",
          "interfaces": {
            "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count"],
            "consumes": ["filtered_item", "filtered_customer", "filtered_dates", "filtered_warehouse_store"]
          }
        },
        "aggregation": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM fact_join GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count",
          "interfaces": {
            "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"],
            "consumes": ["fact_join"]
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "modified",
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, cnt FROM aggregation ORDER BY cnt",
          "interfaces": {
            "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"],
            "consumes": ["aggregation"]
          }
        }
      },
      "reconstruction_order": ["filtered_item", "filtered_dates", "filtered_customer", "filtered_warehouse_store", "fact_join", "aggregation", "main_query"],
      "assembly_template": "WITH filtered_item AS ({filtered_item}), filtered_dates AS ({filtered_dates}), filtered_customer AS ({filtered_customer}), filtered_warehouse_store AS ({filtered_warehouse_store}), fact_join AS ({fact_join}), aggregation AS ({aggregation}) {main_query}"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

Changes: Restructured the query into CTEs following the target logical tree, converting comma joins to explicit JOIN syntax and pre-filtering selective dimension tables. This isolates dimension filtering early and provides PostgreSQL with better cardinality estimates for join planning.

Expected speedup: 2.5-3.5x based on similar transformations in the reference examples. The main gains come from: 1) Early reduction of dimension tables into small hash tables, 2) Explicit JOIN syntax enabling better join order optimization, and 3) Separation of the date range correlation into its own CTE while preserving the exact semantic equivalence.