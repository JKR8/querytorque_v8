### Part 1: Modified Logic Tree

```
QUERY: (CTE-based statement)
└── [MAIN] main_query [~]
    ├── WITH filtered_date (CTE) [+]
    │   └── SCAN date_dim [=]
    │       └── FILTER (d_year=1999 AND d_moy BETWEEN 3 AND 5) [=]
    ├── WITH all_sales_unified (CTE) [+]
    │   └── UNION_ALL [~] (consolidated fact table scans)
    │       ├── SCAN store_sales [=] JOIN filtered_date [=] FILTER ss_list_price [=]
    │       ├── SCAN web_sales [=] JOIN filtered_date [=] FILTER ws_list_price [=]
    │       └── SCAN catalog_sales [=] JOIN filtered_date [=] FILTER cs_list_price [=]
    ├── WITH filtered_address (CTE) [+]
    │   └── SCAN customer_address [=]
    │       └── FILTER ca_state IN ('GA','KY','SD') [=]
    ├── WITH filtered_demo (CTE) [+]
    │   └── SCAN customer_demographics [=]
    │       └── FILTER cd_marital_status AND cd_education_status [=]
    ├── WITH customer_base (CTE) [+]
    │   └── JOIN (customer INNER JOIN filtered_address INNER JOIN filtered_demo) [~] (explicit joins)
    ├── WITH pivot_join (CTE) [+]
    │   └── LEFT JOIN customer_base to all_sales_unified (3-way pivot) [+]
    ├── WITH filter (CTE) [+]
    │   └── FILTER has_store NOT NULL AND has_web IS NULL AND has_catalog IS NULL [~] (converted from NOT EXISTS)
    ├── WITH group_by (CTE) [+]
    │   └── GROUP BY (5 demographic columns) [=]
    │       └── AGGREGATE (COUNT(*) ×3) [=]
    └── OUTPUT (same 8 columns) [=]
        └── ORDER BY (5 columns) [=]
        └── LIMIT 100 [=]
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "scan_consolidation_pivot", "description": "Consolidate three fact table scans into UNION ALL with channel discriminator", "applied_to": ["all_sales_unified"]},
    {"id": "R2", "type": "union_consolidation", "description": "Share date_dim filter via CTE across all UNION branches", "applied_to": ["filtered_date"]},
    {"id": "R3", "type": "pivot_join_pattern", "description": "Convert EXISTS/NOT EXISTS to LEFT JOIN + NULL filter pivot pattern", "applied_to": ["pivot_join", "filter"]},
    {"id": "R4", "type": "explicit_join_conversion", "description": "Convert comma-separated joins to explicit INNER JOIN syntax", "applied_to": ["customer_base"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "all_sales_unified": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_customer_sk AS customer_sk, 'store' AS channel FROM store_sales JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk WHERE ss_list_price BETWEEN 52 AND 141 UNION ALL SELECT ws_bill_customer_sk AS customer_sk, 'web' AS channel FROM web_sales JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk WHERE ws_list_price BETWEEN 52 AND 141 UNION ALL SELECT cs_ship_customer_sk AS customer_sk, 'catalog' AS channel FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk WHERE cs_list_price BETWEEN 52 AND 141",
        "interfaces": {"outputs": ["customer_sk", "channel"], "consumes": ["filtered_date"]}
      },
      "filtered_address": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('GA','KY','SD')",
        "interfaces": {"outputs": ["ca_address_sk"], "consumes": []}
      },
      "filtered_demo": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cd_demo_sk, cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating FROM customer_demographics WHERE cd_marital_status IN ('D','W','U') AND cd_education_status IN ('Primary','College')",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"], "consumes": []}
      },
      "customer_base": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT c.c_customer_sk, d.cd_gender, d.cd_marital_status, d.cd_education_status, d.cd_purchase_estimate, d.cd_credit_rating FROM customer c INNER JOIN filtered_address a ON c.c_current_addr_sk = a.ca_address_sk INNER JOIN filtered_demo d ON c.c_current_cdemo_sk = d.cd_demo_sk",
        "interfaces": {"outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"], "consumes": ["filtered_address", "filtered_demo"]}
      },
      "pivot_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cb.*, store.customer_sk AS has_store, web.customer_sk AS has_web, catalog.customer_sk AS has_catalog FROM customer_base cb LEFT JOIN all_sales_unified store ON cb.c_customer_sk = store.customer_sk AND store.channel = 'store' LEFT JOIN all_sales_unified web ON cb.c_customer_sk = web.customer_sk AND web.channel = 'web' LEFT JOIN all_sales_unified catalog ON cb.c_customer_sk = catalog.customer_sk AND catalog.channel = 'catalog'",
        "interfaces": {"outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating", "has_store", "has_web", "has_catalog"], "consumes": ["customer_base", "all_sales_unified"]}
      },
      "filter": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT c_customer_sk, cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating FROM pivot_join WHERE has_store IS NOT NULL AND has_web IS NULL AND has_catalog IS NULL",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"], "consumes": ["pivot_join"]}
      },
      "group_by": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3 FROM filter GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"], "consumes": ["filter"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, cnt1, cd_purchase_estimate, cnt2, cd_credit_rating, cnt3 FROM group_by ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"], "consumes": ["group_by"]}
      }
    },
    "reconstruction_order": ["filtered_date", "all_sales_unified", "filtered_address", "filtered_demo", "customer_base", "pivot_join", "filter", "group_by", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), all_sales_unified AS ({all_sales_unified}), filtered_address AS ({filtered_address}), filtered_demo AS ({filtered_demo}), customer_base AS ({customer_base}), pivot_join AS ({pivot_join}), filter AS ({filter}), group_by AS ({group_by}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

Changes: Converted comma joins to explicit INNER JOINs and replaced correlated subqueries with UNION ALL fact consolidation + pivot join pattern (3 LEFT JOINs with NULL filters). Expected speedup: 3-5x from eliminating nested loop anti-joins and enabling fact table scan parallelism.