WITH filtered_date_dim AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100), filtered_warehouse AS (SELECT w_warehouse_sk, w_warehouse_name FROM warehouse), prejoined_inventory AS (SELECT w_warehouse_sk, w_warehouse_name, i_item_sk, d_moy, inv_quantity_on_hand FROM inventory INNER JOIN filtered_date_dim ON inv_date_sk = d_date_sk INNER JOIN filtered_item ON inv_item_sk = i_item_sk INNER JOIN filtered_warehouse ON inv_warehouse_sk = w_warehouse_sk WHERE inv_quantity_on_hand BETWEEN 0 AND 200), monthly_agg AS (SELECT w_warehouse_sk, w_warehouse_name, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM prejoined_inventory GROUP BY w_warehouse_sk, w_warehouse_name, i_item_sk, d_moy), inv_cte AS (SELECT w_warehouse_sk, w_warehouse_name, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM monthly_agg WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv_cte inv1, inv_cte inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 2 AND inv2.d_moy = 2+1 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov