### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]  Structural change: CTE pipeline replacing single-block query
    ├── [CTE] filtered_d1  [+]  Pre-filtered date_dim for year 1999
    ├── [CTE] filtered_hd  [+]  Pre-filtered household_demographics
    ├── [CTE] filtered_cd  [+]  Pre-filtered customer_demographics
    ├── [CTE] filtered_item  [+]  Pre-filtered item for categories
    ├── [CTE] filtered_catalog_sales  [!]  Modified: joins pre-filtered dims, adds cs_sold_date_sk to output
    ├── [CTE] filtered_inventory  [!]  Modified: joins filtered_item only, inequality deferred
    ├── [CTE] filtered_d2  [+]  Week-aligned date_dim from filtered_d1
    ├── [CTE] filtered_d3  [+]  Ship date condition via filtered_catalog_sales
    ├── [CTE] filtered_promotion  [!]  Modified: left join with filtered_catalog_sales
    └── [AGGREGATE] aggregated_result  [!]  Modified: explicit joins with all CTEs
        ├── JOIN filtered_inventory ON (cs_item_sk = inv_item_sk AND inv_quantity_on_hand < cs_quantity)
        ├── JOIN filtered_d2 ON (inv_date_sk = d_date_sk)
        ├── LEFT JOIN filtered_promotion ON (cs_promo_sk = p_promo_sk)
        ├── LEFT JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number)
        ├── GROUP BY i_item_desc, w_warehouse_name, d_week_seq
        ├── SORT (total_cnt DESC, i_item_desc ASC, w_warehouse_name ASC, d_week_seq ASC)
        └── OUTPUT (i_item_desc, w_warehouse_name, d_week_seq, no_promo, promo, total_cnt)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL 16.11",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "pg_materialized_dimension_fact_prefilter",
      "description": "Pre-filter all selective dimensions and fact table into CTEs before expensive non-equi join",
      "applied_to": ["filtered_d1", "filtered_hd", "filtered_cd", "filtered_item", "filtered_catalog_sales"]
    },
    {
      "id": "R2",
      "type": "pg_dimension_prefetch_star",
      "description": "Isolate date_dim usage into separate CTEs (d1, d2, d3) with explicit joins",
      "applied_to": ["filtered_d1", "filtered_d2", "filtered_d3"]
    },
    {
      "id": "R3",
      "type": "structural_preservation",
      "description": "Preserve all original join conditions and null-safe patterns; keep catalog_returns left join",
      "applied_to": ["aggregated_result"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_d1": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999",
          "interfaces": {
            "outputs": ["d_date_sk", "d_week_seq", "d_date"],
            "consumes": []
          }
        },
        "filtered_hd": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'",
          "interfaces": {
            "outputs": ["hd_demo_sk"],
            "consumes": []
          }
        },
        "filtered_cd": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11",
          "interfaces": {
            "outputs": ["cd_demo_sk"],
            "consumes": []
          }
        },
        "filtered_item": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')",
          "interfaces": {
            "outputs": ["i_item_sk", "i_item_desc"],
            "consumes": []
          }
        },
        "filtered_catalog_sales": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT cs.cs_item_sk, cs.cs_quantity, cs.cs_promo_sk, cs.cs_order_number, cs.cs_ship_date_sk, cs.cs_wholesale_cost, d1.d_date, d1.d_week_seq FROM catalog_sales cs INNER JOIN filtered_d1 d1 ON cs.cs_sold_date_sk = d1.d_date_sk INNER JOIN filtered_hd hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk INNER JOIN filtered_cd cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk INNER JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk WHERE cs.cs_wholesale_cost BETWEEN 76 AND 96",
          "interfaces": {
            "outputs": ["cs_item_sk", "cs_quantity", "cs_promo_sk", "cs_order_number", "cs_ship_date_sk", "cs_wholesale_cost", "d_date", "d_week_seq"],
            "consumes": ["filtered_d1", "filtered_hd", "filtered_cd", "filtered_item"]
          }
        },
        "filtered_inventory": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT inv.inv_warehouse_sk, inv.inv_date_sk, inv.inv_item_sk, inv.inv_quantity_on_hand FROM inventory inv INNER JOIN filtered_item i ON inv.inv_item_sk = i.i_item_sk",
          "interfaces": {
            "outputs": ["inv_warehouse_sk", "inv_date_sk", "inv_item_sk", "inv_quantity_on_hand"],
            "consumes": ["filtered_item"]
          }
        },
        "filtered_d2": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d2.d_date_sk, d1.d_week_seq FROM date_dim d2 INNER JOIN filtered_d1 d1 ON d2.d_week_seq = d1.d_week_seq",
          "interfaces": {
            "outputs": ["d_date_sk", "d_week_seq"],
            "consumes": ["filtered_d1"]
          }
        },
        "filtered_d3": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d3.d_date_sk FROM date_dim d3 INNER JOIN filtered_catalog_sales cs ON cs.cs_ship_date_sk = d3.d_date_sk WHERE d3.d_date > cs.d_date + INTERVAL '3 day'",
          "interfaces": {
            "outputs": ["d_date_sk"],
            "consumes": ["filtered_catalog_sales"]
          }
        },
        "filtered_promotion": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT p.p_promo_sk, cs.cs_item_sk, cs.cs_order_number FROM promotion p LEFT JOIN filtered_catalog_sales cs ON cs.cs_promo_sk = p.p_promo_sk",
          "interfaces": {
            "outputs": ["p_promo_sk", "cs_item_sk", "cs_order_number"],
            "consumes": ["filtered_catalog_sales"]
          }
        },
        "aggregated_result": {
          "type": "main_query",
          "change": "modified",
          "sql": "SELECT i.i_item_desc, w.w_warehouse_name, cs.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_catalog_sales cs INNER JOIN filtered_inventory inv ON cs.cs_item_sk = inv.inv_item_sk AND inv.inv_quantity_on_hand < cs.cs_quantity INNER JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk INNER JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk INNER JOIN filtered_d2 d2 ON inv.inv_date_sk = d2.d_date_sk INNER JOIN filtered_d3 d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT JOIN filtered_promotion p ON cs.cs_promo_sk = p.p_promo_sk AND cs.cs_item_sk = p.cs_item_sk AND cs.cs_order_number = p.cs_order_number LEFT JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number GROUP BY i.i_item_desc, w.w_warehouse_name, cs.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, cs.d_week_seq LIMIT 100",
          "interfaces": {
            "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
            "consumes": ["filtered_catalog_sales", "filtered_inventory", "filtered_item", "filtered_d2", "filtered_d3", "filtered_promotion"]
          }
        }
      },
      "reconstruction_order": ["filtered_d1", "filtered_hd", "filtered_cd", "filtered_item", "filtered_catalog_sales", "filtered_inventory", "filtered_d2", "filtered_d3", "filtered_promotion", "aggregated_result"],
      "assembly_template": "WITH filtered_d1 AS ({filtered_d1}), filtered_hd AS ({filtered_hd}), filtered_cd AS ({filtered_cd}), filtered_item AS ({filtered_item}), filtered_catalog_sales AS ({filtered_catalog_sales}), filtered_inventory AS ({filtered_inventory}), filtered_d2 AS ({filtered_d2}), filtered_d3 AS ({filtered_d3}), filtered_promotion AS ({filtered_promotion}) {aggregated_result}"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Converted single-block query into staged CTE pipeline that pre-filters dimensions and fact table before the expensive non-equi join. All original join conditions, null-safe patterns, and the catalog_returns left join are preserved.

**Expected speedup**: 2-3× reduction in join search space through dimension prefetching and explicit CTE isolation, similar to referenced patterns.