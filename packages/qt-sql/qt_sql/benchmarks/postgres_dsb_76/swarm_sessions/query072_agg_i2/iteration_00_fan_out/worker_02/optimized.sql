WITH filtered_d1 AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), catalog_sales_join AS (SELECT cs.cs_item_sk, cs.cs_quantity, cs.cs_promo_sk, cs.cs_order_number, cs.cs_ship_date_sk, cs.cs_wholesale_cost, fd.d_week_seq, fd.d_date, fi.i_item_desc FROM catalog_sales cs JOIN filtered_d1 fd ON cs.cs_sold_date_sk = fd.d_date_sk JOIN filtered_hd fh ON cs.cs_bill_hdemo_sk = fh.hd_demo_sk JOIN filtered_cd fc ON cs.cs_bill_cdemo_sk = fc.cd_demo_sk JOIN filtered_item fi ON fi.i_item_sk = cs.cs_item_sk WHERE cs.cs_wholesale_cost BETWEEN 76 AND 96), inventory_join AS (SELECT inv.inv_warehouse_sk, inv.inv_date_sk, inv.inv_item_sk, csj.cs_item_sk, csj.cs_quantity, csj.d_week_seq FROM inventory inv JOIN filtered_item fi ON inv.inv_item_sk = fi.i_item_sk JOIN catalog_sales_join csj ON inv.inv_item_sk = csj.cs_item_sk WHERE inv.inv_quantity_on_hand < csj.cs_quantity), d2_join AS (SELECT d2.d_date_sk, d2.d_week_seq, ij.inv_warehouse_sk, ij.inv_item_sk FROM date_dim d2 JOIN catalog_sales_join csj ON d2.d_week_seq = csj.d_week_seq JOIN inventory_join ij ON d2.d_date_sk = ij.inv_date_sk), d3_join AS (SELECT d3.d_date_sk FROM date_dim d3 JOIN catalog_sales_join csj ON csj.cs_ship_date_sk = d3.d_date_sk WHERE d3.d_date > csj.d_date + INTERVAL '3 day'), promotion_join AS (SELECT p.p_promo_sk, csj.cs_item_sk, csj.cs_order_number FROM promotion p LEFT JOIN catalog_sales_join csj ON csj.cs_promo_sk = p.p_promo_sk), warehouse_join AS (SELECT w.w_warehouse_name, ij.inv_warehouse_sk, ij.inv_item_sk FROM warehouse w JOIN inventory_join ij ON w.w_warehouse_sk = ij.inv_warehouse_sk) SELECT csj.i_item_desc, wj.w_warehouse_name, csj.d_week_seq, SUM(CASE WHEN pj.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN pj.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales_join csj JOIN inventory_join ij ON csj.cs_item_sk = ij.cs_item_sk JOIN warehouse_join wj ON ij.inv_warehouse_sk = wj.inv_warehouse_sk JOIN d2_join d2j ON ij.inv_item_sk = d2j.inv_item_sk JOIN d3_join d3j ON csj.cs_ship_date_sk = d3j.d_date_sk LEFT JOIN promotion_join pj ON csj.cs_item_sk = pj.cs_item_sk AND csj.cs_order_number = pj.cs_order_number LEFT JOIN catalog_returns cr ON csj.cs_item_sk = cr.cr_item_sk AND csj.cs_order_number = cr.cr_order_number GROUP BY csj.i_item_desc, wj.w_warehouse_name, csj.d_week_seq ORDER BY total_cnt DESC, csj.i_item_desc, wj.w_warehouse_name, csj.d_week_seq LIMIT 100