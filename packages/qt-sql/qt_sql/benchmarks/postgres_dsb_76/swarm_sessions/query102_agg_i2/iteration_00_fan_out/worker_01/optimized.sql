WITH filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)), filtered_customer AS (SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, hd.hd_vehicle_count FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk AND ca.ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA') INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk INNER JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998), filtered_web_sales AS (SELECT ws.ws_item_sk, ws.ws_bill_customer_sk, ws.ws_sold_date_sk, ws.ws_warehouse_sk FROM web_sales ws INNER JOIN filtered_item i ON ws.ws_item_sk = i.i_item_sk INNER JOIN filtered_customer c ON ws.ws_bill_customer_sk = c.c_customer_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk WHERE ws.ws_wholesale_cost BETWEEN 76 AND 96), filtered_store_sales AS (SELECT ss.ss_item_sk, ss.ss_customer_sk, ss.ss_quantity, ss.ss_sold_date_sk FROM store_sales ss INNER JOIN filtered_item i ON ss.ss_item_sk = i.i_item_sk INNER JOIN filtered_customer c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN filtered_dates d1 ON ss.ss_sold_date_sk = d1.d_date_sk), date_range AS (SELECT d1.d_date_sk AS d1_date_sk, d2.d_date_sk AS d2_date_sk FROM filtered_dates d1 CROSS JOIN date_dim d2 WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day')), joined_facts AS (SELECT c.cd_gender, c.cd_marital_status, c.cd_education_status, c.hd_vehicle_count FROM filtered_web_sales ws INNER JOIN filtered_store_sales ss ON ws.ws_item_sk = ss.ss_item_sk AND ws.ws_bill_customer_sk = ss.ss_customer_sk INNER JOIN date_range dr ON ss.ss_sold_date_sk = dr.d1_date_sk AND ws.ws_sold_date_sk = dr.d2_date_sk INNER JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk INNER JOIN store s ON s.s_state = w.w_state INNER JOIN inventory inv ON inv.inv_warehouse_sk = ws.ws_warehouse_sk AND inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk INNER JOIN filtered_customer c ON c.c_customer_sk = ss.ss_customer_sk WHERE inv.inv_quantity_on_hand >= ss.ss_quantity), final_aggregation AS (SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM joined_facts GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, cnt FROM final_aggregation