## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]  Cost: 100%  Rows: ~1K
    ├── [CTE] filtered_date  [+]
    │   └── SCAN date_dim (d_date between '1999-01-29' and '1999-01-29' + 90 days)
    ├── [CTE] filtered_item  [+]
    │   └── SCAN item (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))
    ├── [CTE] fact_prefilter  [+]
    │   ├── SCAN web_sales (ws_wholesale_cost BETWEEN 35 AND 55)
    │   └── JOIN INNER filtered_date (d_date_sk = ws_sold_date_sk)
    ├── [CTE] per_item_threshold  [+]
    │   └── AGGREGATE fact_prefilter (GROUP BY ws_item_sk, WHERE ws_sales_price/ws_list_price between 76*0.01 and 91*0.01)
    │       └── AGGREGATE: 1.3 * AVG(ws_ext_discount_amt) AS threshold
    ├── [CTE] main_join  [+]
    │   ├── JOIN filtered_item (i_item_sk = ws_item_sk)
    │   ├── JOIN fact_prefilter (i_item_sk = ws_item_sk)
    │   ├── JOIN per_item_threshold (fact_prefilter.ws_item_sk = per_item_threshold.ws_item_sk)
    │   └── FILTER (ws_ext_discount_amt > threshold)
    ├── [CTE] final_aggregate  [+]
    │   └── AGGREGATE main_join (SUM(ws_ext_discount_amt) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100)
    └── OUTPUT (Excess Discount Amount)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "inline_decorrelate_materialized", "description": "Replace correlated scalar subquery with CTE-based threshold join", "applied_to": ["per_item_threshold", "main_join"]},
    {"id": "R2", "type": "cte_materialization", "description": "Add MATERIALIZED to prevent correlated re-inlining", "applied_to": ["filtered_date", "filtered_item", "fact_prefilter", "per_item_threshold"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND (CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY')",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk, i_manufact_id, i_category FROM item WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))",
        "interfaces": {"outputs": ["i_item_sk", "i_manufact_id", "i_category"], "consumes": []}
      },
      "fact_prefilter": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws.ws_item_sk, ws.ws_sold_date_sk, ws.ws_ext_discount_amt, ws.ws_wholesale_cost, ws.ws_sales_price, ws.ws_list_price FROM web_sales ws INNER JOIN filtered_date fd ON fd.d_date_sk = ws.ws_sold_date_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55",
        "interfaces": {"outputs": ["ws_item_sk", "ws_sold_date_sk", "ws_ext_discount_amt", "ws_wholesale_cost", "ws_sales_price", "ws_list_price"], "consumes": ["filtered_date"]}
      },
      "per_item_threshold": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM fact_prefilter WHERE ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk",
        "interfaces": {"outputs": ["ws_item_sk", "threshold"], "consumes": ["fact_prefilter"]}
      },
      "main_join": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT fp.ws_ext_discount_amt FROM filtered_item fi INNER JOIN fact_prefilter fp ON fi.i_item_sk = fp.ws_item_sk INNER JOIN per_item_threshold pit ON fp.ws_item_sk = pit.ws_item_sk WHERE fp.ws_ext_discount_amt > pit.threshold",
        "interfaces": {"outputs": ["ws_ext_discount_amt"], "consumes": ["filtered_item", "fact_prefilter", "per_item_threshold"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM main_join ORDER BY SUM(ws_ext_discount_amt) ASC LIMIT 100",
        "interfaces": {"outputs": ["Excess Discount Amount"], "consumes": ["main_join"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "fact_prefilter", "per_item_threshold", "main_join", "main_query"],
    "assembly_template": "WITH filtered_date AS MATERIALIZED ({filtered_date}), filtered_item AS MATERIALIZED ({filtered_item}), fact_prefilter AS MATERIALIZED ({fact_prefilter}), per_item_threshold AS MATERIALIZED ({per_item_threshold}), main_join AS MATERIALIZED ({main_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": ["SET LOCAL work_mem = '512MB'"],
  "validation_checks": []
}
```

Changes: Replaced correlated scalar subquery with CTE-based threshold calculation and multi-CTE join. MATERIALIZED CTEs prevent PostgreSQL from re-inlining and re-executing the threshold calculation per outer row.

Expected speedup: 10-100x reduction in execution time by eliminating O(N²) correlated subquery execution and enabling efficient hash joins between pre-aggregated thresholds and fact data.