## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]
    ├── [=] filtered_dates CTE
    ├── [=] filtered_call_center CTE
    ├── [=] filtered_customer_demographics CTE
    ├── [=] filtered_household_demographics CTE
    ├── [=] filtered_customer_address CTE
    ├── [!] filtered_customer CTE (new, replaces joins to three dimensions)
    ├── [!] prefiltered_fact CTE (new, replaces comma joins with explicit JOINs)
    ├── [=] AGG (GROUP BY)
    ├── [=] SORT (SUM(cr_net_loss) DESC)
    └── [=] OUTPUT (Call_Center, Call_Center_Name, Manager, Returns_Loss)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL 16",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch", "description": "Pre-filter selective dimensions into CTEs to create tiny hash tables", "applied_to": ["filtered_dates", "filtered_call_center", "filtered_customer_demographics", "filtered_household_demographics", "filtered_customer_address"]},
    {"id": "R2", "type": "explicit_join_syntax", "description": "Convert comma-separated implicit joins to explicit JOIN syntax", "applied_to": ["filtered_customer", "prefiltered_fact"]},
    {"id": "R3", "type": "multi_dimension_consolidation", "description": "Combine three dimension joins into single filtered_customer CTE", "applied_to": ["filtered_customer"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_call_center": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cc_call_center_sk, cc_call_center_id, cc_name, cc_manager FROM call_center",
        "interfaces": {"outputs": ["cc_call_center_sk", "cc_call_center_id", "cc_name", "cc_manager"], "consumes": []}
      },
      "filtered_customer_demographics": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE ((cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree'))",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"], "consumes": []}
      },
      "filtered_household_demographics": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential LIKE '1001-5000%'",
        "interfaces": {"outputs": ["hd_demo_sk"], "consumes": []}
      },
      "filtered_customer_address": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -7",
        "interfaces": {"outputs": ["ca_address_sk"], "consumes": []}
      },
      "filtered_customer": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c.c_customer_sk, c.c_current_cdemo_sk, c.c_current_hdemo_sk, c.c_current_addr_sk, cd.cd_marital_status, cd.cd_education_status FROM customer c INNER JOIN filtered_customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk INNER JOIN filtered_household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk INNER JOIN filtered_customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk",
        "interfaces": {"outputs": ["c_customer_sk", "c_current_cdemo_sk", "c_current_hdemo_sk", "c_current_addr_sk", "cd_marital_status", "cd_education_status"], "consumes": ["filtered_customer_demographics", "filtered_household_demographics", "filtered_customer_address"]}
      },
      "prefiltered_fact": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cr.cr_net_loss, cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cust.cd_marital_status, cust.cd_education_status FROM catalog_returns cr INNER JOIN filtered_dates d ON cr.cr_returned_date_sk = d.d_date_sk INNER JOIN filtered_call_center cc ON cr.cr_call_center_sk = cc.cc_call_center_sk INNER JOIN filtered_customer cust ON cr.cr_returning_customer_sk = cust.c_customer_sk",
        "interfaces": {"outputs": ["cr_net_loss", "cc_call_center_id", "cc_name", "cc_manager", "cd_marital_status", "cd_education_status"], "consumes": ["filtered_dates", "filtered_call_center", "filtered_customer"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cc_call_center_id AS Call_Center, cc_name AS Call_Center_Name, cc_manager AS Manager, SUM(cr_net_loss) AS Returns_Loss FROM prefiltered_fact GROUP BY cc_call_center_id, cc_name, cc_manager, cd_marital_status, cd_education_status ORDER BY SUM(cr_net_loss) DESC",
        "interfaces": {"outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"], "consumes": ["prefiltered_fact"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_call_center", "filtered_customer_demographics", "filtered_household_demographics", "filtered_customer_address", "filtered_customer", "prefiltered_fact", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_call_center AS ({filtered_call_center}), filtered_customer_demographics AS ({filtered_customer_demographics}), filtered_household_demographics AS ({filtered_household_demographics}), filtered_customer_address AS ({filtered_customer_address}), filtered_customer AS ({filtered_customer}), prefiltered_fact AS ({prefiltered_fact}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Pre-filtered all selective dimensions into tiny CTEs, combined three customer dimension joins into a single filtered_customer CTE, and converted comma-separated implicit joins to explicit JOIN syntax. This creates small hash tables for dimension lookups while keeping the catalog_returns scan outside any materialized CTE for parallel execution.

**Expected speedup**: 2-4x from better hash join planning with tiny dimension tables and preserved parallelism on catalog_returns scan.