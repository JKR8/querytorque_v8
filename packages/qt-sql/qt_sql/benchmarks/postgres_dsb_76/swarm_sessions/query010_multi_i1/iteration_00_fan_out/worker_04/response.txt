## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~121K
    ├── [~] STRUCTURAL: Changed implicit comma joins to explicit CTE-driven pipeline
    ├── [~] SCAN: Replaced base table scans with pre-filtered CTEs (date_filter_cte, item_filter_cte, all_sales_union_cte)
    ├── [~] JOIN: Replaced customer-address-demographics implicit joins with explicit CTE chain
    ├── [~] FILTER: Consolidated three EXISTS subqueries into single UNION ALL CTE with channel checks
    ├── [=] AGG (GROUP BY) [unchanged]
    ├── [=] SORT (8 columns) [unchanged]
    └── [=] OUTPUT (14 columns) [unchanged]
    SUPPORTING CTEs:
    ├── [+] date_filter_cte: d_date_sk for Q3 1999
    ├── [+] item_filter_cte: i_item_sk for categories + manager_id
    ├── [+] all_sales_union_cte: UNION ALL of store/web/catalog sales with price ratio filters
    └── [+] customer_join: c_current_addr_sk, c_current_cdemo_sk filtered by birth_month and channel EXISTS
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "cte_pipeline", "description": "Replaced implicit joins with explicit CTE pipeline following target logical tree", "applied_to": ["all"]},
    {"id": "R2", "type": "union_consolidation", "description": "Consolidated three separate EXISTS subqueries into single UNION ALL CTE with channel checks", "applied_to": ["all_sales_union_cte"]},
    {"id": "R3", "type": "dimension_prefetch", "description": "Pushed date and item filters into reusable CTEs to avoid repeated scans", "applied_to": ["date_filter_cte", "item_filter_cte"]},
    {"id": "R4", "type": "exists_preservation", "description": "Preserved EXISTS semantics for channel checks (store AND (web OR catalog)) as per regression warnings", "applied_to": ["customer_join"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_filter_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "item_filter_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "all_sales_union_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ss_customer_sk AS customer_sk, 'store' AS channel FROM store_sales ss INNER JOIN date_filter_cte d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN item_filter_cte i ON ss.ss_item_sk = i.i_item_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 UNION ALL SELECT ws_bill_customer_sk AS customer_sk, 'web' AS channel FROM web_sales ws INNER JOIN date_filter_cte d ON ws.ws_sold_date_sk = d.d_date_sk INNER JOIN item_filter_cte i ON ws.ws_item_sk = i.i_item_sk WHERE ws.ws_sales_price / ws.ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 UNION ALL SELECT cs_ship_customer_sk AS customer_sk, 'catalog' AS channel FROM catalog_sales cs INNER JOIN date_filter_cte d ON cs.cs_sold_date_sk = d.d_date_sk INNER JOIN item_filter_cte i ON cs.cs_item_sk = i.i_item_sk WHERE cs.cs_sales_price / cs.cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01",
        "interfaces": {"outputs": ["customer_sk", "channel"], "consumes": ["date_filter_cte", "item_filter_cte"]}
      },
      "customer_join": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT DISTINCT c.c_current_addr_sk, c.c_current_cdemo_sk FROM customer c INNER JOIN all_sales_union_cte s ON c.c_customer_sk = s.customer_sk WHERE c.c_birth_month IN (1, 5) AND EXISTS (SELECT 1 FROM all_sales_union_cte s2 WHERE s2.customer_sk = c.c_customer_sk AND s2.channel = 'store') AND EXISTS (SELECT 1 FROM all_sales_union_cte s3 WHERE s3.customer_sk = c.c_customer_sk AND s3.channel IN ('web', 'catalog'))",
        "interfaces": {"outputs": ["c_current_addr_sk", "c_current_cdemo_sk"], "consumes": ["all_sales_union_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer_join cj INNER JOIN customer_address ca ON cj.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cj.c_current_cdemo_sk = cd.cd_demo_sk WHERE ca.ca_county IN ('Grays Harbor County', 'Kootenai County', 'Pike County', 'Thomas County', 'Uinta County') AND cd.cd_marital_status IN ('U', 'U', 'M') AND cd.cd_education_status IN ('College', 'Primary', '2 yr Degree') AND cd.cd_gender = 'M' GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"], "consumes": ["customer_join"]}
      }
    },
    "reconstruction_order": ["date_filter_cte", "item_filter_cte", "all_sales_union_cte", "customer_join", "main_query"],
    "assembly_template": "WITH date_filter_cte AS ({date_filter_cte}), item_filter_cte AS ({item_filter_cte}), all_sales_union_cte AS ({all_sales_union_cte}), customer_join AS ({customer_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL max_parallel_workers_per_gather = 2",
    "SET LOCAL work_mem = '16MB'",
    "SET LOCAL enable_nestloop = off"
  ],
  "validation_checks": []
}
```

**Changes**: Replaced implicit comma joins with explicit CTE pipeline, consolidating three separate EXISTS subqueries into a single UNION ALL CTE that scans each sales channel once with shared dimension filters, then filtering customers via EXISTS checks on the consolidated results.

**Expected speedup**: ~3-5x from eliminating redundant date_dim/item scans (from 9 to 3) and enabling parallel scans on large fact tables without CTE materialization barriers. The UNION ALL consolidation reduces total I/O while preserving the exact EXISTS semantics required by the original OR condition between web/catalog sales.