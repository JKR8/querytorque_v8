## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~121K
    ├── [~] CTE: filtered_store_sales_cte (added)
    ├── [~] CTE: filtered_web_sales_cte (added)  
    ├── [~] CTE: filtered_catalog_sales_cte (added)
    ├── [~] CTE: customer_join_cte (added - combines store sales + web/catalog OR logic)
    ├── [~] JOIN: customer_address (explicit JOIN syntax)
    ├── [~] JOIN: customer_demographics (explicit JOIN syntax)
    ├── [=] FILTER (ca_county IN (...))
    ├── [=] FILTER (c.c_birth_month IN (1, 5))
    ├── [=] FILTER (+3 more)
    ├── [=] AGG (GROUP BY)
    ├── [=] SORT (cd_gender ASC, ...)
    └── [=] OUTPUT (cd_gender, ...)
```

**Structural Changes:**
- **CTE-based pre-filtering**: Added three CTEs that filter fact tables with all dimension predicates early
- **Decoupled OR logic**: Preserved OR between web/catalog via LEFT JOIN + NULL check in customer_join_cte
- **Explicit JOIN syntax**: Converted comma-joins to explicit INNER JOINs for clarity
- **Parallel-safe**: CTEs marked NOT MATERIALIZED to avoid optimization fences

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL v16",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "pg_materialized_dimension_fact_prefilter",
      "description": "Pre-filter fact tables with dimension predicates before customer join",
      "applied_to": ["filtered_store_sales_cte", "filtered_web_sales_cte", "filtered_catalog_sales_cte"]
    },
    {
      "id": "R2", 
      "type": "early_filter_decorrelate",
      "description": "Push dimension filters into CTE definitions; convert EXISTS to semi-join via CTE",
      "applied_to": ["customer_join_cte", "filtered_store_sales_cte", "filtered_web_sales_cte", "filtered_catalog_sales_cte"]
    },
    {
      "id": "R3",
      "type": "explicit_join_syntax",
      "description": "Convert comma-joins to explicit INNER JOIN for clarity and planner hints",
      "applied_to": ["main_query"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_store_sales_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 8 AND 11 AND i.i_category IN ('Children', 'Electronics', 'Music') AND i.i_manager_id BETWEEN 66 AND 75 AND CASE WHEN ss.ss_list_price > 0 THEN ss.ss_sales_price / ss.ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 END",
        "interfaces": {"outputs": ["ss_customer_sk"], "consumes": []}
      },
      "filtered_web_sales_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ws.ws_bill_customer_sk FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 8 AND 11 AND i.i_category IN ('Children', 'Electronics', 'Music') AND i.i_manager_id BETWEEN 66 AND 75 AND CASE WHEN ws.ws_list_price > 0 THEN ws.ws_sales_price / ws.ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 END",
        "interfaces": {"outputs": ["ws_bill_customer_sk"], "consumes": []}
      },
      "filtered_catalog_sales_cte": {
        "type": "cte",
        "change": "modified", 
        "sql": "SELECT cs.cs_ship_customer_sk FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 8 AND 11 AND i.i_category IN ('Children', 'Electronics', 'Music') AND i.i_manager_id BETWEEN 66 AND 75 AND CASE WHEN cs.cs_list_price > 0 THEN cs.cs_sales_price / cs.cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 END",
        "interfaces": {"outputs": ["cs_ship_customer_sk"], "consumes": []}
      },
      "customer_join_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c.c_current_addr_sk, c.c_current_cdemo_sk FROM customer c INNER JOIN filtered_store_sales_cte ss ON c.c_customer_sk = ss.ss_customer_sk LEFT JOIN filtered_web_sales_cte ws ON c.c_customer_sk = ws.ws_bill_customer_sk LEFT JOIN filtered_catalog_sales_cte cs ON c.c_customer_sk = cs.cs_ship_customer_sk WHERE c.c_birth_month IN (1, 5) AND (ws.ws_bill_customer_sk IS NOT NULL OR cs.cs_ship_customer_sk IS NOT NULL)",
        "interfaces": {"outputs": ["c_current_addr_sk", "c_current_cdemo_sk"], "consumes": ["filtered_store_sales_cte", "filtered_web_sales_cte", "filtered_catalog_sales_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, COUNT(*) AS cnt1, cd.cd_purchase_estimate, COUNT(*) AS cnt2, cd.cd_credit_rating, COUNT(*) AS cnt3, cd.cd_dep_count, COUNT(*) AS cnt4, cd.cd_dep_employed_count, COUNT(*) AS cnt5, cd.cd_dep_college_count, COUNT(*) AS cnt6 FROM customer_join_cte cjc INNER JOIN customer_address ca ON cjc.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cjc.c_current_cdemo_sk = cd.cd_demo_sk WHERE ca.ca_county IN ('Grays Harbor County', 'Kootenai County', 'Pike County', 'Thomas County', 'Uinta County') AND cd.cd_marital_status IN ('U', 'M') AND cd.cd_education_status IN ('College', 'Primary', '2 yr Degree') AND cd.cd_gender = 'M' GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count ORDER BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count LIMIT 100",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"], "consumes": ["customer_join_cte"]}
      }
    },
    "reconstruction_order": ["filtered_store_sales_cte", "filtered_web_sales_cte", "filtered_catalog_sales_cte", "customer_join_cte", "main_query"],
    "assembly_template": "WITH filtered_store_sales_cte AS NOT MATERIALIZED ({filtered_store_sales_cte}), filtered_web_sales_cte AS NOT MATERIALIZED ({filtered_web_sales_cte}), filtered_catalog_sales_cte AS NOT MATERIALIZED ({filtered_catalog_sales_cte}), customer_join_cte AS NOT MATERIALIZED ({customer_join_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL enable_seqscan = off",
    "SET LOCAL max_parallel_workers_per_gather = 2",
    "SET LOCAL work_mem = '32MB'"
  ],
  "validation_checks": []
}
```

**Changes**: Restructured to pre-filter fact tables in parallelizable CTEs, preserved OR semantics via LEFT JOIN + NULL check, and converted to explicit JOIN syntax. All guards (CASE WHEN division) remain intact.

**Expected speedup**: ~1.5-2x from parallel fact table scans and reduced join cardinality. The NOT MATERIALIZED CTEs allow parallel execution, while the early filtering reduces fact table rows before expensive customer joins.

**Runtime config rationale**:
- `enable_seqscan = off`: Force index usage on dimension tables (date_dim, item) in CTEs
- `max_parallel_workers_per_gather = 2`: Allow parallel scans on large fact tables in CTEs
- `work_mem = '32MB'`: Support hash joins in CTEs without spilling; three concurrent hash joins in CTEs × 32MB = 96MB total, within 128MB shared_buffers