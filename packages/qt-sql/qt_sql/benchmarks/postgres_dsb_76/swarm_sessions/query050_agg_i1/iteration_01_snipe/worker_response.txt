## Logic Tree

```
[!] Main Query
  [-] Removed: date_dim d1 (sold date dimension)
  [~] Modified: join structure from comma-joins to explicit JOINs
  [~] Modified: date window condition from d1.d_date BETWEEN... to ss_sold_date_sk arithmetic
  [=] Preserved: store, store_sales, store_returns, date_dim d2 relationships
  [=] Preserved: all output columns and aggregation logic
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "date_sk_arithmetic_replacement",
      "description": "Replace d1.d_date BETWEEN condition with integer arithmetic on date_sk columns, eliminating join to date_dim d1",
      "applied_to": ["main_query"]
    },
    {
      "id": "R2", 
      "type": "explicit_join_conversion",
      "description": "Convert comma-joins to explicit JOIN syntax for better planner optimization",
      "applied_to": ["main_query"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip, SUM(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 30) AND (sr_returned_date_sk - ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 60) AND (sr_returned_date_sk - ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 90) AND (sr_returned_date_sk - ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM store_sales JOIN store_returns ON (ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk) JOIN store ON (ss_store_sk = s_store_sk) JOIN date_dim d2 ON (sr_returned_date_sk = d2.d_date_sk) WHERE d2.d_year = 2000 AND d2.d_moy = 8 AND ss_sold_date_sk >= d2.d_date_sk - 120 AND ss_sold_date_sk <= d2.d_date_sk GROUP BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip ORDER BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip LIMIT 100",
        "interfaces": {
          "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "consumes": []
        }
      }
    },
    "reconstruction_order": ["main_query"],
    "assembly_template": "{main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL work_mem = '32MB'",
    "SET LOCAL enable_nestloop = off",
    "SET LOCAL enable_hashjoin = on",
    "SET LOCAL enable_mergejoin = off"
  ],
  "validation_checks": []
}
```

**Changes**: Eliminated the expensive d1 date_dim join by replacing the date range condition with integer arithmetic on date_sk columns, and converted comma-joins to explicit JOIN syntax for better planner optimization.

**Expected speedup**: 2.5-3.0x by removing 92K index scans on date_dim d1 and eliminating the correlated date range filter.