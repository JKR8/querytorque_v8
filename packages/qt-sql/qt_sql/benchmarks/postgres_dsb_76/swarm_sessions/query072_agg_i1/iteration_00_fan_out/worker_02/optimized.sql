WITH core_filters AS (SELECT cs_item_sk, cs_promo_sk, cs_order_number, d1.d_week_seq, inv_warehouse_sk FROM catalog_sales JOIN date_dim d1 ON cs_sold_date_sk = d1.d_date_sk JOIN inventory ON inv_item_sk = cs_item_sk JOIN date_dim d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON cs_ship_date_sk = d3.d_date_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk WHERE d1.d_year = 1998 AND d1.d_week_seq = d2.d_week_seq AND d3.d_date > d1.d_date + interval '3 day' AND inv_quantity_on_hand < cs_quantity AND hd_buy_potential = '>10000' AND cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11 AND cs_wholesale_cost BETWEEN 35 AND 55), initial_aggregation AS (SELECT cs_item_sk, inv_warehouse_sk, d_week_seq, SUM(CASE WHEN cs_promo_sk IS NULL THEN 1 ELSE 0 END) as no_promo, SUM(CASE WHEN cs_promo_sk IS NOT NULL THEN 1 ELSE 0 END) as promo, COUNT(*) as total_cnt FROM core_filters GROUP BY cs_item_sk, inv_warehouse_sk, d_week_seq) SELECT i_item_desc, w_warehouse_name, agg.d_week_seq, agg.no_promo, agg.promo, agg.total_cnt FROM initial_aggregation agg JOIN item ON i_item_sk = agg.cs_item_sk JOIN warehouse ON w_warehouse_sk = agg.inv_warehouse_sk LEFT OUTER JOIN promotion p ON p.p_promo_sk = agg.cs_promo_sk LEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = agg.cs_item_sk AND cr.cr_order_number = agg.cs_order_number WHERE i_category IN ('Children', 'Jewelry', 'Men') ORDER BY agg.total_cnt DESC, i_item_desc, w_warehouse_name, agg.d_week_seq LIMIT 100