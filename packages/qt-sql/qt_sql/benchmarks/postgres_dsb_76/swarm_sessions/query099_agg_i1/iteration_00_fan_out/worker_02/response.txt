## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [~] core_cte (CTE)
│   ├── FROM: catalog_sales
│   ├── JOIN: INNER JOIN date_dim_prefilter ON cs_ship_date_sk = d_date_sk
│   ├── JOIN: INNER JOIN ship_mode_prefilter ON cs_ship_mode_sk = sm_ship_mode_sk
│   ├── JOIN: INNER JOIN call_center_prefilter ON cs_call_center_sk = cc_call_center_sk
│   ├── WHERE: cs_list_price BETWEEN 86 AND 115
│   └── OUTPUT: cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, sm_type, cc_name
├── [+] date_dim_prefilter (CTE)
│   ├── SCAN: date_dim
│   ├── WHERE: d_month_seq BETWEEN 1192 AND 1192 + 23
│   └── OUTPUT: d_date_sk
├── [+] ship_mode_prefilter (CTE)
│   ├── SCAN: ship_mode
│   ├── WHERE: sm_type = 'EXPRESS'
│   └── OUTPUT: sm_ship_mode_sk
├── [+] call_center_prefilter (CTE)
│   ├── SCAN: call_center
│   ├── WHERE: cc_class = 'small'
│   └── OUTPUT: cc_call_center_sk, cc_name
├── [=] aggregation_cte (CTE)
│   ├── FROM: core_cte
│   ├── GROUP BY: cs_warehouse_sk, sm_type, cc_name
│   └── AGGREGATE: 5 conditional SUMs
├── [~] warehouse_join (main query)
│   ├── FROM: aggregation_cte
│   ├── JOIN: INNER JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk
│   ├── WHERE: w_gmt_offset = -5
│   └── OUTPUT: substring(w_warehouse_name,1,20), sm_type, cc_name, "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"
├── [=] SORT
└── [=] LIMIT 100
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "pg_dimension_prefetch_star", "description": "Pre-filter selective dimension tables into CTEs to create tiny hash tables", "applied_to": ["date_dim_prefilter", "ship_mode_prefilter", "call_center_prefilter"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_dim_prefilter": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1192 AND 1192 + 23",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "ship_mode_prefilter": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT sm_ship_mode_sk FROM ship_mode WHERE sm_type = 'EXPRESS'",
        "interfaces": {"outputs": ["sm_ship_mode_sk"], "consumes": []}
      },
      "call_center_prefilter": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'small'",
        "interfaces": {"outputs": ["cc_call_center_sk", "cc_name"], "consumes": []}
      },
      "core_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cs.cs_ship_date_sk, cs.cs_sold_date_sk, cs.cs_warehouse_sk, 'EXPRESS' AS sm_type, cc.cc_name FROM catalog_sales cs INNER JOIN date_dim_prefilter dd ON cs.cs_ship_date_sk = dd.d_date_sk INNER JOIN ship_mode_prefilter sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk INNER JOIN call_center_prefilter cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE cs.cs_list_price BETWEEN 86 AND 115",
        "interfaces": {"outputs": ["cs_ship_date_sk", "cs_sold_date_sk", "cs_warehouse_sk", "sm_type", "cc_name"], "consumes": ["date_dim_prefilter", "ship_mode_prefilter", "call_center_prefilter"]}
      },
      "aggregation_cte": {
        "type": "cte",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["cs_warehouse_sk", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"], "consumes": ["core_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "WITH date_dim_prefilter AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1192 AND 1192 + 23), ship_mode_prefilter AS (SELECT sm_ship_mode_sk FROM ship_mode WHERE sm_type = 'EXPRESS'), call_center_prefilter AS (SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'small'), core_cte AS (SELECT cs.cs_ship_date_sk, cs.cs_sold_date_sk, cs.cs_warehouse_sk, 'EXPRESS' AS sm_type, cc.cc_name FROM catalog_sales cs INNER JOIN date_dim_prefilter dd ON cs.cs_ship_date_sk = dd.d_date_sk INNER JOIN ship_mode_prefilter sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk INNER JOIN call_center_prefilter cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE cs.cs_list_price BETWEEN 86 AND 115), aggregation_cte AS (SELECT cs_warehouse_sk, sm_type, cc_name, SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30 AND cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60 AND cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90 AND cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM core_cte GROUP BY cs_warehouse_sk, sm_type, cc_name) SELECT SUBSTRING(w.w_warehouse_name,1,20), agg.sm_type, agg.cc_name, agg.\"30 days\", agg.\"31-60 days\", agg.\"61-90 days\", agg.\"91-120 days\", agg.\">120 days\" FROM aggregation_cte agg INNER JOIN warehouse w ON agg.cs_warehouse_sk = w.w_warehouse_sk WHERE w.w_gmt_offset = -5 ORDER BY SUBSTRING(w.w_warehouse_name,1,20), agg.sm_type, agg.cc_name LIMIT 100",
        "interfaces": {"outputs": ["substring", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"], "consumes": ["aggregation_cte"]}
      }
    },
    "reconstruction_order": ["date_dim_prefilter", "ship_mode_prefilter", "call_center_prefilter", "core_cte", "aggregation_cte", "main_query"],
    "assembly_template": "WITH {date_dim_prefilter}, {ship_mode_prefilter}, {call_center_prefilter}, {core_cte}, {aggregation_cte} {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Pre-filtered selective dimension tables (date_dim, ship_mode, call_center) into separate CTEs before joining with the fact table, following the pg_dimension_prefetch_star pattern. This allows PostgreSQL to create tiny hash tables from pre-filtered dimensions for efficient hash joins.

**Expected speedup**: 3.32x (based on reference example performance improvement)