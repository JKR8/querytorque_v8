## Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_item  [+]  (new)
├── [CTE] filtered_date  [+]  (new)
├── [CTE] filtered_customer  [+]  (new)
├── [CTE] filtered_catalog_sales  [+]  (new)
├── [CTE] filtered_web_sales  [+]  (new)
├── [CTE] union_all  [+]  (new)
├── [CTE] my_customers  [~]  (now uses union_all)
├── [CTE] my_revenue  [=]  (unchanged, uses new my_customers)
├── [CTE] segments  [=]  (unchanged)
└── [MAIN] main_query  [=]  (unchanged)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "star_join_prefetch",
      "description": "Pre-filter all selective dimension tables into CTEs before joining with fact tables",
      "applied_to": ["filtered_item", "filtered_date", "filtered_customer", "filtered_catalog_sales", "filtered_web_sales"]
    },
    {
      "id": "R2",
      "type": "explicit_join_syntax",
      "description": "Convert comma-separated joins to explicit JOIN syntax",
      "applied_to": ["filtered_catalog_sales", "filtered_web_sales", "my_revenue"]
    },
    {
      "id": "R3",
      "type": "cte_column_completion",
      "description": "Add c_current_addr_sk to filtered_customer output and propagate through fact CTEs",
      "applied_to": ["filtered_customer", "filtered_catalog_sales", "filtered_web_sales", "union_all", "my_customers"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_item": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT i_item_sk FROM item WHERE i_category = 'Electronics' AND i_class = 'personal'",
          "interfaces": {
            "outputs": ["i_item_sk"],
            "consumes": []
          }
        },
        "filtered_date": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 1",
          "interfaces": {
            "outputs": ["d_date_sk"],
            "consumes": []
          }
        },
        "filtered_customer": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_year BETWEEN 1928 AND 1941",
          "interfaces": {
            "outputs": ["c_customer_sk", "c_current_addr_sk"],
            "consumes": []
          }
        },
        "filtered_catalog_sales": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT cs.cs_bill_customer_sk AS customer_sk, fc.c_current_addr_sk FROM catalog_sales cs INNER JOIN filtered_date fd ON cs.cs_sold_date_sk = fd.d_date_sk INNER JOIN filtered_item fi ON cs.cs_item_sk = fi.i_item_sk INNER JOIN filtered_customer fc ON cs.cs_bill_customer_sk = fc.c_customer_sk WHERE cs.cs_wholesale_cost BETWEEN 35 AND 65",
          "interfaces": {
            "outputs": ["customer_sk", "c_current_addr_sk"],
            "consumes": ["filtered_date", "filtered_item", "filtered_customer"]
          }
        },
        "filtered_web_sales": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT ws.ws_bill_customer_sk AS customer_sk, fc.c_current_addr_sk FROM web_sales ws INNER JOIN filtered_date fd ON ws.ws_sold_date_sk = fd.d_date_sk INNER JOIN filtered_item fi ON ws.ws_item_sk = fi.i_item_sk INNER JOIN filtered_customer fc ON ws.ws_bill_customer_sk = fc.c_customer_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 65",
          "interfaces": {
            "outputs": ["customer_sk", "c_current_addr_sk"],
            "consumes": ["filtered_date", "filtered_item", "filtered_customer"]
          }
        },
        "union_all": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT customer_sk, c_current_addr_sk FROM filtered_catalog_sales UNION ALL SELECT customer_sk, c_current_addr_sk FROM filtered_web_sales",
          "interfaces": {
            "outputs": ["customer_sk", "c_current_addr_sk"],
            "consumes": ["filtered_catalog_sales", "filtered_web_sales"]
          }
        },
        "my_customers": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT DISTINCT customer_sk AS c_customer_sk, c_current_addr_sk FROM union_all",
          "interfaces": {
            "outputs": ["c_customer_sk", "c_current_addr_sk"],
            "consumes": ["union_all"]
          }
        },
        "my_revenue": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers mc INNER JOIN store_sales ss ON mc.c_customer_sk = ss.ss_customer_sk INNER JOIN customer_address ca ON mc.c_current_addr_sk = ca.ca_address_sk INNER JOIN store s ON ca.ca_county = s.s_county AND ca.ca_state = s.s_state INNER JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE ss.ss_wholesale_cost BETWEEN 35 AND 65 AND s.s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d.d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk",
          "interfaces": {
            "outputs": ["c_customer_sk", "revenue"],
            "consumes": ["my_customers"]
          }
        },
        "segments": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": [],
            "consumes": []
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["segment", "num_customers", "segment_base"],
            "consumes": []
          }
        }
      },
      "reconstruction_order": [
        "filtered_item",
        "filtered_date",
        "filtered_customer",
        "filtered_catalog_sales",
        "filtered_web_sales",
        "union_all",
        "my_customers",
        "my_revenue",
        "segments",
        "main_query"
      ],
      "assembly_template": "WITH filtered_item AS ({filtered_item}), filtered_date AS ({filtered_date}), filtered_customer AS ({filtered_customer}), filtered_catalog_sales AS ({filtered_catalog_sales}), filtered_web_sales AS ({filtered_web_sales}), union_all AS ({union_all}), my_customers AS ({my_customers}), my_revenue AS ({my_revenue}), segments AS (SELECT CAST((revenue/50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment*50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL work_mem = '512MB'",
    "SET LOCAL enable_nestloop = off",
    "SET LOCAL enable_hashjoin = on",
    "SET LOCAL enable_mergejoin = off",
    "SET LOCAL max_parallel_workers_per_gather = 2",
    "SET LOCAL parallel_setup_cost = 1000",
    "SET LOCAL parallel_tuple_cost = 0.1"
  ],
  "validation_checks": []
}
```

**Changes**: Restructured to pre-filter dimension tables into CTEs before joining with fact tables, using explicit JOIN syntax and fixing the missing c_current_addr_sk column propagation. This allows PostgreSQL to build small hash tables from selective dimensions and probe fact tables efficiently.

**Expected speedup**: ~3x-4x (similar to pg_dimension_prefetch_star pattern) due to reduced dimension table scans, better join order control, and hash join optimization.

**Note**: The runtime configuration disables nested loops (which were causing slowness in the original comma joins), encourages hash joins with ample work_mem, and enables limited parallelism for the fact table scans.