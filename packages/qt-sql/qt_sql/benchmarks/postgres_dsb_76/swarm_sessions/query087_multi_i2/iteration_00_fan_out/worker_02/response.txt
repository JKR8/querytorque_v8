## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query [~] Cost: ~100% Rows: ~55K
    ├── [~] WITH filtered_dates AS ( ... )  -- CTE added
    ├── [~] WITH filtered_customers AS ( ... )  -- CTE added
    ├── [~] sales_union AS ( ... )  -- CTE added (UNION ALL)
    ├── [~] grouped_results AS ( ... )  -- CTE added (GROUP BY with conditional counts)
    ├── [~] filter_present_only_in_store AS ( ... )  -- CTE added
    └── [=] OUTPUT (COUNT(*))
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL 16",
  "rewrite_rules": [
    {"id": "R1", "type": "CTE_introduction", "description": "Replace comma joins with explicit INNER JOINs in CTEs", "applied_to": ["filtered_dates", "filtered_customers", "sales_union"]},
    {"id": "R2", "type": "semantic_restructuring", "description": "Transform EXCEPT to UNION ALL + GROUP BY + filtering", "applied_to": ["sales_union", "grouped_results", "filter_present_only_in_store"]},
    {"id": "R3", "type": "predicate_consolidation", "description": "Move shared date/customer filters to dedicated CTEs", "applied_to": ["filtered_dates", "filtered_customers"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "filtered_customers": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974",
        "interfaces": {"outputs": ["c_customer_sk", "c_last_name", "c_first_name"], "consumes": []}
      },
      "sales_union": {
        "type": "cte",
        "change": "modified",
        "sql": "(SELECT 'store' AS channel, fc.c_last_name, fc.c_first_name, fd.d_date FROM filtered_dates fd INNER JOIN store_sales ss ON ss.ss_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers fc ON ss.ss_customer_sk = fc.c_customer_sk WHERE ss.ss_list_price BETWEEN 168 AND 197 AND ss.ss_wholesale_cost BETWEEN 76 AND 86) UNION ALL (SELECT 'catalog' AS channel, fc.c_last_name, fc.c_first_name, fd.d_date FROM filtered_dates fd INNER JOIN catalog_sales cs ON cs.cs_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers fc ON cs.cs_bill_customer_sk = fc.c_customer_sk WHERE cs.cs_list_price BETWEEN 168 AND 197 AND cs.cs_wholesale_cost BETWEEN 76 AND 86) UNION ALL (SELECT 'web' AS channel, fc.c_last_name, fc.c_first_name, fd.d_date FROM filtered_dates fd INNER JOIN web_sales ws ON ws.ws_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers fc ON ws.ws_bill_customer_sk = fc.c_customer_sk WHERE ws.ws_list_price BETWEEN 168 AND 197 AND ws.ws_wholesale_cost BETWEEN 76 AND 86)",
        "interfaces": {"outputs": ["channel", "c_last_name", "c_first_name", "d_date"], "consumes": ["filtered_dates", "filtered_customers"]}
      },
      "grouped_results": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_last_name, c_first_name, d_date, COUNT(CASE WHEN channel = 'store' THEN 1 END) AS store_count, COUNT(CASE WHEN channel = 'catalog' THEN 1 END) AS catalog_count, COUNT(CASE WHEN channel = 'web' THEN 1 END) AS web_count FROM sales_union GROUP BY c_last_name, c_first_name, d_date",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "d_date", "store_count", "catalog_count", "web_count"], "consumes": ["sales_union"]}
      },
      "filter_present_only_in_store": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_last_name, c_first_name, d_date FROM grouped_results WHERE store_count > 0 AND catalog_count = 0 AND web_count = 0",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "d_date"], "consumes": ["grouped_results"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT COUNT(*) FROM filter_present_only_in_store",
        "interfaces": {"outputs": ["count"], "consumes": ["filter_present_only_in_store"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_customers", "sales_union", "grouped_results", "filter_present_only_in_store", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_customers AS ({filtered_customers}), sales_union AS ({sales_union}), grouped_results AS ({grouped_results}), filter_present_only_in_store AS ({filter_present_only_in_store}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Replaced comma joins with explicit INNER JOINs in CTEs, transformed EXCEPT to UNION ALL + GROUP BY + filtering, and moved shared date/customer filters to dedicated CTEs. This maintains exact EXCEPT semantics while enabling parallel-safe execution.

**Expected speedup**: ~1.2-1.5x due to CTE predicate pushdown and parallel-friendly UNION ALL structure, avoiding single-threaded materialization of large intermediate EXCEPT results.