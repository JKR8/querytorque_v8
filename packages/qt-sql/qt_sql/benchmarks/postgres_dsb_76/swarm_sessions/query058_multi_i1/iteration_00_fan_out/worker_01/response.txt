## Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] date_range_cte  [+]  (new dimension CTE)
├── [CTE] item_filtered_cte  [+]  (new dimension CTE)
├── [CTE] customer_filtered_cte  [+]  (new dimension CTE)
├── [CTE] ss_items  [~]  (changed FROM: comma joins → explicit JOINs with dimension CTEs)
│   ├── SCAN (store_sales)
│   ├── JOIN (date_range_cte ON ss_sold_date_sk = d_date_sk)
│   ├── JOIN (item_filtered_cte ON ss_item_sk = i_item_sk)
│   ├── JOIN (customer_filtered_cte ON ss_customer_sk = c_customer_sk)
│   ├── FILTER (ss_list_price BETWEEN 242 AND 271)
│   ├── AGG (GROUP BY i_item_id, c_birth_year)
│   └── OUTPUT (item_id, birth_year, ss_item_rev)
├── [CTE] cs_items  [~]  (changed FROM: comma joins → explicit JOINs with dimension CTEs)
│   ├── SCAN (catalog_sales)
│   ├── JOIN (date_range_cte ON cs_sold_date_sk = d_date_sk)
│   ├── JOIN (item_filtered_cte ON cs_item_sk = i_item_sk)
│   ├── JOIN (customer_filtered_cte ON cs_bill_customer_sk = c_customer_sk)
│   ├── FILTER (cs_list_price BETWEEN 242 AND 271)
│   ├── AGG (GROUP BY i_item_id, c_birth_year)
│   └── OUTPUT (item_id, birth_year, cs_item_rev)
├── [CTE] ws_items  [~]  (changed FROM: comma joins → explicit JOINs with dimension CTEs)
│   ├── SCAN (web_sales)
│   ├── JOIN (date_range_cte ON ws_sold_date_sk = d_date_sk)
│   ├── JOIN (item_filtered_cte ON ws_item_sk = i_item_sk)
│   ├── JOIN (customer_filtered_cte ON ws_bill_customer_sk = c_customer_sk)
│   ├── FILTER (ws_list_price BETWEEN 242 AND 271)
│   ├── AGG (GROUP BY i_item_id, c_birth_year)
│   └── OUTPUT (item_id, birth_year, ws_item_rev)
└── [MAIN] main_query  [=]  (unchanged structure)
    ├── SCAN (ss_items, cs_items, ws_items)
    ├── JOIN (ss_items.item_id = cs_items.item_id AND ss_items.birth_year = cs_items.birth_year)
    ├── JOIN (ss_items.item_id = ws_items.item_id AND ss_items.birth_year = ws_items.birth_year)
    ├── FILTER (6 pairwise revenue range checks)
    ├── COMPUTE (revenue percentages and average)
    ├── SORT (item_id, birth_year, ss_item_rev)
    └── OUTPUT (9 columns)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch", "description": "Materialize selective dimension filters into CTEs to create tiny hash tables", "applied_to": ["date_range_cte", "item_filtered_cte", "customer_filtered_cte"]},
    {"id": "R2", "type": "explicit_join", "description": "Convert comma-separated joins to explicit JOIN syntax for better cardinality estimation", "applied_to": ["ss_items", "cs_items", "ws_items"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_range_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "item_filtered_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_manager_id BETWEEN 71 AND 100",
        "interfaces": {"outputs": ["i_item_sk", "i_item_id"], "consumes": []}
      },
      "customer_filtered_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c_customer_sk, c_birth_year FROM customer WHERE c_birth_year BETWEEN 1945 AND 1951",
        "interfaces": {"outputs": ["c_customer_sk", "c_birth_year"], "consumes": []}
      },
      "ss_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item_filtered_cte.i_item_id AS item_id, customer_filtered_cte.c_birth_year AS birth_year, SUM(store_sales.ss_ext_sales_price) AS ss_item_rev FROM store_sales INNER JOIN date_range_cte ON store_sales.ss_sold_date_sk = date_range_cte.d_date_sk INNER JOIN item_filtered_cte ON store_sales.ss_item_sk = item_filtered_cte.i_item_sk INNER JOIN customer_filtered_cte ON store_sales.ss_customer_sk = customer_filtered_cte.c_customer_sk WHERE store_sales.ss_list_price BETWEEN 242 AND 271 GROUP BY item_filtered_cte.i_item_id, customer_filtered_cte.c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "ss_item_rev"], "consumes": ["date_range_cte", "item_filtered_cte", "customer_filtered_cte"]}
      },
      "cs_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item_filtered_cte.i_item_id AS item_id, customer_filtered_cte.c_birth_year AS birth_year, SUM(catalog_sales.cs_ext_sales_price) AS cs_item_rev FROM catalog_sales INNER JOIN date_range_cte ON catalog_sales.cs_sold_date_sk = date_range_cte.d_date_sk INNER JOIN item_filtered_cte ON catalog_sales.cs_item_sk = item_filtered_cte.i_item_sk INNER JOIN customer_filtered_cte ON catalog_sales.cs_bill_customer_sk = customer_filtered_cte.c_customer_sk WHERE catalog_sales.cs_list_price BETWEEN 242 AND 271 GROUP BY item_filtered_cte.i_item_id, customer_filtered_cte.c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "cs_item_rev"], "consumes": ["date_range_cte", "item_filtered_cte", "customer_filtered_cte"]}
      },
      "ws_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item_filtered_cte.i_item_id AS item_id, customer_filtered_cte.c_birth_year AS birth_year, SUM(web_sales.ws_ext_sales_price) AS ws_item_rev FROM web_sales INNER JOIN date_range_cte ON web_sales.ws_sold_date_sk = date_range_cte.d_date_sk INNER JOIN item_filtered_cte ON web_sales.ws_item_sk = item_filtered_cte.i_item_sk INNER JOIN customer_filtered_cte ON web_sales.ws_bill_customer_sk = customer_filtered_cte.c_customer_sk WHERE web_sales.ws_list_price BETWEEN 242 AND 271 GROUP BY item_filtered_cte.i_item_id, customer_filtered_cte.c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "ws_item_rev"], "consumes": ["date_range_cte", "item_filtered_cte", "customer_filtered_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["item_id", "birth_year", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"], "consumes": ["ss_items", "cs_items", "ws_items"]}
      }
    },
    "reconstruction_order": ["date_range_cte", "item_filtered_cte", "customer_filtered_cte", "ss_items", "cs_items", "ws_items", "main_query"],
    "assembly_template": "WITH date_range_cte AS ({date_range_cte}), item_filtered_cte AS ({item_filtered_cte}), customer_filtered_cte AS ({customer_filtered_cte}), ss_items AS ({ss_items}), cs_items AS ({cs_items}), ws_items AS ({ws_items}) SELECT ss_items.item_id, ss_items.birth_year, ss_items.ss_item_rev, ss_items.ss_item_rev/((ss_items.ss_item_rev+cs_items.cs_item_rev+ws_items.ws_item_rev)/3) * 100 ss_dev, cs_items.cs_item_rev, cs_items.cs_item_rev/((ss_items.ss_item_rev+cs_items.cs_item_rev+ws_items.ws_item_rev)/3) * 100 cs_dev, ws_items.ws_item_rev, ws_items.ws_item_rev/((ss_items.ss_item_rev+cs_items.cs_item_rev+ws_items.ws_item_rev)/3) * 100 ws_dev, (ss_items.ss_item_rev+cs_items.cs_item_rev+ws_items.ws_item_rev)/3 average FROM ss_items, cs_items, ws_items WHERE ss_items.item_id=cs_items.item_id AND ss_items.item_id=ws_items.item_id AND ss_items.birth_year = cs_items.birth_year AND ss_items.birth_year = ws_items.birth_year AND ss_items.ss_item_rev between 0.9 * cs_items.cs_item_rev and 1.1 * cs_items.cs_item_rev AND ss_items.ss_item_rev between 0.9 * ws_items.ws_item_rev and 1.1 * ws_items.ws_item_rev AND cs_items.cs_item_rev between 0.9 * ss_items.ss_item_rev and 1.1 * ss_items.ss_item_rev AND cs_items.cs_item_rev between 0.9 * ws_items.ws_item_rev and 1.1 * ws_items.ws_item_rev AND ws_items.ws_item_rev between 0.9 * ss_items.ss_item_rev and 1.1 * ss_items.ss_item_rev AND ws_items.ws_item_rev between 0.9 * cs_items.cs_item_rev and 1.1 * cs_items.cs_item_rev ORDER BY item_id, birth_year, ss_item_rev LIMIT 100"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Pre‑filtered date, item, and customer dimensions into materialized CTEs, then converted all comma‑separated fact‑table joins to explicit INNER JOINs against those CTEs. This eliminates correlated date subqueries, prevents repeated dimension scans, and gives PostgreSQL's optimizer clean small hash tables for joining.

**Expected speedup**: 2–3× from eliminating correlated subqueries and enabling better join planning with explicit JOIN syntax.