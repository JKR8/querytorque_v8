## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query [!] Structural change: CTE-based pre-filtering + LATERAL fact reduction
    ├── CTE dim_date [!] Materialized dimension pre-filter (was inline filter)
    ├── CTE dim_cd1 [!] Materialized dimension pre-filter (was inline filter)
    ├── CTE dim_cd2 [!] Materialized dimension pre-filter (was inline filter)
    ├── CTE dim_addr [!] Materialized dimension pre-filter (was inline filter)
    ├── CTE lateral_fact_join [!] LATERAL join with combined OR matrix
    ├── JOIN reason [=] wr_reason_sk = r_reason_sk
    ├── JOIN web_page [=] ws_web_page_sk = wp_web_page_sk
    ├── AGG [=] GROUP BY r_reason_desc
    ├── SORT [=] ORDER BY substring, averages
    └── LIMIT [=] 100
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch", "description": "Extract selective dimension filters into MATERIALIZED CTEs", "applied_to": ["dim_date", "dim_cd1", "dim_cd2", "dim_addr"]},
    {"id": "R2", "type": "staged_reduction", "description": "Use LATERAL to push dimension keys and OR matrix into fact table early", "applied_to": ["lateral_fact_join"]},
    {"id": "R3", "type": "materialized_cte", "description": "MATERIALIZED hints to prevent inlining and force hash table builds", "applied_to": ["dim_date", "dim_cd1", "dim_cd2", "dim_addr"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "dim_date": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "dim_cd1": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"], "consumes": []}
      },
      "dim_cd2": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"], "consumes": []}
      },
      "dim_addr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ca_address_sk FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('NC','PA','TX')) OR (ca_country = 'United States' AND ca_state IN ('AR','CO','NY')) OR (ca_country = 'United States' AND ca_state IN ('IA','IL','TX'))",
        "interfaces": {"outputs": ["ca_address_sk"], "consumes": []}
      },
      "lateral_fact_join": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT f.wr_reason_sk, f.ws_web_page_sk, f.ws_quantity, f.wr_refunded_cash, f.wr_fee FROM dim_date dd, dim_cd1 cd1, dim_cd2 cd2, dim_addr ca, LATERAL (SELECT ws_quantity, wr_refunded_cash, wr_fee, wr_reason_sk, ws_web_page_sk FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number WHERE ws_sold_date_sk = dd.d_date_sk AND wr_refunded_cdemo_sk = cd1.cd_demo_sk AND wr_returning_cdemo_sk = cd2.cd_demo_sk AND wr_refunded_addr_sk = ca.ca_address_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status AND ((cd1.cd_marital_status = 'S' AND ws_sales_price BETWEEN 100.00 AND 150.00 AND ws_net_profit BETWEEN 100 AND 200) OR (cd1.cd_marital_status = 'W' AND ws_sales_price BETWEEN 50.00 AND 100.00 AND ws_net_profit BETWEEN 150 AND 300) OR (cd1.cd_marital_status = 'M' AND ws_sales_price BETWEEN 150.00 AND 200.00 AND ws_net_profit BETWEEN 50 AND 250))) f",
        "interfaces": {"outputs": ["wr_reason_sk", "ws_web_page_sk", "ws_quantity", "wr_refunded_cash", "wr_fee"], "consumes": ["dim_date", "dim_cd1", "dim_cd2", "dim_addr"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT SUBSTRING(r.r_reason_desc,1,20), AVG(f.ws_quantity), AVG(f.wr_refunded_cash), AVG(f.wr_fee) FROM lateral_fact_join f JOIN reason r ON f.wr_reason_sk = r.r_reason_sk JOIN web_page wp ON f.ws_web_page_sk = wp.wp_web_page_sk GROUP BY r.r_reason_desc ORDER BY SUBSTRING(r.r_reason_desc,1,20), AVG(f.ws_quantity), AVG(f.wr_refunded_cash), AVG(f.wr_fee) LIMIT 100",
        "interfaces": {"outputs": ["substring", "avg_ws_quantity", "avg_wr_refunded_cash", "avg_wr_fee"], "consumes": ["lateral_fact_join"]}
      }
    },
    "reconstruction_order": ["dim_date", "dim_cd1", "dim_cd2", "dim_addr", "lateral_fact_join", "main_query"],
    "assembly_template": "WITH dim_date AS MATERIALIZED ({dim_date}), dim_cd1 AS MATERIALIZED ({dim_cd1}), dim_cd2 AS MATERIALIZED ({dim_cd2}), dim_addr AS MATERIALIZED ({dim_addr}), lateral_fact_join AS ({lateral_fact_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Created MATERIALIZED CTEs for each dimension table with their respective filters, then used LATERAL to push dimension keys and the combined OR matrix into the fact table join, enabling early filtering before joining with reason and web_page. This reduces the fact table probe size dramatically.

**Expected speedup**: 2-3× due to reduced nested loop iterations and better cardinality estimation from materialized small dimension sets.