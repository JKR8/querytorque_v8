**Part 1: Modified Logic Tree**

```
QUERY: (single statement)
├── [CTE] date_keys  [!]  (replaces date subqueries)
│   ├── SCAN (date_dim d1, date_dim d2 (self-join))
│   ├── JOIN (d1.d_month_seq = d2.d_month_seq)
│   ├── FILTER (d2.d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))
│   └── OUTPUT (d_date_sk, d_date)
├── [CTE] filtered_items  [!]  (replaces item filters in each CTE)
│   ├── SCAN (item)
│   ├── FILTER (i_category IN ('Home','Men') AND i_manager_id BETWEEN 8 AND 17)
│   └── OUTPUT (i_item_sk, i_item_id)
├── [CTE] consolidated_aggregates  [!]  (replaces sr_items, cr_items, wr_items)
│   ├── SCAN (store_returns, catalog_returns, web_returns) [UNION ALL with NULL padding]
│   ├── JOIN (all three fact tables with date_keys and filtered_items)
│   ├── AGG (GROUP BY i_item_sk with CASE per channel)
│   ├── JOIN (back to filtered_items for i_item_id)
│   └── OUTPUT (item_id, sr_item_qty, cr_item_qty, wr_item_qty)
└── [MAIN] main_query  [!]  (modified)
    ├── SCAN (consolidated_aggregates)
    ├── FILTER (sr_item_qty IS NOT NULL AND cr_item_qty IS NOT NULL AND wr_item_qty IS NOT NULL)
    ├── COMPUTE (sr_dev, cr_dev, wr_dev, average)
    ├── SORT (item_id, sr_item_qty)
    └── OUTPUT (item_id, sr_item_qty, sr_dev, cr_item_qty, cr_dev, wr_item_qty, wr_dev, average)
```

**Part 2: Component Payload JSON**

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL v16.11",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "single_pass_aggregation",
      "description": "Replaced three separate CTEs with UNION ALL + CASE aggregation to compute all channel sums in one pass",
      "applied_to": ["consolidated_aggregates"]
    },
    {
      "id": "R2",
      "type": "materialized_cte",
      "description": "Used MATERIALIZED on date_keys and filtered_items to prevent re-execution per UNION ALL branch",
      "applied_to": ["date_keys", "filtered_items"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_keys": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d1.d_date_sk, d1.d_date FROM date_dim d1 INNER JOIN date_dim d2 ON d1.d_month_seq = d2.d_month_seq WHERE d2.d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')",
        "interfaces": {
          "outputs": ["d_date_sk", "d_date"],
          "consumes": []
        }
      },
      "filtered_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category IN ('Home','Men') AND i_manager_id BETWEEN 8 AND 17",
        "interfaces": {
          "outputs": ["i_item_sk", "i_item_id"],
          "consumes": []
        }
      },
      "consolidated_aggregates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT filtered_items.i_item_id AS item_id, NULLIF(agg.sr_qty, 0) AS sr_item_qty, NULLIF(agg.cr_qty, 0) AS cr_item_qty, NULLIF(agg.wr_qty, 0) AS wr_item_qty FROM (SELECT i_item_sk, SUM(CASE WHEN sr_return_amt / sr_return_quantity BETWEEN 237 AND 266 AND sr_reason_sk IN (6,7,25,45,51) THEN sr_return_quantity ELSE 0 END) AS sr_qty, SUM(CASE WHEN cr_return_amount / cr_return_quantity BETWEEN 237 AND 266 AND cr_reason_sk IN (6,7,25,45,51) THEN cr_return_quantity ELSE 0 END) AS cr_qty, SUM(CASE WHEN wr_return_amt / wr_return_quantity BETWEEN 237 AND 266 AND wr_reason_sk IN (6,7,25,45,51) THEN wr_return_quantity ELSE 0 END) AS wr_qty FROM (SELECT i_item_sk, sr_return_quantity, sr_return_amt, sr_reason_sk, NULL::numeric AS cr_return_quantity, NULL::numeric AS cr_return_amount, NULL::integer AS cr_reason_sk, NULL::integer AS wr_return_quantity, NULL::numeric AS wr_return_amt, NULL::integer AS wr_reason_sk FROM store_returns INNER JOIN date_keys ON sr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON sr_item_sk = i_item_sk UNION ALL SELECT i_item_sk, NULL, NULL, NULL, cr_return_quantity, cr_return_amount, cr_reason_sk, NULL, NULL, NULL FROM catalog_returns INNER JOIN date_keys ON cr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON cr_item_sk = i_item_sk UNION ALL SELECT i_item_sk, NULL, NULL, NULL, NULL, NULL, NULL, wr_return_quantity, wr_return_amt, wr_reason_sk FROM web_returns INNER JOIN date_keys ON wr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON wr_item_sk = i_item_sk) combined GROUP BY i_item_sk) agg INNER JOIN filtered_items ON agg.i_item_sk = filtered_items.i_item_sk",
        "interfaces": {
          "outputs": ["item_id", "sr_item_qty", "cr_item_qty", "wr_item_qty"],
          "consumes": ["date_keys", "filtered_items"]
        }
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT item_id, sr_item_qty, sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS sr_dev, cr_item_qty, cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS cr_dev, wr_item_qty, wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS wr_dev, (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average FROM consolidated_aggregates WHERE sr_item_qty IS NOT NULL AND cr_item_qty IS NOT NULL AND wr_item_qty IS NOT NULL ORDER BY item_id, sr_item_qty LIMIT 100",
        "interfaces": {
          "outputs": ["item_id", "sr_item_qty", "sr_dev", "cr_item_qty", "cr_dev", "wr_item_qty", "wr_dev", "average"],
          "consumes": ["consolidated_aggregates"]
        }
      }
    },
    "reconstruction_order": ["date_keys", "filtered_items", "consolidated_aggregates", "main_query"],
    "assembly_template": "WITH date_keys AS MATERIALIZED ({date_keys}), filtered_items AS MATERIALIZED ({filtered_items}), consolidated_aggregates AS ({consolidated_aggregates}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes:** Replaced three separate CTEs with a single-pass aggregation using UNION ALL + CASE, extracting shared date and item filters into materialized CTEs. Preserved all original filters, division guards, and INNER JOIN semantics.

**Expected speedup:** 2-3× from eliminating repeated scans of date_dim/item and reducing intermediate aggregation materialization.