WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12), store_sales_filtered AS (SELECT ss_customer_sk AS customer_sk, 'store' AS channel FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk WHERE ss_list_price BETWEEN 80 AND 169), web_sales_filtered AS (SELECT ws_bill_customer_sk AS customer_sk, 'web' AS channel FROM web_sales JOIN filtered_date ON ws_sold_date_sk = d_date_sk WHERE ws_list_price BETWEEN 80 AND 169), catalog_sales_filtered AS (SELECT cs_ship_customer_sk AS customer_sk, 'catalog' AS channel FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = d_date_sk WHERE cs_list_price BETWEEN 80 AND 169), all_sales_union AS (SELECT customer_sk, channel FROM store_sales_filtered UNION ALL SELECT customer_sk, channel FROM web_sales_filtered UNION ALL SELECT customer_sk, channel FROM catalog_sales_filtered), customer_channel_flags AS (SELECT customer_sk, MAX(CASE WHEN channel = 'store' THEN 1 ELSE 0 END) AS has_store, MAX(CASE WHEN channel = 'web' THEN 1 ELSE 0 END) AS has_web, MAX(CASE WHEN channel = 'catalog' THEN 1 ELSE 0 END) AS has_catalog FROM all_sales_union GROUP BY customer_sk), customer_base AS (SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('CO','NC','TX') AND cd.cd_marital_status IN ('S','M','U') AND cd.cd_education_status IN ('Primary','College')), filter_flags AS (SELECT cb.cd_gender, cb.cd_marital_status, cb.cd_education_status, cb.cd_purchase_estimate, cb.cd_credit_rating FROM customer_base cb JOIN customer_channel_flags ccf ON cb.c_customer_sk = ccf.customer_sk WHERE ccf.has_store = 1 AND ccf.has_web = 0 AND ccf.has_catalog = 0) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3 FROM filter_flags GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100