## Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [=]  Cost: 100%  Rows: ~39K
    ├── [~] filtered_sales_cte  [Materialized CTE with early wholesale_cost filter]
    ├── [~] date_cte  [Materialized CTE with d_year filter]
    ├── [~] join_date_cte  [INNER JOIN of filtered_sales + date_cte]
    ├── [~] item_cte  [Materialized CTE with i_category filter]
    ├── [~] join_item_cte  [INNER JOIN of join_date + item_cte]
    ├── [~] cd_cte  [Materialized CTE with gender+education filters]
    ├── [~] join_cd_cte  [INNER JOIN of join_item + cd_cte]
    ├── [~] customer_cte  [Materialized CTE with birth_month filter]
    ├── [~] join_customer_cte  [INNER JOIN of join_cd + customer_cte]
    ├── [~] ca_cte  [Materialized CTE with state filter]
    ├── [~] join_ca_cte  [INNER JOIN of join_customer + ca_cte]
    ├── [=] AGG (GROUP BY ROLLUP)
    ├── [=] SORT (ca_country, ca_state, ca_county, i_item_id)
    └── [=] OUTPUT (i_item_id, ca_country, ca_state, ca_county, agg1-agg6)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "early_filter_decorrelate", "description": "Push dimension table filters into materialized CTEs before joining", "applied_to": ["filtered_sales_cte", "date_cte", "item_cte", "cd_cte", "customer_cte", "ca_cte"]},
    {"id": "R2", "type": "pushdown", "description": "Apply cs_wholesale_cost filter at earliest point in catalog_sales scan", "applied_to": ["filtered_sales_cte"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_sales_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cs_sold_date_sk, cs_item_sk, cs_bill_cdemo_sk, cs_bill_customer_sk, cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 41 AND 46",
        "interfaces": {"outputs": ["cs_sold_date_sk", "cs_item_sk", "cs_bill_cdemo_sk", "cs_bill_customer_sk", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit"], "consumes": []}
      },
      "date_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "join_date_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT f.cs_item_sk, f.cs_bill_cdemo_sk, f.cs_bill_customer_sk, f.cs_quantity, f.cs_list_price, f.cs_coupon_amt, f.cs_sales_price, f.cs_net_profit FROM filtered_sales_cte f INNER JOIN date_cte d ON f.cs_sold_date_sk = d.d_date_sk",
        "interfaces": {"outputs": ["cs_item_sk", "cs_bill_cdemo_sk", "cs_bill_customer_sk", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit"], "consumes": ["filtered_sales_cte", "date_cte"]}
      },
      "item_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Sports'",
        "interfaces": {"outputs": ["i_item_sk", "i_item_id"], "consumes": []}
      },
      "join_item_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i.i_item_id, j.cs_bill_cdemo_sk, j.cs_bill_customer_sk, j.cs_quantity, j.cs_list_price, j.cs_coupon_amt, j.cs_sales_price, j.cs_net_profit FROM join_date_cte j INNER JOIN item_cte i ON j.cs_item_sk = i.i_item_sk",
        "interfaces": {"outputs": ["i_item_id", "cs_bill_cdemo_sk", "cs_bill_customer_sk", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit"], "consumes": ["join_date_cte", "item_cte"]}
      },
      "cd_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = 'College'",
        "interfaces": {"outputs": ["cd_demo_sk"], "consumes": []}
      },
      "join_cd_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT j.i_item_id, j.cs_bill_customer_sk, j.cs_quantity, j.cs_list_price, j.cs_coupon_amt, j.cs_sales_price, j.cs_net_profit FROM join_item_cte j INNER JOIN cd_cte c ON j.cs_bill_cdemo_sk = c.cd_demo_sk",
        "interfaces": {"outputs": ["i_item_id", "cs_bill_customer_sk", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit"], "consumes": ["join_item_cte", "cd_cte"]}
      },
      "customer_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_customer_sk, c_current_addr_sk, c_birth_year FROM customer WHERE c_birth_month = 2",
        "interfaces": {"outputs": ["c_customer_sk", "c_current_addr_sk", "c_birth_year"], "consumes": []}
      },
      "join_customer_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT j.i_item_id, c.c_current_addr_sk, c.c_birth_year, j.cs_quantity, j.cs_list_price, j.cs_coupon_amt, j.cs_sales_price, j.cs_net_profit FROM join_cd_cte j INNER JOIN customer_cte c ON j.cs_bill_customer_sk = c.c_customer_sk",
        "interfaces": {"outputs": ["i_item_id", "c_current_addr_sk", "c_birth_year", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit"], "consumes": ["join_cd_cte", "customer_cte"]}
      },
      "ca_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ca_address_sk, ca_country, ca_state, ca_county FROM customer_address WHERE ca_state IN ('AR', 'NY', 'TX')",
        "interfaces": {"outputs": ["ca_address_sk", "ca_country", "ca_state", "ca_county"], "consumes": []}
      },
      "join_ca_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT j.i_item_id, ca.ca_country, ca.ca_state, ca.ca_county, j.cs_quantity, j.cs_list_price, j.cs_coupon_amt, j.cs_sales_price, j.cs_net_profit, j.c_birth_year FROM join_customer_cte j INNER JOIN ca_cte ca ON j.c_current_addr_sk = ca.ca_address_sk",
        "interfaces": {"outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit", "c_birth_year"], "consumes": ["join_customer_cte", "ca_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_item_id, ca_country, ca_state, ca_county, avg(cast(cs_quantity as decimal(12,2))) as agg1, avg(cast(cs_list_price as decimal(12,2))) as agg2, avg(cast(cs_coupon_amt as decimal(12,2))) as agg3, avg(cast(cs_sales_price as decimal(12,2))) as agg4, avg(cast(cs_net_profit as decimal(12,2))) as agg5, avg(cast(c_birth_year as decimal(12,2))) as agg6 FROM join_ca_cte GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county) ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100",
        "interfaces": {"outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"], "consumes": ["join_ca_cte"]}
      }
    },
    "reconstruction_order": ["filtered_sales_cte", "date_cte", "join_date_cte", "item_cte", "join_item_cte", "cd_cte", "join_cd_cte", "customer_cte", "join_customer_cte", "ca_cte", "join_ca_cte", "main_query"],
    "assembly_template": "WITH filtered_sales_cte AS ({filtered_sales_cte}), date_cte AS ({date_cte}), join_date_cte AS ({join_date_cte}), item_cte AS ({item_cte}), join_item_cte AS ({join_item_cte}), cd_cte AS ({cd_cte}), join_cd_cte AS ({join_cd_cte}), customer_cte AS ({customer_cte}), join_customer_cte AS ({join_customer_cte}), ca_cte AS ({ca_cte}), join_ca_cte AS ({join_ca_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": ["SET LOCAL max_parallel_workers_per_gather = 2", "SET LOCAL work_mem = '16MB'", "SET LOCAL enable_nestloop = off", "SET LOCAL enable_hashjoin = on", "SET LOCAL jit = off"],
  "validation_checks": []
}
```

**Changes**: Restructured to follow exact CTE chain from target logical tree, materializing filtered dimension tables early while preserving INNER JOIN semantics and duplicate-sensitive aggregates. Each CTE produces exactly the columns needed downstream.

**Expected speedup**: 1.2-1.5x from early filtering reducing join sizes, though materialization overhead may offset some gains. CTE approach ensures predictable join order and prevents cardinality estimation errors from comma joins.