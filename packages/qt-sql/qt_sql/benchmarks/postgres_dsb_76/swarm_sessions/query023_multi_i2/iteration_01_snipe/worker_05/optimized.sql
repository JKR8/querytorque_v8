WITH date_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999), item_filtered AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports')), customer_filtered AS (SELECT c_customer_sk, c_birth_year FROM customer WHERE c_birth_year BETWEEN 1987 AND 1993), store_sales_base AS (SELECT ss.ss_item_sk, ss.ss_sold_date_sk, df.d_date, if.i_item_desc, ss.ss_customer_sk, cf.c_birth_year, ss.ss_quantity, ss.ss_sales_price, ss.ss_wholesale_cost FROM store_sales ss INNER JOIN date_filtered df ON ss.ss_sold_date_sk = df.d_date_sk INNER JOIN item_filtered if ON ss.ss_item_sk = if.i_item_sk LEFT JOIN customer_filtered cf ON ss.ss_customer_sk = cf.c_customer_sk), frequent_ss_items AS (SELECT SUBSTRING(i_item_desc FROM 1 FOR 30) AS itemdesc, ss_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales_base GROUP BY SUBSTRING(i_item_desc FROM 1 FOR 30), ss_item_sk, d_date HAVING COUNT(*) > 4), customer_aggregates AS (SELECT ss_customer_sk, SUM(CASE WHEN ss_wholesale_cost BETWEEN 26 AND 36 THEN ss_quantity * ss_sales_price END) AS csales, SUM(CASE WHEN c_birth_year BETWEEN 1987 AND 1993 THEN ss_quantity * ss_sales_price END) AS ssales FROM store_sales_base GROUP BY ss_customer_sk), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM customer_aggregates), best_ss_customer AS (SELECT ca.ss_customer_sk AS c_customer_sk FROM customer_aggregates ca CROSS JOIN max_store_sales mss WHERE ca.ssales > (95/100.0) * mss.tpcds_cmax) SELECT SUM(sales) FROM (SELECT cs.cs_quantity * cs.cs_list_price AS sales FROM catalog_sales cs INNER JOIN date_dim d1 ON cs.cs_sold_date_sk = d1.d_date_sk INNER JOIN frequent_ss_items fsi ON cs.cs_item_sk = fsi.item_sk INNER JOIN best_ss_customer bsc ON cs.cs_bill_customer_sk = bsc.c_customer_sk WHERE d1.d_year = 1999 AND d1.d_moy = 5 AND cs.cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws.ws_quantity * ws.ws_list_price AS sales FROM web_sales ws INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk INNER JOIN frequent_ss_items fsi ON ws.ws_item_sk = fsi.item_sk INNER JOIN best_ss_customer bsc ON ws.ws_bill_customer_sk = bsc.c_customer_sk WHERE d2.d_year = 1999 AND d2.d_moy = 5 AND ws.ws_wholesale_cost BETWEEN 26 AND 36) tmp2 LIMIT 100