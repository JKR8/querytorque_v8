### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]
    ├── CTE_WITH date_filter  [+]  (d_date_sk)
    │   └── SCAN date_dim
    │       └── FILTER (d_year = 2002)
    ├── CTE_WITH web_sales_base  [+]  (ws_item_sk, ws_order_number, ws_web_page_sk, ws_quantity, ws_sales_price, ws_net_profit)
    │   └── JOIN (web_sales INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk)
    │       └── FILTER (ws_sales_price BETWEEN 50.00 AND 200.00)
    ├── CTE_WITH web_returns_joined  [+]  (r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee, cd_marital_status, cd_education_status, ca_state, ws_sales_price, ws_net_profit)
    │   └── JOIN web_returns
    │       ├── INNER JOIN web_sales_base ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)
    │       ├── INNER JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk
    │       ├── INNER JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk
    │       ├── INNER JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk
    │       ├── INNER JOIN reason ON r_reason_sk = wr_reason_sk
    │       └── INNER JOIN web_page ON wp_web_page_sk = ws_web_page_sk
    ├── CTE_WITH conditional_filter  [+]  (r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee)
    │   └── FROM web_returns_joined
    │       └── FILTER (
    │           CASE 
    │               WHEN cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ws_sales_price BETWEEN 100.00 AND 150.00 
    │                 THEN (ca_country = 'United States' AND ca_state IN ('KY','NC','SD') AND ws_net_profit BETWEEN 100 AND 200)
    │               WHEN cd_marital_status = 'M' AND cd_education_status = 'Secondary' AND ws_sales_price BETWEEN 50.00 AND 100.00 
    │                 THEN (ca_country = 'United States' AND ca_state IN ('AR','GA','IN') AND ws_net_profit BETWEEN 150 AND 300)
    │               WHEN cd_marital_status = 'U' AND cd_education_status = '2 yr Degree' AND ws_sales_price BETWEEN 150.00 AND 200.00 
    │                 THEN (ca_country = 'United States' AND ca_state IN ('KS','OH','VA') AND ws_net_profit BETWEEN 50 AND 250)
    │               ELSE FALSE
    │           END
    │           AND cd1.cd_marital_status = cd2.cd_marital_status
    │           AND cd1.cd_education_status = cd2.cd_education_status
    │         )
    └── CTE_WITH main_aggregation  [+]  (substring_reason_desc, avg_ws_quantity, avg_wr_refunded_cash, avg_wr_fee)
        └── FROM conditional_filter
            ├── AGG (GROUP BY r_reason_desc)
            ├── AGGREGATE (AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee))
            ├── SORT (SUBSTRING(r_reason_desc FROM 1 FOR 20) ASC, AVG(ws_quantity) ASC, AVG(wr_refunded_cash) ASC, AVG(wr_fee) ASC)
            └── LIMIT 100
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "cte_decomposition", "description": "Decomposed single-block query into CTEs following target logical tree", "applied_to": ["date_filter", "web_sales_base", "web_returns_joined", "conditional_filter", "main_aggregation"]},
    {"id": "R2", "type": "predicate_restructuring", "description": "Transformed OR conditions into CASE expression with branch-local filters and moved equality predicates outside CASE", "applied_to": ["conditional_filter"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_filter": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "web_sales_base": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ws_item_sk, ws_order_number, ws_web_page_sk, ws_quantity, ws_sales_price, ws_net_profit FROM web_sales INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk WHERE ws_sales_price BETWEEN 50.00 AND 200.00",
        "interfaces": {"outputs": ["ws_item_sk", "ws_order_number", "ws_web_page_sk", "ws_quantity", "ws_sales_price", "ws_net_profit"], "consumes": ["date_filter"]}
      },
      "web_returns_joined": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee, cd1.cd_marital_status, cd1.cd_education_status, ca_state, ws_sales_price, ws_net_profit FROM web_returns INNER JOIN web_sales_base ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number INNER JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk INNER JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk INNER JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk INNER JOIN reason ON r_reason_sk = wr_reason_sk INNER JOIN web_page ON wp_web_page_sk = ws_web_page_sk",
        "interfaces": {"outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee", "cd_marital_status", "cd_education_status", "ca_state", "ws_sales_price", "ws_net_profit"], "consumes": ["web_sales_base"]}
      },
      "conditional_filter": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee FROM web_returns_joined WHERE CASE WHEN cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ws_sales_price BETWEEN 100.00 AND 150.00 THEN (ca_country = 'United States' AND ca_state IN ('KY','NC','SD') AND ws_net_profit BETWEEN 100 AND 200) WHEN cd_marital_status = 'M' AND cd_education_status = 'Secondary' AND ws_sales_price BETWEEN 50.00 AND 100.00 THEN (ca_country = 'United States' AND ca_state IN ('AR','GA','IN') AND ws_net_profit BETWEEN 150 AND 300) WHEN cd_marital_status = 'U' AND cd_education_status = '2 yr Degree' AND ws_sales_price BETWEEN 150.00 AND 200.00 THEN (ca_country = 'United States' AND ca_state IN ('KS','OH','VA') AND ws_net_profit BETWEEN 50 AND 250) ELSE FALSE END AND cd_marital_status = cd_marital_status AND cd_education_status = cd_education_status",
        "interfaces": {"outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"], "consumes": ["web_returns_joined"]}
      },
      "main_aggregation": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT SUBSTRING(r_reason_desc FROM 1 FOR 20) AS substring_reason_desc, AVG(ws_quantity) AS avg_ws_quantity, AVG(wr_refunded_cash) AS avg_wr_refunded_cash, AVG(wr_fee) AS avg_wr_fee FROM conditional_filter GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100",
        "interfaces": {"outputs": ["substring_reason_desc", "avg_ws_quantity", "avg_wr_refunded_cash", "avg_wr_fee"], "consumes": ["conditional_filter"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT substring_reason_desc, avg_ws_quantity, avg_wr_refunded_cash, avg_wr_fee FROM main_aggregation",
        "interfaces": {"outputs": ["substring_reason_desc", "avg_ws_quantity", "avg_wr_refunded_cash", "avg_wr_fee"], "consumes": ["main_aggregation"]}
      }
    },
    "reconstruction_order": ["date_filter", "web_sales_base", "web_returns_joined", "conditional_filter", "main_aggregation", "main_query"],
    "assembly_template": "WITH date_filter AS ({date_filter}), web_sales_base AS ({web_sales_base}), web_returns_joined AS ({web_returns_joined}), conditional_filter AS ({conditional_filter}), main_aggregation AS ({main_aggregation}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes:** Structural change from single-block comma joins to CTE decomposition following the exact target logical tree. The CASE expression restructures OR conditions while preserving branch-local predicate dependencies and defensive guards.

**Expected speedup:** Moderate (1.2-1.5x) due to better predicate pushdown opportunities and eliminated nested loop join explosion risk.