WITH filtered_store_zip AS ( SELECT s_store_sk, s_zip, substring(s_zip, 1, 5) AS s_zip_prefix FROM store ), filtered_address_zip AS ( SELECT ca_address_sk, ca_zip, substring(ca_zip, 1, 5) AS ca_zip_prefix FROM customer_address WHERE ca_state = 'KS' ), precomputed_zip_pairs AS ( SELECT s.s_store_sk, a.ca_address_sk FROM filtered_store_zip s, filtered_address_zip a WHERE s.s_zip_prefix <> a.ca_zip_prefix ), filtered_fact AS ( SELECT ss_ext_sales_price, i_brand_id, i_brand, i_manufact_id, i_manufact, c_current_addr_sk, ss_store_sk FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy = 2 INNER JOIN item ON ss_item_sk = i_item_sk AND i_category = 'Shoes' INNER JOIN customer ON ss_customer_sk = c_customer_sk AND c_birth_month = 2 WHERE ss_wholesale_cost BETWEEN 76 AND 96 ), joined_fact AS ( SELECT f.i_brand_id, f.i_brand, f.i_manufact_id, f.i_manufact, f.ss_ext_sales_price FROM filtered_fact f INNER JOIN precomputed_zip_pairs z ON f.ss_store_sk = z.s_store_sk AND f.c_current_addr_sk = z.ca_address_sk ) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM joined_fact GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100