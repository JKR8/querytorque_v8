### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_date [~] (materialized for reuse across channels)
│   ├── SCAN date_dim
│   └── FILTER (d_date BETWEEN '1999-10-21' AND '1999-10-21' + interval '30 day')
├── [CTE] filtered_item [~] (materialized for reuse)
│   ├── SCAN item
│   └── FILTER (i_current_price > 50 AND i_category IN ('Men','Music'))
├── [CTE] filtered_promotion [~] (materialized for reuse)
│   ├── SCAN promotion
│   └── FILTER (p_channel_email='Y' AND p_channel_tv='N' AND p_channel_radio='N' AND p_channel_press='N' AND p_channel_event='N')
├── [!] unified_sales_with_dims (replaces ssr/csr/wsr CTEs; each channel scanned directly with explicit joins)
│   ├── UNION ALL
│   │   ├── SCAN store_sales
│   │   ├── JOIN filtered_date ON ss_sold_date_sk = d_date_sk
│   │   ├── JOIN store ON ss_store_sk = s_store_sk
│   │   ├── JOIN filtered_item ON ss_item_sk = i_item_sk
│   │   ├── JOIN filtered_promotion ON ss_promo_sk = p_promo_sk
│   │   ├── LEFT JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)
│   │   ├── FILTER (ss_wholesale_cost BETWEEN 21 AND 36)
│   │   └── OUTPUT (channel, id, sales, returns, profit)
│   │   └── ── where channel = 'store channel', id = 'store' || s_store_id
│   │   └── ── sales = ss_ext_sales_price, returns = COALESCE(sr_return_amt, 0), profit = ss_net_profit - COALESCE(sr_net_loss, 0)
│   │   ├── SCAN catalog_sales
│   │   ├── JOIN filtered_date ON cs_sold_date_sk = d_date_sk
│   │   ├── JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk
│   │   ├── JOIN filtered_item ON cs_item_sk = i_item_sk
│   │   ├── JOIN filtered_promotion ON cs_promo_sk = p_promo_sk
│   │   ├── LEFT JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)
│   │   ├── FILTER (cs_wholesale_cost BETWEEN 21 AND 36)
│   │   └── OUTPUT (channel, id, sales, returns, profit)
│   │   └── ── where channel = 'catalog channel', id = 'catalog_page' || cp_catalog_page_id
│   │   └── ── sales = cs_ext_sales_price, returns = COALESCE(cr_return_amount, 0), profit = cs_net_profit - COALESCE(cr_net_loss, 0)
│   │   ├── SCAN web_sales
│   │   ├── JOIN filtered_date ON ws_sold_date_sk = d_date_sk
│   │   ├── JOIN web_site ON ws_web_site_sk = web_site_sk
│   │   ├── JOIN filtered_item ON ws_item_sk = i_item_sk
│   │   ├── JOIN filtered_promotion ON ws_promo_sk = p_promo_sk
│   │   ├── LEFT JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)
│   │   ├── FILTER (ws_wholesale_cost BETWEEN 21 AND 36)
│   │   └── OUTPUT (channel, id, sales, returns, profit)
│   │   └── ── where channel = 'web channel', id = 'web_site' || web_site_id
│   │   └── ── sales = ws_ext_sales_price, returns = COALESCE(wr_return_amt, 0), profit = ws_net_profit - COALESCE(wr_net_loss, 0)
└── [MAIN] main_query [=]
    ├── SCAN unified_sales_with_dims
    ├── AGG (GROUP BY ROLLUP(channel, id))
    ├── SORT (channel ASC, id ASC)
    └── LIMIT 100
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL v16",
  "rewrite_rules": [
    {"id": "R1", "type": "predicate_pull_up", "description": "Extract dimension filters into reusable CTEs to avoid repeated evaluation", "applied_to": ["filtered_date", "filtered_item", "filtered_promotion"]},
    {"id": "R2", "type": "cte_elimination", "description": "Replace per-channel aggregated CTEs with single UNION ALL branch scanning fact tables directly with explicit joins", "applied_to": ["unified_sales_with_dims"]},
    {"id": "R3", "type": "parallelism_guard", "description": "Keep fact table scans outside materialized CTEs to allow parallel execution", "applied_to": ["unified_sales_with_dims"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 day'",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk FROM item WHERE i_current_price > 50 AND i_category IN ('Men', 'Music')",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "filtered_promotion": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N'",
        "interfaces": {"outputs": ["p_promo_sk"], "consumes": []}
      },
      "unified_sales_with_dims": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT 'store channel' AS channel, 'store' || s_store_id AS id, ss_ext_sales_price AS sales, COALESCE(sr_return_amt, 0) AS returns, ss_net_profit - COALESCE(sr_net_loss, 0) AS profit FROM store_sales JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN filtered_item ON ss_item_sk = filtered_item.i_item_sk JOIN filtered_promotion ON ss_promo_sk = filtered_promotion.p_promo_sk LEFT JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) WHERE ss_wholesale_cost BETWEEN 21 AND 36 UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || cp_catalog_page_id AS id, cs_ext_sales_price AS sales, COALESCE(cr_return_amount, 0) AS returns, cs_net_profit - COALESCE(cr_net_loss, 0) AS profit FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk JOIN filtered_item ON cs_item_sk = filtered_item.i_item_sk JOIN filtered_promotion ON cs_promo_sk = filtered_promotion.p_promo_sk LEFT JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number) WHERE cs_wholesale_cost BETWEEN 21 AND 36 UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, ws_ext_sales_price AS sales, COALESCE(wr_return_amt, 0) AS returns, ws_net_profit - COALESCE(wr_net_loss, 0) AS profit FROM web_sales JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk JOIN web_site ON ws_web_site_sk = web_site_sk JOIN filtered_item ON ws_item_sk = filtered_item.i_item_sk JOIN filtered_promotion ON ws_promo_sk = filtered_promotion.p_promo_sk LEFT JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) WHERE ws_wholesale_cost BETWEEN 21 AND 36",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM unified_sales_with_dims GROUP BY ROLLUP(channel, id) ORDER BY channel, id LIMIT 100",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["unified_sales_with_dims"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "filtered_promotion", "unified_sales_with_dims", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), filtered_promotion AS ({filtered_promotion}), unified_sales_with_dims AS ({unified_sales_with_dims}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Restructured to eliminate per‑channel aggregated CTEs that blocked parallelism. Dimension filters are pulled into small reusable CTEs, while fact tables are scanned directly in a single UNION ALL with explicit joins, preserving all original semantics and guards.

**Expected speedup**: Moderate (2–3×) due to parallel scans of fact tables and elimination of repeated dimension filtering.