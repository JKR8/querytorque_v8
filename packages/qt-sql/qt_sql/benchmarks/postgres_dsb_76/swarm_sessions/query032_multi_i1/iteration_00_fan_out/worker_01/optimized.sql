WITH filtered_items AS MATERIALIZED (SELECT i_item_sk, i_manufact_id, i_manager_id FROM item WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100)), filtered_dates AS MATERIALIZED (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 DAY'), item_avg_threshold AS MATERIALIZED (SELECT cs.cs_item_sk, 1.3 * AVG(cs.cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN filtered_dates fd ON fd.d_date_sk = cs.cs_sold_date_sk WHERE cs.cs_list_price BETWEEN 108 AND 137 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY cs.cs_item_sk), main_join AS MATERIALIZED (SELECT cs.cs_ext_discount_amt FROM catalog_sales cs JOIN filtered_items fi ON fi.i_item_sk = cs.cs_item_sk JOIN filtered_dates fd ON fd.d_date_sk = cs.cs_sold_date_sk JOIN item_avg_threshold iat ON iat.cs_item_sk = cs.cs_item_sk WHERE cs.cs_ext_discount_amt > iat.threshold) SELECT SUM(cs_ext_discount_amt) AS "excess discount amount" FROM main_join ORDER BY 1 LIMIT 100