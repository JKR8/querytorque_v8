## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_dates  [+]
│   ├── SCAN (date_dim)
│   ├── FILTER (d_month_seq BETWEEN 1187 AND 1210)
│   └── OUTPUT (d_date_sk, d_week_seq, d_month_seq, d_day_name)
├── [CTE] filtered_stores [+]
│   ├── SCAN (store)
│   ├── FILTER (s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX'))
│   └── OUTPUT (s_store_sk, s_store_id, s_store_name)
├── [CTE] wss_period      [+]
│   ├── SCAN (store_sales)
│   ├── JOIN filtered_dates ON d_date_sk = ss_sold_date_sk
│   ├── FILTER (ss_sales_price/ss_list_price BETWEEN 0.57 AND 0.77)
│   ├── AGG (GROUP BY d_week_seq, ss_store_sk, d_month_seq)
│   └── OUTPUT (d_week_seq, ss_store_sk, d_month_seq, sun_sales, mon_sales, tue_sales, wed_sales, thu_sales, fri_sales, sat_sales)
├── [CTE] pivoted         [+]
│   ├── SCAN (wss_period)
│   ├── JOIN filtered_stores ON ss_store_sk = s_store_sk
│   ├── AGG (GROUP BY s_store_id, s_store_name, d_week_seq)
│   └── OUTPUT (s_store_id, s_store_name, d_week_seq, sun_sales1, sun_sales2, mon_sales1, mon_sales2, tue_sales1, tue_sales2, wed_sales1, wed_sales2, thu_sales1, thu_sales2, fri_sales1, fri_sales2, sat_sales1, sat_sales2)
└── [MAIN] main_query     [~]
    ├── SCAN (pivoted AS p1, pivoted AS p2)
    ├── JOIN (p1.s_store_id = p2.s_store_id AND p1.d_week_seq = p2.d_week_seq - 52)
    ├── SORT (p1.s_store_name, p1.s_store_id, p1.d_week_seq)
    └── OUTPUT (s_store_name1, s_store_id1, d_week_seq1, sun_sales1/sun_sales2, mon_sales1/mon_sales2, tue_sales1/tue_sales2, wed_sales1/wed_sales2, thu_sales1/thu_sales2, fri_sales1/fri_sales2, sat_sales1/sat_sales2)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL v16",
  "rewrite_rules": [
    {"id": "R1", "type": "pg_dimension_prefetch_star", "description": "Pre-filter date_dim and store into CTEs for better cardinality estimation", "applied_to": ["filtered_dates", "filtered_stores"]},
    {"id": "R2", "type": "pg_self_join_decomposition", "description": "Materialize fact+dimension scan once (wss_period) instead of two separate scans", "applied_to": ["wss_period"]},
    {"id": "R3", "type": "single_pass_aggregation", "description": "Use CASE inside MAX to pivot period aggregates in one pass", "applied_to": ["pivoted"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_week_seq, d_month_seq, d_day_name FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1210",
        "interfaces": {"outputs": ["d_date_sk", "d_week_seq", "d_month_seq", "d_day_name"], "consumes": []}
      },
      "filtered_stores": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')",
        "interfaces": {"outputs": ["s_store_sk", "s_store_id", "s_store_name"], "consumes": []}
      },
      "wss_period": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT fd.d_week_seq, ss.ss_store_sk, fd.d_month_seq, SUM(CASE WHEN fd.d_day_name='Sunday' THEN ss.ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN fd.d_day_name='Monday' THEN ss.ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN fd.d_day_name='Tuesday' THEN ss.ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN fd.d_day_name='Wednesday' THEN ss.ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN fd.d_day_name='Thursday' THEN ss.ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN fd.d_day_name='Friday' THEN ss.ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN fd.d_day_name='Saturday' THEN ss.ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales ss JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 0.57 AND 0.77 GROUP BY fd.d_week_seq, ss.ss_store_sk, fd.d_month_seq",
        "interfaces": {"outputs": ["d_week_seq", "ss_store_sk", "d_month_seq", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"], "consumes": ["filtered_dates"]}
      },
      "pivoted": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT fs.s_store_id, fs.s_store_name, wp.d_week_seq, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.sun_sales ELSE NULL END) AS sun_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.sun_sales ELSE NULL END) AS sun_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.mon_sales ELSE NULL END) AS mon_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.mon_sales ELSE NULL END) AS mon_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.tue_sales ELSE NULL END) AS tue_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.tue_sales ELSE NULL END) AS tue_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.wed_sales ELSE NULL END) AS wed_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.wed_sales ELSE NULL END) AS wed_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.thu_sales ELSE NULL END) AS thu_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.thu_sales ELSE NULL END) AS thu_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.fri_sales ELSE NULL END) AS fri_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.fri_sales ELSE NULL END) AS fri_sales2, MAX(CASE WHEN wp.d_month_seq BETWEEN 1187 AND 1198 THEN wp.sat_sales ELSE NULL END) AS sat_sales1, MAX(CASE WHEN wp.d_month_seq BETWEEN 1199 AND 1210 THEN wp.sat_sales ELSE NULL END) AS sat_sales2 FROM wss_period wp JOIN filtered_stores fs ON wp.ss_store_sk = fs.s_store_sk GROUP BY fs.s_store_id, fs.s_store_name, wp.d_week_seq",
        "interfaces": {"outputs": ["s_store_id", "s_store_name", "d_week_seq", "sun_sales1", "sun_sales2", "mon_sales1", "mon_sales2", "tue_sales1", "tue_sales2", "wed_sales1", "wed_sales2", "thu_sales1", "thu_sales2", "fri_sales1", "fri_sales2", "sat_sales1", "sat_sales2"], "consumes": ["wss_period", "filtered_stores"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT p1.s_store_name AS s_store_name1, p1.s_store_id AS s_store_id1, p1.d_week_seq AS d_week_seq1, p1.sun_sales1 / p2.sun_sales2 AS sun_ratio, p1.mon_sales1 / p2.mon_sales2 AS mon_ratio, p1.tue_sales1 / p2.tue_sales2 AS tue_ratio, p1.wed_sales1 / p2.wed_sales2 AS wed_ratio, p1.thu_sales1 / p2.thu_sales2 AS thu_ratio, p1.fri_sales1 / p2.fri_sales2 AS fri_ratio, p1.sat_sales1 / p2.sat_sales2 AS sat_ratio FROM pivoted p1 JOIN pivoted p2 ON p1.s_store_id = p2.s_store_id AND p1.d_week_seq = p2.d_week_seq - 52 ORDER BY p1.s_store_name, p1.s_store_id, p1.d_week_seq LIMIT 100",
        "interfaces": {"outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_ratio", "mon_ratio", "tue_ratio", "wed_ratio", "thu_ratio", "fri_ratio", "sat_ratio"], "consumes": ["pivoted"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_stores", "wss_period", "pivoted", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_stores AS ({filtered_stores}), wss_period AS ({wss_period}), pivoted AS ({pivoted}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: The rewrite decomposes the original query into 5 CTEs following the target logical tree. Pre-filters date_dim and store into CTEs (dimension prefetch), materializes the fact+dimension scan once (self-join decomposition), and uses single-pass pivoting with CASE/MAX to produce both period aggregates.

**Expected speedup**: 3–4× from eliminating duplicate fact table scans, better join cardinality estimation, and single-pass aggregation.