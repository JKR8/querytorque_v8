### Part 1: Modified Logic Tree

```
QUERY:
├── [CTE] filtered_stores  [+]
│   ├── SCAN store
│   ├── FILTER s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')
│   └── OUTPUT s_store_sk, s_store_id, s_store_name
├── [CTE] filtered_dates  [+]
│   ├── SCAN date_dim
│   ├── FILTER d_month_seq BETWEEN 1187 AND 1210
│   └── OUTPUT d_date_sk, d_week_seq, d_month_seq, d_day_name
├── [CTE] wss  [~] (modified to use filtered_dates)
│   ├── SCAN store_sales
│   ├── JOIN filtered_dates ON d_date_sk = ss_sold_date_sk
│   ├── FILTER ss_sales_price/ss_list_price BETWEEN 0.57 AND 0.77
│   ├── AGG GROUP BY d_week_seq, ss_store_sk
│   └── OUTPUT d_week_seq, ss_store_sk, sun_sales..sat_sales
├── [CTE] aggregated  [+]
│   ├── SCAN wss
│   ├── JOIN filtered_dates d ON d.d_week_seq = wss.d_week_seq
│   ├── JOIN filtered_stores ON ss_store_sk = s_store_sk
│   ├── FILTER (d.d_month_seq BETWEEN 1187 AND 1198) OR (d.d_month_seq BETWEEN 1199 AND 1210)
│   └── OUTPUT s_store_name, s_store_id, wss.d_week_seq, d.d_month_seq, sun_sales..sat_sales
└── [MAIN] final  [~] (modified to use aggregated CTE instead of original structure)
    ├── FROM (aggregated filtered to 1187-1198) y, (aggregated filtered to 1199-1210) x
    ├── JOIN ON y.s_store_id = x.s_store_id AND y.d_week_seq = x.d_week_seq - 52
    ├── ORDER BY y.s_store_name, y.s_store_id, y.d_week_seq
    └── OUTPUT s_store_name1, s_store_id1, d_week_seq1, sun_sales1/sun_sales2, ...
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Pre-filter store and date dimensions into materialized CTEs", "applied_to": ["filtered_stores", "filtered_dates"]},
    {"id": "R2", "type": "stage_reduction", "description": "Replace original wss CTE with version using filtered_dates to reduce join cardinality", "applied_to": ["wss"]},
    {"id": "R3", "type": "structural_unfold", "description": "Materialize the week-month-store join into aggregated CTE to avoid recomputation", "applied_to": ["aggregated"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_stores": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')",
        "interfaces": {"outputs": ["s_store_sk", "s_store_id", "s_store_name"], "consumes": []}
      },
      "filtered_dates": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_week_seq, d_month_seq, d_day_name FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1210",
        "interfaces": {"outputs": ["d_date_sk", "d_week_seq", "d_month_seq", "d_day_name"], "consumes": []}
      },
      "wss": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_week_seq, ss_store_sk, SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales JOIN filtered_dates ON d_date_sk = ss_sold_date_sk WHERE ss_sales_price / ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01 GROUP BY d_week_seq, ss_store_sk",
        "interfaces": {"outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"], "consumes": ["filtered_dates"]}
      },
      "aggregated": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT s.s_store_name, s.s_store_id, wss.d_week_seq, d.d_month_seq, wss.sun_sales, wss.mon_sales, wss.tue_sales, wss.wed_sales, wss.thu_sales, wss.fri_sales, wss.sat_sales FROM wss JOIN filtered_dates d ON d.d_week_seq = wss.d_week_seq JOIN filtered_stores s ON wss.ss_store_sk = s.s_store_sk WHERE (d.d_month_seq BETWEEN 1187 AND 1198) OR (d.d_month_seq BETWEEN 1199 AND 1210)",
        "interfaces": {"outputs": ["s_store_name", "s_store_id", "d_week_seq", "d_month_seq", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"], "consumes": ["wss", "filtered_dates", "filtered_stores"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT y.s_store_name AS s_store_name1, y.s_store_id AS s_store_id1, y.d_week_seq AS d_week_seq1, y.sun_sales / x.sun_sales, y.mon_sales / x.mon_sales, y.tue_sales / x.tue_sales, y.wed_sales / x.wed_sales, y.thu_sales / x.thu_sales, y.fri_sales / x.fri_sales, y.sat_sales / x.sat_sales FROM (SELECT * FROM aggregated WHERE d_month_seq BETWEEN 1187 AND 1198) y, (SELECT * FROM aggregated WHERE d_month_seq BETWEEN 1199 AND 1210) x WHERE y.s_store_id = x.s_store_id AND y.d_week_seq = x.d_week_seq - 52 ORDER BY y.s_store_name, y.s_store_id, y.d_week_seq LIMIT 100",
        "interfaces": {"outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "?column?", "?column?", "?column?", "?column?", "?column?", "?column?", "?column?"], "consumes": ["aggregated"]}
      }
    },
    "reconstruction_order": ["filtered_stores", "filtered_dates", "wss", "aggregated", "main_query"],
    "assembly_template": "WITH filtered_stores AS ({filtered_stores}), filtered_dates AS ({filtered_dates}), wss AS ({wss}), aggregated AS ({aggregated}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes:** Restructured query into staged CTEs to materialize filtered dimensions (store, date) early, then reduced fact join using pre-filtered dates. The aggregated CTE materializes the week-month-store join to avoid recomputation in the final self-join.

**Expected speedup:** ~2-3x from reduced join cardinality and better predicate pushdown (though the week-month many-to-many join is preserved exactly).