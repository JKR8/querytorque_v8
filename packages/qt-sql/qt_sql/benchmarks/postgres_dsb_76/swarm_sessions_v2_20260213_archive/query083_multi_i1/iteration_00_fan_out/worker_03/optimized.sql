WITH date_keys AS MATERIALIZED (SELECT d1.d_date_sk, d1.d_date FROM date_dim d1 INNER JOIN date_dim d2 ON d1.d_month_seq = d2.d_month_seq WHERE d2.d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')), filtered_items AS MATERIALIZED (SELECT i_item_sk, i_item_id FROM item WHERE i_category IN ('Home','Men') AND i_manager_id BETWEEN 8 AND 17), consolidated_aggregates AS (SELECT filtered_items.i_item_id AS item_id, NULLIF(agg.sr_qty, 0) AS sr_item_qty, NULLIF(agg.cr_qty, 0) AS cr_item_qty, NULLIF(agg.wr_qty, 0) AS wr_item_qty FROM (SELECT i_item_sk, SUM(CASE WHEN sr_return_amt / sr_return_quantity BETWEEN 237 AND 266 AND sr_reason_sk IN (6,7,25,45,51) THEN sr_return_quantity ELSE 0 END) AS sr_qty, SUM(CASE WHEN cr_return_amount / cr_return_quantity BETWEEN 237 AND 266 AND cr_reason_sk IN (6,7,25,45,51) THEN cr_return_quantity ELSE 0 END) AS cr_qty, SUM(CASE WHEN wr_return_amt / wr_return_quantity BETWEEN 237 AND 266 AND wr_reason_sk IN (6,7,25,45,51) THEN wr_return_quantity ELSE 0 END) AS wr_qty FROM (SELECT i_item_sk, sr_return_quantity, sr_return_amt, sr_reason_sk, NULL::numeric AS cr_return_quantity, NULL::numeric AS cr_return_amount, NULL::integer AS cr_reason_sk, NULL::integer AS wr_return_quantity, NULL::numeric AS wr_return_amt, NULL::integer AS wr_reason_sk FROM store_returns INNER JOIN date_keys ON sr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON sr_item_sk = i_item_sk UNION ALL SELECT i_item_sk, NULL, NULL, NULL, cr_return_quantity, cr_return_amount, cr_reason_sk, NULL, NULL, NULL FROM catalog_returns INNER JOIN date_keys ON cr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON cr_item_sk = i_item_sk UNION ALL SELECT i_item_sk, NULL, NULL, NULL, NULL, NULL, NULL, wr_return_quantity, wr_return_amt, wr_reason_sk FROM web_returns INNER JOIN date_keys ON wr_returned_date_sk = d_date_sk INNER JOIN filtered_items ON wr_item_sk = i_item_sk) combined GROUP BY i_item_sk) agg INNER JOIN filtered_items ON agg.i_item_sk = filtered_items.i_item_sk) SELECT item_id, sr_item_qty, sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS sr_dev, cr_item_qty, cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS cr_dev, wr_item_qty, wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0*100 AS wr_dev, (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average FROM consolidated_aggregates WHERE sr_item_qty IS NOT NULL AND cr_item_qty IS NOT NULL AND wr_item_qty IS NOT NULL ORDER BY item_id, sr_item_qty LIMIT 100