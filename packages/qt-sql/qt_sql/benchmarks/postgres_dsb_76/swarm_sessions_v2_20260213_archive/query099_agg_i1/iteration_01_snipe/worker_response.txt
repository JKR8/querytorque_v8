## Part 1: Modified Logic Tree

```
[+] filtered_date: CTE (d_date_sk)
[+] filtered_warehouse: CTE (w_warehouse_sk, w_warehouse_name)
[+] filtered_ship_mode: CTE (sm_ship_mode_sk, sm_type)
[+] filtered_call_center: CTE (cc_call_center_sk, cc_name)
[~] main_query:
    - FROM: Changed comma-joins to explicit JOIN syntax
    - JOINs: catalog_sales → filtered_date → filtered_warehouse → filtered_ship_mode → filtered_call_center
    - Filters: Preserved all original WHERE conditions, moved dimension filters to CTEs
    - Grouping/Aggregation: Unchanged
    - ORDER BY/LIMIT: Unchanged
[=] Output columns: Preserved exactly (7 columns)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "comma_join_to_explicit", "description": "Convert comma-separated joins to explicit JOIN...ON syntax", "applied_to": ["main_query"]},
    {"id": "R2", "type": "dimension_prefetch_cte", "description": "Pre-filter selective dimension tables into CTEs to create tiny hash tables", "applied_to": ["filtered_date", "filtered_warehouse", "filtered_ship_mode", "filtered_call_center"]},
    {"id": "R3", "type": "join_reordering", "description": "Use explicit JOINs to allow PostgreSQL's cost-based join reordering", "applied_to": ["main_query"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1192 AND 1192 + 23",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_warehouse": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT w_warehouse_sk, w_warehouse_name FROM warehouse WHERE w_gmt_offset = -5",
        "interfaces": {"outputs": ["w_warehouse_sk", "w_warehouse_name"], "consumes": []}
      },
      "filtered_ship_mode": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT sm_ship_mode_sk, sm_type FROM ship_mode WHERE sm_type = 'EXPRESS'",
        "interfaces": {"outputs": ["sm_ship_mode_sk", "sm_type"], "consumes": []}
      },
      "filtered_call_center": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'small'",
        "interfaces": {"outputs": ["cc_call_center_sk", "cc_name"], "consumes": []}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT substring(fw.w_warehouse_name,1,20), fsm.sm_type, fcc.cc_name, sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30) then 1 else 0 end) as \"30 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end) as \"31-60 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 120) then 1 else 0 end) as \">120 days\" FROM catalog_sales cs JOIN filtered_date fd ON cs.cs_ship_date_sk = fd.d_date_sk JOIN filtered_warehouse fw ON cs.cs_warehouse_sk = fw.w_warehouse_sk JOIN filtered_ship_mode fsm ON cs.cs_ship_mode_sk = fsm.sm_ship_mode_sk JOIN filtered_call_center fcc ON cs.cs_call_center_sk = fcc.cc_call_center_sk WHERE cs.cs_list_price BETWEEN 86 AND 115 GROUP BY substring(fw.w_warehouse_name,1,20), fsm.sm_type, fcc.cc_name ORDER BY substring(fw.w_warehouse_name,1,20), fsm.sm_type, fcc.cc_name LIMIT 100",
        "interfaces": {
          "outputs": ["substring(w_warehouse_name,1,20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "consumes": ["filtered_date", "filtered_warehouse", "filtered_ship_mode", "filtered_call_center"]
        }
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_warehouse", "filtered_ship_mode", "filtered_call_center", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_warehouse AS ({filtered_warehouse}), filtered_ship_mode AS ({filtered_ship_mode}), filtered_call_center AS ({filtered_call_center}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL enable_nestloop = off",
    "SET LOCAL enable_hashjoin = on",
    "SET LOCAL enable_mergejoin = off",
    "SET LOCAL work_mem = '256MB'",
    "SET LOCAL hash_mem_multiplier = 2.0"
  ],
  "validation_checks": []
}
```

**Changes**: Converted comma-joins to explicit JOIN syntax + pre-filtered selective dimensions into CTEs. This addresses PostgreSQL's comma-join weakness and creates tiny hash tables for efficient hash joins.

**Expected speedup**: 2.5-3.0x. The explicit JOINs enable PostgreSQL's cost-based join reordering, while the CTEs create small dimension hash tables that can be probed efficiently. Disabling nested loops forces hash joins, which is optimal for this star schema with selective dimensions.