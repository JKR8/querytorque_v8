WITH filtered_items AS (SELECT i_item_sk, i_manufact_id, i_manager_id FROM item WHERE i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 DAY'), prefetched_sales AS (SELECT cs.cs_item_sk, cs.cs_ext_discount_amt, cs.cs_sold_date_sk, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs INNER JOIN filtered_items fi ON fi.i_item_sk = cs.cs_item_sk INNER JOIN filtered_dates fd ON fd.d_date_sk = cs.cs_sold_date_sk), threshold_cte AS (SELECT ps.cs_item_sk, 1.3 * AVG(ps.cs_ext_discount_amt) AS threshold FROM prefetched_sales ps INNER JOIN filtered_dates fd ON fd.d_date_sk = ps.cs_sold_date_sk WHERE ps.cs_list_price BETWEEN 108 AND 137 AND ps.cs_sales_price / ps.cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY ps.cs_item_sk), main_filter AS (SELECT ps.cs_ext_discount_amt FROM prefetched_sales ps INNER JOIN threshold_cte tc ON ps.cs_item_sk = tc.cs_item_sk WHERE ps.cs_ext_discount_amt > tc.threshold) SELECT SUM(cs_ext_discount_amt) AS "excess discount amount" FROM main_filter ORDER BY SUM(cs_ext_discount_amt) ASC LIMIT 100