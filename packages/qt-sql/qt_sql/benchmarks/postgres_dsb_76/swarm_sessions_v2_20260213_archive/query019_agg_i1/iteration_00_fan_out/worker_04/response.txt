## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]
    ├── [~] CTE customer_address_materialized
    ├── [~] CTE store_materialized
    ├── [~] CTE date_cte
    ├── [~] CTE item_cte
    ├── [+] CTE customer_cte
    ├── [~] CTE store_sales_join
    └── [=] AGGREGATION (GROUP BY, ORDER BY, LIMIT)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "materialized_dimension_prefilter", "description": "Materialize both sides of non-equi join (customer_address and store) to reduce search space before zip inequality", "applied_to": ["customer_address_materialized", "store_materialized"]},
    {"id": "R2", "type": "dimension_prefetch_star", "description": "Pre-filter all selective dimensions into CTEs for better cardinality estimates", "applied_to": ["date_cte", "item_cte", "customer_cte"]},
    {"id": "R3", "type": "explicit_join_syntax", "description": "Convert comma-separated implicit joins to explicit JOIN syntax", "applied_to": ["store_sales_join"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "customer_address_materialized": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ca_address_sk, ca_zip FROM customer_address WHERE ca_state = 'IL'",
        "interfaces": {"outputs": ["ca_address_sk", "ca_zip"], "consumes": []}
      },
      "store_materialized": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT s_store_sk, s_zip FROM store",
        "interfaces": {"outputs": ["s_store_sk", "s_zip"], "consumes": []}
      },
      "date_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 4",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "item_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk, i_brand_id, i_brand, i_manufact_id, i_manufact FROM item WHERE i_category = 'Jewelry'",
        "interfaces": {"outputs": ["i_item_sk", "i_brand_id", "i_brand", "i_manufact_id", "i_manufact"], "consumes": []}
      },
      "customer_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c.c_customer_sk, c.c_current_addr_sk, ca.ca_zip FROM customer c INNER JOIN customer_address_materialized ca ON ca.ca_address_sk = c.c_current_addr_sk WHERE c.c_birth_month = 1",
        "interfaces": {"outputs": ["c_customer_sk", "c_current_addr_sk", "ca_zip"], "consumes": ["customer_address_materialized"]}
      },
      "store_sales_join": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i.i_brand_id, i.i_brand, i.i_manufact_id, i.i_manufact, ss.ss_ext_sales_price FROM store_sales ss INNER JOIN date_cte d ON d.d_date_sk = ss.ss_sold_date_sk INNER JOIN item_cte i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer_cte c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN store_materialized s ON s.s_store_sk = ss.ss_store_sk WHERE ss.ss_wholesale_cost BETWEEN 35 AND 55 AND substring(c.ca_zip,1,5) <> substring(s.s_zip,1,5)",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "i_manufact_id", "i_manufact", "ss_ext_sales_price"], "consumes": ["date_cte", "item_cte", "customer_cte", "store_materialized"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM store_sales_join GROUP BY i_brand_id, i_brand, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100",
        "interfaces": {"outputs": ["brand_id", "brand", "i_manufact_id", "i_manufact", "ext_price"], "consumes": ["store_sales_join"]}
      }
    },
    "reconstruction_order": ["customer_address_materialized", "store_materialized", "date_cte", "item_cte", "customer_cte", "store_sales_join", "main_query"],
    "assembly_template": "WITH customer_address_materialized AS ({customer_address_materialized}), store_materialized AS ({store_materialized}), date_cte AS ({date_cte}), item_cte AS ({item_cte}), customer_cte AS ({customer_cte}), store_sales_join AS ({store_sales_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": ["SET LOCAL work_mem = '512MB'", "SET LOCAL enable_nestloop = off", "SET LOCAL hash_mem_multiplier = 2.0"],
  "validation_checks": []
}
```

**Changes:** Materialized both sides of the non-equi zip join (customer_address and store) into CTEs to dramatically reduce the search space before applying the expensive inequality filter, while prefetching all selective dimensions into CTEs for better cardinality estimates. Converted implicit comma joins to explicit JOIN syntax for clarity and optimizer hints.

**Expected speedup:** 2.5-3.5x due to reduced hash table sizes for the non-equi join and better selectivity estimation from pre-materialized dimensions.