WITH ss_pivoted AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price END) AS store_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price END) AS store_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price END) AS store_sales_q3 FROM store_sales, date_dim, customer_address, item WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk AND ss_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') AND d_year = 1998 AND d_qoy IN (1, 2, 3) GROUP BY ca_county, d_year), ws_pivoted AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price END) AS ws_store_sales_q1, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price END) AS ws_store_sales_q2, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price END) AS ws_store_sales_q3 FROM web_sales, date_dim, customer_address, item WHERE ws_sold_date_sk = d_date_sk AND ws_bill_addr_sk = ca_address_sk AND ws_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') AND d_year = 1998 AND d_qoy IN (1, 2, 3) GROUP BY ca_county, d_year) SELECT ss.ca_county, ss.d_year, CASE WHEN ws.ws_store_sales_q1 > 0 THEN ws.ws_store_sales_q2 / ws.ws_store_sales_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN ss.store_sales_q1 > 0 THEN ss.store_sales_q2 / ss.store_sales_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN ws.ws_store_sales_q2 > 0 THEN ws.ws_store_sales_q3 / ws.ws_store_sales_q2 ELSE NULL END AS web_q2_q3_increase, CASE WHEN ss.store_sales_q2 > 0 THEN ss.store_sales_q3 / ss.store_sales_q2 ELSE NULL END AS store_q2_q3_increase FROM ss_pivoted ss, ws_pivoted ws WHERE ws.ca_county = ss.ca_county AND ws.d_year = ss.d_year AND CASE WHEN ws.ws_store_sales_q1 > 0 THEN ws.ws_store_sales_q2 / ws.ws_store_sales_q1 ELSE NULL END > CASE WHEN ss.store_sales_q1 > 0 THEN ss.store_sales_q2 / ss.store_sales_q1 ELSE NULL END AND CASE WHEN ws.ws_store_sales_q2 > 0 THEN ws.ws_store_sales_q3 / ws.ws_store_sales_q2 ELSE NULL END > CASE WHEN ss.store_sales_q2 > 0 THEN ss.store_sales_q3 / ss.store_sales_q2 ELSE NULL END ORDER BY ss.d_year