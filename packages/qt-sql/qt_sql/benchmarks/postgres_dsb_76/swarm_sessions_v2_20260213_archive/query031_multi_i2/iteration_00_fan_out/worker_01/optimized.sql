WITH filtered_date AS (SELECT d_date_sk, d_qoy, d_year FROM date_dim WHERE d_year = 1999 AND d_qoy IN (1, 2, 3)), filtered_item AS (SELECT i_item_sk FROM item WHERE i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34), filtered_ca AS (SELECT ca_address_sk, ca_county FROM customer_address WHERE ca_state IN ('KS', 'OH')), ss_fact_join AS (SELECT filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year, ss_ext_sales_price FROM store_sales INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk INNER JOIN filtered_ca ON store_sales.ss_addr_sk = filtered_ca.ca_address_sk WHERE ss_list_price BETWEEN 244 AND 258), ss_agg AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM ss_fact_join GROUP BY ca_county, d_qoy, d_year), ws_fact_join AS (SELECT filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year, ws_ext_sales_price FROM web_sales INNER JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk INNER JOIN filtered_ca ON web_sales.ws_bill_addr_sk = filtered_ca.ca_address_sk WHERE ws_list_price BETWEEN 244 AND 258), ws_agg AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM ws_fact_join GROUP BY ca_county, d_qoy, d_year) SELECT ss.ca_county, 1999 AS d_year, CASE WHEN ws_q1 > 0 THEN ws_q2 / ws_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN ss_q1 > 0 THEN ss_q2 / ss_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN ws_q2 > 0 THEN ws_q3 / ws_q2 ELSE NULL END AS web_q2_q3_increase, CASE WHEN ss_q2 > 0 THEN ss_q3 / ss_q2 ELSE NULL END AS store_q2_q3_increase FROM (SELECT ca_county, MAX(CASE WHEN d_qoy = 1 THEN store_sales END) AS ss_q1, MAX(CASE WHEN d_qoy = 2 THEN store_sales END) AS ss_q2, MAX(CASE WHEN d_qoy = 3 THEN store_sales END) AS ss_q3 FROM ss_agg GROUP BY ca_county) ss INNER JOIN (SELECT ca_county, MAX(CASE WHEN d_qoy = 1 THEN web_sales END) AS ws_q1, MAX(CASE WHEN d_qoy = 2 THEN web_sales END) AS ws_q2, MAX(CASE WHEN d_qoy = 3 THEN web_sales END) AS ws_q3 FROM ws_agg GROUP BY ca_county) ws ON ss.ca_county = ws.ca_county WHERE (CASE WHEN ws_q1 > 0 THEN ws_q2 / ws_q1 ELSE NULL END) > (CASE WHEN ss_q1 > 0 THEN ss_q2 / ss_q1 ELSE NULL END) AND (CASE WHEN ws_q2 > 0 THEN ws_q3 / ws_q2 ELSE NULL END) > (CASE WHEN ss_q2 > 0 THEN ss_q3 / ss_q2 ELSE NULL END) ORDER BY d_year