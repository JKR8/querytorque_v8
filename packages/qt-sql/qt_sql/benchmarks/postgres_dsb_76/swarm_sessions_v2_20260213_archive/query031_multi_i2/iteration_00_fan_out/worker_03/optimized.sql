WITH filtered_dims AS (SELECT d_date_sk, d_qoy, d_year, i_item_sk, ca_address_sk, ca_county FROM date_dim, item, customer_address WHERE d_year = 1999 AND d_qoy IN (1, 2, 3) AND i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34 AND ca_state IN ('KS', 'OH')), combined_sales AS (SELECT sales.channel, addr.ca_county, date.d_qoy, date.d_year, sales.sales FROM (SELECT 'store' AS channel, ss_ext_sales_price AS sales, ss_sold_date_sk, ss_item_sk, ss_addr_sk, ss_list_price FROM store_sales WHERE ss_list_price BETWEEN 244 AND 258 UNION ALL SELECT 'web' AS channel, ws_ext_sales_price AS sales, ws_sold_date_sk, ws_item_sk, ws_bill_addr_sk, ws_list_price FROM web_sales WHERE ws_list_price BETWEEN 244 AND 258) sales JOIN filtered_dims date ON sales.sold_date_sk = date.d_date_sk JOIN filtered_dims item ON sales.item_sk = item.i_item_sk JOIN filtered_dims addr ON (sales.channel = 'store' AND sales.addr_sk = addr.ca_address_sk) OR (sales.channel = 'web' AND sales.bill_addr_sk = addr.ca_address_sk)), channel_quarter_agg AS (SELECT channel, ca_county, d_qoy, d_year, SUM(sales) AS total_sales FROM combined_sales GROUP BY channel, ca_county, d_qoy, d_year) WITH pivoted AS (SELECT ca_county, d_year, MAX(CASE WHEN channel = 'web' AND d_qoy = 1 THEN total_sales END) AS web_q1, MAX(CASE WHEN channel = 'web' AND d_qoy = 2 THEN total_sales END) AS web_q2, MAX(CASE WHEN channel = 'web' AND d_qoy = 3 THEN total_sales END) AS web_q3, MAX(CASE WHEN channel = 'store' AND d_qoy = 1 THEN total_sales END) AS store_q1, MAX(CASE WHEN channel = 'store' AND d_qoy = 2 THEN total_sales END) AS store_q2, MAX(CASE WHEN channel = 'store' AND d_qoy = 3 THEN total_sales END) AS store_q3 FROM channel_quarter_agg GROUP BY ca_county, d_year) SELECT ca_county, d_year, CASE WHEN web_q1 > 0 THEN web_q2 / web_q1 ELSE NULL END AS web_q1_q2_increase, CASE WHEN store_q1 > 0 THEN store_q2 / store_q1 ELSE NULL END AS store_q1_q2_increase, CASE WHEN web_q2 > 0 THEN web_q3 / web_q2 ELSE NULL END AS web_q2_q3_increase, CASE WHEN store_q2 > 0 THEN store_q3 / store_q2 ELSE NULL END AS store_q2_q3_increase FROM pivoted WHERE CASE WHEN web_q1 > 0 THEN web_q2 / web_q1 ELSE NULL END > CASE WHEN store_q1 > 0 THEN store_q2 / store_q1 ELSE NULL END AND CASE WHEN web_q2 > 0 THEN web_q3 / web_q2 ELSE NULL END > CASE WHEN store_q2 > 0 THEN store_q3 / store_q2 ELSE NULL END ORDER BY d_year