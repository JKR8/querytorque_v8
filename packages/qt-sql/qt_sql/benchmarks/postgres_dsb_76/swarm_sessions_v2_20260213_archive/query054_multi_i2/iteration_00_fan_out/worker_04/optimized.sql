WITH date_dim_cte AS (SELECT d_date_sk, d_month_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 5), item_cte AS (SELECT i_item_sk FROM item WHERE i_category = 'Home' AND i_class = 'curtains/drapes'), customer_cte AS (SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_year BETWEEN 1942 AND 1955), sales_union AS ((SELECT cs_bill_customer_sk AS customer_sk FROM catalog_sales INNER JOIN date_dim_cte ON cs_sold_date_sk = date_dim_cte.d_date_sk INNER JOIN item_cte ON cs_item_sk = item_cte.i_item_sk INNER JOIN customer_cte ON cs_bill_customer_sk = customer_cte.c_customer_sk WHERE cs_wholesale_cost BETWEEN 70 AND 100) UNION ALL (SELECT ws_bill_customer_sk AS customer_sk FROM web_sales INNER JOIN date_dim_cte ON ws_sold_date_sk = date_dim_cte.d_date_sk INNER JOIN item_cte ON ws_item_sk = item_cte.i_item_sk INNER JOIN customer_cte ON ws_bill_customer_sk = customer_cte.c_customer_sk WHERE ws_wholesale_cost BETWEEN 70 AND 100)), my_customers AS (SELECT DISTINCT customer_sk AS c_customer_sk, (SELECT c_current_addr_sk FROM customer_cte WHERE c_customer_sk = sales_union.customer_sk) AS c_current_addr_sk FROM sales_union), month_seq_cte AS (SELECT d_month_seq + 1 AS month_seq_start, d_month_seq + 3 AS month_seq_end FROM date_dim_cte), my_revenue AS (SELECT my_customers.c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk INNER JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state INNER JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk CROSS JOIN month_seq_cte WHERE store_sales.ss_wholesale_cost BETWEEN 70 AND 100 AND store.s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') AND date_dim.d_month_seq BETWEEN month_seq_cte.month_seq_start AND month_seq_cte.month_seq_end GROUP BY my_customers.c_customer_sk), segments AS (SELECT CAST((revenue/50) AS INTEGER) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment*50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100