WITH date_dim_cte AS (SELECT d_date_sk, d_month_seq FROM date_dim WHERE d_year = 1998 AND d_moy = 5), month_seq_cte AS (SELECT d_month_seq + 1 AS month_seq_start, d_month_seq + 3 AS month_seq_end FROM date_dim_cte), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) sales JOIN date_dim_cte ON sales.sold_date_sk = date_dim_cte.d_date_sk JOIN item ON sales.item_sk = item.i_item_sk JOIN customer ON sales.customer_sk = customer.c_customer_sk WHERE item.i_category = 'Home' AND item.i_class = 'curtains/drapes' AND sales.wholesale_cost BETWEEN 70 AND 100 AND customer.c_birth_year BETWEEN 1942 AND 1955), my_revenue AS (SELECT my_customers.c_customer_sk, SUM(store_sales.ss_ext_sales_price) AS revenue FROM my_customers JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk CROSS JOIN month_seq_cte WHERE store_sales.ss_wholesale_cost BETWEEN 70 AND 100 AND store.s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') AND date_dim.d_month_seq BETWEEN month_seq_cte.month_seq_start AND month_seq_cte.month_seq_end GROUP BY my_customers.c_customer_sk), segments AS (SELECT CAST((revenue/50) AS INTEGER) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment*50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100