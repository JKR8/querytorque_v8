### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [~] CTE date_cte
│   ├── SCAN date_dim
│   └── FILTER (d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY')
├── [~] CTE item_cte
│   ├── SCAN item
│   └── FILTER ((i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')))
├── [+] CTE fact_with_dates
│   ├── SCAN web_sales
│   ├── JOIN (INNER JOIN date_cte ON d_date_sk = ws_sold_date_sk)
│   └── FILTER (ws_wholesale_cost BETWEEN 35 AND 55)
├── [~] MAIN final_explicit_join
│   ├── JOIN (INNER JOIN item_cte ON i_item_sk = ws_item_sk)
│   ├── JOIN (INNER JOIN fact_with_dates)
│   └── FILTER (ws_ext_discount_amt > correlated_subquery)
│       └── CORRELATED SUBQUERY
│           ├── SCAN fact_with_dates AS sub
│           ├── FILTER (sub.ws_sales_price / sub.ws_list_price BETWEEN 76*0.01 AND 91*0.01)
│           └── AGGREGATE (1.3 * AVG(ws_ext_discount_amt))
├── [=] AGGREGATE (SUM(ws_ext_discount_amt) AS "Excess Discount Amount")
├── [=] SORT (SUM(ws_ext_discount_amt) ASC)
└── [=] LIMIT 100
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch_cte", "description": "Pre-filter selective dimensions into CTEs to create tiny hash tables", "applied_to": ["date_cte", "item_cte"]},
    {"id": "R2", "type": "explicit_join_conversion", "description": "Convert comma-separated joins to explicit INNER JOIN syntax with ON clauses", "applied_to": ["fact_with_dates", "final_explicit_join"]},
    {"id": "R3", "type": "correlated_subquery_optimization", "description": "Keep correlated subquery but make it scan smaller fact_with_dates CTE instead of full web_sales", "applied_to": ["final_explicit_join"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "item_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk, i_manufact_id, i_category FROM item WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))",
        "interfaces": {"outputs": ["i_item_sk", "i_manufact_id", "i_category"], "consumes": []}
      },
      "fact_with_dates": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws_item_sk, ws_sold_date_sk, ws_ext_discount_amt, ws_wholesale_cost, ws_sales_price, ws_list_price FROM web_sales INNER JOIN date_cte ON date_cte.d_date_sk = web_sales.ws_sold_date_sk WHERE web_sales.ws_wholesale_cost BETWEEN 35 AND 55",
        "interfaces": {"outputs": ["ws_item_sk", "ws_sold_date_sk", "ws_ext_discount_amt", "ws_wholesale_cost", "ws_sales_price", "ws_list_price"], "consumes": ["date_cte"]}
      },
      "final_explicit_join": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT fact_with_dates.ws_ext_discount_amt FROM item_cte INNER JOIN fact_with_dates ON item_cte.i_item_sk = fact_with_dates.ws_item_sk WHERE fact_with_dates.ws_ext_discount_amt > (SELECT 1.3 * AVG(sub.ws_ext_discount_amt) FROM fact_with_dates AS sub WHERE sub.ws_item_sk = item_cte.i_item_sk AND sub.ws_sales_price / sub.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01)",
        "interfaces": {"outputs": ["ws_ext_discount_amt"], "consumes": ["item_cte", "fact_with_dates"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM final_explicit_join ORDER BY SUM(ws_ext_discount_amt) ASC LIMIT 100",
        "interfaces": {"outputs": ["Excess Discount Amount"], "consumes": ["final_explicit_join"]}
      }
    },
    "reconstruction_order": ["date_cte", "item_cte", "fact_with_dates", "final_explicit_join", "main_query"],
    "assembly_template": "WITH date_cte AS ({date_cte}), item_cte AS ({item_cte}), fact_with_dates AS ({fact_with_dates}), final_explicit_join AS ({final_explicit_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Pre-filtered date_dim and item into CTEs, converted comma joins to explicit INNER JOIN syntax, and kept the correlated subquery but made it scan the smaller fact_with_dates CTE instead of the full web_sales table. All semantic invariants preserved, including the subquery's additional price ratio filter.

**Expected speedup**: 2-3x from better cardinality estimates via pre-materialized dimension CTEs and explicit join syntax (PostgreSQL optimizer weakness addressed).