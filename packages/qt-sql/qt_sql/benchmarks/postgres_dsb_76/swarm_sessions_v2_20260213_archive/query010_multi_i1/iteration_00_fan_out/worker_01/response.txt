## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~121K
    ├── [~] date_filter_cte (NEW CTE)  [=]  Cost: 0%  Rows: 41
    ├── [~] item_filter_cte (NEW CTE)  [=]  Cost: 0%  Rows: unknown
    ├── [~] store_sales_subquery (NEW CTE)  [=]  Cost: 5%  Rows: 671
    │   ├── JOIN (explicit INNER JOIN to date_filter_cte, item_filter_cte)
    │   └── FILTER (ss_sales_price / ss_list_price BETWEEN 0.2 AND 0.3)
    ├── [~] web_sales_subquery (NEW CTE)  [=]  Cost: 1%  Rows: minimal
    │   ├── JOIN (explicit INNER JOIN to date_filter_cte, item_filter_cte)
    │   └── FILTER (ws_sales_price / ws_list_price BETWEEN 0.2 AND 0.3)
    ├── [~] catalog_sales_subquery (NEW CTE)  [=]  Cost: 4%  Rows: 543
    │   ├── JOIN (explicit INNER JOIN to date_filter_cte, item_filter_cte)
    │   └── FILTER (cs_sales_price / cs_list_price BETWEEN 0.2 AND 0.3)
    ├── [~] customer_join (NEW CTE)  [=]  Cost: 10%  Rows: unknown
    │   ├── JOIN (INNER to store_sales_subquery, LEFT to web_sales, catalog_sales)
    │   ├── FILTER (c_birth_month IN (1,5))
    │   └── FILTER (ws_bill_customer_sk IS NOT NULL OR cs_ship_customer_sk IS NOT NULL)
    ├── [~] address_join (NEW CTE)  [=]  Cost: 15%  Rows: filtered
    │   ├── JOIN (INNER to customer_address)
    │   └── FILTER (ca_county IN list)
    ├── [~] demographics_join (NEW CTE)  [=]  Cost: 20%  Rows: final
    │   ├── JOIN (INNER to customer_demographics)
    │   └── FILTER (cd_marital_status, cd_education_status, cd_gender)
    ├── [~] AGG (GROUP BY 8 columns, 6 COUNT(*))
    ├── [~] SORT (8 columns ASC)
    └── [=] OUTPUT (14 columns as specified)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch", "description": "Isolate date_dim and item filters into CTEs to create tiny hash tables", "applied_to": ["date_filter_cte", "item_filter_cte"]},
    {"id": "R2", "type": "explicit_join_conversion", "description": "Convert comma-separated implicit joins to explicit JOIN syntax", "applied_to": ["store_sales_subquery", "web_sales_subquery", "catalog_sales_subquery", "customer_join", "address_join", "demographics_join"]},
    {"id": "R3", "type": "preserve_exists_semantics", "description": "Convert EXISTS subqueries to LEFT JOIN + NULL checks to maintain semi-join semantics without duplication", "applied_to": ["customer_join"]},
    {"id": "R4", "type": "cte_structure", "description": "Follow target logical tree with explicit CTE dependencies", "applied_to": ["all CTEs"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_filter_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "item_filter_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "store_sales_subquery": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT DISTINCT ss_customer_sk FROM store_sales INNER JOIN date_filter_cte ON ss_sold_date_sk = d_date_sk INNER JOIN item_filter_cte ON ss_item_sk = i_item_sk WHERE ss_sales_price / ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01",
        "interfaces": {"outputs": ["ss_customer_sk"], "consumes": ["date_filter_cte", "item_filter_cte"]}
      },
      "web_sales_subquery": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT DISTINCT ws_bill_customer_sk FROM web_sales INNER JOIN date_filter_cte ON ws_sold_date_sk = d_date_sk INNER JOIN item_filter_cte ON ws_item_sk = i_item_sk WHERE ws_sales_price / ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01",
        "interfaces": {"outputs": ["ws_bill_customer_sk"], "consumes": ["date_filter_cte", "item_filter_cte"]}
      },
      "catalog_sales_subquery": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales INNER JOIN date_filter_cte ON cs_sold_date_sk = d_date_sk INNER JOIN item_filter_cte ON cs_item_sk = i_item_sk WHERE cs_sales_price / cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01",
        "interfaces": {"outputs": ["cs_ship_customer_sk"], "consumes": ["date_filter_cte", "item_filter_cte"]}
      },
      "customer_join": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c.c_current_addr_sk, c.c_current_cdemo_sk, c.c_customer_sk FROM customer c INNER JOIN store_sales_subquery ON c.c_customer_sk = ss_customer_sk LEFT JOIN web_sales_subquery ON c.c_customer_sk = ws_bill_customer_sk LEFT JOIN catalog_sales_subquery ON c.c_customer_sk = cs_ship_customer_sk WHERE c.c_birth_month IN (1, 5) AND (ws_bill_customer_sk IS NOT NULL OR cs_ship_customer_sk IS NOT NULL)",
        "interfaces": {"outputs": ["c_current_addr_sk", "c_current_cdemo_sk", "c_customer_sk"], "consumes": ["store_sales_subquery", "web_sales_subquery", "catalog_sales_subquery"]}
      },
      "address_join": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cj.c_current_cdemo_sk, cj.c_customer_sk FROM customer_join cj INNER JOIN customer_address ca ON cj.c_current_addr_sk = ca.ca_address_sk WHERE ca.ca_county IN ('Grays Harbor County', 'Kootenai County', 'Pike County', 'Thomas County', 'Uinta County')",
        "interfaces": {"outputs": ["c_current_cdemo_sk", "c_customer_sk"], "consumes": ["customer_join"]}
      },
      "demographics_join": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM address_join aj INNER JOIN customer_demographics cd ON aj.c_current_cdemo_sk = cd.cd_demo_sk WHERE cd.cd_marital_status IN ('U', 'U', 'M') AND cd.cd_education_status IN ('College', 'Primary', '2 yr Degree') AND cd.cd_gender = 'M'",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating", "cd_dep_count", "cd_dep_employed_count", "cd_dep_college_count"], "consumes": ["address_join"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM demographics_join GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"], "consumes": ["demographics_join"]}
      }
    },
    "reconstruction_order": ["date_filter_cte", "item_filter_cte", "store_sales_subquery", "web_sales_subquery", "catalog_sales_subquery", "customer_join", "address_join", "demographics_join", "main_query"],
    "assembly_template": "WITH date_filter_cte AS ({date_filter_cte}), item_filter_cte AS ({item_filter_cte}), store_sales_subquery AS ({store_sales_subquery}), web_sales_subquery AS ({web_sales_subquery}), catalog_sales_subquery AS ({catalog_sales_subquery}), customer_join AS ({customer_join}), address_join AS ({address_join}), demographics_join AS ({demographics_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL max_parallel_workers_per_gather = 2",
    "SET LOCAL work_mem = '32MB'",
    "SET LOCAL from_collapse_limit = 8",
    "SET LOCAL join_collapse_limit = 8"
  ],
  "validation_checks": []
}
```

**Changes**: Converted implicit comma-joins to explicit JOIN syntax with dimension prefetching CTEs for date_dim and item, preserving EXISTS semantics via LEFT JOIN + NULL checks. The rewrite follows the target logical tree structure with DISTINCT in sales subqueries to prevent duplication.

**Expected speedup**: 2-3× from dimension isolation (small hash tables) and explicit join planning, while avoiding EXISTS-to-IN regression by maintaining LEFT JOIN + NULL check pattern.