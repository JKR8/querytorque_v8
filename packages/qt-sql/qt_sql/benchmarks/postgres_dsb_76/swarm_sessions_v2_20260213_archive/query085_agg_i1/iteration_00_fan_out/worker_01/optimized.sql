WITH dim_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2000), dim_cd1 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')), dim_cd2 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')), dim_addr AS (SELECT ca_address_sk FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('NC','PA','TX') AND ws_net_profit between 100 and 200) OR (ca_country = 'United States' AND ca_state IN ('AR','CO','NY') AND ws_net_profit between 150 and 300) OR (ca_country = 'United States' AND ca_state IN ('IA','IL','TX') AND ws_net_profit between 50 and 250)), dim_reason AS (SELECT r_reason_sk, r_reason_desc FROM reason), dim_web_page AS (SELECT wp_web_page_sk FROM web_page), fact_join AS (SELECT r_reason_desc, ws_quantity, wr_refunded_cash, wr_fee FROM web_sales INNER JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number INNER JOIN dim_date ON ws_sold_date_sk = dim_date.d_date_sk INNER JOIN dim_cd1 ON wr_refunded_cdemo_sk = dim_cd1.cd_demo_sk INNER JOIN dim_cd2 ON wr_returning_cdemo_sk = dim_cd2.cd_demo_sk AND dim_cd1.cd_marital_status = dim_cd2.cd_marital_status AND dim_cd1.cd_education_status = dim_cd2.cd_education_status INNER JOIN dim_addr ON wr_refunded_addr_sk = dim_addr.ca_address_sk INNER JOIN dim_reason ON wr_reason_sk = dim_reason.r_reason_sk INNER JOIN dim_web_page ON ws_web_page_sk = dim_web_page.wp_web_page_sk WHERE ((dim_cd1.cd_marital_status = 'S' AND ws_sales_price between 100.00 and 150.00) OR (dim_cd1.cd_marital_status = 'W' AND ws_sales_price between 50.00 and 100.00) OR (dim_cd1.cd_marital_status = 'M' AND ws_sales_price between 150.00 and 200.00))) SELECT substring(r_reason_desc,1,20), avg(ws_quantity), avg(wr_refunded_cash), avg(wr_fee) FROM fact_join GROUP BY r_reason_desc ORDER BY substring(r_reason_desc,1,20), avg(ws_quantity), avg(wr_refunded_cash), avg(wr_fee) LIMIT 100