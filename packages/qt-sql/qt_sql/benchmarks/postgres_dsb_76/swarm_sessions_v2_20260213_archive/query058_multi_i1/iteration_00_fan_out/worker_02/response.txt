## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [!] month_seq_cte
│   ├── SCAN date_dim
│   └── FILTER d_date = '1998-05-19'
│   └── OUTPUT d_month_seq
├── [!] date_list_cte
│   ├── SCAN date_dim
│   ├── JOIN month_seq_cte
│   └── FILTER d_month_seq = month_seq_cte.d_month_seq
│   └── OUTPUT d_date_sk, d_date
├── [~] ss_items
│   ├── SCAN store_sales, item, customer
│   ├── JOIN date_list_cte ON ss_sold_date_sk = d_date_sk
│   ├── JOIN item ON ss_item_sk = i_item_sk
│   ├── JOIN customer ON ss_customer_sk = c_customer_sk
│   ├── FILTER ss_list_price BETWEEN 242 AND 271
│   ├── FILTER i_manager_id BETWEEN 71 AND 100
│   ├── FILTER c_birth_year BETWEEN 1945 AND 1951
│   ├── AGG GROUP BY i_item_id, c_birth_year
│   └── OUTPUT item_id, birth_year, ss_item_rev
├── [~] cs_items
│   ├── SCAN catalog_sales, item, customer
│   ├── JOIN date_list_cte ON cs_sold_date_sk = d_date_sk
│   ├── JOIN item ON cs_item_sk = i_item_sk
│   ├── JOIN customer ON cs_bill_customer_sk = c_customer_sk
│   ├── FILTER cs_list_price BETWEEN 242 AND 271
│   ├── FILTER i_manager_id BETWEEN 71 AND 100
│   ├── FILTER c_birth_year BETWEEN 1945 AND 1951
│   ├── AGG GROUP BY i_item_id, c_birth_year
│   └── OUTPUT item_id, birth_year, cs_item_rev
├── [~] ws_items
│   ├── SCAN web_sales, item, customer
│   ├── JOIN date_list_cte ON ws_sold_date_sk = d_date_sk
│   ├── JOIN item ON ws_item_sk = i_item_sk
│   ├── JOIN customer ON ws_bill_customer_sk = c_customer_sk
│   ├── FILTER ws_list_price BETWEEN 242 AND 271
│   ├── FILTER i_manager_id BETWEEN 71 AND 100
│   ├── FILTER c_birth_year BETWEEN 1945 AND 1951
│   ├── AGG GROUP BY i_item_id, c_birth_year
│   └── OUTPUT item_id, birth_year, ws_item_rev
└── [=] main_query
    ├── SCAN ss_items, cs_items, ws_items
    ├── JOIN (ss_items.item_id=cs_items.item_id AND ss_items.birth_year=cs_items.birth_year)
    ├── JOIN (ss_items.item_id=ws_items.item_id AND ss_items.birth_year=ws_items.birth_year)
    ├── FILTER (6 pairwise range checks)
    ├── SORT item_id, birth_year, ss_item_rev
    └── OUTPUT (9 columns with computed percentages)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "PostgreSQL v16.11",
  "rewrite_rules": [
    {"id": "R1", "type": "inline_decorrelate_materialized", "description": "Replaced correlated date subquery with month_seq_cte + date_list_cte MATERIALIZED", "applied_to": ["month_seq_cte", "date_list_cte", "ss_items", "cs_items", "ws_items"]},
    {"id": "R2", "type": "comma_join_to_explicit_join", "description": "Converted comma-separated joins to explicit JOIN syntax in fact CTEs", "applied_to": ["ss_items", "cs_items", "ws_items"]},
    {"id": "R3", "type": "early_filter_decorrelate", "description": "Pushed dimension filters into CTE definitions before materialization", "applied_to": ["ss_items", "cs_items", "ws_items"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "month_seq_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19'",
        "interfaces": {"outputs": ["d_month_seq"], "consumes": []}
      },
      "date_list_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_date FROM date_dim, month_seq_cte WHERE d_month_seq = month_seq_cte.d_month_seq",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": ["month_seq_cte"]}
      },
      "ss_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ss_ext_sales_price) AS ss_item_rev FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_list_cte ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE ss_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "ss_item_rev"], "consumes": ["date_list_cte"]}
      },
      "cs_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(cs_ext_sales_price) AS cs_item_rev FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_list_cte ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE cs_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "cs_item_rev"], "consumes": ["date_list_cte"]}
      },
      "ws_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ws_ext_sales_price) AS ws_item_rev FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_list_cte ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE ws_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year",
        "interfaces": {"outputs": ["item_id", "birth_year", "ws_item_rev"], "consumes": ["date_list_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["item_id", "birth_year", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"], "consumes": ["ss_items", "cs_items", "ws_items"]}
      }
    },
    "reconstruction_order": ["month_seq_cte", "date_list_cte", "ss_items", "cs_items", "ws_items", "main_query"],
    "assembly_template": "WITH month_seq_cte AS ({month_seq_cte}), date_list_cte AS MATERIALIZED ({date_list_cte}), ss_items AS ({ss_items}), cs_items AS ({cs_items}), ws_items AS ({ws_items}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes:** Decorrelated the date subquery by extracting month_seq into a CTE and pre-materializing the date list, eliminating per-CTE re-execution. Converted comma joins to explicit JOINs for better cardinality estimation.

**Expected speedup:** ~2-3x due to elimination of correlated subquery re-execution and improved join cardinality estimates.