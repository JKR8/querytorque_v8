{
  "worker_id": 3,
  "strategy": "self_join_elimination",
  "examples_used": [
    "pg_self_join_decomposition",
    "early_filter_decorrelate"
  ],
  "optimized_sql": "WITH filtered_item AS (SELECT i_item_sk, i_brand_id, i_class_id, i_category_id, i_manufact_id FROM item WHERE i_category = 'Home'), filtered_date AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (1998, 1999)), sales_1999_agg AS (SELECT i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM (SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, ss.ss_quantity - COALESCE(sr.sr_return_quantity,0) AS sales_cnt, ss.ss_ext_sales_price - COALESCE(sr.sr_return_amt,0.0) AS sales_amt FROM store_returns sr JOIN filtered_item i ON sr.sr_item_sk = i.i_item_sk JOIN store_sales ss ON sr.sr_ticket_number = ss.ss_ticket_number AND sr.sr_item_sk = ss.ss_item_sk JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk WHERE sr.sr_reason_sk IN (7,25,26,52,69) AND (ss.ss_sales_price / ss.ss_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1999 UNION ALL SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, cs.cs_quantity - COALESCE(cr.cr_return_quantity,0) AS sales_cnt, cs.cs_ext_sales_price - COALESCE(cr.cr_return_amount,0.0) AS sales_amt FROM catalog_returns cr JOIN filtered_item i ON cr.cr_item_sk = i.i_item_sk JOIN catalog_sales cs ON cr.cr_order_number = cs.cs_order_number AND cr.cr_item_sk = cs.cs_item_sk JOIN filtered_date d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cr.cr_reason_sk IN (7,25,26,52,69) AND (cs.cs_sales_price / cs.cs_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1999 UNION ALL SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, ws.ws_quantity - COALESCE(wr.wr_return_quantity,0) AS sales_cnt, ws.ws_ext_sales_price - COALESCE(wr.wr_return_amt,0.0) AS sales_amt FROM web_returns wr JOIN filtered_item i ON wr.wr_item_sk = i.i_item_sk JOIN web_sales ws ON wr.wr_order_number = ws.ws_order_number AND wr.wr_item_sk = ws.ws_item_sk JOIN filtered_date d ON ws.ws_sold_date_sk = d.d_date_sk WHERE wr.wr_reason_sk IN (7,25,26,52,69) AND (ws.ws_sales_price / ws.ws_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1999) t GROUP BY i_brand_id, i_class_id, i_category_id, i_manufact_id), sales_1998_agg AS (SELECT i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM (SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, ss.ss_quantity - COALESCE(sr.sr_return_quantity,0) AS sales_cnt, ss.ss_ext_sales_price - COALESCE(sr.sr_return_amt,0.0) AS sales_amt FROM store_returns sr JOIN filtered_item i ON sr.sr_item_sk = i.i_item_sk JOIN store_sales ss ON sr.sr_ticket_number = ss.ss_ticket_number AND sr.sr_item_sk = ss.ss_item_sk JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk WHERE sr.sr_reason_sk IN (7,25,26,52,69) AND (ss.ss_sales_price / ss.ss_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1998 UNION ALL SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, cs.cs_quantity - COALESCE(cr.cr_return_quantity,0) AS sales_cnt, cs.cs_ext_sales_price - COALESCE(cr.cr_return_amount,0.0) AS sales_amt FROM catalog_returns cr JOIN filtered_item i ON cr.cr_item_sk = i.i_item_sk JOIN catalog_sales cs ON cr.cr_order_number = cs.cs_order_number AND cr.cr_item_sk = cs.cs_item_sk JOIN filtered_date d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cr.cr_reason_sk IN (7,25,26,52,69) AND (cs.cs_sales_price / cs.cs_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1998 UNION ALL SELECT i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, ws.ws_quantity - COALESCE(wr.wr_return_quantity,0) AS sales_cnt, ws.ws_ext_sales_price - COALESCE(wr.wr_return_amt,0.0) AS sales_amt FROM web_returns wr JOIN filtered_item i ON wr.wr_item_sk = i.i_item_sk JOIN web_sales ws ON wr.wr_order_number = ws.ws_order_number AND wr.wr_item_sk = ws.ws_item_sk JOIN filtered_date d ON ws.ws_sold_date_sk = d.d_date_sk WHERE wr.wr_reason_sk IN (7,25,26,52,69) AND (ws.ws_sales_price / ws.ws_list_price) BETWEEN 0.34 AND 0.54 AND d.d_year = 1998) t GROUP BY i_brand_id, i_class_id, i_category_id, i_manufact_id) SELECT 1998 AS prev_year, 1999 AS year, curr_yr.i_brand_id, curr_yr.i_class_id, curr_yr.i_category_id, curr_yr.i_manufact_id, prev_yr.sales_cnt AS prev_yr_cnt, curr_yr.sales_cnt AS curr_yr_cnt, curr_yr.sales_cnt - prev_yr.sales_cnt AS sales_cnt_diff, curr_yr.sales_amt - prev_yr.sales_amt AS sales_amt_diff FROM sales_1999_agg curr_yr INNER JOIN sales_1998_agg prev_yr ON curr_yr.i_brand_id = prev_yr.i_brand_id AND curr_yr.i_class_id = prev_yr.i_class_id AND curr_yr.i_category_id = prev_yr.i_category_id AND curr_yr.i_manufact_id = prev_yr.i_manufact_id WHERE prev_yr.sales_cnt > 0 AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2))/CAST(prev_yr.sales_cnt AS DECIMAL(17,2)) < 0.9 ORDER BY sales_cnt_diff, sales_amt_diff LIMIT 100",
  "speedup": 0.0,
  "status": "FAIL",
  "transforms": [
    "union_cte_split"
  ],
  "hint": "- pg_self_join_decomposition: Materialize sales aggregates for each year separat",
  "error_message": "Value mismatch: rows differ between original and optimized",
  "error_messages": [
    "Value mismatch: rows differ between original and optimized"
  ],
  "error_category": "semantic"
}