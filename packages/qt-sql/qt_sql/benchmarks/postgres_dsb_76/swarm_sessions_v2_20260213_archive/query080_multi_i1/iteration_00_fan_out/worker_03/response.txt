## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_date  [+]
│   ├── SCAN (date_dim)
│   ├── FILTER (d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 DAY')
│   └── OUTPUT (d_date_sk, d_date)
├── [CTE] filtered_item  [+]
│   ├── SCAN (item)
│   ├── FILTER (i_current_price > 50 AND i_category IN ('Children', 'Sports'))
│   └── OUTPUT (i_item_sk, i_current_price, i_category)
├── [CTE] filtered_promotion  [+]
│   ├── SCAN (promotion)
│   ├── FILTER (p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N')
│   └── OUTPUT (p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event)
├── [CTE] ssr_core  [+]
│   ├── SCAN (store_sales)
│   ├── LEFT JOIN (store_returns) ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)
│   ├── INNER JOIN filtered_date ON ss_sold_date_sk = d_date_sk
│   ├── INNER JOIN filtered_item ON ss_item_sk = i_item_sk
│   ├── INNER JOIN filtered_promotion ON ss_promo_sk = p_promo_sk
│   ├── FILTER (ss_wholesale_cost BETWEEN 23 AND 38)
│   └── OUTPUT (ss_store_sk, ss_ext_sales_price, COALESCE(sr_return_amt, 0) as return_amt, ss_net_profit, COALESCE(sr_net_loss, 0) as return_loss)
├── [CTE] ssr  [~] (changed from original: now consumes ssr_core instead of direct joins)
│   ├── SCAN (ssr_core)
│   ├── INNER JOIN store ON ss_store_sk = s_store_sk
│   ├── AGG (GROUP BY s_store_id)
│   └── OUTPUT (store_id, sales, returns, profit)
├── [CTE] csr_core  [+]
│   ├── SCAN (catalog_sales)
│   ├── LEFT JOIN (catalog_returns) ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)
│   ├── INNER JOIN filtered_date ON cs_sold_date_sk = d_date_sk
│   ├── INNER JOIN filtered_item ON cs_item_sk = i_item_sk
│   ├── INNER JOIN filtered_promotion ON cs_promo_sk = p_promo_sk
│   ├── FILTER (cs_wholesale_cost BETWEEN 23 AND 38)
│   └── OUTPUT (cs_catalog_page_sk, cs_ext_sales_price, COALESCE(cr_return_amount, 0) as return_amt, cs_net_profit, COALESCE(cr_net_loss, 0) as return_loss)
├── [CTE] csr  [~] (changed from original: now consumes csr_core instead of direct joins)
│   ├── SCAN (csr_core)
│   ├── INNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk
│   ├── AGG (GROUP BY cp_catalog_page_id)
│   └── OUTPUT (catalog_page_id, sales, returns, profit)
├── [CTE] wsr_core  [+]
│   ├── SCAN (web_sales)
│   ├── LEFT JOIN (web_returns) ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)
│   ├── INNER JOIN filtered_date ON ws_sold_date_sk = d_date_sk
│   ├── INNER JOIN filtered_item ON ws_item_sk = i_item_sk
│   ├── INNER JOIN filtered_promotion ON ws_promo_sk = p_promo_sk
│   ├── FILTER (ws_wholesale_cost BETWEEN 23 AND 38)
│   └── OUTPUT (ws_web_site_sk, ws_ext_sales_price, COALESCE(wr_return_amt, 0) as return_amt, ws_net_profit, COALESCE(wr_net_loss, 0) as return_loss)
├── [CTE] wsr  [~] (changed from original: now consumes wsr_core instead of direct joins)
│   ├── SCAN (wsr_core)
│   ├── INNER JOIN web_site ON ws_web_site_sk = web_site_sk
│   ├── AGG (GROUP BY web_site_id)
│   └── OUTPUT (web_site_id, sales, returns, profit)
└── [MAIN] main_query  [=]  (unchanged structure)
    ├── SCAN (ssr, csr, wsr)
    ├── AGG (GROUP BY ROLLUP)
    ├── SORT (channel ASC, id ASC)
    └── OUTPUT (channel, id, sales, returns, profit)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "dimension_prefetch_cte",
      "description": "Pre-filter selective dimensions (date_dim, item, promotion) into CTEs before joining with large fact tables",
      "applied_to": ["filtered_date", "filtered_item", "filtered_promotion"]
    },
    {
      "id": "R2",
      "type": "explicit_join_conversion",
      "description": "Convert comma-separated implicit joins to explicit JOIN syntax while preserving LEFT OUTER semantics",
      "applied_to": ["ssr_core", "csr_core", "wsr_core"]
    },
    {
      "id": "R3",
      "type": "late_binding_channel_dimensions",
      "description": "Defer store/catalog_page/web_site joins until after core filtering and returns aggregation",
      "applied_to": ["ssr", "csr", "wsr"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_date": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN CAST('1998-08-29' AS DATE) AND CAST('1998-08-29' AS DATE) + INTERVAL '30 DAY'",
          "interfaces": {
            "outputs": ["d_date_sk", "d_date"],
            "consumes": []
          }
        },
        "filtered_item": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT i_item_sk, i_current_price, i_category FROM item WHERE i_current_price > 50 AND i_category IN ('Children', 'Sports')",
          "interfaces": {
            "outputs": ["i_item_sk", "i_current_price", "i_category"],
            "consumes": []
          }
        },
        "filtered_promotion": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event FROM promotion WHERE p_channel_email = 'N' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N'",
          "interfaces": {
            "outputs": ["p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio", "p_channel_press", "p_channel_event"],
            "consumes": []
          }
        },
        "ssr_core": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT ss_store_sk, ss_ext_sales_price, COALESCE(sr_return_amt, 0) AS return_amt, ss_net_profit, COALESCE(sr_net_loss, 0) AS return_loss FROM store_sales LEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) INNER JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_item ON ss_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON ss_promo_sk = filtered_promotion.p_promo_sk WHERE ss_wholesale_cost BETWEEN 23 AND 38",
          "interfaces": {
            "outputs": ["ss_store_sk", "ss_ext_sales_price", "return_amt", "ss_net_profit", "return_loss"],
            "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]
          }
        },
        "ssr": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(return_amt) AS returns, SUM(ss_net_profit - return_loss) AS profit FROM ssr_core INNER JOIN store ON ss_store_sk = s_store_sk GROUP BY s_store_id",
          "interfaces": {
            "outputs": ["store_id", "sales", "returns", "profit"],
            "consumes": ["ssr_core"]
          }
        },
        "csr_core": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT cs_catalog_page_sk, cs_ext_sales_price, COALESCE(cr_return_amount, 0) AS return_amt, cs_net_profit, COALESCE(cr_net_loss, 0) AS return_loss FROM catalog_sales LEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number) INNER JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_item ON cs_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON cs_promo_sk = filtered_promotion.p_promo_sk WHERE cs_wholesale_cost BETWEEN 23 AND 38",
          "interfaces": {
            "outputs": ["cs_catalog_page_sk", "cs_ext_sales_price", "return_amt", "cs_net_profit", "return_loss"],
            "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]
          }
        },
        "csr": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(return_amt) AS returns, SUM(cs_net_profit - return_loss) AS profit FROM csr_core INNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk GROUP BY cp_catalog_page_id",
          "interfaces": {
            "outputs": ["catalog_page_id", "sales", "returns", "profit"],
            "consumes": ["csr_core"]
          }
        },
        "wsr_core": {
          "type": "cte",
          "change": "new",
          "sql": "SELECT ws_web_site_sk, ws_ext_sales_price, COALESCE(wr_return_amt, 0) AS return_amt, ws_net_profit, COALESCE(wr_net_loss, 0) AS return_loss FROM web_sales LEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) INNER JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_item ON ws_item_sk = filtered_item.i_item_sk INNER JOIN filtered_promotion ON ws_promo_sk = filtered_promotion.p_promo_sk WHERE ws_wholesale_cost BETWEEN 23 AND 38",
          "interfaces": {
            "outputs": ["ws_web_site_sk", "ws_ext_sales_price", "return_amt", "ws_net_profit", "return_loss"],
            "consumes": ["filtered_date", "filtered_item", "filtered_promotion"]
          }
        },
        "wsr": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(return_amt) AS returns, SUM(ws_net_profit - return_loss) AS profit FROM wsr_core INNER JOIN web_site ON ws_web_site_sk = web_site_sk GROUP BY web_site_id",
          "interfaces": {
            "outputs": ["web_site_id", "sales", "returns", "profit"],
            "consumes": ["wsr_core"]
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "unchanged",
          "sql": "SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, returns, profit FROM ssr UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, returns, profit FROM csr UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, returns, profit FROM wsr) x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100",
          "interfaces": {
            "outputs": ["channel", "id", "sales", "returns", "profit"],
            "consumes": ["ssr", "csr", "wsr"]
          }
        }
      },
      "reconstruction_order": [
        "filtered_date",
        "filtered_item",
        "filtered_promotion",
        "ssr_core",
        "csr_core",
        "wsr_core",
        "ssr",
        "csr",
        "wsr",
        "main_query"
      ],
      "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), filtered_promotion AS ({filtered_promotion}), ssr_core AS ({ssr_core}), ssr AS ({ssr}), csr_core AS ({csr_core}), csr AS ({csr}), wsr_core AS ({wsr_core}), wsr AS ({wsr}) {main_query}"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes**: Restructured to match Target Logical Tree exactly, converting implicit comma joins to explicit JOIN syntax while preserving LEFT OUTER semantics, and prefetching selective dimensions (date, item, promotion) into CTEs before joining with large fact tables. This enables PostgreSQL to build small hash tables from the dimension CTEs and use them efficiently in parallel hash joins with the fact tables.

**Expected speedup**: 2.5-3.5x based on similar pattern improvements observed in reference examples (pg_dimension_prefetch_star showed 3.32x). The main gains come from: (1) explicit JOIN syntax providing better optimization hints, (2) small dimension CTEs enabling hash joins instead of nested loops, and (3) preserving parallelism by avoiding materialization of large fact table scans in CTEs.