## Modified Logic Tree

[~] filtered_date: added `d_moy IN (5,6)` to pre‑filter to only relevant months before joining
[=] filtered_item: unchanged  
[=] filtered_warehouse: unchanged  
[=] joined_fact: unchanged (but now joins with pre‑filtered months)  
[=] aggregated: unchanged  
[=] filtered_cov: unchanged  
[=] main_query: unchanged

**Rationale:**  
The dominant cost in W1 (1.895×) was the full scan of `inventory` joined with all 365 days of 2002, even though the self‑join later needed only May and June. By pushing the month filter into the `filtered_date` CTE, we reduce the fact‑table join to about 61 days (≈6× fewer rows). This allows the planner to use an index on `inv_date_sk` (if present) and cuts the aggregation work proportionally. The CTE structure remains the same, preserving all correctness invariants.

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "pg_dimension_prefetch_star",
      "description": "Pre‑filter date_dim to only months 5 and 6 of 2002 before joining with inventory",
      "applied_to": ["filtered_date"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "filtered_date": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002 AND d_moy IN (5, 6)",
          "interfaces": {
            "outputs": ["d_date_sk", "d_moy"],
            "consumes": []
          }
        },
        "filtered_item": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["i_item_sk"],
            "consumes": []
          }
        },
        "filtered_warehouse": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["w_warehouse_sk", "w_warehouse_name"],
            "consumes": []
          }
        },
        "joined_fact": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["w_warehouse_sk", "w_warehouse_name", "i_item_sk", "d_moy", "inv_quantity_on_hand"],
            "consumes": ["filtered_date", "filtered_item", "filtered_warehouse"]
          }
        },
        "aggregated": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean"],
            "consumes": ["joined_fact"]
          }
        },
        "filtered_cov": {
          "type": "cte",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
            "consumes": ["aggregated"]
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
            "consumes": ["filtered_cov"]
          }
        }
      },
      "reconstruction_order": [
        "filtered_date",
        "filtered_item",
        "filtered_warehouse",
        "joined_fact",
        "aggregated",
        "filtered_cov",
        "main_query"
      ],
      "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), filtered_warehouse AS ({filtered_warehouse}), joined_fact AS ({joined_fact}), aggregated AS ({aggregated}), filtered_cov AS ({filtered_cov}) {main_query}"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [
    "SET LOCAL work_mem = '512MB'",
    "SET LOCAL max_parallel_workers_per_gather = 4"
  ],
  "validation_checks": []
}
```

## Assembly (full SQL)

```sql
WITH filtered_date AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002 AND d_moy IN (5, 6)), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61), filtered_warehouse AS (SELECT w_warehouse_sk, w_warehouse_name FROM warehouse), joined_fact AS (SELECT w.w_warehouse_sk, w.w_warehouse_name, i.i_item_sk, d.d_moy, inv.inv_quantity_on_hand FROM inventory inv INNER JOIN filtered_date d ON inv.inv_date_sk = d.d_date_sk INNER JOIN filtered_item i ON inv.inv_item_sk = i.i_item_sk INNER JOIN filtered_warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk WHERE inv.inv_quantity_on_hand BETWEEN 791 AND 991), aggregated AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM joined_fact GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy), filtered_cov AS (SELECT w_warehouse_sk, i_item_sk, d_moy, mean, CASE WHEN mean = 0 THEN NULL ELSE stdev/mean END AS cov FROM aggregated WHERE CASE WHEN mean = 0 THEN 0 ELSE stdev/mean END > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM filtered_cov AS inv1 INNER JOIN filtered_cov AS inv2 ON inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk WHERE inv1.d_moy = 5 AND inv2.d_moy = 6 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov
```

**Changes:**  
Pushed `d_moy IN (5,6)` into the `filtered_date` CTE, reducing the fact‑table join from 365 days to ~61 days. This leverages PostgreSQL’s ability to use an index on `inv_date_sk` and cuts aggregation work by ~6×, while preserving all original semantics and column outputs.

**Expected speedup:** ≥2.0× (the bottleneck in W1 was scanning all months; this rewrite eliminates that).