## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]  Structural change: CTE-based explicit joins
    ├── [~] CTE dim_item  [NEW]
    │   ├── SCAN item
    │   └── FILTER (i_category IN + i_manager_id IN)
    ├── [~] CTE dim_customer  [NEW]
    │   ├── SCAN customer
    │   ├── JOIN customer_address (c_current_addr_sk = ca_address_sk)
    │   ├── JOIN household_demographics (c_current_hdemo_sk = hd_demo_sk)
    │   ├── JOIN customer_demographics (c_current_cdemo_sk = cd_demo_sk)
    │   └── FILTER (ca_state IN)
    ├── [~] CTE dim_date_1998  [NEW]
    │   ├── SCAN date_dim
    │   └── FILTER (d_year = 1998)
    ├── [~] CTE fact_joins  [NEW]
    │   ├── JOIN web_sales ⇔ store_sales (ws_item_sk = ss_item_sk AND ws_bill_customer_sk = ss_customer_sk)
    │   ├── JOIN dim_item (ss_item_sk = i_item_sk)
    │   ├── JOIN dim_customer (ss_customer_sk = c_customer_sk)
    │   ├── JOIN dim_date_1998 d1 (ss_sold_date_sk = d1.d_date_sk)
    │   ├── JOIN date_dim d2 (ws_sold_date_sk = d2.d_date_sk)
    │   ├── JOIN warehouse (ws_warehouse_sk = w_warehouse_sk)
    │   ├── JOIN store (s_state = w_state)
    │   ├── JOIN inventory (inv_warehouse_sk = ws_warehouse_sk AND inv_item_sk = ss_item_sk AND inv_date_sk = ss_sold_date_sk)
    │   ├── FILTER (d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day'))
    │   ├── FILTER (inv_quantity_on_hand >= ss_quantity)
    │   └── FILTER (ws_wholesale_cost BETWEEN 76 AND 96)
    ├── [~] final_aggregation  [REPLACES original main]
    │   ├── SCAN fact_joins
    │   ├── AGG (GROUP BY 4 demographic columns)
    │   ├── AGG (COUNT(*) as cnt)
    │   └── SORT (cnt ASC)
    └── OUTPUT (cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, cnt)  [=]
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "postgresql",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefetch", "description": "Materialize selective dimension filters into CTEs to create tiny hash tables", "applied_to": ["dim_item", "dim_customer", "dim_date_1998"]},
    {"id": "R2", "type": "explicit_join_syntax", "description": "Convert comma-separated implicit joins to explicit JOIN syntax", "applied_to": ["fact_joins"]},
    {"id": "R3", "type": "cte_structure", "description": "Follow target logical tree: dim_ctes → fact_joins → final_aggregation", "applied_to": ["main_query"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "dim_item": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "dim_customer": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_customer_sk, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM customer JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')",
        "interfaces": {"outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count"], "consumes": []}
      },
      "dim_date_1998": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "fact_joins": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT dim_customer.cd_gender, dim_customer.cd_marital_status, dim_customer.cd_education_status, dim_customer.hd_vehicle_count FROM web_sales JOIN store_sales ON ws_item_sk = ss_item_sk AND ws_bill_customer_sk = ss_customer_sk JOIN dim_item ON ss_item_sk = dim_item.i_item_sk JOIN dim_customer ON ss_customer_sk = dim_customer.c_customer_sk JOIN dim_date_1998 d1 ON ss_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON ws_sold_date_sk = d2.d_date_sk JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk JOIN store ON s_state = w_state JOIN inventory ON inv_warehouse_sk = ws_warehouse_sk AND inv_item_sk = ss_item_sk AND inv_date_sk = ss_sold_date_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day') AND inv_quantity_on_hand >= ss_quantity AND ws_wholesale_cost BETWEEN 76 AND 96",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count"], "consumes": ["dim_item", "dim_customer", "dim_date_1998"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM fact_joins GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt",
        "interfaces": {"outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"], "consumes": ["fact_joins"]}
      }
    },
    "reconstruction_order": ["dim_item", "dim_customer", "dim_date_1998", "fact_joins", "main_query"],
    "assembly_template": "WITH dim_item AS ({dim_item}), dim_customer AS ({dim_customer}), dim_date_1998 AS ({dim_date_1998}), fact_joins AS ({fact_joins}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "runtime_config": [],
  "validation_checks": []
}
```

**Changes:** Restructured the original comma-join query into explicit CTEs for selective dimension filtering (item, customer, date) followed by explicit JOIN syntax in the fact_joins CTE, preserving all original filters and defensive guards. The final aggregation operates on the pre-joined fact CTE.

**Expected speedup:** ~2-3x based on similar patterns, due to better cardinality estimates from materialized small dimension CTEs and explicit join ordering allowing PostgreSQL to use efficient hash joins with tiny probe tables.