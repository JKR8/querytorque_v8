WITH base_sales AS (SELECT ws_item_sk AS item_sk, ws_bill_customer_sk AS customer_sk, ws_sold_date_sk AS sold_date_sk, ws_warehouse_sk AS warehouse_sk, ws_wholesale_cost AS wholesale_cost, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, CASE WHEN ws_wholesale_cost IS NOT NULL THEN 'web' ELSE 'store' END AS channel FROM (SELECT ws_item_sk, ws_bill_customer_sk, ws_sold_date_sk, ws_warehouse_sk, ws_wholesale_cost FROM web_sales WHERE ws_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT ss_item_sk, ss_customer_sk, ss_sold_date_sk, NULL, NULL FROM store_sales) sales JOIN item ON sales.ws_item_sk = i_item_sk AND i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98) JOIN customer ON sales.ws_bill_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk AND ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA') JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk), web_sales_part AS (SELECT item_sk, customer_sk, sold_date_sk, warehouse_sk, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM base_sales WHERE channel = 'web'), store_sales_part AS (SELECT item_sk, customer_sk, sold_date_sk, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM base_sales WHERE channel = 'store'), joined AS (SELECT ws.cd_gender, ws.cd_marital_status, ws.cd_education_status, ws.hd_vehicle_count FROM web_sales_part ws JOIN store_sales_part ss ON ws.item_sk = ss.item_sk AND ws.customer_sk = ss.customer_sk JOIN date_dim d1 ON ss.sold_date_sk = d1.d_date_sk AND d1.d_year = 1998 JOIN date_dim d2 ON ws.sold_date_sk = d2.d_date_sk JOIN warehouse ON ws.warehouse_sk = w_warehouse_sk JOIN store ON s_state = w_state JOIN inventory ON inv_warehouse_sk = ws.warehouse_sk AND inv_item_sk = ss.item_sk AND inv_date_sk = ss.sold_date_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day') AND inv_quantity_on_hand >= (SELECT ss_quantity FROM store_sales WHERE ss_item_sk = ss.item_sk AND ss_customer_sk = ss.customer_sk AND ss_sold_date_sk = ss.sold_date_sk)), final_aggregation AS (SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM joined GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, cnt FROM final_aggregation