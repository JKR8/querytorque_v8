WITH filtered_fact AS (SELECT ss_ext_sales_price, i_brand_id, i_brand, i_manufact_id, i_manufact, c_current_addr_sk, ss_store_sk FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy = 2 INNER JOIN item ON ss_item_sk = i_item_sk AND i_category = 'Shoes' INNER JOIN customer ON ss_customer_sk = c_customer_sk AND c_birth_month = 2 WHERE ss_wholesale_cost BETWEEN 76 AND 96), early_aggregation AS (SELECT i_brand_id, i_brand, i_manufact_id, i_manufact, c_current_addr_sk, ss_store_sk, SUM(ss_ext_sales_price) AS ext_price FROM filtered_fact GROUP BY i_brand_id, i_brand, i_manufact_id, i_manufact, c_current_addr_sk, ss_store_sk), late_zip_join AS (SELECT agg.i_brand_id, agg.i_brand, agg.i_manufact_id, agg.i_manufact, agg.ext_price FROM early_aggregation agg INNER JOIN customer_address ON agg.c_current_addr_sk = ca_address_sk AND ca_state = 'KS' INNER JOIN store ON agg.ss_store_sk = s_store_sk WHERE substring(ca_zip,1,5) <> substring(s_zip,1,5)) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ext_price) AS ext_price FROM late_zip_join GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100