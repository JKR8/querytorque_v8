{
  "query_id": "query023_multi_i2",
  "status": "WIN",
  "best_speedup": 8.9668,
  "original_sql": "with frequent_ss_items as\n (select substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt\n  from store_sales\n      ,date_dim\n      ,item\n  where ss_sold_date_sk = d_date_sk\n    and ss_item_sk = i_item_sk\n    and d_year = 1999\n    and i_manager_id BETWEEN 44 and 63\n     AND i_category IN ('Men', 'Music', 'Sports')\n  group by substring(i_item_desc,1,30),i_item_sk,d_date\n  having count(*) >4),\n max_store_sales as\n (select max(csales) tpcds_cmax\n  from (select c_customer_sk,sum(ss_quantity*ss_sales_price) csales\n        from store_sales\n            ,customer\n            ,date_dim\n        where ss_customer_sk = c_customer_sk\n         and ss_sold_date_sk = d_date_sk\n         and d_year = 1999\n         and ss_wholesale_cost BETWEEN 26 AND 36\n        group by c_customer_sk) tmp1),\n best_ss_customer as\n (select c_customer_sk,sum(ss_quantity*ss_sales_price) ssales\n  from store_sales\n      ,customer\n  where ss_customer_sk = c_customer_sk\n  and c_birth_year BETWEEN 1987 AND 1993\n  group by c_customer_sk\n  having sum(ss_quantity*ss_sales_price) > (95/100.0) * (select\n  *\nfrom\n max_store_sales))\n  select  sum(sales)\n from (select cs_quantity*cs_list_price sales\n       from catalog_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and cs_sold_date_sk = d_date_sk\n         and cs_item_sk in (select item_sk from frequent_ss_items)\n         and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and cs_wholesale_cost BETWEEN 26 AND 36\n      union all\n      select ws_quantity*ws_list_price sales\n       from web_sales\n           ,date_dim\n       where d_year = 1999\n         and d_moy = 5\n         and ws_sold_date_sk = d_date_sk\n         and ws_item_sk in (select item_sk from frequent_ss_items)\n         and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer)\n         and ws_wholesale_cost BETWEEN 26 AND 36) tmp2\n limit 100;",
  "optimized_sql": "WITH frequent_ss_items AS (SELECT SUBSTRING(i_item_desc FROM 1 FOR 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales, date_dim, item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY SUBSTRING(i_item_desc FROM 1 FOR 30), i_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales, customer, date_dim WHERE ss_customer_sk = c_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1), best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales, customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales)), main_sales AS (SELECT cs_quantity * cs_list_price AS sales, cs_bill_customer_sk, cs_item_sk, cs_wholesale_cost FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy = 5 UNION ALL SELECT ws_quantity * ws_list_price, ws_bill_customer_sk, ws_item_sk, ws_wholesale_cost FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy = 5) SELECT SUM(sales) FROM main_sales WHERE cs_wholesale_cost BETWEEN 26 AND 36 AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) LIMIT 100;",
  "transforms": [
    "materialization_prefetch"
  ],
  "n_iterations": 3,
  "n_api_calls": 18,
  "winning_patch": {
    "patch_id": "t1",
    "family": "C+E",
    "transform": "preagg_and_materialize_cte",
    "original_ms": 1114.4,
    "patch_ms": 1152.3
  }
}