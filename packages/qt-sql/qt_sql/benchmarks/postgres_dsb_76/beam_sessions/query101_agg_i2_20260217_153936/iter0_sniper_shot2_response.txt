[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Explicit JOINs with dimension CTEs",
    "hypothesis": "Original plan shows nested loops amplifying rows due to comma joins. Converting to explicit JOINs enables better join ordering. Pre-filtering selective dimensions (d1, item, ca, hd) reduces input to nested loops. EXPLAIN showed 389k rows from store_returns before filtering.",
    "target_ir": "CTEs for d1, item, ca, hd with explicit JOINs replacing comma joins. d2 remains in main query since its condition depends on d1 per-row.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH d1_cte AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000),\nitem_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women')),\nca_cte AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')),\nhd_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 8 AND 14 AND hd_buy_potential = '501-1000')\nSELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt\nFROM store_sales ss\nJOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number\nJOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk\nJOIN d1_cte d1 ON sr.sr_returned_date_sk = d1.d_date_sk\nJOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk\nJOIN item_cte i ON ss.ss_item_sk = i.i_item_sk\nJOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\nJOIN ca_cte ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN hd_cte hd ON c.c_current_hdemo_sk = hd.hd_demo_sk\nWHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day')\n  AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01\nGROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name\nORDER BY cnt;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p04",
    "strategy": "Early fact reduction with d1 pushdown",
    "hypothesis": "Nested loop between d1 and store_returns processes 389k rows. Pushing d1 filter into store_returns CTE breaks this loop. Carrying d_date to main query preserves per-row d2 condition. Original plan showed 42437ms on this join.",
    "target_ir": "CTE pre-joining store_returns with filtered d1. Main query uses carried d_date for d2 condition. Explicit joins replace comma syntax.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_returns AS (\n  SELECT sr.*, d1.d_date\n  FROM store_returns sr\n  JOIN date_dim d1 ON sr.sr_returned_date_sk = d1.d_date_sk\n  WHERE d1.d_year = 2000\n)\nSELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt\nFROM store_sales ss\nJOIN filtered_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number\nJOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk\nJOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk\nJOIN item i ON ss.ss_item_sk = i.i_item_sk\nJOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\nJOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk\nWHERE d2.d_date BETWEEN sr.d_date AND (sr.d_date + INTERVAL '90 day')\n  AND i.i_category IN ('Children', 'Home', 'Women')\n  AND ca.ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')\n  AND hd.hd_income_band_sk BETWEEN 8 AND 14\n  AND hd.hd_buy_potential = '501-1000'\n  AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01\nGROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name\nORDER BY cnt;"
        }
      }
    ]
  }
]