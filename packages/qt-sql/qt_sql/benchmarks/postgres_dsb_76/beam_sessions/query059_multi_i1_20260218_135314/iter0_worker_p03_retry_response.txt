{
  "probe_id": "p03",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering store and date_dim ranges into dedicated CTEs before joining with wss reduces the row count entering the final join, leveraging PostgreSQL's explicit join and predicate pushdown strengths.",
  "reasoning_trace": [
    "Assigned transform targets multi-dimension prefetch to reduce input rows via early filtering.",
    "Comma joins in final_select cause late application of dimension filters; converting to explicit JOINs enables better optimization.",
    "Introducing small, pre-filtered CTEs for store and date_dim allows PostgreSQL to build hash tables efficiently.",
    "wss CTE is already materialized and reused; no duplication occurs, satisfying CTE reuse and fence checks."
  ],
  "target_ir": "store_prefetch and date_prefetch CTEs added; final_select FROM clause rewritten to explicit JOINs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "wss",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim"],
        "outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
        "changed": false
      },
      {
        "node_id": "store_prefetch",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_store_id", "s_store_name"],
        "changed": true,
        "sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')"
      },
      {
        "node_id": "date_prefetch1",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_week_seq", "d_month_seq"],
        "changed": true,
        "sql": "SELECT DISTINCT d_week_seq, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1187 + 11"
      },
      {
        "node_id": "date_prefetch2",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_week_seq", "d_month_seq"],
        "changed": true,
        "sql": "SELECT DISTINCT d_week_seq, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 + 12 AND 1187 + 23"
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["wss", "store_prefetch", "date_prefetch1", "date_prefetch2"],
        "outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_sales1/sun_sales2", "mon_sales1/mon_sales2", "tue_sales1/tue_sales2", "wed_sales1/wed_sales2", "thu_sales1/thu_sales2", "fri_sales1/fri_sales2", "sat_sales1/sat_sales2"],
        "changed": true,
        "sql": "SELECT s1.s_store_name AS s_store_name1, s1.s_store_id AS s_store_id1, w1.d_week_seq AS d_week_seq1,\n       w1.sun_sales / w2.sun_sales AS \"sun_sales1/sun_sales2\",\n       w1.mon_sales / w2.mon_sales AS \"mon_sales1/mon_sales2\",\n       w1.tue_sales / w2.tue_sales AS \"tue_sales1/tue_sales2\",\n       w1.wed_sales / w2.wed_sales AS \"wed_sales1/wed_sales2\",\n       w1.thu_sales / w2.thu_sales AS \"thu_sales1/thu_sales2\",\n       w1.fri_sales / w2.fri_sales AS \"fri_sales1/fri_sales2\",\n       w1.sat_sales / w2.sat_sales AS \"sat_sales1/sat_sales2\"\nFROM wss w1\nJOIN store_prefetch s1 ON w1.ss_store_sk = s1.s_store_sk\nJOIN date_prefetch1 d1 ON w1.d_week_seq = d1.d_week_seq\nJOIN wss w2 ON w1.ss_store_sk = w2.ss_store_sk\nJOIN store_prefetch s2 ON w2.ss_store_sk = s2.s_store_sk\nJOIN date_prefetch2 d2 ON w2.d_week_seq = d2.d_week_seq\nWHERE s1.s_store_id = s2.s_store_id\n  AND w1.d_week_seq = w2.d_week_seq - 52\nORDER BY s1.s_store_name, s1.s_store_id, w1.d_week_seq\nLIMIT 100"
      }
    ]
  }
}