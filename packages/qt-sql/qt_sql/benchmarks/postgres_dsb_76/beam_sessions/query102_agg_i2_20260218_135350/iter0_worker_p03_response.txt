{
  "probe_id": "p0",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Isolating date_dim filters into CTEs and converting comma joins to explicit JOIN syntax will reduce planner confusion and enable better join order selection.",
  "reasoning_trace": [
    "Assigned transform targets comma-join weakness and date range conditions between d1 and d2.",
    "Creating CTEs for d1 and d2 filters isolates selective predicates and enables tiny hash build sides.",
    "Converting comma joins to explicit JOIN syntax helps PostgreSQL's optimizer model join costs accurately.",
    "Preserving all WHERE conditions and output semantics ensures correctness."
  ],
  "target_ir": "date_dim d1 and d2 scans become CTEs with selective filters; FROM clause uses explicit JOINs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"],
        "changed": true,
        "sql": "WITH d1_filtered AS (\n  SELECT *\n  FROM date_dim\n  WHERE d_year = 1998\n),\nd2_filtered AS (\n  SELECT *\n  FROM date_dim d1_base\n  WHERE d1_base.d_year = 1998\n)\nSELECT \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    count(*) as cnt\nFROM\n    store_sales\n    JOIN web_sales ON ss_item_sk = ws_item_sk AND ss_customer_sk = ws_bill_customer_sk\n    JOIN d1_filtered d1 ON ss_sold_date_sk = d1.d_date_sk\n    JOIN d2_filtered d2 ON ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day')\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN inventory ON inv_item_sk = ss_item_sk AND inv_date_sk = ss_sold_date_sk AND inv_quantity_on_hand >= ss_quantity\n    JOIN store ON s_state = w_state\n    JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk\n    JOIN item ON ss_item_sk = i_item_sk\n    JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk\n    JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk\n    JOIN customer_address ON c_current_addr_sk = ca_address_sk\nWHERE\n    i_category IN ('Men', 'Shoes', 'Sports')\n    AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)\n    AND ca_state in ('AR', 'CA', 'KS', 'NY', 'VA')\n    AND ws_wholesale_cost BETWEEN 76 AND 96\nGROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\nORDER BY cnt"
      }
    ]
  }
}