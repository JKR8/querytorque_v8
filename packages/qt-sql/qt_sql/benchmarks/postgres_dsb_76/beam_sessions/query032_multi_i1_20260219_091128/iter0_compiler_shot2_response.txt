[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.92,
    "based_on": "p01",
    "strategy": "Decorrelation via per-item average CTE with early fact filtering.",
    "hypothesis": "Winning probe p01 removes correlated subquery execution by precomputing per-item average discount in a CTE, eliminating repeated scans of catalog_sales and date_dim. This addresses the primary hotspot (SubPlan nested loops) and reduces scan volume by 99%.",
    "expected_explain_delta": "SubPlan nested loops replaced by hash joins; aggregate computed once per item via CTE; date and price filters pushed into CTE.",
    "target_ir": "Add cte_date, cte_fact, cte_avg nodes; rewrite final_select to join CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["cte_fact", "item", "cte_avg"],
          "outputs": ["excess discount amount"],
          "changed": true,
          "sql": "SELECT SUM(f.cs_ext_discount_amt) AS \"excess discount amount\" FROM cte_fact f JOIN item i ON f.cs_item_sk = i.i_item_sk JOIN cte_avg a ON f.cs_item_sk = a.cs_item_sk WHERE (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100) AND f.cs_ext_discount_amt > a.threshold ORDER BY SUM(f.cs_ext_discount_amt) LIMIT 100"
        },
        {
          "node_id": "cte_avg",
          "parent_node_id": "final_select",
          "sources": ["cte_fact"],
          "outputs": ["cs_item_sk", "threshold"],
          "changed": true,
          "sql": "SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM cte_fact GROUP BY cs_item_sk"
        },
        {
          "node_id": "cte_fact",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "cte_date"],
          "outputs": ["cs_item_sk", "cs_ext_discount_amt"],
          "changed": true,
          "sql": "SELECT cs.cs_item_sk, cs.cs_ext_discount_amt FROM catalog_sales cs JOIN cte_date d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 108 AND 137 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 0.23 AND 0.43"
        },
        {
          "node_id": "cte_date",
          "parent_node_id": "cte_fact",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'"
        }
      ]
    }
  }
]