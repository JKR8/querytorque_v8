[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.9,
    "based_on": "p01,p02,p08",
    "strategy": "Decorrelation via per-item threshold CTE with explicit joins and early dimension filtering.",
    "hypothesis": "Winning probes p01, p02, p08 show 736-1461x speedup by decorrelating the per-item threshold subquery. This attempt merges the safest elements: per-item threshold CTE (p01) with early dimension filters (p02/p08) and explicit join syntax, eliminating repeated correlated scans while preserving exact semantics.",
    "expected_explain_delta": "SubPlan nested loops removed; replaced by hash joins between pre‑filtered dimension CTEs, a single per‑item threshold aggregate, and the main fact scan.",
    "target_ir": "Add date_range, item_filtered, per_item_threshold CTEs; rewrite final_select with explicit joins and threshold join.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "item_filtered", "date_range", "per_item_threshold"],
          "outputs": ["excess discount amount"],
          "changed": true,
          "sql": "SELECT SUM(cs.cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales cs JOIN item_filtered i ON cs.cs_item_sk = i.i_item_sk JOIN date_range d ON cs.cs_sold_date_sk = d.d_date_sk JOIN per_item_threshold t ON cs.cs_item_sk = t.cs_item_sk WHERE cs.cs_ext_discount_amt > t.threshold ORDER BY SUM(cs.cs_ext_discount_amt) LIMIT 100"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'"
        },
        {
          "node_id": "item_filtered",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100)"
        },
        {
          "node_id": "per_item_threshold",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_range"],
          "outputs": ["cs_item_sk", "threshold"],
          "changed": true,
          "sql": "SELECT cs.cs_item_sk, 1.3 * AVG(cs.cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN date_range d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 108 AND 137 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 0.23 AND 0.43 GROUP BY cs.cs_item_sk"
        }
      ]
    }
  }
]