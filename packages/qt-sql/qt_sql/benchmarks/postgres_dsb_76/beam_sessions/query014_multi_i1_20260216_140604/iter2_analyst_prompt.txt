## Role

You are a SQL optimization analyst reviewing benchmark results. Analyze what worked, what failed, and design refined targets for the next round of workers.

Identify the primary bottleneck. Only provide secondary targets if they are distinct and high-confidence. Quality > Quantity.

You will see the original query, execution plan, IR structure, and detailed results from previous rounds.

## Query: query014_multi_i1

**Dialect**: POSTGRES

```sql
with  cross_items as
 (select i_item_sk ss_item_sk
 from item,
 (select iss.i_brand_id brand_id
     ,iss.i_class_id class_id
     ,iss.i_category_id category_id
 from store_sales
     ,item iss
     ,date_dim d1
 where ss_item_sk = iss.i_item_sk
   and ss_sold_date_sk = d1.d_date_sk
   and d1.d_year between 1999 AND 1999 + 2
   and i_category IN ('Electronics', 'Jewelry', 'Men')
   and i_manager_id BETWEEN 91 and 100
   and ss_wholesale_cost BETWEEN 35 AND 55
intersect
 select ics.i_brand_id
     ,ics.i_class_id
     ,ics.i_category_id
 from catalog_sales
     ,item ics
     ,date_dim d2
 where cs_item_sk = ics.i_item_sk
   and cs_sold_date_sk = d2.d_date_sk
   and d2.d_year between 1999 AND 1999 + 2
   and i_category IN ('Electronics', 'Jewelry', 'Men')
   and i_manager_id BETWEEN 91 and 100
   and cs_wholesale_cost BETWEEN 35 AND 55
intersect
 select iws.i_brand_id
     ,iws.i_class_id
     ,iws.i_category_id
 from web_sales
     ,item iws
     ,date_dim d3
 where ws_item_sk = iws.i_item_sk
   and ws_sold_date_sk = d3.d_date_sk
   and ws_wholesale_cost BETWEEN 35 AND 55
   and d3.d_year between 1999 AND 1999 + 2) x
 where i_brand_id = brand_id
      and i_class_id = class_id
      and i_category_id = category_id
      and i_category IN ('Electronics', 'Jewelry', 'Men')
      and i_manager_id BETWEEN 91 and 100
),
 avg_sales as
(select avg(quantity*list_price) average_sales
  from (select ss_quantity quantity
             ,ss_list_price list_price
       from store_sales
           ,date_dim
       where ss_sold_date_sk = d_date_sk
         and d_year between 1999 and 1999 + 2
         and ss_wholesale_cost BETWEEN 35 AND 55
       union all
       select cs_quantity quantity
             ,cs_list_price list_price
       from catalog_sales
           ,date_dim
       where cs_sold_date_sk = d_date_sk
         and d_year between 1999 and 1999 + 2
         and cs_wholesale_cost BETWEEN 35 AND 55
       union all
       select ws_quantity quantity
             ,ws_list_price list_price
       from web_sales
           ,date_dim
       where ws_sold_date_sk = d_date_sk
        and ws_wholesale_cost BETWEEN 35 AND 55
         and d_year between 1999 and 1999 + 2) x)
  select  this_year.channel ty_channel
                           ,this_year.i_brand_id ty_brand
                           ,this_year.i_class_id ty_class
                           ,this_year.i_category_id ty_category
                           ,this_year.sales ty_sales
                           ,this_year.number_sales ty_number_sales
                           ,last_year.channel ly_channel
                           ,last_year.i_brand_id ly_brand
                           ,last_year.i_class_id ly_class
                           ,last_year.i_category_id ly_category
                           ,last_year.sales ly_sales
                           ,last_year.number_sales ly_number_sales
 from
 (select 'store' channel, i_brand_id,i_class_id,i_category_id
        ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales
 from store_sales
     ,item
     ,date_dim
 where ss_item_sk in (select ss_item_sk from cross_items)
   and ss_item_sk = i_item_sk
   and ss_sold_date_sk = d_date_sk
   and d_week_seq = (select d_week_seq
                     from date_dim
                     where d_year = 1999 + 1
                       and d_moy = 12
                       and d_dom = 20)
   and i_category IN ('Electronics', 'Jewelry', 'Men')
   and i_manager_id BETWEEN 91 and 100
   and ss_wholesale_cost BETWEEN 35 AND 55
 group by i_brand_id,i_class_id,i_category_id
 having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year,
 (select 'store' channel, i_brand_id,i_class_id
        ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales
 from store_sales
     ,item
     ,date_dim
 where ss_item_sk in (select ss_item_sk from cross_items)
   and ss_item_sk = i_item_sk
   and ss_sold_date_sk = d_date_sk
   and d_week_seq = (select d_week_seq
                     from date_dim
                     where d_year = 1999
                       and d_moy = 12
                       and d_dom = 20)
   and i_category IN ('Electronics', 'Jewelry', 'Men')
   and ss_wholesale_cost BETWEEN 35 AND 55
   and i_manager_id BETWEEN 91 and 100
group by i_brand_id,i_class_id,i_category_id
 having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year
 where this_year.i_brand_id= last_year.i_brand_id
   and this_year.i_class_id = last_year.i_class_id
   and this_year.i_category_id = last_year.i_category_id
 order by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id
 limit 100;
```


## Current Execution Plan

```
Limit  (rows=47, time=15315.356)
  Hash Join  (rows=2664, time=7083.621)
    Seq Scan on item (item_2)  (rows=2682, time=21.924)
    Hash  (rows=381, time=7061.158)
      Subquery Scan (x)  (rows=383, time=7061.124)
        SetOp  (rows=383, time=7061.102)
          Append  (rows=384091, time=7028.743)
            Result  (rows=383, time=6243.647)
              SetOp  (rows=383, time=6243.626)
                Append  (rows=210813, time=6197.809)
                  Subquery Scan (*SELECT* 2)  (rows=14587, time=3830.833)
                    Gather  (rows=14587, time=3826.772)
                      Nested Loop  (rows=14587, time=3823.308)
                        Nested Loop  (rows=1119537, time=2199.238)
                          Index Only Scan on date_dim (d2)  (rows=1096, time=3.636)
                          Index Scan on catalog_sales  (rows=1021, time=1.938)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (ics)  (rows=0, time=0.011)
                  Subquery Scan (*SELECT* 1)  (rows=196226, time=2354.844)
                    Gather  (rows=196226, time=2339.823)
                      Nested Loop  (rows=65409, time=1884.96)
                        Nested Loop  (rows=1292829, time=1050.418)
                          Index Only Scan on date_dim (d1)  (rows=365, time=0.921)
                          Index Only Scan on store_sales (store_sales_2)  (rows=3539, time=2.707)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (iss)  (rows=0, time=0.005)
            Subquery Scan (*SELECT* 3)  (rows=383708, time=767.825)
              Gather  (rows=383708, time=739.746)
                Nested Loop  (rows=127903, time=578.753)
                  Nested Loop  (rows=127903, time=319.266)
                    Index Only Scan on date_dim (d3)  (rows=365, time=0.755)
                    Index Scan on web_sales  (rows=350, time=0.85)
                  Index Scan on item (iws)  (rows=1, time=0.002)
  Aggregate  (rows=1, time=2245.591)
    Gather  (rows=3, time=2245.581)
      Aggregate  (rows=1, time=1935.158)
        Append  (rows=1793911, time=1717.83)
          Nested Loop  (rows=1292829, time=899.416)
            Index Only Scan on date_dim (date_dim_2)  (rows=365, time=0.737)
            Index Only Scan on store_sales (store_sales_3)  (rows=3539, time=2.309)
          Nested Loop  (rows=559768, time=692.16)
            Index Only Scan on date_dim (date_dim_3)  (rows=548, time=1.13)
            Index Scan on catalog_sales (catalog_sales_1)  (rows=1021, time=1.206)
          Nested Loop  (rows=383708, time=873.554)
            Index Only Scan on date_dim (date_dim_4)  (rows=1096, time=1.695)
            Index Scan on web_sales (web_sales_1)  (rows=350, time=0.774)
  Sort  (rows=47, time=15315.197)
    Nested Loop  (rows=47, time=15315.135)
      Aggregate  (rows=151, time=12453.186)
        Index Scan on date_dim (date_dim_5)  (rows=1, time=0.024)
        CTE Scan (avg_sales)  (rows=1, time=2245.566)
        Sort  (rows=2621, time=10207.217)
          Nested Loop  (rows=2621, time=10206.098)
            Nested Loop  (rows=272575, time=9989.51)
              Nested Loop  (rows=2664, time=7107.408)
                Aggregate  (rows=2664, time=7085.971)
                  CTE Scan (cross_items)  (rows=2664, time=7083.882)
                Index Scan on item  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales  (rows=102, time=1.072)
                Bitmap Index Scan  (rows=422, time=0.034)
            Index Scan on date_dim  (rows=0, time=0.001)
      Aggregate  (rows=66, time=18.952)
        Index Scan on date_dim (date_dim_6)  (rows=1, time=0.017)
        CTE Scan (avg_sales_1)  (rows=1, time=0.001)
        Sort  (rows=695, time=18.838)
          Nested Loop  (rows=778, time=2841.541)
            Nested Loop  (rows=272575, time=2632.705)
              Nested Loop  (rows=2664, time=21.451)
                Aggregate  (rows=2664, time=1.758)
                  CTE Scan (cross_items_1)  (rows=2664, time=0.087)
                Index Scan on item (item_1)  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales (store_sales_1)  (rows=102, time=0.971)
                Bitmap Index Scan  (rows=422, time=0.028)
            Index Scan on date_dim (date_dim_1)  (rows=0, time=0.001)
```


## IR Structure (for patch targeting)

```
S0 [SELECT]
  CTE: cross_items  (via CTE_Q_S0_cross_items)
    FROM: item, (subquery) x
    WHERE [60fb583c222ff2dd]: i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id AND i_category IN...
  CTE: avg_sales  (via CTE_Q_S0_avg_sales)
    FROM: (subquery) x
  MAIN QUERY (via Q_S0)
    FROM: (subquery) this_year, (subquery) last_year
    WHERE [0351671740d55a99]: this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND t...
    ORDER BY: this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id

Patch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree
Target: by_node_id (statement, e.g. "S0") + by_anchor_hash (expression)
```

**Note**: Use `by_node_id` (e.g., "S0") and `by_anchor_hash` (16-char hex) from map above to target patch operations.


## Optimization Families

Review the 6 families below. Each has a proven gold example.

Choose up to **4 most relevant families** for this query based on:
- Query structure (CTEs, subqueries, joins, aggregations, set operations)
- Execution plan signals (WHERE placement, repeated scans, correlated subqueries)
- Problem signature (cardinality estimation errors, loops vs sets, filter ordering)



### Family A: Early Filtering (Predicate Pushback)
**Description**: Push small filters into CTEs early, reduce row count before expensive operations
**Speedup Range**: 1.3–4.0x (~35% of all wins)
**Use When**:
  1. Late WHERE filters on dimension tables
  2. Cascading CTEs with filters applied downstream
  3. Expensive joins after filters could be pushed earlier

**Gold Example**: `pg_date_cte_explicit_join` (2.28x)



### Family B: Decorrelation (Sets Over Loops)
**Description**: Convert correlated subqueries to standalone CTEs with GROUP BY, eliminate per-row re-execution
**Speedup Range**: 2.4–2.9x (~15% of all wins)
**Use When**:
  1. Correlated subqueries in WHERE clause
  2. Scalar aggregates computed per outer row
  3. DELIM_SCAN in execution plan (indicates correlation)

**Gold Example**: `pg_shared_scan_decorrelate` (8043.91x (timeout rescue))



### Family C: Aggregation Pushdown (Minimize Rows Touched)
**Description**: Aggregate before expensive joins when GROUP BY keys ⊇ join keys, reduce intermediate sizes
**Speedup Range**: 1.3–15.3x (~5% of all wins (high variance))
**Use When**:
  1. GROUP BY happens after large joins
  2. GROUP BY keys are subset of join keys
  3. Intermediate result size >> final result size

**Gold Example**: `pg_materialized_dimension_fact_prefilter` (12.07x (V2 DSB SF10, was 2.68x in V1))



### Family D: Set Operation Optimization (Sets Over Loops)
**Description**: Replace INTERSECT/UNION-based patterns with EXISTS/NOT EXISTS, avoid full materialization
**Speedup Range**: 1.7–2.7x (~8% of all wins)
**Use When**:
  1. INTERSECT patterns between large sets
  2. UNION ALL with duplicate elimination
  3. Set operations materializing full intermediate results

**Gold Example**: `pg_intersect_to_exists` (1.78x)



### Family E: Materialization / Prefetch (Don't Repeat Work)
**Description**: Extract repeated scans or pre-compute intermediate results for reuse across multiple consumers
**Speedup Range**: 1.3–6.2x (~18% of all wins)
**Use When**:
  1. Repeated scans of same table with different filters
  2. Dimension filters applied independently multiple times
  3. CTE referenced multiple times with implicit re-evaluation

**Gold Example**: `multi_dimension_prefetch` (2.71x)



### Family F: Join Transform (Right Shape First)
**Description**: Restructure join topology: convert comma joins to explicit INNER JOIN, optimize join order, eliminate self-joins via single-pass aggregation
**Speedup Range**: 1.8–8.6x (~19% of all wins)
**Use When**:
  1. Comma-separated joins (implicit cross joins) in FROM clause
  2. Self-joins scanning same table multiple times
  3. Dimension-fact join order suboptimal for predicate pushdown

**Gold Example**: `pg_explicit_join_materialized` (8.56x)



## Optimization History

### History — All Prior Patches

| Iter | Patch | Family | Transform | Speedup | Status | Orig ms | Patch ms | Error (summary) |
|------|-------|--------|-----------|---------|--------|---------|----------|-----------------|
| 0 | t1 | D | set_operation_to_exists | — | FAIL | — | — | Tier-1 structural: LITERAL MISMATCH: Ori |
| 0 | t2 | C | aggregation_pushdown | 1.02x | NEUTRAL | 9031 | 8840 |  |
| 0 | syn_w1 | A | early_filter | — | FAIL | — | — | Step s1 failed: No target found for repl |
| 0 | syn_w3 | E | materialize_cte | — | FAIL | — | — | Step s1 failed: No target found for repl |
| 1 | combo_1 | C+D | aggregation_pushdown_then_setop_rewrite | — | FAIL | — | — | Tier-1 structural: COLUMN REF MISMATCH:  |
| 1 | refine_1 | A+D | push_week_filter_into_cte+fixed_setop_to_exists | — | FAIL | — | — | Tier-1 structural: LITERAL MISMATCH: Ori |
| 1 | novel_1 | E | cte_materialization | 1.03x | NEUTRAL | 10559 | 10235 |  |



### Latest Iteration 1 — Detailed Results

#### Race Results

| Patch | Family | Transform | Speedup | Status | Orig ms | Patch ms | Semantic | Error |
|-------|--------|-----------|---------|--------|---------|----------|----------|-------|
| combo_1 | C+D | aggregation_pushdown_then_setop_rewrite | — | FAIL | — | — | FAIL | Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite —  |
| refine_1 | A+D | push_week_filter_into_cte+fixed_setop_to_exists | — | FAIL | — | — | FAIL | Tier-1 structural: LITERAL MISMATCH: Original literals missing from rewrite — st |
| novel_1 | E | cte_materialization | 1.03x | NEUTRAL | 10559 | 10235 | PASS |  |

#### Patched SQL

**combo_1 (Family C+D, aggregation_pushdown_then_setop_rewrite):**
```sql
WITH avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss.ss_quantity AS quantity, ss.ss_list_price AS list_price FROM store_sales AS ss JOIN date_dim AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year BETWEEN 1999 AND 1999 + 2 AND ss.ss_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT cs.cs_quantity AS quantity, cs.cs_list_price AS list_price FROM catalog_sales AS cs JOIN date_dim AS d2 ON cs.cs_sold_date_sk = d2.d_date_sk WHERE d2.d_year BETWEEN 1999 AND 1999 + 2 AND cs.cs_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT ws.ws_quantity AS quantity, ws.ws_list_price AS list_price FROM web_sales AS ws JOIN date_dim AS d3 ON ws.ws_sold_date_sk = d3.d_date_sk WHERE d3.d_year BETWEEN 1999 AND 1999 + 2 AND ws.ws_wholesale_cost BETWEEN 35 AND 55) AS x), store_sales_agg AS (SELECT iss.i_brand_id, iss.i_class_id, iss.i_category_id FROM store_sales AS ss JOIN item AS iss ON ss.ss_item_sk = iss.i_item_sk JOIN date_dim AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year BETWEEN 1999 AND 1999 + 2 AND iss.i_category IN ('Electronics', 'Jewelry', 'Men') AND iss.i_manager_id BETWEEN 91 AND 100 AND ss.ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY iss.i_brand_id, iss.i_class_id, iss.i_category_id), catalog_sales_agg AS (SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales AS cs JOIN item AS ics ON cs.cs_item_sk = ics.i_item_sk JOIN date_dim AS d2 ON cs.cs_sold_date_sk = d2.d_date_sk WHERE d2.d_year BETWEEN 1999 AND 1999 + 2 AND ics.i_category IN ('Electronics', 'Jewelry', 'Men') AND ics.i_manager_id BETWEEN 91 AND 100 AND cs.cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY ics.i_brand_id, ics.i_class_id, ics.i_category_id), web_sales_agg AS (SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales AS ws JOIN item AS iws ON ws.ws_item_sk = iws.i_item_sk JOIN date_dim AS d3 ON ws.ws_sold_date_sk = d3.d_date_sk WHERE d3.d_year BETWEEN 1999 AND 1999 + 2 AND iws.i_category IN ('Electronics', 'Jewelry', 'Men') AND iws.i_manager_id BETWEEN 91 AND 100 AND ws.ws_wholesale_cost BETWEEN 35 AND 55 GROUP BY iws.i_brand_id, iws.i_class_id, iws.i_category_id), cross_items AS (SELECT i.i_item_sk AS ss_item_sk FROM item AS i WHERE i.i_category IN ('Electronics', 'Jewelry', 'Men') AND i.i_manager_id BETWEEN 91 AND 100 AND EXISTS(SELECT 1 FROM store_sales_agg AS ssa WHERE ssa.i_brand_id = i.i_brand_id AND ssa.i_class_id = i.i_class_id AND ssa.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM catalog_sales_agg AS csa WHERE csa.i_brand_id = i.i_brand_id AND csa.i_class_id = i.i_class_id AND csa.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM web_sales_agg AS wsa WHERE wsa.i_brand_id = i.i_brand_id AND wsa.i_class_id = i.i_class_id AND wsa.i_category_id = i.i_category_id)) SELECT this_year.channel AS ty_channel, this_year.i_brand_id AS ty_brand, this_year.i_class_id AS ty_class, this_year.i_category_id AS ty_category, this_year.sales AS ty_sales, this_year.number_sales AS ty_number_sales, last_year.channel AS ly_channel, last_year.i_brand_id AS ly_brand, last_year.i_class_id AS ly_class, last_year.i_category_id AS ly_category, last_year.sales AS ly_sales, last_year.number_sales AS ly_number_sales FROM (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk WHERE ss.ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 20) AND i.i_category IN ('Electronics', 'Jewelry', 'Men') AND i.i_manager_id BETWEEN 91 AND 100 AND ss.ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > (SELECT average_sales FROM avg_sales)) AS this_year, (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk WHERE ss.ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20) AND i.i_category IN ('Electronics', 'Jewelry', 'Men') AND i.i_manager_id BETWEEN 91 AND 100 AND ss.ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > (SELECT average_sales FROM avg_sales)) AS last_year WHERE this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND this_year.i_category_id = last_year.i_category_id ORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id LIMIT 100;
```

**refine_1 (Family A+D, push_week_filter_into_cte+fixed_setop_to_exists):**
```sql
WITH cross_items AS (SELECT i_item_sk AS ss_item_sk FROM item, (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id FROM store_sales, item AS iss, date_dim AS d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100 AND ss_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, item AS ics, date_dim AS d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100 AND cs_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, item AS iws, date_dim AS d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND d3.d_year BETWEEN 1999 AND 1999 + 2) AS x WHERE i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id AND i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 1999 + 2 AND ss_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 1999 + 2 AND cs_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, date_dim WHERE ws_sold_date_sk = d_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND d_year BETWEEN 1999 AND 1999 + 2) AS x), filtered_week AS (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 20), store_sales_filtered AS (SELECT iss.i_item_sk, iss.i_brand_id, iss.i_class_id, iss.i_category_id FROM store_sales JOIN item AS iss ON ss_item_sk = iss.i_item_sk JOIN date_dim AS d1 ON ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year BETWEEN 1999 AND 1999 + 2 AND iss.i_category IN ('Electronics', 'Jewelry', 'Men') AND iss.i_manager_id BETWEEN 91 AND 100 AND ss_wholesale_cost BETWEEN 35 AND 55), catalog_sales_filtered AS (SELECT ics.i_item_sk, ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales JOIN item AS ics ON cs_item_sk = ics.i_item_sk JOIN date_dim AS d2 ON cs_sold_date_sk = d2.d_date_sk WHERE d2.d_year BETWEEN 1999 AND 1999 + 2 AND ics.i_category IN ('Electronics', 'Jewelry', 'Men') AND ics.i_manager_id BETWEEN 91 AND 100 AND cs_wholesale_cost BETWEEN 35 AND 55) SELECT i.i_item_sk AS ss_item_sk FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20) AS lw ON d_week_seq = lw.d_week_seq WHERE i.i_category IN ('Electronics', 'Jewelry', 'Men') AND i.i_manager_id BETWEEN 91 AND 100 AND EXISTS(SELECT 1 FROM store_sales_filtered AS ssf WHERE ssf.i_brand_id = i.i_brand_id AND ssf.i_class_id = i.i_class_id AND ssf.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM catalog_sales_filtered AS csf WHERE csf.i_brand_id = i.i_brand_id AND csf.i_class_id = i.i_class_id AND csf.i_category_id = i.i_category_id) AND EXISTS(SELECT 1 FROM web_sales JOIN item AS iws ON ws_item_sk = iws.i_item_sk JOIN date_dim AS d3 ON ws_sold_date_sk = d3.d_date_sk WHERE d3.d_year BETWEEN 1999 AND 1999 + 2 AND iws.i_category = i.i_category AND iws.i_manager_id BETWEEN 91 AND 100 AND ws_wholesale_cost BETWEEN 35 AND 55 AND iws.i_brand_id = i.i_brand_id AND iws.i_class_id = i.i_class_id AND iws.i_category_id = i.i_category_id);
```

**novel_1 (Family E, cte_materialization) — 1.03x NEUTRAL:**
```sql
WITH cross_items AS (SELECT i_item_sk AS ss_item_sk FROM item JOIN (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id FROM store_sales JOIN item AS iss ON ss_item_sk = iss.i_item_sk JOIN date_dim AS d1 ON ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year BETWEEN 1999 AND 1999 + 2 AND iss.i_category IN ('Electronics', 'Jewelry', 'Men') AND iss.i_manager_id BETWEEN 91 AND 100 AND ss_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales JOIN item AS ics ON cs_item_sk = ics.i_item_sk JOIN date_dim AS d2 ON cs_sold_date_sk = d2.d_date_sk WHERE d2.d_year BETWEEN 1999 AND 1999 + 2 AND ics.i_category IN ('Electronics', 'Jewelry', 'Men') AND ics.i_manager_id BETWEEN 91 AND 100 AND cs_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales JOIN item AS iws ON ws_item_sk = iws.i_item_sk JOIN date_dim AS d3 ON ws_sold_date_sk = d3.d_date_sk WHERE d3.d_year BETWEEN 1999 AND 1999 + 2 AND iws.i_category IN ('Electronics', 'Jewelry', 'Men') AND iws.i_manager_id BETWEEN 91 AND 100 AND ws_wholesale_cost BETWEEN 35 AND 55) AS x ON i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id WHERE i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 1999 + 2 AND ss_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT cs_quantity, cs_list_price FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 1999 + 2 AND cs_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT ws_quantity, ws_list_price FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year BETWEEN 1999 AND 1999 + 2 AND ws_wholesale_cost BETWEEN 35 AND 55) AS x) SELECT this_year.channel AS ty_channel, this_year.i_brand_id AS ty_brand, this_year.i_class_id AS ty_class, this_year.i_category_id AS ty_category, this_year.sales AS ty_sales, this_year.number_sales AS ty_number_sales, last_year.channel AS ly_channel, last_year.i_brand_id AS ly_brand, last_year.i_class_id AS ly_class, last_year.i_category_id AS ly_category, last_year.sales AS ly_sales, last_year.number_sales AS ly_number_sales FROM (SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 20) AND i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)) AS this_year, (SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20) AND i_category IN ('Electronics', 'Jewelry', 'Men') AND i_manager_id BETWEEN 91 AND 100 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)) AS last_year WHERE this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND this_year.i_category_id = last_year.i_category_id ORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id LIMIT 100;
```

#### Execution Plans

**Original EXPLAIN:**
```
Limit  (rows=47, time=15315.356)
  Hash Join  (rows=2664, time=7083.621)
    Seq Scan on item (item_2)  (rows=2682, time=21.924)
    Hash  (rows=381, time=7061.158)
      Subquery Scan (x)  (rows=383, time=7061.124)
        SetOp  (rows=383, time=7061.102)
          Append  (rows=384091, time=7028.743)
            Result  (rows=383, time=6243.647)
              SetOp  (rows=383, time=6243.626)
                Append  (rows=210813, time=6197.809)
                  Subquery Scan (*SELECT* 2)  (rows=14587, time=3830.833)
                    Gather  (rows=14587, time=3826.772)
                      Nested Loop  (rows=14587, time=3823.308)
                        Nested Loop  (rows=1119537, time=2199.238)
                          Index Only Scan on date_dim (d2)  (rows=1096, time=3.636)
                          Index Scan on catalog_sales  (rows=1021, time=1.938)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (ics)  (rows=0, time=0.011)
                  Subquery Scan (*SELECT* 1)  (rows=196226, time=2354.844)
                    Gather  (rows=196226, time=2339.823)
                      Nested Loop  (rows=65409, time=1884.96)
                        Nested Loop  (rows=1292829, time=1050.418)
                          Index Only Scan on date_dim (d1)  (rows=365, time=0.921)
                          Index Only Scan on store_sales (store_sales_2)  (rows=3539, time=2.707)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (iss)  (rows=0, time=0.005)
            Subquery Scan (*SELECT* 3)  (rows=383708, time=767.825)
              Gather  (rows=383708, time=739.746)
                Nested Loop  (rows=127903, time=578.753)
                  Nested Loop  (rows=127903, time=319.266)
                    Index Only Scan on date_dim (d3)  (rows=365, time=0.755)
                    Index Scan on web_sales  (rows=350, time=0.85)
                  Index Scan on item (iws)  (rows=1, time=0.002)
  Aggregate  (rows=1, time=2245.591)
    Gather  (rows=3, time=2245.581)
      Aggregate  (rows=1, time=1935.158)
        Append  (rows=1793911, time=1717.83)
          Nested Loop  (rows=1292829, time=899.416)
            Index Only Scan on date_dim (date_dim_2)  (rows=365, time=0.737)
            Index Only Scan on store_sales (store_sales_3)  (rows=3539, time=2.309)
          Nested Loop  (rows=559768, time=692.16)
            Index Only Scan on date_dim (date_dim_3)  (rows=548, time=1.13)
            Index Scan on catalog_sales (catalog_sales_1)  (rows=1021, time=1.206)
          Nested Loop  (rows=383708, time=873.554)
            Index Only Scan on date_dim (date_dim_4)  (rows=1096, time=1.695)
            Index Scan on web_sales (web_sales_1)  (rows=350, time=0.774)
  Sort  (rows=47, time=15315.197)
    Nested Loop  (rows=47, time=15315.135)
      Aggregate  (rows=151, time=12453.186)
        Index Scan on date_dim (date_dim_5)  (rows=1, time=0.024)
        CTE Scan (avg_sales)  (rows=1, time=2245.566)
        Sort  (rows=2621, time=10207.217)
          Nested Loop  (rows=2621, time=10206.098)
            Nested Loop  (rows=272575, time=9989.51)
              Nested Loop  (rows=2664, time=7107.408)
                Aggregate  (rows=2664, time=7085.971)
                  CTE Scan (cross_items)  (rows=2664, time=7083.882)
                Index Scan on item  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales  (rows=102, time=1.072)
                Bitmap Index Scan  (rows=422, time=0.034)
            Index Scan on date_dim  (rows=0, time=0.001)
      Aggregate  (rows=66, time=18.952)
        Index Scan on date_dim (date_dim_6)  (rows=1, time=0.017)
        CTE Scan (avg_sales_1)  (rows=1, time=0.001)
        Sort  (rows=695, time=18.838)
          Nested Loop  (rows=778, time=2841.541)
            Nested Loop  (rows=272575, time=2632.705)
              Nested Loop  (rows=2664, time=21.451)
                Aggregate  (rows=2664, time=1.758)
                  CTE Scan (cross_items_1)  (rows=2664, time=0.087)
                Index Scan on item (item_1)  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales (store_sales_1)  (rows=102, time=0.971)
                Bitmap Index Scan  (rows=422, time=0.028)
            Index Scan on date_dim (date_dim_1)  (rows=0, time=0.001)
```

**novel_1 (1.03x NEUTRAL) EXPLAIN:**
```
Limit  (rows=47, time=11852.818)
  Hash Join  (rows=2637, time=3859.645)
    Subquery Scan (x)  (rows=371, time=3834.098)
      SetOp  (rows=371, time=3834.075)
        Append  (rows=5490, time=3831.295)
          Subquery Scan (*SELECT* 3)  (rows=5107, time=657.504)
            Gather  (rows=5107, time=656.637)
              Nested Loop  (rows=1702, time=543.169)
                Nested Loop  (rows=127903, time=306.108)
                  Index Only Scan on date_dim (d3)  (rows=365, time=0.726)
                  Index Scan on web_sales  (rows=350, time=0.815)
                Index Scan on item (iws)  (rows=0, time=0.002)
          Result  (rows=383, time=3173.346)
            SetOp  (rows=383, time=3173.315)
              Append  (rows=210813, time=3144.101)
                Subquery Scan (*SELECT* 2)  (rows=14587, time=939.212)
                  Gather  (rows=14587, time=937.639)
                    Nested Loop  (rows=4862, time=772.191)
                      Nested Loop  (rows=373179, time=462.419)
                        Index Only Scan on date_dim (d2)  (rows=365, time=0.622)
                        Index Scan on catalog_sales  (rows=1021, time=1.213)
                      Memoize  (rows=0, time=0.001)
                        Index Scan on item (ics)  (rows=0, time=0.003)
                Subquery Scan (*SELECT* 1)  (rows=196226, time=2194.709)
                  Gather  (rows=196226, time=2181.751)
                    Nested Loop  (rows=98113, time=2181.281)
                      Nested Loop  (rows=1939244, time=1315.32)
                        Index Only Scan on date_dim (d1)  (rows=548, time=1.059)
                        Index Only Scan on store_sales (store_sales_2)  (rows=3539, time=2.249)
                      Memoize  (rows=0, time=0.0)
                        Index Scan on item (iss)  (rows=0, time=0.003)
    Hash  (rows=2679, time=25.332)
      Seq Scan on item (item_2)  (rows=2682, time=24.839)
  Aggregate  (rows=1, time=2215.491)
    Gather  (rows=3, time=2215.483)
      Aggregate  (rows=1, time=1932.573)
        Append  (rows=1793911, time=1707.735)
          Nested Loop  (rows=1292829, time=904.398)
            Index Only Scan on date_dim (date_dim_2)  (rows=365, time=0.727)
            Index Only Scan on store_sales (store_sales_3)  (rows=3539, time=2.314)
          Nested Loop  (rows=559768, time=684.751)
            Index Only Scan on date_dim (date_dim_3)  (rows=548, time=0.83)
            Index Scan on catalog_sales (catalog_sales_1)  (rows=1021, time=1.19)
          Nested Loop  (rows=383708, time=832.696)
            Index Only Scan on date_dim (date_dim_4)  (rows=1096, time=1.427)
            Index Scan on web_sales (web_sales_1)  (rows=350, time=0.737)
  Sort  (rows=47, time=11852.622)
    Nested Loop  (rows=47, time=11852.581)
      Aggregate  (rows=150, time=8988.663)
        Index Scan on date_dim (date_dim_5)  (rows=1, time=0.014)
        CTE Scan (avg_sales)  (rows=1, time=2215.456)
        Sort  (rows=2617, time=6772.789)
          Nested Loop  (rows=2617, time=6771.653)
            Nested Loop  (rows=271899, time=6558.36)
              Nested Loop  (rows=2637, time=3882.311)
                Aggregate  (rows=2637, time=3861.759)
                  CTE Scan (cross_items)  (rows=2637, time=3859.723)
                Index Scan on item  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales  (rows=103, time=1.005)
                Bitmap Index Scan  (rows=425, time=0.033)
            Index Scan on date_dim  (rows=0, time=0.001)
      Aggregate  (rows=65, time=19.091)
        Index Scan on date_dim (date_dim_6)  (rows=1, time=0.015)
        CTE Scan (avg_sales_1)  (rows=1, time=0.001)
        Sort  (rows=693, time=18.976)
          Nested Loop  (rows=776, time=2843.56)
            Nested Loop  (rows=271899, time=2627.576)
              Nested Loop  (rows=2637, time=21.331)
                Aggregate  (rows=2637, time=1.676)
                  CTE Scan (cross_items_1)  (rows=2637, time=0.082)
                Index Scan on item (item_1)  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales (store_sales_1)  (rows=103, time=0.978)
                Bitmap Index Scan  (rows=425, time=0.027)
            Index Scan on date_dim (date_dim_1)  (rows=0, time=0.001)
```

#### Error Details

- **combo_1** (FAIL): Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite — ['brand_id', 'category_id', 'class_id']. The rewrite references different table columns.
- **refine_1** (FAIL): Tier-1 structural: LITERAL MISMATCH: Original literals missing from rewrite — strings: ['store']. The rewrite changed filter values instead of preserving them.


## Your Task — Snipe Round 2


Results from latest iteration: **2 FAIL, 1 NEUTRAL**.

Follow this protocol exactly.

### Step 1 — Compare EXPLAIN Plans

For each patch above, compare its EXPLAIN plan to the Original EXPLAIN.

For each **WIN**, answer:
- QUOTE the operator line(s) from the original that got cheaper or were eliminated. Give the exact operator name, time, and row count from the plan text above.
- What structural SQL change caused that operator improvement?
- What is the **most expensive remaining operator** in this winner's plan? QUOTE its line (name, time, rows).

For each **FAIL/NEUTRAL/REGRESSION**:
- QUOTE the operator(s) that got MORE expensive vs the original.
- Why did the structural change backfire?

Then classify winners as REDUNDANT (same core structural change, same operators improved) or COMPLEMENTARY (different operators improved, different structural changes).

### Step 2 — Design Targets by Combining Strategies

Start from the **best winner's SQL** as your baseline.

**CRITICAL**: Do NOT invent new hypotheses about row counts or selectivity. Every claim about rows, times, or costs MUST be a direct quote from an EXPLAIN plan above. If a number is not in the plans, you do not know it.

**CRITICAL**: Do NOT spend targets on optimizer-equivalent rewrites (UNION↔UNION ALL, JOIN↔WHERE IN, CTE↔subquery). These produce identical plans. Focus on changes that **eliminate operators** or **reduce input rows to expensive operators** as shown in the plans.

Design up to 4 targets, prioritized:

1. **Combination** (primary if complementary winners exist): Take the best winner's SQL. Layer on the structural change from a complementary winner that addresses a DIFFERENT expensive operator. Cite both operators by name from the EXPLAIN plans.
2. **Refinement**: Take the best winner's SQL. Target its most expensive remaining operator (quoted in Step 1). Design a structural change that reduces input rows to that operator. CITE the operator and its current row count from the plan.
3. **Rescue** (if a failed patch had a sound structural idea): Fix the implementation while preserving the best winner's gains.
4. **Novel**: A new structural approach that targets the most expensive remaining operator. Cite the operator from the plan.

**Combined families**: You MAY combine families in a single target (e.g. "A+B", "B+E", "A+F"). The worker will receive gold examples from ALL referenced families.

Output up to 4 targets. Same JSON format:

```json
[
  {
    "family": "A+B",
    "transform": "early_filter_then_decorrelate",
    "target_id": "t1",
    "relevance_score": 0.95,
    "hypothesis": "...",
    "target_ir": "...",
    "recommended_examples": ["date_cte_isolate", "shared_scan_decorrelate"]
  }
]
```

Output up to 4 targets. Fewer strong targets beat padding with weak ones.
