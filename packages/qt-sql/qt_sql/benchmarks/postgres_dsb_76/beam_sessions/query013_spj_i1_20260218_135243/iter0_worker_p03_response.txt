{
  "probe_id": "scout_early_filter",
  "transform_id": "early_filter",
  "family": "A",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering small dimension tables into CTEs reduces the row count entering large joins, especially Nested Loop and Hash Join operators. This aligns with the observed cardinality underestimation and high join costs.",
  "reasoning_trace": [
    "Nested Loop shows severe underestimation (est=1,928, act=56K), suggesting inefficient dimension probing.",
    "Comma-join syntax prevents optimal predicate pushdown; explicit JOINs with CTEs improve clarity and optimization paths.",
    "Each dimension table (store, customer_demographics, etc.) is small and suitable for early filtering into hash tables.",
    "CTE reuse is single-use and selective, satisfying G_PG_CTE_REUSE_REQUIRED and avoiding materialization penalties."
  ],
  "target_ir": "Dimension tables (store, customer_demographics, household_demographics, customer_address) become CTEs with selective filters; store_sales joins against them explicitly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_store_sales"],
        "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
        "changed": true,
        "sql": "SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM filtered_store_sales"
      },
      {
        "node_id": "filtered_store_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "filtered_store", "filtered_customer_demographics", "filtered_household_demographics", "filtered_customer_address", "date_dim"],
        "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost"],
        "changed": true,
        "sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales ss JOIN filtered_store s ON ss.ss_store_sk = s.s_store_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001 JOIN filtered_customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN filtered_customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'U' AND cd.cd_education_status = 'College' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Unknown' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('CO', 'NC', 'TX') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'NY', 'TX') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('IA', 'IL', 'NC') AND ss.ss_net_profit BETWEEN 50 AND 250))"
      },
      {
        "node_id": "filtered_store",
        "parent_node_id": "filtered_store_sales",
        "sources": ["store"],
        "outputs": ["s_store_sk"],
        "changed": true,
        "sql": "SELECT s_store_sk FROM store"
      },
      {
        "node_id": "filtered_customer_demographics",
        "parent_node_id": "filtered_store_sales",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M', 'U', 'S')"
      },
      {
        "node_id": "filtered_household_demographics",
        "parent_node_id": "filtered_store_sales",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_dep_count"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (1, 3)"
      },
      {
        "node_id": "filtered_customer_address",
        "parent_node_id": "filtered_store_sales",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX', 'AR', 'NY', 'IA', 'IL')"
      }
    ]
  }
}