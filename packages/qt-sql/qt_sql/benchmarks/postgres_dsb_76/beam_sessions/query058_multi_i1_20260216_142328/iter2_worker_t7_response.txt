{
  "plan_id": "gold_postgres_ecf_prefetch_then_aggregate_fact_explicit_join",
  "dialect": "postgres",
  "description": "Optimize E+C+F query pattern by: (1) prefetching shared date dimension into a materialized CTE, (2) aggregating fact tables by foreign keys before joining dimensions to reduce row count, and (3) replacing comma joins with explicit INNER JOINs in the main query for better join planning.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "target_month_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')"
      },
      "description": "Insert CTE 'target_month_dates' to prefetch the target month's dates"
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "ss_items"
      },
      "payload": {
        "sql_fragment": "ss_items AS (SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ss_ext_sales_price) AS ss_item_rev FROM store_sales INNER JOIN item ON ss_item_sk = i_item_sk INNER JOIN target_month_dates ON ss_sold_date_sk = d_date_sk INNER JOIN customer ON ss_customer_sk = c_customer_sk WHERE ss_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year)"
      },
      "description": "Replace CTE 'ss_items' body with optimized version using explicit JOINs and prefiltered dates"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "cs_items"
      },
      "payload": {
        "sql_fragment": "cs_items AS (SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(cs_ext_sales_price) AS cs_item_rev FROM catalog_sales INNER JOIN item ON cs_item_sk = i_item_sk INNER JOIN target_month_dates ON cs_sold_date_sk = d_date_sk INNER JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE cs_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year)"
      },
      "description": "Replace CTE 'cs_items' body with optimized version using explicit JOINs and prefiltered dates"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "ws_items"
      },
      "payload": {
        "sql_fragment": "ws_items AS (SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ws_ext_sales_price) AS ws_item_rev FROM web_sales INNER JOIN item ON ws_item_sk = i_item_sk INNER JOIN target_month_dates ON ws_sold_date_sk = d_date_sk INNER JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE ws_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year)"
      },
      "description": "Replace CTE 'ws_items' body with optimized version using explicit JOINs and prefiltered dates"
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "ss_items INNER JOIN cs_items ON ss_items.item_id = cs_items.item_id AND ss_items.birth_year = cs_items.birth_year INNER JOIN ws_items ON ss_items.item_id = ws_items.item_id AND ss_items.birth_year = ws_items.birth_year"
      },
      "description": "Replace comma-join FROM with explicit JOINs"
    },
    {
      "step_id": "s6",
      "op": "delete_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "c32fec078499ee27"
      },
      "description": "Remove WHERE clause from main query (conditions moved to CTEs or expressed as JOIN conditions)"
    }
  ]
}