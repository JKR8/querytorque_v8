[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01",
    "strategy": "Single filtered store_sales CTE with common d_year=1998 filter for frequent_ss_items and max_store_sales, leaving best_ss_customer independent.",
    "hypothesis": "Primary hotspot is three separate store_sales scans. Probe p01 failed due to missing d_date column. This corrected version creates a base CTE with d_year=1998 and d_date, reused by frequent_ss_items and max_store_sales, eliminating two of the three repeated scans. Best_ss_customer remains unchanged to preserve semantics.",
    "expected_explain_delta": "Two store_sales scans removed; frequent_ss_items and max_store_sales become CTE scans on pre-filtered base. Hash join wait times may reduce due to smaller intermediate results.",
    "target_ir": "Add store_sales_1998 node, update frequent_ss_items and max_store_sales sources.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "date_dim", "web_sales", "best_ss_customer", "frequent_ss_items"],
          "outputs": ["SUM(sales)"],
          "changed": false
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales_1998", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, count(*) cnt FROM store_sales_1998 JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id BETWEEN 81 and 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) >4"
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "best_ss_customer",
          "sources": ["store_sales_1998", "customer"],
          "outputs": ["tpcds_cmax"],
          "changed": true,
          "sql": "SELECT max(csales) tpcds_cmax FROM (SELECT c_customer_sk, sum(ss_quantity*ss_sales_price) csales FROM store_sales_1998 JOIN customer ON ss_customer_sk = c_customer_sk WHERE ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) tmp1"
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": false
        },
        {
          "node_id": "store_sales_1998",
          "parent_node_id": "frequent_ss_items",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["ss_item_sk", "ss_customer_sk", "ss_quantity", "ss_sales_price", "ss_wholesale_cost", "ss_sold_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_customer_sk, ss_quantity, ss_sales_price, ss_wholesale_cost, ss_sold_date_sk, d_date FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1998"
        }
      ]
    }
  }
]