{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.04843024,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 133459,
    "completion_tokens": 27522,
    "total_tokens": 160981,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 55552,
    "reasoning_tokens": 15846
  },
  "best_speedup": 1.2,
  "best_patch_id": "p02",
  "best_sql": "SELECT count(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND d2.d_month_seq BETWEEN 1214 AND 1214+11 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND d3.d_month_seq BETWEEN 1214 AND 1214+11 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date)) cool_cust;",
  "patches": [
    {
      "patch_id": "p02",
      "family": "D",
      "transform": "intersect_to_exists",
      "relevance_score": 0.65,
      "status": "WIN",
      "speedup": 1.2,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1697.3,
      "patch_ms": 1415.2,
      "output_sql": "SELECT count(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND d2.d_month_seq BETWEEN 1214 AND 1214+11 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND d3.d_month_seq BETWEEN 1214 AND 1214+11 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date)) cool_cust;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert EXCEPT operations to NOT EXISTS anti-joins, keeping the three branches as derived tables but using WHERE NOT EXISTS instead of set operations."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_prefetch AS (select d_date_sk, d_date from date_dim where d_month_seq between 1214 and 1214+11), customer_prefetch AS (select c_customer_sk, c_last_name, c_first_name from customer where c_birth_year BETWEEN 1955 AND 1961), branch_1 AS (select distinct c.c_last_name, c.c_first_name, d.d_date from store_sales ss join date_prefetch d on ss.ss_sold_date_sk = d.d_date_sk join customer_prefetch c on ss.ss_customer_sk = c.c_customer_sk), branch_2 AS (select distinct c.c_last_name, c.c_first_name, d.d_date from catalog_sales cs join date_prefetch d on cs.cs_sold_date_sk = d.d_date_sk join customer_prefetch c on cs.cs_bill_customer_sk = c.c_customer_sk), branch_3 AS (select distinct c.c_last_name, c.c_first_name, d.d_date from web_sales ws join date_prefetch d on ws.ws_sold_date_sk = d.d_date_sk join customer_prefetch c on ws.ws_bill_customer_sk = c.c_customer_sk) select count(*) from ((select distinct c_last_name, c_first_name, d_date from branch_1) except (select distinct c_last_name, c_first_name, d_date from branch_2) except (select distinct c_last_name, c_first_name, d_date from branch_3)) cool_cust;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create separate MATERIALIZED CTEs for filtered date_dim and filtered customer (c_birth_year range), then join both to each fact table branch with explicit JOIN syntax."
    },
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date, d_month_seq\nFROM date_dim\nWHERE d_month_seq BETWEEN 1214 AND 1225), branch_1 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\nFROM store_sales ss\nINNER JOIN filtered_date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\nINNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk\nWHERE d.d_month_seq BETWEEN 1214 AND 1225\n  AND ss_list_price BETWEEN 242 AND 271\n  AND c_birth_year BETWEEN 1955 AND 1961\n  AND ss_wholesale_cost BETWEEN 35 AND 45), branch_2 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\nFROM catalog_sales cs\nINNER JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk\nINNER JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk\nWHERE d.d_month_seq BETWEEN 1214 AND 1225\n  AND cs_list_price BETWEEN 242 AND 271\n  AND c_birth_year BETWEEN 1955 AND 1961\n  AND cs_wholesale_cost BETWEEN 35 AND 45), branch_3 AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\nFROM web_sales ws\nINNER JOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nINNER JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk\nWHERE d.d_month_seq BETWEEN 1214 AND 1225\n  AND ws_list_price BETWEEN 242 AND 271\n  AND c_birth_year BETWEEN 1955 AND 1961\n  AND ws_wholesale_cost BETWEEN 35 AND 45), except_combined AS ((select distinct c_last_name, c_first_name, d_date\n from branch_1\n except\n select distinct c_last_name, c_first_name, d_date\n from branch_2\n except\n select distinct c_last_name, c_first_name, d_date\n from branch_3)) select count(*)\nfrom except_combined cool_cust;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create a MATERIALIZED CTE for filtered date_dim rows (d_month_seq between 1214 and 1225) and convert comma joins to explicit INNER JOIN syntax in all three EXCEPT branches."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.5,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column cs.c_last_name does not exist\nLINE 1: ...61 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND cs.c_last_...\n                                                             ^\nHINT:  Perhaps you meant to reference the column \"c.c_last_name\".\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH cool_cust AS (WITH store_sales_branch AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) SELECT c_last_name, c_first_name, d_date FROM store_sales_branch WHERE NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND cs.c_last_name = store_sales_branch.c_last_name AND cs.c_first_name = store_sales_branch.c_first_name AND cs.d_date = store_sales_branch.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND ws.c_last_name = store_sales_branch.c_last_name AND ws.c_first_name = store_sales_branch.c_first_name AND ws.d_date = store_sales_branch.d_date)) SELECT count(*) FROM cool_cust;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the first branch (store_sales) as a CTE, then use it as basis for NOT EXISTS checks against catalog_sales and web_sales derived tables."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 1 missing, 1 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "SELECT COUNT(*) AS count FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND d2.d_month_seq BETWEEN 1214 AND 1214+11 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND d3.d_month_seq BETWEEN 1214 AND 1214+11 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date)) cool_cust;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 1 missing, 1 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11), filtered_customer AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961) SELECT COUNT(*) AS count FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN filtered_date d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN filtered_customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN filtered_date d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN filtered_customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date)) cool_cust;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "IMPROVED",
      "speedup": 1.08,
      "semantic_passed": true,
      "error": null,
      "original_ms": 2092.0,
      "patch_ms": 1937.1,
      "output_sql": "SELECT count(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214+11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND d2.d_month_seq BETWEEN 1214 AND 1214+11 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales ws JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND d3.d_month_seq BETWEEN 1214 AND 1214+11 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date)) cool_cust;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "IMPROVED",
      "speedup": 1.07,
      "semantic_passed": true,
      "error": null,
      "original_ms": 2092.0,
      "patch_ms": 1946.6,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11) SELECT count(*) FROM ( SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45 AND NOT EXISTS ( SELECT 1 FROM catalog_sales cs JOIN filtered_date d2 ON cs.cs_sold_date_sk = d2.d_date_sk JOIN customer c2 ON cs.cs_bill_customer_sk = c2.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND c2.c_last_name = c.c_last_name AND c2.c_first_name = c.c_first_name AND d2.d_date = d.d_date ) AND NOT EXISTS ( SELECT 1 FROM web_sales ws JOIN filtered_date d3 ON ws.ws_sold_date_sk = d3.d_date_sk JOIN customer c3 ON ws.ws_bill_customer_sk = c3.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND c3.c_last_name = c.c_last_name AND c3.c_first_name = c.c_first_name AND d3.d_date = d.d_date ) ) cool_cust;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "Aggregate  (rows=1, time=1494.868)\n  Unique  (rows=0, time=1494.852)\n    Gather Merge  (rows=0, time=1494.841)\n      Sort  (rows=0, time=800.247)\n        Nested Loop  (rows=0, time=800.209)\n          Nested Loop  (rows=0, time=800.201)\n            Nested Loop  (rows=0, time=800.193)\n              Nested Loop  (rows=0, time=800.19)\n                Index Scan on date_dim (d)  (rows=182, time=13.886)\n                Index Only Scan on store_sales (ss)  (rows=0, time=4.304)\n              Index Scan ",
    "compile_p1": "Aggregate  (rows=1, time=1520.017)\n  Unique  (rows=0, time=1520.009)\n    Gather Merge  (rows=0, time=1520.005)\n      Sort  (rows=0, time=815.734)\n        Nested Loop  (rows=0, time=815.702)\n          Nested Loop  (rows=0, time=815.698)\n            Nested Loop  (rows=0, time=815.693)\n              Nested Loop  (rows=0, time=815.689)\n                Index Scan on date_dim (d)  (rows=182, time=12.776)\n                Index Only Scan on store_sales (ss)  (rows=0, time=4.396)\n              Index Scan",
    "compile_p2": "Aggregate  (rows=1, time=1413.862)\n  Index Scan on date_dim  (rows=365, time=1.973)\n  Unique  (rows=0, time=1413.853)\n    Nested Loop  (rows=0, time=1413.851)\n      Merge Join  (rows=0, time=1413.848)\n        Sort  (rows=0, time=1413.844)\n          Hash Join  (rows=0, time=1413.831)\n            Nested Loop  (rows=0, time=1413.828)\n              CTE Scan (d)  (rows=365, time=3.044)\n              Index Only Scan on store_sales (ss)  (rows=0, time=3.861)\n            Hash  (rows=0, time=0.0)\n       "
  }
}