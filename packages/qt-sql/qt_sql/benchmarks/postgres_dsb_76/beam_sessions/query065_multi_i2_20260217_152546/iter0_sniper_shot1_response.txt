[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p03",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Consolidate redundant fact scans into single CTE while pre-filtering dimensions early. Original BDA shows duplicate store_sales/date_dim scans dominate cost. CTE reuse avoids double computation while dimension CTEs reduce join cardinality before revenue threshold filter.",
    "target_ir": "CTE chain: base_revenue_data → filtered_store → filtered_item → sb/sc reuse. Main query with explicit JOINs replacing comma syntax.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH base_revenue_data AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq BETWEEN 1215 AND 1215+11 AND ss_sales_price / ss_list_price BETWEEN 79*0.01 AND 89*0.01 GROUP BY ss_store_sk, ss_item_sk), filtered_store AS (SELECT s_store_sk, s_store_name FROM store WHERE s_state IN ('KS','OH','SD')), filtered_item AS (SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand FROM item WHERE i_manager_id BETWEEN 10 AND 14), sb AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM base_revenue_data GROUP BY ss_store_sk) SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM filtered_store s JOIN base_revenue_data sc ON s.s_store_sk = sc.ss_store_sk JOIN filtered_item i ON i.i_item_sk = sc.ss_item_sk JOIN sb ON sc.ss_store_sk = sb.ss_store_sk WHERE sc.revenue <= 0.1 * sb.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p11",
    "strategy": "Minimal CTE reuse with late dimension filtering",
    "hypothesis": "Address core scan duplication via base_revenue CTE while avoiding dimension CTE materialization fences. Retains late dimension filtering but eliminates redundant fact processing. Safer for engines where CTE fencing blocks join reordering.",
    "target_ir": "Single base_revenue_data CTE reused in sb/sc. Original dimension tables retained with filters in main WHERE.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH base_revenue_data AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_month_seq BETWEEN 1215 AND 1215+11 AND ss_sales_price / ss_list_price BETWEEN 79*0.01 AND 89*0.01 GROUP BY ss_store_sk, ss_item_sk), sb AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM base_revenue_data GROUP BY ss_store_sk) SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store s, item i, sb, base_revenue_data sc WHERE sb.ss_store_sk = sc.ss_store_sk AND sc.revenue <= 0.1 * sb.ave AND s.s_store_sk = sc.ss_store_sk AND i.i_item_sk = sc.ss_item_sk AND i.i_manager_id BETWEEN 10 AND 14 AND s.s_state IN ('KS','OH','SD') ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;"
        }
      }
    ]
  }
]