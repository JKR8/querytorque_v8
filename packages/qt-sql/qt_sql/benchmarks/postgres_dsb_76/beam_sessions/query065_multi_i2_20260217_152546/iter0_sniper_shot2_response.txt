[
  {
    "plan_id": "snipe_p1",
    "family": "E",
    "transform": "base_revenue_cte_plus_dimension_prefilter",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01,p03",
    "hypothesis": "Original plan shows duplicate store_sales+date_dim scans for sb/sc subqueries. Create shared base revenue CTE to avoid redundant work. Pre-filter store/item dimensions to reduce join cardinality early. EXPLAIN should show single store_sales scan and reduced rows before main join.",
    "target_ir": "CTEs: base_revenue (store_sales+date_dim), filtered_store, filtered_item. Main query joins CTEs with explicit JOINs.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH base_revenue AS (\n  SELECT \n    ss_store_sk, \n    ss_item_sk, \n    SUM(ss_sales_price) AS revenue\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE d_month_seq BETWEEN 1215 AND 1215+11\n    AND ss_sales_price / ss_list_price BETWEEN 79 * 0.01 AND 89 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n),\nfiltered_store AS (\n  SELECT s_store_sk, s_store_name\n  FROM store\n  WHERE s_state IN ('KS','OH','SD')\n),\nfiltered_item AS (\n  SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand\n  FROM item\n  WHERE i_manager_id BETWEEN 10 AND 14\n),\nsb AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM base_revenue\n  GROUP BY ss_store_sk\n),\nsc AS (\n  SELECT ss_store_sk, ss_item_sk, revenue\n  FROM base_revenue\n)\nSELECT \n  s_store_name,\n  i_item_desc,\n  sc.revenue,\n  i_current_price,\n  i_wholesale_cost,\n  i_brand\nFROM filtered_store\nJOIN sc ON filtered_store.s_store_sk = sc.ss_store_sk\nJOIN filtered_item ON filtered_item.i_item_sk = sc.ss_item_sk\nJOIN sb ON sc.ss_store_sk = sb.ss_store_sk\nWHERE sc.revenue <= 0.1 * sb.ave\nORDER BY s_store_name, i_item_desc\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "family": "F",
    "transform": "explicit_join_plus_date_cte",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p07",
    "hypothesis": "Comma joins in subqueries cause poor cardinality estimates. Convert to explicit JOINs and isolate date_dim filter in CTE. Reuse date CTE across both revenue calculations. EXPLAIN should show accurate row estimates and bitmap index scans on date_dim.",
    "target_IR": "CTE for filtered_dates. Explicit JOINs in all subqueries. Base revenue CTE shared between sb/sc.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1215 AND 1215+11\n),\nbase_revenue AS (\n  SELECT \n    ss_store_sk, \n    ss_item_sk, \n    SUM(ss_sales_price) AS revenue\n  FROM store_sales\n  JOIN filtered_dates ON ss_sold_date_sk = d_date_sk\n  WHERE ss_sales_price / ss_list_price BETWEEN 79 * 0.01 AND 89 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n)\nSELECT \n  s_store_name,\n  i_item_desc,\n  sc.revenue,\n  i_current_price,\n  i_wholesale_cost,\n  i_brand\nFROM store\nJOIN item ON TRUE\nJOIN (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM base_revenue\n  GROUP BY ss_store_sk\n) sb ON TRUE\nJOIN (\n  SELECT ss_store_sk, ss_item_sk, revenue\n  FROM base_revenue\n) sc ON sb.ss_store_sk = sc.ss_store_sk\nWHERE sc.revenue <= 0.1 * sb.ave\n  AND s_store_sk = sc.ss_store_sk\n  AND i_item_sk = sc.ss_item_sk\n  AND i_manager_id BETWEEN 10 AND 14\n  AND s_state IN ('KS','OH','SD')\nORDER BY s_store_name, i_item_desc\nLIMIT 100;"
        }
      }
    ]
  }
]