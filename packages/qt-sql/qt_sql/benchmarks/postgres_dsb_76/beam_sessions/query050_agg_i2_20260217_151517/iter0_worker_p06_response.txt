{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate store_sales and store_returns by ss_store_sk/sr_store_sk to reduce row count before joining with store, avoiding expensive nested-loop evaluation of non-equi date conditions.",
  "reasoning_trace": [
    "Original query joins store_sales and store_returns directly with store and applies d1 range filter late",
    "Non-equi condition (d1.d_date BETWEEN ...) causes large intermediate result",
    "Pushing SUM/CASE aggregation down into a CTE on store_sk reduces rows entering join"
  ],
  "target_ir": "CTE with pre-aggregated store_sales/store_returns grouped by store_sk; main query joins CTE with store and preserves all CASE-based buckets",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "aggregated_returns",
        "cte_query_sql": "SELECT ss_store_sk, sr_returned_date_sk, ss_sold_date_sk FROM store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk WHERE ss_customer_sk = sr_customer_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "select s_store_name ,s_company_id ,s_street_number ,s_street_name ,s_street_type ,s_suite_number ,s_city ,s_county ,s_state ,s_zip ,sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then 1 else 0 end) as \"30 days\" ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and (sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end ) as \"31-60 days\" ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and (sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\" ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and (sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\" ,sum(case when (sr_returned_date_sk - ss_sold_date_sk > 120) then 1 else 0 end) as \">120 days\" from aggregated_returns ar ,store s ,date_dim d1 ,date_dim d2 where d2.d_year = 1999 and d2.d_moy = 7 and ar.ss_store_sk = s.s_store_sk and ss_sold_date_sk = d1.d_date_sk and sr_returned_date_sk = d2.d_date_sk and d1.d_date between (d2.d_date - interval '120 day') and d2.d_date group by s_store_name ,s_company_id ,s_street_number ,s_street_name ,s_street_type ,s_suite_number ,s_city ,s_county ,s_state ,s_zip order by s_store_name ,s_company_id ,s_street_number ,s_street_name ,s_street_type ,s_suite_number ,s_city ,s_county ,s_state ,s_zip limit 100"
      }
    }
  ]
}