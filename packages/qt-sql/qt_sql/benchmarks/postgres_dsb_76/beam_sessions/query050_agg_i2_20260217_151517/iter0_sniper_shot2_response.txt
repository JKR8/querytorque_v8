[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p02,p09",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Original plan shows nested loops dominating runtime (100s). Converting comma joins to explicit JOINs enables better join order optimization. Materializing d2 filter (d_year=1999, d_moy=7) reduces fact table scans. Moving d1 range condition into JOIN clause allows earlier filtering.",
    "target_ir": "Explicit JOIN topology with d2 CTE, d1 range pushed to JOIN condition",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d2_cte",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk JOIN store ON ss_store_sk = s_store_sk JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk JOIN d2_cte ON sr_returned_date_sk = d2_cte.d_date_sk AND d1.d_date BETWEEN (d2_cte.d_date - INTERVAL '120 DAY') AND d2_cte.d_date"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "444f6473896f7965"},
        "payload": {
          "predicate_sql": "ss_customer_sk = sr_customer_sk"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "original",
    "strategy": "Alternative independent pathway",
    "hypothesis": "Nested loop between store_sales/store_returns (50s) remains bottleneck. Prefiltering both fact tables using date ranges before joining reduces input size. Materialized CTEs isolate date constraints while avoiding comma join weaknesses.",
    "target_ir": "Filtered fact CTEs with explicit JOINs, no date_dim tables in main FROM",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d2_cte",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_returns",
          "cte_query_sql": "SELECT sr_item_sk, sr_ticket_number, sr_customer_sk, sr_returned_date_sk FROM store_returns sr JOIN d2_cte ON sr.sr_returned_date_sk = d2_cte.d_date_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_store_sk, ss_sold_date_sk FROM store_sales ss JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN d2_cte ON d1.d_date BETWEEN (d2_cte.d_date - INTERVAL '120 DAY') AND d2_cte.d_date"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "filtered_sales fs JOIN filtered_returns fr ON fs.ss_ticket_number = fr.sr_ticket_number AND fs.ss_item_sk = fr.sr_item_sk AND fs.ss_customer_sk = fr.sr_customer_sk JOIN store ON fs.ss_store_sk = s_store_sk"
        }
      },
      {
        "step_id": "s5",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "444f6473896f7965"},
        "payload": {
          "predicate_sql": "1=1"
        }
      }
    ]
  }
]