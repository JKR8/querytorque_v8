[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p02,p09",
    "strategy": "CTE isolation + explicit JOIN conversion",
    "hypothesis": "Original plan shows comma join weakness and late d1 filtering. Materializing d2 CTE reduces store_returns early. Explicit JOIN syntax enables predicate pushdown to d1 via ON condition. BDA shows workers attempted similar transforms but failed synthetically.",
    "target_ir": "CTE for d2 filtering → explicit JOINs with d1 range condition in ON clause → WHERE clause reduced to TRUE",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d2_cte",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk JOIN store ON ss_store_sk = s_store_sk JOIN d2_cte ON sr_returned_date_sk = d2_cte.d_date_sk JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk AND d1.d_date BETWEEN (d2_cte.d_date - INTERVAL '120 DAY') AND d2_cte.d_date"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "444f6473896f7965"},
        "payload": {
          "sql_fragment": "TRUE"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p09",
    "strategy": "Explicit JOIN conversion with join reordering",
    "hypothesis": "Comma joins prevent optimal join order. Convert to explicit JOINs with d2 joined before d1 to enable d1 range pushdown. Avoids CTE materialization fence while addressing COMMA_JOIN_WEAKNESS gap.",
    "target_ir": "Explicit JOINs with d2 joined before d1 → d1 range condition in ON clause → WHERE reduced to TRUE",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk JOIN store ON ss_store_sk = s_store_sk JOIN date_dim d2 ON sr_returned_date_sk = d2.d_date_sk AND d2.d_year = 1999 AND d2.d_moy = 7 JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk AND d1.d_date BETWEEN (d2.d_date - INTERVAL '120 DAY') AND d2.d_date"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "444f6473896f7965"},
        "payload": {
          "sql_fragment": "TRUE"
        }
      }
    ]
  }
]