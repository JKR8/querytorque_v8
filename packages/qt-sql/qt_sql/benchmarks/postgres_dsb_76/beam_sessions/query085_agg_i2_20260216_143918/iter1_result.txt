{
  "iteration": 1,
  "n_api_calls": 6,
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "t1",
      "family": "A+F",
      "transform": "explicit_join_plus_early_fact_filter",
      "relevance_score": 0.95,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Equivalence (retry failed): Row count mismatch: original=16, patch=41",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_web_sales AS (SELECT ws_item_sk, ws_order_number, ws_quantity, ws_web_page_sk, ws_sold_date_sk, wr_refunded_cdemo_sk, wr_returning_cdemo_sk, wr_refunded_addr_sk, wr_reason_sk, wr_refunded_cash, wr_fee FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number WHERE (ws_sales_price BETWEEN 100.00 AND 150.00 OR ws_sales_price BETWEEN 50.00 AND 100.00 OR ws_sales_price BETWEEN 150.00 AND 200.00) AND (ws_net_profit BETWEEN 100 AND 200 OR ws_net_profit BETWEEN 150 AND 300 OR ws_net_profit BETWEEN 50 AND 250)), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002) SELECT SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM filtered_web_sales JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN customer_demographics AS cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk JOIN customer_demographics AS cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status) AND ((ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD')) OR (ca_country = 'United States' AND ca_state IN ('AR', 'GA', 'IN')) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'VA'))) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t2",
      "family": "A+E",
      "transform": "fact_table_preagg+rescue_dimension_prefilter",
      "relevance_score": 0.9,
      "status": "REGRESSION",
      "speedup": 0.26,
      "semantic_passed": true,
      "error": null,
      "original_ms": 396.3,
      "patch_ms": 1528.2,
      "output_sql": "WITH filtered_cd AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary') OR (cd_marital_status = 'U' AND cd_education_status = '2 yr Degree')), filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), preagg_web_sales AS (SELECT ws_item_sk, ws_order_number, ws_web_page_sk, ws_sold_date_sk, ws_quantity, ws_sales_price, ws_net_profit FROM web_sales WHERE ws_sales_price BETWEEN 50.00 AND 200.00) SELECT SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM preagg_web_sales AS ws JOIN web_returns AS wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN web_page AS wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN filtered_date AS d ON ws.ws_sold_date_sk = d.d_date_sk JOIN filtered_cd AS cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk JOIN filtered_cd AS cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk JOIN customer_address AS ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk JOIN reason AS r ON r.r_reason_sk = wr.wr_reason_sk WHERE ((cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250)) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t4",
      "family": "C",
      "transform": "push_agg_to_web_returns",
      "relevance_score": 0.8,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite \u2014 ['wr_reason_sk', 'wr_refunded_addr_sk', 'wr_refunded_cdemo_sk', 'wr_returning_cdemo_sk']. The rewrite references different table columns.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH web_returns_agg AS (SELECT wr_item_sk, wr_order_number, AVG(wr_refunded_cash) AS avg_wr_refunded_cash, AVG(wr_fee) AS avg_wr_fee FROM web_returns GROUP BY wr_item_sk, wr_order_number), filtered_web_sales AS (SELECT ws_item_sk, ws_order_number, ws_web_page_sk, ws_quantity, ws_sales_price, ws_net_profit FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2002) SELECT SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wra.avg_wr_refunded_cash), AVG(wra.avg_wr_fee) FROM filtered_web_sales AS ws JOIN web_returns_agg AS wra ON ws.ws_item_sk = wra.wr_item_sk AND ws.ws_order_number = wra.wr_order_number JOIN web_page ON ws.ws_web_page_sk = wp_web_page_sk JOIN customer_demographics AS cd1 ON cd1.cd_demo_sk = wra.wr_item_sk JOIN customer_demographics AS cd2 ON cd2.cd_demo_sk = wra.wr_order_number JOIN customer_address ON ca_address_sk = wra.wr_item_sk JOIN reason ON r_reason_sk = wra.wr_order_number WHERE ((cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250)) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wra.avg_wr_refunded_cash), AVG(wra.avg_wr_fee) LIMIT 100;",
      "has_explain": false
    }
  ],
  "explains": {
    "t2": "Limit  (rows=16, time=1652.791)\n  Gather  (rows=164640, time=50.55)\n    Seq Scan on customer_demographics  (rows=54880, time=63.822)\n  Sort  (rows=16, time=1652.697)\n    Aggregate  (rows=16, time=1652.662)\n      Sort  (rows=21, time=1652.627)\n        Nested Loop  (rows=21, time=1652.55)\n          Nested Loop  (rows=21, time=1652.429)\n            Nested Loop  (rows=126, time=1651.607)\n              Nested Loop  (rows=126, time=1649.002)\n                Nested Loop  (rows=36058, time=1354.138)\n   "
  }
}