{
  "probe_id": "materialized_dimension_fact_prefilter_scout_1",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing selective filters on promotion, customer_demographics, and customer_address as CTEs reduces rows before joining with store_sales and store_returns. This should improve join order and reduce the cost of the large Nested Loop chain.",
  "reasoning_trace": [
    "Identified selective dimension filters on promotion, cd1, cd2, and ad2 that can be materialized early.",
    "The cross_sales CTE currently scans all tables in a comma-join style, leading to poor cardinality estimates.",
    "Introducing MATERIALIZED CTEs for dimension filters aligns with PostgreSQL's strength in handling small hash tables.",
    "Explicit JOIN syntax improves readability and allows better optimization compared to comma joins."
  ],
  "target_ir": "Introduce MATERIALIZED CTEs for filtered dimensions (promotion, cd1, cd2, ad2) and pre-join them with store_sales and store_returns.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cross_sales"],
        "outputs": ["product_name", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "cnt", "s11", "s21", "s31", "s12", "s22", "s32", "syear", "cnt"],
        "changed": false
      },
      {
        "node_id": "cross_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "cs_ui", "date_dim", "store", "customer", "customer_demographics", "promotion_cte", "household_demographics", "customer_address", "income_band", "item"],
        "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
        "changed": true,
        "sql": "SELECT i_product_name product_name\n     ,i_item_sk item_sk\n     ,s_store_name store_name\n     ,s_zip store_zip\n     ,ad1.ca_street_number b_street_number\n     ,ad1.ca_street_name b_street_name\n     ,ad1.ca_city b_city\n     ,ad1.ca_zip b_zip\n     ,ad2.ca_street_number c_street_number\n     ,ad2.ca_street_name c_street_name\n     ,ad2.ca_city c_city\n     ,ad2.ca_zip c_zip\n     ,d1.d_year as syear\n     ,d2.d_year as fsyear\n     ,d3.d_year s2year\n     ,count(*) cnt\n     ,sum(ss_wholesale_cost) s1\n     ,sum(ss_list_price) s2\n     ,sum(ss_coupon_amt) s3\n  FROM   store_sales\n        JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number\n        JOIN cs_ui ON ss_item_sk = cs_ui.cs_item_sk\n        JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk\n        JOIN date_dim d2 ON c_first_sales_date_sk = d2.d_date_sk\n        JOIN date_dim d3 ON c_first_shipto_date_sk = d3.d_date_sk\n        JOIN store ON ss_store_sk = s_store_sk\n        JOIN customer ON ss_customer_sk = c_customer_sk\n        JOIN customer_demographics cd1 ON ss_cdemo_sk= cd1.cd_demo_sk\n        JOIN customer_demographics cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk\n        JOIN promotion_cte p ON ss_promo_sk = p.p_promo_sk\n        JOIN household_demographics hd1 ON ss_hdemo_sk = hd1.hd_demo_sk\n        JOIN household_demographics hd2 ON c_current_hdemo_sk = hd2.hd_demo_sk\n        JOIN customer_address ad1 ON ss_addr_sk = ad1.ca_address_sk\n        JOIN customer_address ad2 ON c_current_addr_sk = ad2.ca_address_sk\n        JOIN income_band ib1 ON hd1.hd_income_band_sk = ib1.ib_income_band_sk\n        JOIN income_band ib2 ON hd2.hd_income_band_sk = ib2.ib_income_band_sk\n        JOIN item ON ss_item_sk = i_item_sk\n  WHERE  cd1.cd_marital_status <> cd2.cd_marital_status\n         AND i_current_price between 26 and 26 + 10\n         AND ad2.ca_state in ('IA','IL','TX')\n         AND ss_wholesale_cost BETWEEN 35 AND 55\n         AND cd1.cd_marital_status in ('M', 'M', 'U')\n         AND cd1.cd_education_status in ('Unknown', 'Advanced Degree', 'College')\n         AND cd2.cd_marital_status in ('M', 'M', 'U')\n         AND cd2.cd_education_status in ('Unknown', 'Advanced Degree', 'College')\n         AND p.p_channel_email = 'N'\n         AND p.p_channel_tv = 'Y'\n         AND p.p_channel_radio = 'N'\nGROUP BY i_product_name\n       ,i_item_sk\n       ,s_store_name\n       ,s_zip\n       ,ad1.ca_street_number\n       ,ad1.ca_street_name\n       ,ad1.ca_city\n       ,ad1.ca_zip\n       ,ad2.ca_street_number\n       ,ad2.ca_street_name\n       ,ad2.ca_city\n       ,ad2.ca_zip\n       ,d1.d_year\n       ,d2.d_year\n       ,d3.d_year"
      },
      {
        "node_id": "cs_ui",
        "parent_node_id": "cross_sales",
        "sources": ["catalog_sales", "catalog_returns"],
        "outputs": ["cs_item_sk", "sale", "refund"],
        "changed": false
      },
      {
        "node_id": "promotion_cte",
        "parent_node_id": "cross_sales",
        "sources": ["promotion"],
        "outputs": ["p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio"],
        "changed": true,
        "sql": "SELECT p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio FROM promotion WHERE p_channel_email = 'N' AND p_channel_tv = 'Y' AND p_channel_radio = 'N'"
      }
    ]
  }
}