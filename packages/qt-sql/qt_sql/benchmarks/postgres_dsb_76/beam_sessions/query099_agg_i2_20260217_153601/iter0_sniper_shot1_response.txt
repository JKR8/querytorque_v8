[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "original",
    "strategy": "Convert comma joins to explicit INNER JOIN syntax",
    "hypothesis": "Original plan shows poor row estimates in Hash Joins. Explicit joins may improve cardinality estimates and avoid nested loop amplification. BDA gap COMMA_JOIN_WEAKNESS indicates this optimization for PostgreSQL.",
    "target_ir": "Explicit INNER JOINs between all tables with precise ON conditions",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "catalog_sales\nINNER JOIN date_dim ON cs_ship_date_sk = d_date_sk\nINNER JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk\nINNER JOIN ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk\nINNER JOIN call_center ON cs_call_center_sk = cc_call_center_sk"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "d_month_seq BETWEEN 1191 AND 1191 + 23\nAND cs_list_price BETWEEN 244 AND 273\nAND sm_type = 'LIBRARY'\nAND cc_class = 'medium'\nAND w_gmt_offset = -5"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p05,p01",
    "strategy": "Pre-filter dimensions in CTEs + explicit joins",
    "hypothesis": "Original plan shows late filtering on small dimensions. CTEs enforce early filtering while explicit joins maintain optimizer flexibility. Targets CROSS_CTE_PREDICATE_BLINDNESS gap with minimal CTE fencing risk due to small dimension sizes.",
    "target_ir": "Three filtered dimension CTEs + explicit INNER JOINs between fact/date and CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_warehouse AS (SELECT w_warehouse_sk, w_warehouse_name FROM warehouse WHERE w_gmt_offset = -5),\nfiltered_ship_mode AS (SELECT sm_ship_mode_sk, sm_type FROM ship_mode WHERE sm_type = 'LIBRARY'),\nfiltered_call_center AS (SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'medium')\nSELECT \n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nFROM catalog_sales\nINNER JOIN date_dim ON cs_ship_date_sk = d_date_sk\nINNER JOIN filtered_warehouse ON cs_warehouse_sk = w_warehouse_sk\nINNER JOIN filtered_ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk\nINNER JOIN filtered_call_center ON cs_call_center_sk = cc_call_center_sk\nWHERE d_month_seq BETWEEN 1191 AND 1191 + 23\n  AND cs_list_price BETWEEN 244 AND 273\nGROUP BY \n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\nORDER BY substring(w_warehouse_name,1,20)\n        ,sm_type\n        ,cc_name\nLIMIT 100"
        }
      }
    ]
  }
]