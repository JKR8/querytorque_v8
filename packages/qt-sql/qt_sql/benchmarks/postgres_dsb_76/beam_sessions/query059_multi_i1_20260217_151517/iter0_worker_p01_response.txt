{
  "probe_id": "p01",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Materializing filtered date ranges into CTEs and converting comma joins to explicit JOINs will enable PostgreSQL to use better join planning with smaller, pre-filtered dimension inputs.",
  "reasoning_trace": [
    "FROM clause in subqueries y and x uses comma joins which leads to poor cardinality estimates.",
    "Both y and x repeat the same base scans on wss, store, and date_dim without early filtering.",
    "d_month_seq filters are applied late; moving them into CTEs should reduce row counts before joins."
  ],
  "target_ir": "Two new CTEs for filtered date sequences; main query FROM rewritten with explicit JOINs; WHERE clauses simplified.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "date_range_1",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1187 + 11"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "date_range_2",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 + 12 AND 1187 + 23"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(select s_store_name s_store_name1,wss.d_week_seq d_week_seq1\n        ,s_store_id s_store_id1,sun_sales sun_sales1\n        ,mon_sales mon_sales1,tue_sales tue_sales1\n        ,wed_sales wed_sales1,thu_sales thu_sales1\n        ,fri_sales fri_sales1,sat_sales sat_sales1\n  from wss\n  JOIN store ON ss_store_sk = s_store_sk\n  JOIN date_range_1 dr1 ON dr1.d_week_seq = wss.d_week_seq\n  where s_state in ('AR','CO','IA','IL','NC','NY','PA','TX')\n) y\nJOIN\n(select s_store_name s_store_name2,wss.d_week_seq d_week_seq2\n        ,s_store_id s_store_id2,sun_sales sun_sales2\n        ,mon_sales mon_sales2,tue_sales tue_sales2\n        ,wed_sales wed_sales2,thu_sales thu_sales2\n        ,fri_sales fri_sales2,sat_sales sat_sales2\n  from wss\n  JOIN store ON ss_store_sk = s_store_sk\n  JOIN date_range_2 dr2 ON dr2.d_week_seq = wss.d_week_seq\n  where s_state in ('AR','CO','IA','IL','NC','NY','PA','TX')\n) x\nON y.s_store_id1 = x.s_store_id2 AND y.d_week_seq1 = x.d_week_seq2 - 52"
      }
    }
  ]
}