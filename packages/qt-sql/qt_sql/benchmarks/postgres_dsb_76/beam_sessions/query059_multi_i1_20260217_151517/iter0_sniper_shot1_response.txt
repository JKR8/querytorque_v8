[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p03,p05,p13",
    "strategy": "Pre-filter dimensions and push date constraints into wss CTE",
    "hypothesis": "Original plan shows full scan of store_sales (28M rows) dominates runtime. By filtering date_dim early and pushing constraints into wss CTE, we reduce store_sales scan to relevant date range (1187-1210). Pre-filtering store table also reduces join size. Explicit joins address comma-join weakness.",
    "target_ir": "CTEs for filtered date_dim/store → wss with explicit joins → main query with explicit joins on pre-filtered CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (\n  SELECT d_date_sk, d_week_seq, d_month_seq, d_day_name\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1187 AND 1187 + 23\n),\nfiltered_stores AS (\n  SELECT s_store_sk, s_store_id, s_store_name\n  FROM store\n  WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')\n),\nwss AS (\n  SELECT \n    d_week_seq,\n    ss_store_sk,\n    SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE null END) sun_sales,\n    SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE null END) mon_sales,\n    SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE null END) tue_sales,\n    SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE null END) wed_sales,\n    SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE null END) thu_sales,\n    SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE null END) fri_sales,\n    SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE null END) sat_sales\n  FROM store_sales\n  JOIN filtered_dates ON filtered_dates.d_date_sk = store_sales.ss_sold_date_sk\n  WHERE ss_sales_price / ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01\n  GROUP BY d_week_seq, ss_store_sk\n)\nSELECT \n  s_store_name1, s_store_id1, d_week_seq1,\n  sun_sales1/sun_sales2, mon_sales1/mon_sales2,\n  tue_sales1/tue_sales2, wed_sales1/wed_sales2, thu_sales1/thu_sales2,\n  fri_sales1/fri_sales2, sat_sales1/sat_sales2\nFROM (\n  SELECT \n    s_store_name AS s_store_name1,\n    wss.d_week_seq AS d_week_seq1,\n    s_store_id AS s_store_id1,\n    sun_sales AS sun_sales1,\n    mon_sales AS mon_sales1,\n    tue_sales AS tue_sales1,\n    wed_sales AS wed_sales1,\n    thu_sales AS thu_sales1,\n    fri_sales AS fri_sales1,\n    sat_sales AS sat_sales1\n  FROM wss\n  JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  JOIN filtered_dates AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d.d_month_seq BETWEEN 1187 AND 1187 + 11\n) AS y,\n(\n  SELECT \n    s_store_name AS s_store_name2,\n    wss.d_week_seq AS d_week_seq2,\n    s_store_id AS s_store_id2,\n    sun_sales AS sun_sales2,\n    mon_sales AS mon_sales2,\n    tue_sales AS tue_sales2,\n    wed_sales AS wed_sales2,\n    thu_sales AS thu_sales2,\n    fri_sales AS fri_sales2,\n    sat_sales AS sat_sales2\n  FROM wss\n  JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  JOIN filtered_dates AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d.d_month_seq BETWEEN 1187 + 12 AND 1187 + 23\n) AS x\nWHERE s_store_id1 = s_store_id2\n  AND d_week_seq1 = d_week_seq2 - 52\nORDER BY s_store_name1, s_store_id1, d_week_seq1\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p11,p08",
    "strategy": "Pre-filter dimensions and convert comma joins to explicit INNER JOIN",
    "hypothesis": "Comma joins cause poor cardinality estimates. Pre-filtering store/date_dim reduces dimension sizes. Explicit joins may enable better join reordering while avoiding full store_sales scan in wss CTE.",
    "target_ir": "CTEs for filtered date_dim/store → original wss → main query with explicit INNER JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH wss AS (\n  SELECT \n    d_week_seq,\n    ss_store_sk,\n    SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE null END) sun_sales,\n    SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE null END) mon_sales,\n    SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE null END) tue_sales,\n    SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE null END) wed_sales,\n    SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE null END) thu_sales,\n    SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE null END) fri_sales,\n    SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE null END) sat_sales\n  FROM store_sales, date_dim\n  WHERE d_date_sk = ss_sold_date_sk\n    AND ss_sales_price / ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01\n  GROUP BY d_week_seq, ss_store_sk\n),\nfiltered_stores AS (\n  SELECT s_store_sk, s_store_id, s_store_name\n  FROM store\n  WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')\n),\nfiltered_dates AS (\n  SELECT d_week_seq, d_month_seq\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1187 AND 1187 + 23\n)\nSELECT \n  s_store_name1, s_store_id1, d_week_seq1,\n  sun_sales1/sun_sales2, mon_sales1/mon_sales2,\n  tue_sales1/tue_sales2, wed_sales1/wed_sales2, thu_sales1/thu_sales2,\n  fri_sales1/fri_sales2, sat_sales1/sat_sales2\nFROM (\n  SELECT \n    s_store_name AS s_store_name1,\n    wss.d_week_seq AS d_week_seq1,\n    s_store_id AS s_store_id1,\n    sun_sales AS sun_sales1,\n    mon_sales AS mon_sales1,\n    tue_sales AS tue_sales1,\n    wed_sales AS wed_sales1,\n    thu_sales AS thu_sales1,\n    fri_sales AS fri_sales1,\n    sat_sales AS sat_sales1\n  FROM wss\n  INNER JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  INNER JOIN filtered_dates AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d.d_month_seq BETWEEN 1187 AND 1187 + 11\n) AS y\nINNER JOIN (\n  SELECT \n    s_store_name AS s_store_name2,\n    wss.d_week_seq AS d_week_seq2,\n    s_store_id AS s_store_id2,\n    sun_sales AS sun_sales2,\n    mon_sales AS mon_sales2,\n    tue_sales AS tue_sales2,\n    wed_sales AS wed_sales2,\n    thu_sales AS thu_sales2,\n    fri_sales AS fri_sales2,\n    sat_sales AS sat_sales2\n  FROM wss\n  INNER JOIN filtered_stores ON wss.ss_store_sk = filtered_stores.s_store_sk\n  INNER JOIN filtered_dates AS d ON d.d_week_seq = wss.d_week_seq\n  WHERE d.d_month_seq BETWEEN 1187 + 12 AND 1187 + 23\n) AS x \n  ON y.s_store_id1 = x.s_store_id2 \n  AND y.d_week_seq1 = x.d_week_seq2 - 52\nORDER BY s_store_name1, s_store_id1, d_week_seq1\nLIMIT 100;"
        }
      }
    ]
  }
]