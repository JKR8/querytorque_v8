{
  "probe_id": "p01",
  "transform_id": "prefetch_fact_join",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Filter date_dim early and join with store_sales in a CTE chain to reduce row count before expensive grouping and cross-join operations.",
  "reasoning_trace": [
    "The dominant cost is scanning store_sales without early date filtering.",
    "Current comma joins prevent efficient join planning and predicate pushdown.",
    "Pre-filtering date_dim and joining with store_sales reduces rows before aggregation."
  ],
  "target_ir": "CTE chain: filtered date_dim → filtered store_sales → grouped wss; main query joins y/x using structured JOINs.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1187 + 23"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_store_sales",
        "cte_query_sql": "SELECT ss_sold_date_sk, ss_store_sk, ss_sales_price, ss_list_price FROM store_sales WHERE EXISTS (SELECT 1 FROM filtered_dates fd WHERE fd.d_date_sk = ss_sold_date_sk)"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "filtered_store_sales fss JOIN filtered_dates fd ON fd.d_date_sk = fss.ss_sold_date_sk"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0", "by_anchor_hash": "5f7f8283ea72d640"},
      "payload": {
        "expr_sql": "fss.ss_sales_price / fss.ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01"
      }
    }
  ]
}