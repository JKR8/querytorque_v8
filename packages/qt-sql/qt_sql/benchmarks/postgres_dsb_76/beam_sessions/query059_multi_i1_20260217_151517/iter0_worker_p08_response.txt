{
  "probe_id": "p01",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering date_dim and store into CTEs reduces large scans and enables better join planning via explicit JOIN syntax.",
  "reasoning_trace": [
    "Original query uses comma joins leading to poor cardinality estimates.",
    "store_sales is scanned twice without early filtering on date or store dimensions.",
    "Introducing filtered CTEs for date_dim and store will allow PostgreSQL to use smaller hash tables in joins."
  ],
  "target_ir": "CTEs for filtered date_dim and store, with explicit JOINs replacing comma joins in main query blocks.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "date_cte",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1187 + 23"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "store_cte",
        "cte_query_sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(SELECT d_week_seq, ss_store_sk, sum(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) AS sun_sales, sum(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) AS mon_sales, sum(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) AS tue_sales, sum(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) AS wed_sales, sum(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) AS thu_sales, sum(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) AS fri_sales, sum(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales ss JOIN date_cte dd ON ss.ss_sold_date_sk = dd.d_date_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 57 * 0.01 AND 77 * 0.01 GROUP BY d_week_seq, ss_store_sk) wss"
      }
    }
  ]
}