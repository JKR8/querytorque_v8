[
  {
    "plan_id": "patch_early_filter_explicit_join",
    "family": "Early Filtering",
    "transform": "date_cte_explicit_join",
    "hypothesis": "EXPLAIN shows sequential scans on customer_address (11K rows) and customer_demographics with late filtering. Comma-join syntax prevents predicate pushdown. Materializing filtered dimensions early reduces fact table probes and enables efficient hash joins.",
    "target_ir": "S0",
    "dialect": "POSTGRES",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "payload": "ca_filtered AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('CO','NC','TX'))"
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "payload": "cd_filtered AS (SELECT cd_demo_sk, cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'College'))"
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {
          "by_node_id": "S0",
          "by_anchor_hash": "dae945277e160f9b"
        },
        "payload": "customer c INNER JOIN ca_filtered ON c.c_current_addr_sk = ca_filtered.ca_address_sk INNER JOIN cd_filtered ON cd_filtered.cd_demo_sk = c.c_current_cdemo_sk"
      },
      {
        "step_id": "s4",
        "op": "delete_expr_subtree",
        "target": {
          "by_node_id": "S0",
          "by_anchor_hash": "dae945277e160f9b"
        }
      }
    ]
  },
  {
    "plan_id": "patch_decorrelate_sales",
    "family": "Decorrelation",
    "transform": "decorrelate",
    "hypothesis": "EXPLAIN shows nested loops re-executing sales subqueries per customer row (store_sales:150K rows, catalog_sales:332K rows). Converting correlated EXISTS to precomputed CTE sets eliminates per-row re-execution.",
    "target_ir": "S0",
    "dialect": "POSTGRES",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "payload": "store_customers AS (SELECT DISTINCT ss_customer_sk FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12 AND ss_list_price BETWEEN 80 AND 169)"
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "payload": "web_customers AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12 AND ws_list_price BETWEEN 80 AND 169)"
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "payload": "catalog_customers AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales INNER JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12 AND cs_list_price BETWEEN 80 AND 169)"
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {
          "by_node_id": "S0"
        },
        "payload": "c.c_current_addr_sk = ca.ca_address_sk AND cd_demo_sk = c.c_current_cdemo_sk AND c.c_customer_sk IN (SELECT ss_customer_sk FROM store_customers) AND c.c_customer_sk NOT IN (SELECT ws_bill_customer_sk FROM web_customers) AND c.c_customer_sk NOT IN (SELECT cs_ship_customer_sk FROM catalog_customers)"
      }
    ]
  }
]