[
  {
    "plan_id": "patch_early_filter_explicit_join_v2",
    "family": "Early Filtering",
    "transform": "date_cte_explicit_join",
    "hypothesis": "Execution plan shows comma joins (implicit cross joins) causing poor cardinality estimates. Materializing filtered dimension tables into CTEs and converting to explicit joins improves row estimates and join order. The Gather Merge node (time=252ms) and Hash Join (time=224ms) will benefit from smaller probe tables.",
    "target_ir": "S0",
    "dialect": "POSTGRES",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "payload": "ca_cte AS (SELECT * FROM customer_address WHERE ca_state IN ('CO','NC','TX'))"
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "payload": "cd_cte AS (SELECT * FROM customer_demographics WHERE cd_marital_status IN ('S','M','U') AND cd_education_status IN ('Primary','College'))"
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "payload": "customer c JOIN ca_cte ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN cd_cte ON cd_cte.cd_demo_sk = c.c_current_cdemo_sk"
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {
          "by_anchor_hash": "dae945277e160f9b"
        },
        "payload": "EXISTS (SELECT * FROM store_sales, date_dim WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND ss_list_price BETWEEN 80 AND 169) AND (NOT EXISTS (SELECT * FROM web_sales, date_dim WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND ws_list_price BETWEEN 80 AND 169) AND NOT EXISTS (SELECT * FROM catalog_sales, date_dim WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND cs_list_price BETWEEN 80 AND 169))"
      }
    ]
  },
  {
    "plan_id": "patch_anti_join_decorrelation",
    "family": "Decorrelation",
    "transform": "decorrelate",
    "hypothesis": "Top-level Nested Loop (25s) materializes large anti-join sets (83k+ and 310k+ rows) causing O(n*m) scans. Precomputing excluded customer keys in CTEs and using LEFT JOIN/IS NULL converts correlated anti-joins to hash anti-joins, eliminating per-row re-execution.",
    "target_ir": "S0",
    "dialect": "POSTGRES",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "payload": "web_excluded AS (SELECT DISTINCT ws_bill_customer_sk AS customer_sk FROM web_sales, date_dim WHERE ws_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND ws_list_price BETWEEN 80 AND 169)"
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "payload": "catalog_excluded AS (SELECT DISTINCT cs_ship_customer_sk AS customer_sk FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND cs_list_price BETWEEN 80 AND 169)"
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "payload": "customer c, customer_address ca, customer_demographics LEFT JOIN web_excluded ON c.c_customer_sk = web_excluded.customer_sk LEFT JOIN catalog_excluded ON c.c_customer_sk = catalog_excluded.customer_sk"
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {
          "by_anchor_hash": "dae945277e160f9b"
        },
        "payload": "c.c_current_addr_sk = ca.ca_address_sk AND ca.ca_state IN ('CO','NC','TX') AND customer_demographics.cd_demo_sk = c.c_current_cdemo_sk AND customer_demographics.cd_marital_status IN ('S','M','U') AND customer_demographics.cd_education_status IN ('Primary','College') AND EXISTS (SELECT * FROM store_sales, date_dim WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2002 AND d_moy BETWEEN 10 AND 10+2 AND ss_list_price BETWEEN 80 AND 169) AND web_excluded.customer_sk IS NULL AND catalog_excluded.customer_sk IS NULL"
      },
      {
        "step_id": "s5",
        "op": "delete_expr_subtree",
        "target": {
          "by_anchor_hash": "dae945277e160f9b"
        }
      }
    ]
  }
]