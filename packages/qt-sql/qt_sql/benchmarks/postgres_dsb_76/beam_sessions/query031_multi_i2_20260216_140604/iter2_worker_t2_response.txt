{
  "plan_id": "postgres_structural_optimization_plan",
  "dialect": "postgres",
  "description": "Optimize query by prefetching filtered dimensions (item, customer_address), restructuring joins explicitly, and eliminating self-joins via pivot with conditional aggregation.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_items",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34"
      },
      "description": "Insert CTE 'filtered_items' to prefetch item dimension"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_addresses",
        "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('KS', 'OH')"
      },
      "description": "Insert CTE 'filtered_addresses' to prefetch customer_address dimension"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_ss",
        "by_anchor_hash": "f55d9959a55a5f8c"
      },
      "payload": {
        "sql_fragment": "ss AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN filtered_addresses ON ss_addr_sk = ca_address_sk INNER JOIN filtered_items ON ss_item_sk = filtered_items.i_item_sk WHERE ss_list_price BETWEEN 244 AND 258 GROUP BY ca_county, d_qoy, d_year)"
      },
      "description": "Replace ss CTE body with explicit INNER JOINs and filtered dimensions"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_ws",
        "by_anchor_hash": "3c884b73784f3399"
      },
      "payload": {
        "sql_fragment": "ws AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN filtered_addresses ON ws_bill_addr_sk = ca_address_sk INNER JOIN filtered_items ON ws_item_sk = filtered_items.i_item_sk WHERE ws_list_price BETWEEN 244 AND 258 GROUP BY ca_county, d_qoy, d_year)"
      },
      "description": "Replace ws CTE body with explicit INNER JOINs and filtered dimensions"
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {
        "by_node_id": "Q_S0",
        "by_anchor_hash": "e3d013ee216110fe"
      },
      "payload": {
        "from_sql": "(SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN web_sales ELSE 0 END) AS web_q1, SUM(CASE WHEN d_qoy = 2 THEN web_sales ELSE 0 END) AS web_q2, SUM(CASE WHEN d_qoy = 3 THEN web_sales ELSE 0 END) AS web_q3, SUM(CASE WHEN d_qoy = 1 THEN store_sales ELSE 0 END) AS store_q1, SUM(CASE WHEN d_qoy = 2 THEN store_sales ELSE 0 END) AS store_q2, SUM(CASE WHEN d_qoy = 3 THEN store_sales ELSE 0 END) AS store_q3 FROM ss GROUP BY ca_county, d_year) AS pivot_data"
      },
      "description": "Replace FROM clause with pivoted data using conditional aggregation"
    },
    {
      "step_id": "s6",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "Q_S0",
        "by_anchor_hash": "e3d013ee216110fe"
      },
      "payload": {
        "expr_sql": "SELECT ca_county, d_year, (web_q2 * 1.0 / NULLIF(web_q1, 0)) AS web_q1_q2_increase, (store_q2 * 1.0 / NULLIF(store_q1, 0)) AS store_q1_q2_increase, (web_q3 * 1.0 / NULLIF(web_q2, 0)) AS web_q2_q3_increase, (store_q3 * 1.0 / NULLIF(store_q2, 0)) AS store_q2_q3_increase FROM (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN web_sales ELSE 0 END) AS web_q1, SUM(CASE WHEN d_qoy = 2 THEN web_sales ELSE 0 END) AS web_q2, SUM(CASE WHEN d_qoy = 3 THEN web_sales ELSE 0 END) AS web_q3, SUM(CASE WHEN d_qoy = 1 THEN store_sales ELSE 0 END) AS store_q1, SUM(CASE WHEN d_qoy = 2 THEN store_sales ELSE 0 END) AS store_q2, SUM(CASE WHEN d_qoy = 3 THEN store_sales ELSE 0 END) AS store_q3 FROM ss GROUP BY ca_county, d_year) AS pivot_data WHERE d_year = 1999 AND web_q1 > 0 AND store_q1 > 0 AND (web_q2 * 1.0 / NULLIF(web_q1, 0)) > (store_q2 * 1.0 / NULLIF(store_q1, 0)) AND (web_q3 * 1.0 / NULLIF(web_q2, 0)) > (store_q3 * 1.0 / NULLIF(store_q2, 0)) ORDER BY d_year"
      },
      "description": "Replace full SELECT expression with pivoted logic and ratio calculations"
    }
  ]
}