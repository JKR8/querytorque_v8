[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.45,
    "based_on": "p02",
    "strategy": "Convert comma joins to explicit inner joins while preserving LEFT JOIN semantics and pushdown opportunities.",
    "hypothesis": "Original comma joins may cause poor cardinality estimates and suboptimal join order, especially in the web-sales branch. p02 (date_cte_explicit_join) showed neutral regression; converting all dimensions to explicit joins may provide better selectivity propagation.",
    "expected_explain_delta": "Explicit join graph may allow better join order and reduce hash join cardinality mismatch (est=7, act=446) in wsr branch.",
    "target_ir": "Rewrite ssr, csr, wsr to use explicit JOIN syntax for all dimension tables, preserving LEFT OUTER JOIN with returns tables.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ssr", "csr", "wsr"],
          "outputs": ["channel", "id", "sales", "returns", "profit"],
          "changed": false
        },
        {
          "node_id": "ssr",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "date_dim", "store", "item", "promotion"],
          "outputs": ["store_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT s_store_id AS store_id,\n       SUM(ss_ext_sales_price) AS sales,\n       SUM(COALESCE(sr_return_amt, 0)) AS returns,\n       SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit\nFROM store_sales\nLEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)\nINNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\nINNER JOIN store ON ss_store_sk = s_store_sk\nINNER JOIN item ON ss_item_sk = i_item_sk\nINNER JOIN promotion ON ss_promo_sk = p_promo_sk\nWHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 DAY'\n  AND i_current_price > 50\n  AND p_channel_email = 'Y'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND ss_wholesale_cost BETWEEN 21 AND 36\n  AND i_category IN ('Men', 'Music')\nGROUP BY s_store_id"
        },
        {
          "node_id": "csr",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "catalog_returns", "date_dim", "catalog_page", "item", "promotion"],
          "outputs": ["catalog_page_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id,\n       SUM(cs_ext_sales_price) AS sales,\n       SUM(COALESCE(cr_return_amount, 0)) AS returns,\n       SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit\nFROM catalog_sales\nLEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)\nINNER JOIN date_dim ON cs_sold_date_sk = d_date_sk\nINNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk\nINNER JOIN item ON cs_item_sk = i_item_sk\nINNER JOIN promotion ON cs_promo_sk = p_promo_sk\nWHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 DAY'\n  AND i_current_price > 50\n  AND p_channel_email = 'Y'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND cs_wholesale_cost BETWEEN 21 AND 36\n  AND i_category IN ('Men', 'Music')\nGROUP BY cp_catalog_page_id"
        },
        {
          "node_id": "wsr",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "date_dim", "web_site", "item", "promotion"],
          "outputs": ["web_site_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT web_site_id,\n       SUM(ws_ext_sales_price) AS sales,\n       SUM(COALESCE(wr_return_amt, 0)) AS returns,\n       SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit\nFROM web_sales\nLEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)\nINNER JOIN date_dim ON ws_sold_date_sk = d_date_sk\nINNER JOIN web_site ON ws_web_site_sk = web_site_sk\nINNER JOIN item ON ws_item_sk = i_item_sk\nINNER JOIN promotion ON ws_promo_sk = p_promo_sk\nWHERE d_date BETWEEN CAST('1999-10-21' AS DATE) AND CAST('1999-10-21' AS DATE) + INTERVAL '30 DAY'\n  AND i_current_price > 50\n  AND p_channel_email = 'Y'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND ws_wholesale_cost BETWEEN 21 AND 36\n  AND i_category IN ('Men', 'Music')\nGROUP BY web_site_id"
        }
      ]
    }
  }
]