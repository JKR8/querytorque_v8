[
  {
    "plan_id": "snipe_p1",
    "family": "B,F",
    "transform": "decorrelate_with_explicit_joins",
    "dialect": "postgres",
    "based_on": "p07,p02",
    "hypothesis": "Correlated subquery causes nested loop re-execution per row. Comma joins prevent efficient join planning. Decorrelation via CTE with explicit JOINs should eliminate per-row execution while explicit joins improve row estimates.",
    "target_ir": "Main query with filtered_dates CTE, item_avg_discount CTE (grouped by item_sk), and explicit JOINs replacing comma joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_dates",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "item_avg_discount",
          "cte_query_sql": "SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN filtered_dates ON d_date_sk = cs_sold_date_sk WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY cs_item_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales AS cs JOIN item AS i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_dates AS fd ON fd.d_date_sk = cs.cs_sold_date_sk JOIN item_avg_discount AS tad ON tad.cs_item_sk = cs.cs_item_sk WHERE (i.i_manufact_id IN (47, 226, 612, 676, 818) OR i.i_manager_id BETWEEN 71 AND 100) AND cs.cs_ext_discount_amt > tad.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "family": "A,B",
    "transform": "dimension_prefetch_with_decorrelation",
    "dialect": "postgres",
    "based_on": "p06",
    "hypothesis": "Prefiltering dimensions into CTEs reduces fact table joins early. Combined with decorrelation, this minimizes input sizes before non-equi threshold comparison while preserving OR condition as single scan.",
    "target_ir": "Main query with filtered_items CTE, filtered_dates CTE, item_avg_discount CTE, and explicit JOINs between CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_items",
          "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_dates",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "item_avg_discount",
          "cte_query_sql": "SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN filtered_dates ON d_date_sk = cs_sold_date_sk WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY cs_item_sk"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales AS cs JOIN filtered_items AS fi ON cs.cs_item_sk = fi.i_item_sk JOIN filtered_dates AS fd ON fd.d_date_sk = cs.cs_sold_date_sk JOIN item_avg_discount AS tad ON tad.cs_item_sk = cs.cs_item_sk WHERE cs.cs_ext_discount_amt > tad.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
        }
      }
    ]
  }
]