[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p07",
    "strategy": "Decorrelate subquery + explicit JOIN syntax",
    "hypothesis": "Original plan suffers from CORRELATED_SUBQUERY_PARALYSIS and COMMA_JOIN_WEAKNESS. Convert correlated subquery to CTE with GROUP BY and replace comma joins with explicit JOINs to improve join planning and eliminate per-row subquery execution.",
    "target_ir": "Main query with explicit JOINs and threshold CTE replacing correlated subquery",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH item_discount_thresholds AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 DAY' AND cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY cs_item_sk) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk JOIN item_discount_thresholds AS idt ON idt.cs_item_sk = catalog_sales.cs_item_sk WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100) AND cs_ext_discount_amt > idt.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p06,p07",
    "strategy": "Dimension prefetch + decorrelation",
    "hypothesis": "OR condition on item blocks index usage (CROSS_COLUMN_OR_DECOMPOSITION gap). Precompute filtered dimensions in CTEs to isolate OR condition, combine with decorrelated threshold CTE to reduce nested loops and enable better index usage.",
    "target_ir": "Three CTEs (filtered_items, filtered_dates, threshold) with explicit JOINs in main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_items AS (SELECT i_item_sk FROM item WHERE i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 DAY'), item_discount_thresholds AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN filtered_dates ON d_date_sk = cs_sold_date_sk WHERE cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01 GROUP BY cs_item_sk) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN filtered_items ON filtered_items.i_item_sk = catalog_sales.cs_item_sk JOIN filtered_dates ON filtered_dates.d_date_sk = catalog_sales.cs_sold_date_sk JOIN item_discount_thresholds AS idt ON idt.cs_item_sk = catalog_sales.cs_item_sk WHERE cs_ext_discount_amt > idt.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
        }
      }
    ]
  }
]