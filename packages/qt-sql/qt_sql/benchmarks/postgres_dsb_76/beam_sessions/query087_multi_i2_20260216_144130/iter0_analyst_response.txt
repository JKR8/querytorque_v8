## Analysis of Optimization Families

### Family A: Early Filtering (Predicate Pushback)
**Relevance**: HIGH  
The query applies identical filters on `date_dim` (d_month_seq) and `customer` (c_birth_year) across all three subqueries. Precomputing these filtered dimensions would prevent redundant scans.

### Family B: Decorrelation (Sets Over Loops)
**Relevance**: LOW  
No correlated subqueries exist. All joins are explicit equality joins between tables.

### Family C: Aggregation Pushdown
**Relevance**: LOW  
DISTINCT operations require columns from joined tables (customer + date_dim), preventing safe aggregation pushdown before joins.

### Family D: Set Operation Optimization
**Relevance**: HIGH  
EXCEPT operations force full materialization/sorting of three large subquery results. Converting to NOT EXISTS would use indexed lookups instead.

### Family E: Materialization/Prefetch
**Relevance**: HIGH  
Identical dimension tables (date_dim/customer) are scanned three times with the same filtersâ€”a prime candidate for CTE materialization.

### Family F: Join Transform
**Relevance**: MEDIUM  
Implicit comma joins could be converted to explicit INNER JOINs, but this provides minor gains compared to dimension reuse.

**Chosen families**: D, E, A  
**Confidence**: High (plan shows repeated scans + expensive sorts for set ops)

---

```json
[
  {
    "family": "E",
    "transform": "multi_dimension_prefetch",
    "target_id": "t1",
    "relevance_score": 0.95,
    "hypothesis": "Identical date_dim/customer scans repeated 3x with same filters. Materializing filtered versions reduces I/O and join work.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_date (via Q1)\n    SELECT: d_date_sk, d_date\n    FROM: date_dim\n    WHERE: d_month_seq BETWEEN 1213 AND 1224\n  CTE: filtered_cust (via Q2)\n    SELECT: c_customer_sk, c_last_name, c_first_name\n    FROM: customer\n    WHERE: c_birth_year BETWEEN 1968 AND 1974\n  MAIN QUERY (via Q0)\n    FROM: (\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM store_sales\n         INNER JOIN filtered_date ON ss_sold_date_sk = d_date_sk\n         INNER JOIN filtered_cust ON ss_customer_sk = c_customer_sk\n       WHERE ss_list_price BETWEEN 168 AND 197\n         AND ss_wholesale_cost BETWEEN 76 AND 86)\n      EXCEPT\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM catalog_sales\n         INNER JOIN filtered_date ON cs_sold_date_sk = d_date_sk\n         INNER JOIN filtered_cust ON cs_bill_customer_sk = c_customer_sk\n       WHERE cs_list_price BETWEEN 168 AND 197\n         AND cs_wholesale_cost BETWEEN 76 AND 86)\n      EXCEPT\n      (SELECT DISTINCT ... /* web_sales mirror */)\n    ) cool_cust",
    "recommended_examples": ["multi_dimension_prefetch"]
  },
  {
    "family": "D",
    "transform": "intersect_to_exists",
    "target_id": "t2",
    "relevance_score": 0.90,
    "hypothesis": "EXCEPT forces materializing/sorting all subqueries. NOT EXISTS with indexed lookups avoids intermediate result explosion.",
    "target_ir": "S0 [SELECT]\n  CTE: base_results (via Q1)\n    SELECT: c_last_name, c_first_name, d_date\n    FROM store_sales\n      INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n      INNER JOIN customer ON ss_customer_sk = c_customer_sk\n    WHERE d_month_seq BETWEEN 1213 AND 1224\n      AND ss_list_price BETWEEN 168 AND 197\n      AND c_birth_year BETWEEN 1968 AND 1974\n      AND ss_wholesale_cost BETWEEN 76 AND 86\n  MAIN QUERY (via Q0)\n    SELECT: COUNT(*)\n    FROM: base_results br\n    WHERE: NOT EXISTS (\n      SELECT 1 FROM catalog_sales\n        INNER JOIN date_dim ON cs_sold_date_sk = d_date_sk\n        INNER JOIN customer ON cs_bill_customer_sk = c_customer_sk\n      WHERE d_month_seq BETWEEN 1213 AND 1224\n        AND cs_list_price BETWEEN 168 AND 197\n        AND c_birth_year BETWEEN 1968 AND 1974\n        AND cs_wholesale_cost BETWEEN 76 AND 86\n        AND br.c_last_name = customer.c_last_name\n        AND br.c_first_name = customer.c_first_name\n        AND br.d_date = date_dim.d_date\n    )\n    AND NOT EXISTS (/* web_sales mirror */)",
    "recommended_examples": ["pg_intersect_to_exists"]
  },
  {
    "family": "A",
    "transform": "predicate_push_into_cte",
    "target_id": "t3",
    "relevance_score": 0.80,
    "hypothesis": "Sales table filters (list_price/wholesale_cost) applied late. Pushing them into CTEs reduces rows before DISTINCT.",
    "target_ir": "S0 [SELECT]\n  CTE: store_sales_pre (via Q1)\n    SELECT: ss_customer_sk, ss_sold_date_sk\n    FROM: store_sales\n    WHERE: ss_list_price BETWEEN 168 AND 197\n      AND ss_wholesale_cost BETWEEN 76 AND 86\n  CTE: catalog_sales_pre (via Q2) ... \n  MAIN QUERY (via Q0)\n    FROM: (\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM store_sales_pre\n         INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n         INNER JOIN customer ON ss_customer_sk = c_customer_sk\n       WHERE d_month_seq BETWEEN 1213 AND 1224\n         AND c_birth_year BETWEEN 1968 AND 1974)\n      EXCEPT\n      (SELECT DISTINCT ... /* catalog_sales_pre mirror */)\n      EXCEPT ...\n    ) cool_cust",
    "recommended_examples": ["pg_date_cte_explicit_join"]
  }
]
```