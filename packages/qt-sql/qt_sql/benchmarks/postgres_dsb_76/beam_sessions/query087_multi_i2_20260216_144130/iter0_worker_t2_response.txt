{
  "plan_id": "gold_postgres_pg_intersect_to_exists_and_predicate_push",
  "dialect": "postgres",
  "description": "Convert EXCEPT set operations to NOT EXISTS anti-joins and push selective filters into CTEs. PostgreSQL implements EXCEPT via full materialization and sorting, which is expensive. Pushing filters into CTEs reduces intermediate row counts. NOT EXISTS with indexed lookups avoids materialization and enables early pruning.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "store_sales_pre",
        "cte_query_sql": "SELECT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86"
      },
      "description": "Insert CTE 'store_sales_pre' with early filtering on store_sales"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "catalog_sales_pre",
        "cte_query_sql": "SELECT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86"
      },
      "description": "Insert CTE 'catalog_sales_pre' with early filtering on catalog_sales"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "web_sales_pre",
        "cte_query_sql": "SELECT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86"
      },
      "description": "Insert CTE 'web_sales_pre' with early filtering on web_sales"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "WITH store_sales_pre AS (SELECT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86), catalog_sales_pre AS (SELECT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86), web_sales_pre AS (SELECT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86) SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales_pre ss INNER JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1213 AND 1224 AND c.c_birth_year BETWEEN 1968 AND 1974) br WHERE NOT EXISTS (SELECT 1 FROM catalog_sales_pre cs INNER JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk INNER JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1213 AND 1224 AND c.c_birth_year BETWEEN 1968 AND 1974 AND br.c_last_name = c.c_last_name AND br.c_first_name = c.c_first_name AND br.d_date = d.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales_pre ws INNER JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk INNER JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1213 AND 1224 AND c.c_birth_year BETWEEN 1968 AND 1974 AND br.c_last_name = c.c_last_name AND br.c_first_name = c.c_first_name AND br.d_date = d.d_date)"
      },
      "description": "Replace main query body with optimized version using CTEs and NOT EXISTS"
    }
  ]
}