{
  "probe_id": "p09",
  "transform_id": "self_join_decomposition",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Decompose the self-join on wss into two specialized CTEs with embedded date and state filters to avoid redundant scans and enable early filtering.",
  "reasoning_trace": [
    "The original query joins the same CTE `wss` twice with different `d_month_seq` filters.",
    "PostgreSQL cannot push outer WHERE predicates into the CTE's GROUP BY, causing full materialization.",
    "Splitting into two CTEs with embedded filters reduces redundant aggregation and scan costs.",
    "Preserve all original literal values including state filters to pass structural validation."
  ],
  "target_ir": "Two CTEs (y_wss, x_wss) with embedded date and state filters, joined in main query; original comma joins replaced with explicit JOINs.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "y_wss",
        "cte_query_sql": "select d_week_seq, ss_store_sk, sum(case when (d_day_name='Sunday') then ss_sales_price else null end) sun_sales, sum(case when (d_day_name='Monday') then ss_sales_price else null end) mon_sales, sum(case when (d_day_name='Tuesday') then ss_sales_price else null end) tue_sales, sum(case when (d_day_name='Wednesday') then ss_sales_price else null end) wed_sales, sum(case when (d_day_name='Thursday') then ss_sales_price else null end) thu_sales, sum(case when (d_day_name='Friday') then ss_sales_price else null end) fri_sales, sum(case when (d_day_name='Saturday') then ss_sales_price else null end) sat_sales from store_sales, date_dim where d_date_sk = ss_sold_date_sk and ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01 and d_month_seq between 1183 and 1183 + 11 group by d_week_seq, ss_store_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "x_wss",
        "cte_query_sql": "select d_week_seq, ss_store_sk, sum(case when (d_day_name='Sunday') then ss_sales_price else null end) sun_sales, sum(case when (d_day_name='Monday') then ss_sales_price else null end) mon_sales, sum(case when (d_day_name='Tuesday') then ss_sales_price else null end) tue_sales, sum(case when (d_day_name='Wednesday') then ss_sales_price else null end) wed_sales, sum(case when (d_day_name='Thursday') then ss_sales_price else null end) thu_sales, sum(case when (d_day_name='Friday') then ss_sales_price else null end) fri_sales, sum(case when (d_day_name='Saturday') then ss_sales_price else null end) sat_sales from store_sales, date_dim where d_date_sk = ss_sold_date_sk and ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01 and d_month_seq between 1183 + 12 and 1183 + 23 group by d_week_seq, ss_store_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(select s_store_name s_store_name1,wss.d_week_seq d_week_seq1,s_store_id s_store_id1,sun_sales sun_sales1,mon_sales mon_sales1,tue_sales tue_sales1,wed_sales wed_sales1,thu_sales thu_sales1,fri_sales fri_sales1,sat_sales sat_sales1 from y_wss,store,date_dim d where d.d_week_seq = y_wss.d_week_seq and ss_store_sk = s_store_sk and s_state in ('AR','GA','IN','KS','KY','OH','SD','VA')) y, (select s_store_name s_store_name2,wss.d_week_seq d_week_seq2,s_store_id s_store_id2,sun_sales sun_sales2,mon_sales mon_sales2,tue_sales tue_sales2,wed_sales wed_sales2,thu_sales thu_sales2,fri_sales fri_sales2,sat_sales sat_sales2 from x_wss,store,date_dim d where d.d_week_seq = x_wss.d_week_seq and ss_store_sk = s_store_sk and s_state in ('AR','GA','IN','KS','KY','OH','SD','VA')) x"
      }
    }
  ]
}