{
  "probe_id": "p04",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Precompute store_sales joined with date_dim once in a CTE to eliminate repeated scans and improve performance of the self-join pattern.",
  "reasoning_trace": [
    "Original query repeats the same store_sales and date_dim join logic in both wss1 and wss2 subqueries.",
    "Materializing this join once allows PostgreSQL to reuse the result, avoiding redundant work."
  ],
  "target_ir": "Single CTE encapsulates store_sales joined with date_dim; main query references it twice for wss1/wss2 projections.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "joined_store_sales",
        "cte_query_sql": "SELECT ss_sold_date_sk, ss_store_sk, ss_sales_price, ss_list_price, d_week_seq, d_month_seq, d_day_name FROM store_sales JOIN date_dim ON d_date_sk = ss_sold_date_sk WHERE ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(SELECT d_week_seq, ss_store_sk, sum(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) sun_sales, sum(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) mon_sales, sum(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) tue_sales, sum(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) wed_sales, sum(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) thu_sales, sum(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) fri_sales, sum(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) sat_sales FROM joined_store_sales GROUP BY d_week_seq, ss_store_sk) wss, store, date_dim d"
      }
    }
  ]
}