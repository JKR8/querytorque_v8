{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate repeated aggregations on store_sales into a single pass to avoid multiple scans and reduce I/O.",
  "reasoning_trace": [
    "Multiple aggregate expressions computed over the same store_sales table",
    "Each aggregate currently requires a separate scan or subquery execution",
    "CASE-based aggregation in a CTE can compute all metrics in one pass"
  ],
  "target_ir": "CTE with CASE-based SUM expressions replacing multiple aggregate subqueries; main query selects from that CTE",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ss_metrics",
        "cte_query_sql": "SELECT ss_item_sk, ss_customer_sk, ss_store_sk, ss_ticket_number, ss_wholesale_cost, ss_list_price, ss_coupon_amt FROM store_sales WHERE ss_wholesale_cost BETWEEN 76 AND 96"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_select",
      "target": {"by_node_id": "S0", "by_anchor_hash": "0cee22073fe2dd22"},
      "payload": {
        "sql_fragment": "i_product_name product_name ,i_item_sk item_sk ,s_store_name store_name ,s_zip store_zip ,ad1.ca_street_number b_street_number ,ad1.ca_street_name b_street_name ,ad1.ca_city b_city ,ad1.ca_zip b_zip ,ad2.ca_street_number c_street_number ,ad2.ca_street_name c_street_name ,ad2.ca_city c_city ,ad2.ca_zip c_zip ,d1.d_year as syear ,d2.d_year as fsyear ,d3.d_year s2year ,count(*) cnt ,sum(CASE WHEN p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'Y' THEN ss_wholesale_cost ELSE 0 END) s1 ,sum(CASE WHEN p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'Y' THEN ss_list_price ELSE 0 END) s2 ,sum(CASE WHEN p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'Y' THEN ss_coupon_amt ELSE 0 END) s3"
      }
    }
  ]
}