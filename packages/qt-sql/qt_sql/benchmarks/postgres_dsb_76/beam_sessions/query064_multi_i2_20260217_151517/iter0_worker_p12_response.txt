{
  "probe_id": "p01",
  "transform_id": "inline_decorrelate_materialized",
  "family": "B",
  "dialect": "postgres",
  "hypothesis": "Materializing the cs_ui CTE prevents PostgreSQL from inlining it and re-executing the aggregation per outer query row, reducing redundant work.",
  "reasoning_trace": [
    "The cs_ui CTE computes an aggregate with a HAVING clause that depends on joined catalog_sales and catalog_returns.",
    "When referenced in cross_sales, PostgreSQL may inline and re-execute this logic per outer row due to correlated use.",
    "Using MATERIALIZED enforces early execution and materialization of the result set, avoiding repeated scans and aggregations."
  ],
  "target_ir": "cs_ui CTE marked as MATERIALIZED; original FROM/WHERE/GROUP BY preserved; cross_sales continues to reference it.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "cs_ui AS MATERIALIZED (SELECT cs_item_sk, sum(cs_ext_list_price) AS sale, sum(cr_refunded_cash + cr_reversed_charge + cr_store_credit) AS refund FROM catalog_sales, catalog_returns WHERE cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY cs_item_sk HAVING sum(cs_ext_list_price) > 2 * sum(cr_refunded_cash + cr_reversed_charge + cr_store_credit))"
      }
    }
  ]
}