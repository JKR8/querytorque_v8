[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Materializes base revenue CTE to avoid duplicate store_sales scans and pre-filters dimensions to reduce join cardinality. Explicit JOIN syntax improves optimizer decisions.",
    "target_ir": "CTE chain: base_revenue → store_avg_revenue + filtered dimensions → explicit JOINs with pushed-down predicates",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH base_revenue AS (\n  SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE d_month_seq BETWEEN 1195 AND 1195+11\n    AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n),\nstore_avg_revenue AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM base_revenue\n  GROUP BY ss_store_sk\n),\nfiltered_store AS (\n  SELECT s_store_sk, s_store_name\n  FROM store\n  WHERE s_state IN ('IA','IL','NC')\n),\nfiltered_item AS (\n  SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand\n  FROM item\n  WHERE i_manager_id BETWEEN 80 AND 84\n)\nSELECT\n  s.s_store_name,\n  i.i_item_desc,\n  sc.revenue,\n  i.i_current_price,\n  i.i_wholesale_cost,\n  i.i_brand\nFROM filtered_store s\nJOIN base_revenue sc ON s.s_store_sk = sc.ss_store_sk\nJOIN store_avg_revenue sb ON sc.ss_store_sk = sb.ss_store_sk\nJOIN filtered_item i ON sc.ss_item_sk = i.i_item_sk\nWHERE sc.revenue <= 0.1 * sb.ave\nORDER BY s.s_store_name, i.i_item_desc\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01",
    "strategy": "Alternative independent pathway",
    "hypothesis": "Materializes base revenue CTE to avoid duplicate scans while maintaining original structure. Explicit JOINs address comma-join weakness without dimension pre-filters.",
    "target_ir": "CTE chain: base_revenue → sb/sc aggregates → explicit JOINs with original dimension tables",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH base_revenue AS (\n  SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE d_month_seq BETWEEN 1195 AND 1195+11\n    AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n),\nsb AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM base_revenue\n  GROUP BY ss_store_sk\n),\nsc AS (\n  SELECT ss_store_sk, ss_item_sk, revenue\n  FROM base_revenue\n)\nSELECT\n  s.s_store_name,\n  i.i_item_desc,\n  sc.revenue,\n  i.i_current_price,\n  i.i_wholesale_cost,\n  i.i_brand\nFROM store s\nJOIN sc ON s.s_store_sk = sc.ss_store_sk\nJOIN sb ON sc.ss_store_sk = sb.ss_store_sk\nJOIN item i ON sc.ss_item_sk = i.i_item_sk\nWHERE sc.revenue <= 0.1 * sb.ave\n  AND i.i_manager_id BETWEEN 80 AND 84\n  AND s.s_state IN ('IA','IL','NC')\nORDER BY s.s_store_name, i.i_item_desc\nLIMIT 100;"
        }
      }
    ]
  }
]