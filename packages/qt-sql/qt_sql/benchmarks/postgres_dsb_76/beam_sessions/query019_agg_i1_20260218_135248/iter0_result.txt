{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.02439189,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 99640,
    "completion_tokens": 13426,
    "total_tokens": 113066,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 34880,
    "reasoning_tokens": 6050
  },
  "best_speedup": 2.45,
  "best_patch_id": "p02",
  "best_sql": "WITH date_filter AS MATERIALIZED (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 4) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM store_sales JOIN date_filter ON ss_sold_date_sk = date_filter.d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN store ON ss_store_sk = s_store_sk WHERE i_category = 'Jewelry' AND substring(ca_zip,1,5) <> substring(s_zip,1,5) AND ca_state = 'IL' AND c_birth_month = 1 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100;",
  "patches": [
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.78,
      "status": "WIN",
      "speedup": 2.45,
      "semantic_passed": true,
      "error": null,
      "original_ms": 149.3,
      "patch_ms": 60.9,
      "output_sql": "WITH date_filter AS MATERIALIZED (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 4) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM store_sales JOIN date_filter ON ss_sold_date_sk = date_filter.d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN store ON ss_store_sk = s_store_sk WHERE i_category = 'Jewelry' AND substring(ca_zip,1,5) <> substring(s_zip,1,5) AND ca_state = 'IL' AND c_birth_month = 1 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Isolate date_dim filter into MATERIALIZED CTE and convert comma joins to explicit JOIN syntax, enabling better join order optimization."
    },
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.82,
      "status": "REGRESSION",
      "speedup": 0.91,
      "semantic_passed": true,
      "error": null,
      "original_ms": 149.3,
      "patch_ms": 164.7,
      "output_sql": "WITH store_sales_filtered AS (SELECT ss_sold_date_sk, ss_item_sk, ss_customer_sk, ss_store_sk, ss_ext_sales_price, ss_wholesale_cost FROM store_sales WHERE ss_wholesale_cost BETWEEN 35 AND 55), date_dim_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 4), item_cte AS (SELECT i_item_sk, i_brand_id, i_brand, i_manufact_id, i_manufact FROM item WHERE i_category = 'Jewelry'), customer_cte AS (SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_month = 1), customer_address_cte AS (SELECT ca_address_sk, ca_zip FROM customer_address WHERE ca_state = 'IL'), store_cte AS (SELECT s_store_sk, s_zip FROM store) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM store_sales_filtered JOIN date_dim_cte ON d_date_sk = ss_sold_date_sk JOIN item_cte ON ss_item_sk = i_item_sk JOIN customer_cte ON ss_customer_sk = c_customer_sk JOIN customer_address_cte ON c_current_addr_sk = ca_address_sk JOIN store_cte ON ss_store_sk = s_store_sk GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit JOIN syntax and pre-filter all selective dimensions (date_dim, item, customer, customer_address, store) into MATERIALIZED CTEs before joining with store_sales."
    },
    {
      "patch_id": "p04",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.91,
      "semantic_passed": true,
      "error": null,
      "original_ms": 149.3,
      "patch_ms": 164.4,
      "output_sql": "WITH customer_filtered AS (\n  SELECT *\n  FROM customer\n  WHERE c_birth_month = 1\n),\ncustomer_address_filtered AS (\n  SELECT *\n  FROM customer_address\n  WHERE ca_state = 'IL'\n)\nSELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact,\n       SUM(ss_ext_sales_price) AS ext_price\nFROM date_dim\nJOIN store_sales ON d_date_sk = ss_sold_date_sk\nJOIN item ON ss_item_sk = i_item_sk\nJOIN customer_filtered c ON ss_customer_sk = c.c_customer_sk\nJOIN customer_address_filtered ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN store s ON ss_store_sk = s.s_store_sk\nWHERE i_category = 'Jewelry'\n  AND d_year = 2002\n  AND d_moy = 4\n  AND substring(ca.ca_zip,1,5) <> substring(s.s_zip,1,5)\n  AND ss_wholesale_cost BETWEEN 35 AND 55\nGROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact\nORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all dimensions into CTEs and use explicit joins, focusing on early reduction of customer and customer_address to address cardinality underestimation."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "pg_materialized_dimension_fact_prefilter",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.91,
      "semantic_passed": true,
      "error": null,
      "original_ms": 149.3,
      "patch_ms": 164.5,
      "output_sql": "select  i_brand_id brand_id, i_brand brand, i_manufact_id, i_manufact,\n \tsum(ss_ext_sales_price) ext_price\n  from date_dim, store_sales, item,customer,customer_address,store\n  where  d_date_sk = ss_sold_date_sk\n    and ss_item_sk = i_item_sk\n    and ss_customer_sk = c_customer_sk\n    and c_current_addr_sk = ca_address_sk\n    and ss_store_sk = s_store_sk\n    AND i_category  = 'Jewelry'\n    and d_year=2002\n    and d_moy = 4\n    and substring(ca_zip,1,5) <> substring(s_zip,1,5)\n    and ca_state  = 'IL'\n    and c_birth_month = 1\n    and ss_wholesale_cost BETWEEN 35 AND 55\n group by i_brand\n      ,i_brand_id\n      ,i_manufact_id\n      ,i_manufact\n order by ext_price desc\n         ,i_brand\n         ,i_brand_id\n         ,i_manufact_id\n         ,i_manufact\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Create MATERIALIZED CTEs for selective dimensions (item, customer, customer_address, store) and pre-join them with store_sales before final aggregation."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.79,
      "semantic_passed": true,
      "error": null,
      "original_ms": 98.5,
      "patch_ms": 55.0,
      "output_sql": "WITH date_filter AS MATERIALIZED (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 4) SELECT i_brand_id AS brand_id, i_brand AS brand, i_manufact_id, i_manufact, SUM(ss_ext_sales_price) AS ext_price FROM store_sales JOIN date_filter ON ss_sold_date_sk = date_filter.d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN store ON ss_store_sk = s_store_sk WHERE i_category = 'Jewelry' AND substring(ca_zip,1,5) <> substring(s_zip,1,5) AND ca_state = 'IL' AND c_birth_month = 1 AND ss_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_brand, i_brand_id, i_manufact_id, i_manufact ORDER BY ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "Limit  (rows=4, time=71.899)\n  Index Only Scan on date_dim  (rows=30, time=0.044)\n  Sort  (rows=4, time=71.897)\n    Aggregate  (rows=4, time=71.873)\n      Sort  (rows=5, time=71.858)\n        Nested Loop  (rows=5, time=71.844)\n          Seq Scan on store  (rows=102, time=0.017)\n          Materialize  (rows=5, time=0.704)\n            Nested Loop  (rows=5, time=71.756)\n              Nested Loop  (rows=311, time=69.812)\n                Hash Join  (rows=3297, time=52.942)\n                  Nested Loo",
    "p01": "Limit  (rows=4, time=163.337)\n  Sort  (rows=4, time=163.334)\n    Aggregate  (rows=4, time=163.322)\n      Gather Merge  (rows=4, time=163.315)\n        Aggregate  (rows=4, time=163.005)\n          Sort  (rows=5, time=162.992)\n            Nested Loop  (rows=5, time=162.967)\n              Nested Loop  (rows=309, time=160.832)\n                Nested Loop  (rows=3259, time=141.361)\n                  Hash Join  (rows=54766, time=46.694)\n                    Nested Loop  (rows=55425, time=41.858)\n        ",
    "p04": "Limit  (rows=4, time=153.799)\n  Sort  (rows=4, time=153.797)\n    Aggregate  (rows=4, time=153.785)\n      Gather Merge  (rows=4, time=153.779)\n        Aggregate  (rows=4, time=153.458)\n          Sort  (rows=5, time=153.446)\n            Nested Loop  (rows=5, time=153.422)\n              Nested Loop  (rows=309, time=151.249)\n                Nested Loop  (rows=3259, time=132.828)\n                  Hash Join  (rows=54766, time=46.014)\n                    Nested Loop  (rows=55425, time=40.843)\n        ",
    "p03": "Limit  (rows=4, time=157.818)\n  Sort  (rows=4, time=157.816)\n    Aggregate  (rows=4, time=157.804)\n      Gather Merge  (rows=4, time=157.798)\n        Aggregate  (rows=4, time=157.514)\n          Sort  (rows=5, time=157.502)\n            Nested Loop  (rows=5, time=157.474)\n              Nested Loop  (rows=309, time=155.367)\n                Nested Loop  (rows=3259, time=136.424)\n                  Hash Join  (rows=54766, time=46.579)\n                    Nested Loop  (rows=55425, time=41.189)\n        ",
    "compile_p1": "Limit  (rows=4, time=76.452)\n  Index Only Scan on date_dim  (rows=30, time=0.048)\n  Sort  (rows=4, time=76.451)\n    Aggregate  (rows=4, time=76.43)\n      Sort  (rows=5, time=76.422)\n        Nested Loop  (rows=5, time=76.412)\n          Seq Scan on store  (rows=102, time=0.013)\n          Materialize  (rows=5, time=0.749)\n            Nested Loop  (rows=5, time=76.329)\n              Nested Loop  (rows=311, time=74.395)\n                Hash Join  (rows=3297, time=57.773)\n                  Nested Loop"
  }
}