{
  "probe_id": "scout_001",
  "transform_id": "materialize_cte",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing the filtered item table as a CTE can reduce the row count entering the main join, potentially improving performance by creating a smaller hash table for the join with catalog_sales.",
  "reasoning_trace": [
    "The item table filter (i_manufact_id IN (...) OR i_manager_id BETWEEN ...) is applied after a Seq Scan on 102K rows.",
    "Creating a CTE for the filtered item rows allows PostgreSQL to materialize a smaller subset (estimated 30K rows) which can be reused efficiently.",
    "The main query's correlated subquery (SubPlan 1) is a significant bottleneck; reducing item table size may help reduce its re-execution cost."
  ],
  "target_ir": "Introduce a new CTE node 'filtered_item' containing the item table with the OR filter applied, and reference it in the main query.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["catalog_sales", "filtered_item", "date_dim"],
        "outputs": ["excess discount amount"],
        "changed": true,
        "sql": "select  sum(cs_ext_discount_amt)  as \"excess discount amount\"\nfrom\n   catalog_sales\n   ,filtered_item\n   ,date_dim\nwhere\ni_item_sk = cs_item_sk\nand d_date between '2001-02-23' and\n        cast('2001-02-23' as date) + interval '90 day'\nand d_date_sk = cs_sold_date_sk\nand cs_ext_discount_amt\n     > (\n         select\n            1.3 * avg(cs_ext_discount_amt)\n         from\n            catalog_sales\n           ,date_dim\n         where\n              cs_item_sk = filtered_item.i_item_sk\n          and d_date between '2001-02-23' and\n                             cast('2001-02-23' as date) + interval '90 day'\n          and d_date_sk = cs_sold_date_sk\n          and cs_list_price between 115 and 144\n          and cs_sales_price / cs_list_price BETWEEN 21 * 0.01 AND 41 * 0.01\n      )\norder by sum(cs_ext_discount_amt)\nlimit 100;"
      },
      {
        "node_id": "filtered_item",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk"],
        "changed": true,
        "sql": "SELECT i_item_sk FROM item WHERE (i_manufact_id in (184, 307, 365, 560, 681) or i_manager_id BETWEEN 42 and 71)"
      }
    ]
  }
}