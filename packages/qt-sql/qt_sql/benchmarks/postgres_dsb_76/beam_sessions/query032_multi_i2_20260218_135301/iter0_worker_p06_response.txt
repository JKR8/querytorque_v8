{
  "probe_id": "p01",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Shared scan of filtered catalog_sales with date_dim join can eliminate redundant scans in both main query and subquery threshold calculation.",
  "reasoning_trace": [
    "Assigned transform targets redundant catalog_sales scans in correlated subquery pattern.",
    "Materializing filtered catalog_sales once allows reuse in both outer query and subquery logic.",
    "CTE reuse preserves row count and null semantics while reducing execution cost.",
    "PostgreSQL materializes CTEs by default, aligning with transform intent."
  ],
  "target_ir": "Introduce cte_sales as shared filtered scan; final_select and threshold subquery reference it.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cte_sales", "item"],
        "outputs": ["excess discount amount"],
        "changed": true,
        "sql": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM cte_sales JOIN item ON cte_sales.cs_item_sk = item.i_item_sk WHERE (i_manufact_id IN (184,307,365,560,681) OR i_manager_id BETWEEN 42 AND 71) AND cs_ext_discount_amt > (SELECT 1.3 * AVG(cs_ext_discount_amt) FROM cte_sales cs2 WHERE cs2.cs_item_sk = item.i_item_sk AND cs2.cs_list_price BETWEEN 115 AND 144 AND cs2.cs_sales_price / cs2.cs_list_price BETWEEN 0.21 AND 0.41) ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
      },
      {
        "node_id": "cte_sales",
        "parent_node_id": null,
        "sources": ["catalog_sales", "date_dim"],
        "outputs": ["cs_item_sk", "cs_ext_discount_amt", "cs_list_price", "cs_sales_price"],
        "changed": true,
        "sql": "SELECT cs.cs_item_sk, cs.cs_ext_discount_amt, cs.cs_list_price, cs.cs_sales_price FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day'"
      }
    ]
  }
}