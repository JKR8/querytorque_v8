[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "original",
    "strategy": "Explicit joins with dimension pre-filtering",
    "hypothesis": "Original comma-joins cause poor row estimates. Pre-filtering item and date_dim reduces nested loop amplification. Explicit joins enable better optimization.",
    "target_ir": "Explicit INNER JOINs with filtered_item and filtered_d1 CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_item AS (\n  SELECT i_item_sk\n  FROM item\n  WHERE i_category IN ('Children', 'Jewelry', 'Men')\n    AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n),\nfiltered_d1 AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim \n  WHERE d_year = 2001\n)\nSELECT \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    COUNT(*) AS cnt\nFROM store_sales\nINNER JOIN web_sales ON store_sales.ss_item_sk = web_sales.ws_item_sk\nINNER JOIN filtered_d1 d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk\nINNER JOIN date_dim d2 ON web_sales.ws_sold_date_sk = d2.d_date_sk\nINNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk \n  AND web_sales.ws_bill_customer_sk = customer.c_customer_sk\nINNER JOIN inventory ON store_sales.ss_item_sk = inventory.inv_item_sk \n  AND store_sales.ss_sold_date_sk = inventory.inv_date_sk\n  AND web_sales.ws_warehouse_sk = inventory.inv_warehouse_sk\n  AND inventory.inv_quantity_on_hand >= store_sales.ss_quantity\nINNER JOIN warehouse ON web_sales.ws_warehouse_sk = warehouse.w_warehouse_sk\nINNER JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk\nINNER JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk\nINNER JOIN household_demographics ON customer.c_current_hdemo_sk = household_demographics.hd_demo_sk\nINNER JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk,\nstore\nWHERE \n  d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day')\n  AND store.s_state = warehouse.w_state\n  AND customer_address.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')\n  AND web_sales.ws_wholesale_cost BETWEEN 35 AND 55\nGROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\nORDER BY cnt;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.68,
    "based_on": "original",
    "strategy": "Non-equi join early materialization",
    "hypothesis": "Inventory non-equi join processes unfiltered inputs. Materializing store_sales with item/d1 filters and inventory condition reduces join cardinality before web_sales join.",
    "target_ir": "CTE for store_sales+item+d1+inventory with non-equi condition, explicit joins in main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH store_sales_inv AS (\n  SELECT \n    ss.ss_item_sk, \n    ss.ss_customer_sk, \n    ss.ss_quantity, \n    ss.ss_sold_date_sk,\n    d1.d_date,\n    inv.inv_warehouse_sk\n  FROM store_sales ss\n  JOIN item i ON ss.ss_item_sk = i.i_item_sk\n  JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk\n  JOIN inventory inv ON ss.ss_item_sk = inv.inv_item_sk \n    AND ss.ss_sold_date_sk = inv.inv_date_sk \n    AND inv.inv_quantity_on_hand >= ss.ss_quantity\n  WHERE \n    i.i_category IN ('Children', 'Jewelry', 'Men')\n    AND i.i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n    AND d1.d_year = 2001\n)\nSELECT \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    COUNT(*) AS cnt\nFROM store_sales_inv ssi\nINNER JOIN web_sales ws ON ws.ws_item_sk = ssi.ss_item_sk \n  AND ws.ws_warehouse_sk = ssi.inv_warehouse_sk\nINNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk\nINNER JOIN customer c ON ssi.ss_customer_sk = c.c_customer_sk \n  AND ws.ws_bill_customer_sk = c.c_customer_sk\nINNER JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk\nINNER JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk\nINNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk\nINNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk,\nstore s\nWHERE \n  d2.d_date BETWEEN ssi.d_date AND (ssi.d_date + INTERVAL '30 day')\n  AND s.s_state = w.w_state\n  AND ca.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\nGROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\nORDER BY cnt;"
        }
      }
    ]
  }
]