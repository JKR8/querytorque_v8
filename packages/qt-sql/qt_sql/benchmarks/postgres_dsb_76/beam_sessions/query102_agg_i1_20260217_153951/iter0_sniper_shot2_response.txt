[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "original",
    "strategy": "Explicit joins and early date filtering",
    "hypothesis": "Original comma-joins cause poor row estimates. Convert to explicit JOINs and isolate d1 filter via CTE to reduce Merge Join input size. EXPLAIN shows 45.6s spent on Merge Join processing 10k rows from nested loops.",
    "target_ir": "CTE for filtered d1 + explicit JOIN structure with conditions in ON clauses",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_d1",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2001"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN filtered_d1 d1 ON ss_sold_date_sk = d1.d_date_sk JOIN web_sales ON ss_item_sk = ws_item_sk JOIN date_dim d2 ON ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 day') JOIN customer ON ss_customer_sk = c_customer_sk AND ws_bill_customer_sk = c_customer_sk JOIN item ON ss_item_sk = i_item_sk JOIN inventory ON ss_item_sk = inv_item_sk AND ss_sold_date_sk = inv_date_sk JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk AND inv_warehouse_sk = w_warehouse_sk JOIN store ON s_state = w_state JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "inv_quantity_on_hand >= ss_quantity AND i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93) AND ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA') AND ws_wholesale_cost BETWEEN 35 AND 55"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "original",
    "strategy": "Fact table pre-join with dimensions",
    "hypothesis": "Non-equi join processes unfiltered inputs. Pre-join store_sales with dimensions to reduce rows before inventory join. EXPLAIN shows nested loops amplifying 13k store_sales Ã— 786 items = 10M+ rows.",
    "target_ir": "CTE for pre-joined store_sales with dimensions + simplified main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_ss",
          "cte_query_sql": "SELECT ss_item_sk, ss_quantity, ss_sold_date_sk, ss_customer_sk, c_customer_sk, d1.d_date AS d1_date, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN household_demographics ON c_current_hdemo_sk = hd_demo_sk JOIN item ON ss_item_sk = i_item_sk JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year = 2001 AND i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93) AND ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "filtered_ss ss JOIN web_sales ws ON ss.ss_item_sk = ws.ws_item_sk AND ss.c_customer_sk = ws.ws_bill_customer_sk JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN ss.d1_date AND (ss.d1_date + INTERVAL '30 day') JOIN inventory inv ON ss.ss_item_sk = inv.inv_item_sk AND ss.ss_sold_date_sk = inv.inv_date_sk JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk JOIN store s ON s.s_state = w.w_state"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "inv_quantity_on_hand >= ss_quantity AND ws_wholesale_cost BETWEEN 35 AND 55"
        }
      }
    ]
  }
]