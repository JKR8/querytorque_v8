{
  "probe_id": "p12",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering selective dimensions into CTEs and using explicit star-join syntax will reduce row amplification from nested loops and improve join order.",
  "reasoning_trace": [
    "Nested loop joins dominate execution time due to comma join syntax and poor cardinality estimates.",
    "Materializing selective dimensions (item, customer_address, household_demographics, date_dim) into CTEs creates small build sides for hash joins.",
    "Converting comma joins to explicit JOIN syntax enables better join reordering and selectivity propagation."
  ],
  "target_ir": "Selective dimensions prefetched into CTEs with explicit star-join structure around store_sales/store_returns/web_sales facts.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["main_join"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, count(*) as cnt FROM main_join mj JOIN customer c ON mj.ss_customer_sk = c.c_customer_sk GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt"
      },
      {
        "node_id": "main_join",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "web_sales", "item_filtered", "date_dim_d1", "date_dim_d2", "customer_address_filtered", "household_demographics_filtered"],
        "outputs": ["ss_customer_sk"],
        "changed": true,
        "sql": "WITH item_filtered AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music')), customer_address_filtered AS (SELECT ca_address_sk FROM customer_address WHERE ca_state in ('AR', 'CO', 'NC', 'NY', 'TX')), household_demographics_filtered AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 7 AND 13 AND hd_buy_potential = '0-500'), date_dim_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998), date_dim_d2 AS (SELECT d_date_sk, d_date FROM date_dim) SELECT ss.ss_customer_sk FROM store_sales ss JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk JOIN item_filtered i ON ss.ss_item_sk = i.i_item_sk JOIN customer_address_filtered ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN household_demographics_filtered hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN date_dim_d1 d1 ON sr.sr_returned_date_sk = d1.d_date_sk JOIN date_dim_d2 d2 ON ws.ws_sold_date_sk = d2.d_date_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 35 * 0.01 AND 55 * 0.01 AND d2.d_date between d1.d_date AND (d1.d_date + interval '90 day')"
      }
    ]
  }
}