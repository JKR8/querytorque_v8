{
  "probe_id": "scout_001",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing selective filters on date_dim, item, customer_address, and household_demographics as CTEs reduces row counts before the expensive non-equi join. Converting comma joins to explicit JOINs enables better optimization and join reordering.",
  "reasoning_trace": [
    "Non-equi join between d1 and d2 dominates execution time with nested loops due to poor cardinality estimates.",
    "Selective dimension filters (e.g., ca_state, hd_income_band_sk, i_category) can be pre-applied to reduce intermediate sizes.",
    "Explicit JOIN syntax unlocks PostgreSQL's join reordering capabilities, avoiding nested loop traps.",
    "CTEs for filtered dimensions are reused and protect from repeated scans while enabling early filtering."
  ],
  "target_ir": "Introduce MATERIALIZED CTEs for filtered dimensions (d1, d2, item, customer_address, household_demographics), convert comma joins to explicit JOINs, and pre-join filtered dimensions with facts.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["aggregated_results"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_first_name, c_last_name, cnt FROM aggregated_results ORDER BY cnt"
      },
      {
        "node_id": "aggregated_results",
        "parent_node_id": "final_select",
        "sources": [
          "store_sales_filtered",
          "store_returns_filtered",
          "web_sales_filtered",
          "d1_filtered",
          "d2_filtered",
          "item_filtered",
          "customer_filtered",
          "customer_address_filtered",
          "household_demographics_filtered"
        ],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM store_sales_filtered ss JOIN store_returns_filtered sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN web_sales_filtered ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk JOIN d1_filtered d1 ON sr.sr_returned_date_sk = d1.d_date_sk JOIN d2_filtered d2 ON ws.ws_sold_date_sk = d2.d_date_sk JOIN item_filtered i ON i.i_item_sk = ss.ss_item_sk JOIN customer_filtered c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address_filtered ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN household_demographics_filtered hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name"
      },
      {
        "node_id": "store_sales_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["store_sales"],
        "outputs": ["ss_ticket_number", "ss_item_sk", "ss_customer_sk", "ss_sales_price", "ss_list_price"],
        "changed": true,
        "sql": "SELECT ss_ticket_number, ss_item_sk, ss_customer_sk, ss_sales_price, ss_list_price FROM store_sales WHERE ss_sales_price / ss_list_price BETWEEN 0.35 AND 0.55"
      },
      {
        "node_id": "store_returns_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["store_returns"],
        "outputs": ["sr_returned_date_sk", "sr_item_sk", "sr_ticket_number"],
        "changed": true,
        "sql": "SELECT sr_returned_date_sk, sr_item_sk, sr_ticket_number FROM store_returns"
      },
      {
        "node_id": "web_sales_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["web_sales"],
        "outputs": ["ws_sold_date_sk", "ws_item_sk", "ws_bill_customer_sk"],
        "changed": true,
        "sql": "SELECT ws_sold_date_sk, ws_item_sk, ws_bill_customer_sk FROM web_sales"
      },
      {
        "node_id": "d1_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
      },
      {
        "node_id": "d2_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      },
      {
        "node_id": "item_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_category"],
        "changed": true,
        "sql": "SELECT i_item_sk, i_category FROM item WHERE i_category IN ('Children', 'Electronics', 'Music')"
      },
      {
        "node_id": "customer_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "c_current_addr_sk", "c_current_hdemo_sk"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_first_name, c_last_name, c_current_addr_sk, c_current_hdemo_sk FROM customer"
      },
      {
        "node_id": "customer_address_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state FROM customer_address WHERE ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX')"
      },
      {
        "node_id": "household_demographics_filtered",
        "parent_node_id": "aggregated_results",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_income_band_sk", "hd_buy_potential"],
        "changed": true,
        "sql": "SELECT hd_demo_sk, hd_income_band_sk, hd_buy_potential FROM household_demographics WHERE hd_income_band_sk BETWEEN 7 AND 13 AND hd_buy_potential = '0-500'"
      }
    ]
  }
}