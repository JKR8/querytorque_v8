{
  "iteration": 1,
  "n_api_calls": 7,
  "best_speedup": 1.0,
  "best_patch_id": "t2",
  "best_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
  "patches": [
    {
      "patch_id": "t1",
      "family": "B+A",
      "transform": "decorrelate_then_early_filter",
      "relevance_score": 0.95,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite \u2014 ['ctr_reason_sk']. The rewrite references different table columns.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_store_returns AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SR_RETURN_AMT_INC_TAX FROM store_returns INNER JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND sr_reason_sk BETWEEN 17 AND 20), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM filtered_store_returns GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), avg_thresholds AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 INNER JOIN avg_thresholds AS a ON ctr1.ctr_store_sk = a.ctr_store_sk INNER JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk INNER JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk INNER JOIN customer_demographics AS cd ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_total_return > a.threshold AND s_state IN ('IA', 'KY', 'NE') AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t2",
      "family": "A",
      "transform": "push_store_state_to_cte",
      "relevance_score": 0.85,
      "status": "NEUTRAL",
      "speedup": 1.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 28983.7,
      "patch_ms": 28877.2,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t4",
      "family": "B+A+F",
      "transform": "full_dimension_pushdown",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Equivalence execution error: column c.c_current_cdemo_sk does not exist\nLINE 1: ...NNER JOIN customer_demographics_filtered AS cd ON c.c_curren...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_filtered AS (SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')), customer_demographics_filtered AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M'), customer_filtered AS (SELECT c_customer_sk, c_customer_id FROM customer WHERE c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993), customer_total_return_agg AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) AS customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 INNER JOIN store_filtered AS s ON ctr1.ctr_store_sk = s.s_store_sk INNER JOIN customer_filtered AS c ON ctr1.ctr_customer_sk = c.c_customer_sk INNER JOIN customer_demographics_filtered AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk INNER JOIN customer_total_return_agg AS ctr_agg ON ctr1.ctr_store_sk = ctr_agg.ctr_store_sk WHERE ctr1.ctr_total_return > ctr_agg.threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t3",
      "family": "E",
      "transform": "precompute_filtered_cte",
      "relevance_score": 0.8,
      "status": "NEUTRAL",
      "speedup": 0.99,
      "semantic_passed": true,
      "error": null,
      "original_ms": 28983.7,
      "patch_ms": 29259.2,
      "output_sql": "WITH filtered_store_returns AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SR_RETURN_AMT_INC_TAX FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM filtered_store_returns GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_customer_total_return AS (SELECT * FROM customer_total_return WHERE ctr_reason_sk BETWEEN 17 AND 20) SELECT c_customer_id FROM filtered_customer_total_return AS ctr1 JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND s_state IN ('IA', 'KY', 'NE') AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true
    }
  ],
  "explains": {
    "t2": "Limit  (rows=0, time=32654.652)\n  Aggregate  (rows=93169, time=741.418)\n    Gather Merge  (rows=93235, time=712.89)\n      Aggregate  (rows=31078, time=497.602)\n        Sort  (rows=31155, time=487.599)\n          Nested Loop  (rows=31155, time=476.452)\n            Index Only Scan on date_dim  (rows=122, time=0.49)\n            Index Scan on store_returns  (rows=255, time=3.878)\n  Sort  (rows=0, time=32654.561)\n    Nested Loop  (rows=0, time=32654.55)\n      Nested Loop  (rows=6, time=32654.446)\n    ",
    "t3": "Limit  (rows=0, time=34284.667)\n  Aggregate  (rows=93169, time=677.74)\n    Gather Merge  (rows=93235, time=645.351)\n      Aggregate  (rows=31078, time=428.216)\n        Sort  (rows=31155, time=415.612)\n          Nested Loop  (rows=31155, time=403.358)\n            Index Only Scan on date_dim  (rows=122, time=0.688)\n            Index Scan on store_returns  (rows=255, time=3.277)\n  Sort  (rows=0, time=34284.564)\n    Nested Loop  (rows=0, time=34284.55)\n      Nested Loop  (rows=6, time=34284.431)\n   "
  }
}