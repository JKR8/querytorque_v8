{
  "iteration": 2,
  "n_api_calls": 8,
  "best_speedup": 1.03,
  "best_patch_id": "fix_t4_error",
  "best_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), customer_demographics_filtered AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status, cd_gender FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M'), store_filtered AS (SELECT s_store_sk, s_state FROM store WHERE s_state IN ('IA', 'KY', 'NE')) SELECT c_customer_id FROM customer_total_return AS ctr1, store_filtered AS s, customer AS c, customer_demographics_filtered AS cd WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s.s_store_sk = ctr1.ctr_store_sk AND ctr1.ctr_customer_sk = c.c_customer_sk AND c.c_current_cdemo_sk = cd.cd_demo_sk AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
  "patches": [
    {
      "patch_id": "ctr1_early_filter",
      "family": "B+A",
      "transform": "decorrelate_subquery_and_push_filters",
      "relevance_score": 0.98,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s2 failed: Cannot parse body sql_fragment: Failed to parse any statement following CTE. Line 1, Col: 455.\n  sk BETWEEN 17 AND 20 and sr_store_sk = s_store_sk group by sr_customer_sk ,sr_store_sk, sr_reason_sk\u001b[4m)\u001b[0m",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false
    },
    {
      "patch_id": "prefilter_demo",
      "family": "B+E+F",
      "transform": "prefilter_customer_demographics+explicit_join_store_in_cte",
      "relevance_score": 0.9,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s7 failed: Could not locate expression to delete for label=None hash='172e78014ed65e1b'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false
    },
    {
      "patch_id": "fix_t4_error",
      "family": "E",
      "transform": "rescue_dimension_prefetch",
      "relevance_score": 0.8,
      "status": "NEUTRAL",
      "speedup": 1.03,
      "semantic_passed": true,
      "error": null,
      "original_ms": 30631.3,
      "patch_ms": 29795.5,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), customer_demographics_filtered AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status, cd_gender FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M'), store_filtered AS (SELECT s_store_sk, s_state FROM store WHERE s_state IN ('IA', 'KY', 'NE')) SELECT c_customer_id FROM customer_total_return AS ctr1, store_filtered AS s, customer AS c, customer_demographics_filtered AS cd WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s.s_store_sk = ctr1.ctr_store_sk AND ctr1.ctr_customer_sk = c.c_customer_sk AND c.c_current_cdemo_sk = cd.cd_demo_sk AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true
    }
  ],
  "explains": {
    "fix_t4_error": "Limit  (rows=0, time=33640.438)\n  Aggregate  (rows=93169, time=1235.973)\n    Gather Merge  (rows=93235, time=1205.36)\n      Aggregate  (rows=31078, time=779.448)\n        Sort  (rows=31155, time=769.051)\n          Nested Loop  (rows=31155, time=755.573)\n            Index Only Scan on date_dim  (rows=122, time=0.695)\n            Index Scan on store_returns  (rows=255, time=6.159)\n  Sort  (rows=0, time=33640.351)\n    Nested Loop  (rows=0, time=33640.337)\n      Nested Loop  (rows=6, time=33640.23)\n "
  }
}