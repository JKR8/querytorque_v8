{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering selective dimension tables (cd1, cd2, promotion, ad1, ad2) into CTEs before joining with fact tables reduces row explosion caused by nested loops. Each filtered CTE acts as a small hash table, enabling hash joins and reducing fact-table scan size.",
  "reasoning_trace": [
    "Nested-loop explosion originates from under-estimated join between cross_sales and itself; selective dimensions scanned repeatedly.",
    "Assigned transform targets all selective dimension tables with clear filter predicates in WHERE clause.",
    "CTEs for cd1, cd2, promotion, ad1, ad2 isolate selective filters and allow reuse without duplication."
  ],
  "target_ir": "Dimension tables cd1, cd2, promotion, ad1, ad2 become prefetched CTEs; cross_sales rewritten to reference them.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cross_sales"],
        "outputs": ["product_name", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "cnt", "s11", "s21", "s31", "s12", "s22", "s32", "syear", "cnt"],
        "changed": false
      },
      {
        "node_id": "cross_sales",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "cs_ui", "date_dim", "store", "customer", "cd1_filtered", "promotion_filtered", "hd1", "hd2", "ad1_filtered", "ad2_filtered", "ib1", "ib2", "item"],
        "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
        "changed": true,
        "sql": "SELECT i_product_name product_name\n     ,i_item_sk item_sk\n     ,s_store_name store_name\n     ,s_zip store_zip\n     ,ad1.ca_street_number b_street_number\n     ,ad1.ca_street_name b_street_name\n     ,ad1.ca_city b_city\n     ,ad1.ca_zip b_zip\n     ,ad2.ca_street_number c_street_number\n     ,ad2.ca_street_name c_street_name\n     ,ad2.ca_city c_city\n     ,ad2.ca_zip c_zip\n     ,d1.d_year as syear\n     ,d2.d_year as fsyear\n     ,d3.d_year s2year\n     ,count(*) cnt\n     ,sum(ss_wholesale_cost) s1\n     ,sum(ss_list_price) s2\n     ,sum(ss_coupon_amt) s3\n  FROM   store_sales\n        ,store_returns\n        ,cs_ui\n        ,date_dim d1\n        ,date_dim d2\n        ,date_dim d3\n        ,store\n        ,customer\n        ,cd1_filtered cd1\n        ,cd2_filtered cd2\n        ,promotion_filtered p\n        ,household_demographics hd1\n        ,household_demographics hd2\n        ,ad1_filtered ad1\n        ,ad2_filtered ad2\n        ,income_band ib1\n        ,income_band ib2\n        ,item\n  WHERE  ss_store_sk = s_store_sk AND\n         ss_sold_date_sk = d1.d_date_sk AND\n         ss_customer_sk = c_customer_sk AND\n         ss_cdemo_sk= cd1.cd_demo_sk AND\n         ss_hdemo_sk = hd1.hd_demo_sk AND\n         ss_addr_sk = ad1.ca_address_sk and\n         ss_item_sk = i_item_sk and\n         ss_item_sk = sr_item_sk and\n         ss_ticket_number = sr_ticket_number and\n         ss_item_sk = cs_ui.cs_item_sk and\n         c_current_cdemo_sk = cd2.cd_demo_sk AND\n         c_current_hdemo_sk = hd2.hd_demo_sk AND\n         c_current_addr_sk = ad2.ca_address_sk and\n         c_first_sales_date_sk = d2.d_date_sk and\n         c_first_shipto_date_sk = d3.d_date_sk and\n         ss_promo_sk = p.p_promo_sk and\n         hd1.hd_income_band_sk = ib1.ib_income_band_sk and\n         hd2.hd_income_band_sk = ib2.ib_income_band_sk and\n         cd1.cd_marital_status <> cd2.cd_marital_status and\n         i_current_price between 77 and 77 + 10\n         and p.p_channel_email = 'Y'\n         and p.p_channel_tv = 'Y'\n         and p.p_channel_radio = 'Y'\n         and ad2.ca_state in ('KS','OH','VA')\n         and ss_wholesale_cost BETWEEN 76 AND 96\n         and cd1.cd_marital_status in ('S', 'S', 'S')\n         and cd1.cd_education_status in ('Advanced Degree', '4 yr Degree', '4 yr Degree')\n         and cd2.cd_marital_status in ('S', 'S', 'S')\n         and cd2.cd_education_status in ('Advanced Degree', '4 yr Degree', '4 yr Degree')\ngroup by i_product_name\n       ,i_item_sk\n       ,s_store_name\n       ,s_zip\n       ,ad1.ca_street_number\n       ,ad1.ca_street_name\n       ,ad1.ca_city\n       ,ad1.ca_zip\n       ,ad2.ca_street_number\n       ,ad2.ca_street_name\n       ,ad2.ca_city\n       ,ad2.ca_zip\n       ,d1.d_year\n       ,d2.d_year\n       ,d3.d_year"
      },
      {
        "node_id": "cs_ui",
        "parent_node_id": "cross_sales",
        "sources": ["catalog_sales", "catalog_returns"],
        "outputs": ["cs_item_sk", "sale", "refund"],
        "changed": false
      },
      {
        "node_id": "cd1_filtered",
        "parent_node_id": "cross_sales",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'S', 'S') AND cd_education_status IN ('Advanced Degree', '4 yr Degree', '4 yr Degree')"
      },
      {
        "node_id": "cd2_filtered",
        "parent_node_id": "cross_sales",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'S', 'S') AND cd_education_status IN ('Advanced Degree', '4 yr Degree', '4 yr Degree')"
      },
      {
        "node_id": "promotion_filtered",
        "parent_node_id": "cross_sales",
        "sources": ["promotion"],
        "outputs": ["p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio"],
        "changed": true,
        "sql": "SELECT p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio FROM promotion WHERE p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'Y'"
      },
      {
        "node_id": "ad1_filtered",
        "parent_node_id": "cross_sales",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_street_number", "ca_street_name", "ca_city", "ca_zip"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_street_number, ca_street_name, ca_city, ca_zip FROM customer_address"
      },
      {
        "node_id": "ad2_filtered",
        "parent_node_id": "cross_sales",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_state FROM customer_address WHERE ca_state IN ('KS','OH','VA')"
      }
    ]
  }
}