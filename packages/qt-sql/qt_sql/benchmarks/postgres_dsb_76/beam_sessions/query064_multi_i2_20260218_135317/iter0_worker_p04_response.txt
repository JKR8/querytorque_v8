{
  "probe_id": "p12",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing cross_sales once and filtering into cs1 and cs2 CTEs allows PostgreSQL to better estimate cardinalities and avoid nested loop explosion in final self-join.",
  "reasoning_trace": [
    "Assigned transform targets self-join on cross_sales; materialization approach aligns with PostgreSQL CTE default behavior.",
    "Creating cs1 and cs2 as filtered projections of materialized cross_sales avoids duplicating the 13-table scan body.",
    "Final SELECT rewritten to join cs1 and cs2 explicitly preserves all required output columns and WHERE semantics."
  ],
  "target_ir": "cross_sales materialized once; cs1 and cs2 derived with year filters; final_select joins cs1 and cs2 explicitly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "cs_ui",
        "parent_node_id": "cross_sales",
        "sources": ["catalog_sales", "catalog_returns"],
        "outputs": ["cs_item_sk", "sale", "refund"],
        "changed": false
      },
      {
        "node_id": "cross_sales",
        "parent_node_id": "cs1",
        "sources": ["store_sales", "store_returns", "cs_ui", "date_dim", "store", "customer", "customer_demographics", "promotion", "household_demographics", "customer_address", "income_band", "item"],
        "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
        "changed": false
      },
      {
        "node_id": "cs1",
        "parent_node_id": "final_select",
        "sources": ["cross_sales"],
        "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
        "changed": true,
        "sql": "SELECT * FROM cross_sales WHERE syear = 2000"
      },
      {
        "node_id": "cs2",
        "parent_node_id": "final_select",
        "sources": ["cross_sales"],
        "outputs": ["product_name", "item_sk", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "fsyear", "s2year", "cnt", "s1", "s2", "s3"],
        "changed": true,
        "sql": "SELECT * FROM cross_sales WHERE syear = 2001"
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cs1", "cs2"],
        "outputs": ["product_name", "store_name", "store_zip", "b_street_number", "b_street_name", "b_city", "b_zip", "c_street_number", "c_street_name", "c_city", "c_zip", "syear", "cnt", "s11", "s21", "s31", "s12", "s22", "s32", "syear", "cnt"],
        "changed": true,
        "sql": "SELECT cs1.product_name, cs1.store_name, cs1.store_zip, cs1.b_street_number, cs1.b_street_name, cs1.b_city, cs1.b_zip, cs1.c_street_number, cs1.c_street_name, cs1.c_city, cs1.c_zip, cs1.syear, cs1.cnt, cs1.s1 AS s11, cs1.s2 AS s21, cs1.s3 AS s31, cs2.s1 AS s12, cs2.s2 AS s22, cs2.s3 AS s32, cs2.syear, cs2.cnt FROM cs1 JOIN cs2 ON cs1.item_sk = cs2.item_sk AND cs1.store_name = cs2.store_name AND cs1.store_zip = cs2.store_zip WHERE cs2.cnt <= cs1.cnt ORDER BY cs1.product_name, cs1.store_name, cs2.cnt, cs1.s1, cs2.s1"
      }
    ]
  }
}