[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p04,p06,p08",
    "strategy": "Convert comma joins to explicit joins and reuse filtered_date CTE",
    "hypothesis": "PostgreSQL has poor row estimates for comma joins. Converting to explicit joins and reusing a filtered_date CTE should improve join order and reduce repeated scans of date_dim.",
    "target_ir": "CTE cross_items and main query subqueries rewritten with explicit joins and filtered_date CTE",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date AS (\n  SELECT d_date_sk, d_week_seq, d_year\n  FROM date_dim\n  WHERE d_year BETWEEN 1999 AND 1999 + 2\n),\ncross_items AS\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id\n     ,iss.i_class_id class_id\n     ,iss.i_category_id category_id\n from store_sales\n INNER JOIN item iss ON store_sales.ss_item_sk = iss.i_item_sk\n INNER JOIN filtered_date d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk\n where d1.d_year between 1999 AND 1999 + 2\n   and iss.i_category IN ('Electronics', 'Jewelry', 'Men')\n   and iss.i_manager_id BETWEEN 91 and 100\n   and store_sales.ss_wholesale_cost BETWEEN 35 AND 55\nintersect\n select ics.i_brand_id\n     ,ics.i_class_id\n     ,ics.i_category_id\n from catalog_sales\n INNER JOIN item ics ON catalog_sales.cs_item_sk = ics.i_item_sk\n INNER JOIN filtered_date d2 ON catalog_sales.cs_sold_date_sk = d2.d_date_sk\n where d2.d_year between 1999 AND 1999 + 2\n   and ics.i_category IN ('Electronics', 'Jewelry', 'Men')\n   and ics.i_manager_id BETWEEN 91 and 100\n   and catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55\nintersect\n select iws.i_brand_id\n     ,iws.i_class_id\n     ,iws.i_category_id\n from web_sales\n INNER JOIN item iws ON web_sales.ws_item_sk = iws.i_item_sk\n INNER JOIN filtered_date d3 ON web_sales.ws_sold_date_sk = d3.d_date_sk\n where web_sales.ws_wholesale_cost BETWEEN 35 AND 55\n   and d3.d_year between 1999 AND 1999 + 2) x\n where i_brand_id = brand_id\n      and i_class_id = class_id\n      and i_category_id = category_id\n      and i_category IN ('Electronics', 'Jewelry', 'Men')\n      and i_manager_id BETWEEN 91 and 100\n),\n avg_sales as\n(select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity\n             ,ss_list_price list_price\n       from store_sales\n           ,date_dim\n       where ss_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and ss_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select cs_quantity quantity\n             ,cs_list_price list_price\n       from catalog_sales\n           ,date_dim\n       where cs_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and cs_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select ws_quantity quantity\n             ,ws_list_price list_price\n       from web_sales\n           ,date_dim\n       where ws_sold_date_sk = d_date_sk\n        and ws_wholesale_cost BETWEEN 35 AND 55\n         and d_year between 1999 and 1999 + 2) x)\n  select  this_year.channel ty_channel\n                           ,this_year.i_brand_id ty_brand\n                           ,this_year.i_class_id ty_class\n                           ,this_year.i_category_id ty_category\n                           ,this_year.sales ty_sales\n                           ,this_year.number_sales ty_number_sales\n                           ,last_year.channel ly_channel\n                           ,last_year.i_brand_id ly_brand\n                           ,last_year.i_class_id ly_class\n                           ,last_year.i_category_id ly_category\n                           ,last_year.sales ly_sales\n                           ,last_year.number_sales ly_number_sales\n from\n (select 'store' channel, i_brand_id,i_class_id,i_category_id\n        ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999 + 1\n                       and d_moy = 12\n                       and d_dom = 20)\n   and item.i_category IN ('Electronics', 'Jewelry', 'Men')\n   and item.i_manager_id BETWEEN 91 and 100\n   and store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n group by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year,\n (select 'store' channel, i_brand_id,i_class_id\n        ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999\n                       and d_moy = 12\n                       and d_dom = 20)\n   and item.i_category IN ('Electronics', 'Jewelry', 'Men')\n   and store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n   and item.i_manager_id BETWEEN 91 and 100\n group by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year\n where this_year.i_brand_id= last_year.i_brand_id\n   and this_year.i_class_id = last_year.i_class_id\n   and this_year.i_category_id = last_year.i_category_id\n order by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\n limit 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p01",
    "strategy": "Replace INTERSECT with EXISTS to avoid expensive set operations",
    "hypothesis": "The INTERSECT operations are expensive. Rewriting with EXISTS should allow PostgreSQL to use semi-join optimizations and avoid materializing the intermediate sets.",
    "target_ir": "CTE cross_items rewritten with EXISTS subqueries",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "with  cross_items as\n (select i_item_sk ss_item_sk\n from item\n where i_category IN ('Electronics', 'Jewelry', 'Men')\n   and i_manager_id BETWEEN 91 and 100\n   and exists (select 1 from store_sales, date_dim\n               where store_sales.ss_item_sk = item.i_item_sk\n                 and store_sales.ss_sold_date_sk = date_dim.d_date_sk\n                 and date_dim.d_year between 1999 AND 1999 + 2\n                 and store_sales.ss_wholesale_cost BETWEEN 35 AND 55)\n   and exists (select 1 from catalog_sales, date_dim\n               where catalog_sales.cs_item_sk = item.i_item_sk\n                 and catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n                 and date_dim.d_year between 1999 AND 1999 + 2\n                 and catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55)\n   and exists (select 1 from web_sales, date_dim\n               where web_sales.ws_item_sk = item.i_item_sk\n                 and web_sales.ws_sold_date_sk = date_dim.d_date_sk\n                 and date_dim.d_year between 1999 AND 1999 + 2\n                 and web_sales.ws_wholesale_cost BETWEEN 35 AND 55)\n),\n avg_sales as\n(select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity\n             ,ss_list_price list_price\n       from store_sales\n           ,date_dim\n       where ss_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and ss_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select cs_quantity quantity\n             ,cs_list_price list_price\n       from catalog_sales\n           ,date_dim\n       where cs_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and cs_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select ws_quantity quantity\n             ,ws_list_price list_price\n       from web_sales\n           ,date_dim\n       where ws_sold_date_sk = d_date_sk\n        and ws_wholesale_cost BETWEEN 35 AND 55\n         and d_year between 1999 and 1999 + 2) x)\n  select  this_year.channel ty_channel\n                           ,this_year.i_brand_id ty_brand\n                           ,this_year.i_class_id ty_class\n                           ,this_year.i_category_id ty_category\n                           ,this_year.sales ty_sales\n                           ,this_year.number_sales ty_number_sales\n                           ,last_year.channel ly_channel\n                           ,last_year.i_brand_id ly_brand\n                           ,last_year.i_class_id ly_class\n                           ,last_year.i_category_id ly_category\n                           ,last_year.sales ly_sales\n                           ,last_year.number_sales ly_number_sales\n from\n (select 'store' channel, i_brand_id,i_class_id,i_category_id\n        ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n     ,item\n     ,date_dim\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and ss_item_sk = i_item_sk\n   and ss_sold_date_sk = d_date_sk\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999 + 1\n                       and d_moy = 12\n                       and d_dom = 20)\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and i_manager_id BETWEEN 91 and 100\n   and ss_wholesale_cost BETWEEN 35 AND 55\n group by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year,\n (select 'store' channel, i_brand_id,i_class_id\n        ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n     ,item\n     ,date_dim\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and ss_item_sk = i_item_sk\n   and ss_sold_date_sk = d_date_sk\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999\n                       and d_moy = 12\n                       and d_dom = 20)\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and ss_wholesale_cost BETWEEN 35 AND 55\n   and i_manager_id BETWEEN 91 and 100\n group by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year\n where this_year.i_brand_id= last_year.i_brand_id\n   and this_year.i_class_id = last_year.i_class_id\n   and this_year.i_category_id = last_year.i_category_id\n order by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\n limit 100;"
        }
      }
    ]
  }
]