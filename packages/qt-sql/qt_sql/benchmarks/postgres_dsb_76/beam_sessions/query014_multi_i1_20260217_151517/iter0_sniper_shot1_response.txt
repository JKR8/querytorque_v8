[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p03,p04",
    "strategy": "Foundation plus explicit join conversion",
    "hypothesis": "Convert comma joins to explicit INNER JOINs and introduce filtered_item CTE to push item filters early. BDA shows comma joins cause poor row estimates. Filtering item first reduces fact table joins.",
    "target_ir": "CTE with filtered_item, explicit joins in cross_items/avg_sales/main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_item AS (\n    SELECT i_item_sk, i_brand_id, i_class_id, i_category_id\n    FROM item\n    WHERE i_category IN ('Electronics', 'Jewelry', 'Men')\n      AND i_manager_id BETWEEN 91 AND 100\n),\ncross_items AS (\n    SELECT i_item_sk AS ss_item_sk\n    FROM filtered_item,\n    (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id\n     FROM store_sales\n     INNER JOIN filtered_item AS iss ON store_sales.ss_item_sk = iss.i_item_sk\n     INNER JOIN date_dim AS d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk\n     WHERE d1.d_year BETWEEN 1999 AND 2001\n       AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n     INTERSECT\n     SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id\n     FROM catalog_sales\n     INNER JOIN filtered_item AS ics ON catalog_sales.cs_item_sk = ics.i_item_sk\n     INNER JOIN date_dim AS d2 ON catalog_sales.cs_sold_date_sk = d2.d_date_sk\n     WHERE d2.d_year BETWEEN 1999 AND 2001\n       AND catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55\n     INTERSECT\n     SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id\n     FROM web_sales\n     INNER JOIN filtered_item AS iws ON web_sales.ws_item_sk = iws.i_item_sk\n     INNER JOIN date_dim AS d3 ON web_sales.ws_sold_date_sk = d3.d_date_sk\n     WHERE d3.d_year BETWEEN 1999 AND 2001\n       AND web_sales.ws_wholesale_cost BETWEEN 35 AND 55) AS x\n    WHERE filtered_item.i_brand_id = x.brand_id\n      AND filtered_item.i_class_id = x.class_id\n      AND filtered_item.i_category_id = x.category_id\n),\navg_sales AS (\n    SELECT AVG(quantity * list_price) AS average_sales\n    FROM (\n        SELECT ss_quantity AS quantity, ss_list_price AS list_price\n        FROM store_sales\n        INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n        WHERE date_dim.d_year BETWEEN 1999 AND 2001\n          AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n        UNION ALL\n        SELECT cs_quantity AS quantity, cs_list_price AS list_price\n        FROM catalog_sales\n        INNER JOIN date_dim ON catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n        WHERE date_dim.d_year BETWEEN 1999 AND 2001\n          AND catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55\n        UNION ALL\n        SELECT ws_quantity AS quantity, ws_list_price AS list_price\n        FROM web_sales\n        INNER JOIN date_dim ON web_sales.ws_sold_date_sk = date_dim.d_date_sk\n        WHERE date_dim.d_year BETWEEN 1999 AND 2001\n          AND web_sales.ws_wholesale_cost BETWEEN 35 AND 55\n    ) AS x\n)\nSELECT\n    this_year.channel AS ty_channel,\n    this_year.i_brand_id AS ty_brand,\n    this_year.i_class_id AS ty_class,\n    this_year.i_category_id AS ty_category,\n    this_year.sales AS ty_sales,\n    this_year.number_sales AS ty_number_sales,\n    last_year.channel AS ly_channel,\n    last_year.i_brand_id AS ly_brand,\n    last_year.i_class_id AS ly_class,\n    last_year.i_category_id AS ly_category,\n    last_year.sales AS ly_sales,\n    last_year.number_sales AS ly_number_sales\nFROM (\n    SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id,\n           SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales\n    FROM store_sales\n    INNER JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk\n    INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    WHERE store_sales.ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND date_dim.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 2000 AND d_moy = 12 AND d_dom = 20)\n      AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) AS this_year,\n(\n    SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id,\n           SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales\n    FROM store_sales\n    INNER JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk\n    INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    WHERE store_sales.ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND date_dim.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20)\n      AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) AS last_year\nWHERE this_year.i_brand_id = last_year.i_brand_id\n  AND this_year.i_class_id = last_year.i_class_id\n  AND this_year.i_category_id = last_year.i_category_id\nORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p04",
    "strategy": "Date isolation plus explicit joins",
    "hypothesis": "Create filtered_date CTE to reuse date_dim scans across queries and convert comma joins to explicit INNER JOIN. BDA shows date_dim is scanned multiple times. Isolating dates should reduce redundant scans.",
    "target_ir": "CTE with filtered_date, explicit joins in all components",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date AS (\n    SELECT d_date_sk, d_week_seq, d_year, d_moy, d_dom\n    FROM date_dim\n    WHERE d_year BETWEEN 1999 AND 2001\n),\ncross_items AS (\n    SELECT i_item_sk AS ss_item_sk\n    FROM item,\n    (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id\n     FROM store_sales\n     INNER JOIN item AS iss ON store_sales.ss_item_sk = iss.i_item_sk\n     INNER JOIN filtered_date AS d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk\n     WHERE iss.i_category IN ('Electronics', 'Jewelry', 'Men')\n       AND iss.i_manager_id BETWEEN 91 AND 100\n       AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n     INTERSECT\n     SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id\n     FROM catalog_sales\n     INNER JOIN item AS ics ON catalog_sales.cs_item_sk = ics.i_item_sk\n     INNER JOIN filtered_date AS d2 ON catalog_sales.cs_sold_date_sk = d2.d_date_sk\n     WHERE ics.i_category IN ('Electronics', 'Jewelry', 'Men')\n       AND ics.i_manager_id BETWEEN 91 AND 100\n       AND catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55\n     INTERSECT\n     SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id\n     FROM web_sales\n     INNER JOIN item AS iws ON web_sales.ws_item_sk = iws.i_item_sk\n     INNER JOIN filtered_date AS d3 ON web_sales.ws_sold_date_sk = d3.d_date_sk\n     WHERE web_sales.ws_wholesale_cost BETWEEN 35 AND 55\n    ) AS x\n    WHERE i_brand_id = brand_id\n      AND i_class_id = class_id\n      AND i_category_id = category_id\n      AND i_category IN ('Electronics', 'Jewelry', 'Men')\n      AND i_manager_id BETWEEN 91 AND 100\n),\navg_sales AS (\n    SELECT AVG(quantity * list_price) AS average_sales\n    FROM (\n        SELECT ss_quantity AS quantity, ss_list_price AS list_price\n        FROM store_sales\n        INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n        WHERE store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n        UNION ALL\n        SELECT cs_quantity AS quantity, cs_list_price AS list_price\n        FROM catalog_sales\n        INNER JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n        WHERE catalog_sales.cs_wholesale_cost BETWEEN 35 AND 55\n        UNION ALL\n        SELECT ws_quantity AS quantity, ws_list_price AS list_price\n        FROM web_sales\n        INNER JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n        WHERE web_sales.ws_wholesale_cost BETWEEN 35 AND 55\n    ) AS x\n)\nSELECT\n    this_year.channel AS ty_channel,\n    this_year.i_brand_id AS ty_brand,\n    this_year.i_class_id AS ty_class,\n    this_year.i_category_id AS ty_category,\n    this_year.sales AS ty_sales,\n    this_year.number_sales AS ty_number_sales,\n    last_year.channel AS ly_channel,\n    last_year.i_brand_id AS ly_brand,\n    last_year.i_class_id AS ly_class,\n    last_year.i_category_id AS ly_category,\n    last_year.sales AS ly_sales,\n    last_year.number_sales AS ly_number_sales\nFROM (\n    SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id,\n           SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales\n    FROM store_sales\n    INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n    INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n    WHERE store_sales.ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND filtered_date.d_week_seq = (SELECT d_week_seq FROM filtered_date WHERE d_year = 2000 AND d_moy = 12 AND d_dom = 20)\n      AND item.i_category IN ('Electronics', 'Jewelry', 'Men')\n      AND item.i_manager_id BETWEEN 91 AND 100\n      AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) AS this_year,\n(\n    SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id,\n           SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales\n    FROM store_sales\n    INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n    INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n    WHERE store_sales.ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND filtered_date.d_week_seq = (SELECT d_week_seq FROM filtered_date WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20)\n      AND item.i_category IN ('Electronics', 'Jewelry', 'Men')\n      AND item.i_manager_id BETWEEN 91 AND 100\n      AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) AS last_year\nWHERE this_year.i_brand_id = last_year.i_brand_id\n  AND this_year.i_class_id = last_year.i_class_id\n  AND this_year.i_category_id = last_year.i_category_id\nORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\nLIMIT 100;"
        }
      }
    ]
  }
]