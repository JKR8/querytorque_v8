{
  "probe_id": "p01",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Isolate date filtering into a CTE and convert comma joins to explicit JOINs in avg_sales to reduce fact table scan size and enable better hash join planning.",
  "reasoning_trace": [
    "Target comma-join syntax in avg_sales UNION branches causing poor row estimates",
    "Replace repeated date_dim scans with one filtered_date CTE",
    "Explicit JOIN syntax will help planner recognize hash join opportunities"
  ],
  "target_ir": "Filtered date CTE joined explicitly in each UNION branch of avg_sales; no comma joins remain",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_date",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "CTE_Q_S0_avg_sales"},
      "payload": {
        "from_sql": "(select ss_quantity quantity, ss_list_price list_price from store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk where ss_wholesale_cost BETWEEN 35 AND 55 union all select cs_quantity quantity, cs_list_price list_price from catalog_sales JOIN filtered_date ON cs_sold_date_sk = d_date_sk where cs_wholesale_cost BETWEEN 35 AND 55 union all select ws_quantity quantity, ws_list_price list_price from web_sales JOIN filtered_date ON ws_sold_date_sk = d_date_sk where ws_wholesale_cost BETWEEN 35 AND 55) x"
      }
    }
  ]
}