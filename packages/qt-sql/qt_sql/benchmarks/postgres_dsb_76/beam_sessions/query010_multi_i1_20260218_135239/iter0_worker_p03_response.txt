{
  "probe_id": "p0",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Converting comma-separated joins to explicit JOIN syntax and filtering date_dim into a CTE will improve join planning and reduce redundant scans in correlated subqueries.",
  "reasoning_trace": [
    "Assigned transform targets comma-join pattern with correlated subqueries causing repeated scans.",
    "Explicit JOINs and date CTE allow PostgreSQL to better estimate and plan joins.",
    "CTE materialization isolates small date filter set for efficient hash joins.",
    "All original WHERE predicates and output semantics preserved."
  ],
  "target_ir": "Main query uses explicit JOINs; date_dim filtered into CTE for reuse across correlated subqueries.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer c", "customer_address ca", "customer_demographics cd", "filtered_dates"],
        "outputs": [
          "cd_gender",
          "cd_marital_status",
          "cd_education_status",
          "cnt1",
          "cd_purchase_estimate",
          "cnt2",
          "cd_credit_rating",
          "cnt3",
          "cd_dep_count",
          "cnt4",
          "cd_dep_employed_count",
          "cnt5",
          "cd_dep_college_count",
          "cnt6"
        ],
        "changed": true,
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, count(*) cnt1, cd_purchase_estimate, count(*) cnt2, cd_credit_rating, count(*) cnt3, cd_dep_count, count(*) cnt4, cd_dep_employed_count, count(*) cnt5, cd_dep_college_count, count(*) cnt6 FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN filtered_dates fd ON TRUE WHERE ca.ca_county IN ('Grays Harbor County','Kootenai County','Pike County','Thomas County','Uinta County') AND c.c_birth_month IN (1, 5) AND cd.cd_marital_status IN ('U', 'U', 'M') AND cd.cd_education_status IN ('College', 'Primary', '2 yr Degree') AND cd.cd_gender = 'M' AND EXISTS (SELECT 1 FROM store_sales, item, filtered_dates fd1 WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = fd1.d_date_sk AND fd1.d_year = 1999 AND fd1.d_moy BETWEEN 8 AND 8+3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Electronics', 'Music') AND ss_sales_price / ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01 AND i_manager_id BETWEEN 66 AND 75) AND (EXISTS (SELECT 1 FROM web_sales, item, filtered_dates fd2 WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = fd2.d_date_sk AND fd2.d_year = 1999 AND fd2.d_moy BETWEEN 8 AND 8+3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75 AND ws_sales_price / ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01) OR EXISTS (SELECT 1 FROM catalog_sales, item, filtered_dates fd3 WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = fd3.d_date_sk AND fd3.d_year = 1999 AND fd3.d_moy BETWEEN 8 AND 8+3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75 AND cs_sales_price / cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100"
      },
      {
        "node_id": "filtered_dates",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_year", "d_moy"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_year, d_moy FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 8+3"
      }
    ]
  }
}