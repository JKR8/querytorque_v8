[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01,p02",
    "strategy": "Shared dimension CTEs + explicit joins",
    "hypothesis": "Original plan shows repeated date_dim scans and comma joins. Precompute filtered_dates and filtered_items CTEs to eliminate redundant scans. Convert CTE joins to explicit syntax to resolve COMMA_JOIN_WEAKNESS.",
    "target_ir": "CTEs: filtered_dates, filtered_items, then sr/cr/wr_items using explicit joins to dimension CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_dates",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_items",
          "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children','Electronics') AND i_manager_id BETWEEN 15 AND 24"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_sr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(sr_return_quantity) sr_item_qty FROM store_returns JOIN filtered_items fi ON sr_item_sk = fi.i_item_sk JOIN filtered_dates fd ON sr_returned_date_sk = fd.d_date_sk WHERE sr_return_amt / sr_return_quantity between 253 and 282 AND sr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_cr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(cr_return_quantity) cr_item_qty FROM catalog_returns JOIN filtered_items fi ON cr_item_sk = fi.i_item_sk JOIN filtered_dates fd ON cr_returned_date_sk = fd.d_date_sk WHERE cr_return_amount / cr_return_quantity between 253 and 282 AND cr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      },
      {
        "step_id": "s5",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_wr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(wr_return_quantity) wr_item_qty FROM web_returns JOIN filtered_items fi ON wr_item_sk = fi.i_item_sk JOIN filtered_dates fd ON wr_returned_date_sk = fd.d_date_sk WHERE wr_return_amt / wr_return_quantity between 253 and 282 AND wr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p03,p04,p05",
    "strategy": "Explicit join conversion only",
    "hypothesis": "Address COMMA_JOIN_WEAKNESS by converting implicit joins to explicit syntax without shared CTEs. Simpler transformation that may resolve optimizer confusion without materialization risks.",
    "target_ir": "Original CTE structure with explicit INNER JOINs replacing comma joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_sr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(sr_return_quantity) sr_item_qty FROM store_returns INNER JOIN item ON sr_item_sk = i_item_sk INNER JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))) AND i_category IN ('Children','Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity between 253 and 282 AND sr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_cr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(cr_return_quantity) cr_item_qty FROM catalog_returns INNER JOIN item ON cr_item_sk = i_item_sk INNER JOIN date_dim ON cr_returned_date_sk = d_date_sk WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))) AND i_category IN ('Children','Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity between 253 and 282 AND cr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_wr_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, sum(wr_return_quantity) wr_item_qty FROM web_returns INNER JOIN item ON wr_item_sk = i_item_sk INNER JOIN date_dim ON wr_returned_date_sk = d_date_sk WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))) AND i_category IN ('Children','Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity between 253 and 282 AND wr_reason_sk in (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      }
    ]
  }
]