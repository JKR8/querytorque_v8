{
  "dispatch": {
    "dialect": "postgres",
    "importance_stars": 3,
    "probe_count": 12,
    "early_stop": false,
    "equivalence_tier": "unordered",
    "hypothesis": "Cost spine dominated by nested loops and aggregates in CTEs due to repeated date_dim scans and comma joins. Transform families A (filtering) and F (join topology) should reduce redundant scans and improve join planning.",
    "reasoning_trace": [
      "Hotspot: Aggregate in sr_items (3568ms) and cr_items (2466ms) from repeated date_dim scans",
      "Late selectivity: Date filters applied after large scans in CTEs",
      "Comma joins in CTEs prevent optimal join ordering"
    ],
    "cost_spine": ["Aggregate (sr_items) → Nested Loop → Hash Join", "Aggregate (cr_items) → Gather Merge → Nested Loop"],
    "hotspots": [
      {"op": "Aggregate (sr_items)", "why": "Dominant time consumer", "evidence": "time=3568.666ms"},
      {"op": "Aggregate (cr_items)", "why": "Secondary bottleneck", "evidence": "time=2466.142ms"},
      {"op": "Hash Join (sr_items)", "why": "Amplifies row processing", "evidence": "rows=61 → 42 loops"}
    ],
    "do_not_do": ["or_to_union", "materialize_exists"]
  },
  "probe_summary_schema": [
    "probe_id",
    "transform_id",
    "family",
    "status",
    "speedup",
    "expected_explain_delta",
    "ops_used",
    "confidence",
    "exploration",
    "failure_reason",
    "target"
  ],
  "probes": [
    {
      "probe_id": "p01",
      "transform_id": "shared_dimension_multi_channel",
      "family": "A",
      "target": "Create CTE 'filtered_dates' with d_date_sk WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'). Replace all date_dim subqueries in CTEs with JOIN filtered_dates ON {date_sk} = {returned_date_sk}",
      "node_contract": {
        "from_must_include": ["store_returns", "catalog_returns", "web_returns"],
        "where_must_preserve": ["i_category", "i_manager_id", "return_amt/quantity BETWEEN"],
        "output_must_preserve": ["GROUP BY i_item_id", "SUM(return_quantity)"]
      },
      "gates_checked": ["no_or_to_union:PASS", "not_simple_exists:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Plan shows repeated date_dim scans. Pre-materializing dates should eliminate redundant subqueries.",
      "confidence": 0.75,
      "expected_explain_delta": "Eliminate date_dim subqueries; replace with single CTE scan",
      "recommended_patch_ops": ["insert_cte", "replace_where_predicate"]
    },
    {
      "probe_id": "p02",
      "transform_id": "dimension_cte_isolate",
      "family": "A",
      "target": "Create CTE 'filtered_items' with i_item_sk WHERE i_category IN ('Children','Electronics') AND i_manager_id BETWEEN 15 AND 24. Replace all item joins in CTEs with JOIN filtered_items ON {item_sk} = {fact_item_sk}",
      "node_contract": {
        "from_must_include": ["store_returns", "catalog_returns", "web_returns"],
        "where_must_preserve": ["return_amt/quantity BETWEEN", "reason_sk IN"],
        "output_must_preserve": ["GROUP BY i_item_id", "SUM(return_quantity)"]
      },
      "gates_checked": ["no_or_to_union:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Item filters applied late in nested loops. Pre-filtering should reduce fact table joins.",
      "confidence": 0.7,
      "expected_explain_delta": "Replace item scans with CTE; reduce nested loop cardinality",
      "recommended_patch_ops": ["insert_cte", "replace_from"]
    },
    {
      "probe_id": "p03",
      "transform_id": "date_cte_explicit_join",
      "family": "F",
      "target": "In sr_items: Convert comma join to INNER JOIN filtered_dates fd ON sr.sr_returned_date_sk = fd.d_date_sk",
      "node_contract": {
        "from_must_include": ["store_returns sr", "filtered_dates fd"],
        "where_must_preserve": ["sr_reason_sk IN", "sr_return_amt/sr_return_quantity BETWEEN"],
        "output_must_preserve": ["i_item_id", "SUM(sr_return_quantity)"]
      },
      "gates_checked": ["no_left_join_conversion:PASS"],
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "Explicit JOIN syntax enabling better hash join planning",
      "recommended_patch_ops": ["replace_from", "replace_join_condition"]
    },
    {
      "probe_id": "p04",
      "transform_id": "date_cte_explicit_join",
      "family": "F",
      "target": "In cr_items: Convert comma join to INNER JOIN filtered_dates fd ON cr.cr_returned_date_sk = fd.d_date_sk",
      "node_contract": {
        "from_must_include": ["catalog_returns cr", "filtered_dates fd"],
        "where_must_preserve": ["cr_reason_sk IN", "cr_return_amount/cr_return_quantity BETWEEN"],
        "output_must_preserve": ["i_item_id", "SUM(cr_return_quantity)"]
      },
      "gates_checked": ["no_left_join_conversion:PASS"],
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "Explicit JOIN syntax enabling better hash join planning",
      "recommended_patch_ops": ["replace_from", "replace_join_condition"]
    },
    {
      "probe_id": "p05",
      "transform_id": "date_cte_explicit_join",
      "family": "F",
      "target": "In wr_items: Convert comma join to INNER JOIN filtered_dates fd ON wr.wr_returned_date_sk = fd.d_date_sk",
      "node_contract": {
        "from_must_include": ["web_returns wr", "filtered_dates fd"],
        "where_must_preserve": ["wr_reason_sk IN", "wr_return_amt/wr_return_quantity BETWEEN"],
        "output_must_preserve": ["i_item_id", "SUM(wr_return_quantity)"]
      },
      "gates_checked": ["no_left_join_conversion:PASS"],
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "Explicit JOIN syntax enabling better hash join planning",
      "recommended_patch_ops": ["replace_from", "replace_join_condition"]
    },
    {
      "probe_id": "p06",
      "transform_id": "dimension_prefetch_star",
      "family": "F",
      "target": "Pre-materialize filtered_dates and filtered_items. In sr_items: JOIN filtered_dates fd JOIN filtered_items fi",
      "node_contract": {
        "from_must_include": ["filtered_dates fd", "filtered_items fi"],
        "where_must_preserve": ["reason_sk IN", "return_amt/quantity BETWEEN"],
        "output_must_preserve": ["GROUP BY i_item_id", "SUM(return_quantity)"]
      },
      "gates_checked": ["no_double_scans:PASS"],
      "exploration": false,
      "confidence": 0.85,
      "expected_explain_delta": "Tiny hash joins replacing sequential scans; reduced loop amplification",
      "recommended_patch_ops": ["replace_from", "insert_cte"]
    },
    {
      "probe_id": "p07",
      "transform_id": "early_filter_decorrelate",
      "family": "B",
      "target": "In sr_items: Replace date subquery with decorrelated JOIN to filtered_dates",
      "node_contract": {
        "from_must_include": ["store_returns", "filtered_dates"],
        "where_must_preserve": ["i_category", "i_manager_id", "sr_return_amt/sr_return_quantity BETWEEN"],
        "output_must_preserve": ["GROUP BY i_item_id"]
      },
      "gates_checked": ["no_correlated_subquery:PASS"],
      "exploration": false,
      "confidence": 0.8,
      "expected_explain_delta": "Eliminate correlated execution; single CTE scan",
      "recommended_patch_ops": ["replace_where_predicate", "replace_from"]
    },
    {
      "probe_id": "p08",
      "transform_id": "early_filter_decorrelate",
      "family": "B",
      "target": "In cr_items: Replace date subquery with decorrelated JOIN to filtered_dates",
      "node_contract": {
        "from_must_include": ["catalog_returns", "filtered_dates"],
        "where_must_preserve": ["i_category", "i_manager_id", "cr_return_amount/cr_return_quantity BETWEEN"],
        "output_must_preserve": ["GROUP BY i_item_id"]
      },
      "gates_checked": ["no_correlated_subquery:PASS"],
      "exploration": false,
      "confidence": 0.8,
      "expected_explain_delta": "Eliminate correlated execution; single CTE scan",
      "recommended_patch_ops": ["replace_where_predicate", "replace_from"]
    },
    {
      "probe_id": "p09",
      "transform_id": "early_filter_decorrelate",
      "family": "B",
      "target": "In wr_items: Replace date subquery with decorrelated JOIN to filtered_dates",
      "node_contract": {
        "from_must_include": ["web_returns", "filtered_dates"],
        "where_must_preserve": ["i_category", "i_manager_id", "wr_return_amt/wr_return_quantity BETWEEN"],
        "output_must_preserve": ["GROUP BY i_item_id"]
      },
      "gates_checked": ["no_correlated_subquery:PASS"],
      "exploration": false,
      "confidence": 0.8,
      "expected_explain_delta": "Eliminate correlated execution; single CTE scan",
      "recommended_patch_ops": ["replace_where_predicate", "replace_from"]
    },
    {
      "probe_id": "p10",
      "transform_id": "pg_self_join_decomposition",
      "family": "E",
      "target": "Materialize filtered_dates as MATERIALIZED CTE",
      "node_contract": {
        "from_must_include": [],
        "where_must_preserve": ["d_date IN values"],
        "output_must_preserve": ["d_date_sk"]
      },
      "gates_checked": ["cte_materialization_fence:PASS"],
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "CTE scan replacing repeated index scans; reduced I/O",
      "recommended_patch_ops": ["insert_cte"]
    },
    {
      "probe_id": "p11",
      "transform_id": "aggregate_pushdown",
      "family": "C",
      "target": "In sr_items: Pre-aggregate store_returns by sr_item_sk before joining dimensions",
      "node_contract": {
        "from_must_include": ["store_returns"],
        "where_must_preserve": ["sr_reason_sk IN", "sr_return_amt/sr_return_quantity BETWEEN"],
        "output_must_preserve": ["SUM(sr_return_quantity)"]
      },
      "gates_checked": ["aggregate_below_join_safe:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Plan shows high row amplification in nested loops. Early aggregation may reduce join cardinality.",
      "confidence": 0.6,
      "expected_explain_delta": "Aggregate node before join; reduced rows to item/date joins",
      "recommended_patch_ops": ["replace_body"]
    },
    {
      "probe_id": "p12",
      "transform_id": "materialized_dimension_fact_prefilter",
      "family": "F",
      "target": "Create CTE 'prefiltered_sr' joining store_returns with filtered_dates and filtered_items before aggregation",
      "node_contract": {
        "from_must_include": ["store_returns", "filtered_dates", "filtered_items"],
        "where_must_preserve": ["reason_sk IN", "return_amt/quantity BETWEEN"],
        "output_must_preserve": ["sr_item_sk", "sr_return_quantity"]
      },
      "gates_checked": ["no_double_scans:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Non-equi ratio condition may benefit from staged reduction",
      "confidence": 0.65,
      "expected_explain_delta": "Reduced fact scan before ratio calculation; cheaper aggregates",
      "recommended_patch_ops": ["insert_cte", "replace_from"]
    }
  ],
  "dropped": [
    {"transform_id": "or_to_union", "family": "D", "reason": "No OR conditions in predicates"},
    {"transform_id": "intersect_to_exists", "family": "D", "reason": "No INTERSECT operations present"}
  ]
}