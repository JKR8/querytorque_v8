{
  "probe_id": "p01",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Materializing a prefiltered store_returns CTE with explicit JOINs reduces redundant scans and enables better selectivity before aggregation.",
  "reasoning_trace": [
    "Target CTE 'sr_items' with comma-joined tables and nested date_dim subqueries causing repeated scans",
    "Replace comma-join syntax with explicit JOINs and prefilter store_returns with filtered_dates and filtered_items"
  ],
  "target_ir": "CTE prefiltered_sr joins store_returns with filtered date/item dimensions; original ratio logic preserved in main query",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_items",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24"
      }
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "prefiltered_sr",
        "cte_query_sql": "SELECT sr_item_sk, sr_return_quantity FROM store_returns sr JOIN filtered_dates fd ON sr.sr_returned_date_sk = fd.d_date_sk JOIN filtered_items fi ON sr.sr_item_sk = fi.i_item_sk WHERE sr.sr_return_amt / sr.sr_return_quantity BETWEEN 253 AND 282 AND sr.sr_reason_sk IN (7, 18, 19, 22, 36)"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {"by_node_id": "CTE_Q_S0_sr_items"},
      "payload": {
        "from_sql": "prefiltered_sr"
      }
    }
  ]
}