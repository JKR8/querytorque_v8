{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate store_returns by sr_item_sk before joining with item and date_dim to reduce row amplification and improve join performance.",
  "reasoning_trace": [
    "The current sr_items CTE aggregates store_returns after joining with item and date_dim, causing high row amplification.",
    "Pushing the aggregation on sr_item_sk down reduces the number of rows entering the join with dimension tables."
  ],
  "target_ir": "CTE with pre-aggregated store_returns grouped by sr_item_sk, joined with item and date_dim in the main query.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {"by_node_id": "CTE_Q_S0_sr_items"},
      "payload": {
        "sql_fragment": "with preagg_sr as (select sr_item_sk, sum(sr_return_quantity) as sr_item_qty from store_returns where sr_reason_sk in (7, 18, 19, 22, 36) and sr_return_amt / sr_return_quantity between 253 and 282 group by sr_item_sk) select i_item_id item_id, sum(preagg_sr.sr_item_qty) as sr_item_qty from preagg_sr join item on preagg_sr.sr_item_sk = item.i_item_sk join date_dim on d_date in (select d_date from date_dim where d_month_seq in (select d_month_seq from date_dim where d_date in ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))) and d_date_sk = preagg_sr.sr_item_sk where i_category IN ('Children', 'Electronics') and i_manager_id BETWEEN 15 and 24 group by i_item_id"
      }
    }
  ]
}