[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p03",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Original plan shows repeated full scans of date_dim in nested loops. Creating a shared filtered_dates CTE and converting comma joins to explicit joins should enable efficient index usage and eliminate redundant subqueries.",
    "target_ir": "CTE filtered_dates; explicit INNER JOINs replacing comma joins in all fact CTEs; removed date subqueries",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq IN (\n    SELECT d_month_seq\n    FROM date_dim\n    WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')\n  )\n),\nsr_items AS (\n  SELECT i_item_id item_id,\n         sum(sr_return_quantity) sr_item_qty\n  FROM store_returns\n  INNER JOIN item ON store_returns.sr_item_sk = item.i_item_sk\n  INNER JOIN filtered_dates ON store_returns.sr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE item.i_category IN ('Children', 'Electronics')\n    AND item.i_manager_id BETWEEN 15 and 24\n    AND store_returns.sr_return_amt / store_returns.sr_return_quantity BETWEEN 253 AND 282\n    AND store_returns.sr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY item.i_item_id\n),\ncr_items AS (\n  SELECT i_item_id item_id,\n         sum(cr_return_quantity) cr_item_qty\n  FROM catalog_returns\n  INNER JOIN item ON catalog_returns.cr_item_sk = item.i_item_sk\n  INNER JOIN filtered_dates ON catalog_returns.cr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE item.i_category IN ('Children', 'Electronics')\n    AND item.i_manager_id BETWEEN 15 and 24\n    AND catalog_returns.cr_return_amount / catalog_returns.cr_return_quantity BETWEEN 253 AND 282\n    AND catalog_returns.cr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY item.i_item_id\n),\nwr_items AS (\n  SELECT i_item_id item_id,\n         sum(wr_return_quantity) wr_item_qty\n  FROM web_returns\n  INNER JOIN item ON web_returns.wr_item_sk = item.i_item_sk\n  INNER JOIN filtered_dates ON web_returns.wr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE item.i_category IN ('Children', 'Electronics')\n    AND item.i_manager_id BETWEEN 15 and 24\n    AND web_returns.wr_return_amt / web_returns.wr_return_quantity BETWEEN 253 AND 282\n    AND web_returns.wr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY item.i_item_id\n)\nSELECT sr_items.item_id,\n       sr_item_qty,\n       sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 sr_dev,\n       cr_item_qty,\n       cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 cr_dev,\n       wr_item_qty,\n       wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 wr_dev,\n       (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 average\nFROM sr_items,\n     cr_items,\n     wr_items\nWHERE sr_items.item_id=cr_items.item_id\n  AND sr_items.item_id=wr_items.item_id\nORDER BY sr_items.item_id,\n         sr_item_qty\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.82,
    "based_on": "p01,p02",
    "strategy": "Alternative independent pathway",
    "hypothesis": "Nested loops in original plan stem from late filtering of both date_dim and item. Pre-materializing filtered dimensions as CTEs reduces join input sizes and enables better join ordering.",
    "target_ir": "CTEs filtered_dates + filtered_items; explicit joins to both CTEs in fact aggregations; removed dimension conditions from WHERE clauses",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq IN (\n    SELECT d_month_seq\n    FROM date_dim\n    WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')\n  )\n),\nfiltered_items AS (\n  SELECT i_item_sk, i_item_id\n  FROM item\n  WHERE i_category IN ('Children', 'Electronics')\n    AND i_manager_id BETWEEN 15 and 24\n),\nsr_items AS (\n  SELECT filtered_items.i_item_id item_id,\n         sum(sr_return_quantity) sr_item_qty\n  FROM store_returns\n  INNER JOIN filtered_items ON store_returns.sr_item_sk = filtered_items.i_item_sk\n  INNER JOIN filtered_dates ON store_returns.sr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE store_returns.sr_return_amt / store_returns.sr_return_quantity BETWEEN 253 AND 282\n    AND store_returns.sr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY filtered_items.i_item_id\n),\ncr_items AS (\n  SELECT filtered_items.i_item_id item_id,\n         sum(cr_return_quantity) cr_item_qty\n  FROM catalog_returns\n  INNER JOIN filtered_items ON catalog_returns.cr_item_sk = filtered_items.i_item_sk\n  INNER JOIN filtered_dates ON catalog_returns.cr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE catalog_returns.cr_return_amount / catalog_returns.cr_return_quantity BETWEEN 253 AND 282\n    AND catalog_returns.cr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY filtered_items.i_item_id\n),\nwr_items AS (\n  SELECT filtered_items.i_item_id item_id,\n         sum(wr_return_quantity) wr_item_qty\n  FROM web_returns\n  INNER JOIN filtered_items ON web_returns.wr_item_sk = filtered_items.i_item_sk\n  INNER JOIN filtered_dates ON web_returns.wr_returned_date_sk = filtered_dates.d_date_sk\n  WHERE web_returns.wr_return_amt / web_returns.wr_return_quantity BETWEEN 253 AND 282\n    AND web_returns.wr_reason_sk IN (7, 18, 19, 22, 36)\n  GROUP BY filtered_items.i_item_id\n)\nSELECT sr_items.item_id,\n       sr_item_qty,\n       sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 sr_dev,\n       cr_item_qty,\n       cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 cr_dev,\n       wr_item_qty,\n       wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 wr_dev,\n       (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 average\nFROM sr_items,\n     cr_items,\n     wr_items\nWHERE sr_items.item_id=cr_items.item_id\n  AND sr_items.item_id=wr_items.item_id\nORDER BY sr_items.item_id,\n         sr_item_qty\nLIMIT 100;"
        }
      }
    ]
  }
]