{
  "plan_id": "postgres_intersect_to_exists_optimization",
  "dialect": "postgres",
  "description": "Convert INTERSECT set operations in cross_items CTE to EXISTS semi-joins to avoid materialization of large intermediate sets.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_cross_items"
      },
      "payload": {
        "sql_fragment": "SELECT i_item_sk AS ss_item_sk FROM item WHERE i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND EXISTS (SELECT 1 FROM store_sales, date_dim d1 WHERE ss_item_sk = i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 2001 AND ss_wholesale_cost BETWEEN 76 AND 96) AND EXISTS (SELECT 1 FROM catalog_sales, date_dim d2 WHERE cs_item_sk = i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 2001 AND cs_wholesale_cost BETWEEN 76 AND 96) AND EXISTS (SELECT 1 FROM web_sales, date_dim d3 WHERE ws_item_sk = i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND d3.d_year BETWEEN 1999 AND 2001 AND ws_wholesale_cost BETWEEN 76 AND 96)"
      },
      "description": "Replace cross_items CTE body with EXISTS-based logic to eliminate INTERSECT"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "cross_items, avg_sales, (select 'store' channel, i_brand_id,i_class_id,i_category_id ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales from store_sales ,item ,date_dim where ss_item_sk in (select ss_item_sk from cross_items) and ss_item_sk = i_item_sk and ss_sold_date_sk = d_date_sk and d_week_seq = (select d_week_seq from date_dim where d_year = 2000 and d_moy = 12 and d_dom = 12) and i_category IN ('Electronics', 'Shoes', 'Sports') and i_manager_id BETWEEN 42 and 51 and ss_wholesale_cost BETWEEN 76 AND 96 group by i_brand_id,i_class_id,i_category_id having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year, (select 'store' channel, i_brand_id,i_class_id ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales from store_sales ,item ,date_dim where ss_item_sk in (select ss_item_sk from cross_items) and ss_item_sk = i_item_sk and ss_sold_date_sk = d_date_sk and d_week_seq = (select d_week_seq from date_dim where d_year = 1999 and d_moy = 12 and d_dom = 12) and i_category IN ('Electronics', 'Shoes', 'Sports') and ss_wholesale_cost BETWEEN 76 AND 96 and i_manager_id BETWEEN 42 and 51 group by i_brand_id,i_class_id,i_category_id having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year"
      },
      "description": "Update main query FROM clause to reflect optimized CTE"
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "0351671740d55a99"
      },
      "payload": {
        "expr_sql": "this_year.i_brand_id= last_year.i_brand_id and this_year.i_class_id = last_year.i_class_id and this_year.i_category_id = last_year.i_category_id"
      },
      "description": "Retain join condition between this_year and last_year"
    }
  ]
}