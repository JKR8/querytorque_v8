## Role

You are a SQL optimization analyst reviewing benchmark results. Analyze what worked, what failed, and design refined targets for the next round of workers.

Identify the primary bottleneck. Only provide secondary targets if they are distinct and high-confidence. Quality > Quantity.

You will see the original query, execution plan, IR structure, and detailed results from previous rounds.

## Query: query014_multi_i2

**Dialect**: POSTGRES

```sql
with  cross_items as
 (select i_item_sk ss_item_sk
 from item,
 (select iss.i_brand_id brand_id
     ,iss.i_class_id class_id
     ,iss.i_category_id category_id
 from store_sales
     ,item iss
     ,date_dim d1
 where ss_item_sk = iss.i_item_sk
   and ss_sold_date_sk = d1.d_date_sk
   and d1.d_year between 1999 AND 1999 + 2
   and i_category IN ('Electronics', 'Shoes', 'Sports')
   and i_manager_id BETWEEN 42 and 51
   and ss_wholesale_cost BETWEEN 76 AND 96
intersect
 select ics.i_brand_id
     ,ics.i_class_id
     ,ics.i_category_id
 from catalog_sales
     ,item ics
     ,date_dim d2
 where cs_item_sk = ics.i_item_sk
   and cs_sold_date_sk = d2.d_date_sk
   and d2.d_year between 1999 AND 1999 + 2
   and i_category IN ('Electronics', 'Shoes', 'Sports')
   and i_manager_id BETWEEN 42 and 51
   and cs_wholesale_cost BETWEEN 76 AND 96
intersect
 select iws.i_brand_id
     ,iws.i_class_id
     ,iws.i_category_id
 from web_sales
     ,item iws
     ,date_dim d3
 where ws_item_sk = iws.i_item_sk
   and ws_sold_date_sk = d3.d_date_sk
   and ws_wholesale_cost BETWEEN 76 AND 96
   and d3.d_year between 1999 AND 1999 + 2) x
 where i_brand_id = brand_id
      and i_class_id = class_id
      and i_category_id = category_id
      and i_category IN ('Electronics', 'Shoes', 'Sports')
      and i_manager_id BETWEEN 42 and 51
),
 avg_sales as
(select avg(quantity*list_price) average_sales
  from (select ss_quantity quantity
             ,ss_list_price list_price
       from store_sales
           ,date_dim
       where ss_sold_date_sk = d_date_sk
         and d_year between 1999 and 1999 + 2
         and ss_wholesale_cost BETWEEN 76 AND 96
       union all
       select cs_quantity quantity
             ,cs_list_price list_price
       from catalog_sales
           ,date_dim
       where cs_sold_date_sk = d_date_sk
         and d_year between 1999 and 1999 + 2
         and cs_wholesale_cost BETWEEN 76 AND 96
       union all
       select ws_quantity quantity
             ,ws_list_price list_price
       from web_sales
           ,date_dim
       where ws_sold_date_sk = d_date_sk
        and ws_wholesale_cost BETWEEN 76 AND 96
         and d_year between 1999 and 1999 + 2) x)
  select  this_year.channel ty_channel
                           ,this_year.i_brand_id ty_brand
                           ,this_year.i_class_id ty_class
                           ,this_year.i_category_id ty_category
                           ,this_year.sales ty_sales
                           ,this_year.number_sales ty_number_sales
                           ,last_year.channel ly_channel
                           ,last_year.i_brand_id ly_brand
                           ,last_year.i_class_id ly_class
                           ,last_year.i_category_id ly_category
                           ,last_year.sales ly_sales
                           ,last_year.number_sales ly_number_sales
 from
 (select 'store' channel, i_brand_id,i_class_id,i_category_id
        ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales
 from store_sales
     ,item
     ,date_dim
 where ss_item_sk in (select ss_item_sk from cross_items)
   and ss_item_sk = i_item_sk
   and ss_sold_date_sk = d_date_sk
   and d_week_seq = (select d_week_seq
                     from date_dim
                     where d_year = 1999 + 1
                       and d_moy = 12
                       and d_dom = 12)
   and i_category IN ('Electronics', 'Shoes', 'Sports')
   and i_manager_id BETWEEN 42 and 51
   and ss_wholesale_cost BETWEEN 76 AND 96
 group by i_brand_id,i_class_id,i_category_id
 having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year,
 (select 'store' channel, i_brand_id,i_class_id
        ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales
 from store_sales
     ,item
     ,date_dim
 where ss_item_sk in (select ss_item_sk from cross_items)
   and ss_item_sk = i_item_sk
   and ss_sold_date_sk = d_date_sk
   and d_week_seq = (select d_week_seq
                     from date_dim
                     where d_year = 1999
                       and d_moy = 12
                       and d_dom = 12)
   and i_category IN ('Electronics', 'Shoes', 'Sports')
   and ss_wholesale_cost BETWEEN 76 AND 96
   and i_manager_id BETWEEN 42 and 51
group by i_brand_id,i_class_id,i_category_id
 having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year
 where this_year.i_brand_id= last_year.i_brand_id
   and this_year.i_class_id = last_year.i_class_id
   and this_year.i_category_id = last_year.i_category_id
 order by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id
 limit 100;
```


## Current Execution Plan

```
Limit  (rows=55, time=13604.658)
  Hash Join  (rows=4735, time=6646.202)
    Seq Scan on item (item_2)  (rows=4750, time=22.753)
    Hash  (rows=432, time=6622.828)
      Subquery Scan (x)  (rows=435, time=6622.774)
        SetOp  (rows=435, time=6622.753)
          Append  (rows=840725, time=6555.582)
            Result  (rows=436, time=5737.74)
              SetOp  (rows=436, time=5737.717)
                Append  (rows=116507, time=5694.265)
                  Subquery Scan (*SELECT* 2)  (rows=59725, time=3650.129)
                    Gather  (rows=59725, time=3641.744)
                      Nested Loop  (rows=59725, time=3634.266)
                        Nested Loop  (rows=787633, time=2186.749)
                          Index Only Scan on date_dim (d2)  (rows=1096, time=4.064)
                          Index Scan on catalog_sales  (rows=719, time=1.94)
                        Memoize  (rows=0, time=0.002)
                          Index Scan on item (ics)  (rows=0, time=0.011)
                  Subquery Scan (*SELECT* 1)  (rows=56782, time=2034.486)
                    Gather  (rows=56782, time=2029.228)
                      Nested Loop  (rows=18927, time=1704.871)
                        Nested Loop  (rows=798538, time=996.232)
                          Index Only Scan on date_dim (d1)  (rows=365, time=0.858)
                          Index Only Scan on store_sales (store_sales_2)  (rows=2186, time=2.614)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (iss)  (rows=0, time=0.005)
            Subquery Scan (*SELECT* 3)  (rows=840289, time=781.833)
              Gather  (rows=840289, time=729.31)
                Nested Loop  (rows=280096, time=689.832)
                  Nested Loop  (rows=280096, time=329.834)
                    Index Only Scan on date_dim (d3)  (rows=365, time=0.913)
                    Index Scan on web_sales  (rows=767, time=0.861)
                  Memoize  (rows=1, time=0.001)
                    Index Scan on item (iws)  (rows=1, time=0.003)
  Aggregate  (rows=1, time=2044.731)
    Gather  (rows=3, time=2044.708)
      Aggregate  (rows=1, time=1783.638)
        Append  (rows=1341178, time=1609.766)
          Nested Loop  (rows=798538, time=830.86)
            Index Only Scan on date_dim (date_dim_2)  (rows=365, time=0.785)
            Index Only Scan on store_sales (store_sales_3)  (rows=2186, time=2.172)
          Nested Loop  (rows=393816, time=655.686)
            Index Only Scan on date_dim (date_dim_3)  (rows=548, time=1.006)
            Index Scan on catalog_sales (catalog_sales_1)  (rows=719, time=1.154)
          Nested Loop  (rows=840289, time=870.432)
            Index Only Scan on date_dim (date_dim_4)  (rows=1096, time=1.71)
            Index Scan on web_sales (web_sales_1)  (rows=767, time=0.75)
  Sort  (rows=55, time=13604.449)
    Nested Loop  (rows=55, time=13604.4)
      Aggregate  (rows=194, time=11089.622)
        Index Scan on date_dim (date_dim_5)  (rows=1, time=0.018)
        CTE Scan (avg_sales)  (rows=1, time=2044.705)
        Sort  (rows=751, time=9044.707)
          Nested Loop  (rows=751, time=9043.59)
            Nested Loop  (rows=100842, time=8935.808)
              Nested Loop  (rows=4735, time=6684.33)
                Aggregate  (rows=4735, time=6650.739)
                  CTE Scan (cross_items)  (rows=4735, time=6646.541)
                Index Scan on item  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales  (rows=21, time=0.472)
                Bitmap Index Scan  (rows=143, time=0.012)
            Index Scan on date_dim  (rows=0, time=0.001)
      Aggregate  (rows=78, time=12.961)
        Index Scan on date_dim (date_dim_6)  (rows=1, time=0.022)
        CTE Scan (avg_sales_1)  (rows=1, time=0.002)
        Sort  (rows=244, time=12.896)
          Nested Loop  (rows=274, time=2500.19)
            Nested Loop  (rows=100842, time=2382.395)
              Nested Loop  (rows=4735, time=43.759)
                Aggregate  (rows=4735, time=4.594)
                  CTE Scan (cross_items_1)  (rows=4735, time=0.243)
                Index Scan on item (item_1)  (rows=1, time=0.008)
              Bitmap Heap Scan on store_sales (store_sales_1)  (rows=21, time=0.491)
                Bitmap Index Scan  (rows=143, time=0.012)
            Index Scan on date_dim (date_dim_1)  (rows=0, time=0.001)
```


## IR Structure (for patch targeting)

```
S0 [SELECT]
  CTE: cross_items  (via CTE_Q_S0_cross_items)
    FROM: item, (subquery) x
    WHERE [888d3c332566b19b]: i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id AND i_category IN...
  CTE: avg_sales  (via CTE_Q_S0_avg_sales)
    FROM: (subquery) x
  MAIN QUERY (via Q_S0)
    FROM: (subquery) this_year, (subquery) last_year
    WHERE [0351671740d55a99]: this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND t...
    ORDER BY: this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id

Patch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree
Target: by_node_id (statement, e.g. "S0") + by_anchor_hash (expression)
```

**Note**: Use `by_node_id` (e.g., "S0") and `by_anchor_hash` (16-char hex) from map above to target patch operations.


## Optimization Families

Review the 6 families below. Each has a proven gold example.

Choose up to **4 most relevant families** for this query based on:
- Query structure (CTEs, subqueries, joins, aggregations, set operations)
- Execution plan signals (WHERE placement, repeated scans, correlated subqueries)
- Problem signature (cardinality estimation errors, loops vs sets, filter ordering)



### Family A: Early Filtering (Predicate Pushback)
**Description**: Push small filters into CTEs early, reduce row count before expensive operations
**Speedup Range**: 1.3â€“4.0x (~35% of all wins)
**Use When**:
  1. Late WHERE filters on dimension tables
  2. Cascading CTEs with filters applied downstream
  3. Expensive joins after filters could be pushed earlier

**Gold Example**: `pg_date_cte_explicit_join` (2.28x)



### Family B: Decorrelation (Sets Over Loops)
**Description**: Convert correlated subqueries to standalone CTEs with GROUP BY, eliminate per-row re-execution
**Speedup Range**: 2.4â€“2.9x (~15% of all wins)
**Use When**:
  1. Correlated subqueries in WHERE clause
  2. Scalar aggregates computed per outer row
  3. DELIM_SCAN in execution plan (indicates correlation)

**Gold Example**: `pg_shared_scan_decorrelate` (8043.91x (timeout rescue))



### Family C: Aggregation Pushdown (Minimize Rows Touched)
**Description**: Aggregate before expensive joins when GROUP BY keys âŠ‡ join keys, reduce intermediate sizes
**Speedup Range**: 1.3â€“15.3x (~5% of all wins (high variance))
**Use When**:
  1. GROUP BY happens after large joins
  2. GROUP BY keys are subset of join keys
  3. Intermediate result size >> final result size

**Gold Example**: `pg_materialized_dimension_fact_prefilter` (12.07x (V2 DSB SF10, was 2.68x in V1))



### Family D: Set Operation Optimization (Sets Over Loops)
**Description**: Replace INTERSECT/UNION-based patterns with EXISTS/NOT EXISTS, avoid full materialization
**Speedup Range**: 1.7â€“2.7x (~8% of all wins)
**Use When**:
  1. INTERSECT patterns between large sets
  2. UNION ALL with duplicate elimination
  3. Set operations materializing full intermediate results

**Gold Example**: `pg_intersect_to_exists` (1.78x)



### Family E: Materialization / Prefetch (Don't Repeat Work)
**Description**: Extract repeated scans or pre-compute intermediate results for reuse across multiple consumers
**Speedup Range**: 1.3â€“6.2x (~18% of all wins)
**Use When**:
  1. Repeated scans of same table with different filters
  2. Dimension filters applied independently multiple times
  3. CTE referenced multiple times with implicit re-evaluation

**Gold Example**: `multi_dimension_prefetch` (2.71x)



### Family F: Join Transform (Right Shape First)
**Description**: Restructure join topology: convert comma joins to explicit INNER JOIN, optimize join order, eliminate self-joins via single-pass aggregation
**Speedup Range**: 1.8â€“8.6x (~19% of all wins)
**Use When**:
  1. Comma-separated joins (implicit cross joins) in FROM clause
  2. Self-joins scanning same table multiple times
  3. Dimension-fact join order suboptimal for predicate pushdown

**Gold Example**: `pg_explicit_join_materialized` (8.56x)



## Optimization History

### History â€” All Prior Patches

| Iter | Patch | Family | Transform | Speedup | Status | Orig ms | Patch ms | Error (summary) |
|------|-------|--------|-----------|---------|--------|---------|----------|-----------------|
| 0 | t1 | D | intersect_to_exists | â€” | FAIL | â€” | â€” | Step s1 failed: No target found for repl |
| 0 | t3 | A | predicate_push_into_setop | â€” | FAIL | â€” | â€” | Step s1 failed: Cannot parse body sql_fr |
| 0 | t2 | F | join_transform_combine_subqueries | â€” | FAIL | â€” | â€” | Tier-1 structural: LITERAL MISMATCH: Ori |
| 0 | syn_w2 | B | decorrelate | â€” | FAIL | â€” | â€” | Step s4 failed: No target found for repl |



### Latest Iteration 0 â€” Detailed Results

#### Race Results

| Patch | Family | Transform | Speedup | Status | Orig ms | Patch ms | Semantic | Error |
|-------|--------|-----------|---------|--------|---------|----------|----------|-------|
| t1 | D | intersect_to_exists | â€” | FAIL | â€” | â€” | FAIL | Step s1 failed: No target found for replace_body step s1 |
| t3 | A | predicate_push_into_setop | â€” | FAIL | â€” | â€” | FAIL | Step s1 failed: Cannot parse body sql_fragment: Failed to parse any statement fo |
| t2 | F | join_transform_combine_subqueries | â€” | FAIL | â€” | â€” | FAIL | Tier-1 structural: LITERAL MISMATCH: Original literals missing from rewrite â€” st |
| syn_w2 | B | decorrelate | â€” | FAIL | â€” | â€” | FAIL | Step s4 failed: No target found for replace_from step s4 |

#### Patched SQL

**t1** (Family D): FAILED to apply â€” Step s1 failed: No target found for replace_body step s1

**t3** (Family A): FAILED to apply â€” Step s1 failed: Cannot parse body sql_fragment: Failed to parse any statement following CTE. Line 1, Col: 1311.
   category_id and i_category IN ('Electronics', 'Shoes', 'Sports') and i_manager_id BETWEEN 42 and 51[4m)[0m

**t2 (Family F, join_transform_combine_subqueries):**
```sql
WITH cross_items AS (SELECT i_item_sk AS ss_item_sk FROM item, (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id FROM store_sales, item AS iss, date_dim AS d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND ss_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, item AS ics, date_dim AS d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND cs_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, item AS iws, date_dim AS d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96 AND d3.d_year BETWEEN 1999 AND 1999 + 2) AS x WHERE i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 1999 + 2 AND ss_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 1999 + 2 AND cs_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, date_dim WHERE ws_sold_date_sk = d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96 AND d_year BETWEEN 1999 AND 1999 + 2) AS x), date_weeks AS (SELECT d_week_seq, d_year FROM date_dim WHERE (d_year = 1999 AND d_moy = 12 AND d_dom = 12) OR (d_year = 2000 AND d_moy = 12 AND d_dom = 12)), sales_combined AS (SELECT i_brand_id, i_class_id, i_category_id, d_week_seq, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales INNER JOIN item ON ss_item_sk = i_item_sk INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d_week_seq IN (SELECT d_week_seq FROM date_weeks) AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_brand_id, i_class_id, i_category_id, d_week_seq) SELECT this_year.channel AS ty_channel, this_year.i_brand_id AS ty_brand, this_year.i_class_id AS ty_class, this_year.i_category_id AS ty_category, this_year.sales AS ty_sales, this_year.number_sales AS ty_number_sales, last_year.channel AS ly_channel, last_year.i_brand_id AS ly_brand, last_year.i_class_id AS ly_class, last_year.i_category_id AS ly_category, last_year.sales AS ly_sales, last_year.number_sales AS ly_number_sales FROM (SELECT * FROM sales_combined WHERE d_week_seq = (SELECT d_week_seq FROM date_weeks WHERE d_year = 2000)) AS this_year, (SELECT * FROM sales_combined WHERE d_week_seq = (SELECT d_week_seq FROM date_weeks WHERE d_year = 1999)) AS last_year WHERE this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND this_year.i_category_id = last_year.i_category_id AND this_year.sales > (SELECT average_sales FROM avg_sales) AND last_year.sales > (SELECT average_sales FROM avg_sales) ORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id LIMIT 100;
```

**syn_w2** (Family B): FAILED to apply â€” Step s4 failed: No target found for replace_from step s4

#### Execution Plans

**Original EXPLAIN:**
```
Limit  (rows=55, time=13604.658)
  Hash Join  (rows=4735, time=6646.202)
    Seq Scan on item (item_2)  (rows=4750, time=22.753)
    Hash  (rows=432, time=6622.828)
      Subquery Scan (x)  (rows=435, time=6622.774)
        SetOp  (rows=435, time=6622.753)
          Append  (rows=840725, time=6555.582)
            Result  (rows=436, time=5737.74)
              SetOp  (rows=436, time=5737.717)
                Append  (rows=116507, time=5694.265)
                  Subquery Scan (*SELECT* 2)  (rows=59725, time=3650.129)
                    Gather  (rows=59725, time=3641.744)
                      Nested Loop  (rows=59725, time=3634.266)
                        Nested Loop  (rows=787633, time=2186.749)
                          Index Only Scan on date_dim (d2)  (rows=1096, time=4.064)
                          Index Scan on catalog_sales  (rows=719, time=1.94)
                        Memoize  (rows=0, time=0.002)
                          Index Scan on item (ics)  (rows=0, time=0.011)
                  Subquery Scan (*SELECT* 1)  (rows=56782, time=2034.486)
                    Gather  (rows=56782, time=2029.228)
                      Nested Loop  (rows=18927, time=1704.871)
                        Nested Loop  (rows=798538, time=996.232)
                          Index Only Scan on date_dim (d1)  (rows=365, time=0.858)
                          Index Only Scan on store_sales (store_sales_2)  (rows=2186, time=2.614)
                        Memoize  (rows=0, time=0.001)
                          Index Scan on item (iss)  (rows=0, time=0.005)
            Subquery Scan (*SELECT* 3)  (rows=840289, time=781.833)
              Gather  (rows=840289, time=729.31)
                Nested Loop  (rows=280096, time=689.832)
                  Nested Loop  (rows=280096, time=329.834)
                    Index Only Scan on date_dim (d3)  (rows=365, time=0.913)
                    Index Scan on web_sales  (rows=767, time=0.861)
                  Memoize  (rows=1, time=0.001)
                    Index Scan on item (iws)  (rows=1, time=0.003)
  Aggregate  (rows=1, time=2044.731)
    Gather  (rows=3, time=2044.708)
      Aggregate  (rows=1, time=1783.638)
        Append  (rows=1341178, time=1609.766)
          Nested Loop  (rows=798538, time=830.86)
            Index Only Scan on date_dim (date_dim_2)  (rows=365, time=0.785)
            Index Only Scan on store_sales (store_sales_3)  (rows=2186, time=2.172)
          Nested Loop  (rows=393816, time=655.686)
            Index Only Scan on date_dim (date_dim_3)  (rows=548, time=1.006)
            Index Scan on catalog_sales (catalog_sales_1)  (rows=719, time=1.154)
          Nested Loop  (rows=840289, time=870.432)
            Index Only Scan on date_dim (date_dim_4)  (rows=1096, time=1.71)
            Index Scan on web_sales (web_sales_1)  (rows=767, time=0.75)
  Sort  (rows=55, time=13604.449)
    Nested Loop  (rows=55, time=13604.4)
      Aggregate  (rows=194, time=11089.622)
        Index Scan on date_dim (date_dim_5)  (rows=1, time=0.018)
        CTE Scan (avg_sales)  (rows=1, time=2044.705)
        Sort  (rows=751, time=9044.707)
          Nested Loop  (rows=751, time=9043.59)
            Nested Loop  (rows=100842, time=8935.808)
              Nested Loop  (rows=4735, time=6684.33)
                Aggregate  (rows=4735, time=6650.739)
                  CTE Scan (cross_items)  (rows=4735, time=6646.541)
                Index Scan on item  (rows=1, time=0.007)
              Bitmap Heap Scan on store_sales  (rows=21, time=0.472)
                Bitmap Index Scan  (rows=143, time=0.012)
            Index Scan on date_dim  (rows=0, time=0.001)
      Aggregate  (rows=78, time=12.961)
        Index Scan on date_dim (date_dim_6)  (rows=1, time=0.022)
        CTE Scan (avg_sales_1)  (rows=1, time=0.002)
        Sort  (rows=244, time=12.896)
          Nested Loop  (rows=274, time=2500.19)
            Nested Loop  (rows=100842, time=2382.395)
              Nested Loop  (rows=4735, time=43.759)
                Aggregate  (rows=4735, time=4.594)
                  CTE Scan (cross_items_1)  (rows=4735, time=0.243)
                Index Scan on item (item_1)  (rows=1, time=0.008)
              Bitmap Heap Scan on store_sales (store_sales_1)  (rows=21, time=0.491)
                Bitmap Index Scan  (rows=143, time=0.012)
            Index Scan on date_dim (date_dim_1)  (rows=0, time=0.001)
```

#### Error Details

- **t1** (FAIL): Step s1 failed: No target found for replace_body step s1
- **t3** (FAIL): Step s1 failed: Cannot parse body sql_fragment: Failed to parse any statement following CTE. Line 1, Col: 1311.
   category_id and i_category IN ('Electronics', 'Shoes', 'Sports') and i_manager_id BETWEEN 42 and 51[4m)[0m
- **t2** (FAIL): Tier-1 structural: LITERAL MISMATCH: Original literals missing from rewrite â€” strings: ['store']. The rewrite changed filter values instead of preserving them.
- **syn_w2** (FAIL): Step s4 failed: No target found for replace_from step s4


## Your Task â€” Snipe Round 1


Results from latest iteration: **4 FAIL**.

Follow this protocol exactly.

### Step 1 â€” Compare EXPLAIN Plans

For each patch above, compare its EXPLAIN plan to the Original EXPLAIN.

For each **WIN**, answer:
- QUOTE the operator line(s) from the original that got cheaper or were eliminated. Give the exact operator name, time, and row count from the plan text above.
- What structural SQL change caused that operator improvement?
- What is the **most expensive remaining operator** in this winner's plan? QUOTE its line (name, time, rows).

For each **FAIL/NEUTRAL/REGRESSION**:
- QUOTE the operator(s) that got MORE expensive vs the original.
- Why did the structural change backfire?

Then classify winners as REDUNDANT (same core structural change, same operators improved) or COMPLEMENTARY (different operators improved, different structural changes).

### Step 2 â€” Design Targets by Combining Strategies

Start from the **best winner's SQL** as your baseline.

**CRITICAL**: Do NOT invent new hypotheses about row counts or selectivity. Every claim about rows, times, or costs MUST be a direct quote from an EXPLAIN plan above. If a number is not in the plans, you do not know it.

**CRITICAL**: Do NOT spend targets on optimizer-equivalent rewrites (UNIONâ†”UNION ALL, JOINâ†”WHERE IN, CTEâ†”subquery). These produce identical plans. Focus on changes that **eliminate operators** or **reduce input rows to expensive operators** as shown in the plans.

Design up to 4 targets, prioritized:

1. **Combination** (primary if complementary winners exist): Take the best winner's SQL. Layer on the structural change from a complementary winner that addresses a DIFFERENT expensive operator. Cite both operators by name from the EXPLAIN plans.
2. **Refinement**: Take the best winner's SQL. Target its most expensive remaining operator (quoted in Step 1). Design a structural change that reduces input rows to that operator. CITE the operator and its current row count from the plan.
3. **Rescue** (if a failed patch had a sound structural idea): Fix the implementation while preserving the best winner's gains.
4. **Novel**: A new structural approach that targets the most expensive remaining operator. Cite the operator from the plan.

**Combined families**: You MAY combine families in a single target (e.g. "A+B", "B+E", "A+F"). The worker will receive gold examples from ALL referenced families.

Output up to 4 targets. Same JSON format:

```json
[
  {
    "family": "A+B",
    "transform": "early_filter_then_decorrelate",
    "target_id": "t1",
    "relevance_score": 0.95,
    "hypothesis": "...",
    "target_ir": "...",
    "recommended_examples": ["date_cte_isolate", "shared_scan_decorrelate"]
  }
]
```

Output up to 4 targets. Fewer strong targets beat padding with weak ones.
