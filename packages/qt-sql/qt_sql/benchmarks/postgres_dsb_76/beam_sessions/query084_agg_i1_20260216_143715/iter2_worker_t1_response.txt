{
  "plan_id": "wildcard_postgres_early_filter_explicit_join",
  "dialect": "postgres",
  "description": "Push selective filters into CTEs to reduce customer table scan size and convert comma joins to explicit JOINs for better PostgreSQL join planning. This targets elimination of the full customer scan (250K rows) by filtering address and income bands early.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_addresses",
        "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Jackson'"
      },
      "description": "Insert CTE 'filtered_addresses' to pre-filter customer addresses by city"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_income_bands",
        "cte_query_sql": "SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 23567 AND ib_upper_bound <= 23567 + 50000"
      },
      "description": "Insert CTE 'filtered_income_bands' to pre-filter income bands"
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "customer JOIN filtered_addresses ON c_current_addr_sk = ca_address_sk JOIN customer_demographics ON cd_demo_sk = c_current_cdemo_sk JOIN household_demographics ON hd_demo_sk = c_current_hdemo_sk JOIN filtered_income_bands ON hd_income_band_sk = ib_income_band_sk JOIN store_returns ON sr_cdemo_sk = cd_demo_sk"
      },
      "description": "Replace comma-join FROM with explicit JOINs using filtered CTEs"
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "bfc6729fe553d3e9"
      },
      "payload": {
        "expr_sql": "TRUE"
      },
      "description": "Clear original WHERE clause as conditions are now in JOINs/CTEs"
    }
  ]
}