[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Decorrelation + explicit joins",
    "hypothesis": "Eliminate correlated subquery by precomputing store averages in CTE. Convert comma joins to explicit INNER JOINs to enable better optimization. Original plan showed nested loop re-executing aggregate per row (282k ms).",
    "target_ir": "CTE for aggregates + CTE for store thresholds + explicit joins with filtered dimensions",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 INNER JOIN store ON s_store_sk = ctr1.ctr_store_sk INNER JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk INNER JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk INNER JOIN store_avg_return sar ON ctr1.ctr_store_sk = sar.ctr_store_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 AND ctr1.ctr_total_return > sar.threshold ORDER BY c_customer_id LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p01,p02,p04,p05,p06",
    "strategy": "Decorrelation + explicit joins + dimension prefiltering",
    "hypothesis": "Precompute store averages and add filtered dimension CTEs to reduce join cardinality early. Targets late-applied dimension filters in original plan and comma-join limitations.",
    "target_ir": "CTE aggregates + store thresholds + filtered dimension CTEs + explicit star-join",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY ctr_store_sk), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('IL', 'KY', 'TX')), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk FROM customer WHERE c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971), filtered_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F') SELECT c_customer_id FROM customer_total_return ctr1 INNER JOIN filtered_store fs ON ctr1.ctr_store_sk = fs.s_store_sk INNER JOIN filtered_customer fc ON ctr1.ctr_customer_sk = fc.c_customer_sk INNER JOIN filtered_demographics fd ON fc.c_current_cdemo_sk = fd.cd_demo_sk INNER JOIN store_avg_return sar ON ctr1.ctr_store_sk = sar.ctr_store_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND ctr1.ctr_total_return > sar.threshold ORDER BY c_customer_id LIMIT 100;"
        }
      }
    ]
  }
]