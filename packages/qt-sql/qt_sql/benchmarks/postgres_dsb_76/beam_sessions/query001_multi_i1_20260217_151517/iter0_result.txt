{
  "iteration": 0,
  "n_api_calls": 21,
  "beam_cost_usd": 0.0803029,
  "beam_cost_priced_calls": 21,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 100533,
    "completion_tokens": 27121,
    "total_tokens": 127654,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 37760
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.9,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_stores AS (SELECT s_store_sk FROM store WHERE s_state IN ('IL', 'KY', 'TX')) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN filtered_stores AS fs ON fs.s_store_sk = ctr1.ctr_store_sk, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IL', 'KY', 'TX') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Pre-filter store table with s_state IN (...) via CTE"
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "date_cte_isolate",
      "relevance_score": 0.85,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Failed to parse/apply PatchPlan",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "Materialize date_dim filter into CTE before store_returns join"
    },
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.87,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F') SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk JOIN filtered_demographics AS fd ON c.c_current_cdemo_sk = fd.cd_demo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Pre-filter customer_demographics via CTE with cd_* conditions"
    },
    {
      "patch_id": "p06",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.89,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_customers AS (SELECT c_customer_sk FROM customer WHERE c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN filtered_customers AS fc ON fc.c_customer_sk = ctr1.ctr_customer_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c_current_cdemo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Pre-filter customer via CTE with birth month/year"
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.92,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), avg_threshold AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN avg_threshold ON avg_threshold.ctr_store_sk = ctr1.ctr_store_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Convert correlated subquery to MATERIALIZED CTE with group by ctr_store_sk"
    },
    {
      "patch_id": "p11",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.85,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_store_returns AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_thresholds AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM filtered_store_returns GROUP BY ctr_store_sk) SELECT c_customer_id FROM filtered_store_returns AS ctr1 JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN store_thresholds AS st ON ctr1.ctr_store_sk = st.ctr_store_sk WHERE ctr1.ctr_total_return > st.threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Combine dimension filters with decorrelation in single CTE chain"
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.88,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('IL', 'KY', 'TX')), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk FROM customer WHERE c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971), filtered_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F') SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN filtered_store AS fs ON fs.s_store_sk = ctr1.ctr_store_sk JOIN filtered_customer AS fc ON fc.c_customer_sk = ctr1.ctr_customer_sk JOIN filtered_demographics AS fd ON fd.cd_demo_sk = fc.c_current_cdemo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Convert comma joins to explicit INNER JOINs with optimized order"
    },
    {
      "patch_id": "p07",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.8,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_store_returns AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns WHERE sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_avg_return AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return_threshold FROM filtered_store_returns GROUP BY ctr_store_sk) SELECT c_customer_id FROM filtered_store_returns AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics AS cd ON c_current_cdemo_sk = cd_demo_sk JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk WHERE ctr1.ctr_total_return > sar.avg_return_threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Materialize customer_total_return with filters as separate CTE"
    },
    {
      "patch_id": "p13",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.68,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Failed to parse/apply PatchPlan",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "Reuse date_dim CTE across both CTE and main query"
    },
    {
      "patch_id": "p10",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_store_returns AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SR_RETURN_AMT_INC_TAX FROM store_returns AS sr JOIN filtered_date AS fd ON sr.sr_returned_date_sk = fd.d_date_sk WHERE sr_return_amt / sr_return_quantity BETWEEN 108 AND 167) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics AS cd ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Materialize both date_dim and store_returns filters before main join"
    },
    {
      "patch_id": "p12",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.7,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_with_avg AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return, AVG(SR_RETURN_AMT_INC_TAX) OVER (PARTITION BY sr_store_sk) AS ctr_avg_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM ctr_with_avg AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics AS cd ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_total_return > ctr1.ctr_avg_return * 1.2 AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Compute AVG(ctr_total_return) in same scan as main aggregates"
    },
    {
      "patch_id": "p08",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.65,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), agg_store_returns AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns WHERE sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM agg_store_returns AS ctr1 JOIN date_dim ON sr_returned_date_sk = d_date_sk JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE d_year = 2002 AND ctr1.ctr_total_return > (SELECT AVG(ctr2.ctr_total_return) * 1.2 FROM agg_store_returns AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s.s_state IN ('IL', 'KY', 'TX') AND cd.cd_marital_status IN ('M', 'M') AND cd.cd_education_status IN ('Advanced Degree', 'College') AND cd.cd_gender = 'F' AND c.c_birth_month = 2 AND c.c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Pre-aggregate store_returns before joining with date_dim"
    },
    {
      "patch_id": "p14",
      "family": "D",
      "transform": "union_cte_split",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: COLUMN REF MISMATCH: Original columns missing from rewrite \u2014 ['ctr_reason_sk']. The rewrite references different table columns.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_filtered_43_46 AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 AND sr_reason_sk BETWEEN 43 AND 46 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_avg_base AS (SELECT sr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY sr_store_sk) SELECT c_customer_id FROM ctr_filtered_43_46 AS ctr1 JOIN store AS s ON s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics AS cd ON c_current_cdemo_sk = cd_demo_sk JOIN ctr_avg_base AS avg_base ON ctr1.ctr_store_sk = avg_base.sr_store_sk WHERE ctr1.ctr_total_return > avg_base.threshold AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Separate ctr1 and ctr2 CTEs with different reason_sk filters"
    },
    {
      "patch_id": "p09",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), valid_return_reasons AS (SELECT DISTINCT sr_reason_sk FROM store_returns WHERE sr_reason_sk BETWEEN 43 AND 46), filtered_store_returns AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns AS sr JOIN date_dim AS dd ON sr.sr_returned_date_sk = dd.d_date_sk JOIN valid_return_reasons AS vrr ON sr.sr_reason_sk = vrr.sr_reason_sk WHERE dd.d_year = 2002 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), avg_return_by_store AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold FROM filtered_store_returns GROUP BY ctr_store_sk) SELECT c_customer_id FROM filtered_store_returns AS ctr1 JOIN store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN avg_return_by_store AS a ON ctr1.ctr_store_sk = a.ctr_store_sk WHERE ctr1.ctr_total_return > a.threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s.s_state IN ('IL', 'KY', 'TX') AND cd.cd_marital_status IN ('M', 'M') AND cd.cd_education_status IN ('Advanced Degree', 'College') AND cd.cd_gender = 'F' AND c.c_birth_month = 2 AND c.c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "Stage joins via filtered dimension CTEs before fact scan"
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 numbers: ['1.2']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 INNER JOIN store ON s_store_sk = ctr1.ctr_store_sk INNER JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk INNER JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk INNER JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 AND ctr1.ctr_total_return > sar.threshold ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 strings: ['Advanced Degree', 'College', 'IL', 'KY', 'TX'], numbers: ['1.2', '1965.0', '1971.0', '2.0']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 INNER JOIN filtered_store AS fs ON ctr1.ctr_store_sk = fs.s_store_sk INNER JOIN filtered_customer AS fc ON ctr1.ctr_customer_sk = fc.c_customer_sk INNER JOIN filtered_demographics AS fd ON fc.c_current_cdemo_sk = fd.cd_demo_sk INNER JOIN store_avg_return AS sar ON ctr1.ctr_store_sk = sar.ctr_store_sk WHERE ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND ctr1.ctr_total_return > sar.threshold ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p1",
      "family": "decorrelate",
      "transform": "inline_materialized_join",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 numbers: ['1.2']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store ON s_store_sk = ctr1.ctr_store_sk JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN store_avg_threshold AS sat ON ctr1.ctr_store_sk = sat.ctr_store_sk WHERE ctr1.ctr_total_return > sat.threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "prefilter",
      "transform": "dimension_cte_chain",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 strings: ['Advanced Degree', 'College', 'IL', 'KY', 'TX'], numbers: ['1.2', '1965.0', '1971.0', '2.0']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN f_store ON f_store.s_store_sk = ctr1.ctr_store_sk JOIN f_customer ON f_customer.c_customer_sk = ctr1.ctr_customer_sk JOIN f_demographics ON f_demographics.cd_demo_sk = f_customer.c_current_cdemo_sk JOIN store_avg_threshold AS sat ON ctr1.ctr_store_sk = sat.ctr_store_sk WHERE ctr1.ctr_total_return > sat.threshold AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {}
}