[
  {
    "plan_id": "snipe_p1",
    "family": "decorrelate",
    "transform": "inline_materialized_join",
    "hypothesis": "Original plan shows nested loop re-executing correlated subquery per row (282k ms). Precomputing store averages in CTE eliminates correlation. EXPLAIN should replace nested loop with hash join to pre-aggregated CTE.",
    "target_ir": "Two CTEs: customer_total_return and store_avg_threshold. Main query joins CTEs and dimensions with explicit JOIN syntax.",
    "dialect": "postgres",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (\n  SELECT sr_customer_sk AS ctr_customer_sk,\n    sr_store_sk AS ctr_store_sk,\n    sr_reason_sk AS ctr_reason_sk,\n    SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return\n  FROM store_returns, date_dim\n  WHERE sr_returned_date_sk = d_date_sk\n    AND d_year = 2002\n    AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167\n  GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk\n),\nstore_avg_threshold AS (\n  SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold\n  FROM customer_total_return\n  GROUP BY ctr_store_sk\n)\nSELECT c_customer_id\nFROM customer_total_return ctr1\nJOIN store ON s_store_sk = ctr1.ctr_store_sk\nJOIN customer ON ctr1.ctr_customer_sk = c_customer_sk\nJOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk\nJOIN store_avg_threshold sat ON ctr1.ctr_store_sk = sat.ctr_store_sk\nWHERE ctr1.ctr_total_return > sat.threshold\n  AND ctr1.ctr_reason_sk BETWEEN 43 AND 46\n  AND s_state IN ('IL', 'KY', 'TX')\n  AND cd_marital_status IN ('M', 'M')\n  AND cd_education_status IN ('Advanced Degree', 'College')\n  AND cd_gender = 'F'\n  AND c_birth_month = 2\n  AND c_birth_year BETWEEN 1965 AND 1971\nORDER BY c_customer_id\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "family": "prefilter",
    "transform": "dimension_cte_chain",
    "hypothesis": "Late-applied dimension filters (store, customer) cause full scans in original plan. Prefiltering dimensions into CTEs reduces join cardinality early. Decorrelate subquery via store_avg_threshold CTE. EXPLAIN should show reduced rows in nested loops.",
    "target_ir": "CTEs for filtered dimensions + store_avg_threshold. Main query joins all CTEs with explicit JOIN syntax.",
    "dialect": "postgres",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (\n  SELECT sr_customer_sk AS ctr_customer_sk,\n    sr_store_sk AS ctr_store_sk,\n    sr_reason_sk AS ctr_reason_sk,\n    SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return\n  FROM store_returns, date_dim\n  WHERE sr_returned_date_sk = d_date_sk\n    AND d_year = 2002\n    AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167\n  GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk\n),\nf_store AS (\n  SELECT s_store_sk\n  FROM store\n  WHERE s_state IN ('IL', 'KY', 'TX')\n),\nf_customer AS (\n  SELECT c_customer_sk, c_current_cdemo_sk\n  FROM customer\n  WHERE c_birth_month = 2\n    AND c_birth_year BETWEEN 1965 AND 1971\n),\nf_demographics AS (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_marital_status IN ('M', 'M')\n    AND cd_education_status IN ('Advanced Degree', 'College')\n    AND cd_gender = 'F'\n),\nstore_avg_threshold AS (\n  SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS threshold\n  FROM customer_total_return\n  GROUP BY ctr_store_sk\n)\nSELECT c_customer_id\nFROM customer_total_return ctr1\nJOIN f_store ON f_store.s_store_sk = ctr1.ctr_store_sk\nJOIN f_customer ON f_customer.c_customer_sk = ctr1.ctr_customer_sk\nJOIN f_demographics ON f_demographics.cd_demo_sk = f_customer.c_current_cdemo_sk\nJOIN store_avg_threshold sat ON ctr1.ctr_store_sk = sat.ctr_store_sk\nWHERE ctr1.ctr_total_return > sat.threshold\n  AND ctr1.ctr_reason_sk BETWEEN 43 AND 46\nORDER BY c_customer_id\nLIMIT 100;"
        }
      }
    ]
  }
]