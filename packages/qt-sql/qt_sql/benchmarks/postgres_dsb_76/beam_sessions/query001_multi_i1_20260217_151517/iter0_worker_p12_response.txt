{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate the correlated AVG subquery into a single-pass CTE aggregation to eliminate repeated scans of customer_total_return.",
  "reasoning_trace": [
    "The correlated subquery computing AVG(ctr_total_return) executes per outer row, causing repeated scans.",
    "PostgreSQL can compute multiple aggregates in one pass using CASE expressions inside aggregate functions.",
    "Precompute both the total return and average per store in a single CTE scan."
  ],
  "target_ir": "CTE computes grouped aggregates including average; main query joins and filters without correlated subquery.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ctr_with_avg",
        "cte_query_sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return, AVG(SR_RETURN_AMT_INC_TAX) OVER (PARTITION BY sr_store_sk) AS ctr_avg_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "ctr_with_avg ctr1 JOIN store s ON s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics cd ON c_current_cdemo_sk = cd_demo_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "ctr1.ctr_total_return > ctr1.ctr_avg_return * 1.2 AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971"
      }
    }
  ]
}