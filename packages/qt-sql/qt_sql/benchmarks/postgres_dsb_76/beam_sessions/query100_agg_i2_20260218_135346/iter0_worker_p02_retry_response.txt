{
  "probe_id": "p02",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Decomposing the self-join on store_sales into two CTEs, each prefiltered by item and date constraints, allows earlier application of the expensive item inequality filter and may improve join order.",
  "reasoning_trace": [
    "Assigned transform targets decomposition of self-join on store_sales.",
    "Two CTEs are introduced to materialize filtered versions of s1 and s2.",
    "Filters on item and date are pushed into the CTEs to reduce intermediate result sizes.",
    "Explicit joins replace comma-style joins to enable better optimizer behavior."
  ],
  "target_ir": "Two CTEs (s1_filtered, s2_filtered) replace direct store_sales scans; final_select joins these CTEs explicitly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["s1_filtered", "s2_filtered", "item1", "item2", "date_dim", "customer", "customer_address", "customer_demographics"],
        "outputs": ["item1.i_item_sk", "item2.i_item_sk", "count(*) as cnt"],
        "changed": true,
        "sql": "WITH s1_filtered AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk, ss_list_price FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_dim ON d_date_sk = ss_sold_date_sk WHERE d_year between 1999 and 1999 + 1 AND i_category in ('Electronics', 'Men') AND ss_list_price between 115 and 129), s2_filtered AS (SELECT ss_item_sk, ss_ticket_number, ss_list_price FROM store_sales JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id between 44 and 63 AND ss_list_price between 115 and 129) SELECT item1.i_item_sk, item2.i_item_sk, count(*) as cnt FROM item AS item1 JOIN s1_filtered AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN s2_filtered AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN date_dim ON d_date_sk = s1.ss_sold_date_sk JOIN customer ON s1.ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE d_year between 1999 and 1999 + 1 AND item1.i_category in ('Electronics', 'Men') AND item2.i_manager_id between 44 and 63 AND cd_marital_status = 'D' AND cd_education_status = 'College' AND s1.ss_list_price between 115 and 129 AND s2.ss_list_price between 115 and 129 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
      },
      {
        "node_id": "s1_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item", "date_dim"],
        "outputs": ["ss_item_sk", "ss_ticket_number", "ss_customer_sk", "ss_sold_date_sk", "ss_list_price"],
        "changed": false
      },
      {
        "node_id": "s2_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item"],
        "outputs": ["ss_item_sk", "ss_ticket_number", "ss_list_price"],
        "changed": false
      }
    ]
  }
}