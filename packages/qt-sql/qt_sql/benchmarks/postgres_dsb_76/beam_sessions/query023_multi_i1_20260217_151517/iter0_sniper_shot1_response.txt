[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "original",
    "strategy": "Convert comma joins to explicit INNER JOINs + pre-filter dimensions",
    "hypothesis": "Original comma joins prevent optimal join reordering. Pre-filtering item/customer reduces CTE scan costs. BDA shows 79.6s spent on best_ss_customer CTE with full store_sales scan. Explicit joins enable better plans while pre-filtering reduces row counts before joins.",
    "target_ir": "CTEs with explicit JOINs + dimension subqueries",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH frequent_ss_items AS (\n  SELECT SUBSTRING(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, COUNT(*) cnt\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  JOIN (SELECT * FROM item WHERE i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports')) AS i ON ss_item_sk = i_item_sk\n  WHERE d_year = 1998\n  GROUP BY SUBSTRING(i_item_desc,1,30), i_item_sk, d_date\n  HAVING COUNT(*) >4\n), \nmax_store_sales AS (\n  SELECT MAX(csales) tpcds_cmax\n  FROM (\n    SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) csales\n    FROM store_sales\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE d_year = 1998\n      AND ss_wholesale_cost BETWEEN 11 AND 21\n    GROUP BY c_customer_sk\n  ) tmp1\n), \nbest_ss_customer AS (\n  SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) ssales\n  FROM store_sales\n  JOIN (SELECT * FROM customer WHERE c_birth_year BETWEEN 1934 AND 1940) AS c ON ss_customer_sk = c_customer_sk\n  GROUP BY c_customer_sk\n  HAVING SUM(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)\n)\nSELECT SUM(sales)\nFROM (\n  SELECT cs_quantity*cs_list_price sales\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  WHERE d_year = 1998\n    AND d_moy = 10\n    AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND cs_wholesale_cost BETWEEN 11 AND 21\n  UNION ALL\n  SELECT ws_quantity*ws_list_price sales\n  FROM web_sales\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  WHERE d_year = 1998\n    AND d_moy = 10\n    AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND ws_wholesale_cost BETWEEN 11 AND 21\n) tmp2\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "original",
    "strategy": "Materialize expensive CTEs + explicit JOINs",
    "hypothesis": "BDA shows 79.6s spent on best_ss_customer CTE. Materializing CTEs prevents recomputation in UNION branches while explicit JOINs fix comma-join weakness. Fallback to non-materialized if PostgreSQL optimizer doesn't benefit.",
    "target_ir": "Materialized CTEs + preserved UNION structure",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH frequent_ss_items AS MATERIALIZED (\n  SELECT SUBSTRING(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, COUNT(*) cnt\n  FROM store_sales, date_dim, item\n  WHERE ss_sold_date_sk = d_date_sk\n    AND ss_item_sk = i_item_sk\n    AND d_year = 1998\n    AND i_manager_id BETWEEN 81 AND 100\n    AND i_category IN ('Children', 'Men', 'Sports')\n  GROUP BY SUBSTRING(i_item_desc,1,30), i_item_sk, d_date\n  HAVING COUNT(*) >4\n), \nmax_store_sales AS MATERIALIZED (\n  SELECT MAX(csales) tpcds_cmax\n  FROM (\n    SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) csales\n    FROM store_sales\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE d_year = 1998\n      AND ss_wholesale_cost BETWEEN 11 AND 21\n    GROUP BY c_customer_sk\n  ) tmp1\n), \nbest_ss_customer AS MATERIALIZED (\n  SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) ssales\n  FROM store_sales\n  JOIN customer ON ss_customer_sk = c_customer_sk\n  WHERE c_birth_year BETWEEN 1934 AND 1940\n  GROUP BY c_customer_sk\n  HAVING SUM(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)\n)\nSELECT SUM(sales)\nFROM (\n  SELECT cs_quantity*cs_list_price sales\n  FROM catalog_sales, date_dim\n  WHERE d_year = 1998\n    AND d_moy = 10\n    AND cs_sold_date_sk = d_date_sk\n    AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND cs_wholesale_cost BETWEEN 11 AND 21\n  UNION ALL\n  SELECT ws_quantity*ws_list_price sales\n  FROM web_sales, date_dim\n  WHERE d_year = 1998\n    AND d_moy = 10\n    AND ws_sold_date_sk = d_date_sk\n    AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND ws_wholesale_cost BETWEEN 11 AND 21\n) tmp2\nLIMIT 100;"
        }
      }
    ]
  }
]