[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "family": "A",
    "transform": "exists_replace_intersect",
    "hypothesis": "Original INTERSECT operations cause expensive materialization/sorting. Replacing with EXISTS avoids intermediate materialization and leverages PostgreSQL's semi-join optimization. EXPLAIN shows bitmap scans possible on sales tables.",
    "target_ir": "cross_items rewritten as item scan with EXISTS subqueries",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH cross_items AS (\n    SELECT i_item_sk AS ss_item_sk\n    FROM item\n    WHERE i_category IN ('Electronics', 'Shoes', 'Sports')\n      AND i_manager_id BETWEEN 42 AND 51\n      AND EXISTS (\n          SELECT 1 \n          FROM store_sales \n          INNER JOIN date_dim d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk\n          WHERE store_sales.ss_item_sk = item.i_item_sk\n            AND d1.d_year BETWEEN 1999 AND 2001\n            AND store_sales.ss_wholesale_cost BETWEEN 76 AND 96\n      )\n      AND EXISTS (\n          SELECT 1 \n          FROM catalog_sales \n          INNER JOIN date_dim d2 ON catalog_sales.cs_sold_date_sk = d2.d_date_sk\n          WHERE catalog_sales.cs_item_sk = item.i_item_sk\n            AND d2.d_year BETWEEN 1999 AND 2001\n            AND catalog_sales.cs_wholesale_cost BETWEEN 76 AND 96\n      )\n      AND EXISTS (\n          SELECT 1 \n          FROM web_sales \n          INNER JOIN date_dim d3 ON web_sales.ws_sold_date_sk = d3.d_date_sk\n          WHERE web_sales.ws_item_sk = item.i_item_sk\n            AND d3.d_year BETWEEN 1999 AND 2001\n            AND web_sales.ws_wholesale_cost BETWEEN 76 AND 96\n      )\n),\navg_sales AS (\n    SELECT AVG(quantity * list_price) AS average_sales\n    FROM (\n        SELECT ss_quantity AS quantity, ss_list_price AS list_price\n        FROM store_sales, date_dim\n        WHERE ss_sold_date_sk = d_date_sk\n          AND d_year BETWEEN 1999 AND 2001\n          AND ss_wholesale_cost BETWEEN 76 AND 96\n        UNION ALL\n        SELECT cs_quantity AS quantity, cs_list_price AS list_price\n        FROM catalog_sales, date_dim\n        WHERE cs_sold_date_sk = d_date_sk\n          AND d_year BETWEEN 1999 AND 2001\n          AND cs_wholesale_cost BETWEEN 76 AND 96\n        UNION ALL\n        SELECT ws_quantity AS quantity, ws_list_price AS list_price\n        FROM web_sales, date_dim\n        WHERE ws_sold_date_sk = d_date_sk\n          AND ws_wholesale_cost BETWEEN 76 AND 96\n          AND d_year BETWEEN 1999 AND 2001\n    ) x\n)\nSELECT \n    this_year.channel AS ty_channel,\n    this_year.i_brand_id AS ty_brand,\n    this_year.i_class_id AS ty_class,\n    this_year.i_category_id AS ty_category,\n    this_year.sales AS ty_sales,\n    this_year.number_sales AS ty_number_sales,\n    last_year.channel AS ly_channel,\n    last_year.i_brand_id AS ly_brand,\n    last_year.i_class_id AS ly_class,\n    last_year.i_category_id AS ly_category,\n    last_year.sales AS ly_sales,\n    last_year.number_sales AS ly_number_sales\nFROM (\n    SELECT \n        'store' AS channel,\n        i_brand_id,\n        i_class_id,\n        i_category_id,\n        SUM(ss_quantity * ss_list_price) AS sales,\n        COUNT(*) AS number_sales\n    FROM store_sales\n    JOIN item ON ss_item_sk = i_item_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12)\n      AND i_category IN ('Electronics', 'Shoes', 'Sports')\n      AND i_manager_id BETWEEN 42 AND 51\n      AND ss_wholesale_cost BETWEEN 76 AND 96\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) this_year,\n(\n    SELECT \n        'store' AS channel,\n        i_brand_id,\n        i_class_id,\n        i_category_id,\n        SUM(ss_quantity * ss_list_price) AS sales,\n        COUNT(*) AS number_sales\n    FROM store_sales\n    JOIN item ON ss_item_sk = i_item_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n      AND d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 12)\n      AND i_category IN ('Electronics', 'Shoes', 'Sports')\n      AND ss_wholesale_cost BETWEEN 76 AND 96\n      AND i_manager_id BETWEEN 42 AND 51\n    GROUP BY i_brand_id, i_class_id, i_category_id\n    HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)\n) last_year\nWHERE this_year.i_brand_id = last_year.i_brand_id\n  AND this_year.i_class_id = last_year.i_class_id\n  AND this_year.i_category_id = last_year.i_category_id\nORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "family": "C",
    "transform": "single_pass_aggregation",
    "hypothesis": "Main query scans store_sales twice for year comparisons. Single aggregation with conditional sums reduces fact table scans and join overhead. EXPLAIN shows reduced loops and row processing.",
    "target_ir": "Main query consolidated to single aggregation with conditional year logic",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH cross_items AS\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id\n     ,iss.i_class_id class_id\n     ,iss.i_category_id category_id\n from store_sales\n     ,item iss\n     ,date_dim d1\n where ss_item_sk = iss.i_item_sk\n   and ss_sold_date_sk = d1.d_date_sk\n   and d1.d_year between 1999 AND 1999 + 2\n   and i_category IN ('Electronics', 'Shoes', 'Sports')\n   and i_manager_id BETWEEN 42 and 51\n   and ss_wholesale_cost BETWEEN 76 AND 96\nintersect\n select ics.i_brand_id\n     ,ics.i_class_id\n     ,ics.i_category_id\n from catalog_sales\n     ,item ics\n     ,date_dim d2\n where cs_item_sk = ics.i_item_sk\n   and cs_sold_date_sk = d2.d_date_sk\n   and d2.d_year between 1999 AND 1999 + 2\n   and i_category IN ('Electronics', 'Shoes', 'Sports')\n   and i_manager_id BETWEEN 42 and 51\n   and cs_wholesale_cost BETWEEN 76 AND 96\nintersect\n select iws.i_brand_id\n     ,iws.i_class_id\n     ,iws.i_category_id\n from web_sales\n     ,item iws\n     ,date_dim d3\n where ws_item_sk = iws.i_item_sk\n   and ws_sold_date_sk = d3.d_date_sk\n   and ws_wholesale_cost BETWEEN 76 AND 96\n   and d3.d_year between 1999 AND 1999 + 2) x\n where i_brand_id = brand_id\n      and i_class_id = class_id\n      and i_category_id = category_id\n      and i_category IN ('Electronics', 'Shoes', 'Sports')\n      and i_manager_id BETWEEN 42 and 51\n),\n avg_sales as\n(select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity\n             ,ss_list_price list_price\n       from store_sales\n           ,date_dim\n       where ss_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and ss_wholesale_cost BETWEEN 76 AND 96\n       union all\n       select cs_quantity quantity\n             ,cs_list_price list_price\n       from catalog_sales\n           ,date_dim\n       where cs_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and cs_wholesale_cost BETWEEN 76 AND 96\n       union all\n       select ws_quantity quantity\n             ,ws_list_price list_price\n       from web_sales\n           ,date_dim\n       where ws_sold_date_sk = d_date_sk\n        and ws_wholesale_cost BETWEEN 76 AND 96\n         and d_year between 1999 and 1999 + 2) x)\nSELECT \n    'store' AS ty_channel,\n    i_brand_id AS ty_brand,\n    i_class_id AS ty_class,\n    i_category_id AS ty_category,\n    SUM(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=1999+1 AND d_moy=12 AND d_dom=12) THEN ss_quantity*ss_list_price ELSE 0 END) AS ty_sales,\n    COUNT(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=1999+1 AND d_moy=12 AND d_dom=12) THEN 1 END) AS ty_number_sales,\n    'store' AS ly_channel,\n    i_brand_id AS ly_brand,\n    i_class_id AS ly_class,\n    i_category_id AS ly_category,\n    SUM(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=1999 AND d_moy=12 AND d_dom=12) THEN ss_quantity*ss_list_price ELSE 0 END) AS ly_sales,\n    COUNT(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=1999 AND d_moy=12 AND d_dom=12) THEN 1 END) AS ly_number_sales\nFROM store_sales\nJOIN item ON ss_item_sk = i_item_sk\nJOIN date_dim ON ss_sold_date_sk = d_date_sk\nWHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n  AND i_category IN ('Electronics', 'Shoes', 'Sports')\n  AND i_manager_id BETWEEN 42 AND 51\n  AND ss_wholesale_cost BETWEEN 76 AND 96\n  AND d_week_seq IN (\n      (SELECT d_week_seq FROM date_dim WHERE d_year=1999 AND d_moy=12 AND d_dom=12),\n      (SELECT d_week_seq FROM date_dim WHERE d_year=2000 AND d_moy=12 AND d_dom=12)\n  )\nGROUP BY i_brand_id, i_class_id, i_category_id\nHAVING \n    SUM(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=2000 AND d_moy=12 AND d_dom=12) THEN ss_quantity*ss_list_price ELSE 0 END) > (SELECT average_sales FROM avg_sales)\n    AND SUM(CASE WHEN d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year=1999 AND d_moy=12 AND d_dom=12) THEN ss_quantity*ss_list_price ELSE 0 END) > (SELECT average_sales FROM avg_sales)\nORDER BY ty_channel, ty_brand, ty_class, ty_category\nLIMIT 100;"
        }
      }
    ]
  }
]