{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate three UNION ALL branches scanning store_sales, catalog_sales, and web_sales into a single scan with conditional aggregation to reduce redundant fact table scans.",
  "reasoning_trace": [
    "UNION ALL in avg_sales causes three separate scans of sales tables with identical filters",
    "Conditional aggregation with CASE inside SUM/COUNT can compute all three channels in one pass",
    "Reduces row amplification and avoids repeated date_dim joins"
  ],
  "target_ir": "Single CTE with CASE-based conditional aggregation replacing three UNION ALL branches; main query unchanged",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {"by_node_id": "CTE_Q_S0_avg_sales"},
      "payload": {
        "sql_fragment": "SELECT AVG(CASE WHEN src = 'ss' THEN quantity*list_price END) AS average_sales FROM (SELECT 'ss' AS src, ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 2001 AND ss_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT 'cs' AS src, cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, date_dim WHERE cs_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 2001 AND cs_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT 'ws' AS src, ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, date_dim WHERE ws_sold_date_sk = d_date_sk AND d_year BETWEEN 1999 AND 2001 AND ws_wholesale_cost BETWEEN 76 AND 96) x"
      }
    }
  ]
}