{
  "probe_id": "p12",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Decomposing the self-join into separate CTEs for this_year and last_year with embedded date filters avoids full fact table scans and correlated subqueries, reducing cardinality blow-up and repeated work.",
  "reasoning_trace": [
    "Assigned transform targets the main query self-join pattern for decomposition.",
    "Embedding selective date_dim filters in each branch reduces input to aggregation.",
    "Separate CTEs eliminate correlated subqueries and enable reuse of cross_items and avg_sales."
  ],
  "target_ir": "this_year and last_year become materialized CTEs with embedded date filters; final_select joins them.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "cross_items",
        "parent_node_id": "final_select",
        "sources": ["item", "web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["ss_item_sk"],
        "changed": false
      },
      {
        "node_id": "avg_sales",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["average_sales"],
        "changed": false
      },
      {
        "node_id": "this_year",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item", "date_dim", "cross_items", "avg_sales"],
        "outputs": ["channel", "i_brand_id", "i_class_id", "i_category_id", "sales", "number_sales"],
        "changed": true,
        "sql": "SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk CROSS JOIN cross_items ci CROSS JOIN avg_sales avgs WHERE ss.ss_item_sk = ci.ss_item_sk AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12) AND i.i_category IN ('Electronics', 'Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 51 AND ss.ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > avgs.average_sales"
      },
      {
        "node_id": "last_year",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item", "date_dim", "cross_items", "avg_sales"],
        "outputs": ["channel", "i_brand_id", "i_class_id", "i_category_id", "sales", "number_sales"],
        "changed": true,
        "sql": "SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk CROSS JOIN cross_items ci CROSS JOIN avg_sales avgs WHERE ss.ss_item_sk = ci.ss_item_sk AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 12) AND i.i_category IN ('Electronics', 'Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 51 AND ss.ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > avgs.average_sales"
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["this_year", "last_year"],
        "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
        "changed": true,
        "sql": "SELECT ty.channel AS ty_channel, ty.i_brand_id AS ty_brand, ty.i_class_id AS ty_class, ty.i_category_id AS ty_category, ty.sales AS ty_sales, ty.number_sales AS ty_number_sales, ly.channel AS ly_channel, ly.i_brand_id AS ly_brand, ly.i_class_id AS ly_class, ly.i_category_id AS ly_category, ly.sales AS ly_sales, ly.number_sales AS ly_number_sales FROM this_year ty JOIN last_year ly ON ty.i_brand_id = ly.i_brand_id AND ty.i_class_id = ly.i_class_id AND ty.i_category_id = ly.i_category_id ORDER BY ty.channel, ty.i_brand_id, ty.i_class_id, ty.i_category_id LIMIT 100"
      }
    ]
  }
}