{
  "probe_id": "p12",
  "transform_id": "multi_date_range_cte",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Separating date_dim scans into dedicated CTEs per alias (d1, d2, d3) enables earlier filtering and improves join selectivity estimates.",
  "reasoning_trace": [
    "Original query joins date_dim three times with overlapping but distinct filters.",
    "Creating dedicated CTEs for each date alias isolates selective predicates.",
    "This allows the planner to better estimate row counts and optimize join order."
  ],
  "target_ir": "New CTEs d1, d2, d3 encapsulate filtered date_dim scans; existing nodes reference these.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "item", "date_dim", "avg_sales", "cross_items"],
        "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
        "changed": false
      },
      {
        "node_id": "cross_items",
        "parent_node_id": "final_select",
        "sources": ["item", "web_sales", "d1", "d2", "d3", "store_sales", "catalog_sales"],
        "outputs": ["ss_item_sk"],
        "changed": true,
        "sql": "SELECT i_item_sk ss_item_sk FROM item, (SELECT iss.i_brand_id brand_id, iss.i_class_id class_id, iss.i_category_id category_id FROM store_sales, item iss, d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND ss_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, item ics, d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 1999 + 2 AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51 AND cs_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, item iws, d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96 AND d3.d_year BETWEEN 1999 AND 1999 + 2) x WHERE i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id AND i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51"
      },
      {
        "node_id": "avg_sales",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "d1", "d2", "d3", "store_sales", "catalog_sales"],
        "outputs": ["average_sales"],
        "changed": true,
        "sql": "SELECT avg(quantity * list_price) average_sales FROM (SELECT ss_quantity quantity, ss_list_price list_price FROM store_sales, d1 WHERE ss_sold_date_sk = d1.d_date_sk AND d1.d_year BETWEEN 1999 AND 1999 + 2 AND ss_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT cs_quantity quantity, cs_list_price list_price FROM catalog_sales, d2 WHERE cs_sold_date_sk = d2.d_date_sk AND d2.d_year BETWEEN 1999 AND 1999 + 2 AND cs_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT ws_quantity quantity, ws_list_price list_price FROM web_sales, d3 WHERE ws_sold_date_sk = d3.d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96 AND d3.d_year BETWEEN 1999 AND 1999 + 2) x"
      },
      {
        "node_id": "d1",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2"
      },
      {
        "node_id": "d2",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2"
      },
      {
        "node_id": "d3",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2"
      }
    ]
  }
}