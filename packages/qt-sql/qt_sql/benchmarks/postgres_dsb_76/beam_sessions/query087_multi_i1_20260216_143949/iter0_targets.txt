[
  {
    "target_id": "t1",
    "family": "E",
    "transform": "multi_dimension_prefetch",
    "relevance_score": 0.95,
    "hypothesis": "Repeated full scans of date_dim and customer tables with identical filters across three EXCEPT branches. Precompute filtered dimension tables in CTEs for reuse.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_date AS (SELECT * FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11)\n  CTE: filtered_customer AS (SELECT * FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961)\n  MAIN QUERY (via Q_S0)\n    FROM: (\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM store_sales\n       INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n       INNER JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n       WHERE ss_list_price BETWEEN 242 AND 271\n         AND ss_wholesale_cost BETWEEN 35 AND 45)\n      EXCEPT\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM catalog_sales\n       INNER JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n       INNER JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n       WHERE cs_list_price BETWEEN 242 AND 271\n         AND cs_wholesale_cost BETWEEN 35 AND 45)\n      EXCEPT\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM web_sales\n       INNER JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n       INNER JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n       WHERE ws_list_price BETWEEN 242 AND 271\n         AND ws_wholesale_cost BETWEEN 35 AND 45)\n    ) cool_cust",
    "recommended_examples": [
      "multi_dimension_prefetch"
    ]
  },
  {
    "target_id": "t2",
    "family": "D",
    "transform": "intersect_to_exists",
    "relevance_score": 0.85,
    "hypothesis": "EXCEPT operations materialize full distinct sets. Replace with NOT EXISTS to avoid duplicate elimination and enable early exit.",
    "target_ir": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: (\n      SELECT DISTINCT c_last_name, c_first_name, d_date\n      FROM store_sales\n      INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n      INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk\n      WHERE d_month_seq BETWEEN 1214 AND 1214+11\n        AND ss_list_price BETWEEN 242 AND 271\n        AND c_birth_year BETWEEN 1955 AND 1961\n        AND ss_wholesale_cost BETWEEN 35 AND 45\n        AND NOT EXISTS (\n          SELECT 1 FROM catalog_sales\n          WHERE cs_sold_date_sk = date_dim.d_date_sk\n            AND cs_bill_customer_sk = customer.c_customer_sk\n            AND cs_list_price BETWEEN 242 AND 271\n            AND cs_wholesale_cost BETWEEN 35 AND 45\n        )\n        AND NOT EXISTS (\n          SELECT 1 FROM web_sales\n          WHERE ws_sold_date_sk = date_dim.d_date_sk\n            AND ws_bill_customer_sk = customer.c_customer_sk\n            AND ws_list_price BETWEEN 242 AND 271\n            AND ws_wholesale_cost BETWEEN 35 AND 45\n        )\n    ) cool_cust",
    "recommended_examples": [
      "pg_intersect_to_exists"
    ]
  },
  {
    "target_id": "t3",
    "family": "C",
    "transform": "distinct_pushdown",
    "relevance_score": 0.75,
    "hypothesis": "DISTINCT applied after large joins. Pre-aggregate sales tables on join keys before joining to dimensions.",
    "target_ir": "S0 [SELECT]\n  CTE: agg_store_sales AS (\n    SELECT ss_customer_sk, ss_sold_date_sk\n    FROM store_sales\n    WHERE ss_list_price BETWEEN 242 AND 271\n      AND ss_wholesale_cost BETWEEN 35 AND 45\n    GROUP BY ss_customer_sk, ss_sold_date_sk\n  )\n  CTE: agg_catalog_sales AS (\n    SELECT cs_bill_customer_sk, cs_sold_date_sk\n    FROM catalog_sales\n    WHERE cs_list_price BETWEEN 242 AND 271\n      AND cs_wholesale_cost BETWEEN 35 AND 45\n    GROUP BY cs_bill_customer_sk, cs_sold_date_sk\n  )\n  CTE: agg_web_sales AS (\n    SELECT ws_bill_customer_sk, ws_sold_date_sk\n    FROM web_sales\n    WHERE ws_list_price BETWEEN 242 AND 271\n      AND ws_wholesale_cost BETWEEN 35 AND 45\n    GROUP BY ws_bill_customer_sk, ws_sold_date_sk\n  )\n  MAIN QUERY (via Q_S0)\n    FROM: (\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM agg_store_sales\n       INNER JOIN date_dim ON agg_store_sales.ss_sold_date_sk = date_dim.d_date_sk\n       INNER JOIN customer ON agg_store_sales.ss_customer_sk = customer.c_customer_sk\n       WHERE d_month_seq BETWEEN 1214 AND 1214+11\n         AND c_birth_year BETWEEN 1955 AND 1961)\n      EXCEPT\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM agg_catalog_sales\n       INNER JOIN date_dim ON agg_catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n       INNER JOIN customer ON agg_catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n       WHERE d_month_seq BETWEEN 1214 AND 1214+11\n         AND c_birth_year BETWEEN 1955 AND 1961)\n      EXCEPT\n      (SELECT DISTINCT c_last_name, c_first_name, d_date\n       FROM agg_web_sales\n       INNER JOIN date_dim ON agg_web_sales.ws_sold_date_sk = date_dim.d_date_sk\n       INNER JOIN customer ON agg_web_sales.ws_bill_customer_sk = customer.c_customer_sk\n       WHERE d_month_seq BETWEEN 1214 AND 1214+11\n         AND c_birth_year BETWEEN 1955 AND 1961)\n    ) cool_cust",
    "recommended_examples": [
      "pg_materialized_dimension_fact_prefilter"
    ]
  }
]