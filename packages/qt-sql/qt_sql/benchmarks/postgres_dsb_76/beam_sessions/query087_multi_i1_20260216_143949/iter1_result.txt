{
  "iteration": 1,
  "n_api_calls": 4,
  "best_speedup": 2.08,
  "best_patch_id": "t1_comb",
  "best_sql": "WITH store_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45), catalog_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales AS cs JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer AS c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45), web_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales AS ws JOIN date_dim AS d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer AS c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM store_sales_base AS ssb WHERE NOT EXISTS(SELECT 1 FROM catalog_sales_base AS csb WHERE csb.c_last_name = ssb.c_last_name AND csb.c_first_name = ssb.c_first_name AND csb.d_date = ssb.d_date) AND NOT EXISTS(SELECT 1 FROM web_sales_base AS wsb WHERE wsb.c_last_name = ssb.c_last_name AND wsb.c_first_name = ssb.c_first_name AND wsb.d_date = ssb.d_date);",
  "patches": [
    {
      "patch_id": "t1_comb",
      "family": "C+D",
      "transform": "distinct_pushdown_then_except_to_exists",
      "relevance_score": 0.95,
      "status": "WIN",
      "speedup": 2.08,
      "semantic_passed": true,
      "error": null,
      "original_ms": 778.0,
      "patch_ms": 374.5,
      "output_sql": "WITH store_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales AS ss JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND ss.ss_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ss.ss_wholesale_cost BETWEEN 35 AND 45), catalog_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales AS cs JOIN date_dim AS d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer AS c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND cs.cs_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND cs.cs_wholesale_cost BETWEEN 35 AND 45), web_sales_base AS (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales AS ws JOIN date_dim AS d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer AS c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE d.d_month_seq BETWEEN 1214 AND 1214 + 11 AND ws.ws_list_price BETWEEN 242 AND 271 AND c.c_birth_year BETWEEN 1955 AND 1961 AND ws.ws_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM store_sales_base AS ssb WHERE NOT EXISTS(SELECT 1 FROM catalog_sales_base AS csb WHERE csb.c_last_name = ssb.c_last_name AND csb.c_first_name = ssb.c_first_name AND csb.d_date = ssb.d_date) AND NOT EXISTS(SELECT 1 FROM web_sales_base AS wsb WHERE wsb.c_last_name = ssb.c_last_name AND wsb.c_first_name = ssb.c_first_name AND wsb.d_date = ssb.d_date);",
      "has_explain": true
    },
    {
      "patch_id": "t3_rescue",
      "family": "D+A+E",
      "transform": "except_to_exists_corrected+prefilter_dimensions_materialize",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 778.0,
      "patch_ms": 843.4,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214 + 11), filtered_customers AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961), store_sales_base AS (SELECT DISTINCT fc.c_last_name, fc.c_first_name, fd.d_date FROM store_sales AS ss INNER JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers AS fc ON ss.ss_customer_sk = fc.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND ss.ss_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM store_sales_base AS ssb WHERE NOT EXISTS(SELECT 1 FROM catalog_sales AS cs INNER JOIN filtered_dates AS fd ON cs.cs_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers AS fc ON cs.cs_bill_customer_sk = fc.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND cs.cs_wholesale_cost BETWEEN 35 AND 45 AND fc.c_last_name = ssb.c_last_name AND fc.c_first_name = ssb.c_first_name AND fd.d_date = ssb.d_date) AND NOT EXISTS(SELECT 1 FROM web_sales AS ws INNER JOIN filtered_dates AS fd ON ws.ws_sold_date_sk = fd.d_date_sk INNER JOIN filtered_customers AS fc ON ws.ws_bill_customer_sk = fc.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND ws.ws_wholesale_cost BETWEEN 35 AND 45 AND fc.c_last_name = ssb.c_last_name AND fc.c_first_name = ssb.c_first_name AND fd.d_date = ssb.d_date);",
      "has_explain": true
    },
    {
      "patch_id": "t2_refine",
      "family": "C",
      "transform": "distinct_pushdown_corrected",
      "relevance_score": 0.9,
      "status": "REGRESSION",
      "speedup": 0.42,
      "semantic_passed": true,
      "error": null,
      "original_ms": 778.0,
      "patch_ms": 1837.0,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214 + 11), filtered_customer AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961), store_sales_filtered AS (SELECT DISTINCT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 242 AND 271 AND ss_wholesale_cost BETWEEN 35 AND 45), catalog_sales_filtered AS (SELECT DISTINCT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 242 AND 271 AND cs_wholesale_cost BETWEEN 35 AND 45), web_sales_filtered AS (SELECT DISTINCT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 242 AND 271 AND ws_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM (SELECT c_last_name, c_first_name, d_date FROM store_sales_filtered AS ss JOIN filtered_customer AS c ON ss.ss_customer_sk = c.c_customer_sk JOIN filtered_date AS d ON ss.ss_sold_date_sk = d.d_date_sk EXCEPT SELECT c_last_name, c_first_name, d_date FROM catalog_sales_filtered AS cs JOIN filtered_customer AS c ON cs.cs_bill_customer_sk = c.c_customer_sk JOIN filtered_date AS d ON cs.cs_sold_date_sk = d.d_date_sk EXCEPT SELECT c_last_name, c_first_name, d_date FROM web_sales_filtered AS ws JOIN filtered_customer AS c ON ws.ws_bill_customer_sk = c.c_customer_sk JOIN filtered_date AS d ON ws.ws_sold_date_sk = d.d_date_sk) AS cool_cust;",
      "has_explain": true
    }
  ],
  "explains": {
    "t1_comb": "Aggregate  (rows=1, time=412.318)\n  Merge Join  (rows=0, time=412.31)\n    Merge Join  (rows=0, time=412.307)\n      Unique  (rows=0, time=412.303)\n        Gather Merge  (rows=0, time=412.301)\n          Sort  (rows=0, time=402.186)\n            Nested Loop  (rows=0, time=402.147)\n              Nested Loop  (rows=0, time=402.146)\n                Seq Scan on date_dim (d)  (rows=182, time=2.432)\n                Index Only Scan on store_sales (ss)  (rows=0, time=2.189)\n              Index Scan on custo",
    "t3_rescue": "Aggregate  (rows=1, time=874.062)\n  Index Scan on date_dim  (rows=365, time=0.809)\n  Seq Scan on customer  (rows=47740, time=52.428)\n  Merge Join  (rows=0, time=874.055)\n    Merge Join  (rows=0, time=874.051)\n      Unique  (rows=0, time=874.046)\n        Sort  (rows=0, time=874.044)\n          Merge Join  (rows=0, time=874.034)\n            Sort  (rows=1, time=76.625)\n              CTE Scan (fc_2)  (rows=47740, time=64.998)\n            Sort  (rows=0, time=797.405)\n              Nested Loop  (rows=0",
    "t2_refine": "Aggregate  (rows=1, time=2533.685)\n  Index Scan on date_dim  (rows=365, time=0.103)\n  Seq Scan on customer  (rows=47740, time=58.516)\n  Subquery Scan (cool_cust)  (rows=0, time=2533.68)\n    SetOp  (rows=0, time=2533.678)\n      Sort  (rows=0, time=2533.676)\n        Append  (rows=0, time=2533.641)\n          Result  (rows=0, time=2154.407)\n            SetOp  (rows=0, time=2154.405)\n              Sort  (rows=0, time=2154.404)\n                Append  (rows=0, time=2154.388)\n                  Subquery"
  }
}