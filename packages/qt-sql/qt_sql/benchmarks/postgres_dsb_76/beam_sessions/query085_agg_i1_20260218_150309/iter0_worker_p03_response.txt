{
  "probe_id": "scout_early_filter_decorrelate",
  "transform_id": "early_filter_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Precomputing cd_demo_sk values that meet the marital/education criteria in a CTE reduces row amplification in nested loops by enabling hash joins on selective keys.",
  "reasoning_trace": [
    "Nested loop join pathology shows severe cardinality misestimate (est=3, act=460) due to late evaluation of customer_demographics OR filters.",
    "Assigned transform targets decorrelation via early filter materialization without correlated subqueries present.",
    "PostgreSQL's BitmapOr handles indexed OR well, so we avoid UNION ALL and instead precompute qualifying cd_demo_sk values.",
    "New CTE 'cd_filtered' isolates complex OR logic; web_returns and web_sales join via hash using precomputed keyset."
  ],
  "target_ir": "Introduce cd_filtered CTE with distinct cd_demo_sk matching OR conditions; replace FROM with explicit JOINs referencing cd_filtered.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": [
          "SUBSTRING(r_reason_desc FROM 1 FOR 20)",
          "AVG(ws_quantity)",
          "AVG(wr_refunded_cash)",
          "AVG(wr_fee)"
        ],
        "changed": true,
        "sql": "SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN reason r ON r.r_reason_sk = wr.wr_reason_sk JOIN cd_filtered cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk JOIN cd_filtered cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk WHERE d.d_year = 2000 AND ((ca_country = 'United States' AND ca_state IN ('NC', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'CO', 'NY') AND ws_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'TX') AND ws_net_profit BETWEEN 50 AND 250)) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
      },
      {
        "node_id": "cd_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')"
      }
    ]
  }
}