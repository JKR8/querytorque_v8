{
  "probe_id": "scout_dimension_prefetch_star",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering selective dimensions (date_dim, customer_demographics, customer_address) into MATERIALIZED CTEs before joining with fact tables reduces row amplification and enables hash joins.",
  "reasoning_trace": [
    "Nested loop joins dominate due to late application of selective filters on dimensions.",
    "Materializing filtered dimensions early creates small hash tables for efficient joins.",
    "Explicit JOIN syntax improves PostgreSQL's ability to estimate cardinalities."
  ],
  "target_ir": "Introduce CTEs for filtered date_dim, cd1, ca; replace comma joins with explicit JOINs in final_select.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["web_sales", "web_returns", "web_page", "cd2", "reason", "date_dim_filtered", "cd1_filtered", "ca_filtered"],
        "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
        "changed": true,
        "sql": "SELECT\n  SUBSTRING(r_reason_desc FROM 1 FOR 20),\n  AVG(ws_quantity),\n  AVG(wr_refunded_cash),\n  AVG(wr_fee)\nFROM\n  web_sales\nJOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number\nJOIN web_page ON ws_web_page_sk = wp_web_page_sk\nJOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk\nJOIN reason ON r_reason_sk = wr_reason_sk\nJOIN date_dim_filtered d ON ws_sold_date_sk = d.d_date_sk\nJOIN cd1_filtered cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk\nJOIN ca_filtered ca ON ca.ca_address_sk = wr_refunded_addr_sk\nWHERE (\n  (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 100.00 AND 150.00)\n  OR\n  (cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 50.00 AND 100.00)\n  OR\n  (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 150.00 AND 200.00)\n)\nAND (\n  (ca_country = 'United States' AND ca_state IN ('NC', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200)\n  OR\n  (ca_country = 'United States' AND ca_state IN ('AR', 'CO', 'NY') AND ws_net_profit BETWEEN 150 AND 300)\n  OR\n  (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'TX') AND ws_net_profit BETWEEN 50 AND 250)\n)\nGROUP BY r_reason_desc\nORDER BY SUBSTRING(r_reason_desc FROM 1 FOR 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee)\nLIMIT 100"
      },
      {
        "node_id": "date_dim_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000"
      },
      {
        "node_id": "cd1_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S', 'W', 'M')"
      },
      {
        "node_id": "ca_filtered",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk", "ca_country", "ca_state"],
        "changed": true,
        "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('NC', 'PA', 'TX', 'AR', 'CO', 'NY', 'IA', 'IL')"
      },
      {
        "node_id": "web_sales",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["ws_item_sk", "ws_order_number", "ws_web_page_sk", "ws_sold_date_sk", "ws_sales_price", "ws_net_profit"],
        "changed": false
      },
      {
        "node_id": "web_returns",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["wr_item_sk", "wr_order_number", "wr_returning_cdemo_sk", "wr_reason_sk", "wr_refunded_cdemo_sk", "wr_refunded_addr_sk"],
        "changed": false
      },
      {
        "node_id": "web_page",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["wp_web_page_sk"],
        "changed": false
      },
      {
        "node_id": "cd2",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["cd_demo_sk"],
        "changed": false
      },
      {
        "node_id": "reason",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["r_reason_sk", "r_reason_desc"],
        "changed": false
      },
      {
        "node_id": "date_dim",
        "parent_node_id": "date_dim_filtered",
        "sources": [],
        "outputs": ["d_date_sk", "d_year"],
        "changed": false
      },
      {
        "node_id": "customer_demographics",
        "parent_node_id": "cd1_filtered",
        "sources": [],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": false
      },
      {
        "node_id": "customer_address",
        "parent_node_id": "ca_filtered",
        "sources": [],
        "outputs": ["ca_address_sk", "ca_country", "ca_state"],
        "changed": false
      }
    ]
  }
}