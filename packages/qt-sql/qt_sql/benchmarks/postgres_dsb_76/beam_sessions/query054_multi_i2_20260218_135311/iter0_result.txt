{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.04180147,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 115377,
    "completion_tokens": 17114,
    "total_tokens": 132491,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 32640,
    "reasoning_tokens": 7396
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 52.1,
      "patch_ms": 59.5,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales JOIN item ON item_sk = i_item_sk JOIN date_dim ON sold_date_sk = d_date_sk JOIN customer ON c_customer_sk = customer_sk WHERE i_category = 'Home' AND i_class = 'curtains/drapes' AND d_moy = 5 AND d_year = 1998 AND wholesale_cost BETWEEN 70 AND 100 AND c_birth_year BETWEEN 1942 AND 1955), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 70 AND 100 AND s_state IN ('AR', 'GA', 'IN', 'KS', 'KY', 'NC', 'OH', 'PA', 'SD', 'VA') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the my_customers CTE and reuse it in my_revenue to avoid recomputation of the expensive UNION ALL and dimension joins."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.89,
      "semantic_passed": true,
      "error": null,
      "original_ms": 52.1,
      "patch_ms": 58.3,
      "output_sql": "WITH date_filter AS (SELECT d_date_sk, d_moy, d_year, d_month_seq FROM date_dim WHERE d_moy = 5 AND d_year = 1998), my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales INNER JOIN date_filter ON sold_date_sk = d_date_sk INNER JOIN item ON item_sk = i_item_sk INNER JOIN customer ON c_customer_sk = cs_or_ws_sales.customer_sk WHERE i_category = 'Home' AND i_class = 'curtains/drapes' AND d_moy = 5 AND d_year = 1998 AND wholesale_cost BETWEEN 70 AND 100 AND c_birth_year BETWEEN 1942 AND 1955), my_revenue AS (SELECT c_customer_sk, sum(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN store_sales ON c_customer_sk = ss_customer_sk INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk INNER JOIN store ON ca_county = s_county AND ca_state = s_state INNER JOIN date_filter ON ss_sold_date_sk = d_date_sk WHERE ss_wholesale_cost BETWEEN 70 AND 100 AND s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit INNER JOIN syntax and isolate date_dim filters into a CTE for my_customers and my_revenue CTEs, preserving all predicates."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 52.1,
      "patch_ms": 2571.2,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Home' AND i_class = 'curtains/drapes' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 5 AND d_year = 1998 AND wholesale_cost BETWEEN 70 AND 100 AND c_birth_year BETWEEN 1942 AND 1955), store_sales_preagg AS (select ss_customer_sk, ss_sold_date_sk, ss_wholesale_cost, sum(ss_ext_sales_price) as ss_ext_sales_price from store_sales where ss_wholesale_cost BETWEEN 70 AND 100 group by ss_customer_sk, ss_sold_date_sk, ss_wholesale_cost), my_revenue AS (select c_customer_sk, sum(ss_ext_sales_price) as revenue from my_customers, store_sales_preagg, customer_address, store, date_dim where c_current_addr_sk = ca_address_sk and ca_county = s_county and ca_state = s_state and ss_sold_date_sk = d_date_sk and c_customer_sk = ss_customer_sk and ss_wholesale_cost BETWEEN 70 AND 100 and s_state in ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') and d_month_seq between (select distinct d_month_seq+1 from date_dim where d_year = 1998 and d_moy = 5) and (select distinct d_month_seq+3 from date_dim where d_year = 1998 and d_moy = 5) group by c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate store_sales by ss_customer_sk and ss_wholesale_cost filter before joining with my_customers, customer_address, store, and date_dim in my_revenue CTE."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.78,
      "status": "REGRESSION",
      "speedup": 0.88,
      "semantic_passed": true,
      "error": null,
      "original_ms": 52.1,
      "patch_ms": 59.4,
      "output_sql": "WITH cs_or_ws_sales AS (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales), item_prefetch AS (SELECT i_item_sk FROM item WHERE i_category = 'Home' AND i_class = 'curtains/drapes'), date_dim_prefetch AS (SELECT d_date_sk, d_moy, d_year FROM date_dim), customer_prefetch AS (SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_year BETWEEN 1942 AND 1955), customer_address_prefetch AS (SELECT ca_address_sk, ca_county, ca_state FROM customer_address), store_prefetch AS (SELECT s_county, s_state FROM store WHERE s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA')), date_dim_prefetch_revenue AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 5)), my_customers AS (SELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales JOIN item_prefetch i ON cs_or_ws_sales.item_sk = i.i_item_sk JOIN date_dim_prefetch ddp ON cs_or_ws_sales.sold_date_sk = ddp.d_date_sk JOIN customer_prefetch c ON c.c_customer_sk = cs_or_ws_sales.customer_sk WHERE ddp.d_moy = 5 AND ddp.d_year = 1998 AND cs_or_ws_sales.wholesale_cost BETWEEN 70 AND 100), my_revenue AS (SELECT mc.c_customer_sk, SUM(ss.ss_ext_sales_price) AS revenue FROM my_customers mc JOIN store_sales ss ON mc.c_customer_sk = ss.ss_customer_sk JOIN customer_address_prefetch ca ON mc.c_current_addr_sk = ca.ca_address_sk JOIN store_prefetch s ON ca.ca_county = s.s_county AND ca.ca_state = s.s_state JOIN date_dim_prefetch_revenue ddr ON ss.ss_sold_date_sk = ddr.d_date_sk GROUP BY mc.c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Prefilter all selective dimensions (date_dim, item, customer, customer_address, store) into separate CTEs and join explicitly, creating tiny hash tables before fact-table scans."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.8,
      "semantic_passed": true,
      "error": null,
      "original_ms": 39.4,
      "patch_ms": 49.5,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales INNER JOIN item ON cs_or_ws_sales.item_sk = item.i_item_sk INNER JOIN date_dim ON cs_or_ws_sales.sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON cs_or_ws_sales.customer_sk = customer.c_customer_sk WHERE item.i_category = 'Home' AND item.i_class = 'curtains/drapes' AND date_dim.d_moy = 5 AND date_dim.d_year = 1998 AND cs_or_ws_sales.wholesale_cost BETWEEN 70 AND 100 AND customer.c_birth_year BETWEEN 1942 AND 1955), date_range AS (SELECT (SELECT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AS start_seq, (SELECT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AS end_seq), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk INNER JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk INNER JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk INNER JOIN date_range ON date_dim.d_month_seq BETWEEN date_range.start_seq AND date_range.end_seq WHERE store_sales.ss_wholesale_cost BETWEEN 70 AND 100 AND store.s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p04": "Limit  (rows=0, time=134.029)\n  Sort  (rows=0, time=134.028)\n    Aggregate  (rows=0, time=134.004)\n      Sort  (rows=0, time=134.002)\n        Subquery Scan (my_revenue)  (rows=0, time=133.992)\n          Aggregate  (rows=0, time=133.99)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows",
    "p01": "Limit  (rows=0, time=124.162)\n  Index Only Scan on date_dim  (rows=31, time=0.204)\n  Sort  (rows=0, time=124.154)\n    Aggregate  (rows=0, time=124.116)\n      Sort  (rows=0, time=124.112)\n        Subquery Scan (my_revenue)  (rows=0, time=124.104)\n          Aggregate  (rows=0, time=124.1)\n            Aggregate  (rows=1, time=0.104)\n              Index Only Scan on date_dim (date_dim_1)  (rows=31, time=0.085)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_",
    "p03": "Limit  (rows=0, time=8327.228)\n  Sort  (rows=0, time=8327.226)\n    Aggregate  (rows=0, time=8327.211)\n      Sort  (rows=0, time=8327.209)\n        Subquery Scan (my_revenue)  (rows=0, time=8327.203)\n          Aggregate  (rows=0, time=8327.2)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  ",
    "p02": "Limit  (rows=0, time=132.813)\n  Sort  (rows=0, time=132.81)\n    Aggregate  (rows=0, time=132.749)\n      Sort  (rows=0, time=132.747)\n        Subquery Scan (my_revenue)  (rows=0, time=132.733)\n          Aggregate  (rows=0, time=132.731)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows",
    "compile_p1": "Limit  (rows=0, time=61.605)\n  Sort  (rows=0, time=61.604)\n    Aggregate  (rows=0, time=61.556)\n      Sort  (rows=0, time=61.555)\n        Subquery Scan (my_revenue)  (rows=0, time=61.521)\n          Aggregate  (rows=0, time=61.52)\n            Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows=0, time=61.518)\n              Nested Loop  (rows=0, time=61.517)\n                Nested Loop "
  }
}