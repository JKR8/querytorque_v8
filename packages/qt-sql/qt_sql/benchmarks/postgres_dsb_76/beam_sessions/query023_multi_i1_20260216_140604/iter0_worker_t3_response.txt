{
  "plan_id": "postgres_explicit_join_materialized_frequent_items",
  "dialect": "postgres",
  "description": "Convert comma joins to explicit INNER JOINs and restructure CTEs for better join ordering. Materialize frequent_ss_items and max_store_sales with explicit JOINs to improve cardinality estimation and enable dimension-table-first join strategies.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "frequent_ss_items"
      },
      "payload": {
        "sql_fragment": "frequent_ss_items AS (SELECT SUBSTRING(i_item_desc, 1, 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM item INNER JOIN store_sales ON ss_item_sk = i_item_sk INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports') GROUP BY SUBSTRING(i_item_desc, 1, 30), i_item_sk, d_date HAVING COUNT(*) > 4)"
      },
      "description": "Replace frequent_ss_items CTE with explicit JOINs"
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "max_store_sales"
      },
      "payload": {
        "sql_fragment": "max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM date_dim INNER JOIN store_sales ON ss_sold_date_sk = d_date_sk INNER JOIN customer ON ss_customer_sk = c_customer_sk WHERE d_year = 1998 AND ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c_customer_sk) tmp1)"
      },
      "description": "Replace max_store_sales CTE with explicit JOINs"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "best_ss_customer"
      },
      "payload": {
        "sql_fragment": "best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM customer INNER JOIN store_sales ON ss_customer_sk = c_customer_sk WHERE c_birth_year BETWEEN 1934 AND 1940 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95 / 100.0) * (SELECT * FROM max_store_sales))"
      },
      "description": "Replace best_ss_customer CTE with explicit JOINs"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "(SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales INNER JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 1998 AND d_moy = 10 AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_wholesale_cost BETWEEN 11 AND 21 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 1998 AND d_moy = 10 AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_wholesale_cost BETWEEN 11 AND 21) tmp2"
      },
      "description": "Replace main query FROM clause with explicit JOINs"
    }
  ]
}