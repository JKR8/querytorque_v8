{
  "plan_id": "postgres_preaggregate_store_sales_for_frequent_items",
  "dialect": "postgres",
  "description": "Pre-aggregate store_sales before joining with item and date_dim to reduce data volume for frequent_ss_items CTE. This pushes aggregation before the join, reducing row count early.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preagg_store_sales",
        "cte_query_sql": "SELECT ss_item_sk, ss_sold_date_sk, COUNT(*) AS cnt FROM store_sales GROUP BY ss_item_sk, ss_sold_date_sk HAVING COUNT(*) > 4"
      },
      "description": "Insert pre-aggregated store_sales CTE with count and grouping on join keys"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "CTE_Q_S0_frequent_ss_items"
      },
      "payload": {
        "from_sql": "preagg_store_sales JOIN item ON i_item_sk = preagg_store_sales.ss_item_sk JOIN date_dim ON d_date_sk = preagg_store_sales.ss_sold_date_sk"
      },
      "description": "Replace FROM clause in frequent_ss_items to use pre-aggregated CTE"
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "CTE_Q_S0_frequent_ss_items",
        "by_anchor_hash": "89fc2fb260a938e8"
      },
      "payload": {
        "expr_sql": "d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports')"
      },
      "description": "Retain original filter conditions on dimensions after join"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_frequent_ss_items"
      },
      "payload": {
        "sql_fragment": "SELECT SUBSTRING(i_item_desc FROM 1 FOR 30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, preagg_store_sales.cnt FROM preagg_store_sales JOIN item ON i_item_sk = preagg_store_sales.ss_item_sk JOIN date_dim ON d_date_sk = preagg_store_sales.ss_sold_date_sk WHERE d_year = 1998 AND i_manager_id BETWEEN 81 AND 100 AND i_category IN ('Children', 'Men', 'Sports')"
      },
      "description": "Replace full body of frequent_ss_items to reflect new structure"
    }
  ]
}