[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02,p03",
    "strategy": "Foundation plus explicit join conversion",
    "hypothesis": "Original plan shows 3x sequential scans on date_dim and nested loops dominating runtime. Precomputing filtered dimensions via CTEs should eliminate redundant scans. Converting comma joins to explicit INNER JOIN syntax helps optimizer recognize join dependencies. BDA shows workers failed due to literal mismatches - this preserves exact values.",
    "target_ir": "Top-level WITH date_cte/cust_cte; subqueries converted to explicit INNER JOINs on CTEs; preserved EXCEPT structure",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH date_cte AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11), cust_cte AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961) SELECT COUNT(*) FROM ((SELECT DISTINCT cust_cte.c_last_name, cust_cte.c_first_name, date_cte.d_date FROM store_sales INNER JOIN date_cte ON store_sales.ss_sold_date_sk = date_cte.d_date_sk INNER JOIN cust_cte ON store_sales.ss_customer_sk = cust_cte.c_customer_sk WHERE store_sales.ss_list_price BETWEEN 242 AND 271 AND store_sales.ss_wholesale_cost BETWEEN 35 AND 45) EXCEPT (SELECT DISTINCT cust_cte.c_last_name, cust_cte.c_first_name, date_cte.d_date FROM catalog_sales INNER JOIN date_cte ON catalog_sales.cs_sold_date_sk = date_cte.d_date_sk INNER JOIN cust_cte ON catalog_sales.cs_bill_customer_sk = cust_cte.c_customer_sk WHERE catalog_sales.cs_list_price BETWEEN 242 AND 271 AND catalog_sales.cs_wholesale_cost BETWEEN 35 AND 45) EXCEPT (SELECT DISTINCT cust_cte.c_last_name, cust_cte.c_first_name, date_cte.d_date FROM web_sales INNER JOIN date_cte ON web_sales.ws_sold_date_sk = date_cte.d_date_sk INNER JOIN cust_cte ON web_sales.ws_bill_customer_sk = cust_cte.c_customer_sk WHERE web_sales.ws_list_price BETWEEN 242 AND 271 AND web_sales.ws_wholesale_cost BETWEEN 35 AND 45)) AS cool_cust"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p05,p12",
    "strategy": "Alternative pathway with anti-join rewrite",
    "hypothesis": "EXCEPT operations show high sort costs in original plan. Converting to NOT EXISTS avoids materializing full intermediate sets. Precomputing store path as CTE enables direct anti-joins while preserving correlation on name+date. BDA shows decorrelation was attempted but failed validation - this preserves all filters.",
    "target_ir": "Store results in CTE; filter via NOT EXISTS anti-joins for catalog/web paths; preserve key correlation",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH store_customers AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk WHERE date_dim.d_month_seq BETWEEN 1214 AND 1214+11 AND store_sales.ss_list_price BETWEEN 242 AND 271 AND customer.c_birth_year BETWEEN 1955 AND 1961 AND store_sales.ss_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM store_customers sc WHERE NOT EXISTS (SELECT 1 FROM catalog_sales INNER JOIN date_dim d2 ON catalog_sales.cs_sold_date_sk = d2.d_date_sk INNER JOIN customer c2 ON catalog_sales.cs_bill_customer_sk = c2.c_customer_sk WHERE d2.d_month_seq BETWEEN 1214 AND 1214+11 AND catalog_sales.cs_list_price BETWEEN 242 AND 271 AND c2.c_birth_year BETWEEN 1955 AND 1961 AND catalog_sales.cs_wholesale_cost BETWEEN 35 AND 45 AND c2.c_last_name = sc.c_last_name AND c2.c_first_name = sc.c_first_name AND d2.d_date = sc.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales INNER JOIN date_dim d3 ON web_sales.ws_sold_date_sk = d3.d_date_sk INNER JOIN customer c3 ON web_sales.ws_bill_customer_sk = c3.c_customer_sk WHERE d3.d_month_seq BETWEEN 1214 AND 1214+11 AND web_sales.ws_list_price BETWEEN 242 AND 271 AND c3.c_birth_year BETWEEN 1955 AND 1961 AND web_sales.ws_wholesale_cost BETWEEN 35 AND 45 AND c3.c_last_name = sc.c_last_name AND c3.c_first_name = sc.c_first_name AND d3.d_date = sc.d_date)"
        }
      }
    ]
  }
]