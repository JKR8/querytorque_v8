[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02,p03",
    "strategy": "Foundation plus explicit joins",
    "hypothesis": "Original plan shows 3 sequential scans on date_dim (340ms/147ms/145ms) with identical filters. Pre-filtering dimensions into CTEs avoids redundant scans. Converting comma joins to explicit syntax improves join planning.",
    "target_ir": "CTE for filtered_date and filtered_customer; explicit INNER JOINs in all subqueries; preserved EXCEPT structure",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1214 AND 1214+11), filtered_customer AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1955 AND 1961) SELECT COUNT(*) FROM ((SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk WHERE ss_list_price BETWEEN 242 AND 271 AND ss_wholesale_cost BETWEEN 35 AND 45) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales INNER JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk WHERE cs_list_price BETWEEN 242 AND 271 AND cs_wholesale_cost BETWEEN 35 AND 45) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales INNER JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk WHERE ws_list_price BETWEEN 242 AND 271 AND ws_wholesale_cost BETWEEN 35 AND 45)) AS cool_cust"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p05,p12",
    "strategy": "Alternative pathway",
    "hypothesis": "EXCEPT operations show high sort costs (5799ms/5168ms/3553ms). NOT EXISTS rewrite avoids materialization and uses anti-joins. Store_sales path dominates runtime so anchor with CTE.",
    "target_ir": "CTE for store_sales results; NOT EXISTS anti-joins for catalog/web sales; key correlation on (c_last_name, c_first_name, d_date)",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH store_customers AS (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk WHERE d_month_seq BETWEEN 1214 AND 1214+11 AND ss_list_price BETWEEN 242 AND 271 AND c_birth_year BETWEEN 1955 AND 1961 AND ss_wholesale_cost BETWEEN 35 AND 45) SELECT COUNT(*) FROM store_customers sc WHERE NOT EXISTS (SELECT 1 FROM catalog_sales INNER JOIN date_dim ON catalog_sales.cs_sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON catalog_sales.cs_bill_customer_sk = customer.c_customer_sk WHERE d_month_seq BETWEEN 1214 AND 1214+11 AND cs_list_price BETWEEN 242 AND 271 AND c_birth_year BETWEEN 1955 AND 1961 AND cs_wholesale_cost BETWEEN 35 AND 45 AND customer.c_last_name = sc.c_last_name AND customer.c_first_name = sc.c_first_name AND date_dim.d_date = sc.d_date) AND NOT EXISTS (SELECT 1 FROM web_sales INNER JOIN date_dim ON web_sales.ws_sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON web_sales.ws_bill_customer_sk = customer.c_customer_sk WHERE d_month_seq BETWEEN 1214 AND 1214+11 AND ws_list_price BETWEEN 242 AND 271 AND c_birth_year BETWEEN 1955 AND 1961 AND ws_wholesale_cost BETWEEN 35 AND 45 AND customer.c_last_name = sc.c_last_name AND customer.c_first_name = sc.c_first_name AND date_dim.d_date = sc.d_date)"
        }
      }
    ]
  }
]