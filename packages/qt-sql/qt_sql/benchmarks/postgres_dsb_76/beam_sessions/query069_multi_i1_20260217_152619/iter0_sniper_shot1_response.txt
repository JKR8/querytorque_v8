[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p08",
    "strategy": "Comma-join conversion plus anti-join decorrelation",
    "hypothesis": "Converting comma joins to explicit INNER JOINs addresses PostgreSQL's comma-join weakness while anti-join CTEs eliminate correlated subqueries. This should reduce nested loop overhead by precomputing exclusion sets and enabling better join ordering.",
    "target_ir": "Explicit JOINs with CTE-based anti-joins replacing NOT EXISTS",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH qualifying_web AS (\n  SELECT DISTINCT ws_bill_customer_sk AS customer_sk\n  FROM web_sales\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12\n    AND ws_list_price BETWEEN 80 AND 169\n),\nqualifying_catalog AS (\n  SELECT DISTINCT cs_ship_customer_sk AS customer_sk\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12\n    AND cs_list_price BETWEEN 80 AND 169\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  COUNT(*) cnt1,\n  cd_purchase_estimate,\n  COUNT(*) cnt2,\n  cd_credit_rating,\n  COUNT(*) cnt3\nFROM customer c\nJOIN customer_address ca \n  ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd \n  ON cd.cd_demo_sk = c.c_current_cdemo_sk\nLEFT JOIN qualifying_web w \n  ON c.c_customer_sk = w.customer_sk\nLEFT JOIN qualifying_catalog cat \n  ON c.c_customer_sk = cat.customer_sk\nWHERE ca_state IN ('CO','NC','TX')\n  AND cd_marital_status IN ('S', 'M', 'U')\n  AND cd_education_status IN ('Primary', 'College')\n  AND EXISTS (\n    SELECT 1\n    FROM store_sales\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE c.c_customer_sk = ss_customer_sk\n      AND d_year = 2002\n      AND d_moy BETWEEN 10 AND 12\n      AND ss_list_price BETWEEN 80 AND 169\n  )\n  AND w.customer_sk IS NULL\n  AND cat.customer_sk IS NULL\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p03,p06",
    "strategy": "Shared date CTE with explicit joins",
    "hypothesis": "Materializing date range once avoids redundant date_dim scans. Combined with explicit JOIN syntax, this reduces repeated computation while addressing comma-join weakness. Should optimize date predicate handling across all sales channels.",
    "target_ir": "CTE-isolated date dimension with explicit JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH date_range AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 2002\n    AND d_moy BETWEEN 10 AND 12\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  COUNT(*) cnt1,\n  cd_purchase_estimate,\n  COUNT(*) cnt2,\n  cd_credit_rating,\n  COUNT(*) cnt3\nFROM customer c\nJOIN customer_address ca \n  ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd \n  ON cd.cd_demo_sk = c.c_current_cdemo_sk\nWHERE ca_state IN ('CO','NC','TX')\n  AND cd_marital_status IN ('S', 'M', 'U')\n  AND cd_education_status IN ('Primary', 'College')\n  AND EXISTS (\n    SELECT 1\n    FROM store_sales\n    JOIN date_range dr ON ss_sold_date_sk = dr.d_date_sk\n    WHERE c.c_customer_sk = ss_customer_sk\n      AND ss_list_price BETWEEN 80 AND 169\n  )\n  AND NOT EXISTS (\n    SELECT 1\n    FROM web_sales\n    JOIN date_range dr ON ws_sold_date_sk = dr.d_date_sk\n    WHERE c.c_customer_sk = ws_bill_customer_sk\n      AND ws_list_price BETWEEN 80 AND 169\n  )\n  AND NOT EXISTS (\n    SELECT 1\n    FROM catalog_sales\n    JOIN date_range dr ON cs_sold_date_sk = dr.d_date_sk\n    WHERE c.c_customer_sk = cs_ship_customer_sk\n      AND cs_list_price BETWEEN 80 AND 169\n  )\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating\nLIMIT 100;"
        }
      }
    ]
  }
]