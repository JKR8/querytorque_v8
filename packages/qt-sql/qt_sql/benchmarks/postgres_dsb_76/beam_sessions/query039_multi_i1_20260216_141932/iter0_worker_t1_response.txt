{
  "plan_id": "postgres_early_filtering_inv_cte_d_moy_pushdown",
  "dialect": "postgres",
  "description": "Push d_moy filter into the CTE to reduce aggregation workload. Only d_moy=2 and d_moy=3 are used in the main query, so restrict CTE to those months.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_inv"
      },
      "payload": {
        "sql_fragment": "select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Jewelry', 'Men')\n        and i_manager_id BETWEEN 81 and 100\n        and inv_quantity_on_hand between 0 and 200\n        and d_moy IN (2,3)\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1"
      },
      "description": "Replace CTE body to include d_moy filter early"
    },
    {
      "step_id": "s2",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "Q_S0",
        "by_anchor_hash": "7c17a3840cbbb8b9"
      },
      "payload": {
        "expr_sql": "inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy=2 AND inv2.d_moy=3"
      },
      "description": "Update main query WHERE clause to use explicit d_moy values"
    }
  ]
}