{
  "plan_id": "wildcard_postgres_self_join_elimination_covariance",
  "dialect": "postgres",
  "description": "Eliminate self-join on CTE 'inv' by decomposing into filtered base data, monthly aggregations, and covariance filtering. Enables single-pass aggregation and avoids duplicate scans of the CTE.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_inventory",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, inv_quantity_on_hand FROM inventory INNER JOIN item ON inv_item_sk = i_item_sk INNER JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk INNER JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200"
      },
      "description": "Insert CTE 'filtered_inventory' to pre-filter base data"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "monthly_stats",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM filtered_inventory GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Insert CTE 'monthly_stats' for pre-aggregated monthly statistics"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "valid_covariance",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM monthly_stats WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Insert CTE 'valid_covariance' to filter rows with high coefficient of variation"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "valid_covariance inv1 JOIN valid_covariance inv2 ON inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk WHERE inv1.d_moy = 2 AND inv2.d_moy = 3"
      },
      "description": "Replace self-join FROM clause with explicit JOIN on valid_covariance"
    },
    {
      "step_id": "s5",
      "op": "delete_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "7c17a3840cbbb8b9"
      },
      "description": "Remove original WHERE clause (conditions moved to JOIN and CTEs)"
    },
    {
      "step_id": "s6",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "cte_name": "filtered_inventory",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, inv_quantity_on_hand FROM inventory INNER JOIN item ON inv_item_sk = i_item_sk INNER JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk INNER JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200"
      },
      "description": "Insert CTE 'filtered_inventory' to pre-filter base data"
    },
    {
      "step_id": "s7",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "cte_name": "monthly_stats",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM filtered_inventory GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Insert CTE 'monthly_stats' for pre-aggregated monthly statistics"
    },
    {
      "step_id": "s8",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "cte_name": "valid_covariance",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM monthly_stats WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Insert CTE 'valid_covariance' to filter rows with high coefficient of variation"
    },
    {
      "step_id": "s9",
      "op": "replace_from",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "from_sql": "valid_covariance inv1 JOIN valid_covariance inv2 ON inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk WHERE inv1.d_moy = 2 AND inv2.d_moy = 3 AND inv1.cov > 1.5"
      },
      "description": "Replace self-join FROM clause with explicit JOIN on valid_covariance and additional cov filter"
    },
    {
      "step_id": "s10",
      "op": "delete_expr_subtree",
      "target": {
        "by_node_id": "S1",
        "by_anchor_hash": "6b5ed1ac84f1ced1"
      },
      "description": "Remove original WHERE clause (conditions moved to JOIN and CTEs)"
    }
  ]
}