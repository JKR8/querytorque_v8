{
  "plan_id": "gold_postgres_window_self_join_elimination_cte_materialization",
  "dialect": "postgres",
  "description": "Eliminate self-join by using LAG window function to compute consecutive month metrics in a single CTE scan. Materialize the CTE to prevent recomputation.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "ceb681f4fee117f7"
      },
      "payload": {
        "expr_sql": "CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
      },
      "description": "Retain existing filter condition on coefficient of variation"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Jewelry', 'Men')\n        and i_manager_id BETWEEN 81 and 100\n        and inv_quantity_on_hand between 0 and 200\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1) inv"
      },
      "description": "Rewrite FROM clause to inline the CTE"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "WITH inv AS MATERIALIZED (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,\n            stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean,\n            CASE mean WHEN 0 THEN NULL ELSE stdev/mean END cov,\n            LAG(stdev,1) OVER(PARTITION BY w_warehouse_sk,i_item_sk ORDER BY d_moy) prev_stdev,\n            LAG(mean,1) OVER(PARTITION BY w_warehouse_sk,i_item_sk ORDER BY d_moy) prev_mean,\n            LAG(CASE mean WHEN 0 THEN NULL ELSE stdev/mean END,1) OVER(PARTITION BY w_warehouse_sk,i_item_sk ORDER BY d_moy) prev_cov\n      FROM inventory\n          INNER JOIN item ON inv_item_sk = i_item_sk\n          INNER JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk\n          INNER JOIN date_dim ON inv_date_sk = d_date_sk\n      WHERE d_year =2002\n        AND i_category IN ('Jewelry', 'Men')\n        AND i_manager_id BETWEEN 81 and 100\n        AND inv_quantity_on_hand between 0 and 200\n      GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy)\nSELECT w_warehouse_sk,i_item_sk,d_moy,mean,cov,\n       w_warehouse_sk,i_item_sk,d_moy+1,prev_mean,prev_cov\nFROM inv\nWHERE d_moy=2 AND cov > 1.5\nORDER BY w_warehouse_sk,i_item_sk,d_moy,mean,cov,d_moy+1,prev_mean,prev_cov"
      },
      "description": "Replace entire query body with optimized version using LAG window function and explicit joins"
    }
  ]
}