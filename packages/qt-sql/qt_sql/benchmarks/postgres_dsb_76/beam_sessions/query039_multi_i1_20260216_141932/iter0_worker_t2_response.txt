{
  "plan_id": "gold_postgres_self_join_elimination_cte_materialization",
  "dialect": "postgres",
  "description": "Eliminate self-join on CTE 'inv' by materializing monthly aggregates in a single pass. Convert comma joins to explicit INNER JOINs and pre-filter dimensions.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "monthly_data",
        "cte_query_sql": "SELECT w_warehouse_sk, i_item_sk, d_moy, AVG(inv_quantity_on_hand) AS mean, STDDEV_SAMP(inv_quantity_on_hand) AS stdev FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND d_moy IN (2, 3) GROUP BY w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Insert CTE 'monthly_data' for aggregated monthly inventory data"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "pivoted_data",
        "cte_query_sql": "SELECT w_warehouse_sk, i_item_sk, AVG(CASE WHEN d_moy = 2 THEN inv_quantity_on_hand END) AS mean_2, STDDEV_SAMP(CASE WHEN d_moy = 2 THEN inv_quantity_on_hand END) AS stdev_2, AVG(CASE WHEN d_moy = 3 THEN inv_quantity_on_hand END) AS mean_3, STDDEV_SAMP(CASE WHEN d_moy = 3 THEN inv_quantity_on_hand END) AS stdev_3 FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND d_moy IN (2, 3) GROUP BY w_warehouse_sk, i_item_sk"
      },
      "description": "Insert CTE 'pivoted_data' for conditional aggregation of months 2 and 3"
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "pivoted_data"
      },
      "description": "Replace FROM clause with optimized pivoted_data CTE"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "SELECT w_warehouse_sk, i_item_sk, 2 AS d_moy, mean_2 AS mean, CASE WHEN mean_2 = 0 THEN NULL ELSE stdev_2 / mean_2 END AS cov, w_warehouse_sk, i_item_sk, 3 AS d_moy, mean_3 AS mean, CASE WHEN mean_3 = 0 THEN NULL ELSE stdev_3 / mean_3 END AS cov FROM pivoted_data WHERE (CASE WHEN mean_2 = 0 THEN NULL ELSE stdev_2 / mean_2 END) > 1 AND (CASE WHEN mean_3 = 0 THEN NULL ELSE stdev_3 / mean_3 END) > 1"
      },
      "description": "Replace main query body with simplified selection from pivoted_data"
    },
    {
      "step_id": "s5",
      "op": "delete_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "7c17a3840cbbb8b9"
      },
      "description": "Remove original WHERE clause (conditions moved to CTEs)"
    }
  ]
}