[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "original",
    "strategy": "Pre-filter dimensions and convert to explicit joins",
    "hypothesis": "Original nested loops stem from late dimension filtering and comma-join syntax. Pre-filtering small dimensions (date_dim, customer_address, cd1) via CTEs and converting to explicit joins enables hash joins and reduces row counts early. Retains OR conditions but applies them after dimension reduction.",
    "target_ir": "CTEs for date_dim, customer_address, cd1; explicit JOINs replacing comma joins; WHERE clause simplified to retain only OR conditions on sales_price and net_profit",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_ca",
          "cte_query_sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND (ca_state IN ('NC','PA','TX') OR ca_state IN ('AR','CO','NY') OR ca_state IN ('IA','IL','TX'))"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_cd1",
          "cte_query_sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM web_sales\nJOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\nJOIN web_returns ON web_sales.ws_item_sk = web_returns.wr_item_sk AND web_sales.ws_order_number = web_returns.wr_order_number\nJOIN filtered_ca ON web_returns.wr_refunded_addr_sk = filtered_ca.ca_address_sk\nJOIN filtered_cd1 cd1 ON web_returns.wr_refunded_cdemo_sk = cd1.cd_demo_sk\nJOIN customer_demographics cd2 ON web_returns.wr_returning_cdemo_sk = cd2.cd_demo_sk AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status\nJOIN web_page ON web_sales.ws_web_page_sk = web_page.wp_web_page_sk\nJOIN reason ON web_returns.wr_reason_sk = reason.r_reason_sk"
        }
      },
      {
        "step_id": "s5",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WHERE \n(\n  (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND web_sales.ws_sales_price BETWEEN 100.00 AND 150.00)\n  OR\n  (cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND web_sales.ws_sales_price BETWEEN 50.00 AND 100.00)\n  OR\n  (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND web_sales.ws_sales_price BETWEEN 150.00 AND 200.00)\n)\nAND\n(\n  (filtered_ca.ca_country = 'United States' AND filtered_ca.ca_state IN ('NC','PA','TX') AND web_sales.ws_net_profit BETWEEN 100 AND 200)\n  OR\n  (filtered_ca.ca_country = 'United States' AND filtered_ca.ca_state IN ('AR','CO','NY') AND web_sales.ws_net_profit BETWEEN 150 AND 300)\n  OR\n  (filtered_ca.ca_country = 'United States' AND filtered_ca.ca_state IN ('IA','IL','TX') AND web_sales.ws_net_profit BETWEEN 50 AND 250)\n)"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "original",
    "strategy": "Early fact table reduction with sales_price filter",
    "hypothesis": "Pre-filtering web_sales by date and sales_price OR condition reduces fact rows before joining dimensions. Combined with customer_address CTE to minimize nested loops. Removes redundant dimension checks in WHERE by leveraging CTE pre-filtering.",
    "target_ir": "CTE for web_sales pre-filtered by date and sales_price OR; CTE for customer_address; explicit JOINs; simplified WHERE for net_profit OR and cd status matching",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_web_sales",
          "cte_query_sql": "SELECT ws.* FROM web_sales ws JOIN date_dim ON ws.ws_sold_date_sk = date_dim.d_date_sk AND date_dim.d_year = 2000 WHERE (ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (ws.ws_sales_price BETWEEN 150.00 AND 200.00)"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_ca",
          "cte_query_sql": "SELECT ca_address_sk, ca_state FROM customer_address WHERE ca_country = 'United States' AND (ca_state IN ('NC','PA','TX') OR ca_state IN ('AR','CO','NY') OR ca_state IN ('IA','IL','TX'))"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM filtered_web_sales ws\nJOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number\nJOIN filtered_ca ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk\nJOIN customer_demographics cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk\nJOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk\nJOIN reason r ON wr.wr_reason_sk = r.r_reason_sk"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WHERE \n(\n  (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status)\n  OR\n  (cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status)\n  OR\n  (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status)\n)\nAND\n(\n  (ca.ca_state IN ('NC','PA','TX') AND ws.ws_net_profit BETWEEN 100 AND 200)\n  OR\n  (ca.ca_state IN ('AR','CO','NY') AND ws.ws_net_profit BETWEEN 150 AND 300)\n  OR\n  (ca.ca_state IN ('IA','IL','TX') AND ws.ws_net_profit BETWEEN 50 AND 250)\n)"
        }
      }
    ]
  }
]