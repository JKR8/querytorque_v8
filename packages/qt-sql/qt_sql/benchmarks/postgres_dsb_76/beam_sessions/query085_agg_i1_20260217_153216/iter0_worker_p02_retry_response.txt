{
  "probe_id": "p02",
  "transform_id": "date_cte_isolate",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Isolate date_dim filtering into a CTE to enable early reduction of web_sales rows before joining other dimensions, preserving all original filter semantics.",
  "reasoning_trace": [
    "The previous attempt incorrectly removed the full WHERE clause instead of only the date condition.",
    "This caused loss of critical filter literals such as 'AR', 'CO', 'College', and numeric ranges like 150.00â€“200.00.",
    "Must preserve all non-date filters exactly while only extracting d_year=2000 into the CTE logic."
  ],
  "target_ir": "CTE for filtered date_dim keys joined explicitly with web_sales; original WHERE preserved except for date condition.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "web_sales JOIN filtered_dates fd ON ws_sold_date_sk = fd.d_date_sk, web_returns, web_page, customer_demographics cd1, customer_demographics cd2, customer_address, reason"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0", "by_anchor_hash": "edf10a498f1ee83a"},
      "payload": {
        "expr_sql": "ws_web_page_sk = wp_web_page_sk AND ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number AND cd1.cd_demo_sk = wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr_returning_cdemo_sk AND ca_address_sk = wr_refunded_addr_sk AND r_reason_sk = wr_reason_sk AND ((cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca_country = 'United States' AND ca_state IN ('NC', 'PA', 'TX') AND ws_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'CO', 'NY') AND ws_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'TX') AND ws_net_profit BETWEEN 50 AND 250))"
      }
    }
  ]
}