[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02,p03,p10",
    "strategy": "Explicit joins with pre-filtered dimension CTEs",
    "hypothesis": "Original nested loops (3551ms) show comma-join weakness. Convert to explicit joins for better planning. Pre-filter date_dim and cd1 to reduce rows early. BDA shows workers attempted similar transforms but failed validation - this combines compatible passes with syntax fixes.",
    "target_ir": "CTE for date_dim and cd1, explicit JOINs in FROM clause",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_dates",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_cd1",
          "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'College') OR (cd_marital_status = 'W' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary')"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN filtered_cd1 cd1 ON wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN customer_demographics cd2 ON wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN customer_address ON wr_refunded_addr_sk = ca_address_sk JOIN reason ON wr_reason_sk = r_reason_sk"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p06,p09",
    "strategy": "Fact-first filtering via CTE with explicit joins",
    "hypothesis": "Nested loop on web_sales (2034ms) dominates. Isolate date_dim join in CTE to reduce fact rows early. Explicit joins prevent comma-join weakness. Avoids over-materializing dimensions while targeting the largest table first.",
    "target_ir": "CTE for date_dim+web_sales, explicit JOINs for remaining tables",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT ws_item_sk, ws_order_number, ws_quantity, ws_web_page_sk, ws_sales_price, ws_net_profit FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2000"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "filtered_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN customer_demographics cd1 ON wr.wr_refunded_cdemo_sk = cd1.cd_demo_sk JOIN customer_demographics cd2 ON wr.wr_returning_cdemo_sk = cd2.cd_demo_sk JOIN customer_address ca ON wr.wr_refunded_addr_sk = ca.ca_address_sk JOIN reason r ON wr.wr_reason_sk = r.r_reason_sk"
        }
      }
    ]
  }
]