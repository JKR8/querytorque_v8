{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate web_sales and web_returns on join keys (ws_item_sk, ws_order_number) to reduce row count before dimension joins and enable hash joins.",
  "reasoning_trace": [
    "Nested loops dominate due to late filtering of large fact tables",
    "OR conditions in WHERE may block index usage but bitmap scans are acceptable per profile",
    "web_sales and web_returns are joined on (ws_item_sk, ws_order_number) = (wr_item_sk, wr_order_number)",
    "Group-by keys do not align with join keys; however, avg() can be computed post-join safely if preserved"
  ],
  "target_ir": "CTE for pre-aggregated web_sales/web_returns grouped by (ws_item_sk, ws_order_number), joined explicitly with dimensions using INNER JOIN syntax",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "sales_return_summary",
        "cte_query_sql": "SELECT ws_item_sk, ws_order_number, AVG(ws_quantity) AS avg_ws_quantity, AVG(wr_refunded_cash) AS avg_wr_refunded_cash, AVG(wr_fee) AS avg_wr_fee FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number GROUP BY ws_item_sk, ws_order_number"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "sales_return_summary srs JOIN web_page wp ON srs.ws_item_sk = wp.wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = srs.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = srs.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = srs.wr_refunded_addr_sk JOIN date_dim d ON d.d_date_sk = srs.ws_sold_date_sk JOIN reason r ON r.r_reason_sk = srs.wr_reason_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "( ( cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND srs.avg_ws_quantity BETWEEN 100.00 AND 150.00 ) OR ( cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND srs.avg_ws_quantity BETWEEN 50.00 AND 100.00 ) OR ( cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND srs.avg_ws_quantity BETWEEN 150.00 AND 200.00 ) ) AND ( ( ca.ca_country = 'United States' AND ca.ca_state IN ('NC', 'PA', 'TX') AND srs.avg_ws_quantity BETWEEN 100 AND 200 ) OR ( ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'CO', 'NY') AND srs.avg_ws_quantity BETWEEN 150 AND 300 ) OR ( ca.ca_country = 'United States' AND ca.ca_state IN ('IA', 'IL', 'TX') AND srs.avg_ws_quantity BETWEEN 50 AND 250 ) ) AND d.d_year = 2000"
      }
    }
  ]
}