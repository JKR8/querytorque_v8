{
  "probe_id": "p04",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate web_sales and web_returns on (ws_item_sk, ws_order_number) to reduce input rows to subsequent joins and avoid nested loop explosion.",
  "reasoning_trace": [
    "Nested loops dominate due to late filtering of large fact tables",
    "OR conditions may block index usage but bitmap scans are acceptable per profile",
    "Previous attempt incorrectly projected avg() in CTE instead of preserving base columns required for WHERE clause filters",
    "Must preserve access to ws_net_profit, ws_sales_price, and ws_web_page_sk for outer query predicates"
  ],
  "target_ir": "CTE groups web_sales and web_returns by join keys, preserving all necessary scalar columns for outer filters; explicit JOIN syntax replaces comma-join",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "sales_return_summary",
        "cte_query_sql": "SELECT ws_item_sk, ws_order_number, ws_net_profit, ws_sales_price, ws_web_page_sk, wr_refunded_cdemo_sk, wr_returning_cdemo_sk, wr_refunded_addr_sk, wr_reason_sk, ws_sold_date_sk, ws_quantity, wr_refunded_cash, wr_fee FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "sales_return_summary srs JOIN web_page wp ON srs.ws_web_page_sk = wp.wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = srs.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = srs.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = srs.wr_refunded_addr_sk JOIN date_dim d ON d.d_date_sk = srs.ws_sold_date_sk JOIN reason r ON r.r_reason_sk = srs.wr_reason_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "( ( cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'College' AND cd1.cd_education_status = cd2.cd_education_status AND srs.ws_sales_price BETWEEN 100.00 AND 150.00 ) OR ( cd1.cd_marital_status = 'W' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Unknown' AND cd1.cd_education_status = cd2.cd_education_status AND srs.ws_sales_price BETWEEN 50.00 AND 100.00 ) OR ( cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND srs.ws_sales_price BETWEEN 150.00 AND 200.00 ) ) AND ( ( ca.ca_country = 'United States' AND ca.ca_state IN ('NC', 'PA', 'TX') AND srs.ws_net_profit BETWEEN 100 AND 200 ) OR ( ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'CO', 'NY') AND srs.ws_net_profit BETWEEN 150 AND 300 ) OR ( ca.ca_country = 'United States' AND ca.ca_state IN ('IA', 'IL', 'TX') AND srs.ws_net_profit BETWEEN 50 AND 250 ) ) AND d.d_year = 2000"
      }
    }
  ]
}