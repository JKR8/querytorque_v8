[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Consolidate repeated store_sales+date_dim scans into single CTE, compute both aggregates in one pass.",
    "hypothesis": "Primary hotspot is the duplicated scan of 145,949 rows. Probes p01 and p02 eliminated the repeated work by scanning store_sales+date_dim once, yielding 2x speedup with validated semantics.",
    "expected_explain_delta": "Replace two Nested Loop + Index Scan branches with one scan feeding both aggregates. Remove Merge Join between aggregates, replaced by direct joins from consolidated CTE.",
    "target_ir": "Add base_agg CTE; derive sb and sc from it; update final_select to join with store and item filters.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store", "item", "sb", "base_agg"],
          "outputs": ["s_store_name", "i_item_desc", "revenue", "i_current_price", "i_wholesale_cost", "i_brand"],
          "changed": true,
          "sql": "SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store s JOIN base_agg sc ON s.s_store_sk = sc.ss_store_sk JOIN item i ON i.i_item_sk = sc.ss_item_sk JOIN (SELECT ss_store_sk, AVG(revenue) AS ave FROM base_agg GROUP BY ss_store_sk) sb ON sb.ss_store_sk = sc.ss_store_sk WHERE sc.revenue <= 0.1 * sb.ave AND i.i_manager_id BETWEEN 80 AND 84 AND s.s_state IN ('IA','IL','NC') ORDER BY s.s_store_name, i.i_item_desc LIMIT 100"
        },
        {
          "node_id": "base_agg",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["ss_store_sk", "ss_item_sk", "revenue"],
          "changed": true,
          "sql": "SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq BETWEEN 1195 AND 1195 + 11 AND ss.ss_sales_price / ss.ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01 GROUP BY ss_store_sk, ss_item_sk"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p03",
    "strategy": "Pre-filter store and item dimensions early, then join with consolidated fact aggregates.",
    "hypothesis": "Secondary pathway pushes store and item filters before the join spine, reducing rows early. Combined with single-pass fact scan from p01 to address both hotspots.",
    "expected_explain_delta": "Sequential scans on store and item become selective index scans; Merge Join removed; final join uses preâ€‘filtered dimension CTEs.",
    "target_ir": "Add store_filtered and item_filtered CTEs; keep base_agg CTE; rewrite final_select to use filtered CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_filtered", "item_filtered", "sb", "base_agg"],
          "outputs": ["s_store_name", "i_item_desc", "revenue", "i_current_price", "i_wholesale_cost", "i_brand"],
          "changed": true,
          "sql": "SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store_filtered s JOIN base_agg sc ON s.s_store_sk = sc.ss_store_sk JOIN item_filtered i ON i.i_item_sk = sc.ss_item_sk JOIN (SELECT ss_store_sk, AVG(revenue) AS ave FROM base_agg GROUP BY ss_store_sk) sb ON sb.ss_store_sk = sc.ss_store_sk WHERE sc.revenue <= 0.1 * sb.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100"
        },
        {
          "node_id": "store_filtered",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk", "s_store_name"],
          "changed": true,
          "sql": "SELECT s_store_sk, s_store_name FROM store WHERE s_state IN ('IA','IL','NC')"
        },
        {
          "node_id": "item_filtered",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_desc", "i_current_price", "i_wholesale_cost", "i_brand"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand FROM item WHERE i_manager_id BETWEEN 80 AND 84"
        },
        {
          "node_id": "base_agg",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["ss_store_sk", "ss_item_sk", "revenue"],
          "changed": true,
          "sql": "SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq BETWEEN 1195 AND 1195 + 11 AND ss.ss_sales_price / ss.ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01 GROUP BY ss_store_sk, ss_item_sk"
        }
      ]
    }
  }
]