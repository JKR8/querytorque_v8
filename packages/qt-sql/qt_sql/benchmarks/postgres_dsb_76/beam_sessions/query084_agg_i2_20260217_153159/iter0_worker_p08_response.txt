{
  "probe_id": "p01",
  "transform_id": "prefetch_fact_join",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Staged filtering of dimensions via CTEs reduces large table scans and enables better join planning in PostgreSQL.",
  "reasoning_trace": [
    "Original query uses comma joins leading to poor join order and row estimation.",
    "Filter conditions on customer_address and income_band are selective and can be pushed into CTEs.",
    "Pre-joining filtered customer_address with customer reduces inner loop size for subsequent joins."
  ],
  "target_ir": "CTE chain filters customer_address and income_band, joins to customer; final query joins reduced customer set to store_returns.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_addresses",
        "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Mount Vernon'"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_customers",
        "cte_query_sql": "SELECT c_customer_sk, c_current_addr_sk, c_current_cdemo_sk, c_current_hdemo_sk, c_customer_id, coalesce(c_last_name,'') || ', ' || coalesce(c_first_name,'') as customername FROM customer JOIN filtered_addresses fa ON c_current_addr_sk = fa.ca_address_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "filtered_customers fc JOIN household_demographics hd ON hd.hd_demo_sk = fc.c_current_hdemo_sk JOIN income_band ib ON ib.ib_income_band_sk = hd.hd_income_band_sk JOIN customer_demographics cd ON cd.cd_demo_sk = fc.c_current_cdemo_sk JOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "ib_lower_bound >= 40374 AND ib_upper_bound <= 40374 + 50000"
      }
    }
  ]
}