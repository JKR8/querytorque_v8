[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p07",
    "strategy": "Explicit JOINs with filtered dimension CTEs",
    "hypothesis": "Original comma-joins prevent optimal join ordering. Pre-filtering customer_address (99 rows) and income_band (4 rows) in CTEs will reduce base scan costs. Explicit JOIN syntax enables better join reordering.",
    "target_ir": "CTE-filtered dimensions with explicit INNER JOIN chain",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_ca AS (\n  SELECT ca_address_sk\n  FROM customer_address\n  WHERE ca_city = 'Mount Vernon'\n),\nfiltered_ib AS (\n  SELECT ib_income_band_sk\n  FROM income_band\n  WHERE ib_lower_bound >= 40374 AND ib_upper_bound <= 90374\n)\nSELECT\n  c.c_customer_id AS customer_id,\n  COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername\nFROM customer c\nJOIN filtered_ca ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\nJOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk\nJOIN filtered_ib ib ON ib.ib_income_band_sk = hd.hd_income_band_sk\nJOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk\nORDER BY c.c_customer_id\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p04",
    "strategy": "Minimal CTE with explicit JOINs",
    "hypothesis": "Filtering only customer_address (most selective dimension) avoids CTE materialization overhead while enabling join reordering. Explicit JOINs resolve comma-join weaknesses without full dimension prefetch.",
    "target_ir": "Single CTE for customer_address with staged INNER JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_ca AS (\n  SELECT ca_address_sk\n  FROM customer_address\n  WHERE ca_city = 'Mount Vernon'\n)\nSELECT\n  c.c_customer_id AS customer_id,\n  COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername\nFROM filtered_ca ca\nJOIN customer c ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk\nJOIN income_band ib ON ib.ib_income_band_sk = hd.hd_income_band_sk\n  AND ib.ib_lower_bound >= 40374\n  AND ib.ib_upper_bound <= 90374\nJOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\nJOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk\nORDER BY c.c_customer_id\nLIMIT 100;"
        }
      }
    ]
  }
]