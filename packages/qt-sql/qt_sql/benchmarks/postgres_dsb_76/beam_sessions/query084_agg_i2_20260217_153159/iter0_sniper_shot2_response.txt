[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p07",
    "strategy": "Foundation plus explicit join conversion",
    "hypothesis": "Original shows sequential scans on customer and customer_address due to comma-join syntax preventing filter pushdown. Convert to explicit joins and pre-filter dimensions via CTEs to reduce scan volume. EXPLAIN should show index scans on customer_address and income_band instead of seq scans.",
    "target_ir": "CTEs for filtered dimensions + explicit INNER JOIN chain",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Mount Vernon'), filtered_income_band AS (SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 40374 AND ib_upper_bound <= 40374 + 50000) SELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM customer c INNER JOIN filtered_customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk INNER JOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk INNER JOIN filtered_income_band ib ON ib.ib_income_band_sk = hd.hd_income_band_sk INNER JOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk ORDER BY c.c_customer_id LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p04",
    "strategy": "Subquery prefiltering without CTE fences",
    "hypothesis": "Avoid CTE materialization overhead by using subqueries. Pre-filter customer_address and income_band directly in FROM clause to enable early reduction. EXPLAIN should show nested loops with small dimension scans first.",
    "target_ir": "Inline subqueries for dimensions + explicit JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT c.c_customer_id AS customer_id, COALESCE(c.c_last_name, '') || ', ' || COALESCE(c.c_first_name, '') AS customername FROM customer c INNER JOIN (SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Mount Vernon') ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk INNER JOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk INNER JOIN (SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 40374 AND ib_upper_bound <= 40374 + 50000) ib ON ib.ib_income_band_sk = hd.hd_income_band_sk INNER JOIN store_returns sr ON sr.sr_cdemo_sk = cd.cd_demo_sk ORDER BY c.c_customer_id LIMIT 100;"
        }
      }
    ]
  }
]