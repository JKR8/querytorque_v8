{
  "probe_id": "p06",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering selective dimensions into CTEs reduces row counts before joining with the large customer table, avoiding full scans and nested loops.",
  "reasoning_trace": [
    "customer_address has a selective filter (ca_city = 'Mount Vernon') that can be isolated",
    "income_band and household_demographics are joined via ib_income_band_sk = hd_income_band_sk with selective bounds",
    "customer_demographics and household_demographics are linked to customer via foreign keys",
    "Replacing comma joins with explicit JOINs enables better optimization and avoids COMMA_JOIN_WEAKNESS"
  ],
  "target_ir": "Dimension tables pre-filtered into CTEs; main query joins CTEs explicitly with customer and store_returns",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_address",
        "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_city = 'Mount Vernon'"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_income_band",
        "cte_query_sql": "SELECT ib_income_band_sk FROM income_band WHERE ib_lower_bound >= 40374 AND ib_upper_bound <= 40374 + 50000"
      }
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_household_demo",
        "cte_query_sql": "SELECT hd_demo_sk, hd_income_band_sk FROM household_demographics"
      }
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_customer_demo",
        "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics"
      }
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "customer c JOIN filtered_address fa ON c.c_current_addr_sk = fa.ca_address_sk JOIN filtered_household_demo fhd ON c.c_current_hdemo_sk = fhd.hd_demo_sk JOIN filtered_customer_demo fcd ON c.c_current_cdemo_sk = fcd.cd_demo_sk JOIN store_returns sr ON sr.sr_cdemo_sk = fcd.cd_demo_sk JOIN filtered_income_band fib ON fib.ib_income_band_sk = fhd.hd_income_band_sk"
      }
    },
    {
      "step_id": "s6",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "c.c_current_addr_sk IS NOT NULL"
      }
    }
  ]
}