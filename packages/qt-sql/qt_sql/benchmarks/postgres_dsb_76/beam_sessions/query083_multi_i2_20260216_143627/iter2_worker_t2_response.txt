{
  "plan_id": "postgres_unnest_correlated_date_subquery_and_preaggregate_returns",
  "dialect": "postgres",
  "description": "Pre-aggregates store_returns, catalog_returns, and web_returns by item before joining with dimensions. Eliminates correlated subqueries in date filtering by extracting d_date values into a shared CTE based on fixed input dates.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "target_dates",
        "cte_query_sql": "SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))"
      },
      "description": "Insert CTE 'target_dates' to materialize the list of qualifying dates"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preagg_sr",
        "cte_query_sql": "SELECT sr_item_sk, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns WHERE sr_returned_date_sk IN (SELECT d_date_sk FROM date_dim JOIN target_dates ON date_dim.d_date = target_dates.d_date) AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY sr_item_sk"
      },
      "description": "Insert CTE 'preagg_sr' for pre-aggregated store returns"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preagg_cr",
        "cte_query_sql": "SELECT cr_item_sk, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns WHERE cr_returned_date_sk IN (SELECT d_date_sk FROM date_dim JOIN target_dates ON date_dim.d_date = target_dates.d_date) AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY cr_item_sk"
      },
      "description": "Insert CTE 'preagg_cr' for pre-aggregated catalog returns"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preagg_wr",
        "cte_query_sql": "SELECT wr_item_sk, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns WHERE wr_returned_date_sk IN (SELECT d_date_sk FROM date_dim JOIN target_dates ON date_dim.d_date = target_dates.d_date) AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY wr_item_sk"
      },
      "description": "Insert CTE 'preagg_wr' for pre-aggregated web returns"
    },
    {
      "step_id": "s5",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_sr_items"
      },
      "payload": {
        "sql_fragment": "SELECT i.i_item_id AS item_id, p.sr_item_qty FROM item i JOIN preagg_sr p ON i.i_item_sk = p.sr_item_sk WHERE i.i_category IN ('Children', 'Electronics') AND i.i_manager_id BETWEEN 15 AND 24 GROUP BY i.i_item_id, p.sr_item_qty"
      },
      "description": "Replace sr_items CTE body with join to pre-aggregated store returns"
    },
    {
      "step_id": "s6",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_cr_items"
      },
      "payload": {
        "sql_fragment": "SELECT i.i_item_id AS item_id, p.cr_item_qty FROM item i JOIN preagg_cr p ON i.i_item_sk = p.cr_item_sk WHERE i.i_category IN ('Children', 'Electronics') AND i.i_manager_id BETWEEN 15 AND 24 GROUP BY i.i_item_id, p.cr_item_qty"
      },
      "description": "Replace cr_items CTE body with join to pre-aggregated catalog returns"
    },
    {
      "step_id": "s7",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_wr_items"
      },
      "payload": {
        "sql_fragment": "SELECT i.i_item_id AS item_id, p.wr_item_qty FROM item i JOIN preagg_wr p ON i.i_item_sk = p.wr_item_sk WHERE i.i_category IN ('Children', 'Electronics') AND i.i_manager_id BETWEEN 15 AND 24 GROUP BY i.i_item_id, p.wr_item_qty"
      },
      "description": "Replace wr_items CTE body with join to pre-aggregated web returns"
    }
  ]
}