{
  "plan_id": "wildcard_postgres_explicit_join_early_filters",
  "dialect": "postgres",
  "description": "Transform comma joins to explicit INNER JOINs and push selective filters on item and date dimensions into MATERIALIZED CTEs. This reduces the input size to Merge Joins and Sorts by pre-filtering large fact tables.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1"
      },
      "description": "Insert CTE 'filtered_dates' for date dimension filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_item1",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Electronics', 'Men')"
      },
      "description": "Insert CTE 'filtered_item1' for item1 filtering"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_item2",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63"
      },
      "description": "Insert CTE 'filtered_item2' for item2 filtering"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "store_sales s1 INNER JOIN store_sales s2 ON s1.ss_ticket_number = s2.ss_ticket_number INNER JOIN filtered_item1 ON s1.ss_item_sk = filtered_item1.i_item_sk INNER JOIN filtered_item2 ON s2.ss_item_sk = filtered_item2.i_item_sk INNER JOIN filtered_dates ON s1.ss_sold_date_sk = filtered_dates.d_date_sk INNER JOIN customer ON s1.ss_customer_sk = c_customer_sk INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk INNER JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk"
      },
      "description": "Replace comma-join FROM with explicit JOINs"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "2dafc52d90775c79"
      },
      "payload": {
        "expr_sql": "filtered_item1.i_item_sk < filtered_item2.i_item_sk AND cd_marital_status = 'D' AND cd_education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129 AND s2.ss_list_price BETWEEN 115 AND 129"
      },
      "description": "Replace WHERE predicate with optimized version"
    }
  ]
}