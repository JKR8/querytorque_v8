[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "original",
    "strategy": "Decorrelate subquery + explicit joins",
    "hypothesis": "BDA shows correlated subquery as primary bottleneck. Replace with CTE-based threshold precomputation to avoid per-row execution while converting comma joins to explicit syntax for better optimizer guidance.",
    "target_ir": "Main query with discount_thresholds CTE joined via explicit INNER JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH discount_thresholds AS (\n    SELECT \n        ws_item_sk,\n        1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM web_sales\n    JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    WHERE \n        d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'\n        AND ws_wholesale_cost BETWEEN 35 AND 55\n        AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n    GROUP BY ws_item_sk\n)\nSELECT \n    SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales\nJOIN item ON i_item_sk = ws_item_sk\nJOIN date_dim ON d_date_sk = ws_sold_date_sk\nJOIN discount_thresholds ON discount_thresholds.ws_item_sk = web_sales.ws_item_sk\nWHERE \n    (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))\n    AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'\n    AND ws_wholesale_cost BETWEEN 35 AND 55\n    AND ws_ext_discount_amt > threshold\nORDER BY SUM(ws_ext_discount_amt)\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "original",
    "strategy": "Early fact reduction + OR decomposition",
    "hypothesis": "BDA indicates full fact scan amplification. Prefilter web_sales with date_dim in CTE, split item OR condition into UNION branches to enable index usage, and decorrelate subquery via CTE.",
    "target_ir": "Filtered web_sales CTE + UNION-based item filtering + threshold CTE",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH date_filtered_web AS (\n    SELECT ws_item_sk, ws_ext_discount_amt\n    FROM web_sales\n    JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'\n      AND ws_wholesale_cost BETWEEN 35 AND 55\n), \nitem_union AS (\n    SELECT i_item_sk FROM item WHERE i_manufact_id BETWEEN 797 AND 996\n    UNION\n    SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')\n),\nthresholds AS (\n    SELECT \n        ws_item_sk,\n        1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM date_filtered_web\n    WHERE ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n    GROUP BY ws_item_sk\n)\nSELECT \n    SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM date_filtered_web\nJOIN item_union ON item_union.i_item_sk = date_filtered_web.ws_item_sk\nJOIN thresholds ON thresholds.ws_item_sk = date_filtered_web.ws_item_sk\nWHERE ws_ext_discount_amt > threshold\nORDER BY SUM(ws_ext_discount_amt)\nLIMIT 100;"
        }
      }
    ]
  }
]