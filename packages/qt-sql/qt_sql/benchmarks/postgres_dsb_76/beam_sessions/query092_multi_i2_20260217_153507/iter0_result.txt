{
  "iteration": 0,
  "n_api_calls": 20,
  "beam_cost_usd": 0.08735401,
  "beam_cost_priced_calls": 20,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 93783,
    "completion_tokens": 29661,
    "total_tokens": 123444,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 37376
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_range AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY') SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_range ON d_date_sk = ws_sold_date_sk WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM web_sales, date_dim WHERE ws_item_sk = i_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Extract date_dim filter into date_range CTE. Convert comma joins to explicit INNER JOINs with CTE."
    },
    {
      "patch_id": "p10",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.7,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 numbers: ['0.01', '76.0', '91.0']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_web_sales AS (SELECT ws_item_sk, ws_sold_date_sk, ws_ext_discount_amt FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM filtered_web_sales AS fws JOIN item AS i ON i.i_item_sk = fws.ws_item_sk WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM filtered_web_sales AS fws2 WHERE fws2.ws_item_sk = i.i_item_sk) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Materialize filtered web_sales+date_dim in CTE. Reuse in main query and threshold subquery computation."
    },
    {
      "patch_id": "p08",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.7,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))), filtered_web_date AS (SELECT ws_item_sk, ws_ext_discount_amt FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM filtered_item AS i JOIN filtered_web_date AS w ON i.i_item_sk = w.ws_item_sk WHERE w.ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM filtered_web_date) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Materialize BOTH filtered item and pre-joined web_sales/date_dim in CTEs before final join and aggregation."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.8,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'), filtered_item AS (SELECT i_item_sk FROM item WHERE i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN filtered_item ON i_item_sk = ws_item_sk JOIN filtered_date ON d_date_sk = ws_sold_date_sk WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM web_sales, date_dim WHERE ws_item_sk = i_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Create CTEs for filtered date_dim AND item. Join both CTEs with web_sales using explicit INNER JOIN syntax."
    },
    {
      "patch_id": "p04",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH discount_thresholds AS (SELECT i_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY i_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk JOIN discount_thresholds ON discount_thresholds.i_item_sk = i_item_sk WHERE i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports') AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > discount_thresholds.threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Combine p01+p03: decorrelate subquery using MATERIALIZED CTEs AND pre-filter both dimensions in CTEs before main join."
    },
    {
      "patch_id": "p09",
      "family": "B",
      "transform": "decorrelate",
      "relevance_score": 0.65,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH avg_discount_thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk JOIN avg_discount_thresholds ON avg_discount_thresholds.ws_item_sk = web_sales.ws_item_sk WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Basic decorrelation: compute subquery thresholds in CTE without MATERIALIZED. Rely on optimizer to prevent re-execution."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.9,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'), filtered_web_sales AS (SELECT ws_item_sk, ws_ext_discount_amt FROM web_sales JOIN filtered_dates AS fd ON fd.d_date_sk = ws_sold_date_sk WHERE ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01), item_thresholds AS (SELECT ws_item_sk AS item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM filtered_web_sales GROUP BY ws_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales AS ws JOIN item AS i ON i.i_item_sk = ws.ws_item_sk JOIN date_dim AS d ON d.d_date_sk = ws.ws_sold_date_sk JOIN item_thresholds AS it ON it.item_sk = ws.ws_item_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ws.ws_ext_discount_amt > it.threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Replace correlated subquery with 3 MATERIALIZED CTEs: 1) filtered date_dim, 2) pre-joined web_sales/date_dim with ratio filter, 3) per-item thresholds. Join threshold CTE in main WHERE."
    },
    {
      "patch_id": "p06",
      "family": "B",
      "transform": "sf_shared_scan_decorrelate",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH shared_web AS (SELECT ws_item_sk, ws_ext_discount_amt, ws_sold_date_sk FROM web_sales WHERE ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01), thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM shared_web AS sw JOIN date_dim AS dd ON dd.d_date_sk = sw.ws_sold_date_sk WHERE dd.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' GROUP BY ws_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM shared_web AS sw JOIN item AS i ON i.i_item_sk = sw.ws_item_sk JOIN date_dim AS dd ON dd.d_date_sk = sw.ws_sold_date_sk JOIN thresholds AS t ON t.ws_item_sk = sw.ws_item_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND dd.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND sw.ws_ext_discount_amt > t.threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Create shared_web CTE with web_sales+date_dim filters. Compute thresholds from CTE + ratio filter. Join to main."
    },
    {
      "patch_id": "p07",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.5,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH preagg_web AS (SELECT i_item_sk, AVG(ws_ext_discount_amt) AS avg_discount FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY i_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales, item, date_dim, preagg_web WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > (SELECT 1.3 * avg_discount FROM preagg_web WHERE preagg_web.i_item_sk = i_item_sk) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "Pre-aggregate web_sales by i_item_sk in CTE before joining dimensions. Use in main and subquery."
    },
    {
      "patch_id": "p05",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.4,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Failed to parse/apply PatchPlan",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "Split item OR condition into UNION ALL branches: 1) i_manufact_id filter 2) i_category filter (with NOT i_manufact_id). Preserve in subquery."
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH discount_thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk JOIN discount_thresholds ON discount_thresholds.ws_item_sk = web_sales.ws_item_sk WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_filtered_web AS (SELECT ws_item_sk, ws_ext_discount_amt FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_cost BETWEEN 35 AND 55), item_union AS (SELECT i_item_sk FROM item WHERE i_manufact_id BETWEEN 797 AND 996 UNION SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM date_filtered_web WHERE ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM date_filtered_web JOIN item_union ON item_union.i_item_sk = date_filtered_web.ws_item_sk JOIN thresholds ON thresholds.ws_item_sk = date_filtered_web.ws_item_sk WHERE ws_ext_discount_amt > threshold ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s2 failed: replace_from requires from_sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s3 failed: replace_from requires from_sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {}
}