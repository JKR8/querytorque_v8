[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p04,p09",
    "strategy": "Decorrelation via threshold CTE + explicit joins",
    "hypothesis": "Eliminate correlated subquery nested loops by precomputing thresholds in CTE. Convert comma joins to explicit JOIN/ON syntax to help cardinality estimation.",
    "target_ir": "Main query joins threshold CTE, date_dim and item via explicit INNER JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "discount_thresholds",
          "cte_query_sql": "SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "web_sales INNER JOIN item ON i_item_sk = ws_item_sk INNER JOIN date_dim ON d_date_sk = ws_sold_date_sk INNER JOIN discount_thresholds ON discount_thresholds.ws_item_sk = web_sales.ws_item_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "(i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > threshold"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p03",
    "strategy": "Dimension pre-filtering + CTE fencing",
    "hypothesis": "Pre-filter small dimension tables first to reduce join fanout. Materialize date range CTE to avoid repeated date computations.",
    "target_ir": "Nested CTEs for dimensions with explicit JOIN topology",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "date_range",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "valid_items",
          "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "web_sales INNER JOIN valid_items ON i_item_sk = ws_item_sk INNER JOIN date_range ON d_date_sk = ws_sold_date_sk"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM web_sales INNER JOIN date_range ON date_range.d_date_sk = web_sales.ws_sold_date_sk WHERE web_sales.ws_item_sk = valid_items.i_item_sk AND web_sales.ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01)"
        }
      }
    ]
  }
]