[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p06",
    "strategy": "Materialize pre‑filtered fact and date dimension in CTEs to break nested‑loop hotspot.",
    "hypothesis": "WIN probe p06 (1.27×) shows pre‑filtering catalog_sales and date_dim eliminates the 67‑second nested‑loop hotspot. This attempt adopts the same CTE shape while converting to explicit JOIN syntax for clarity and potential reorder benefit.",
    "expected_explain_delta": "Nested‑loop between date_dim and catalog_sales replaced by hash join; early filter on cs_list_price applied before join; dimension filters remain after join.",
    "target_ir": "Add filtered_date_dim and filtered_catalog_sales CTEs, rewrite final_select with explicit joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_date_dim", "filtered_catalog_sales", "warehouse", "ship_mode", "call_center"],
          "outputs": ["SUBSTRING(w_warehouse_name FROM 1 FOR 20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1191 AND 1191 + 23\n),\nfiltered_catalog_sales AS (\n  SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk\n  FROM catalog_sales\n  WHERE cs_list_price BETWEEN 244 AND 273\n)\nSELECT\n  SUBSTRING(w_warehouse_name, 1, 20),\n  sm_type,\n  cc_name,\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\"\nFROM filtered_catalog_sales cs\nJOIN filtered_date_dim d ON cs.cs_ship_date_sk = d.d_date_sk\nJOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk\nJOIN ship_mode sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk\nJOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk\nWHERE sm.sm_type = 'LIBRARY'\n  AND cc.cc_class = 'medium'\n  AND w.w_gmt_offset = -5\nGROUP BY SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name\nORDER BY SUBSTRING(w_warehouse_name, 1, 20), sm_type, cc_name\nLIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales"],
          "outputs": ["cs_ship_date_sk", "cs_sold_date_sk", "cs_warehouse_sk", "cs_ship_mode_sk", "cs_call_center_sk"],
          "changed": true,
          "sql": "SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk FROM catalog_sales WHERE cs_list_price BETWEEN 244 AND 273"
        },
        {
          "node_id": "warehouse",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["w_warehouse_sk", "w_warehouse_name", "w_gmt_offset"],
          "changed": false
        },
        {
          "node_id": "ship_mode",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["sm_ship_mode_sk", "sm_type"],
          "changed": false
        },
        {
          "node_id": "call_center",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["cc_call_center_sk", "cc_name", "cc_class"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02,p04",
    "strategy": "Pre‑filter all dimensions and fact table into CTEs to minimize join input rows.",
    "hypothesis": "Probes p02/p04 attempted full dimension prefetch but failed on syntax/semantic errors. This attempt corrects the CTE definitions and ensures all dimension keys and required columns are present, targeting the same nested‑loop hotspot with more aggressive early reduction.",
    "expected_explain_delta": "All dimension filters applied before joins; catalog_sales scan filtered by cs_list_price and joined only to pre‑filtered date_dim; nested‑loop replaced by hash joins.",
    "target_ir": "Add CTEs for each dimension (date_dim, warehouse, ship_mode, call_center) and filtered catalog_sales, rewrite final_select with explicit joins on CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_date_dim", "filtered_catalog_sales", "filtered_warehouse", "filtered_ship_mode", "filtered_call_center"],
          "outputs": ["SUBSTRING(w_warehouse_name FROM 1 FOR 20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1191 AND 1191 + 23\n),\nfiltered_warehouse AS (\n  SELECT w_warehouse_sk, w_warehouse_name\n  FROM warehouse\n  WHERE w_gmt_offset = -5\n),\nfiltered_ship_mode AS (\n  SELECT sm_ship_mode_sk, sm_type\n  FROM ship_mode\n  WHERE sm_type = 'LIBRARY'\n),\nfiltered_call_center AS (\n  SELECT cc_call_center_sk, cc_name\n  FROM call_center\n  WHERE cc_class = 'medium'\n),\nfiltered_catalog_sales AS (\n  SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk\n  FROM catalog_sales\n  WHERE cs_list_price BETWEEN 244 AND 273\n)\nSELECT\n  SUBSTRING(w.w_warehouse_name, 1, 20),\n  sm.sm_type,\n  cc.cc_name,\n  SUM(CASE WHEN (cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\",\n  SUM(CASE WHEN (cs.cs_ship_date_sk - cs.cs_sold_date_sk > 30) AND (cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\",\n  SUM(CASE WHEN (cs.cs_ship_date_sk - cs.cs_sold_date_sk > 60) AND (cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\",\n  SUM(CASE WHEN (cs.cs_ship_date_sk - cs.cs_sold_date_sk > 90) AND (cs.cs_ship_date_sk - cs.cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\",\n  SUM(CASE WHEN (cs.cs_ship_date_sk - cs.cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\"\nFROM filtered_catalog_sales cs\nJOIN filtered_date_dim d ON cs.cs_ship_date_sk = d.d_date_sk\nJOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk\nJOIN filtered_ship_mode sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk\nJOIN filtered_call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk\nGROUP BY SUBSTRING(w.w_warehouse_name, 1, 20), sm.sm_type, cc.cc_name\nORDER BY SUBSTRING(w.w_warehouse_name, 1, 20), sm.sm_type, cc.cc_name\nLIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23"
        },
        {
          "node_id": "filtered_warehouse",
          "parent_node_id": "final_select",
          "sources": ["warehouse"],
          "outputs": ["w_warehouse_sk", "w_warehouse_name"],
          "changed": true,
          "sql": "SELECT w_warehouse_sk, w_warehouse_name FROM warehouse WHERE w_gmt_offset = -5"
        },
        {
          "node_id": "filtered_ship_mode",
          "parent_node_id": "final_select",
          "sources": ["ship_mode"],
          "outputs": ["sm_ship_mode_sk", "sm_type"],
          "changed": true,
          "sql": "SELECT sm_ship_mode_sk, sm_type FROM ship_mode WHERE sm_type = 'LIBRARY'"
        },
        {
          "node_id": "filtered_call_center",
          "parent_node_id": "final_select",
          "sources": ["call_center"],
          "outputs": ["cc_call_center_sk", "cc_name"],
          "changed": true,
          "sql": "SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'medium'"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales"],
          "outputs": ["cs_ship_date_sk", "cs_sold_date_sk", "cs_warehouse_sk", "cs_ship_mode_sk", "cs_call_center_sk"],
          "changed": true,
          "sql": "SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk FROM catalog_sales WHERE cs_list_price BETWEEN 244 AND 273"
        }
      ]
    }
  }
]