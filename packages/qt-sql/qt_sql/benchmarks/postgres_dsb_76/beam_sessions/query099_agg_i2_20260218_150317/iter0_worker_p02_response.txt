{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering selective dimensions (date_dim, warehouse, ship_mode, call_center) into CTEs before joining with catalog_sales reduces catalog_sales scan rows significantly.",
  "reasoning_trace": [
    "Nested Loop between date_dim and catalog_sales dominates runtime due to repeated index scans.",
    "Pre-filtering all selective dimensions allows compound selectivity before the main join.",
    "CTEs avoid duplicating heavy scans and align with PostgreSQL's BitmapOr strength."
  ],
  "target_ir": "Introduce CTEs for each selective dimension, then join filtered dimensions with catalog_sales.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_catalog_sales", "filtered_warehouse", "filtered_ship_mode", "filtered_call_center"],
        "outputs": ["SUBSTRING(w_warehouse_name FROM 1 FOR 20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "SELECT\n  SUBSTRING(w_warehouse_name FROM 1 FOR 20),\n  sm_type,\n  cc_name,\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\",\n  SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\"\nFROM\n  filtered_catalog_sales cs\nJOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk\nJOIN filtered_ship_mode sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk\nJOIN filtered_call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk\nJOIN date_dim d ON cs.cs_ship_date_sk = d.d_date_sk\nWHERE\n  d.d_month_seq BETWEEN 1191 AND 1191 + 23\nGROUP BY\n  SUBSTRING(w_warehouse_name FROM 1 FOR 20),\n  sm_type,\n  cc_name\nORDER BY\n  SUBSTRING(w_warehouse_name FROM 1 FOR 20),\n  sm_type,\n  cc_name\nLIMIT 100"
      },
      {
        "node_id": "filtered_catalog_sales",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales"],
        "outputs": ["cs_sold_date_sk", "cs_ship_date_sk", "cs_warehouse_sk", "cs_ship_mode_sk", "cs_call_center_sk", "cs_list_price"],
        "changed": true,
        "sql": "WITH filtered_warehouse AS (\n  SELECT w_warehouse_sk\n  FROM warehouse\n  WHERE w_gmt_offset = -5\n),\nfiltered_ship_mode AS (\n  SELECT sm_ship_mode_sk\n  FROM ship_mode\n  WHERE sm_type = 'LIBRARY'\n),\nfiltered_call_center AS (\n  SELECT cc_call_center_sk\n  FROM call_center\n  WHERE cc_class = 'medium'\n)\nSELECT\n  cs_sold_date_sk,\n  cs_ship_date_sk,\n  cs_warehouse_sk,\n  cs_ship_mode_sk,\n  cs_call_center_sk,\n  cs_list_price\nFROM\n  catalog_sales cs\nJOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk\nJOIN filtered_ship_mode sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk\nJOIN filtered_call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk\nWHERE\n  cs_list_price BETWEEN 244 AND 273"
      },
      {
        "node_id": "filtered_warehouse",
        "parent_node_id": "filtered_catalog_sales",
        "sources": ["warehouse"],
        "outputs": ["w_warehouse_sk"],
        "changed": false
      },
      {
        "node_id": "filtered_ship_mode",
        "parent_node_id": "filtered_catalog_sales",
        "sources": ["ship_mode"],
        "outputs": ["sm_ship_mode_sk"],
        "changed": false
      },
      {
        "node_id": "filtered_call_center",
        "parent_node_id": "filtered_catalog_sales",
        "sources": ["call_center"],
        "outputs": ["cc_call_center_sk"],
        "changed": false
      }
    ]
  }
}