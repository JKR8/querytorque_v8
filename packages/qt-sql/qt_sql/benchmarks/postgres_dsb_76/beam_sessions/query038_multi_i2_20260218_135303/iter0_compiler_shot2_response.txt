[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "hypothesis": "Primary hotspot is the SetOp materialization of three large distinct sets (62K, 21K, 22K rows) from nested loops; secondary hotspot is repeated date_dim scans. Transform INTERSECT to EXISTS to avoid full materialization, preserving distinct semantics with correlated subqueries.",
    "target_ir": "Replace INTERSECT with EXISTS, using store_sales branch as driver and adding correlated EXISTS subqueries for catalog_sales and web_sales.",
    "confidence": 0.65,
    "based_on": "p01",
    "strategy": "Set reduction via EXISTS semi‑joins, eliminating full distinct materialization.",
    "expected_explain_delta": "SetOp disappears; nested loops remain but with EXISTS semi‑joins; total work reduced from 62K+21K+22K distinct rows to early filtering.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales, date_dim, customer WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk AND store_sales.ss_customer_sk = customer.c_customer_sk AND d_month_seq BETWEEN 1207 AND 1207 + 11 AND c_birth_month IN (2, 3, 4, 10) AND ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96 AND EXISTS (SELECT 1 FROM catalog_sales cs, date_dim d2, customer c2 WHERE cs.cs_sold_date_sk = d2.d_date_sk AND cs.cs_bill_customer_sk = c2.c_customer_sk AND d2.d_month_seq = date_dim.d_month_seq AND c2.c_birth_month = customer.c_birth_month AND cs.cs_list_price BETWEEN 241 AND 300 AND cs.cs_wholesale_cost BETWEEN 76 AND 96) AND EXISTS (SELECT 1 FROM web_sales ws, date_dim d3, customer c3 WHERE ws.ws_sold_date_sk = d3.d_date_sk AND ws.ws_bill_customer_sk = c3.c_customer_sk AND d3.d_month_seq = date_dim.d_month_seq AND c3.c_birth_month = customer.c_birth_month AND ws.ws_list_price BETWEEN 241 AND 300 AND ws.ws_wholesale_cost BETWEEN 76 AND 96)) hot_cust LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "hypothesis": "Residual gap: repeated date_dim and customer scans across three branches. Pre‑filter both dimensions into CTEs and join once per fact table, converting comma joins to explicit JOIN syntax to help join order flexibility.",
    "target_ir": "Add date_dim_prefetch and customer_prefetch CTEs, rewrite each branch with explicit joins, keep INTERSECT structure.",
    "confidence": 0.6,
    "based_on": "p02,p03",
    "strategy": "Dimension prefetch to single scan, explicit join syntax.",
    "expected_explain_delta": "Three date_dim scans become one; three customer scans become one; nested loops remain but with smaller dimension hash tables.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales_branch", "catalog_sales_branch", "web_sales_branch"],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (SELECT * FROM store_sales_branch INTERSECT SELECT * FROM catalog_sales_branch INTERSECT SELECT * FROM web_sales_branch) hot_cust LIMIT 100"
        },
        {
          "node_id": "store_sales_branch",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim_prefetch", "customer_prefetch"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 241 AND 300 AND ss.ss_wholesale_cost BETWEEN 76 AND 96"
        },
        {
          "node_id": "catalog_sales_branch",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_dim_prefetch", "customer_prefetch"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales cs JOIN date_dim_prefetch d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 241 AND 300 AND cs.cs_wholesale_cost BETWEEN 76 AND 96"
        },
        {
          "node_id": "web_sales_branch",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim_prefetch", "customer_prefetch"],
          "outputs": ["c_last_name", "c_first_name", "d_date"],
          "changed": true,
          "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales ws JOIN date_dim_prefetch d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 241 AND 300 AND ws.ws_wholesale_cost BETWEEN 76 AND 96"
        },
        {
          "node_id": "date_dim_prefetch",
          "parent_node_id": "store_sales_branch",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1207 + 11"
        },
        {
          "node_id": "customer_prefetch",
          "parent_node_id": "store_sales_branch",
          "sources": ["customer"],
          "outputs": ["c_customer_sk", "c_last_name", "c_first_name"],
          "changed": true,
          "sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_month IN (2, 3, 4, 10)"
        }
      ]
    }
  }
]