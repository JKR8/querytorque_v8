{
  "probe_id": "p03",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering date_dim and customer into CTEs reduces repeated scans and nested-loop inner side cardinality. Explicit JOIN syntax improves optimizer estimates.",
  "reasoning_trace": [
    "Three branches of INTERSECT repeat identical date_dim and customer scans with nested loops.",
    "Prefetch dimensions into CTEs to create small hash tables for explicit JOINs.",
    "Each branch retains original WHERE and DISTINCT semantics with explicit JOINs.",
    "CTEs are selective and reused once per branch, avoiding materialization fence issues."
  ],
  "target_ir": "date_dim_prefetch and customer_prefetch CTEs added; each fact branch joins explicitly with prefiltered dimensions.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["intersect_branch_1", "intersect_branch_2", "intersect_branch_3"],
        "outputs": ["count"],
        "changed": true,
        "sql": "SELECT COUNT(*) FROM (SELECT * FROM intersect_branch_1 INTERSECT SELECT * FROM intersect_branch_2 INTERSECT SELECT * FROM intersect_branch_3) hot_cust LIMIT 100"
      },
      {
        "node_id": "intersect_branch_1",
        "parent_node_id": "final_select",
        "sources": ["store_sales_branch"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales_branch ss JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON ss.ss_customer_sk = c.c_customer_sk"
      },
      {
        "node_id": "intersect_branch_2",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales_branch"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales_branch cs JOIN date_dim_prefetch d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON cs.cs_bill_customer_sk = c.c_customer_sk"
      },
      {
        "node_id": "intersect_branch_3",
        "parent_node_id": "final_select",
        "sources": ["web_sales_branch"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales_branch ws JOIN date_dim_prefetch d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON ws.ws_bill_customer_sk = c.c_customer_sk"
      },
      {
        "node_id": "store_sales_branch",
        "parent_node_id": "intersect_branch_1",
        "sources": ["store_sales"],
        "outputs": ["ss_customer_sk", "ss_sold_date_sk"],
        "changed": true,
        "sql": "SELECT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "catalog_sales_branch",
        "parent_node_id": "intersect_branch_2",
        "sources": ["catalog_sales"],
        "outputs": ["cs_bill_customer_sk", "cs_sold_date_sk"],
        "changed": true,
        "sql": "SELECT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 241 AND 300 AND cs_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "web_sales_branch",
        "parent_node_id": "intersect_branch_3",
        "sources": ["web_sales"],
        "outputs": ["ws_bill_customer_sk", "ws_sold_date_sk"],
        "changed": true,
        "sql": "SELECT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 241 AND 300 AND ws_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "date_dim_prefetch",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1207 + 11"
      },
      {
        "node_id": "customer_prefetch",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_last_name", "c_first_name"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_month IN (2, 3, 4, 10)"
      }
    ]
  }
}