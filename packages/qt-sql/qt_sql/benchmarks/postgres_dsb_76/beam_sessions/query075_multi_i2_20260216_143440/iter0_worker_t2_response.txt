{
  "plan_id": "gold_postgres_pg_union_all_early_filter",
  "dialect": "postgres",
  "description": "Convert UNION to UNION ALL to avoid duplicate elimination before final GROUP BY. Push return reason filters into each sales component to reduce row counts early. This reduces intermediate result size before expensive grouping.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_all_sales"
      },
      "payload": {
        "sql_fragment": "WITH sales_detail AS (SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt, cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt FROM catalog_sales JOIN item ON i_item_sk=cs_item_sk JOIN date_dim ON d_date_sk=cs_sold_date_sk LEFT JOIN catalog_returns ON (cs_order_number=cr_order_number AND cs_item_sk=cr_item_sk AND cr_reason_sk in (8, 18, 20, 23, 41)) WHERE i_category='Children' and cs_sales_price / cs_list_price BETWEEN 0.69 AND 0.89 UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt, ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt FROM store_sales JOIN item ON i_item_sk=ss_item_sk JOIN date_dim ON d_date_sk=ss_sold_date_sk LEFT JOIN store_returns ON (ss_ticket_number=sr_ticket_number AND ss_item_sk=sr_item_sk AND sr_reason_sk in (8, 18, 20, 23, 41)) WHERE i_category='Children' and ss_sales_price / ss_list_price BETWEEN 0.69 AND 0.89 UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt, ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt FROM web_sales JOIN item ON i_item_sk=ws_item_sk JOIN date_dim ON d_date_sk=ws_sold_date_sk LEFT JOIN web_returns ON (ws_order_number=wr_order_number AND ws_item_sk=wr_item_sk AND wr_reason_sk in (8, 18, 20, 23, 41)) WHERE i_category='Children' and ws_sales_price / ws_list_price BETWEEN 0.69 AND 0.89) SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM sales_detail GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id"
      },
      "description": "Replace the body of all_sales CTE with UNION ALL and early return reason filtering"
    }
  ]
}