{
  "probe_id": "p01",
  "transform_id": "inner_join_conversion",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Convert LEFT JOINs to INNER JOINs and push return reason filters into ON clauses to reduce row explosion and enable earlier filtering.",
  "reasoning_trace": [
    "Each UNION branch has a LEFT JOIN followed by a WHERE clause on the right-side table's column (e.g. cr_reason_sk IN (...)).",
    "This pattern forces PostgreSQL to retain all left rows during the join, only to filter them afterward.",
    "Converting to INNER JOIN with embedded filter in the ON clause allows early pruning and better cardinality estimates."
  ],
  "target_ir": "INNER JOINs with reason_sk filters moved to ON clauses; original projection and grouping preserved.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "(SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt, cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt FROM catalog_sales JOIN item ON i_item_sk=cs_item_sk JOIN date_dim ON d_date_sk=cs_sold_date_sk INNER JOIN catalog_returns ON (cs_order_number=cr_order_number AND cs_item_sk=cr_item_sk AND cr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i_category='Children' AND cs_sales_price / cs_list_price BETWEEN 0.69 AND 0.89)"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "(SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt, ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt FROM store_sales JOIN item ON i_item_sk=ss_item_sk JOIN date_dim ON d_date_sk=ss_sold_date_sk INNER JOIN store_returns ON (ss_ticket_number=sr_ticket_number AND ss_item_sk=sr_item_sk AND sr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i_category='Children' AND ss_sales_price / ss_list_price BETWEEN 0.69 AND 0.89)"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "(SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt, ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt FROM web_sales JOIN item ON i_item_sk=ws_item_sk JOIN date_dim ON d_date_sk=ws_sold_date_sk INNER JOIN web_returns ON (ws_order_number=wr_order_number AND ws_item_sk=wr_item_sk AND wr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i_category='Children' AND ws_sales_price / ws_list_price BETWEEN 0.69 AND 0.89)"
      }
    }
  ]
}