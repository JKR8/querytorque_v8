{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate store_sales ticket-item pairs before joining to reduce row multiplicity and avoid nested loop explosion on dimension tables.",
  "reasoning_trace": [
    "Original query joins two store_sales instances on ss_ticket_number with item and customer filters applied post-join.",
    "Aggregation is done after all joins, causing high-cardinality intermediate results.",
    "Pushing down the GROUP BY to pre-aggregate s1/s2 pairs reduces rows entering expensive dimension joins."
  ],
  "target_ir": "CTE with pre-aggregated ticket-item pairs, joined to dimensions; original GROUP BY keys preserved in final SELECT.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ticket_item_pairs",
        "cte_query_sql": "SELECT s1.ss_ticket_number, s1.ss_item_sk AS item1_sk, s2.ss_item_sk AS item2_sk, COUNT(*) AS cnt FROM store_sales s1 JOIN store_sales s2 ON s1.ss_ticket_number = s2.ss_ticket_number WHERE s1.ss_item_sk < s2.ss_item_sk AND s1.ss_list_price BETWEEN 108 AND 122 AND s2.ss_list_price BETWEEN 108 AND 122 GROUP BY s1.ss_ticket_number, s1.ss_item_sk, s2.ss_item_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "ticket_item_pairs tip, item item1, item item2, date_dim, customer, customer_address, customer_demographics"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "tip.item1_sk = item1.i_item_sk AND tip.item2_sk = item2.i_item_sk AND d_year BETWEEN 1998 AND 1999 AND d_date_sk = (SELECT ss_sold_date_sk FROM store_sales WHERE ss_ticket_number = tip.ss_ticket_number LIMIT 1) AND item1.i_category IN ('Electronics', 'Jewelry') AND item2.i_manager_id BETWEEN 81 AND 100 AND cd_marital_status = 'S' AND cd_education_status = 'College'"
      }
    }
  ]
}