[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "hypothesis": "Workers p01 and p04 showed neutral speedup but were safe. This attempt avoids CTE materialization fences by using explicit JOINs with inline subqueries for date_dim and customer, allowing predicate pushdown and preserving the original nested-loop index scans.",
    "target_ir": "Transform each branch to explicit JOINs with filtered dimension subqueries, keep EXCEPT set operations unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (\n    (\n        SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\n        FROM store_sales ss\n        JOIN (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224) d ON ss.ss_sold_date_sk = d.d_date_sk\n        JOIN (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974) c ON ss.ss_customer_sk = c.c_customer_sk\n        WHERE ss.ss_list_price BETWEEN 168 AND 197\n          AND ss.ss_wholesale_cost BETWEEN 76 AND 86\n    )\n    EXCEPT\n    (\n        SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\n        FROM catalog_sales cs\n        JOIN (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224) d ON cs.cs_sold_date_sk = d.d_date_sk\n        JOIN (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974) c ON cs.cs_bill_customer_sk = c.c_customer_sk\n        WHERE cs.cs_list_price BETWEEN 168 AND 197\n          AND cs.cs_wholesale_cost BETWEEN 76 AND 86\n    )\n    EXCEPT\n    (\n        SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date\n        FROM web_sales ws\n        JOIN (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1224) d ON ws.ws_sold_date_sk = d.d_date_sk\n        JOIN (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974) c ON ws.ws_bill_customer_sk = c.c_customer_sk\n        WHERE ws.ws_list_price BETWEEN 168 AND 197\n          AND ws.ws_wholesale_cost BETWEEN 76 AND 86\n    )\n) cool_cust"
        }
      ]
    },
    "confidence": 0.45,
    "based_on": "p01,p04",
    "strategy": "Explicit JOIN with inline filtered dimension subqueries to avoid CTE materialization fences.",
    "expected_explain_delta": "Eliminate CTE scans; retain nested-loop index scans on fact tables, reduce duplicate dimension filtering work."
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "hypothesis": "SetOp materialization and three separate dimension scans are the primary hotspots. This alternative rewrites EXCEPT with NOT EXISTS anti-joins, reducing intermediate row materialization and allowing semi-join early-stop. Based on p02 but fixed to preserve semantic safety.",
    "target_ir": "Replace EXCEPT with NOT EXISTS correlated subqueries, keep distinct per branch.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT COUNT(*) FROM (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM store_sales ss, date_dim d, customer c\n    WHERE ss.ss_sold_date_sk = d.d_date_sk\n      AND ss.ss_customer_sk = c.c_customer_sk\n      AND d.d_month_seq BETWEEN 1213 AND 1224\n      AND ss.ss_list_price BETWEEN 168 AND 197\n      AND c.c_birth_year BETWEEN 1968 AND 1974\n      AND ss.ss_wholesale_cost BETWEEN 76 AND 86\n      AND NOT EXISTS (\n          SELECT 1\n          FROM catalog_sales cs\n          WHERE cs.cs_sold_date_sk = d.d_date_sk\n            AND cs.cs_bill_customer_sk = c.c_customer_sk\n            AND cs.cs_list_price BETWEEN 168 AND 197\n            AND cs.cs_wholesale_cost BETWEEN 76 AND 86\n      )\n      AND NOT EXISTS (\n          SELECT 1\n          FROM web_sales ws\n          WHERE ws.ws_sold_date_sk = d.d_date_sk\n            AND ws.ws_bill_customer_sk = c.c_customer_sk\n            AND ws.ws_list_price BETWEEN 168 AND 197\n            AND ws.ws_wholesale_cost BETWEEN 76 AND 86\n      )\n) cool_cust"
        }
      ]
    },
    "confidence": 0.35,
    "based_on": "p02",
    "strategy": "Convert EXCEPT to NOT EXISTS anti-joins to leverage PostgreSQL semi-join optimization.",
    "expected_explain_delta": "SetOp removal, potential hash anti-join or nested-loop anti-join instead of full materialization."
  }
]