{
  "plan_id": "builder_cs_ui_materialize_decorrelate_cross_sales_explicit_join",
  "dialect": "postgres",
  "description": "Materialize cs_ui CTE to avoid re-computation in nested loops while decorrelating store_sales join. Convert comma joins to explicit INNER JOIN in cross_sales CTE to optimize join order.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "materialized_cs_ui",
        "cte_query_sql": "SELECT cs_item_sk, sum(cs_ext_list_price) AS sale, sum(cr_refunded_cash + cr_reversed_charge + cr_store_credit) AS refund FROM catalog_sales INNER JOIN catalog_returns ON cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number WHERE cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY cs_item_sk HAVING sum(cs_ext_list_price) > 2 * sum(cr_refunded_cash + cr_reversed_charge + cr_store_credit)"
      },
      "description": "Insert materialized CTE 'materialized_cs_ui' to eliminate recomputation"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "prefiltered_dimensions",
        "cte_query_sql": "SELECT d1.d_date_sk AS d1_sk, d2.d_date_sk AS d2_sk, d3.d_date_sk AS d3_sk, s_store_sk, cd1.cd_demo_sk AS cd1_sk, cd2.cd_demo_sk AS cd2_sk, hd1.hd_demo_sk AS hd1_sk, hd2.hd_demo_sk AS hd2_sk, ad1.ca_address_sk AS ad1_sk, ad2.ca_address_sk AS ad2_sk, i_item_sk FROM date_dim d1, date_dim d2, date_dim d3, store, customer_demographics cd1, customer_demographics cd2, household_demographics hd1, household_demographics hd2, customer_address ad1, customer_address ad2, item WHERE cd1.cd_marital_status IN ('S', 'S', 'S') AND cd1.cd_education_status IN ('Advanced Degree', '4 yr Degree', '4 yr Degree') AND cd2.cd_marital_status IN ('S', 'S', 'S') AND cd2.cd_education_status IN ('Advanced Degree', '4 yr Degree', '4 yr Degree') AND ad2.ca_state IN ('KS', 'OH', 'VA') AND i_current_price BETWEEN 77 AND 77 + 10"
      },
      "description": "Insert prefiltered dimension tables into a single CTE for reuse"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_cross_sales"
      },
      "payload": {
        "sql_fragment": "SELECT i_product_name AS product_name, i_item_sk AS item_sk, s_store_name AS store_name, s_zip AS store_zip, ad1.ca_street_number AS b_street_number, ad1.ca_street_name AS b_street_name, ad1.ca_city AS b_city, ad1.ca_zip AS b_zip, ad2.ca_street_number AS c_street_number, ad2.ca_street_name AS c_street_name, ad2.ca_city AS c_city, ad2.ca_zip AS c_zip, d1.d_year AS syear, d2.d_year AS fsyear, d3.d_year AS s2year, count(*) AS cnt, sum(ss_wholesale_cost) AS s1, sum(ss_list_price) AS s2, sum(ss_coupon_amt) AS s3 FROM store_sales INNER JOIN store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number INNER JOIN materialized_cs_ui ON ss_item_sk = materialized_cs_ui.cs_item_sk INNER JOIN prefiltered_dimensions pd ON ss_sold_date_sk = pd.d1_sk AND ss_customer_sk = c_customer_sk AND ss_cdemo_sk = pd.cd1_sk AND ss_hdemo_sk = pd.hd1_sk AND ss_addr_sk = pd.ad1_sk AND ss_store_sk = pd.s_store_sk AND ss_item_sk = pd.i_item_sk AND c_current_cdemo_sk = pd.cd2_sk AND c_current_hdemo_sk = pd.hd2_sk AND c_current_addr_sk = pd.ad2_sk AND c_first_sales_date_sk = pd.d2_sk AND c_first_shipto_date_sk = pd.d3_sk INNER JOIN promotion ON ss_promo_sk = p_promo_sk INNER JOIN income_band ib1 ON hd1.hd_income_band_sk = ib1.ib_income_band_sk INNER JOIN income_band ib2 ON hd2.hd_income_band_sk = ib2.ib_income_band_sk WHERE cd1.cd_marital_status <> cd2.cd_marital_status AND p_channel_email = 'Y' AND p_channel_tv = 'Y' AND p_channel_radio = 'Y' AND ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_product_name, i_item_sk, s_store_name, s_zip, ad1.ca_street_number, ad1.ca_street_name, ad1.ca_city, ad1.ca_zip, ad2.ca_street_number, ad2.ca_street_name, ad2.ca_city, ad2.ca_zip, d1.d_year, d2.d_year, d3.d_year"
      },
      "description": "Rewrite cross_sales with explicit JOINs and reference to materialized CTEs"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "Q_S0"
      },
      "payload": {
        "from_sql": "cross_sales cs1 INNER JOIN cross_sales cs2 ON cs1.item_sk = cs2.item_sk AND cs1.store_name = cs2.store_name AND cs1.store_zip = cs2.store_zip"
      },
      "description": "Replace comma-join in main query with explicit INNER JOIN"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "Q_S0",
        "by_anchor_hash": "9854cf89f6241330"
      },
      "payload": {
        "expr_sql": "cs1.syear = 2000 AND cs2.syear = 2000 + 1 AND cs2.cnt <= cs1.cnt"
      },
      "description": "Refine WHERE clause after converting to explicit JOIN"
    }
  ]
}