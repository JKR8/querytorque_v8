Worker Role: W2
Family: B
Transform: decorrelate
Status: OK

--- OUTPUT SQL ---
WITH common_scan AS (SELECT ws_item_sk, ws_ext_discount_amt, ws_sales_price, ws_list_price, ws_wholesale_cost, d_date FROM web_sales INNER JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 DAY'), thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM common_scan WHERE ws_wholesale_cost BETWEEN 35 AND 55 AND (ws_sales_price / ws_list_price) BETWEEN 0.76 AND 0.91 GROUP BY ws_item_sk) SELECT SUM(cs.ws_ext_discount_amt) AS "Excess Discount Amount" FROM common_scan AS cs INNER JOIN item AS i ON cs.ws_item_sk = i.i_item_sk INNER JOIN thresholds AS t ON cs.ws_item_sk = t.ws_item_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND cs.ws_wholesale_cost BETWEEN 35 AND 55 AND cs.ws_ext_discount_amt > t.threshold ORDER BY SUM(cs.ws_ext_discount_amt) LIMIT 100;