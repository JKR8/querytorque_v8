{
  "plan_id": "gold_postgres_store_prefetch_and_self_join_elimination",
  "dialect": "postgres",
  "description": "Precompute filtered store dimension as CTE to eliminate 2x scans. Replace self-join with LAG window function to avoid expensive hash join.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_stores",
        "cte_query_sql": "SELECT s_store_sk, s_store_id, s_store_name, s_state FROM store WHERE s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')"
      },
      "description": "Insert CTE 'filtered_stores' for dimension prefetch"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_wss",
        "cte_query_sql": "SELECT wss.d_week_seq, wss.ss_store_sk, wss.sun_sales, wss.mon_sales, wss.tue_sales, wss.wed_sales, wss.thu_sales, wss.fri_sales, wss.sat_sales FROM wss JOIN date_dim d ON d.d_week_seq = wss.d_week_seq WHERE d.d_month_seq BETWEEN 1183 AND 1183 + 23"
      },
      "description": "Insert CTE 'filtered_wss' with date filtering applied"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "lagged_sales",
        "cte_query_sql": "SELECT s_store_name AS s_store_name1, s_store_id AS s_store_id1, d_week_seq, sun_sales, mon_sales, tue_sales, wed_sales, thu_sales, fri_sales, sat_sales, LAG(sun_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS sun_sales2, LAG(mon_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS mon_sales2, LAG(tue_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS tue_sales2, LAG(wed_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS wed_sales2, LAG(thu_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS thu_sales2, LAG(fri_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS fri_sales2, LAG(sat_sales, 1) OVER (PARTITION BY s_store_id ORDER BY d_week_seq) AS sat_sales2 FROM filtered_wss JOIN filtered_stores ON ss_store_sk = s_store_sk"
      },
      "description": "Insert CTE 'lagged_sales' replacing self-join with window function"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "lagged_sales"
      },
      "description": "Replace FROM clause with optimized CTE"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "expr_sql": "sun_sales2 IS NOT NULL"
      },
      "description": "Filter out rows where lag is NULL (equivalent to original join condition d_week_seq1 = d_week_seq2 - 52)"
    },
    {
      "step_id": "s6",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "0b824afb49a292d0"
      },
      "payload": {
        "expr_sql": "SELECT s_store_name1, s_store_id1, d_week_seq, sun_sales / sun_sales2 AS sun_sales_ratio, mon_sales / mon_sales2 AS mon_sales_ratio, tue_sales / tue_sales2 AS tue_sales_ratio, wed_sales / wed_sales2 AS wed_sales_ratio, thu_sales / thu_sales2 AS thu_sales_ratio, fri_sales / fri_sales2 AS fri_sales_ratio, sat_sales / sat_sales2 AS sat_sales_ratio FROM lagged_sales WHERE sun_sales2 IS NOT NULL ORDER BY s_store_name1, s_store_id1, d_week_seq LIMIT 100"
      },
      "description": "Replace full SELECT body to use window-based columns and remove old self-join logic"
    }
  ]
}