[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.9,
    "based_on": "p01",
    "strategy": "Explicit join conversion with date CTE to improve join ordering and filter pushdown.",
    "hypothesis": "Probe p01 showed 1.06x speedup by converting comma-separated joins to explicit JOIN syntax and materializing the date_dim filter into a CTE, addressing the nested-loop hotspot caused by poor cardinality estimates.",
    "expected_explain_delta": "Nested Loop replaced by Hash Joins; date_dim scan becomes a small hash table; join order may improve.",
    "target_ir": "Convert final_select to explicit joins with a filtered date CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999) SELECT i_item_id, ca_country, ca_state, ca_county, avg(cast(cs_quantity as decimal(12,2))) agg1, avg(cast(cs_list_price as decimal(12,2))) agg2, avg(cast(cs_coupon_amt as decimal(12,2))) agg3, avg(cast(cs_sales_price as decimal(12,2))) agg4, avg(cast(cs_net_profit as decimal(12,2))) agg5, avg(cast(c_birth_year as decimal(12,2))) agg6 FROM catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN customer_demographics cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE cd_gender = 'F' AND cd_education_status = '4 yr Degree' AND c_birth_month = 12 AND ca_state IN ('AR', 'IN', 'VA') AND cs_wholesale_cost BETWEEN 5 AND 10 AND i_category = 'Music' GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county) ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p02",
    "strategy": "Pre-aggregate catalog_sales by join keys before joining with dimensions, using explicit joins.",
    "hypothesis": "Probe p02 attempted aggregate pushdown but had incomplete SQL. This corrected version pre-aggregates catalog_sales by item, customer demo, and customer keys after applying date and cost filters, reducing rows before joining with dimensions.",
    "expected_explain_delta": "Aggregate input reduced early; hash joins on pre-aggregated keys; less data shuffled in final aggregation.",
    "target_ir": "Add preagg CTE and update final_select to join with pre-aggregated sales.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "preagg",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_dim"],
          "outputs": ["cs_item_sk", "cs_bill_cdemo_sk", "cs_bill_customer_sk", "sum_qty", "cnt_qty", "sum_list_price", "cnt_list_price", "sum_coupon_amt", "cnt_coupon_amt", "sum_sales_price", "cnt_sales_price", "sum_net_profit", "cnt_net_profit"],
          "changed": true,
          "sql": "SELECT cs_item_sk, cs_bill_cdemo_sk, cs_bill_customer_sk, SUM(CAST(cs_quantity AS DECIMAL(12,2))) AS sum_qty, COUNT(CAST(cs_quantity AS DECIMAL(12,2))) AS cnt_qty, SUM(CAST(cs_list_price AS DECIMAL(12,2))) AS sum_list_price, COUNT(CAST(cs_list_price AS DECIMAL(12,2))) AS cnt_list_price, SUM(CAST(cs_coupon_amt AS DECIMAL(12,2))) AS sum_coupon_amt, COUNT(CAST(cs_coupon_amt AS DECIMAL(12,2))) AS cnt_coupon_amt, SUM(CAST(cs_sales_price AS DECIMAL(12,2))) AS sum_sales_price, COUNT(CAST(cs_sales_price AS DECIMAL(12,2))) AS cnt_sales_price, SUM(CAST(cs_net_profit AS DECIMAL(12,2))) AS sum_net_profit, COUNT(CAST(cs_net_profit AS DECIMAL(12,2))) AS cnt_net_profit FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 1999 AND cs.cs_wholesale_cost BETWEEN 5 AND 10 GROUP BY cs_item_sk, cs_bill_cdemo_sk, cs_bill_customer_sk"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["preagg", "item", "customer_demographics", "customer", "customer_address"],
          "outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6"],
          "changed": true,
          "sql": "SELECT i_item_id, ca_country, ca_state, ca_county, SUM(sum_qty) / SUM(cnt_qty) AS agg1, SUM(sum_list_price) / SUM(cnt_list_price) AS agg2, SUM(sum_coupon_amt) / SUM(cnt_coupon_amt) AS agg3, SUM(sum_sales_price) / SUM(cnt_sales_price) AS agg4, SUM(sum_net_profit) / SUM(cnt_net_profit) AS agg5, AVG(CAST(c_birth_year AS DECIMAL(12,2))) AS agg6 FROM preagg JOIN item i ON preagg.cs_item_sk = i.i_item_sk JOIN customer_demographics cd ON preagg.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN customer c ON preagg.cs_bill_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE i.i_category = 'Music' AND cd.cd_gender = 'F' AND cd.cd_education_status = '4 yr Degree' AND c.c_birth_month = 12 AND ca.ca_state IN ('AR', 'IN', 'VA') GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county) ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100"
        }
      ]
    }
  }
]