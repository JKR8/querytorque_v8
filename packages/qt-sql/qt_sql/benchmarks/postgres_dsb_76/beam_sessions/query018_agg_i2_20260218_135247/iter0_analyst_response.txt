{  "dispatch": {
    "dialect": "postgresql",
    "importance_stars": 1,
    "probe_count": 4,
    "early_stop": false,
    "equivalence_tier": "unordered",
    "hypothesis": "Nested loop join dominates runtime due to poor cardinality estimates from comma-separated joins. Converting to explicit joins and pre-filtering selective dimensions can improve estimates and reduce join work, while aggregation after large joins may benefit from pushdown.",
    "reasoning_trace": [
      "Nested Loop time=3855.317 ms accounts for 99% of total query time.",
      "Cardinality estimation error: est=2,142 vs act=45K at a join node indicates poor planning.",
      "Comma joins in FROM clause may prevent optimal join ordering and filter pushdown."
    ],
    "cost_spine": ["Nested Loop", "Aggregate", "Sort", "Limit"],
    "hotspots": [
      {
        "op": "Nested Loop",
        "why": "dominates runtime with high time consumption from inefficient join strategy",
        "evidence": "time=3855.317 ms"
      },
      {
        "op": "Aggregate",
        "why": "large input from preceding joins, indicating late reduction",
        "evidence": "time=3855.346 ms"
      }
    ],
    "do_not_do": [
      "avoid or_to_union split as no OR predicates in query",
      "avoid duplicating CTE bodies without reuse benefit",
      "avoid decorrelation transforms since no correlated subqueries present"
    ]
  },
  "probe_summary_schema": [
    "probe_id",
    "transform_id",
    "family",
    "expected_explain_delta",
    "confidence",
    "exploration",
    "rank_rationale",
    "target",
    "dag_target_hint",
    "recommended_patch_ops",
    "recommended_examples"
  ],
  "probes": [
    {
      "probe_id": "p01",
      "transform_id": "date_cte_explicit_join",
      "family": "F",
      "target": "Convert comma-separated joins to explicit JOIN syntax and materialize date_dim filter (d_year=1999) into a CTE to create a small hash table for probing, preserving all join predicates and filters.",
      "dag_target_hint": "Change final_select FROM clause to use explicit JOINs and add a CTE for filtered date_dim.",
      "node_contract": {
        "from_must_include": ["catalog_sales cs", "date_dim d", "item i", "customer_demographics cd", "customer c", "customer_address ca"],
        "where_must_preserve": ["cs_sold_date_sk = d_date_sk", "cs_item_sk = i_item_sk", "cs_bill_cdemo_sk = cd_demo_sk", "cs_bill_customer_sk = c_customer_sk", "cd_gender = 'F'", "cd_education_status = '4 yr Degree'", "c_current_addr_sk = ca_address_sk", "d_year = 1999", "c_birth_month = 12", "ca_state in ('AR', 'IN', 'VA')", "cs_wholesale_cost BETWEEN 5 AND 10", "i_category = 'Music'"],
        "output_must_preserve": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6", "GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county)", "ORDER BY ca_country, ca_state, ca_county, i_item_id", "LIMIT 100"]
      },
      "gates_checked": ["G_PG_COMMA_JOIN_PRESENT:PASS", "G_PG_COMMA_FACT_FANOUT:PASS"],
      "exploration": false,
      "exploration_hypothesis": "",
      "confidence": 0.85,
      "expected_explain_delta": "Nested Loop replaced with Hash Join or Merge Join, reduced rows in join inputs due to better estimates.",
      "recommended_patch_ops": ["insert_cte", "replace_from", "convert_to_explicit_join"],
      "recommended_examples": ["pg_date_cte_explicit_join"],
      "rank_rationale": "Targets primary hotspot — comma joins causing nested loop inefficiency with direct evidence.",
      "gold_example_id": "pg_date_cte_explicit_join"
    },
    {
      "probe_id": "p02",
      "transform_id": "aggregate_pushdown",
      "family": "C",
      "target": "Pre-aggregate catalog_sales by item key (i_item_sk) and customer key (c_customer_sk) before joining with dimensions, to reduce rows entering the final aggregate, ensuring AVG calculations are guarded for duplication.",
      "dag_target_hint": "Add a CTE that aggregates cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, cs_net_profit, c_birth_year by i_item_sk and c_customer_sk, then join with filtered dimensions.",
      "node_contract": {
        "from_must_include": ["catalog_sales cs"],
        "where_must_preserve": ["cs_sold_date_sk = d_date_sk", "d_year = 1999", "cs_wholesale_cost BETWEEN 5 AND 10", "i_category = 'Music'"],
        "output_must_preserve": ["grouping keys compatible with i_item_id, ca_country, ca_state, ca_county", "aggregate values (agg1 to agg6) correctly rolled up and averaged"]
      },
      "gates_checked": ["agg_key_compatibility:PASS", "duplication_sensitive_metrics:AVG guard required"],
      "exploration": true,
      "exploration_hypothesis": "Aggregation after joins may be inefficient; pushing aggregation down could reduce join input size despite being a portability candidate.",
      "confidence": 0.60,
      "expected_explain_delta": "Aggregate node moves earlier in plan, reducing rows fed into joins and potentially changing join order.",
      "recommended_patch_ops": ["insert_cte", "replace_from"],
      "recommended_examples": [],
      "rank_rationale": "Targets secondary hotspot — large aggregate input with exploratory pushdown.",
      "gold_example_id": ""
    },
    {
      "probe_id": "p03",
      "transform_id": "dimension_prefetch_star",
      "family": "F",
      "target": "Pre-filter all selective dimensions (date_dim, customer_demographics, customer, customer_address, item) into CTEs before joining with catalog_sales, using explicit JOIN syntax to create small hash tables and improve join estimates.",
      "dag_target_hint": "Create CTEs for each dimension with their filters, then join them with catalog_sales in final_select using explicit JOINs.",
      "node_contract": {
        "from_must_include": ["catalog_sales cs", "date_dim d", "item i", "customer_demographics cd", "customer c", "customer_address ca"],
        "where_must_preserve": ["cs_sold_date_sk = d_date_sk", "cs_item_sk = i_item_sk", "cs_bill_cdemo_sk = cd_demo_sk", "cs_bill_customer_sk = c_customer_sk", "cd_gender = 'F'", "cd_education_status = '4 yr Degree'", "c_current_addr_sk = ca_address_sk", "d_year = 1999", "c_birth_month = 12", "ca_state in ('AR', 'IN', 'VA')", "cs_wholesale_cost BETWEEN 5 AND 10", "i_category = 'Music'"],
        "output_must_preserve": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1 to agg6", "GROUP BY ROLLUP and ORDER BY LIMIT behavior"]
      },
      "gates_checked": ["G_PG_COMMA_JOIN_PRESENT:PASS", "G_PG_COMMA_FACT_FANOUT:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Prefetching all dimensions could further reduce fact table scan and improve join order beyond date isolation.",
      "confidence": 0.70,
      "expected_explain_delta": "Multiple CTEs materialized, joins become hash joins with smaller build sides and reduced nested loops.",
      "recommended_patch_ops": ["insert_multiple_ctes", "replace_from", "convert_to_explicit_join"],
      "recommended_examples": ["pg_dimension_prefetch_star"],
      "rank_rationale": "Exploration — extends explicit join conversion to all dimensions for potential further gain on primary hotspot.",
      "gold_example_id": ""
    },
    {
      "probe_id": "p04",
      "transform_id": "dimension_cte_isolate",
      "family": "A",
      "target": "Isolate dimension filters into CTEs (e.g., date_dim, customer_demographics) to materialize small result sets before joining with catalog_sales, using comma joins but with early reduction.",
      "dag_target_hint": "Create CTEs for selective dimensions and reference them in the FROM clause, keeping comma joins but with pre-filtered data.",
      "node_contract": {
        "from_must_include": ["catalog_sales cs", "date_dim d", "item i", "customer_demographics cd", "customer c", "customer_address ca"],
        "where_must_preserve": ["cs_sold_date_sk = d_date_sk", "cs_item_sk = i_item_sk", "cs_bill_cdemo_sk = cd_demo_sk", "cs_bill_customer_sk = c_customer_sk", "cd_gender = 'F'", "cd_education_status = '4 yr Degree'", "c_current_addr_sk = ca_address_sk", "d_year = 1999", "c_birth_month = 12", "ca_state in ('AR', 'IN', 'VA')", "cs_wholesale_cost BETWEEN 5 AND 10", "i_category = 'Music'"],
        "output_must_preserve": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1 to agg6", "GROUP BY ROLLUP and ORDER BY LIMIT behavior"]
      },
      "gates_checked": ["portability_candidate:CAUTION", "CROSS_CTE_PREDICATE_BLINDNESS:addressed with CTE isolation"],
      "exploration": true,
      "exploration_hypothesis": "Early filtering of dimensions might reduce fact table scan even with comma joins, testing portability transform.",
      "confidence": 0.50,
      "expected_explain_delta": "Dimension scans become CTE materializations, potentially reducing nested loops and improving scan efficiency.",
      "recommended_patch_ops": ["insert_ctes", "replace_from"],
      "recommended_examples": [],
      "rank_rationale": "Exploration — tests early filtering with a portability candidate transform on secondary hotspot.",
      "gold_example_id": ""
    }
  ],
  "dropped": [
    {
      "transform_id": "or_to_union",
      "family": "D",
      "reason": "No OR predicate in the query; engine guardrails protect against unnecessary splits."
    },
    {
      "transform_id": "intersect_to_exists",
      "family": "D",
      "reason": "No INTERSECT operation in the query; transform not applicable."
    },
    {
      "transform_id": "decorrelate",
      "family": "B",
      "reason": "No correlated subqueries in the query; plan shows no evidence for decorrelation."
    }
  ]
}