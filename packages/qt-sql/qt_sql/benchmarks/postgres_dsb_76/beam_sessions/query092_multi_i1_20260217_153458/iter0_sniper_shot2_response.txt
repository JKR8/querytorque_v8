[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p03",
    "hypothesis": "Original plan shows correlated subquery re-execution per row. Precompute thresholds via CTE to eliminate nested loops. Convert comma-joins to explicit syntax to aid optimizer join reordering.",
    "target_ir": "CTE for thresholds + explicit JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH item_thresholds AS (SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '2002-03-06' AND CAST('2002-03-06' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_cost BETWEEN 16 AND 36 AND ws_sales_price / ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01 GROUP BY ws_item_sk) SELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales ws JOIN item i ON i.i_item_sk = ws.ws_item_sk JOIN date_dim dd ON dd.d_date_sk = ws.ws_sold_date_sk JOIN item_thresholds it ON ws.ws_item_sk = it.ws_item_sk WHERE (i.i_manufact_id BETWEEN 566 AND 765 OR i.i_category IN ('Children', 'Jewelry', 'Men')) AND dd.d_date BETWEEN '2002-03-06' AND CAST('2002-03-06' AS DATE) + INTERVAL '90 DAY' AND ws.ws_wholesale_cost BETWEEN 16 AND 36 AND ws.ws_ext_discount_amt > it.threshold ORDER BY SUM(ws.ws_ext_discount_amt) LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p06",
    "hypothesis": "Comma-join syntax limits optimizer choices. Prefilter dimensions via CTEs and convert to explicit JOINs. Retain subquery correlation but reduce iterations via filtered items.",
    "target_ir": "CTEs for dimensions + explicit JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_items AS (SELECT i_item_sk FROM item WHERE i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men')), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND CAST('2002-03-06' AS DATE) + INTERVAL '90 DAY') SELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales ws JOIN filtered_items fi ON fi.i_item_sk = ws.ws_item_sk JOIN filtered_dates fd ON fd.d_date_sk = ws.ws_sold_date_sk WHERE ws.ws_wholesale_cost BETWEEN 16 AND 36 AND ws.ws_ext_discount_amt > (SELECT 1.3 * AVG(ws2.ws_ext_discount_amt) FROM web_sales ws2 JOIN filtered_dates fd2 ON fd2.d_date_sk = ws2.ws_sold_date_sk WHERE ws2.ws_item_sk = fi.i_item_sk AND ws2.ws_wholesale_cost BETWEEN 16 AND 36 AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01) ORDER BY SUM(ws.ws_ext_discount_amt) LIMIT 100;"
        }
      }
    ]
  }
]