{
  "probe_id": "p01",
  "transform_id": "inline_decorrelate_materialized",
  "family": "B",
  "dialect": "postgres",
  "hypothesis": "Decompose correlated scalar subquery into 3 MATERIALIZED CTEs to eliminate per-row re-execution and enable early filtering of large fact tables.",
  "reasoning_trace": [
    "Correlated subquery computes per-item threshold causing nested loop",
    "Comma-join syntax may block optimal join planning",
    "Precompute thresholds in materialized CTEs to allow hash join"
  ],
  "target_ir": "Three MATERIALIZED CTEs: filtered date_dim, precomputed item thresholds, and main fact data joined explicitly",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_date_dim",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "item_thresholds",
        "cte_query_sql": "SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold_value FROM web_sales ws JOIN filtered_date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk WHERE ws.ws_wholesale_cost BETWEEN 16 AND 36 AND ws.ws_sales_price / ws.ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01 GROUP BY ws_item_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN filtered_date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk JOIN item_thresholds it ON ws.ws_item_sk = it.ws_item_sk"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "(i.i_manufact_id BETWEEN 566 AND 765 OR i.i_category IN ('Children', 'Jewelry', 'Men')) AND ws.ws_wholesale_cost BETWEEN 16 AND 36 AND ws.ws_ext_discount_amt > it.threshold_value"
      }
    }
  ]
}