{
  "iteration": 1,
  "n_api_calls": 7,
  "best_speedup": 7.76,
  "best_patch_id": "t1_plus_A",
  "best_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1998), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN filtered_household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN filtered_dates AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN filtered_dates AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN filtered_dates AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
  "patches": [
    {
      "patch_id": "t1_plus_A",
      "family": "A+E",
      "transform": "prefetch_dates_and_filter_demographics",
      "relevance_score": 0.95,
      "status": "WIN",
      "speedup": 7.76,
      "semantic_passed": true,
      "error": null,
      "original_ms": 460.6,
      "patch_ms": 59.4,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1998), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN filtered_household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN filtered_dates AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN filtered_dates AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN filtered_dates AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t1_cd_filter",
      "family": "A",
      "transform": "customer_demographics_pushdown",
      "relevance_score": 0.9,
      "status": "NEUTRAL",
      "speedup": 0.97,
      "semantic_passed": true,
      "error": null,
      "original_ms": 460.6,
      "patch_ms": 476.8,
      "output_sql": "WITH filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1998 AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t1_agg_pushdown",
      "family": "C",
      "transform": "aggregate_before_joins",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Equivalence execution error: column cs.cs_bill_cdemo_sk does not exist\nLINE 1: ...item_sk = cs.cs_item_sk JOIN filtered_cd AS cd ON cs.cs_bill...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH cs_agg AS (SELECT cs_item_sk, cs_sold_date_sk, cs_promo_sk, cs_order_number, SUM(cs_quantity) AS total_quantity, COUNT(*) AS total_cnt, SUM(CASE WHEN cs_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT cs_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY cs_item_sk, cs_sold_date_sk, cs_promo_sk, cs_order_number), filtered_date AS (SELECT d_date_sk, d_date, d_week_seq FROM date_dim WHERE d_year = 1998), filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM cs_agg AS cs JOIN inventory AS inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse AS w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN filtered_item AS i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_cd AS cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_hd AS hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_date AS d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv.inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns AS cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.total_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t1_fixed_t3",
      "family": "F",
      "transform": "date_self_join_elimination_fixed",
      "relevance_score": 0.8,
      "status": "WIN",
      "speedup": 7.75,
      "semantic_passed": true,
      "error": null,
      "original_ms": 460.6,
      "patch_ms": 59.4,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1998) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales INNER JOIN inventory ON cs_item_sk = inv_item_sk INNER JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk INNER JOIN item ON i_item_sk = cs_item_sk INNER JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk INNER JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk INNER JOIN filtered_dates AS d1 ON cs_sold_date_sk = d1.d_date_sk INNER JOIN filtered_dates AS d2 ON inv_date_sk = d2.d_date_sk INNER JOIN filtered_dates AS d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    }
  ],
  "explains": {
    "t1_plus_A": "Limit  (rows=0, time=42.332)\n  Index Scan on date_dim  (rows=0, time=0.0)\n  Sort  (rows=0, time=42.329)\n    Aggregate  (rows=0, time=42.306)\n      Sort  (rows=0, time=42.305)\n        Nested Loop  (rows=0, time=42.299)\n          Nested Loop  (rows=0, time=42.297)\n            Nested Loop  (rows=0, time=42.296)\n              Nested Loop  (rows=0, time=42.295)\n                Nested Loop  (rows=0, time=42.293)\n                  Nested Loop  (rows=0, time=42.292)\n                    Nested Loop  (row",
    "t1_cd_filter": "Limit  (rows=0, time=464.828)\n  Sort  (rows=0, time=464.826)\n    Aggregate  (rows=0, time=464.812)\n      Nested Loop  (rows=0, time=464.81)\n        Gather Merge  (rows=0, time=464.809)\n          Sort  (rows=0, time=456.816)\n            Nested Loop  (rows=0, time=456.795)\n              Nested Loop  (rows=0, time=456.793)\n                Nested Loop  (rows=0, time=456.792)\n                  Nested Loop  (rows=0, time=456.792)\n                    Hash Join  (rows=0, time=456.79)\n                   ",
    "t1_fixed_t3": "Limit  (rows=0, time=37.94)\n  Index Scan on date_dim  (rows=0, time=0.0)\n  Sort  (rows=0, time=37.937)\n    Aggregate  (rows=0, time=37.897)\n      Sort  (rows=0, time=37.896)\n        Nested Loop  (rows=0, time=37.89)\n          Nested Loop  (rows=0, time=37.89)\n            Nested Loop  (rows=0, time=37.889)\n              Nested Loop  (rows=0, time=37.888)\n                Nested Loop  (rows=0, time=37.887)\n                  Nested Loop  (rows=0, time=37.886)\n                    Nested Loop  (rows=0"
  }
}