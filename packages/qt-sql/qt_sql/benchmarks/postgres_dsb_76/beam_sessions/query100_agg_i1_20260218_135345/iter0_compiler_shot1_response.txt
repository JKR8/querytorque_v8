[
  {
    "plan_id": "compile_p01",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Explicit join reordering with selective CTE.",
    "hypothesis": "Probe p01 (1.78x) addressed comma‑join weakness by converting to explicit INNER JOIN and isolating date_dim filter into a materialized CTE, reducing rows early and improving join ordering.",
    "expected_explain_delta": "Merge Join replaced by hash joins, reduced nested‑loop amplification, earlier application of selective date filter.",
    "target_ir": "Replace comma joins with explicit joins and add date_dim CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_dim_cte", "item1", "item2", "s1", "s2", "customer", "customer_address", "customer_demographics"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH date_dim_cte AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year between 1998 and 1998 + 1) SELECT item1.i_item_sk, item2.i_item_sk, count(*) as cnt FROM item AS item1 INNER JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk INNER JOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk INNER JOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number INNER JOIN date_dim_cte d ON d.d_date_sk = s1.ss_sold_date_sk INNER JOIN customer ON s1.ss_customer_sk = c_customer_sk INNER JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE item1.i_category in ('Electronics', 'Jewelry') AND item2.i_manager_id between 81 and 100 AND cd_marital_status = 'S' AND cd_education_status = 'College' AND s1.ss_list_price between 108 and 122 AND s2.ss_list_price between 108 and 122 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        },
        {
          "node_id": "date_dim_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_year"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_year FROM date_dim WHERE d_year between 1998 and 1998 + 1"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p03",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p03",
    "strategy": "Early fact‑table reduction via CTE.",
    "hypothesis": "Probe p03 (1.78x) materialized the filtered fact‑table join (store_sales s1 with date_dim and item1) into a CTE, reducing rows before joining with s2 and the non‑equi condition.",
    "expected_explain_delta": "Large Merge Join removed, nested‑loop iterations reduced, earlier aggregation input shrunk.",
    "target_ir": "Add CTE for filtered s1 and adjust main query.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["cte_s1", "item2", "s2", "customer", "customer_address", "customer_demographics"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH cte_s1 AS (SELECT s1.ss_customer_sk, s1.ss_ticket_number, item1.i_item_sk FROM store_sales AS s1 JOIN date_dim ON d_date_sk = s1.ss_sold_date_sk JOIN item AS item1 ON s1.ss_item_sk = item1.i_item_sk WHERE d_year BETWEEN 1998 AND 1999 AND item1.i_category IN ('Electronics', 'Jewelry') AND s1.ss_list_price BETWEEN 108 AND 122) SELECT cte_s1.i_item_sk, item2.i_item_sk, count(*) as cnt FROM cte_s1 JOIN item AS item2 ON cte_s1.i_item_sk < item2.i_item_sk JOIN store_sales AS s2 ON cte_s1.ss_ticket_number = s2.ss_ticket_number AND s2.ss_item_sk = item2.i_item_sk JOIN customer ON cte_s1.ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk WHERE item2.i_manager_id BETWEEN 81 AND 100 AND cd_marital_status = 'S' AND cd_education_status = 'College' AND s2.ss_list_price BETWEEN 108 AND 122 GROUP BY cte_s1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        },
        {
          "node_id": "cte_s1",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "item"],
          "outputs": ["ss_customer_sk", "ss_ticket_number", "i_item_sk"],
          "changed": true,
          "sql": "SELECT s1.ss_customer_sk, s1.ss_ticket_number, item1.i_item_sk FROM store_sales AS s1 JOIN date_dim ON d_date_sk = s1.ss_sold_date_sk JOIN item AS item1 ON s1.ss_item_sk = item1.i_item_sk WHERE d_year BETWEEN 1998 AND 1999 AND item1.i_category IN ('Electronics', 'Jewelry') AND s1.ss_list_price BETWEEN 108 AND 122"
        }
      ]
    }
  }
]