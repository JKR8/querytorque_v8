{
  "probe_id": "scout_early_filter_decorrelate",
  "transform_id": "early_filter_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Early filtering of catalog_sales and date_dim into CTEs reduces rows before decorrelation. Pre-computing the average discount in a CTE avoids repeated subquery execution per outer row.",
  "reasoning_trace": [
    "Identified correlated scalar subquery on cs_item_sk with repeated execution per Hash Join row.",
    "Moved date and item filters into prefilters to reduce CTE sizes before decorrelation.",
    "Computed average discount threshold in separate CTE to replace per-row subquery."
  ],
  "target_ir": "Introduce prefiltered catalog_sales and date_dim CTEs, compute avg discount in threshold CTE, join with main fact CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["main_fact", "item_filtered", "date_filtered"],
        "outputs": ["excess discount amount"],
        "changed": true,
        "sql": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM main_fact JOIN item_filtered ON main_fact.cs_item_sk = item_filtered.i_item_sk JOIN date_filtered ON main_fact.cs_sold_date_sk = date_filtered.d_date_sk WHERE cs_ext_discount_amt > (SELECT avg_threshold FROM threshold_cte) ORDER BY SUM(cs_ext_discount_amt) LIMIT 100"
      },
      {
        "node_id": "main_fact",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales"],
        "outputs": ["cs_item_sk", "cs_sold_date_sk", "cs_ext_discount_amt"],
        "changed": true,
        "sql": "SELECT cs_item_sk, cs_sold_date_sk, cs_ext_discount_amt FROM catalog_sales"
      },
      {
        "node_id": "item_filtered",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk"],
        "changed": true,
        "sql": "SELECT i_item_sk FROM item WHERE (i_manufact_id IN (47, 226, 612, 676, 818) OR i_manager_id BETWEEN 71 AND 100)"
      },
      {
        "node_id": "date_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'"
      },
      {
        "node_id": "threshold_cte",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "date_dim"],
        "outputs": ["avg_threshold"],
        "changed": true,
        "sql": "SELECT 1.3 * AVG(cs_ext_discount_amt) AS avg_threshold FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 108 AND 137 AND cs_sales_price / cs_list_price BETWEEN 0.23 AND 0.43"
      }
    ]
  }
}