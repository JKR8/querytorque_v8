{
  "probe_id": "p01",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Pre-filter inventory and date_dim before aggregation to reduce CTE materialization size and avoid hash join amplification on large self-join.",
  "reasoning_trace": [
    "CTE materializes full year data before d_moy filtering, causing excessive row count",
    "Self-join on large CTE output leads to expensive hash joins",
    "Filtering early in CTE reduces inner query size and enables better join planning"
  ],
  "target_ir": "Filtered inventory joined with pre-filtered date_dim in CTE; main query joins two references of the same filtered CTE.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_inventory",
        "cte_query_sql": "SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory WHERE inv_quantity_on_hand BETWEEN 0 AND 200"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM filtered_inventory inv JOIN item i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND i.i_category IN ('Jewelry', 'Men') AND i.i_manager_id BETWEEN 81 and 100 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1) inv"
      }
    }
  ]
}