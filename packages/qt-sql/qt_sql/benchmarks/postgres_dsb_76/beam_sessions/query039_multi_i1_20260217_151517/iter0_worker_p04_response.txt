{
  "probe_id": "p01",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Decompose self-join on aggregated inventory data by materializing base scan once and deriving aggregates separately to avoid repeated full scans and reduce hash join amplification.",
  "reasoning_trace": [
    "Original query computes same inventory aggregate twice in CTE `inv`, causing redundant large scans",
    "Self-join on CTE results in 2.4M+ row hash join due to lack of early filtering",
    "Materialize shared inventory scan as CTE_base, then compute inv1/inv2 aggregates from it"
  ],
  "target_ir": "CTE_base with filtered inventory joined to date_dim/item/warehouse; two separate aggregate CTEs for inv1 and inv2 derived from CTE_base",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "CTE_base",
        "cte_query_sql": "SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory WHERE inv_quantity_on_hand BETWEEN 0 AND 200"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "with CTE_base as (SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory WHERE inv_quantity_on_hand BETWEEN 0 AND 200),\ninv1 as (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stdev,mean, case mean when 0 then null else stdev/mean end cov from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean from CTE_base ib ,item ,warehouse ,date_dim where ib.inv_item_sk = i_item_sk and ib.inv_warehouse_sk = w_warehouse_sk and ib.inv_date_sk = d_date_sk and d_year =2002 and i_category IN ('Jewelry', 'Men') and i_manager_id BETWEEN 81 and 100 group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo where case mean when 0 then 0 else stdev/mean end > 1 and d_moy=2),\ninv2 as (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stdev,mean, case mean when 0 then null else stdev/mean end cov from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean from CTE_base ib ,item ,warehouse ,date_dim where ib.inv_item_sk = i_item_sk and ib.inv_warehouse_sk = w_warehouse_sk and ib.inv_date_sk = d_date_sk and d_year =2002 and i_category IN ('Jewelry', 'Men') and i_manager_id BETWEEN 81 and 100 group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo where case mean when 0 then 0 else stdev/mean end > 1 and d_moy=3)\nselect inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov ,inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov from inv1,inv2 where inv1.i_item_sk = inv2.i_item_sk and inv1.w_warehouse_sk = inv2.w_warehouse_sk order by inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov ,inv2.d_moy,inv2.mean, inv2.cov"
      }
    }
  ]
}