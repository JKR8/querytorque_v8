[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01",
    "strategy": "Foundation plus early filter pushdown",
    "hypothesis": "Pushing d_moy filter into CTE subquery reduces aggregation workload by 90% (from 12 months to 2 months). Original plan showed full year scan despite later d_moy=2/3 filters due to CTE materialization fence",
    "target_ir": "CTE inv now includes d_moy IN (2,3) in inner query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH inv AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy IN (2,3) GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov, inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov FROM inv inv1, inv inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy=2 AND inv2.d_moy=2+1 ORDER BY inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov, inv2.d_moy,inv2.mean, inv2.cov;"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "WITH inv AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy IN (2,3) GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov, inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov FROM inv inv1, inv inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy=2 AND inv2.d_moy=2+1 AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov, inv2.d_moy,inv2.mean, inv2.cov;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p02,p04",
    "strategy": "Self-join decomposition with literal preservation",
    "hypothesis": "Splitting CTE by month avoids materializing full year aggregate. Preserves original literal '2.0' and 2+1 expression to prevent regression. Targets COMMA_JOIN_WEAKNESS in large self-join",
    "target_ir": "Two CTEs (inv_m2, inv_m3) replacing single inv CTE",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH inv_m2 AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 2 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1), inv_m3 AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 2+1 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov, inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov FROM inv_m2 inv1, inv_m3 inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk ORDER BY inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov, inv2.d_moy,inv2.mean, inv2.cov;"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "WITH inv_m2 AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 2 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1), inv_m3 AS (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy, stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 2+1 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1) SELECT inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov, inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov FROM inv_m2 inv1, inv_m3 inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov, inv2.d_moy,inv2.mean, inv2.cov;"
        }
      }
    ]
  }
]