[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "original",
    "strategy": "Push d_moy filter into CTE subquery",
    "hypothesis": "Original CTE scans entire year before filtering. Adding d_moy IN (2,3) reduces CTE materialization by 83% (12â†’2 months) while preserving semantics. This targets the full-year scan hotspot shown in BDA.",
    "target_ir": "CTE with d_moy filter in inner subquery",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "with inv as\n(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Jewelry', 'Men')\n        and i_manager_id BETWEEN 81 and 100\n        and inv_quantity_on_hand between 0 and 200\n        and d_moy in (2,3)\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1)\nselect inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov\n        ,inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov\nfrom inv inv1,inv inv2\nwhere inv1.i_item_sk = inv2.i_item_sk\n  and inv1.w_warehouse_sk =  inv2.w_warehouse_sk\n  and inv1.d_moy=2\n  and inv2.d_moy=2+1\norder by inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov\n        ,inv2.d_moy,inv2.mean, inv2.cov"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "with inv as\n(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Jewelry', 'Men')\n        and i_manager_id BETWEEN 81 and 100\n        and inv_quantity_on_hand between 0 and 200\n        and d_moy in (2,3)\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1)\nselect inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean, inv1.cov\n        ,inv2.w_warehouse_sk,inv2.i_item_sk,inv2.d_moy,inv2.mean, inv2.cov\nfrom inv inv1,inv inv2\nwhere inv1.i_item_sk = inv2.i_item_sk\n  and inv1.w_warehouse_sk =  inv2.w_warehouse_sk\n  and inv1.d_moy=2\n  and inv2.d_moy=2+1\n  and inv1.cov > 1.5\norder by inv1.w_warehouse_sk,inv1.i_item_sk,inv1.d_moy,inv1.mean,inv1.cov\n        ,inv2.d_moy,inv2.mean, inv2.cov"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "original",
    "strategy": "Decompose into per-month CTEs to avoid self-join",
    "hypothesis": "CTE materialization causes full-year scan. Creating separate CTEs for months 2/3 with early filtering eliminates self-join and reduces aggregation input. Targets CTE fencing and join amplification.",
    "target_ir": "Two CTEs (inv_m2/inv_m3) joined directly in main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "with inv_m2 as (\n  select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n         ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n  from(\n    select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n    from inventory\n        ,item\n        ,warehouse\n        ,date_dim\n    where inv_item_sk = i_item_sk\n      and inv_warehouse_sk = w_warehouse_sk\n      and inv_date_sk = d_date_sk\n      and d_year =2002\n      and i_category IN ('Jewelry', 'Men')\n      and i_manager_id BETWEEN 81 and 100\n      and inv_quantity_on_hand between 0 and 200\n      and d_moy = 2\n    group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n  ) foo where case mean when 0 then 0 else stdev/mean end > 1\n),\ninv_m3 as (\n  select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n         ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n  from(\n    select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n    from inventory\n        ,item\n        ,warehouse\n        ,date_dim\n    where inv_item_sk = i_item_sk\n      and inv_warehouse_sk = w_warehouse_sk\n      and inv_date_sk = d_date_sk\n      and d_year =2002\n      and i_category IN ('Jewelry', 'Men')\n      and i_manager_id BETWEEN 81 and 100\n      and inv_quantity_on_hand between 0 and 200\n      and d_moy = 3\n    group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n  ) foo where case mean when 0 then 0 else stdev/mean end > 1\n)\nselect \n  inv_m2.w_warehouse_sk,inv_m2.i_item_sk,inv_m2.d_moy,inv_m2.mean, inv_m2.cov,\n  inv_m3.w_warehouse_sk,inv_m3.i_item_sk,inv_m3.d_moy,inv_m3.mean, inv_m3.cov\nfrom inv_m2\njoin inv_m3\n  on inv_m2.i_item_sk = inv_m3.i_item_sk\n  and inv_m2.w_warehouse_sk = inv_m3.w_warehouse_sk\norder by inv_m2.w_warehouse_sk,inv_m2.i_item_sk,inv_m2.d_moy,inv_m2.mean,inv_m2.cov\n        ,inv_m3.d_moy,inv_m3.mean, inv_m3.cov"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "with inv_m2 as (\n  select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n         ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n  from(\n    select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n    from inventory\n        ,item\n        ,warehouse\n        ,date_dim\n    where inv_item_sk = i_item_sk\n      and inv_warehouse_sk = w_warehouse_sk\n      and inv_date_sk = d_date_sk\n      and d_year =2002\n      and i_category IN ('Jewelry', 'Men')\n      and i_manager_id BETWEEN 81 and 100\n      and inv_quantity_on_hand between 0 and 200\n      and d_moy = 2\n    group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n  ) foo where case mean when 0 then 0 else stdev/mean end > 1\n),\ninv_m3 as (\n  select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n         ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n  from(\n    select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n    from inventory\n        ,item\n        ,warehouse\n        ,date_dim\n    where inv_item_sk = i_item_sk\n      and inv_warehouse_sk = w_warehouse_sk\n      and inv_date_sk = d_date_sk\n      and d_year =2002\n      and i_category IN ('Jewelry', 'Men')\n      and i_manager_id BETWEEN 81 and 100\n      and inv_quantity_on_hand between 0 and 200\n      and d_moy = 3\n    group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n  ) foo where case mean when 0 then 0 else stdev/mean end > 1\n)\nselect \n  inv_m2.w_warehouse_sk,inv_m2.i_item_sk,inv_m2.d_moy,inv_m2.mean, inv_m2.cov,\n  inv_m3.w_warehouse_sk,inv_m3.i_item_sk,inv_m3.d_moy,inv_m3.mean, inv_m3.cov\nfrom inv_m2\njoin inv_m3\n  on inv_m2.i_item_sk = inv_m3.i_item_sk\n  and inv_m2.w_warehouse_sk = inv_m3.w_warehouse_sk\nwhere inv_m2.cov > 1.5\norder by inv_m2.w_warehouse_sk,inv_m2.i_item_sk,inv_m2.d_moy,inv_m2.mean,inv_m2.cov\n        ,inv_m3.d_moy,inv_m3.mean, inv_m3.cov"
        }
      }
    ]
  }
]