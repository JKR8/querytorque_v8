{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregate inventory on (inv_date_sk, inv_item_sk, inv_warehouse_sk) to reduce row count before joining with dimension tables, avoiding CTE materialization fence and hash join amplification.",
  "reasoning_trace": [
    "CTE materializes full year data before d_moy filtering, causing expensive hash join on 2.4M+ rows",
    "Self-join on CTE amplifies cost due to repeated scans",
    "Pre-aggregation reduces rows entering join, enabling better index usage and avoiding materialization fence"
  ],
  "target_ir": "CTE with pre-aggregated inventory grouped by join keys, joined with dimensions in outer query",
  "steps": [
    {
      "step_id": "s1",
      "op": "wrap_query_with_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "agg_inventory",
        "cte_query_sql": "SELECT inv_date_sk, inv_item_sk, inv_warehouse_sk, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM inventory WHERE inv_quantity_on_hand BETWEEN 0 AND 200 GROUP BY inv_date_sk, inv_item_sk, inv_warehouse_sk"
      }
    }
  ]
}