{
  "probe_id": "p01",
  "transform_id": "self_join_decomposition",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Splitting the CTE into month-specific filtered CTEs will allow PostgreSQL to push down d_moy predicates and avoid full materialization before filtering.",
  "reasoning_trace": [
    "CTE 'inv' is materialized with full year data before d_moy=2/3 filters are applied",
    "Self-join on large CTE output causes hash join amplification",
    "PostgreSQL cannot push outer WHERE conditions into CTE GROUP BY due to materialization fence"
  ],
  "target_ir": "Two CTEs (inv_m2, inv_m3) with embedded d_moy filters; main query joins them explicitly",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "inv_m2",
        "cte_query_sql": "SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory,item,warehouse,date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 2 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "inv_m3",
        "cte_query_sql": "SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,stdev,mean, case mean when 0 then null else stdev/mean end cov FROM (SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory,item,warehouse,date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year =2002 AND i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 and 100 AND inv_quantity_on_hand between 0 and 200 AND d_moy = 3 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo WHERE case mean when 0 then 0 else stdev/mean end > 1"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "inv_m2 inv1 JOIN inv_m3 inv2 ON inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "inv1.cov > 1.5"
      }
    }
  ]
}