{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate repeated scans of inventory into one CTE with conditional aggregation to compute both stddev_samp and avg in a single pass.",
  "reasoning_trace": [
    "Original query computes stdev and mean in subquery foo inside CTE inv",
    "Both aggregates scan same filtered inventory data",
    "Replace with single CTE that pre-aggregates both measures to avoid redundant scans"
  ],
  "target_ir": "CTE computes both stddev_samp and avg in one GROUP BY; main query joins dimension tables to it.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "WITH inv_agg AS (SELECT inv_item_sk, inv_warehouse_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM inventory, date_dim WHERE inv_date_sk = d_date_sk AND d_year = 2002 GROUP BY inv_item_sk, inv_warehouse_sk, d_moy), inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov FROM inv_agg JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk WHERE i_category IN ('Jewelry', 'Men') AND i_manager_id BETWEEN 81 AND 100 AND inv_quantity_on_hand BETWEEN 0 AND 200 AND CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1)"
      }
    }
  ]
}