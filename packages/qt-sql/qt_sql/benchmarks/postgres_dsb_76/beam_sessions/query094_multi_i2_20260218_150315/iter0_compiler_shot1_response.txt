[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.35,
    "based_on": "",
    "strategy": "Explicit join syntax only, preserve original EXISTS/ANTI JOIN semantics.",
    "hypothesis": "All probes regressed. Original plan shows heavy hash join with web_returns (51578 rows) and nested loop EXISTS. PostgreSQL's semi-join optimization is already active. Removing comma joins may improve join order flexibility without materialization overhead from failed CTE attempts.",
    "expected_explain_delta": "Hash Join may reorder; Nested Loop may remain but with better cardinality estimates.",
    "target_ir": "Convert comma joins to explicit INNER JOIN, keep EXISTS/ NOT EXISTS unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "order count",
            "total shipping cost",
            "total net profit"
          ],
          "changed": true,
          "sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  join date_dim on ws1.ws_ship_date_sk = d_date_sk\n  join customer_address on ws1.ws_ship_addr_sk = ca_address_sk\n  join web_site on ws1.ws_web_site_sk = web_site_sk\nwhere\n    d_date between '1999-10-01' and\n           cast('1999-10-01' as date) + interval '60 day'\nand ca_state in ('MO','MT','OK'\n            ,'SC' ,'TX' ,'WI')\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 253 and 282\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (8, 18, 20, 23, 41)\n               )\norder by count(distinct ws_order_number)\nlimit 100;"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.25,
    "based_on": "",
    "strategy": "Anti‑join via left join with pre‑filtered web_returns, EXISTS via distinct order set.",
    "hypothesis": "Residual hotspot is hash join with full web_returns scan. Pre‑filter web_returns by reason_sk before anti‑join. Transform EXISTS to join with distinct order numbers having multiple warehouses to avoid nested loops.",
    "expected_explain_delta": "Hash Join with web_returns replaced by smaller filtered aggregate; EXISTS becomes hash join over pre‑aggregated order list.",
    "target_ir": "Add filtered web_returns aggregate and multi‑warehouse order subquery.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [
            "filtered_ws",
            "multi_warehouse_orders",
            "filtered_wr"
          ],
          "outputs": [
            "order count",
            "total shipping cost",
            "total net profit"
          ],
          "changed": true,
          "sql": "with filtered_ws as (\n  select ws_order_number, ws_warehouse_sk, ws_ext_ship_cost, ws_net_profit\n  from web_sales ws1\n  join date_dim on ws1.ws_ship_date_sk = d_date_sk\n  join customer_address on ws1.ws_ship_addr_sk = ca_address_sk\n  join web_site on ws1.ws_web_site_sk = web_site_sk\n  where d_date between '1999-10-01' and cast('1999-10-01' as date) + interval '60 day'\n    and ca_state in ('MO','MT','OK','SC','TX','WI')\n    and web_gmt_offset >= -5\n    and ws1.ws_list_price between 253 and 282\n),\nmulti_warehouse_orders as (\n  select ws_order_number\n  from web_sales\n  group by ws_order_number\n  having count(distinct ws_warehouse_sk) >= 2\n),\nfiltered_wr as (\n  select distinct wr_order_number\n  from web_returns\n  where wr_reason_sk in (8, 18, 20, 23, 41)\n)\nselect \n   count(distinct f.ws_order_number) as \"order count\"\n  ,sum(f.ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(f.ws_net_profit) as \"total net profit\"\nfrom filtered_ws f\njoin multi_warehouse_orders m on f.ws_order_number = m.ws_order_number\nleft join filtered_wr w on f.ws_order_number = w.wr_order_number\nwhere w.wr_order_number is null\norder by count(distinct f.ws_order_number)\nlimit 100;"
        },
        {
          "node_id": "filtered_ws",
          "parent_node_id": "final_select",
          "sources": [
            "web_sales",
            "date_dim",
            "customer_address",
            "web_site"
          ],
          "outputs": [
            "ws_order_number",
            "ws_warehouse_sk",
            "ws_ext_ship_cost",
            "ws_net_profit"
          ],
          "changed": true,
          "sql": "select ws_order_number, ws_warehouse_sk, ws_ext_ship_cost, ws_net_profit\nfrom web_sales ws1\njoin date_dim on ws1.ws_ship_date_sk = d_date_sk\njoin customer_address on ws1.ws_ship_addr_sk = ca_address_sk\njoin web_site on ws1.ws_web_site_sk = web_site_sk\nwhere d_date between '1999-10-01' and cast('1999-10-01' as date) + interval '60 day'\n  and ca_state in ('MO','MT','OK','SC','TX','WI')\n  and web_gmt_offset >= -5\n  and ws1.ws_list_price between 253 and 282"
        },
        {
          "node_id": "multi_warehouse_orders",
          "parent_node_id": "final_select",
          "sources": [
            "web_sales"
          ],
          "outputs": [
            "ws_order_number"
          ],
          "changed": true,
          "sql": "select ws_order_number\nfrom web_sales\ngroup by ws_order_number\nhaving count(distinct ws_warehouse_sk) >= 2"
        },
        {
          "node_id": "filtered_wr",
          "parent_node_id": "final_select",
          "sources": [
            "web_returns"
          ],
          "outputs": [
            "wr_order_number"
          ],
          "changed": true,
          "sql": "select distinct wr_order_number\nfrom web_returns\nwhere wr_reason_sk in (8, 18, 20, 23, 41)"
        }
      ]
    }
  }
]