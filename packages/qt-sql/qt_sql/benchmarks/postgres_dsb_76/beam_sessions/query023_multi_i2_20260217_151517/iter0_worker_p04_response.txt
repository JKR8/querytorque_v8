{
  "probe_id": "p01",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregating store_sales by customer_sk before joining with customer reduces row amplification and avoids nested loop execution in best_ss_customer CTE.",
  "reasoning_trace": [
    "best_ss_customer CTE shows high cost (70.4s) due to nested loop on unaggregated store_sales",
    "Group-by key c_customer_sk aligns with join key ss_customer_sk",
    "Pushing SUM and GROUP BY into a CTE below the customer join enables early filtering and smaller input to join"
  ],
  "target_ir": "New CTE pre-aggregates store_sales by customer; best_ss_customer joins pre-aggregated CTE with customer and filters on birth year",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "agg_store_sales",
        "cte_query_sql": "SELECT ss_customer_sk, SUM(ss_quantity * ss_sales_price) as ssales FROM store_sales WHERE ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY ss_customer_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {"by_node_id": "CTE_Q_S0_best_ss_customer"},
      "payload": {
        "sql_fragment": "SELECT c.c_customer_sk, agg.ssales FROM customer c JOIN agg_store_sales agg ON c.c_customer_sk = agg.ss_customer_sk WHERE c.c_birth_year BETWEEN 1987 AND 1993 GROUP BY c.c_customer_sk, agg.ssales HAVING agg.ssales > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)"
      }
    }
  ]
}