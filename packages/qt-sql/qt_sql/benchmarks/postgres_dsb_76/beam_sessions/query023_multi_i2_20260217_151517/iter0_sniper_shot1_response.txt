[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p06",
    "strategy": "Convert comma joins to explicit JOINs to improve cardinality estimates",
    "hypothesis": "Original comma joins cause poor row estimates in PostgreSQL. Explicit JOIN syntax will help optimizer choose better plans and reduce nested loop amplification in UNION ALL branches and best_ss_customer CTE",
    "target_ir": "Explicit JOINs in best_ss_customer CTE and UNION ALL branches",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH frequent_ss_items AS (\n  SELECT SUBSTRING(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, COUNT(*) cnt\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  JOIN item ON ss_item_sk = i_item_sk\n  WHERE d_year = 1999\n    AND i_manager_id BETWEEN 44 AND 63\n    AND i_category IN ('Men', 'Music', 'Sports')\n  GROUP BY SUBSTRING(i_item_desc,1,30), i_item_sk, d_date\n  HAVING COUNT(*) > 4\n),\nmax_store_sales AS (\n  SELECT MAX(csales) tpcds_cmax\n  FROM (\n    SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) csales\n    FROM store_sales\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE d_year = 1999\n      AND ss_wholesale_cost BETWEEN 26 AND 36\n    GROUP BY c_customer_sk\n  ) tmp1\n),\nbest_ss_customer AS (\n  SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) ssales\n  FROM store_sales\n  JOIN customer ON ss_customer_sk = c_customer_sk\n  WHERE c_birth_year BETWEEN 1987 AND 1993\n  GROUP BY c_customer_sk\n  HAVING SUM(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)\n)\nSELECT SUM(sales)\nFROM (\n  SELECT cs_quantity*cs_list_price sales\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  WHERE d_year = 1999\n    AND d_moy = 5\n    AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND cs_wholesale_cost BETWEEN 26 AND 36\n  UNION ALL\n  SELECT ws_quantity*ws_list_price sales\n  FROM web_sales\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  WHERE d_year = 1999\n    AND d_moy = 5\n    AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND ws_wholesale_cost BETWEEN 26 AND 36\n) tmp2\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p07",
    "strategy": "Precompute threshold + explicit JOINs to avoid scalar subquery execution",
    "hypothesis": "Scalar subquery in HAVING clause may cause repeated execution. Precomputing threshold as CTE avoids this and explicit JOINs improve cardinality estimates",
    "target_ir": "Added threshold CTE, best_ss_customer references threshold, explicit JOINs in all joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH frequent_ss_items AS (\n  SELECT SUBSTRING(i_item_desc,1,30) itemdesc, i_item_sk item_sk, d_date solddate, COUNT(*) cnt\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  JOIN item ON ss_item_sk = i_item_sk\n  WHERE d_year = 1999\n    AND i_manager_id BETWEEN 44 AND 63\n    AND i_category IN ('Men', 'Music', 'Sports')\n  GROUP BY SUBSTRING(i_item_desc,1,30), i_item_sk, d_date\n  HAVING COUNT(*) > 4\n),\nmax_store_sales AS (\n  SELECT MAX(csales) tpcds_cmax\n  FROM (\n    SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) csales\n    FROM store_sales\n    JOIN customer ON ss_customer_sk = c_customer_sk\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE d_year = 1999\n      AND ss_wholesale_cost BETWEEN 26 AND 36\n    GROUP BY c_customer_sk\n  ) tmp1\n),\nthreshold AS (SELECT (95/100.0) * tpcds_cmax AS thr FROM max_store_sales),\nbest_ss_customer AS (\n  SELECT c_customer_sk, SUM(ss_quantity*ss_sales_price) ssales\n  FROM store_sales\n  JOIN customer ON ss_customer_sk = c_customer_sk\n  WHERE c_birth_year BETWEEN 1987 AND 1993\n  GROUP BY c_customer_sk\n  HAVING SUM(ss_quantity*ss_sales_price) > (SELECT thr FROM threshold)\n)\nSELECT SUM(sales)\nFROM (\n  SELECT cs_quantity*cs_list_price sales\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  WHERE d_year = 1999\n    AND d_moy = 5\n    AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND cs_wholesale_cost BETWEEN 26 AND 36\n  UNION ALL\n  SELECT ws_quantity*ws_list_price sales\n  FROM web_sales\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  WHERE d_year = 1999\n    AND d_moy = 5\n    AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items)\n    AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)\n    AND ws_wholesale_cost BETWEEN 26 AND 36\n) tmp2\nLIMIT 100;"
        }
      }
    ]
  }
]