[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p07",
    "hypothesis": "Convert best_ss_customer CTE's comma join to explicit JOIN and decorrelate HAVING threshold using scalar CTE to avoid correlated subquery re-execution. EXPLAIN shows nested loop amplification from correlated aggregate.",
    "target_ir": "best_ss_customer with explicit JOIN and precomputed threshold scalar",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "threshold_value",
          "cte_query_sql": "SELECT (95/100.0) * tpcds_cmax AS threshold FROM max_store_sales"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "best_ss_customer AS (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales INNER JOIN customer ON ss_customer_sk = c_customer_sk WHERE c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (SELECT threshold FROM threshold_value))"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p08,p11",
    "hypothesis": "Isolate date_dim filter for UNION ALL branches via CTE to enable predicate pushdown and reduce redundant scans. EXPLAIN shows sequential date_dim scans in both UNION branches.",
    "target_ir": "Main query with shared date_dim CTE for catalog/web sales",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "union_dates",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 5"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM catalog_sales, union_dates WHERE cs_sold_date_sk = d_date_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM web_sales, union_dates WHERE ws_sold_date_sk = d_date_sk"
        }
      }
    ]
  }
]