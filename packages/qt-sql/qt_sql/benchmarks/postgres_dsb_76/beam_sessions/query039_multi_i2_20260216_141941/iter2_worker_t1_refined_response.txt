{
  "plan_id": "wildcard_af_early_month_filter_with_window_refined",
  "dialect": "postgres",
  "description": "Push d_moy filter into CTE to reduce aggregation rows and replace self-join with window function to avoid duplicate CTE scans.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "ceb681f4fee117f7"
      },
      "payload": {
        "expr_sql": "d_moy IN (5, 6) AND CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Add d_moy filter to CTE WHERE clause"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov,\n       lead(w_warehouse_sk) over (partition by i_item_sk order by d_moy) as next_w_warehouse_sk,\n       lead(i_item_sk) over (partition by i_item_sk order by d_moy) as next_i_item_sk,\n       lead(d_moy) over (partition by i_item_sk order by d_moy) as next_d_moy,\n       lead(mean) over (partition by i_item_sk order by d_moy) as next_mean,\n       lead(cov) over (partition by i_item_sk order by d_moy) as next_cov\nfrom (select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_quantity_on_hand between 791 and 991\n        and d_moy in (5,6)\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1) inv"
      },
      "description": "Replace FROM clause with windowed version"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "SELECT w_warehouse_sk,i_item_sk,d_moy,mean,cov,\nnext_w_warehouse_sk,next_i_item_sk,next_d_moy,next_mean,next_cov\nFROM inv\nWHERE d_moy=5\nAND cov > 1.5\nORDER BY w_warehouse_sk,i_item_sk,d_moy,mean,cov,\nnext_d_moy,next_mean,next_cov"
      },
      "description": "Replace main query body with simplified select using window functions"
    }
  ]
}