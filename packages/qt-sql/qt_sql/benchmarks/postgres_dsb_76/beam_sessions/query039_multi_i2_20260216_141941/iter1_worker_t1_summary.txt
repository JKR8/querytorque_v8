Worker Role: W4
Family: A+F
Transform: early_month_filter_with_window
Status: OK

--- OUTPUT SQL ---
WITH inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) AS foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1), filtered_inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 AND d_moy IN (5, 6) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy), inv_with_cov AS (SELECT *, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM filtered_inv WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1), inv_windowed AS (SELECT *, LEAD(w_warehouse_sk) OVER w AS next_warehouse_sk, LEAD(i_item_sk) OVER w AS next_item_sk, LEAD(d_moy) OVER w AS next_d_moy, LEAD(mean) OVER w AS next_mean, LEAD(cov) OVER w AS next_cov FROM inv_with_cov WINDOW w AS (PARTITION BY i_item_sk, w_warehouse_sk ORDER BY d_moy)) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv_windowed AS inv1 WHERE inv1.d_moy = 5 AND inv1.next_d_moy = 6 AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov;

WITH inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) AS stdev, AVG(inv_quantity_on_hand) AS mean FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) AS foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv1.next_warehouse_sk, inv1.next_item_sk, inv1.next_d_moy, inv1.next_mean, inv1.next_cov FROM inv_windowed AS inv1 WHERE inv1.d_moy = 5 AND inv1.next_d_moy = 6 AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv1.next_d_moy, inv1.next_mean, inv1.next_cov;