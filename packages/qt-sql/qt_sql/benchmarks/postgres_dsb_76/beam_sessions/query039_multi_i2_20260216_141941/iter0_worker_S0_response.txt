{
  "plan_id": "replace_self_join_with_window",
  "dialect": "postgres",
  "description": "Replace self-join on CTE for consecutive months with window functions to avoid duplicate scanning and joining. Applies to both S0 and S1, with S1 including an additional cov > 1.5 filter.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "inv_combined",
        "cte_query_sql": "SELECT w_warehouse_sk, i_item_sk, d_moy, mean, cov, lead(mean) OVER (PARTITION BY w_warehouse_sk, i_item_sk ORDER BY d_moy) AS next_mean, lead(cov) OVER (PARTITION BY w_warehouse_sk, i_item_sk ORDER BY d_moy) AS next_cov FROM inv"
      },
      "description": "Insert CTE 'inv_combined' that adds window-based lead functions for mean and cov"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "inv_combined"
      },
      "description": "Replace FROM clause to use the new inv_combined CTE instead of self-joined inv"
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "expr_sql": "d_moy = 5 AND next_mean IS NOT NULL"
      },
      "description": "Replace WHERE clause to filter on d_moy=5 and ensure next_mean is not null"
    },
    {
      "step_id": "s4",
      "op": "replace_body",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "sql_fragment": "SELECT w_warehouse_sk, i_item_sk, d_moy, mean, cov, w_warehouse_sk, i_item_sk, d_moy + 1 AS d_moy, next_mean AS mean, next_cov AS cov FROM inv_combined WHERE d_moy = 5 AND next_mean IS NOT NULL AND cov > 1.5 ORDER BY w_warehouse_sk, i_item_sk, d_moy, mean, cov, d_moy + 1, next_mean, next_cov"
      },
      "description": "Replace entire query body for S1 including cov > 1.5 condition"
    }
  ]
}