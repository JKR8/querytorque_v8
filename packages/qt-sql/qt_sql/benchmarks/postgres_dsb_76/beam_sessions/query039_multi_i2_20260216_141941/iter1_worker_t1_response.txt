{
  "plan_id": "wildcard_postgres_early_month_filter_with_window",
  "dialect": "postgres",
  "description": "Push d_moy filter into CTE to reduce aggregation workload and replace self-join with window function LEAD() to avoid duplicate scans and sort-merge joins.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_inv",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 AND d_moy IN (5, 6) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Insert filtered CTE with d_moy IN (5,6) to reduce data volume"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "inv_with_cov",
        "cte_query_sql": "SELECT *, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM filtered_inv WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Add cov calculation and filtering in a new CTE"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "inv_windowed",
        "cte_query_sql": "SELECT *, LEAD(w_warehouse_sk) OVER w AS next_warehouse_sk, LEAD(i_item_sk) OVER w AS next_item_sk, LEAD(d_moy) OVER w AS next_d_moy, LEAD(mean) OVER w AS next_mean, LEAD(cov) OVER w AS next_cov FROM inv_with_cov WINDOW w AS (PARTITION BY i_item_sk, w_warehouse_sk ORDER BY d_moy)"
      },
      "description": "Introduce windowed CTE using LEAD() to replace self-join"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "inv_windowed inv1"
      },
      "description": "Replace FROM clause to use windowed CTE instead of self-join"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "5709b808cc635062"
      },
      "payload": {
        "expr_sql": "inv1.d_moy = 5 AND inv1.next_d_moy = 6 AND inv1.cov > 1.5"
      },
      "description": "Replace WHERE clause to use windowed fields for month comparison"
    },
    {
      "step_id": "s6",
      "op": "replace_body",
      "target": {
        "by_node_id": "S1"
      },
      "payload": {
        "sql_fragment": "WITH filtered_inv AS (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 AND d_moy IN (5, 6) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy), inv_with_cov AS (SELECT *, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM filtered_inv WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1), inv_windowed AS (SELECT *, LEAD(w_warehouse_sk) OVER w AS next_warehouse_sk, LEAD(i_item_sk) OVER w AS next_item_sk, LEAD(d_moy) OVER w AS next_d_moy, LEAD(mean) OVER w AS next_mean, LEAD(cov) OVER w AS next_cov FROM inv_with_cov WINDOW w AS (PARTITION BY i_item_sk, w_warehouse_sk ORDER BY d_moy)) SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv1.next_warehouse_sk, inv1.next_item_sk, inv1.next_d_moy, inv1.next_mean, inv1.next_cov FROM inv_windowed inv1 WHERE inv1.d_moy = 5 AND inv1.next_d_moy = 6 AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv1.next_d_moy, inv1.next_mean, inv1.next_cov"
      },
      "description": "Replace entire S1 body with optimized version including cov filter"
    }
  ]
}