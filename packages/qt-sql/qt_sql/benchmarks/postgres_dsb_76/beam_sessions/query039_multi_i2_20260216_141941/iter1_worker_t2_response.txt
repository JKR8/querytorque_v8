{
  "plan_id": "gold_postgres_pg_shared_scan_decorrelate",
  "dialect": "postgres",
  "description": "Pre-filter months 5-6 in CTE to enable single-pass computation. Materialized CTE prevents re-execution for inv1/inv2. Aggregating inventory before dimension joins reduces input rows to fact-dimension joins.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_inventory",
        "cte_query_sql": "SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory WHERE inv_quantity_on_hand BETWEEN 791 AND 991"
      },
      "description": "Insert CTE 'filtered_inventory' for pre-filtered inventory"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "aggregated_inventory",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean FROM filtered_inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND d_moy IN (5, 6) GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Insert CTE 'aggregated_inventory' for pre-aggregated inventory"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "inv",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM aggregated_inventory WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Insert CTE 'inv' for final filtered and computed inventory"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "inv inv1, inv inv2"
      },
      "description": "Replace comma-join FROM with explicit JOINs"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "5709b808cc635062"
      },
      "payload": {
        "expr_sql": "inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 6"
      },
      "description": "Replace WHERE clause with optimized version"
    }
  ]
}