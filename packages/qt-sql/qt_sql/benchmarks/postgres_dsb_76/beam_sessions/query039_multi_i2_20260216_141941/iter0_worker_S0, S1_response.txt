{
  "plan_id": "remove_unnecessary_join_warehouse",
  "dialect": "postgres",
  "description": "Remove unnecessary warehouse table join by pushing filters down and using inv_warehouse_sk directly from inventory. Reduce join complexity and improve performance.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_inv"
      },
      "payload": {
        "sql_fragment": "SELECT inv_warehouse_sk AS w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) stdev, avg(inv_quantity_on_hand) mean FROM inventory, item, date_dim WHERE inv_item_sk = i_item_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND d_moy IN (5,6) AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY inv_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Replace CTE body to remove warehouse join and push down filters"
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {
        "by_node_id": "Q_S0"
      },
      "payload": {
        "from_sql": "inv inv1, inv inv2"
      },
      "description": "Keep main query FROM clause unchanged"
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "Q_S0",
        "by_anchor_hash": "5709b808cc635062"
      },
      "payload": {
        "expr_sql": "inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 6"
      },
      "description": "Update WHERE clause with simplified join conditions"
    }
  ]
}