{
  "plan_id": "unnester_decorrelate_aggregation_pushdown",
  "dialect": "postgres",
  "description": "Decorrelate and push down aggregation by restructuring the CTE to include filtering and grouping early, reducing per-row re-execution.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "CTE_Q_S0_inv"
      },
      "payload": {
        "sql_fragment": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END AS cov FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND d_moy IN (5, 6) AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy"
      },
      "description": "Replace CTE body to push down aggregation and filter early"
    },
    {
      "step_id": "s2",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "CTE_Q_S0_inv",
        "by_anchor_hash": "ceb681f4fee117f7"
      },
      "payload": {
        "expr_sql": "CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
      },
      "description": "Retain outer filter on coefficient of variation"
    }
  ]
}