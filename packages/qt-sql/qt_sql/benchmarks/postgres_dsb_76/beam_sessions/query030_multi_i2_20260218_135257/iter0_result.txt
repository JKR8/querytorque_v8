{
  "iteration": 0,
  "n_api_calls": 11,
  "beam_cost_usd": 0.03520388,
  "beam_cost_priced_calls": 11,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 141235,
    "completion_tokens": 24538,
    "total_tokens": 165773,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 64768,
    "reasoning_tokens": 11626
  },
  "best_speedup": 130.23,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH customer_total_return AS (SELECT wr.wr_returning_customer_sk AS ctr_customer_sk, ca.ca_state AS ctr_state, wr.wr_reason_sk AS ctr_reason_sk, SUM(wr.wr_return_amt) AS ctr_total_return FROM web_returns wr INNER JOIN date_dim d ON wr.wr_returned_date_sk = d.d_date_sk INNER JOIN item i ON wr.wr_item_sk = i.i_item_sk INNER JOIN customer_address ca ON wr.wr_returning_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND i.i_manager_id BETWEEN 68 AND 77 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 242 AND 271 AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND wr.wr_reason_sk IN (20, 36) GROUP BY wr.wr_returning_customer_sk, ca.ca_state, wr.wr_reason_sk) SELECT c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return FROM customer_total_return AS ctr1, customer_address, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca_address_sk = c_current_addr_sk AND ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.88,
      "status": "REGRESSION",
      "speedup": 0.94,
      "semantic_passed": true,
      "error": null,
      "original_ms": 228.6,
      "patch_ms": 243.7,
      "output_sql": "WITH customer_total_return AS (SELECT wr_returning_customer_sk AS ctr_customer_sk, ca_state AS ctr_state, wr_reason_sk AS ctr_reason_sk, SUM(wr_return_amt) AS ctr_total_return FROM web_returns, date_dim, customer_address, item WHERE wr_returned_date_sk = d_date_sk AND d_year = 2002 AND wr_returning_addr_sk = ca_address_sk AND wr_item_sk = i_item_sk AND i_manager_id BETWEEN 68 AND 77 AND wr_return_amt / wr_return_quantity BETWEEN 242 AND 271 GROUP BY wr_returning_customer_sk, ca_state, wr_reason_sk), state_avg AS (SELECT ctr_state, AVG(ctr_total_return) AS avg_ctr_total_return FROM customer_total_return GROUP BY ctr_state) SELECT c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address,c_last_review_date_sk,ctr_total_return FROM customer_total_return ctr1 JOIN state_avg ON ctr1.ctr_state = state_avg.ctr_state JOIN customer_address ON customer_address.ca_address_sk = ctr1.ctr_customer_sk JOIN customer ON customer.c_customer_sk = ctr1.ctr_customer_sk WHERE ctr1.ctr_total_return > state_avg.avg_ctr_total_return * 1.2 AND customer_address.ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_reason_sk IN (20, 36) AND customer.c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id,c_salutation,c_first_name,c_last_name,c_preferred_cust_flag,c_birth_day,c_birth_month,c_birth_year,c_birth_country,c_login,c_email_address,c_last_review_date_sk,ctr_total_return LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Replace correlated scalar subquery with MATERIALIZED CTE computing avg(ctr_total_return) per state, then join. Use MATERIALIZED to prevent re-inlining and force single evaluation."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.65,
      "status": "WIN",
      "speedup": 1.83,
      "semantic_passed": true,
      "error": null,
      "original_ms": 228.6,
      "patch_ms": 124.6,
      "output_sql": "WITH customer_total_return AS (SELECT wr.wr_returning_customer_sk AS ctr_customer_sk, ca.ca_state AS ctr_state, wr.wr_reason_sk AS ctr_reason_sk, SUM(wr.wr_return_amt) AS ctr_total_return FROM web_returns wr INNER JOIN date_dim d ON wr.wr_returned_date_sk = d.d_date_sk INNER JOIN item i ON wr.wr_item_sk = i.i_item_sk INNER JOIN customer_address ca ON wr.wr_returning_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND i.i_manager_id BETWEEN 68 AND 77 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 242 AND 271 AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND wr.wr_reason_sk IN (20, 36) GROUP BY wr.wr_returning_customer_sk, ca.ca_state, wr.wr_reason_sk) SELECT c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return FROM customer_total_return AS ctr1, customer_address, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca_address_sk = c_current_addr_sk AND ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit INNER JOINs and prefetch selective dimension filters (date_dim, item, customer_address) into small CTEs to create tiny hash tables before joining web_returns."
    },
    {
      "patch_id": "p04",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.58,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `web_returns_agg`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH web_returns_agg AS (SELECT wr_returning_customer_sk, wr_returning_addr_sk, wr_item_sk, wr_reason_sk, SUM(wr_return_amt) AS total_return_amt FROM web_returns WHERE wr_return_amt / wr_return_quantity BETWEEN 242 AND 271 GROUP BY wr_returning_customer_sk, wr_returning_addr_sk, wr_item_sk, wr_reason_sk), customer_total_return AS (SELECT wr_agg.wr_returning_customer_sk AS ctr_customer_sk, ca_state AS ctr_state, wr_reason_sk AS ctr_reason_sk, SUM(wr_agg.total_return_amt) AS ctr_total_return FROM (SELECT wr_returning_customer_sk, wr_returning_addr_sk, wr_item_sk, wr_reason_sk, SUM(wr_return_amt) AS total_return_amt FROM web_returns WHERE wr_return_amt / wr_return_quantity BETWEEN 242 AND 271 GROUP BY wr_returning_customer_sk, wr_returning_addr_sk, wr_item_sk, wr_reason_sk) wr_agg JOIN date_dim ON wr_agg.wr_item_sk = i_item_sk AND wr_agg.wr_returning_addr_sk = ca_address_sk AND wr_returned_date_sk = d_date_sk AND d_year = 2002 JOIN customer_address ON wr_agg.wr_returning_addr_sk = ca_address_sk JOIN item ON wr_agg.wr_item_sk = i_item_sk AND i_manager_id BETWEEN 68 AND 77 GROUP BY wr_agg.wr_returning_customer_sk, ca_state, wr_agg.wr_reason_sk) SELECT c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return FROM customer_total_return AS ctr1, customer_address, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca_address_sk = c_current_addr_sk AND ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate web_returns by returning_customer_sk, returning_addr_sk, item_sk before joining dimensions, then compute ctr_total_return after filtering by state and reason."
    },
    {
      "patch_id": "p02",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.82,
      "status": "REGRESSION",
      "speedup": 0.95,
      "semantic_passed": true,
      "error": null,
      "original_ms": 228.6,
      "patch_ms": 241.2,
      "output_sql": "WITH customer_total_return AS (SELECT wr_returning_customer_sk AS ctr_customer_sk, ca_state AS ctr_state, wr_reason_sk AS ctr_reason_sk, SUM(wr_return_amt) AS ctr_total_return FROM web_returns, date_dim, customer_address, item WHERE wr_returned_date_sk = d_date_sk AND d_year = 2002 AND wr_returning_addr_sk = ca_address_sk AND wr_item_sk = i_item_sk AND i_manager_id BETWEEN 68 AND 77 AND wr_return_amt / wr_return_quantity BETWEEN 242 AND 271 GROUP BY wr_returning_customer_sk, ca_state, wr_reason_sk) SELECT c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return FROM customer_total_return AS ctr1, customer_address, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca_address_sk = c_current_addr_sk AND ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Split customer_total_return CTE into two MATERIALIZED CTEs: ctr_filtered (with state and reason filters pushed down) and ctr_all_states (without reason filter for avg). Avoid recomputing full aggregate for unused states/reasons."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 130.23,
      "semantic_passed": true,
      "error": null,
      "original_ms": 18083.9,
      "patch_ms": 138.9,
      "output_sql": "WITH customer_total_return AS (SELECT wr.wr_returning_customer_sk AS ctr_customer_sk, ca.ca_state AS ctr_state, wr.wr_reason_sk AS ctr_reason_sk, SUM(wr.wr_return_amt) AS ctr_total_return FROM web_returns wr INNER JOIN date_dim d ON wr.wr_returned_date_sk = d.d_date_sk INNER JOIN item i ON wr.wr_item_sk = i.i_item_sk INNER JOIN customer_address ca ON wr.wr_returning_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND i.i_manager_id BETWEEN 68 AND 77 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 242 AND 271 AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND wr.wr_reason_sk IN (20, 36) GROUP BY wr.wr_returning_customer_sk, ca.ca_state, wr.wr_reason_sk) SELECT c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return FROM customer_total_return AS ctr1, customer_address, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_state = ctr2.ctr_state) AND ca_address_sk = c_current_addr_sk AND ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr1.ctr_customer_sk = c_customer_sk AND ctr1.ctr_reason_sk IN (20, 36) AND c_birth_year BETWEEN 1985 AND 1991 ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_day, c_birth_month, c_birth_year, c_birth_country, c_login, c_email_address, c_last_review_date_sk, ctr_total_return LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 126.69,
      "semantic_passed": true,
      "error": null,
      "original_ms": 18083.9,
      "patch_ms": 142.7,
      "output_sql": "WITH customer_total_return AS (SELECT wr.wr_returning_customer_sk AS ctr_customer_sk, ca.ca_state AS ctr_state, wr.wr_reason_sk AS ctr_reason_sk, SUM(wr.wr_return_amt) AS ctr_total_return FROM web_returns wr INNER JOIN date_dim d ON wr.wr_returned_date_sk = d.d_date_sk INNER JOIN item i ON wr.wr_item_sk = i.i_item_sk INNER JOIN customer_address ca ON wr.wr_returning_addr_sk = ca.ca_address_sk WHERE d.d_year = 2002 AND i.i_manager_id BETWEEN 68 AND 77 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 242 AND 271 AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND wr.wr_reason_sk IN (20, 36) GROUP BY wr.wr_returning_customer_sk, ca.ca_state, wr.wr_reason_sk), state_avg AS (SELECT ctr_state, AVG(ctr_total_return) AS avg_ctr_total_return FROM customer_total_return GROUP BY ctr_state) SELECT c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr.ctr_total_return FROM customer_total_return ctr JOIN state_avg sa ON ctr.ctr_state = sa.ctr_state JOIN customer_address ca ON ca.ca_address_sk = ctr.ctr_customer_sk JOIN customer c ON c.c_customer_sk = ctr.ctr_customer_sk WHERE ctr.ctr_total_return > sa.avg_ctr_total_return * 1.2 AND ca.ca_state IN ('OK', 'SC', 'TX', 'WI') AND ctr.ctr_reason_sk IN (20, 36) AND c.c_birth_year BETWEEN 1985 AND 1991 ORDER BY c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, c.c_birth_day, c.c_birth_month, c.c_birth_year, c.c_birth_country, c.c_login, c.c_email_address, c.c_last_review_date_sk, ctr.ctr_total_return LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=0, time=230.016)\n  Aggregate  (rows=99, time=229.893)\n    Sort  (rows=99, time=229.858)\n      Gather  (rows=99, time=229.804)\n        Nested Loop  (rows=99, time=229.527)\n          Nested Loop  (rows=100, time=229.188)\n            Hash Join  (rows=1070, time=226.572)\n              Seq Scan on web_returns  (rows=7850, time=225.514)\n              Hash  (rows=365, time=0.069)\n                Index Only Scan on date_dim  (rows=365, time=0.04)\n            Index Scan on item  (rows=0, tim",
    "p03": "Limit  (rows=0, time=122.806)\n  Aggregate  (rows=2, time=122.775)\n    Nested Loop  (rows=2, time=122.769)\n      Gather Merge  (rows=8, time=122.708)\n        Sort  (rows=8, time=122.457)\n          Nested Loop  (rows=8, time=122.448)\n            Merge Join  (rows=46, time=122.118)\n              Sort  (rows=227, time=122.013)\n                Seq Scan on web_returns (wr)  (rows=283, time=121.842)\n              Index Only Scan on date_dim (d)  (rows=365, time=0.08)\n            Index Scan on customer_",
    "p02": "Limit  (rows=0, time=244.044)\n  Aggregate  (rows=99, time=243.934)\n    Sort  (rows=99, time=243.899)\n      Gather  (rows=99, time=243.839)\n        Nested Loop  (rows=99, time=243.562)\n          Nested Loop  (rows=100, time=242.696)\n            Hash Join  (rows=1070, time=239.044)\n              Seq Scan on web_returns  (rows=7850, time=237.868)\n              Hash  (rows=365, time=0.073)\n                Index Only Scan on date_dim  (rows=365, time=0.043)\n            Index Scan on item  (rows=0, ti",
    "compile_p1": "Limit  (rows=0, time=125.522)\n  Aggregate  (rows=2, time=125.479)\n    Nested Loop  (rows=2, time=125.47)\n      Gather Merge  (rows=8, time=125.416)\n        Sort  (rows=8, time=125.041)\n          Nested Loop  (rows=8, time=125.031)\n            Merge Join  (rows=46, time=124.821)\n              Sort  (rows=227, time=124.745)\n                Seq Scan on web_returns (wr)  (rows=283, time=124.59)\n              Index Only Scan on date_dim (d)  (rows=365, time=0.05)\n            Index Scan on customer_ad",
    "compile_p2": "Limit  (rows=0, time=125.078)\n  Aggregate  (rows=2, time=125.019)\n    Nested Loop  (rows=2, time=125.014)\n      Gather Merge  (rows=8, time=124.953)\n        Sort  (rows=8, time=124.674)\n          Nested Loop  (rows=8, time=124.653)\n            Merge Join  (rows=46, time=124.495)\n              Sort  (rows=227, time=124.417)\n                Seq Scan on web_returns (wr)  (rows=283, time=124.189)\n              Index Only Scan on date_dim (d)  (rows=365, time=0.054)\n            Index Scan on customer"
  }
}