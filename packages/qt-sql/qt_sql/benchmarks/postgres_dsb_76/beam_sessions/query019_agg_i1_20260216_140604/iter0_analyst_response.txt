### Analysis of Families

- **Family A (Early Filtering)**: HIGH  
  Multiple dimension tables (`item`, `customer_address`, `customer`, `date_dim`) have selective filters applied late in nested loops. Pushing these filters into CTEs early would drastically reduce join cardinality.

- **Family B (Decorrelation)**: LOW  
  No correlated subqueries exist in the query. The execution plan shows nested loops but not due to correlation.

- **Family C (Aggregation Pushdown)**: MEDIUM  
  Grouping keys (`i_brand_id`, `i_brand`, etc.) are a superset of `item` join keys. Aggregating after filtering dimensions but before joining with `item` could reduce rows.

- **Family D (Set Operations)**: LOW  
  No `INTERSECT`/`UNION` operations exist in the query.

- **Family E (Materialization)**: HIGH  
  Repeated dimension scans (e.g., `customer` → `customer_address`) could be pre-joined and materialized. State/zip filters on `customer_address` and `store` benefit from prefetch.

- **Family F (Join Transform)**: HIGH  
  Implicit comma joins obscure join order control. Restructuring to explicit joins with filtered CTEs enables optimal dimension order (most selective first).

**Chosen families**: A, C, E, F  
**Confidence**: High (plan shows late filtering on high-cardinality joins)

---

### Optimization Targets

```json
[
  {
    "family": "A",
    "transform": "early_filtering",
    "target_id": "t1",
    "relevance_score": 0.98,
    "hypothesis": "Filters on item/customer/address are applied late, forcing large nested loops. Isolating filtered dimensions first reduces join cardinality by 10-100x.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_date (via Q1)\n    FROM: date_dim\n    WHERE: d_year=2002 AND d_moy=4\n  CTE: filtered_item (via Q2)\n    FROM: item\n    WHERE: i_category='Jewelry'\n  CTE: filtered_ca (via Q3)\n    FROM: customer_address\n    WHERE: ca_state='IL'\n  CTE: filtered_customer (via Q4)\n    FROM: customer\n    WHERE: c_birth_month=1\n  MAIN QUERY (via Q0)\n    FROM: store_sales\n    INNER JOIN filtered_date ON ss_sold_date_sk = d_date_sk\n    INNER JOIN filtered_item ON ss_item_sk = i_item_sk\n    INNER JOIN filtered_customer ON ss_customer_sk = c_customer_sk\n    INNER JOIN filtered_ca ON c_current_addr_sk = ca_address_sk\n    INNER JOIN store ON ss_store_sk = s_store_sk\n    WHERE: ss_wholesale_cost BETWEEN 35 AND 55\n      AND substring(ca_zip,1,5) <> substring(s_zip,1,5)\n    GROUP BY: i_brand, i_brand_id, i_manufact_id, i_manufact\n    ORDER BY: sum(ss_ext_sales_price) DESC, i_brand, i_brand_id, i_manufact_id, i_manufact\n    LIMIT: 100",
    "recommended_examples": ["pg_date_cte_explicit_join"]
  },
  {
    "family": "F",
    "transform": "explicit_join_materialized",
    "target_id": "t2",
    "relevance_score": 0.92,
    "hypothesis": "Implicit comma joins prevent join order optimization. Explicit joins with materialized CTEs allow ordered dimension injection (date→item→customer first).",
    "target_ir": "S0 [SELECT]\n  CTE: precomputed_dims (via Q1)\n    SELECT: d_date_sk, i_item_sk, c_customer_sk, ca_address_sk\n    FROM: date_dim\n    INNER JOIN item ON true\n    INNER JOIN customer ON true\n    INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk\n    WHERE: d_year=2002 AND d_moy=4\n      AND i_category='Jewelry'\n      AND ca_state='IL'\n      AND c_birth_month=1\n  MAIN QUERY (via Q0)\n    FROM: store_sales\n    INNER JOIN precomputed_dims \n      ON ss_sold_date_sk = d_date_sk \n      AND ss_item_sk = i_item_sk \n      AND ss_customer_sk = c_customer_sk\n    INNER JOIN store ON ss_store_sk = s_store_sk\n    WHERE: ss_wholesale_cost BETWEEN 35 AND 55\n      AND substring(ca_zip,1,5) <> substring(s_zip,1,5)\n    GROUP BY: i_brand, i_brand_id, i_manufact_id, i_manufact\n    ORDER BY: sum(ss_ext_sales_price) DESC, i_brand, i_brand_id, i_manufact_id, i_manufact\n    LIMIT: 100",
    "recommended_examples": ["pg_explicit_join_materialized"]
  },
  {
    "family": "C",
    "transform": "aggregation_pushdown",
    "target_id": "t3",
    "relevance_score": 0.85,
    "hypothesis": "GROUP BY keys are superset of item join key. Aggregating sales after customer/store filters but before joining item reduces rows 100x.",
    "target_ir": "S0 [SELECT]\n  CTE: base_sales (via Q1)\n    SELECT: ss_item_sk, ss_ext_sales_price\n    FROM: store_sales\n    INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    INNER JOIN customer ON ss_customer_sk = c_customer_sk\n    INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk\n    INNER JOIN store ON ss_store_sk = s_store_sk\n    WHERE: d_year=2002 AND d_moy=4\n      AND ca_state='IL'\n      AND c_birth_month=1\n      AND ss_wholesale_cost BETWEEN 35 AND 55\n      AND substring(ca_zip,1,5) <> substring(s_zip,1,5)\n  CTE: aggregated_sales (via Q2)\n    SELECT: ss_item_sk, SUM(ss_ext_sales_price) AS ext_price\n    FROM: base_sales\n    GROUP BY: ss_item_sk\n  MAIN QUERY (via Q0)\n    FROM: aggregated_sales\n    INNER JOIN item ON ss_item_sk = i_item_sk\n    WHERE: i_category='Jewelry'\n    GROUP BY: i_brand, i_brand_id, i_manufact_id, i_manufact\n    ORDER BY: ext_price DESC, i_brand, i_brand_id, i_manufact_id, i_manufact\n    LIMIT: 100",
    "recommended_examples": ["pg_materialized_dimension_fact_prefilter"]
  },
  {
    "family": "E",
    "transform": "prefetch_geo",
    "target_id": "t4",
    "relevance_score": 0.80,
    "hypothesis": "Zip/state comparisons re-scan customer_address and store per row. Pre-joining and materializing geo-filtered pairs avoids repeated computation.",
    "target_ir": "S0 [SELECT]\n  CTE: geo_pairs (via Q1)\n    SELECT: ca_address_sk, s_store_sk\n    FROM: customer_address\n    CROSS JOIN store\n    WHERE: ca_state='IL'\n      AND substring(ca_zip,1,5) <> substring(s_zip,1,5)\n  MAIN QUERY (via Q0)\n    FROM: store_sales\n    INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    INNER JOIN item ON ss_item_sk = i_item_sk\n    INNER JOIN customer ON ss_customer_sk = c_customer_sk\n    INNER JOIN geo_pairs ON c_current_addr_sk = ca_address_sk AND ss_store_sk = s_store_sk\n    WHERE: i_category='Jewelry'\n      AND d_year=2002 AND d_moy=4\n      AND c_birth_month=1\n      AND ss_wholesale_cost BETWEEN 35 AND 55\n    GROUP BY: i_brand, i_brand_id, i_manufact_id, i_manufact\n    ORDER BY: sum(ss_ext_sales_price) DESC, i_brand, i_brand_id, i_manufact_id, i_manufact\n    LIMIT: 100",
    "recommended_examples": ["multi_dimension_prefetch"]
  }
]
```