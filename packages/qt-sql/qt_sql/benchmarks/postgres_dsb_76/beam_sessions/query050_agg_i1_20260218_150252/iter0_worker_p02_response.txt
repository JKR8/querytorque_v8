{
  "probe_id": "scout_dimension_prefetch_star",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Prefetching filtered date dimensions into CTEs and converting comma joins to explicit joins enables better join reordering and reduces rows entering the final aggregation.",
  "reasoning_trace": [
    "Comma joins with BETWEEN predicate cause late filtering and poor estimates.",
    "Date filters on d1 and d2 are selective and can be isolated into CTEs.",
    "Explicit JOIN syntax allows PostgreSQL to reorder joins for better performance."
  ],
  "target_ir": "Two CTEs for filtered date_dim instances; main query uses explicit JOINs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "store_returns", "store", "d1_filtered", "d2_filtered"],
        "outputs": [
          "s_store_name",
          "s_company_id",
          "s_street_number",
          "s_street_name",
          "s_street_type",
          "s_suite_number",
          "s_city",
          "s_county",
          "s_state",
          "s_zip",
          "30 days",
          "31-60 days",
          "61-90 days",
          "91-120 days",
          ">120 days"
        ],
        "changed": true,
        "sql": "WITH d1_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (SELECT MIN(d_date - INTERVAL '120 day') FROM date_dim WHERE d_year = 2000 AND d_moy = 8) AND (SELECT MAX(d_date) FROM date_dim WHERE d_year = 2000 AND d_moy = 8)), d2_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000 AND d_moy = 8) SELECT s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip, SUM(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 30) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 60) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 90) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM store_sales ss JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN store s ON ss.ss_store_sk = s.s_store_sk JOIN d1_filtered d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN d2_filtered d2 ON sr.sr_returned_date_sk = d2.d_date_sk GROUP BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip ORDER BY s.s_store_name, s.s_company_id, s.s_street_number, s.s_street_name, s.s_street_type, s.s_suite_number, s.s_city, s.s_county, s.s_state, s.s_zip LIMIT 100"
      }
    ]
  }
}