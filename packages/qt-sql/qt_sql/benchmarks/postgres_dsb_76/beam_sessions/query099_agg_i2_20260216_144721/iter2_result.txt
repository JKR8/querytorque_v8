{
  "iteration": 2,
  "n_api_calls": 5,
  "best_speedup": 1.09,
  "best_patch_id": "t3",
  "best_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23), cs_with_date_diff AS (SELECT cs.*, (cs_ship_date_sk - cs_sold_date_sk) AS date_diff FROM catalog_sales AS cs JOIN filtered_date AS d ON cs.cs_ship_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 244 AND 273) SELECT SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name, SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM cs_with_date_diff AS cs JOIN warehouse AS w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN ship_mode AS sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE sm.sm_type = 'LIBRARY' AND cc.cc_class = 'medium' AND w.w_gmt_offset = -5 GROUP BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name ORDER BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name LIMIT 100;",
  "patches": [
    {
      "patch_id": "t1",
      "family": "A+F+C",
      "transform": "preagg_after_date_join",
      "relevance_score": 0.97,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1 structural: Column mismatch: 1 missing, 1 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23), preagg_cs AS (SELECT cs_sold_date_sk, cs_ship_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk, cs_list_price, CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END AS \"30 days\", CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END AS \"31-60 days\", CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END AS \"61-90 days\", CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END AS \"91-120 days\", CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END AS \">120 days\" FROM catalog_sales JOIN filtered_date AS d ON cs_ship_date_sk = d.d_date_sk WHERE cs_list_price BETWEEN 244 AND 273) SELECT SUBSTRING(w.w_warehouse_name FROM 1 FOR 20), sm.sm_type, cc.cc_name, SUM(cs.\"30 days\") AS \"30 days\", SUM(cs.\"31-60 days\") AS \"31-60 days\", SUM(cs.\"61-90 days\") AS \"61-90 days\", SUM(cs.\"91-120 days\") AS \"91-120 days\", SUM(cs.\">120 days\") AS \">120 days\" FROM preagg_cs AS cs JOIN warehouse AS w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN ship_mode AS sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE sm.sm_type = 'LIBRARY' AND cc.cc_class = 'medium' AND w.w_gmt_offset = -5 GROUP BY SUBSTRING(w.w_warehouse_name FROM 1 FOR 20), sm.sm_type, cc.cc_name ORDER BY SUBSTRING(w.w_warehouse_name FROM 1 FOR 20), sm.sm_type, cc.cc_name LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t2",
      "family": "A+E+B",
      "transform": "materialize_dims_early+semi_join_prefilter",
      "relevance_score": 0.9,
      "status": "IMPROVED",
      "speedup": 1.06,
      "semantic_passed": true,
      "error": null,
      "original_ms": 5219.7,
      "patch_ms": 4940.5,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23), filtered_warehouses AS (SELECT w_warehouse_sk FROM warehouse WHERE w_gmt_offset = -5), filtered_ship_modes AS (SELECT sm_ship_mode_sk FROM ship_mode WHERE sm_type = 'LIBRARY'), filtered_call_centers AS (SELECT cc_call_center_sk FROM call_center WHERE cc_class = 'medium'), filtered_catalog_sales AS (SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk FROM catalog_sales WHERE cs_list_price BETWEEN 244 AND 273 AND EXISTS(SELECT 1 FROM filtered_dates WHERE d_date_sk = cs_ship_date_sk) AND EXISTS(SELECT 1 FROM filtered_warehouses WHERE w_warehouse_sk = cs_warehouse_sk) AND EXISTS(SELECT 1 FROM filtered_ship_modes WHERE sm_ship_mode_sk = cs_ship_mode_sk) AND EXISTS(SELECT 1 FROM filtered_call_centers WHERE cc_call_center_sk = cs_call_center_sk)) SELECT SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name, SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM filtered_catalog_sales JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk JOIN ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk JOIN call_center ON cs_call_center_sk = cc_call_center_sk JOIN date_dim ON cs_ship_date_sk = d_date_sk GROUP BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name ORDER BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t3",
      "family": "C",
      "transform": "preagg_with_date_math",
      "relevance_score": 0.85,
      "status": "IMPROVED",
      "speedup": 1.09,
      "semantic_passed": true,
      "error": null,
      "original_ms": 5219.7,
      "patch_ms": 4806.8,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23), cs_with_date_diff AS (SELECT cs.*, (cs_ship_date_sk - cs_sold_date_sk) AS date_diff FROM catalog_sales AS cs JOIN filtered_date AS d ON cs.cs_ship_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 244 AND 273) SELECT SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name, SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 30) AND (cs_ship_date_sk - cs_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 60) AND (cs_ship_date_sk - cs_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 90) AND (cs_ship_date_sk - cs_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (cs_ship_date_sk - cs_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM cs_with_date_diff AS cs JOIN warehouse AS w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN ship_mode AS sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk JOIN call_center AS cc ON cs.cs_call_center_sk = cc.cc_call_center_sk WHERE sm.sm_type = 'LIBRARY' AND cc.cc_class = 'medium' AND w.w_gmt_offset = -5 GROUP BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name ORDER BY SUBSTRING(w_warehouse_name FROM 1 FOR 20), sm_type, cc_name LIMIT 100;",
      "has_explain": true
    }
  ],
  "explains": {
    "t2": "Limit  (rows=11, time=4968.089)\n  Aggregate  (rows=11, time=4968.085)\n    Nested Loop  (rows=2477, time=4967.6)\n      Nested Loop  (rows=2477, time=4966.014)\n        Gather Merge  (rows=3860, time=4963.879)\n          Sort  (rows=1287, time=4777.432)\n            Merge Join  (rows=1287, time=4776.776)\n              Sort  (rows=1287, time=4776.494)\n                Hash Join  (rows=1287, time=4771.591)\n                  Hash Join  (rows=4948, time=4765.476)\n                    Nested Loop  (rows=258",
    "t3": "Limit  (rows=11, time=4870.008)\n  Aggregate  (rows=11, time=4870.004)\n    Gather Merge  (rows=25, time=4869.983)\n      Aggregate  (rows=8, time=4701.487)\n        Sort  (rows=826, time=4701.31)\n          Nested Loop  (rows=826, time=4697.899)\n            Hash Join  (rows=1287, time=4687.808)\n              Hash Join  (rows=4948, time=4681.476)\n                Nested Loop  (rows=25870, time=4667.483)\n                  Index Only Scan on date_dim  (rows=244, time=1.827)\n                  Index Scan "
  }
}