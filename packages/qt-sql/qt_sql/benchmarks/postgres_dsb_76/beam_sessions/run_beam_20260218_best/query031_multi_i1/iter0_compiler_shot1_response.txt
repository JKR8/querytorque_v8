[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.5,
    "based_on": "p01,p02,p04",
    "strategy": "Push year/quarter filters into CTEs and convert to explicit joins.",
    "hypothesis": "Original CTEs compute all years/quarters; final query only uses 1998 and quarters 1-3. Pushing filters reduces aggregation work. Explicit joins may improve join-order flexibility.",
    "expected_explain_delta": "CTE scans reduce from full table to filtered subset; nested loops may shift to hash joins.",
    "target_ir": "Modify ss and ws CTEs to filter d_year=1998 and d_qoy IN (1,2,3) and use explicit JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss", "ws"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": false
        },
        {
          "node_id": "ss",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ss.ss_ext_sales_price) AS store_sales FROM store_sales ss INNER JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk INNER JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('navajo', 'orchid') AND i.i_manager_id BETWEEN 8 AND 27 AND ss.ss_list_price BETWEEN 86 AND 100 AND ca.ca_state IN ('IA', 'IL') AND d.d_year = 1998 AND d.d_qoy IN (1, 2, 3) GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ws",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ws.ws_ext_sales_price) AS web_sales FROM web_sales ws INNER JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk INNER JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk INNER JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE i.i_color IN ('navajo', 'orchid') AND i.i_manager_id BETWEEN 8 AND 27 AND ws.ws_list_price BETWEEN 86 AND 100 AND ca.ca_state IN ('IA', 'IL') AND d.d_year = 1998 AND d.d_qoy IN (1, 2, 3) GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.3,
    "based_on": "p03",
    "strategy": "Pre-aggregate fact tables before joining dimensions.",
    "hypothesis": "Fact tables are large; aggregating by join keys before dimension joins reduces rows early. Must preserve list‑price filter after aggregation.",
    "expected_explain_delta": "Aggregate before dimension joins reduces nested‑loop input; may enable hash joins.",
    "target_ir": "Add pre‑aggregation CTE for store_sales, then join dimensions and apply remaining filters.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss", "ws"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": false
        },
        {
          "node_id": "ss",
          "parent_node_id": "final_select",
          "sources": ["store_sales_preagg", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(pre.ss_ext_sales_price) AS store_sales FROM (SELECT ss_item_sk, ss_addr_sk, ss_sold_date_sk, ss_list_price, SUM(ss_ext_sales_price) AS ss_ext_sales_price FROM store_sales GROUP BY ss_item_sk, ss_addr_sk, ss_sold_date_sk, ss_list_price) pre INNER JOIN date_dim d ON pre.ss_sold_date_sk = d.d_date_sk INNER JOIN customer_address ca ON pre.ss_addr_sk = ca.ca_address_sk INNER JOIN item i ON pre.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('navajo', 'orchid') AND i.i_manager_id BETWEEN 8 AND 27 AND pre.ss_list_price BETWEEN 86 AND 100 AND ca.ca_state IN ('IA', 'IL') AND d.d_year = 1998 AND d.d_qoy IN (1, 2, 3) GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "store_sales_preagg",
          "parent_node_id": "ss",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_addr_sk", "ss_sold_date_sk", "ss_list_price", "ss_ext_sales_price"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_addr_sk, ss_sold_date_sk, ss_list_price, SUM(ss_ext_sales_price) AS ss_ext_sales_price FROM store_sales GROUP BY ss_item_sk, ss_addr_sk, ss_sold_date_sk, ss_list_price"
        },
        {
          "node_id": "ws",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": false
        }
      ]
    }
  }
]