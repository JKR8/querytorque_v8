{
  "iteration": 0,
  "n_api_calls": 2,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.8,
      "status": "REGRESSION",
      "speedup": 0.58,
      "semantic_passed": true,
      "error": null,
      "original_ms": 815.5,
      "patch_ms": 1411.1,
      "output_sql": "WITH web_sales_prefetch AS (WITH date_dim_cte AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-10-01' AND CAST('1999-10-01' AS DATE) + INTERVAL '60 day'), customer_address_cte AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('MO','MT','OK','SC','TX','WI')), web_site_cte AS (SELECT web_site_sk FROM web_site WHERE web_gmt_offset >= -5) SELECT ws.ws_order_number, ws.ws_warehouse_sk, ws.ws_ext_ship_cost, ws.ws_net_profit FROM web_sales ws JOIN date_dim_cte d ON ws.ws_ship_date_sk = d.d_date_sk JOIN customer_address_cte ca ON ws.ws_ship_addr_sk = ca.ca_address_sk JOIN web_site_cte w ON ws.ws_web_site_sk = w.web_site_sk WHERE ws.ws_list_price BETWEEN 253 AND 282) SELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales_prefetch ws1 WHERE EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT 1 FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (8, 18, 20, 23, 41)) ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, customer_address, web_site) into separate CTEs, then join with web_sales to reduce fact scan rows."
    },
    {
      "patch_id": "p03",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Checksum mismatch",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH cte_web_sales AS (SELECT ws_order_number, ws_warehouse_sk, ws_ship_date_sk, ws_ship_addr_sk, ws_web_site_sk, ws_list_price, ws_ext_ship_cost, ws_net_profit FROM web_sales WHERE ws_list_price between 253 and 282) select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   cte_web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '1999-10-01' and\n           cast('1999-10-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('MO','MT','OK'\n            ,'SC' ,'TX' ,'WI')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 253 and 282\nand exists (select *\n            from cte_web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (8, 18, 20, 23, 41)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered web_sales (ws1) once in a CTE, then reuse for both main join and EXISTS self-join to avoid repeated index scans."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.5,
      "semantic_passed": true,
      "error": null,
      "original_ms": 815.5,
      "patch_ms": 1624.3,
      "output_sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_date BETWEEN '1999-10-01' AND cast('1999-10-01' as date) + interval '60 day'\n)\nselect \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  INNER JOIN filtered_date_dim d ON ws1.ws_ship_date_sk = d.d_date_sk\n  INNER JOIN customer_address ca ON ws1.ws_ship_addr_sk = ca.ca_address_sk\n  INNER JOIN web_site w ON ws1.ws_web_site_sk = w.web_site_sk\nwhere\n    ca_state in ('MO','MT','OK','SC','TX','WI')\nand w.web_gmt_offset >= -5\nand ws1.ws_list_price between 253 and 282\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (8, 18, 20, 23, 41)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit INNER JOIN syntax and isolate date_dim filter into a CTE to create a tiny hash table for better join planning."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 815.5,
      "patch_ms": 891.3,
      "output_sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '1999-10-01' and\n           cast('1999-10-01' as date) + interval '60 day'\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state in ('MO','MT','OK'\n            ,'SC' ,'TX' ,'WI')\nand ws1.ws_web_site_sk = web_site_sk\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 253 and 282\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (8, 18, 20, 23, 41)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Stage reduction: create CTE with filtered web_sales keys (order_number) and join with pre-filtered web_returns (by reason_sk) to shrink anti-join input."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.71,
      "semantic_passed": true,
      "error": null,
      "original_ms": 889.0,
      "patch_ms": 1252.7,
      "output_sql": "select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  join date_dim on ws1.ws_ship_date_sk = d_date_sk\n  join customer_address on ws1.ws_ship_addr_sk = ca_address_sk\n  join web_site on ws1.ws_web_site_sk = web_site_sk\nwhere\n    d_date between '1999-10-01' and\n           cast('1999-10-01' as date) + interval '60 day'\nand ca_state in ('MO','MT','OK'\n            ,'SC' ,'TX' ,'WI')\nand web_gmt_offset >= -5\nand ws1.ws_list_price between 253 and 282\nand exists (select *\n            from web_sales ws2\n            where ws1.ws_order_number = ws2.ws_order_number\n              and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where ws1.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (8, 18, 20, 23, 41)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 889.0,
      "patch_ms": 305157.7,
      "output_sql": "with filtered_ws as (\n  select ws_order_number, ws_warehouse_sk, ws_ext_ship_cost, ws_net_profit\n  from web_sales ws1\n  join date_dim on ws1.ws_ship_date_sk = d_date_sk\n  join customer_address on ws1.ws_ship_addr_sk = ca_address_sk\n  join web_site on ws1.ws_web_site_sk = web_site_sk\n  where d_date between '1999-10-01' and cast('1999-10-01' as date) + interval '60 day'\n    and ca_state in ('MO','MT','OK','SC','TX','WI')\n    and web_gmt_offset >= -5\n    and ws1.ws_list_price between 253 and 282\n),\nmulti_warehouse_orders as (\n  select ws_order_number\n  from web_sales\n  group by ws_order_number\n  having count(distinct ws_warehouse_sk) >= 2\n),\nfiltered_wr as (\n  select distinct wr_order_number\n  from web_returns\n  where wr_reason_sk in (8, 18, 20, 23, 41)\n)\nselect \n   count(distinct f.ws_order_number) as \"order count\"\n  ,sum(f.ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(f.ws_net_profit) as \"total net profit\"\nfrom filtered_ws f\njoin multi_warehouse_orders m on f.ws_order_number = m.ws_order_number\nleft join filtered_wr w on f.ws_order_number = w.wr_order_number\nwhere w.wr_order_number is null\norder by count(distinct f.ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "Limit  (rows=1, time=866.617)\n  Sort  (rows=1, time=866.614)\n    Aggregate  (rows=1, time=866.578)\n      Gather  (rows=1185, time=865.146)\n        Nested Loop  (rows=592, time=699.722)\n          Hash Join  (rows=592, time=694.278)\n            Nested Loop  (rows=783, time=588.141)\n              Hash Join  (rows=3906, time=548.238)\n                Nested Loop  (rows=5566, time=546.088)\n                  Seq Scan on date_dim  (rows=30, time=4.448)\n                  Index Scan on web_sales (ws)  (ro",
    "p01": "Limit  (rows=1, time=891.734)\n  Sort  (rows=1, time=891.731)\n    Aggregate  (rows=1, time=891.7)\n      Nested Loop  (rows=1185, time=890.483)\n        Nested Loop  (rows=1185, time=877.517)\n          Gather  (rows=1672, time=873.7)\n            Nested Loop  (rows=836, time=697.818)\n              Hash Join  (rows=4230, time=655.507)\n                Nested Loop  (rows=5566, time=544.876)\n                  Seq Scan on date_dim  (rows=30, time=4.515)\n                  Index Scan on web_sales (ws1)  (r",
    "p04": "Limit  (rows=1, time=880.529)\n  Sort  (rows=1, time=880.523)\n    Aggregate  (rows=1, time=880.478)\n      Nested Loop  (rows=1185, time=879.256)\n        Nested Loop  (rows=1185, time=866.594)\n          Gather  (rows=1672, time=862.89)\n            Nested Loop  (rows=836, time=685.798)\n              Hash Join  (rows=4230, time=644.834)\n                Nested Loop  (rows=5566, time=537.14)\n                  Seq Scan on date_dim  (rows=30, time=4.825)\n                  Index Scan on web_sales (ws1)  ",
    "compile_p1": "Limit  (rows=1, time=1323.085)\n  Sort  (rows=1, time=1323.083)\n    Aggregate  (rows=1, time=1323.06)\n      Nested Loop  (rows=1185, time=1321.839)\n        Nested Loop  (rows=1185, time=1300.712)\n          Gather  (rows=1672, time=1297.595)\n            Nested Loop  (rows=836, time=1083.721)\n              Hash Join  (rows=4230, time=960.375)\n                Nested Loop  (rows=5566, time=556.616)\n                  Seq Scan on date_dim  (rows=30, time=13.795)\n                  Index Scan on web_sale",
    "compile_p2": "Limit  (rows=1, time=444965.31)\n  Sort  (rows=1, time=444965.31)\n    Aggregate  (rows=1, time=444965.3)\n      Nested Loop  (rows=1, time=444965.28)\n        Nested Loop  (rows=1, time=219729.28)\n          Nested Loop  (rows=1, time=219725.47)\n            Hash Join  (rows=1, time=219724.92)\n              Gather  (rows=206, time=155104.84)\n                Nested Loop  (rows=121, time=154084.24)\n                  Seq Scan on date_dim  (rows=38, time=2049.55)\n                  Index Scan on web_sales"
  }
}