[
  {
    "plan_id": "compile_p01",
    "dialect": "postgres",
    "confidence": 0.68,
    "based_on": "p01,p03",
    "strategy": "Replace INTERSECT with EXISTS semi‑joins on (brand,class,category) plus explicit JOIN syntax to improve cardinality estimation.",
    "hypothesis": "INTERSECT materializes large intermediate sets; EXISTS semi‑joins preserve set‑intersection semantics without sorting. Explicit JOINs improve planner estimates for the nested‑loop hotspot.",
    "expected_explain_delta": "INTERSECT operators replaced by EXISTS semi‑joins; comma joins become explicit INNER JOIN; nested‑loop cardinality estimates improve.",
    "target_ir": "Update cross_items CTE to EXISTS form; convert comma joins in main query to explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["this_year", "last_year"],
          "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
          "changed": true,
          "sql": "SELECT this_year.channel AS ty_channel, this_year.i_brand_id AS ty_brand, this_year.i_class_id AS ty_class, this_year.i_category_id AS ty_category, this_year.sales AS ty_sales, this_year.number_sales AS ty_number_sales, last_year.channel AS ly_channel, last_year.i_brand_id AS ly_brand, last_year.i_class_id AS ly_class, last_year.i_category_id AS ly_category, last_year.sales AS ly_sales, last_year.number_sales AS ly_number_sales FROM (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE ss.ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12) AND i.i_category IN ('Electronics', 'Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 51 AND ss.ss_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > (SELECT average_sales FROM avg_sales)) this_year JOIN (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss.ss_quantity * ss.ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE ss.ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND d.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 12) AND i.i_category IN ('Electronics', 'Shoes', 'Sports') AND ss.ss_wholesale_cost BETWEEN 76 AND 96 AND i.i_manager_id BETWEEN 42 AND 51 GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss.ss_quantity * ss.ss_list_price) > (SELECT average_sales FROM avg_sales)) last_year ON this_year.i_brand_id = last_year.i_brand_id AND this_year.i_class_id = last_year.i_class_id AND this_year.i_category_id = last_year.i_category_id ORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id LIMIT 100"
        },
        {
          "node_id": "cross_items",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["ss_item_sk"],
          "changed": true,
          "sql": "SELECT i.i_item_sk AS ss_item_sk FROM item i WHERE i.i_category IN ('Electronics', 'Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 51 AND EXISTS (SELECT 1 FROM store_sales ss JOIN item iss ON ss.ss_item_sk = iss.i_item_sk JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk WHERE d1.d_year BETWEEN 1999 AND 1999 + 2 AND iss.i_brand_id = i.i_brand_id AND iss.i_class_id = i.i_class_id AND iss.i_category_id = i.i_category_id AND iss.i_category IN ('Electronics', 'Shoes', 'Sports') AND iss.i_manager_id BETWEEN 42 AND 51 AND ss.ss_wholesale_cost BETWEEN 76 AND 96) AND EXISTS (SELECT 1 FROM catalog_sales cs JOIN item ics ON cs.cs_item_sk = ics.i_item_sk JOIN date_dim d2 ON cs.cs_sold_date_sk = d2.d_date_sk WHERE d2.d_year BETWEEN 1999 AND 1999 + 2 AND ics.i_brand_id = i.i_brand_id AND ics.i_class_id = i.i_class_id AND ics.i_category_id = i.i_category_id AND ics.i_category IN ('Electronics', 'Shoes', 'Sports') AND ics.i_manager_id BETWEEN 42 AND 51 AND cs.cs_wholesale_cost BETWEEN 76 AND 96) AND EXISTS (SELECT 1 FROM web_sales ws JOIN item iws ON ws.ws_item_sk = iws.i_item_sk JOIN date_dim d3 ON ws.ws_sold_date_sk = d3.d_date_sk WHERE d3.d_year BETWEEN 1999 AND 1999 + 2 AND iws.i_brand_id = i.i_brand_id AND iws.i_class_id = i.i_class_id AND iws.i_category_id = i.i_category_id AND iws.i_category IN ('Electronics', 'Shoes', 'Sports') AND iws.i_manager_id BETWEEN 42 AND 51 AND ws.ws_wholesale_cost BETWEEN 76 AND 96)"
        },
        {
          "node_id": "avg_sales",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "store_sales", "catalog_sales"],
          "outputs": ["average_sales"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02",
    "dialect": "postgres",
    "confidence": 0.52,
    "based_on": "p07,p09",
    "strategy": "Pre‑compute date filters and dimension prefetching to reduce repeated scans, while keeping INTERSECT for safety.",
    "hypothesis": "Residual gap: date_dim scanned 6+ times across CTEs. Materialize filtered date_dim and item CTEs to push filters earlier and reduce fact‑table input sizes.",
    "expected_explain_delta": "Multiple date_dim index scans collapse into CTE scans; fact‑table nested‑loop rows drop.",
    "target_ir": "Add filtered_date_dim and filtered_item CTEs; rewrite cross_items and avg_sales to reference them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["this_year", "last_year"],
          "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
          "changed": false
        },
        {
          "node_id": "cross_items",
          "parent_node_id": "final_select",
          "sources": ["filtered_item", "filtered_date_dim", "web_sales", "store_sales", "catalog_sales"],
          "outputs": ["ss_item_sk"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2), filtered_item AS (SELECT i_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51) SELECT i.i_item_sk AS ss_item_sk FROM filtered_item i, (SELECT iss.i_brand_id brand_id, iss.i_class_id class_id, iss.i_category_id category_id FROM store_sales, filtered_item iss, filtered_date_dim d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk AND ss_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, filtered_item ics, filtered_date_dim d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk AND cs_wholesale_cost BETWEEN 76 AND 96 INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, filtered_item iws, filtered_date_dim d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96) x WHERE i.i_brand_id = x.brand_id AND i.i_class_id = x.class_id AND i.i_category_id = x.category_id"
        },
        {
          "node_id": "avg_sales",
          "parent_node_id": "final_select",
          "sources": ["filtered_date_dim", "web_sales", "store_sales", "catalog_sales"],
          "outputs": ["average_sales"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2) SELECT avg(quantity * list_price) average_sales FROM (SELECT ss_quantity quantity, ss_list_price list_price FROM store_sales, filtered_date_dim WHERE ss_sold_date_sk = d_date_sk AND ss_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT cs_quantity quantity, cs_list_price list_price FROM catalog_sales, filtered_date_dim WHERE cs_sold_date_sk = d_date_sk AND cs_wholesale_cost BETWEEN 76 AND 96 UNION ALL SELECT ws_quantity quantity, ws_list_price list_price FROM web_sales, filtered_date_dim WHERE ws_sold_date_sk = d_date_sk AND ws_wholesale_cost BETWEEN 76 AND 96) x"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "cross_items",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 2"
        },
        {
          "node_id": "filtered_item",
          "parent_node_id": "cross_items",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_brand_id", "i_class_id", "i_category_id"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE i_category IN ('Electronics', 'Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 51"
        }
      ]
    }
  }
]