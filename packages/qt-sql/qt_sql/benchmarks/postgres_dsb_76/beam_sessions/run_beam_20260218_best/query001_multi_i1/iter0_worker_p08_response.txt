{
  "probe_id": "scout_001",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing filtered dimension keys (store, customer, customer_demographics) and pre-joining with store_returns before the main CTE aggregation reduces fact table scan size and avoids late selective filter application.",
  "reasoning_trace": [
    "Assigned transform targets early filtering of dimension tables to reduce fact scan size.",
    "CTE scan shows high actual row count (2450) vs estimate (1), indicating materialization inefficiency.",
    "Correlated subquery causes nested loop with full CTE scan per outer row.",
    "Pre-filtering dimensions allows smaller, selective join before aggregation."
  ],
  "target_ir": "Introduce prefetched_dimension CTE to filter store/customer/customer_demographics early; join with store_returns in new filtered_returns CTE before main aggregation.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_total_return", "filtered_returns", "store", "customer", "customer_demographics"],
        "outputs": ["c_customer_id"],
        "changed": true,
        "sql": "SELECT c_customer_id FROM customer_total_return ctr1 JOIN filtered_returns fr ON ctr1.ctr_store_sk = fr.sr_store_sk JOIN store s ON s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_demographics cd ON c_current_cdemo_sk = cd_demo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return)*1.2 FROM customer_total_return ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s_state IN ('IL', 'KY', 'TX') AND cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F' AND c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100"
      },
      {
        "node_id": "customer_total_return",
        "parent_node_id": "final_select",
        "sources": ["filtered_returns"],
        "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM filtered_returns GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk"
      },
      {
        "node_id": "filtered_returns",
        "parent_node_id": "customer_total_return",
        "sources": ["store_returns", "prefetched_dimension"],
        "outputs": ["sr_customer_sk", "sr_store_sk", "sr_reason_sk", "SR_RETURN_AMT_INC_TAX"],
        "changed": true,
        "sql": "SELECT sr.sr_customer_sk, sr.sr_store_sk, sr.sr_reason_sk, sr.SR_RETURN_AMT_INC_TAX FROM store_returns sr JOIN prefetched_dimension pd ON sr.sr_store_sk = pd.s_store_sk AND sr.sr_customer_sk = pd.c_customer_sk WHERE sr.sr_returned_date_sk = pd.d_date_sk AND pd.d_year = 2002 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 108 AND 167"
      },
      {
        "node_id": "prefetched_dimension",
        "parent_node_id": "filtered_returns",
        "sources": ["store", "customer", "customer_demographics", "date_dim"],
        "outputs": ["s_store_sk", "c_customer_sk", "d_date_sk", "d_year"],
        "changed": true,
        "sql": "SELECT s.s_store_sk, c.c_customer_sk, d.d_date_sk, d.d_year FROM store s, customer c, customer_demographics cd, date_dim d WHERE s.s_state IN ('IL', 'KY', 'TX') AND c.c_current_cdemo_sk = cd.cd_demo_sk AND cd.cd_marital_status IN ('M', 'M') AND cd.cd_education_status IN ('Advanced Degree', 'College') AND cd.cd_gender = 'F' AND c.c_birth_month = 2 AND c.c_birth_year BETWEEN 1965 AND 1971 AND d.d_year = 2002"
      }
    ]
  }
}