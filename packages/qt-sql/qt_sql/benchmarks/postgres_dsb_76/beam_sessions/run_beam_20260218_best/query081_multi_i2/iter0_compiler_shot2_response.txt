[  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02",
    "strategy": "Decorrelation via pre-computed state averages with explicit JOIN syntax.",
    "hypothesis": "Winning probe p02 (274x speedup) eliminates correlated subquery by pre-aggregating state averages and joining. This attempt adopts its decorrelation mechanism while converting comma-joins to explicit JOINs for optimizer clarity.",
    "expected_explain_delta": "SubPlan 2 (correlated aggregate) replaced by hash join on ctr_state; nested loop amplification removed.",
    "target_ir": "Add avg_state_return node and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "avg_state_return", "customer", "customer_address"],
          "outputs": ["c_customer_id", "c_salutation", "c_first_name", "c_last_name", "ca_street_number", "ca_street_name", "ca_street_type", "ca_suite_number", "ca_city", "ca_county", "ca_state", "ca_zip", "ca_country", "ca_gmt_offset", "ca_location_type", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT c_customer_id, c_salutation, c_first_name, c_last_name, ca_street_number, ca_street_name, ca_street_type, ca_suite_number, ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset, ca_location_type, ctr_total_return FROM customer_total_return ctr1 JOIN avg_state_return avg ON ctr1.ctr_state = avg.ctr_state JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ctr1.ctr_total_return > avg.avg_ctr_total_return * 1.2 AND ca_state = 'OH' ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, ca_street_number, ca_street_name, ca_street_type, ca_suite_number, ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset, ca_location_type, ctr_total_return LIMIT 100"
        },
        {
          "node_id": "avg_state_return",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_state", "avg_ctr_total_return"],
          "changed": true,
          "sql": "SELECT ctr_state, AVG(ctr_total_return) AS avg_ctr_total_return FROM customer_total_return GROUP BY ctr_state"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "date_dim", "customer_address"],
          "outputs": ["ctr_customer_sk", "ctr_state", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT cr_returning_customer_sk AS ctr_customer_sk, ca_state AS ctr_state, SUM(cr_return_amt_inc_tax) AS ctr_total_return FROM catalog_returns INNER JOIN date_dim ON cr_returned_date_sk = d_date_sk INNER JOIN customer_address ON cr_returning_addr_sk = ca_address_sk WHERE d_year = 2002 GROUP BY cr_returning_customer_sk, ca_state"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p01",
    "strategy": "Materialized decorrelation with nested CTE structure for early filtering.",
    "hypothesis": "Winning probe p01 (190x speedup) uses nested MATERIALIZED CTEs to pre-filter date_dim and catalog_returns before aggregation, then computes state thresholds. This pathway may reduce input rows to the aggregate.",
    "expected_explain_delta": "Correlated subquery removed; early filtered scans reduce aggregate input; hash join on ctr_state.",
    "target_ir": "Add date_dim_filtered, catalog_returns_filtered, and state_avg_threshold nodes; update customer_total_return and final_select.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "state_avg_threshold", "customer", "customer_address"],
          "outputs": ["c_customer_id", "c_salutation", "c_first_name", "c_last_name", "ca_street_number", "ca_street_name", "ca_street_type", "ca_suite_number", "ca_city", "ca_county", "ca_state", "ca_zip", "ca_country", "ca_gmt_offset", "ca_location_type", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT c_customer_id, c_salutation, c_first_name, c_last_name, ca_street_number, ca_street_name, ca_street_type, ca_suite_number, ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset, ca_location_type, ctr_total_return FROM customer_total_return ctr1 JOIN state_avg_threshold sat ON ctr1.ctr_state = sat.ctr_state JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ctr1.ctr_total_return > sat.threshold AND ca_state = 'OH' ORDER BY c_customer_id, c_salutation, c_first_name, c_last_name, ca_street_number, ca_street_name, ca_street_type, ca_suite_number, ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset, ca_location_type, ctr_total_return LIMIT 100"
        },
        {
          "node_id": "state_avg_threshold",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_state", "threshold"],
          "changed": true,
          "sql": "SELECT ctr_state, AVG(ctr_total_return) * 1.2 AS threshold FROM customer_total_return GROUP BY ctr_state"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns_filtered", "customer_address"],
          "outputs": ["ctr_customer_sk", "ctr_state", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT cr_returning_customer_sk AS ctr_customer_sk, ca_state AS ctr_state, SUM(cr_return_amt_inc_tax) AS ctr_total_return FROM catalog_returns_filtered INNER JOIN customer_address ON cr_returning_addr_sk = ca_address_sk GROUP BY cr_returning_customer_sk, ca_state"
        },
        {
          "node_id": "catalog_returns_filtered",
          "parent_node_id": "customer_total_return",
          "sources": ["catalog_returns", "date_dim_filtered"],
          "outputs": ["cr_returning_customer_sk", "cr_returning_addr_sk", "cr_return_amt_inc_tax"],
          "changed": true,
          "sql": "SELECT cr_returning_customer_sk, cr_returning_addr_sk, cr_return_amt_inc_tax FROM catalog_returns WHERE cr_returned_date_sk IN (SELECT d_date_sk FROM date_dim_filtered)"
        },
        {
          "node_id": "date_dim_filtered",
          "parent_node_id": "catalog_returns_filtered",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        }
      ]
    }
  }
]