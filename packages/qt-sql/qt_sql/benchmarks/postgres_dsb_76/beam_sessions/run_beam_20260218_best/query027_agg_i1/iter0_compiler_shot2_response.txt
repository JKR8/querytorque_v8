[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Explicit join conversion with early date_dim filtering to improve cardinality propagation.",
    "hypothesis": "Probes show that converting comma joins to explicit JOINs and filtering date_dim early can address the primary nested-loop hotspot. While prior attempts regressed, a cleaner implementation avoiding CTE overuse may succeed.",
    "expected_explain_delta": "Nested loops replaced with hash joins; date_dim filtered before large-table joins.",
    "target_ir": "Convert final_select to explicit JOINs and pre-filter date_dim.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "i_item_id",
            "s_state",
            "g_state",
            "agg1",
            "agg2",
            "agg3",
            "agg4"
          ],
          "changed": true,
          "sql": "SELECT i_item_id, s_state, grouping(s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND d_year = 2002 AND s_state = 'IA' AND i_category = 'Sports' GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02",
    "strategy": "Dimension prefetch with inline filtering to reduce store_sales probe volume.",
    "hypothesis": "Prefetching and filtering all dimensions before joining with store_sales reduces row volume entering the fact table. Prior attempt regressed due to excessive CTEs; this version uses inline filtering without materialization.",
    "expected_explain_delta": "store_sales probed with pre-filtered dimension keys; fewer rows scanned.",
    "target_ir": "Inline-filter dimensions and join with store_sales.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "i_item_id",
            "s_state",
            "g_state",
            "agg1",
            "agg2",
            "agg3",
            "agg4"
          ],
          "changed": true,
          "sql": "SELECT i.i_item_id, s.s_state, grouping(s.s_state) g_state, avg(ss.ss_quantity) agg1, avg(ss.ss_list_price) agg2, avg(ss.ss_coupon_amt) agg3, avg(ss.ss_sales_price) agg4 FROM (SELECT ss_sold_date_sk, ss_item_sk, ss_store_sk, ss_cdemo_sk, ss_quantity, ss_list_price, ss_coupon_amt, ss_sales_price FROM store_sales) ss JOIN (SELECT d_date_sk FROM date_dim WHERE d_year = 2002) d ON ss.ss_sold_date_sk = d.d_date_sk JOIN (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Sports') i ON ss.ss_item_sk = i.i_item_sk JOIN (SELECT s_store_sk, s_state FROM store WHERE s_state = 'IA') s ON ss.ss_store_sk = s.s_store_sk JOIN (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary') cd ON ss.ss_cdemo_sk = cd.cd_demo_sk GROUP BY rollup (i.i_item_id, s.s_state) ORDER BY i.i_item_id, s.s_state LIMIT 100"
        }
      ]
    }
  }
]