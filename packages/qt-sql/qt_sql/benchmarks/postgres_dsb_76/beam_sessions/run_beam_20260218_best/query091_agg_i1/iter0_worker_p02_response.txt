{
  "probe_id": "scout_early_filter_decorrelate",
  "transform_id": "early_filter_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Filtering dimension tables early using CTEs before joining with catalog_returns reduces the row count entering the large fact table scan. This aligns with the observed sequential scan bottleneck and overestimation in nested loops.",
  "reasoning_trace": [
    "The Seq Scan on catalog_returns dominates execution time (1579 ms of 1669 ms total).",
    "All dimension tables are small and have selective filters that can be applied early.",
    "Creating CTEs for filtered dimensions allows PostgreSQL to optimize joins more effectively."
  ],
  "target_ir": "Introduce CTEs for each dimension with filters applied, then join these with catalog_returns explicitly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_catalog_returns", "filtered_date_dim", "filtered_call_center", "filtered_customer", "filtered_customer_address", "filtered_customer_demographics", "filtered_household_demographics"],
        "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
        "changed": true,
        "sql": "SELECT cc.cc_call_center_id AS Call_Center, cc.cc_name AS Call_Center_Name, cc.cc_manager AS Manager, SUM(cr.cr_net_loss) AS Returns_Loss FROM filtered_catalog_returns cr JOIN filtered_date_dim d ON cr.cr_returned_date_sk = d.d_date_sk JOIN filtered_call_center cc ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN filtered_customer c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN filtered_customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN filtered_household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk JOIN filtered_customer_address ca ON ca.ca_address_sk = c.c_current_addr_sk GROUP BY cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status ORDER BY SUM(cr.cr_net_loss) DESC"
      },
      {
        "node_id": "filtered_catalog_returns",
        "parent_node_id": "final_select",
        "sources": ["catalog_returns"],
        "outputs": ["cr_returned_date_sk", "cr_call_center_sk", "cr_returning_customer_sk", "cr_net_loss"],
        "changed": true,
        "sql": "SELECT cr_returned_date_sk, cr_call_center_sk, cr_returning_customer_sk, cr_net_loss FROM catalog_returns"
      },
      {
        "node_id": "filtered_date_dim",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2"
      },
      {
        "node_id": "filtered_call_center",
        "parent_node_id": "final_select",
        "sources": ["call_center"],
        "outputs": ["cc_call_center_sk", "cc_call_center_id", "cc_name", "cc_manager"],
        "changed": true,
        "sql": "SELECT cc_call_center_sk, cc_call_center_id, cc_name, cc_manager FROM call_center"
      },
      {
        "node_id": "filtered_customer",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_current_cdemo_sk", "c_current_hdemo_sk", "c_current_addr_sk"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_current_cdemo_sk, c_current_hdemo_sk, c_current_addr_sk FROM customer"
      },
      {
        "node_id": "filtered_customer_address",
        "parent_node_id": "final_select",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": true,
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -7"
      },
      {
        "node_id": "filtered_customer_demographics",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')"
      },
      {
        "node_id": "filtered_household_demographics",
        "parent_node_id": "final_select",
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk"],
        "changed": true,
        "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential LIKE '1001-5000%'"
      }
    ]
  }
}