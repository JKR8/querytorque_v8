[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.5,
    "based_on": "",
    "strategy": "Convert comma joins to explicit JOIN syntax to allow better join reordering and predicate pushdown.",
    "hypothesis": "Original comma-join syntax may restrict PostgreSQL's join reordering; explicit JOINs let the optimizer choose a more efficient order, potentially starting with selective dimensions before scanning the large fact table.",
    "expected_explain_delta": "Planner may reorder joins to start with date_dim and call_center, then nested loops to filtered customer chain, reducing rows fed to catalog_returns scan.",
    "target_ir": "Replace comma joins with explicit INNER JOIN ... ON syntax, keeping all filters in WHERE clause.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["call_center", "catalog_returns", "date_dim", "customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "SELECT cc.cc_call_center_id AS Call_Center, cc.cc_name AS Call_Center_Name, cc.cc_manager AS Manager, SUM(cr.cr_net_loss) AS Returns_Loss FROM call_center cc JOIN catalog_returns cr ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN date_dim d ON cr.cr_returned_date_sk = d.d_date_sk JOIN customer c ON cr.cr_returning_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE d.d_year = 1998 AND d.d_moy = 2 AND ca.ca_gmt_offset = -7 AND hd.hd_buy_potential LIKE '1001-5000%' AND ((cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Unknown') OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Advanced Degree')) GROUP BY cc.cc_call_center_id, cc.cc_name, cc.cc_manager, cd.cd_marital_status, cd.cd_education_status ORDER BY SUM(cr.cr_net_loss) DESC"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.45,
    "based_on": "p01",
    "strategy": "Pre‑filter customer‑related dimensions in a CTE to reduce rows before joining with the large fact table.",
    "hypothesis": "Probe p01 (dimension_prefetch_star) showed neutral performance but used multiple CTEs; this attempt uses a single CTE for the filtered customer chain to avoid optimization fences while still pushing selective filters earlier.",
    "expected_explain_delta": "CTE should be inlined; join order may start with filtered customer, then hash join to catalog_returns, reducing the fact‑table probe set.",
    "target_ir": "Add a CTE that joins customer with its three filtered dimensions, then join CTE with call_center, catalog_returns, and date_dim.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "filtered_customer",
          "parent_node_id": "final_select",
          "sources": ["customer", "customer_address", "customer_demographics", "household_demographics"],
          "outputs": ["c_customer_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, cd.cd_marital_status, cd.cd_education_status FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE ca.ca_gmt_offset = -7 AND hd.hd_buy_potential LIKE '1001-5000%' AND ((cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Unknown') OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Advanced Degree'))"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["call_center", "catalog_returns", "date_dim", "filtered_customer"],
          "outputs": ["Call_Center", "Call_Center_Name", "Manager", "Returns_Loss"],
          "changed": true,
          "sql": "WITH filtered_customer AS (SELECT c_customer_sk, cd_marital_status, cd_education_status FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE ca.ca_gmt_offset = -7 AND hd.hd_buy_potential LIKE '1001-5000%' AND ((cd.cd_marital_status = 'M' AND cd.cd_education_status = 'Unknown') OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Advanced Degree'))) SELECT cc.cc_call_center_id AS Call_Center, cc.cc_name AS Call_Center_Name, cc.cc_manager AS Manager, SUM(cr.cr_net_loss) AS Returns_Loss FROM call_center cc JOIN catalog_returns cr ON cr.cr_call_center_sk = cc.cc_call_center_sk JOIN date_dim d ON cr.cr_returned_date_sk = d.d_date_sk JOIN filtered_customer fc ON cr.cr_returning_customer_sk = fc.c_customer_sk WHERE d.d_year = 1998 AND d.d_moy = 2 GROUP BY cc.cc_call_center_id, cc.cc_name, cc.cc_manager, fc.cd_marital_status, fc.cd_education_status ORDER BY SUM(cr.cr_net_loss) DESC"
        }
      ]
    }
  }
]