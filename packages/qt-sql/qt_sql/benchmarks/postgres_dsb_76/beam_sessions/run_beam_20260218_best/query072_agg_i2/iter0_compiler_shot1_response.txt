[
  {
    "plan_id": "compile_p01_corrected",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Early filtering via materialized CTEs to shrink intermediate rows before the expensive nested loop and non‑equi join.",
    "hypothesis": "WIN probe p01 (4.46×) shows that materializing filtered dimensions and fact tables reduces the large nested loop between date_dim d1 and catalog_sales. Corrected d3 condition to avoid correlated subquery and added missing d_date column.",
    "expected_explain_delta": "Nested loop and hash join cardinalities drop dramatically; early scans on catalog_sales and inventory become filtered; aggregate input shrinks.",
    "target_ir": "Replace base scans with filtered CTEs for d1, household_demographics, customer_demographics, item, catalog_sales, and inventory, then join with remaining tables.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim WHERE d_year = 1999), filtered_household_demographics AS (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_customer_demographics AS (SELECT cd_demo_sk, cd_marital_status, cd_dep_count FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS (SELECT i_item_sk, i_item_desc, i_category FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_catalog_sales AS (SELECT cs_item_sk, cs_order_number, cs_wholesale_cost, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_quantity FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96), filtered_inventory AS (SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory) SELECT i.i_item_desc, w.w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_catalog_sales cs JOIN filtered_inventory inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_customer_demographics cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_d1 d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON inv.inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + interval '3 day' GROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_date_dim_cte",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p01,p04",
    "strategy": "Single date_dim CTE to avoid multiple scans, combined with early filtering on other dimensions.",
    "hypothesis": "Extend p01 by materializing date_dim once for d2 and d3 to reduce repeated scans, while keeping early filtering on d1 and other dimensions. Residual gap: multiple date_dim scans unaddressed by p01.",
    "expected_explain_delta": "Same early filtering as p01 plus reduced date_dim scan count; may improve if date_dim scan is a bottleneck.",
    "target_ir": "Add a date_dim_all CTE for d2 and d3, while retaining filtered CTEs for other dimensions and fact tables.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim WHERE d_year = 1999), filtered_household_demographics AS (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_customer_demographics AS (SELECT cd_demo_sk, cd_marital_status, cd_dep_count FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS (SELECT i_item_sk, i_item_desc, i_category FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_catalog_sales AS (SELECT cs_item_sk, cs_order_number, cs_wholesale_cost, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_quantity FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96), filtered_inventory AS (SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory), date_dim_all AS (SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim) SELECT i.i_item_desc, w.w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_catalog_sales cs JOIN filtered_inventory inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_customer_demographics cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_d1 d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim_all d2 ON inv.inv_date_sk = d2.d_date_sk JOIN date_dim_all d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + interval '3 day' GROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq LIMIT 100"
        }
      ]
    }
  }
]