{
  "probe_id": "scout_1",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing selective dimensions (date_dim d1, household_demographics, customer_demographics, item) into CTEs before joining with catalog_sales reduces intermediate cardinality and improves join efficiency.",
  "reasoning_trace": [
    "Nested loop between date_dim d1 and catalog_sales produces 113k rows; early filtering reduces this.",
    "Multiple date_dim scans (d1, d2, d3) are repeated; materializing once avoids redundant work.",
    "Dimension tables are small and selective; materializing them enables better estimates and faster hash joins."
  ],
  "target_ir": "Prefiltered dimension CTEs (d1, hd, cd, i) joined explicitly before fact-table join.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["prefetch_joins", "promotion", "catalog_returns"],
        "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
        "changed": true,
        "sql": "select  i_item_desc\n      ,w_warehouse_name\n      ,d1.d_week_seq\n      ,sum(case when p_promo_sk is null then 1 else 0 end) no_promo\n      ,sum(case when p_promo_sk is not null then 1 else 0 end) promo\n      ,count(*) total_cnt\nfrom prefetch_joins\nleft outer join promotion on (cs_promo_sk=p_promo_sk)\nleft outer join catalog_returns on (cr_item_sk = cs_item_sk and cr_order_number = cs_order_number)\ngroup by i_item_desc,w_warehouse_name,d1.d_week_seq\norder by total_cnt desc, i_item_desc, w_warehouse_name, d_week_seq\nlimit 100"
      },
      {
        "node_id": "prefetch_joins",
        "parent_node_id": "final_select",
        "sources": ["filtered_date_dim_d1", "household_demographics", "customer_demographics", "item", "catalog_sales", "inventory", "warehouse", "date_dim_d2", "date_dim_d3"],
        "outputs": ["i_item_desc", "w_warehouse_name", "d1.d_week_seq", "cs_promo_sk", "cs_item_sk", "cs_order_number", "cr_item_sk", "cr_order_number"],
        "changed": true,
        "sql": "WITH filtered_date_dim_d1 AS (\n  SELECT *\n  FROM date_dim\n  WHERE d_year = 1999\n),\nhousehold_demographics AS (\n  SELECT *\n  FROM household_demographics\n  WHERE hd_buy_potential = '>10000'\n),\ncustomer_demographics AS (\n  SELECT *\n  FROM customer_demographics\n  WHERE cd_marital_status = 'S'\n    AND cd_dep_count between 9 and 11\n),\nitem AS (\n  SELECT *\n  FROM item\n  WHERE i_category IN ('Men', 'Shoes', 'Sports')\n)\nSELECT\n  i.i_item_desc,\n  w.w_warehouse_name,\n  d1.d_week_seq,\n  cs.cs_promo_sk,\n  cs.cs_item_sk,\n  cs.cs_order_number,\n  cr.cr_item_sk,\n  cr.cr_order_number\nFROM catalog_sales cs\nJOIN inventory inv ON (cs.cs_item_sk = inv.inv_item_sk)\nJOIN warehouse w ON (w.w_warehouse_sk=inv.inv_warehouse_sk)\nJOIN item i ON (i.i_item_sk = cs.cs_item_sk)\nJOIN customer_demographics cd ON (cs.cs_bill_cdemo_sk = cd.cd_demo_sk)\nJOIN household_demographics hd ON (cs.cs_bill_hdemo_sk = hd.hd_demo_sk)\nJOIN filtered_date_dim_d1 d1 ON (cs.cs_sold_date_sk = d1.d_date_sk)\nJOIN date_dim d2 ON (inv.inv_date_sk = d2.d_date_sk)\nJOIN date_dim d3 ON (cs.cs_ship_date_sk = d3.d_date_sk)\nWHERE d1.d_week_seq = d2.d_week_seq\n  AND inv_quantity_on_hand < cs_quantity\n  AND d3.d_date > d1.d_date + interval '3 day'\n  AND cs_wholesale_cost BETWEEN 76 AND 96"
      }
    ]
  }
}