[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.5,
    "based_on": "p02",
    "strategy": "Explicit join syntax with filtered date dimension CTE to improve cardinality estimates.",
    "hypothesis": "Probe p02 (1.00x) shows explicit join conversion is safe. The original nested-loop plan had zero rows; explicit joins may help planner reorder and reduce nested loop amplification.",
    "expected_explain_delta": "Nested loops may convert to hash joins; index-only scans on store_sales may be better utilized.",
    "target_ir": "Convert comma joins to explicit INNER JOIN ON and isolate date_dim filter into CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999) SELECT i_item_id, s_state, grouping(s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM store_sales JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk WHERE cd_gender = 'M' AND cd_marital_status = 'W' AND cd_education_status = 'Secondary' AND s_state = 'OH' AND i_category = 'Music' GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.4,
    "based_on": "p03",
    "strategy": "Pre-filter all selective dimensions into CTEs to reduce nested loop iterations and enable better join planning.",
    "hypothesis": "Probe p03 failed on syntax (missing column) but its core hypothesis—pre‑filtering dimensions—remains valid. Fixed CTE column selection and explicit joins may reduce rows early.",
    "expected_explain_delta": "Dimension CTEs become small hash tables; store_sales joins via hash joins instead of nested loops.",
    "target_ir": "Convert comma joins to explicit joins, push all dimension filters into CTEs, preserve all required columns.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999), filtered_store AS (SELECT s_store_sk, s_state FROM store WHERE s_state = 'OH'), filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Music'), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'W' AND cd_education_status = 'Secondary') SELECT i.i_item_id, s.s_state, grouping(s.s_state) AS g_state, avg(ss.ss_quantity) AS agg1, avg(ss.ss_list_price) AS agg2, avg(ss.ss_coupon_amt) AS agg3, avg(ss.ss_sales_price) AS agg4 FROM store_sales ss JOIN filtered_date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_store s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_item i ON ss.ss_item_sk = i.i_item_sk JOIN filtered_customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk GROUP BY rollup (i.i_item_id, s.s_state) ORDER BY i.i_item_id, s.s_state LIMIT 100"
        }
      ]
    }
  }
]