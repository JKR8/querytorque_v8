[  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p03",
    "strategy": "Pre-filter all selective dimensions into CTEs with explicit JOIN syntax to reduce nested-loop iterations and improve cardinality estimates.",
    "hypothesis": "Probes p01 and p03 failed due to syntax errors but their core hypothesis—pre‑filtering dimensions to reduce nested‑loop amplification—remains valid. This corrected version includes all required columns (s_state) and uses explicit JOINs to arm the optimizer.",
    "expected_explain_delta": "Nested‑loop operators replaced by hash joins; dimension scans become fast CTE scans; aggregate input rows reduced.",
    "target_ir": "Replace comma‑join with explicit INNER JOINs after materializing filtered dimension subsets.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999), filtered_store AS (SELECT s_store_sk, s_state FROM store WHERE s_state = 'OH'), filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Music'), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status = 'W' AND cd_education_status = 'Secondary') SELECT i.i_item_id, s.s_state, GROUPING(s.s_state) AS g_state, AVG(ss.ss_quantity) AS agg1, AVG(ss.ss_list_price) AS agg2, AVG(ss.ss_coupon_amt) AS agg3, AVG(ss.ss_sales_price) AS agg4 FROM store_sales ss INNER JOIN filtered_date_dim d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN filtered_store s ON ss.ss_store_sk = s.s_store_sk INNER JOIN filtered_item i ON ss.ss_item_sk = i.i_item_sk INNER JOIN filtered_customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk GROUP BY ROLLUP (i.i_item_id, s.s_state) ORDER BY i.i_item_id, s.s_state LIMIT 100"
        }
      ]
    }
  }
]