[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.95,
    "based_on": "p02,p03,p04",
    "strategy": "Decorrelation via precomputed per-item threshold CTE with early dimension filtering and explicit joins.",
    "hypothesis": "Primary hotspot is correlated subquery executing per outer row (SubPlan 1). p02 shows 153x speedup by decorrelating via threshold CTE. Combined with p03/p04 early date/item filtering to reduce hash join inputs. Fixed ambiguous column issue from p01.",
    "expected_explain_delta": "SubPlan nested loop disappears; single threshold CTE scan replaces per-row executions; early filtered dimension CTEs reduce hash join rows; explicit joins improve predicate pushdown.",
    "target_ir": "Add threshold_cte, filtered_dates, filtered_item nodes; update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["web_sales", "filtered_dates", "filtered_item", "threshold_cte"],
          "outputs": ["Excess Discount Amount"],
          "changed": true,
          "sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day'), filtered_item AS (SELECT i_item_sk FROM item WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))), threshold_cte AS (SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = filtered_dates.d_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36 AND (ws_sales_price / ws_list_price) BETWEEN 0.35 AND 0.50 GROUP BY ws_item_sk) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk JOIN threshold_cte ON web_sales.ws_item_sk = threshold_cte.ws_item_sk WHERE web_sales.ws_wholesale_cost BETWEEN 16 AND 36 AND web_sales.ws_ext_discount_amt > threshold_cte.threshold ORDER BY sum(ws_ext_discount_amt) LIMIT 100"
        },
        {
          "node_id": "filtered_dates",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day'"
        },
        {
          "node_id": "filtered_item",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))"
        },
        {
          "node_id": "threshold_cte",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "filtered_dates"],
          "outputs": ["ws_item_sk", "threshold"],
          "changed": true,
          "sql": "SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = filtered_dates.d_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36 AND (ws_sales_price / ws_list_price) BETWEEN 0.35 AND 0.50 GROUP BY ws_item_sk"
        }
      ]
    }
  }
]