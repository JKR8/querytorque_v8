[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p01",
    "strategy": "Convert comma joins to explicit INNER JOIN, push dimension filters into ON clauses, keep predicate order natural.",
    "hypothesis": "Probe p01 (neutral 1.01x) showed explicit join conversion is safe but did not improve; residual gap is 5856 index scans on catalog_sales due to nested loops. This rewrite removes comma‑join rigidity, allowing hash joins and better join order.",
    "expected_explain_delta": "Nested Loop replaced by Hash Join, Index Scan on catalog_sales replaced by Seq Scan or Bitmap Heap Scan, Sort cardinality estimate improved.",
    "target_ir": "Replace comma joins with explicit INNER JOIN and move dimension filters to ON clauses.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "SUBSTRING(w_warehouse_name FROM 1 FOR 20)",
            "sm_type",
            "cc_name",
            "\"30 days\"",
            "\"31-60 days\"",
            "\"61-90 days\"",
            "\"91-120 days\"",
            "\">120 days\""
          ],
          "changed": true,
          "sql": "SELECT\n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nFROM catalog_sales\nINNER JOIN date_dim ON cs_ship_date_sk = d_date_sk AND d_month_seq between 1192 and 1192 + 23\nINNER JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk AND w_gmt_offset = -5\nINNER JOIN ship_mode ON cs_ship_mode_sk = sm_ship_mode_sk AND sm_type = 'EXPRESS'\nINNER JOIN call_center ON cs_call_center_sk = cc_call_center_sk AND cc_class = 'small'\nWHERE cs_list_price between 86 and 115\nGROUP BY substring(w_warehouse_name,1,20), sm_type, cc_name\nORDER BY substring(w_warehouse_name,1,20), sm_type, cc_name\nLIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02",
    "strategy": "Derived‑table pre‑filter for each dimension to encourage small hash‑table build, avoid CTE materialization fence.",
    "hypothesis": "Probe p02 regressed (0.63x) likely due to CTE materialization blocking parallelism. Use inline derived tables instead, which may inline and allow hash joins with early‑filtered dimension sets.",
    "expected_explain_delta": "Hash Join build from small derived tables, reduce nested‑loop amplification, improve cardinality estimates for Sort.",
    "target_ir": "Replace CTEs with inline derived tables, preserve explicit JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "SUBSTRING(w_warehouse_name FROM 1 FOR 20)",
            "sm_type",
            "cc_name",
            "\"30 days\"",
            "\"31-60 days\"",
            "\"61-90 days\"",
            "\"91-120 days\"",
            "\">120 days\""
          ],
          "changed": true,
          "sql": "SELECT\n   substring(w_warehouse_name,1,20)\n  ,sm_type\n  ,cc_name\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end)  as \"30 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end )  as \"31-60 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end)  as \"61-90 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and\n                 (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end)  as \"91-120 days\"\n  ,sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end)  as \">120 days\"\nFROM catalog_sales\nINNER JOIN (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1192 AND 1192 + 23) dd ON cs_ship_date_sk = dd.d_date_sk\nINNER JOIN (SELECT w_warehouse_sk, w_warehouse_name FROM warehouse WHERE w_gmt_offset = -5) w ON cs_warehouse_sk = w.w_warehouse_sk\nINNER JOIN (SELECT sm_ship_mode_sk, sm_type FROM ship_mode WHERE sm_type = 'EXPRESS') sm ON cs_ship_mode_sk = sm.sm_ship_mode_sk\nINNER JOIN (SELECT cc_call_center_sk, cc_name FROM call_center WHERE cc_class = 'small') cc ON cs_call_center_sk = cc.cc_call_center_sk\nWHERE cs_list_price BETWEEN 86 AND 115\nGROUP BY substring(w_warehouse_name,1,20), sm_type, cc_name\nORDER BY substring(w_warehouse_name,1,20), sm_type, cc_name\nLIMIT 100"
        }
      ]
    }
  }
]