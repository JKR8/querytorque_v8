[
  {
    "plan_id": "compile_p03_fixed",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p03",
    "strategy": "Early fact-table reduction by pre‑filtering household_demographics and converting to explicit joins.",
    "hypothesis": "Winning probe p03 (1.11×) successfully reduces the 56K-row Nested‑Loop hotspot by joining store_sales, date_dim and household_demographics early, filtering hd_dep_count before the later joins. This rewrite preserves BitmapOr for the OR predicates and avoids the unsafe OR‑to‑UNION split.",
    "expected_explain_delta": "Nested‑Loop amplification reduced; household_demographics filter applied before hash‑join build; join order may improve.",
    "target_ir": "Introduce filtered_sales CTE with early hd_dep_count filter and explicit joins, keep final_select unchanged except source.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_sales", "store", "customer_demographics", "customer_address"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "WITH filtered_sales AS (\n  SELECT\n    ss.ss_quantity,\n    ss.ss_ext_sales_price,\n    ss.ss_ext_wholesale_cost,\n    ss.ss_net_profit,\n    ss.ss_sales_price,\n    ss.ss_store_sk,\n    ss.ss_cdemo_sk,\n    ss.ss_addr_sk,\n    hd.hd_dep_count\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001\n  JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk AND hd.hd_dep_count IN (1, 3)\n)\nSELECT\n  avg(fs.ss_quantity),\n  avg(fs.ss_ext_sales_price),\n  avg(fs.ss_ext_wholesale_cost),\n  sum(fs.ss_ext_wholesale_cost)\nFROM filtered_sales fs\nJOIN store s ON s.s_store_sk = fs.ss_store_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = fs.ss_cdemo_sk\nJOIN customer_address ca ON ca.ca_address_sk = fs.ss_addr_sk\nWHERE\n  (\n    (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND fs.ss_sales_price BETWEEN 100.00 AND 150.00 AND fs.hd_dep_count = 3) OR\n    (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 50.00 AND 100.00 AND fs.hd_dep_count = 1) OR\n    (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 150.00 AND 200.00 AND fs.hd_dep_count = 1)\n  ) AND\n  (\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND fs.ss_net_profit BETWEEN 100 AND 200) OR\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND fs.ss_net_profit BETWEEN 150 AND 300) OR\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND fs.ss_net_profit BETWEEN 50 AND 250)\n  )"
        },
        {
          "node_id": "filtered_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "household_demographics"],
          "outputs": ["ss_quantity", "ss_ext_sales_price", "ss_ext_wholesale_cost", "ss_net_profit", "ss_sales_price", "ss_store_sk", "ss_cdemo_sk", "ss_addr_sk", "hd_dep_count"],
          "changed": true,
          "sql": "SELECT\n    ss.ss_quantity,\n    ss.ss_ext_sales_price,\n    ss.ss_ext_wholesale_cost,\n    ss.ss_net_profit,\n    ss.ss_sales_price,\n    ss.ss_store_sk,\n    ss.ss_cdemo_sk,\n    ss.ss_addr_sk,\n    hd.hd_dep_count\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001\n  JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk AND hd.hd_dep_count IN (1, 3)"
        }
      ]
    }
  },
  {
    "plan_id": "compile_aggressive_prefilter",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p01",
    "strategy": "Pre‑filter all three dimension tables into CTEs before joining with store_sales and date_dim, converting comma joins to explicit JOIN syntax.",
    "hypothesis": "Worker p01 failed due to column‑reference syntax error; the underlying hypothesis (pre‑filtering dimensions to reduce fact‑table probe volume) remains sound. This attempt fixes the column‑scope error by bringing dimension‑specific filters into separate CTEs and joining on the appropriate keys.",
    "expected_explain_delta": "Early dimension scans reduce hash‑table sizes; fact‑table joins see fewer rows; join order may shift to place selective dimensions earlier.",
    "target_ir": "Introduce three dimension‑filter CTEs, join them with store_sales and date_dim, keep final aggregation unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["prefetch_household", "prefetch_customer_demo", "prefetch_customer_addr", "store_sales", "date_dim", "store"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "WITH\n  prefetch_household AS (\n    SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)\n  ),\n  prefetch_customer_demo AS (\n    SELECT cd_demo_sk, cd_marital_status, cd_education_status\n    FROM customer_demographics\n    WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR\n          (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR\n          (cd_marital_status = 'W' AND cd_education_status = 'Primary')\n  ),\n  prefetch_customer_addr AS (\n    SELECT ca_address_sk, ca_state\n    FROM customer_address\n    WHERE ca_country = 'United States' AND\n          ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH', 'SD')\n  )\nSELECT\n  avg(ss.ss_quantity),\n  avg(ss.ss_ext_sales_price),\n  avg(ss.ss_ext_wholesale_cost),\n  sum(ss.ss_ext_wholesale_cost)\nFROM store_sales ss\nJOIN store s ON s.s_store_sk = ss.ss_store_sk\nJOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001\nJOIN prefetch_household hd ON ss.ss_hdemo_sk = hd.hd_demo_sk\nJOIN prefetch_customer_demo cd ON ss.ss_cdemo_sk = cd.cd_demo_sk\nJOIN prefetch_customer_addr ca ON ss.ss_addr_sk = ca.ca_address_sk\nWHERE\n  (\n    (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR\n    (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR\n    (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)\n  ) AND\n  (\n    (ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR\n    (ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR\n    (ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250)\n  )"
        },
        {
          "node_id": "prefetch_household",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk"],
          "changed": true,
          "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)"
        },
        {
          "node_id": "prefetch_customer_demo",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status\n    FROM customer_demographics\n    WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR\n          (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR\n          (cd_marital_status = 'W' AND cd_education_status = 'Primary')"
        },
        {
          "node_id": "prefetch_customer_addr",
          "parent_node_id": "final_select",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_state\n    FROM customer_address\n    WHERE ca_country = 'United States' AND\n          ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH', 'SD')"
        }
      ]
    }
  }
]