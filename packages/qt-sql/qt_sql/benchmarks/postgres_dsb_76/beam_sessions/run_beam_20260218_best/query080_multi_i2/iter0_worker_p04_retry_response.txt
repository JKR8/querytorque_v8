{
  "probe_id": "p04",
  "transform_id": "shared_dimension_multi_channel",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Extracting shared dimension filters (date_dim, item, promotion) into a single CTE reduces redundant scans and enables better selectivity propagation in each channel branch.",
  "reasoning_trace": [
    "All three channel CTEs (ssr, csr, wsr) apply identical filters on date_dim, item, and promotion.",
    "Shared filters can be precomputed into one materialized CTE referenced by each channel.",
    "This avoids repeated scans of the same dimension tables with the same predicates.",
    "PostgreSQL's CTE inlining behavior supports this pattern without introducing materialization fences."
  ],
  "target_ir": "New CTE 'shared_dims' contains filtered surrogate keys; channel CTEs join to it instead of scanning dimensions directly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["wsr", "ssr", "csr"],
        "outputs": ["channel", "id", "sales", "returns", "profit"],
        "changed": false
      },
      {
        "node_id": "ssr",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "shared_dims", "store"],
        "outputs": ["store_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n from store_sales left outer join store_returns on\n        (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number)\n    join shared_dims on ss_sold_date_sk = shared_dims.d_date_sk\n                      and ss_item_sk = shared_dims.i_item_sk\n                      and ss_promo_sk = shared_dims.p_promo_sk\n    join store on ss_store_sk = s_store_sk\nwhere ss_wholesale_cost BETWEEN 21 AND 36\n      and shared_dims.p_channel_email = 'Y'\n      and shared_dims.p_channel_tv = 'N'\n      and shared_dims.p_channel_radio = 'N'\n      and shared_dims.p_channel_press = 'N'\n      and shared_dims.p_channel_event = 'N'\ngroup by s_store_id"
      },
      {
        "node_id": "csr",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "catalog_returns", "shared_dims", "catalog_page"],
        "outputs": ["catalog_page_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  cp_catalog_page_id as catalog_page_id,\n         sum(cs_ext_sales_price) as sales,\n         sum(coalesce(cr_return_amount, 0)) as returns,\n         sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n from catalog_sales left outer join catalog_returns on\n        (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number)\n    join shared_dims on cs_sold_date_sk = shared_dims.d_date_sk\n                      and cs_item_sk = shared_dims.i_item_sk\n                      and cs_promo_sk = shared_dims.p_promo_sk\n    join catalog_page on cs_catalog_page_sk = cp_catalog_page_sk\nwhere cs_wholesale_cost BETWEEN 21 AND 36\n      and shared_dims.p_channel_email = 'Y'\n      and shared_dims.p_channel_tv = 'N'\n      and shared_dims.p_channel_radio = 'N'\n      and shared_dims.p_channel_press = 'N'\n      and shared_dims.p_channel_event = 'N'\ngroup by cp_catalog_page_id"
      },
      {
        "node_id": "wsr",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "web_returns", "shared_dims", "web_site"],
        "outputs": ["web_site_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  web_site_id,\n         sum(ws_ext_sales_price) as sales,\n         sum(coalesce(wr_return_amt, 0)) as returns,\n         sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n from web_sales left outer join web_returns on\n        (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number)\n    join shared_dims on ws_sold_date_sk = shared_dims.d_date_sk\n                      and ws_item_sk = shared_dims.i_item_sk\n                      and ws_promo_sk = shared_dims.p_promo_sk\n    join web_site on ws_web_site_sk = web_site_sk\nwhere ws_wholesale_cost BETWEEN 21 AND 36\n      and shared_dims.p_channel_email = 'Y'\n      and shared_dims.p_channel_tv = 'N'\n      and shared_dims.p_channel_radio = 'N'\n      and shared_dims.p_channel_press = 'N'\n      and shared_dims.p_channel_event = 'N'\ngroup by web_site_id"
      },
      {
        "node_id": "shared_dims",
        "parent_node_id": "final_select",
        "sources": ["date_dim", "item", "promotion"],
        "outputs": ["d_date_sk", "i_item_sk", "p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio", "p_channel_press", "p_channel_event"],
        "changed": true,
        "sql": "select d_date_sk, i_item_sk, p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event\nfrom date_dim, item, promotion\nwhere d_date between cast('1999-10-21' as date)\n             and cast('1999-10-21' as date) + interval '30 day'\n  and i_current_price > 50\n  and i_category IN ('Men', 'Music')\n  and ss_promo_sk = p_promo_sk\n  and p_channel_email = 'Y'\n  and p_channel_tv = 'N'\n  and p_channel_radio = 'N'\n  and p_channel_press = 'N'\n  and p_channel_event = 'N'"
      }
    ]
  }
}