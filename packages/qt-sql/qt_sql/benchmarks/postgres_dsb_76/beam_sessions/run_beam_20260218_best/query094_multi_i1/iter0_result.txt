{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.02401748,
  "beam_cost_priced_calls": 7,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 86055,
    "completion_tokens": 15075,
    "total_tokens": 101130,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 23488,
    "reasoning_tokens": 7528
  },
  "best_speedup": 2.14,
  "best_patch_id": "compile_p1",
  "best_sql": "SELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales ws1 INNER JOIN date_dim ON ws1.ws_ship_date_sk = date_dim.d_date_sk AND date_dim.d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day' INNER JOIN customer_address ON ws1.ws_ship_addr_sk = customer_address.ca_address_sk AND customer_address.ca_state IN ('CA','MI','OH','SD','TX','VA') INNER JOIN web_site ON ws1.ws_web_site_sk = web_site.web_site_sk AND web_site.web_gmt_offset >= -5 WHERE ws1.ws_list_price BETWEEN 237 AND 266 AND EXISTS (SELECT * FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.75,
      "status": "IMPROVED",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 484.4,
      "patch_ms": 459.8,
      "output_sql": "WITH date_dim_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day') SELECT COUNT(DISTINCT ws_order_number) AS \"order count\", SUM(ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws_net_profit) AS \"total net profit\" FROM web_sales ws1 INNER JOIN date_dim_filtered d ON ws1.ws_ship_date_sk = d.d_date_sk INNER JOIN customer_address ca ON ws1.ws_ship_addr_sk = ca.ca_address_sk INNER JOIN web_site w ON ws1.ws_web_site_sk = w.web_site_sk WHERE ca_state IN ('CA','MI','OH','SD','TX','VA') AND w.web_gmt_offset >= -5 AND ws1.ws_list_price BETWEEN 237 AND 266 AND EXISTS (SELECT * FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) ORDER BY COUNT(DISTINCT ws_order_number) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated joins to explicit INNER JOIN syntax and isolate date_dim filter into a CTE to create a tiny hash table for early join."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.6,
      "status": "REGRESSION",
      "speedup": 0.82,
      "semantic_passed": true,
      "error": null,
      "original_ms": 484.4,
      "patch_ms": 591.5,
      "output_sql": "WITH ws_filtered AS (SELECT ws1.ws_order_number, ws1.ws_warehouse_sk, ws1.ws_ext_ship_cost, ws1.ws_net_profit FROM web_sales ws1 JOIN date_dim ON ws1.ws_ship_date_sk = date_dim.d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = customer_address.ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site.web_site_sk WHERE date_dim.d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day' AND customer_address.ca_state IN ('CA','MI','OH','SD','TX','VA') AND web_site.web_gmt_offset >= -5 AND ws1.ws_list_price BETWEEN 237 AND 266) SELECT COUNT(DISTINCT ws_order_number) AS \"order count\", SUM(ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws_net_profit) AS \"total net profit\" FROM ws_filtered WHERE EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws_filtered.ws_order_number = ws2.ws_order_number AND ws_filtered.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT 1 FROM web_returns wr1 WHERE ws_filtered.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) ORDER BY COUNT(DISTINCT ws_order_number) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Create a MATERIALIZED CTE that pre-joins filtered date_dim, customer_address, web_site with web_sales (ws1) to produce a reduced fact set, then apply EXISTS/NOT EXISTS checks."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.7,
      "status": "REGRESSION",
      "speedup": 0.75,
      "semantic_passed": true,
      "error": null,
      "original_ms": 484.4,
      "patch_ms": 641.8,
      "output_sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_date between '2002-9-01' and cast('2002-9-01' as date) + interval '60 day'), customer_address_filtered AS (SELECT ca_address_sk FROM customer_address WHERE ca_state in ('CA','MI','OH','SD','TX','VA')), web_site_filtered AS (SELECT web_site_sk FROM web_site WHERE web_gmt_offset >= -5), web_sales_prefiltered AS (SELECT ws1.ws_order_number, ws1.ws_warehouse_sk, ws1.ws_ext_ship_cost, ws1.ws_net_profit\nFROM web_sales ws1\nJOIN date_filtered d ON ws1.ws_ship_date_sk = d.d_date_sk\nJOIN customer_address_filtered ca ON ws1.ws_ship_addr_sk = ca.ca_address_sk\nJOIN web_site_filtered web ON ws1.ws_web_site_sk = web.web_site_sk\nWHERE ws1.ws_list_price between 237 and 266) select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales_prefiltered\nwhere\n    exists (select *\n            from web_sales ws2\n            where web_sales_prefiltered.ws_order_number = ws2.ws_order_number\n              and web_sales_prefiltered.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nand not exists(select *\n               from web_returns wr1\n               where web_sales_prefiltered.ws_order_number = wr1.wr_order_number\n               and wr1.wr_reason_sk in (7, 25, 26, 52, 69)\n               )\norder by count(distinct ws_order_number)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, customer_address, web_site) into separate CTEs, then join them with web_sales (ws1) before applying EXISTS/NOT EXISTS checks."
    },
    {
      "patch_id": "p03",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 484.4,
      "patch_ms": 21903.0,
      "output_sql": "WITH web_sales_filtered AS (SELECT * FROM web_sales), ws_multiple_warehouse_orders AS (SELECT DISTINCT ws_order_number FROM web_sales WHERE ws_warehouse_sk IS NOT NULL GROUP BY ws_order_number HAVING COUNT(DISTINCT ws_warehouse_sk) > 1), wr_filtered_orders AS (SELECT DISTINCT wr_order_number FROM web_returns WHERE wr_reason_sk IN (7, 25, 26, 52, 69)) SELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales ws1 JOIN (SELECT DISTINCT ws_order_number FROM web_sales WHERE ws_warehouse_sk IS NOT NULL GROUP BY ws_order_number HAVING COUNT(DISTINCT ws_warehouse_sk) > 1) ws_multiple_warehouse_orders ON ws1.ws_order_number = ws_multiple_warehouse_orders.ws_order_number LEFT JOIN (SELECT DISTINCT wr_order_number FROM web_returns WHERE wr_reason_sk IN (7, 25, 26, 52, 69)) wr_filtered_orders ON ws1.ws_order_number = wr_filtered_orders.wr_order_number JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day' AND ca_state IN ('CA','MI','OH','SD','TX','VA') AND web_gmt_offset >= -5 AND ws1.ws_list_price BETWEEN 237 AND 266 AND wr_filtered_orders.wr_order_number IS NULL ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push dimension filters into CTEs and decorrelate EXISTS/NOT EXISTS by pre-computing distinct ws_order_number sets for each subquery, then join as anti/semi-joins."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 2.14,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1569.8,
      "patch_ms": 734.3,
      "output_sql": "SELECT COUNT(DISTINCT ws1.ws_order_number) AS \"order count\", SUM(ws1.ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws1.ws_net_profit) AS \"total net profit\" FROM web_sales ws1 INNER JOIN date_dim ON ws1.ws_ship_date_sk = date_dim.d_date_sk AND date_dim.d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 day' INNER JOIN customer_address ON ws1.ws_ship_addr_sk = customer_address.ca_address_sk AND customer_address.ca_state IN ('CA','MI','OH','SD','TX','VA') INNER JOIN web_site ON ws1.ws_web_site_sk = web_site.web_site_sk AND web_site.web_gmt_offset >= -5 WHERE ws1.ws_list_price BETWEEN 237 AND 266 AND EXISTS (SELECT * FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) ORDER BY COUNT(DISTINCT ws1.ws_order_number) LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=1, time=1181.749)\n  Sort  (rows=1, time=1181.744)\n    Aggregate  (rows=1, time=1181.705)\n      Nested Loop  (rows=753, time=1179.89)\n        Nested Loop  (rows=753, time=1167.924)\n          Gather  (rows=944, time=1164.723)\n            Nested Loop  (rows=944, time=1163.003)\n              Hash Join  (rows=4281, time=1088.841)\n                Nested Loop  (rows=5064, time=749.648)\n                  Seq Scan on date_dim  (rows=61, time=16.832)\n                  Index Scan on web_sales ",
    "p04": "Limit  (rows=1, time=1274.402)\n  Sort  (rows=1, time=1274.398)\n    Aggregate  (rows=1, time=1274.354)\n      Nested Loop  (rows=753, time=1271.689)\n        Nested Loop  (rows=753, time=1256.503)\n          Gather  (rows=944, time=1252.535)\n            Nested Loop  (rows=944, time=1250.639)\n              Hash Join  (rows=4281, time=1166.502)\n                Nested Loop  (rows=5064, time=835.32)\n                  Seq Scan on date_dim  (rows=61, time=15.255)\n                  Index Scan on web_sales ",
    "p02": "Limit  (rows=1, time=1190.027)\n  Sort  (rows=1, time=1190.022)\n    Aggregate  (rows=1, time=1189.862)\n      Nested Loop  (rows=753, time=1187.957)\n        Nested Loop  (rows=753, time=1175.021)\n          Gather  (rows=944, time=1171.835)\n            Nested Loop  (rows=944, time=1169.849)\n              Hash Join  (rows=4281, time=1089.141)\n                Nested Loop  (rows=5064, time=743.683)\n                  Seq Scan on date_dim  (rows=61, time=14.015)\n                  Index Scan on web_sales",
    "p03": "Limit  (rows=1, time=35346.644)\n  Sort  (rows=1, time=35346.639)\n    Aggregate  (rows=1, time=35346.609)\n      Nested Loop  (rows=753, time=35341.667)\n        Nested Loop  (rows=753, time=1160.361)\n          Nested Loop  (rows=944, time=1154.142)\n            Hash Join  (rows=4281, time=1077.502)\n              Gather  (rows=5064, time=694.3)\n                Nested Loop  (rows=5064, time=692.093)\n                  Seq Scan on date_dim  (rows=61, time=13.127)\n                  Index Scan on web_sal",
    "compile_p1": "Limit  (rows=1, time=825.79)\n  Sort  (rows=1, time=825.786)\n    Aggregate  (rows=1, time=825.624)\n      Nested Loop  (rows=753, time=824.777)\n        Nested Loop  (rows=753, time=818.505)\n          Gather  (rows=944, time=816.58)\n            Nested Loop  (rows=944, time=814.515)\n              Hash Join  (rows=4281, time=771.631)\n                Nested Loop  (rows=5064, time=379.493)\n                  Seq Scan on date_dim  (rows=61, time=18.121)\n                  Index Scan on web_sales (ws1)  (r"
  }
}