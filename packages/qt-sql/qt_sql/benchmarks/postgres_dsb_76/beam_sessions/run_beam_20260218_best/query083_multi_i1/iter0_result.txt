{
  "iteration": 0,
  "n_api_calls": 9,
  "beam_cost_usd": 0.02895601,
  "beam_cost_priced_calls": 9,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 123032,
    "completion_tokens": 16504,
    "total_tokens": 139536,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 49344,
    "reasoning_tokens": 6511
  },
  "best_speedup": 70.99,
  "best_patch_id": "compile_p02_early_filter",
  "best_sql": "WITH sr_items AS (SELECT i.i_item_id AS item_id, SUM(sr.sr_return_quantity) AS sr_item_qty FROM store_returns sr JOIN item i ON sr.sr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON sr.sr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 237 AND 266 AND sr.sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), cr_items AS (SELECT i.i_item_id AS item_id, SUM(cr.cr_return_quantity) AS cr_item_qty FROM catalog_returns cr JOIN item i ON cr.cr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON cr.cr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 237 AND 266 AND cr.cr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), wr_items AS (SELECT i.i_item_id AS item_id, SUM(wr.wr_return_quantity) AS wr_item_qty FROM web_returns wr JOIN item i ON wr.wr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON wr.wr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 237 AND 266 AND wr.wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.75,
      "status": "REGRESSION",
      "speedup": 0.4,
      "semantic_passed": true,
      "error": null,
      "original_ms": 384.3,
      "patch_ms": 955.1,
      "output_sql": "WITH filtered_dates AS (select d_date_sk, d_date from date_dim where d_month_seq in (select d_month_seq from date_dim where d_date in ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))), sr_items AS (select i_item_id item_id, sum(sr_return_quantity) sr_item_qty from store_returns, item, filtered_dates where sr_item_sk = i_item_sk and d_date = filtered_dates.d_date and sr_returned_date_sk = d_date_sk and i_category IN ('Home', 'Men') and i_manager_id BETWEEN 8 and 17 and sr_return_amt / sr_return_quantity between 237 and 266 and sr_reason_sk in (6, 7, 25, 45, 51) group by i_item_id), cr_items AS (select i_item_id item_id, sum(cr_return_quantity) cr_item_qty from catalog_returns, item, filtered_dates where cr_item_sk = i_item_sk and d_date = filtered_dates.d_date and cr_returned_date_sk = d_date_sk and i_category IN ('Home', 'Men') and i_manager_id BETWEEN 8 and 17 and cr_return_amount / cr_return_quantity between 237 and 266 and cr_reason_sk in (6, 7, 25, 45, 51) group by i_item_id), wr_items AS (select i_item_id item_id, sum(wr_return_quantity) wr_item_qty from web_returns, item, filtered_dates where wr_item_sk = i_item_sk and d_date = filtered_dates.d_date and wr_returned_date_sk = d_date_sk and i_category IN ('Home', 'Men') and i_manager_id BETWEEN 8 and 17 and wr_return_amt / wr_return_quantity between 237 and 266 and wr_reason_sk in (6, 7, 25, 45, 51) group by i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Extract common date filter subquery into a single CTE (filtered_dates) and reference it in all three channel CTEs (sr_items, cr_items, wr_items) to avoid redundant date_dim scans."
    },
    {
      "patch_id": "p03",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.61,
      "semantic_passed": true,
      "error": null,
      "original_ms": 384.3,
      "patch_ms": 628.4,
      "output_sql": "WITH sr_items AS (SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns, item, date_dim WHERE sr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26', '2002-05-03', '2002-08-19', '2002-11-18'))) AND sr_returned_date_sk = d_date_sk AND i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 AND sr_return_amt / sr_return_quantity BETWEEN 237 AND 266 AND sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i_item_id), wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns, item, date_dim WHERE wr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26', '2002-05-03', '2002-08-19', '2002-11-18'))) AND wr_returned_date_sk = d_date_sk AND i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 AND wr_return_amt / wr_return_quantity BETWEEN 237 AND 266 AND wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i_item_id), cr_items_materialized AS (SELECT i.i_item_id, cr.cr_return_quantity FROM catalog_returns cr JOIN date_dim d ON cr.cr_returned_date_sk = d.d_date_sk JOIN item i ON cr.cr_item_sk = i.i_item_sk WHERE d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18'))) AND i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 237 AND 266 AND cr.cr_reason_sk IN (6, 7, 25, 45, 51)), cr_items AS (SELECT i_item_id item_id, sum(cr_return_quantity) cr_item_qty FROM cr_items_materialized GROUP BY i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the filtered date_dim + catalog_returns join once as a CTE, then compute aggregates per item_id, avoiding repeated scans of catalog_returns."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.6,
      "status": "REGRESSION",
      "speedup": 0.38,
      "semantic_passed": true,
      "error": null,
      "original_ms": 384.3,
      "patch_ms": 1001.5,
      "output_sql": "WITH wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns, item, date_dim WHERE wr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26', '2002-05-03', '2002-08-19', '2002-11-18'))) AND wr_returned_date_sk = d_date_sk AND i_category IN ('Home', 'Men') AND i_manager_id BETWEEN 8 AND 17 AND wr_return_amt / wr_return_quantity BETWEEN 237 AND 266 AND wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i_item_id), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')))), sr_items AS (SELECT i.i_item_id AS item_id, SUM(sr.sr_return_quantity) AS sr_item_qty FROM store_returns sr INNER JOIN item i ON sr.sr_item_sk = i.i_item_sk INNER JOIN filtered_dates fd ON sr.sr_returned_date_sk = fd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 237 AND 266 AND sr.sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), cr_items AS (SELECT i.i_item_id AS item_id, SUM(cr.cr_return_quantity) AS cr_item_qty FROM catalog_returns cr INNER JOIN item i ON cr.cr_item_sk = i.i_item_sk INNER JOIN filtered_dates fd ON cr.cr_returned_date_sk = fd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 237 AND 266 AND cr.cr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins in sr_items and cr_items to explicit INNER JOIN syntax and isolate date filter into a CTE to improve join planning."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.7,
      "status": "WIN",
      "speedup": 8.72,
      "semantic_passed": true,
      "error": null,
      "original_ms": 384.3,
      "patch_ms": 44.1,
      "output_sql": "WITH sr_items AS (SELECT i.i_item_id AS item_id, SUM(sr.sr_return_quantity) AS sr_item_qty FROM store_returns sr JOIN item i ON sr.sr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON sr.sr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 237 AND 266 AND sr.sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), cr_items AS (SELECT i.i_item_id AS item_id, SUM(cr.cr_return_quantity) AS cr_item_qty FROM catalog_returns cr JOIN item i ON cr.cr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON cr.cr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 237 AND 266 AND cr.cr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), wr_items AS (SELECT i.i_item_id AS item_id, SUM(wr.wr_return_quantity) AS wr_item_qty FROM web_returns wr JOIN item i ON wr.wr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON wr.wr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 237 AND 266 AND wr.wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim by the four hardcoded dates and join only the surrogate keys (d_date_sk) to catalog_returns before other filters, moving i_category and i_manager_id filters earlier."
    },
    {
      "patch_id": "compile_p02_early_filter",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 70.99,
      "semantic_passed": true,
      "error": null,
      "original_ms": 3611.5,
      "patch_ms": 50.9,
      "output_sql": "WITH sr_items AS (SELECT i.i_item_id AS item_id, SUM(sr.sr_return_quantity) AS sr_item_qty FROM store_returns sr JOIN item i ON sr.sr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON sr.sr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 237 AND 266 AND sr.sr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), cr_items AS (SELECT i.i_item_id AS item_id, SUM(cr.cr_return_quantity) AS cr_item_qty FROM catalog_returns cr JOIN item i ON cr.cr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON cr.cr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 237 AND 266 AND cr.cr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id), wr_items AS (SELECT i.i_item_id AS item_id, SUM(wr.wr_return_quantity) AS wr_item_qty FROM web_returns wr JOIN item i ON wr.wr_item_sk = i.i_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_date IN ('2002-02-26','2002-05-03','2002-08-19','2002-11-18')) dd ON wr.wr_returned_date_sk = dd.d_date_sk WHERE i.i_category IN ('Home', 'Men') AND i.i_manager_id BETWEEN 8 AND 17 AND wr.wr_return_amt / wr.wr_return_quantity BETWEEN 237 AND 266 AND wr.wr_reason_sk IN (6, 7, 25, 45, 51) GROUP BY i.i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=0, time=903.815)\n  Nested Loop  (rows=120, time=9.273)\n    Aggregate  (rows=4, time=8.653)\n      Index Only Scan on date_dim (date_dim_1)  (rows=4, time=8.619)\n    Index Scan on date_dim  (rows=30, time=0.096)\n  Sort  (rows=0, time=903.803)\n    Nested Loop  (rows=0, time=903.757)\n      Merge Join  (rows=0, time=903.748)\n        Aggregate  (rows=2, time=788.1)\n          Sort  (rows=2, time=788.085)\n            Nested Loop  (rows=2, time=788.035)\n              Nested Loop  (rows=101, ",
    "p03": "Limit  (rows=0, time=445.425)\n  Sort  (rows=0, time=445.423)\n    Nested Loop  (rows=0, time=445.398)\n      Nested Loop  (rows=0, time=445.393)\n        Aggregate  (rows=2, time=339.638)\n          Sort  (rows=2, time=339.624)\n            Gather  (rows=2, time=339.607)\n              Nested Loop  (rows=1, time=247.644)\n                Nested Loop  (rows=50, time=246.913)\n                  Hash Join  (rows=60, time=10.859)\n                    Seq Scan on date_dim  (rows=36524, time=4.107)\n           ",
    "p04": "Limit  (rows=0, time=794.914)\n  Hash Join  (rows=120, time=18.372)\n    Seq Scan on date_dim (date_dim_3)  (rows=73049, time=8.732)\n    Hash  (rows=120, time=4.954)\n      Nested Loop  (rows=120, time=4.939)\n        Aggregate  (rows=4, time=4.904)\n          Index Only Scan on date_dim (date_dim_5)  (rows=4, time=4.892)\n        Index Only Scan on date_dim (date_dim_4)  (rows=30, time=0.007)\n  Sort  (rows=0, time=794.904)\n    Nested Loop  (rows=0, time=794.878)\n      Merge Join  (rows=0, time=794.86",
    "p02": "Limit  (rows=0, time=41.884)\n  Sort  (rows=0, time=41.882)\n    Nested Loop  (rows=0, time=41.863)\n      Nested Loop  (rows=0, time=41.856)\n        Aggregate  (rows=0, time=41.846)\n          Sort  (rows=0, time=41.844)\n            Nested Loop  (rows=0, time=41.834)\n              Gather  (rows=5, time=41.745)\n                Nested Loop  (rows=2, time=31.345)\n                  Seq Scan on date_dim  (rows=2, time=4.713)\n                  Index Scan on store_returns (sr)  (rows=1, time=13.309)\n     ",
    "compile_p02_early_filter": "Limit  (rows=0, time=73.863)\n  Sort  (rows=0, time=73.86)\n    Nested Loop  (rows=0, time=73.818)\n      Nested Loop  (rows=0, time=73.813)\n        Aggregate  (rows=0, time=73.807)\n          Sort  (rows=0, time=73.805)\n            Nested Loop  (rows=0, time=73.781)\n              Gather  (rows=5, time=73.653)\n                Nested Loop  (rows=5, time=73.094)\n                  Seq Scan on date_dim  (rows=4, time=12.324)\n                  Index Scan on store_returns (sr)  (rows=1, time=15.186)\n     "
  }
}