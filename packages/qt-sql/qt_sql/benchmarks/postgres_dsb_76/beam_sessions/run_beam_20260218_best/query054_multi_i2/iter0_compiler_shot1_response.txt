[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.45,
    "based_on": "p01,p04",
    "strategy": "Minimal explicit-join conversion with date-range CTE to address comma-join weakness and subquery evaluation.",
    "hypothesis": "All probes regressed, but original plan shows 717ms with nested loops on large fact tables. Comma joins may block predicate pushdown and join reordering. This attempt converts both CTEs to explicit joins and precomputes date-range constants, avoiding heavy CTE duplication and preserving semantics.",
    "expected_explain_delta": "Nested loops may convert to hash joins; date-range subqueries evaluated once; join order may improve.",
    "target_ir": "Convert my_customers and my_revenue to explicit INNER JOINs; add date_range CTE; keep UNION ALL structure.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["segments"],
          "outputs": ["segment", "num_customers", "segment_base"],
          "changed": false
        },
        {
          "node_id": "segments",
          "parent_node_id": "final_select",
          "sources": ["my_revenue"],
          "outputs": ["segment"],
          "changed": false
        },
        {
          "node_id": "my_revenue",
          "parent_node_id": "segments",
          "sources": ["my_customers", "store_sales", "customer_address", "store", "date_dim", "date_range"],
          "outputs": ["c_customer_sk", "revenue"],
          "changed": true,
          "sql": "SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk INNER JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk INNER JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk INNER JOIN date_range ON date_dim.d_month_seq BETWEEN date_range.start_seq AND date_range.end_seq WHERE store_sales.ss_wholesale_cost BETWEEN 70 AND 100 AND store.s_state IN ('AR','GA','IN','KS','KY','NC','OH','PA','SD','VA') GROUP BY c_customer_sk"
        },
        {
          "node_id": "my_customers",
          "parent_node_id": "my_revenue",
          "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
          "outputs": ["c_customer_sk", "c_current_addr_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales INNER JOIN item ON cs_or_ws_sales.item_sk = item.i_item_sk INNER JOIN date_dim ON cs_or_ws_sales.sold_date_sk = date_dim.d_date_sk INNER JOIN customer ON cs_or_ws_sales.customer_sk = customer.c_customer_sk WHERE item.i_category = 'Home' AND item.i_class = 'curtains/drapes' AND date_dim.d_moy = 5 AND date_dim.d_year = 1998 AND cs_or_ws_sales.wholesale_cost BETWEEN 70 AND 100 AND customer.c_birth_year BETWEEN 1942 AND 1955"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "my_revenue",
          "sources": [],
          "outputs": ["start_seq", "end_seq"],
          "changed": true,
          "sql": "SELECT (SELECT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AS start_seq, (SELECT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 5) AS end_seq"
        }
      ]
    }
  }
]