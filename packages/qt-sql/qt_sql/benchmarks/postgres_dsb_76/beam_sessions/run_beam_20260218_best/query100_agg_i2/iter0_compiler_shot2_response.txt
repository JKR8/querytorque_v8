[
  {
    "plan_id": "compile_p01",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Explicit join conversion with date CTE to break comma-join weakness",
    "hypothesis": "Probe p01 (WIN) converted comma joins to explicit JOINs and isolated date filter into a CTE, achieving 1.15x speedup by addressing comma-join weakness and enabling better join reordering.",
    "expected_explain_delta": "Merge Join replaced by hash join or nested loop with lower input rows; better join order and predicate pushdown.",
    "target_ir": "Convert comma joins to explicit JOINs and push date filter into a CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["item", "item", "store_sales", "store_sales", "customer", "customer_address", "customer_demographics", "filtered_date_dim"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1) SELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt FROM item AS item1 JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN customer ON s1.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk JOIN filtered_date_dim ON filtered_date_dim.d_date_sk = s1.ss_sold_date_sk WHERE item1.i_category IN ('Electronics', 'Men') AND item2.i_manager_id BETWEEN 44 AND 63 AND customer_demographics.cd_marital_status = 'D' AND customer_demographics.cd_education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129 AND s2.ss_list_price BETWEEN 115 AND 129 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02_fixed",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p02",
    "strategy": "Dimension prefetch with explicit joins to push all selective filters early",
    "hypothesis": "Fixed syntax error from p02; prefetches all selective dimensions and fact tables into CTEs to break comma-join and reduce input sizes before the self‑join and inequality comparison.",
    "expected_explain_delta": "Early filtering of store_sales and item2 may reduce nested‑loop iterations and avoid large Merge Join.",
    "target_ir": "Create CTEs for each filtered table and join explicitly.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "prefetch_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1"
        },
        {
          "node_id": "prefetch_customer_demographics",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D' AND cd_education_status = 'College'"
        },
        {
          "node_id": "prefetch_item1",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Electronics', 'Men')"
        },
        {
          "node_id": "prefetch_item2",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63"
        },
        {
          "node_id": "prefetch_s1",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number", "ss_customer_sk", "ss_sold_date_sk"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129"
        },
        {
          "node_id": "prefetch_s2",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["prefetch_item1", "prefetch_item2", "prefetch_s1", "prefetch_s2", "customer", "customer_address", "prefetch_customer_demographics", "prefetch_date_dim"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH prefetch_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1), prefetch_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D' AND cd_education_status = 'College'), prefetch_item1 AS (SELECT i_item_sk FROM item WHERE i_category IN ('Electronics', 'Men')), prefetch_item2 AS (SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63), prefetch_s1 AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129), prefetch_s2 AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129) SELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt FROM prefetch_item1 AS item1 JOIN prefetch_item2 AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN prefetch_s1 AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN prefetch_s2 AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN customer ON s1.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN prefetch_customer_demographics AS cd ON customer.c_current_cdemo_sk = cd.cd_demo_sk JOIN prefetch_date_dim AS d ON s1.ss_sold_date_sk = d.d_date_sk GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        }
      ]
    }
  }
]