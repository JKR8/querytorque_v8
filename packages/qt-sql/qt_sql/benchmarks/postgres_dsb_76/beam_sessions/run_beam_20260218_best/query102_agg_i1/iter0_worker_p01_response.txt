{
  "probe_id": "scout_01",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing selective dimensions (date_dim, item, customer_address, household_demographics) and pre-joining with fact tables (store_sales, web_sales) reduces rows before the expensive non-equi date join and final Merge Join.",
  "reasoning_trace": [
    "Assigned transform targets non-equi join with high input cardinality.",
    "Materialized CTEs for selective dimensions reduce fact table sizes early.",
    "Pre-join filtering on fact tables preserves downstream join compatibility.",
    "Non-equi join (d2.d_date BETWEEN d1.d_date AND d1.d_date + 30) benefits from smaller input sets."
  ],
  "target_ir": "MATERIALIZED CTEs for dimensions and early pre-join filtering on facts; final_select remains unchanged.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["prejoined_facts", "date_dim d1", "date_dim d2", "customer", "inventory", "store", "warehouse", "customer_demographics", "household_demographics", "customer_address"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "count(*) as cnt"],
        "changed": false
      },
      {
        "node_id": "prejoined_facts",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "web_sales", "item", "customer_address", "household_demographics"],
        "outputs": ["ss_item_sk", "ws_item_sk", "ss_sold_date_sk", "ws_sold_date_sk", "ss_customer_sk", "ws_bill_customer_sk", "ws_warehouse_sk", "inv_item_sk", "inv_date_sk", "inv_quantity_on_hand", "ss_quantity", "s_state", "w_state", "i_category", "i_manager_id", "ca_state", "ws_wholesale_cost"],
        "changed": true,
        "sql": "WITH mat_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)), mat_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA')), mat_household_demographics AS (SELECT hd_demo_sk FROM household_demographics) SELECT ss.ss_item_sk, ws.ws_item_sk, ss.ss_sold_date_sk, ws.ws_sold_date_sk, ss.ss_customer_sk, ws.ws_bill_customer_sk, ws.ws_warehouse_sk, inv.inv_item_sk, inv.inv_date_sk, inv.inv_quantity_on_hand, ss.ss_quantity, s.s_state, w.w_state, i.i_category, i.i_manager_id, ca.ca_state, ws.ws_wholesale_cost FROM store_sales ss JOIN web_sales ws ON ss.ss_item_sk = ws.ws_item_sk JOIN inventory inv ON inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk JOIN store s ON s.s_state = w.w_state JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk JOIN mat_item i ON ss.ss_item_sk = i.i_item_sk JOIN mat_customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN mat_household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE inv.inv_quantity_on_hand >= ss.ss_quantity AND ws.ws_wholesale_cost BETWEEN 35 AND 55"
      },
      {
        "node_id": "mat_date_dim_d1",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date", "d_year"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date, d_year FROM date_dim WHERE d_year = 2001"
      },
      {
        "node_id": "mat_date_dim_d2",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      }
    ]
  }
}