[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01",
    "strategy": "Materialize selective dimensions early and convert to explicit JOINs to improve cardinality estimates.",
    "hypothesis": "Probe p01 showed 2.83x speedup but with identical SQL - likely due to caching or plan instability. The original plan's primary hotspot is the Sort/Merge Join (12.2s) with poor cardinality estimates due to comma-join syntax and late non-equi date filter. Materializing selective dimensions and converting to explicit joins should stabilize better plans.",
    "expected_explain_delta": "Sort/Merge Join replaced with hash joins, earlier filtering of date_dim d1 and dimensions, reduced rows flowing to final aggregation.",
    "target_ir": "Replace comma joins with explicit JOINs, materialize selective filters early, maintain original join relationships.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_store_sales", "filtered_web_sales", "customer", "customer_demographics", "household_demographics", "customer_address", "store", "warehouse"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"],
          "changed": true,
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM filtered_store_sales ss JOIN filtered_web_sales ws ON ss.ss_item_sk = ws.ws_item_sk AND ss.ss_customer_sk = ws.ws_bill_customer_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store s ON s.s_state = ws.w_state JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ca.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA') GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt"
        },
        {
          "node_id": "filtered_store_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim_d1", "item", "inventory"],
          "outputs": ["ss_item_sk", "ss_customer_sk", "ss_sold_date_sk", "ss_quantity"],
          "changed": true,
          "sql": "SELECT ss.ss_item_sk, ss.ss_customer_sk, ss.ss_sold_date_sk, ss.ss_quantity FROM store_sales ss JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN inventory inv ON ss.ss_item_sk = inv.inv_item_sk AND ss.ss_sold_date_sk = inv.inv_date_sk WHERE d1.d_year = 2001 AND i.i_category IN ('Children', 'Jewelry', 'Men') AND i.i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93) AND inv.inv_quantity_on_hand >= ss.ss_quantity"
        },
        {
          "node_id": "filtered_web_sales",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim_d2", "filtered_store_sales"],
          "outputs": ["ws_item_sk", "ws_bill_customer_sk", "ws_warehouse_sk", "ws_wholesale_cost", "ws_state"],
          "changed": true,
          "sql": "SELECT ws.ws_item_sk, ws.ws_bill_customer_sk, ws.ws_warehouse_sk, ws.ws_wholesale_cost, w.w_state FROM web_sales ws JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk JOIN filtered_store_sales ss ON ws.ws_item_sk = ss.ss_item_sk AND ws.ws_bill_customer_sk = ss.ss_customer_sk WHERE d2.d_date BETWEEN (SELECT d_date FROM date_dim WHERE d_date_sk = ss.ss_sold_date_sk) AND (SELECT d_date + INTERVAL '30 day' FROM date_dim WHERE d_date_sk = ss.ss_sold_date_sk)"
        }
      ]
    }
  }
]