[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.72,
    "based_on": "p01,p02",
    "strategy": "Convert comma joins to explicit joins and pre-filter selective dimension into CTEs for early predicate pushdown.",
    "hypothesis": "Hotspots are CTE materializations (best_ss_customer 17.9s, frequent_ss_items 3.4s) due to late filter application and comma‑join weakness. Pre‑filtering date_dim for d_year=1998 into a shared CTE and converting to explicit JOINs enables earlier reduction and better join ordering.",
    "expected_explain_delta": "Replace sequential scans on date_dim with index‑only scans, reduce hash‑join input sizes, and allow predicate pushdown into store_sales joins.",
    "target_ir": "Add d1998 and d1998_m10 CTEs, rewrite frequent_ss_items and max_store_sales with explicit JOINs, keep final SELECT unchanged except for date‑filter CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "web_sales", "d1998_m10", "frequent_ss_items", "best_ss_customer"],
          "outputs": ["SUM(sales)"],
          "changed": false
        },
        {
          "node_id": "d1998",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
        },
        {
          "node_id": "d1998_m10",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 10"
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "d1998", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d.d_date AS solddate, COUNT(*) AS cnt FROM store_sales ss INNER JOIN d1998 d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_manager_id BETWEEN 81 AND 100 AND i.i_category IN ('Children', 'Men', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d.d_date HAVING COUNT(*) > 4"
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "d1998", "customer"],
          "outputs": ["tpcds_cmax"],
          "changed": true,
          "sql": "SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c.c_customer_sk, SUM(ss.ss_quantity * ss.ss_sales_price) AS csales FROM store_sales ss INNER JOIN d1998 d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_wholesale_cost BETWEEN 11 AND 21 GROUP BY c.c_customer_sk) tmp1"
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": false
        }
      ]
    }
  }
]