{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.03445316,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 122607,
    "completion_tokens": 27524,
    "total_tokens": 150131,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 45696,
    "reasoning_tokens": 15293
  },
  "best_speedup": 4.95,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH filtered_store_sales_date AS (\n  SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n  FROM store_sales, date_dim\n  WHERE ss_sold_date_sk = d_date_sk\n    AND d_month_seq BETWEEN 1195 AND 1195 + 11\n    AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n),\nsb AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM filtered_store_sales_date\n  GROUP BY ss_store_sk\n)\nSELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand\nFROM store, item, sb, filtered_store_sales_date sc\nWHERE sb.ss_store_sk = sc.ss_store_sk\n  AND sc.revenue <= 0.1 * sb.ave\n  AND s_store_sk = sc.ss_store_sk\n  AND i_item_sk = sc.ss_item_sk\n  AND i_manager_id BETWEEN 80 AND 84\n  AND s_state IN ('IA','IL','NC')\nORDER BY s_store_name, i_item_desc\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.85,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Missing SQL for tree node `store`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate the two identical store_sales+date_dim scans into a single CTE that computes both revenue per (store,item) and average revenue per store, then derive sb and sc from that CTE."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.75,
      "status": "WIN",
      "speedup": 1.61,
      "semantic_passed": true,
      "error": null,
      "original_ms": 4099.5,
      "patch_ms": 2549.5,
      "output_sql": "WITH filtered_store_sales_date AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_month_seq BETWEEN 1195 AND 1195 + 11 AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01 GROUP BY ss_store_sk, ss_item_sk), sb AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM filtered_store_sales_date GROUP BY ss_store_sk), sc AS (SELECT ss_store_sk, ss_item_sk, revenue FROM filtered_store_sales_date) SELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand FROM store, item, sb, sc WHERE sb.ss_store_sk = sc.ss_store_sk AND sc.revenue <= 0.1 * sb.ave AND s_store_sk = sc.ss_store_sk AND i_item_sk = sc.ss_item_sk AND i_manager_id BETWEEN 80 AND 84 AND s_state IN ('IA','IL','NC') ORDER BY s_store_name, i_item_desc LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered date_dim rows and pre-join with store_sales in a CTE, then compute both aggregates from the reduced set before the non-equi join (revenue <= 0.1 * ave)."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.6,
      "status": "WIN",
      "speedup": 1.85,
      "semantic_passed": true,
      "error": null,
      "original_ms": 4099.5,
      "patch_ms": 2219.9,
      "output_sql": "WITH date_dim_prefetch AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1195 AND 1195+11 AND d_date_sk IS NOT NULL), store_prefetch AS (SELECT s_store_sk, s_store_name FROM store WHERE s_state IN ('IA','IL','NC')), store_sales_prefiltered AS (SELECT ss.ss_store_sk, ss.ss_item_sk, ss.ss_sales_price FROM store_sales ss JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk), combined_aggregates AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue, AVG(SUM(ss_sales_price)) OVER (PARTITION BY ss_store_sk) AS ave FROM store_sales_prefiltered GROUP BY ss_store_sk, ss_item_sk) SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store_prefetch s JOIN item i ON i.i_manager_id BETWEEN 80 AND 84 JOIN combined_aggregates sc ON s.s_store_sk = sc.ss_store_sk AND i.i_item_sk = sc.ss_item_sk WHERE sc.revenue <= 0.1 * sc.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter store and date_dim into separate CTEs, then join with store_sales in a single pass, computing both aggregates in the same CTE using conditional aggregation."
    },
    {
      "patch_id": "p04",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column i.i_manager_id does not exist\nLINE 1: ...c.ss_store_sk AND i.i_item_sk = sc.ss_item_sk AND i.i_manage...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH shared_aggregates AS (WITH filtered_sales AS (SELECT ss_store_sk, ss_item_sk, ss_sales_price FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_month_seq BETWEEN 1195 AND 1195 + 11 AND ss.ss_sales_price / ss.ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01) SELECT fs.ss_store_sk, fs.ss_item_sk, SUM(fs.ss_sales_price) AS revenue, AVG(sa.rev_per_store) AS ave FROM filtered_sales fs JOIN (SELECT ss_store_sk, SUM(ss_sales_price) AS rev_per_store FROM filtered_sales GROUP BY ss_store_sk, ss_item_sk) sa ON fs.ss_store_sk = sa.ss_store_sk GROUP BY fs.ss_store_sk, fs.ss_item_sk), store AS (SELECT s_store_sk, s_store_name FROM store), item AS (SELECT i_item_sk, i_item_desc, i_current_price, i_wholesale_cost, i_brand FROM item) SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store s, item i, shared_aggregates sc WHERE sc.revenue <= 0.1 * sc.ave AND s.s_store_sk = sc.ss_store_sk AND i.i_item_sk = sc.ss_item_sk AND i.i_manager_id BETWEEN 80 AND 84 AND s.s_state IN ('IA','IL','NC') ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Push store and date_dim filters into CTEs, then join with store_sales once, computing both aggregates in a single pass. Use MATERIALIZED hint to prevent inlining and force early reduction."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 4.95,
      "semantic_passed": true,
      "error": null,
      "original_ms": 7192.0,
      "patch_ms": 1452.0,
      "output_sql": "WITH filtered_store_sales_date AS (\n  SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n  FROM store_sales, date_dim\n  WHERE ss_sold_date_sk = d_date_sk\n    AND d_month_seq BETWEEN 1195 AND 1195 + 11\n    AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n  GROUP BY ss_store_sk, ss_item_sk\n),\nsb AS (\n  SELECT ss_store_sk, AVG(revenue) AS ave\n  FROM filtered_store_sales_date\n  GROUP BY ss_store_sk\n)\nSELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand\nFROM store, item, sb, filtered_store_sales_date sc\nWHERE sb.ss_store_sk = sc.ss_store_sk\n  AND sc.revenue <= 0.1 * sb.ave\n  AND s_store_sk = sc.ss_store_sk\n  AND i_item_sk = sc.ss_item_sk\n  AND i_manager_id BETWEEN 80 AND 84\n  AND s_state IN ('IA','IL','NC')\nORDER BY s_store_name, i_item_desc\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 3.11,
      "semantic_passed": true,
      "error": null,
      "original_ms": 7192.0,
      "patch_ms": 2315.4,
      "output_sql": "WITH date_dim_prefetch AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1195 AND 1195 + 11\n    AND d_date_sk IS NOT NULL\n),\nstore_prefetch AS (\n  SELECT s_store_sk, s_store_name\n  FROM store\n  WHERE s_state IN ('IA','IL','NC')\n),\nstore_sales_prefiltered AS (\n  SELECT ss.ss_store_sk, ss.ss_item_sk, ss.ss_sales_price\n  FROM store_sales ss\n  JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk\n  WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01\n),\ncombined_aggregates AS (\n  SELECT\n    ss_store_sk,\n    ss_item_sk,\n    SUM(ss_sales_price) AS revenue,\n    AVG(SUM(ss_sales_price)) OVER (PARTITION BY ss_store_sk) AS ave\n  FROM store_sales_prefiltered\n  GROUP BY ss_store_sk, ss_item_sk\n)\nSELECT\n  s.s_store_name,\n  i.i_item_desc,\n  sc.revenue,\n  i.i_current_price,\n  i.i_wholesale_cost,\n  i.i_brand\nFROM store_prefetch s\nJOIN item i ON i.i_manager_id BETWEEN 80 AND 84\nJOIN combined_aggregates sc\n  ON s.s_store_sk = sc.ss_store_sk\n AND i.i_item_sk = sc.ss_item_sk\nWHERE sc.revenue <= 0.1 * sc.ave\nORDER BY s.s_store_name, i.i_item_desc\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 3.62,
      "semantic_passed": true,
      "error": null,
      "original_ms": 7192.0,
      "patch_ms": 1985.9,
      "output_sql": "WITH filtered_store_sales_date AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND d_month_seq BETWEEN 1195 AND 1195+11 AND ss_sales_price / ss_list_price BETWEEN 38 * 0.01 AND 48 * 0.01 GROUP BY ss_store_sk, ss_item_sk), sb AS (SELECT ss_store_sk, AVG(revenue) AS ave FROM filtered_store_sales_date GROUP BY ss_store_sk), sc AS (SELECT ss_store_sk, ss_item_sk, revenue FROM filtered_store_sales_date) SELECT s_store_name, i_item_desc, sc.revenue, i_current_price, i_wholesale_cost, i_brand FROM store, item, sb, sc WHERE sb.ss_store_sk = sc.ss_store_sk AND sc.revenue <= 0.1 * sb.ave AND s_store_sk = sc.ss_store_sk AND i_item_sk = sc.ss_item_sk AND i_manager_id BETWEEN 80 AND 84 AND s_state IN ('IA','IL','NC') ORDER BY s_store_name, i_item_desc LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.25,
      "semantic_passed": true,
      "error": null,
      "original_ms": 7192.0,
      "patch_ms": 5731.4,
      "output_sql": "WITH date_dim_prefetch AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1195 AND 1195+11 AND d_date_sk IS NOT NULL), store_prefetch AS (SELECT s_store_sk, s_store_name FROM store WHERE s_state IN ('IA','IL','NC')), store_sales_prefiltered AS (SELECT ss.ss_store_sk, ss.ss_item_sk, ss.ss_sales_price FROM store_sales ss JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk), combined_aggregates AS (SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue, AVG(SUM(ss_sales_price)) OVER (PARTITION BY ss_store_sk) AS ave FROM store_sales_prefiltered GROUP BY ss_store_sk, ss_item_sk) SELECT s.s_store_name, i.i_item_desc, sc.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand FROM store_prefetch s JOIN item i ON i.i_manager_id BETWEEN 80 AND 84 JOIN combined_aggregates sc ON s.s_store_sk = sc.ss_store_sk AND i.i_item_sk = sc.ss_item_sk WHERE sc.revenue <= 0.1 * sc.ave ORDER BY s.s_store_name, i.i_item_desc LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "Limit  (rows=0, time=1508.417)\n  Aggregate  (rows=168630, time=1437.809)\n    Gather Merge  (rows=184381, time=1350.371)\n      Aggregate  (rows=92190, time=1251.128)\n        Sort  (rows=218923, time=1189.713)\n          Nested Loop  (rows=218923, time=1043.479)\n            Index Only Scan on date_dim  (rows=183, time=2.659)\n            Index Only Scan on store_sales  (rows=1196, time=5.595)\n  Sort  (rows=0, time=1505.925)\n    Nested Loop  (rows=0, time=1505.885)\n      Hash Join  (rows=0, time=1505",
    "p03": "Limit  (rows=0, time=2859.781)\n  Sort  (rows=0, time=2859.774)\n    Nested Loop  (rows=0, time=2859.666)\n      Merge Join  (rows=0, time=2859.661)\n        Subquery Scan (sc)  (rows=112265, time=2854.974)\n          WindowAgg  (rows=467378, time=2788.156)\n            Aggregate  (rows=507333, time=2600.013)\n              Gather Merge  (rows=606384, time=2293.787)\n                Aggregate  (rows=303476, time=2051.284)\n                  Sort  (rows=744756, time=1840.177)\n                    Nested Lo",
    "compile_p1": "Limit  (rows=0, time=1517.574)\n  Aggregate  (rows=168630, time=1451.453)\n    Gather Merge  (rows=184381, time=1363.768)\n      Aggregate  (rows=92190, time=1247.426)\n        Sort  (rows=218923, time=1185.165)\n          Nested Loop  (rows=218923, time=1046.055)\n            Index Only Scan on date_dim  (rows=183, time=2.281)\n            Index Only Scan on store_sales  (rows=1196, time=5.611)\n  Sort  (rows=0, time=1515.298)\n    Nested Loop  (rows=0, time=1515.248)\n      Hash Join  (rows=0, time=1515",
    "compile_p2": "Limit  (rows=0, time=6061.309)\n  Sort  (rows=0, time=6061.305)\n    Nested Loop  (rows=0, time=6061.284)\n      Merge Join  (rows=0, time=6061.28)\n        Subquery Scan (sc)  (rows=112265, time=6057.024)\n          WindowAgg  (rows=467378, time=5996.675)\n            Aggregate  (rows=507333, time=5826.18)\n              Gather Merge  (rows=606384, time=5524.889)\n                Aggregate  (rows=303456, time=1713.857)\n                  Sort  (rows=744734, time=1513.358)\n                    Nested Loop"
  }
}