{
  "probe_id": "p02",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering date_dim and customer into reusable CTEs reduces repeated scans and enables explicit joins with better cardinality estimates.",
  "reasoning_trace": [
    "Three channel queries repeat identical filters on date_dim and customer; materializing once improves efficiency.",
    "Comma joins are converted to explicit JOIN syntax to enable better optimization and predicate pushdown.",
    "Dimension CTEs are reused across all three channels, avoiding duplication and reducing total scan cost."
  ],
  "target_ir": "date_dim and customer filtered into CTEs; each fact table joined explicitly with these CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["channel_1", "channel_2", "channel_3"],
        "outputs": ["count(*)"],
        "changed": true,
        "sql": "SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_1 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_2 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM channel_3) hot_cust LIMIT 100"
      },
      {
        "node_id": "channel_1",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "filtered_date_dim", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales ss JOIN filtered_date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 241 AND 300 AND ss.ss_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "channel_2",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "filtered_date_dim", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 241 AND 300 AND cs.cs_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "channel_3",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "filtered_date_dim", "filtered_customer"],
        "outputs": ["c_last_name", "c_first_name", "d_date"],
        "changed": true,
        "sql": "SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales ws JOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN filtered_customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 241 AND 300 AND ws.ws_wholesale_cost BETWEEN 76 AND 96"
      },
      {
        "node_id": "filtered_date_dim",
        "parent_node_id": "channel_1",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1218"
      },
      {
        "node_id": "filtered_customer",
        "parent_node_id": "channel_1",
        "sources": ["customer"],
        "outputs": ["c_customer_sk", "c_last_name", "c_first_name"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_month IN (2, 3, 4, 10)"
      }
    ]
  }
}