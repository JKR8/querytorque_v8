{
  "iteration": 0,
  "n_api_calls": 7,
  "beam_cost_usd": 0.03902418,
  "beam_cost_priced_calls": 7,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 101243,
    "completion_tokens": 15065,
    "total_tokens": 116308,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 45696,
    "reasoning_tokens": 7201
  },
  "best_speedup": 1.19,
  "best_patch_id": "compile_nochange",
  "best_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.8,
      "semantic_passed": true,
      "error": null,
      "original_ms": 57.6,
      "patch_ms": 71.9,
      "output_sql": "WITH my_customers AS (with filtered_date_dim as (select d_date_sk from date_dim where d_moy = 1 and d_year = 1998) select distinct c.c_customer_sk, c.c_current_addr_sk from (select cs_sold_date_sk as sold_date_sk, cs_bill_customer_sk as customer_sk, cs_item_sk as item_sk, cs_wholesale_cost as wholesale_cost from catalog_sales union all select ws_sold_date_sk as sold_date_sk, ws_bill_customer_sk as customer_sk, ws_item_sk as item_sk, ws_wholesale_cost as wholesale_cost from web_sales) cs_or_ws_sales inner join filtered_date_dim d on cs_or_ws_sales.sold_date_sk = d.d_date_sk inner join item i on cs_or_ws_sales.item_sk = i.i_item_sk inner join customer c on cs_or_ws_sales.customer_sk = c.c_customer_sk where i.i_category = 'Electronics' and i.i_class = 'personal' and cs_or_ws_sales.wholesale_cost between 35 and 65 and c.c_birth_year between 1928 and 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins in my_customers CTE to explicit INNER JOIN syntax and pre-filter date_dim (d_moy=1, d_year=1998) into a tiny CTE to create a small hash table for fact probes."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.78,
      "status": "REGRESSION",
      "speedup": 0.8,
      "semantic_passed": true,
      "error": null,
      "original_ms": 57.6,
      "patch_ms": 72.0,
      "output_sql": "WITH item_prefetch AS (SELECT i_item_sk FROM item WHERE i_category = 'Electronics' AND i_class = 'personal'), date_dim_prefetch AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998), customer_prefetch AS (SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_year BETWEEN 1928 AND 1941), my_customers AS (WITH item_prefetch AS (SELECT i_item_sk FROM item WHERE i_category = 'Electronics' AND i_class = 'personal'), date_dim_prefetch AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 1 AND d_year = 1998), customer_prefetch AS (SELECT c_customer_sk, c_current_addr_sk FROM customer WHERE c_birth_year BETWEEN 1928 AND 1941) SELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales JOIN item_prefetch i ON cs_or_ws_sales.item_sk = i.i_item_sk JOIN date_dim_prefetch d ON cs_or_ws_sales.sold_date_sk = d.d_date_sk JOIN customer_prefetch c ON c.c_customer_sk = cs_or_ws_sales.customer_sk WHERE cs_or_ws_sales.wholesale_cost BETWEEN 35 AND 65), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, item, customer) into separate CTEs before joining with the UNION of fact tables, using explicit JOIN syntax."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.8,
      "semantic_passed": true,
      "error": null,
      "original_ms": 57.6,
      "patch_ms": 72.0,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), store_sales_prefilter AS (SELECT ss_customer_sk, ss_ext_sales_price, ss_sold_date_sk FROM store_sales, date_dim WHERE ss_sold_date_sk = d_date_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1)), my_revenue AS (SELECT c_customer_sk, sum(ss_ext_sales_price) AS revenue FROM my_customers, store_sales_prefilter, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push store_sales filter (ss_wholesale_cost BETWEEN 35 AND 65) and date range filter into a pre-filtered CTE before joining with my_customers and other dimensions in my_revenue CTE."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.55,
      "status": "REGRESSION",
      "speedup": 0.81,
      "semantic_passed": true,
      "error": null,
      "original_ms": 57.6,
      "patch_ms": 71.5,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), date_bounds AS (select distinct d_month_seq+1 as low_seq, d_month_seq+3 as high_seq\nfrom date_dim\nwhere d_year = 1998 and d_moy = 1), my_revenue AS (select c_customer_sk,\n       sum(ss_ext_sales_price) as revenue\nfrom   my_customers,\n       store_sales,\n       customer_address,\n       store,\n       date_bounds,\n       date_dim\nwhere  c_current_addr_sk = ca_address_sk\n       and ca_county = s_county\n       and ca_state = s_state\n       and ss_sold_date_sk = d_date_sk\n       and c_customer_sk = ss_customer_sk\n       and ss_wholesale_cost BETWEEN 35 AND 65\n       and s_state in ('AR','CO','IA'\n                   ,'IL','KY','NC'\n                   ,'NM','NY','PA'\n                   ,'TX')\n       and d_month_seq between date_bounds.low_seq and date_bounds.high_seq\ngroup by c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize the two identical scalar subqueries on date_dim (d_month_seq+1 and d_month_seq+3) into a single CTE to avoid duplicate index-only scans."
    },
    {
      "patch_id": "compile_nochange",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.19,
      "semantic_passed": true,
      "error": null,
      "original_ms": 37.4,
      "patch_ms": 31.6,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c_customer_sk, c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) AS cs_or_ws_sales, item, date_dim, customer WHERE sold_date_sk = d_date_sk AND item_sk = i_item_sk AND i_category = 'Electronics' AND i_class = 'personal' AND c_customer_sk = cs_or_ws_sales.customer_sk AND d_moy = 1 AND d_year = 1998 AND wholesale_cost BETWEEN 35 AND 65 AND c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers, store_sales, customer_address, store, date_dim WHERE c_current_addr_sk = ca_address_sk AND ca_county = s_county AND ca_state = s_state AND ss_sold_date_sk = d_date_sk AND c_customer_sk = ss_customer_sk AND ss_wholesale_cost BETWEEN 35 AND 65 AND s_state IN ('AR', 'CO', 'IA', 'IL', 'KY', 'NC', 'NM', 'NY', 'PA', 'TX') AND d_month_seq BETWEEN (SELECT DISTINCT d_month_seq + 1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq + 3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_explicit_join",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.17,
      "semantic_passed": true,
      "error": null,
      "original_ms": 37.4,
      "patch_ms": 32.0,
      "output_sql": "WITH my_customers AS (SELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales INNER JOIN date_dim d ON cs_or_ws_sales.sold_date_sk = d.d_date_sk INNER JOIN item i ON cs_or_ws_sales.item_sk = i.i_item_sk INNER JOIN customer c ON cs_or_ws_sales.customer_sk = c.c_customer_sk WHERE i.i_category = 'Electronics' AND i.i_class = 'personal' AND d.d_moy = 1 AND d.d_year = 1998 AND cs_or_ws_sales.wholesale_cost BETWEEN 35 AND 65 AND c.c_birth_year BETWEEN 1928 AND 1941), my_revenue AS (SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk INNER JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk INNER JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk WHERE store_sales.ss_wholesale_cost BETWEEN 35 AND 65 AND store.s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND date_dim.d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk), segments AS (SELECT CAST((revenue / 50) AS INT) AS segment FROM my_revenue) SELECT segment, COUNT(*) AS num_customers, segment * 50 AS segment_base FROM segments GROUP BY segment ORDER BY segment, num_customers LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=0, time=68.926)\n  Sort  (rows=0, time=68.924)\n    Aggregate  (rows=0, time=68.906)\n      Sort  (rows=0, time=68.904)\n        Subquery Scan (my_revenue)  (rows=0, time=68.894)\n          Aggregate  (rows=0, time=68.893)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows=0, t",
    "p02": "Limit  (rows=0, time=63.354)\n  Sort  (rows=0, time=63.352)\n    Aggregate  (rows=0, time=63.337)\n      Sort  (rows=0, time=63.336)\n        Subquery Scan (my_revenue)  (rows=0, time=63.332)\n          Aggregate  (rows=0, time=63.331)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows=0, t",
    "p03": "Limit  (rows=0, time=68.082)\n  Sort  (rows=0, time=68.08)\n    Aggregate  (rows=0, time=68.065)\n      Sort  (rows=0, time=68.063)\n        Subquery Scan (my_revenue)  (rows=0, time=68.002)\n          Aggregate  (rows=0, time=68.0)\n            Aggregate  (rows=1, time=0.045)\n              Index Only Scan on date_dim (date_dim_3)  (rows=31, time=0.037)\n            Aggregate  (rows=1, time=0.024)\n              Index Only Scan on date_dim (date_dim_4)  (rows=31, time=0.017)\n            Aggregate  (rows",
    "p04": "Limit  (rows=0, time=64.656)\n  Sort  (rows=0, time=64.654)\n    Aggregate  (rows=0, time=64.639)\n      Sort  (rows=0, time=64.638)\n        Subquery Scan (my_revenue)  (rows=0, time=64.634)\n          Aggregate  (rows=0, time=64.633)\n            Nested Loop  (rows=0, time=64.632)\n              Nested Loop  (rows=0, time=64.631)\n                Nested Loop  (rows=0, time=64.63)\n                  Nested Loop  (rows=0, time=64.627)\n                    Nested Loop  (rows=69, time=64.49)\n               ",
    "compile_nochange": "Limit  (rows=0, time=38.275)\n  Sort  (rows=0, time=38.273)\n    Aggregate  (rows=0, time=38.261)\n      Sort  (rows=0, time=38.26)\n        Subquery Scan (my_revenue)  (rows=0, time=38.255)\n          Aggregate  (rows=0, time=38.255)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_3)  (rows=0, time=0.0)\n            Nested Loop  (rows=0, ti",
    "compile_explicit_join": "Limit  (rows=0, time=38.141)\n  Sort  (rows=0, time=38.139)\n    Aggregate  (rows=0, time=38.123)\n      Sort  (rows=0, time=38.122)\n        Subquery Scan (my_revenue)  (rows=0, time=38.118)\n          Aggregate  (rows=0, time=38.117)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_1)  (rows=0, time=0.0)\n            Aggregate  (rows=0, time=0.0)\n              Index Only Scan on date_dim (date_dim_2)  (rows=0, time=0.0)\n            Nested Loop  (rows=0, t"
  }
}