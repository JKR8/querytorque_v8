[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p03",
    "strategy": "Decorrelation via pre‑filtered sales CTEs, explicit joins, preserve EXISTS semantics with LEFT JOIN + OR guard.",
    "hypothesis": "Probe p03 (1.07x) showed decorrelation works; we keep its shape but fix the comma‑join and ensure the OR condition is correctly guarded. Residual gap: the store_sales branch (3.3s) remains the largest hotspot; we address it by pushing date_dim/item filters into each sales CTE.",
    "expected_explain_delta": "Nested‑loop correlation operators disappear; three separate index scans on date_dim/item become one per channel; explicit join order may improve cardinality estimates.",
    "target_ir": "Add store_customers, web_customers, catalog_customers nodes; rewrite final_select with explicit INNER/LEFT JOINs and OR guard.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_customers", "web_customers", "catalog_customers", "customer", "customer_address", "customer_demographics"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
          "changed": true,
          "sql": "SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, COUNT(*) cnt1, cd.cd_purchase_estimate, COUNT(*) cnt2, cd.cd_credit_rating, COUNT(*) cnt3, cd.cd_dep_count, COUNT(*) cnt4, cd.cd_dep_employed_count, COUNT(*) cnt5, cd.cd_dep_college_count, COUNT(*) cnt6 FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_customers sc ON c.c_customer_sk = sc.ss_customer_sk LEFT JOIN web_customers wc ON c.c_customer_sk = wc.ws_bill_customer_sk LEFT JOIN catalog_customers cc ON c.c_customer_sk = cc.cs_ship_customer_sk WHERE ca.ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County') AND c.c_birth_month IN (4, 5) AND cd.cd_marital_status IN ('U', 'S', 'U') AND cd.cd_education_status IN ('College', 'Secondary', 'College') AND cd.cd_gender = 'M' AND (wc.ws_bill_customer_sk IS NOT NULL OR cc.cs_ship_customer_sk IS NOT NULL) GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count ORDER BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count LIMIT 100"
        },
        {
          "node_id": "store_customers",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "item"],
          "outputs": ["ss_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 5 AND 8 AND i.i_category IN ('Children', 'Home', 'Women') AND i.i_manager_id BETWEEN 91 AND 100 AND ss.ss_sales_price / ss.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
        },
        {
          "node_id": "web_customers",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "item"],
          "outputs": ["ws_bill_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ws.ws_bill_customer_sk FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 5 AND 8 AND i.i_category IN ('Children', 'Home', 'Women') AND i.i_manager_id BETWEEN 91 AND 100 AND ws.ws_sales_price / ws.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
        },
        {
          "node_id": "catalog_customers",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_dim", "item"],
          "outputs": ["cs_ship_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT cs.cs_ship_customer_sk FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE d.d_year = 1999 AND d.d_moy BETWEEN 5 AND 8 AND i.i_category IN ('Children', 'Home', 'Women') AND i.i_manager_id BETWEEN 91 AND 100 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
        }
      ]
    }
  }
]