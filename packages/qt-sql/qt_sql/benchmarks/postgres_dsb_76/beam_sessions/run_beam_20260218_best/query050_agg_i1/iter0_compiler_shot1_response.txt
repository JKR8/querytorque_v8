{
  "plan_id": "compile_p1",
  "dialect": "postgres",
  "confidence": 0.7,
  "based_on": "p01",
  "strategy": "Pre-join date dimensions on non-equi condition before fact join to eliminate late correlated nested loop and enable better join reordering.",
  "hypothesis": "Probes targeting comma-join and non-equi join blindness failed due to semantic drift (p01) or regression (p02,p03). The largest hotspot is the late nested-loop join with date_dim d1 after sort/gather. Pre-joining d1 and d2 on the date range condition, then joining to facts ensures correctness and may allow earlier reduction.",
  "expected_explain_delta": "Eliminate correlated nested loop with d1; replace with hash join on pre-joined date pairs; reduce rows before sort and gather merge.",
  "target_ir": "Replace comma joins with explicit joins; introduce d1_d2 CTE that joins date dimensions on range condition; join facts to CTE on both date keys.",
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "store_returns", "store", "d1_d2"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "WITH d2_filtered AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_year = 2000 AND d_moy = 8\n),\nd1_d2 AS (\n  SELECT d1.d_date_sk AS d1_date_sk,\n         d1.d_date AS d1_date,\n         d2.d_date_sk AS d2_date_sk,\n         d2.d_date AS d2_date\n  FROM date_dim d1\n  JOIN d2_filtered d2 ON d1.d_date BETWEEN (d2.d_date - INTERVAL '120 day') AND d2.d_date\n)\nSELECT \n   s_store_name\n  ,s_company_id\n  ,s_street_number\n  ,s_street_name\n  ,s_street_type\n  ,s_suite_number\n  ,s_city\n  ,s_county\n  ,s_state\n  ,s_zip\n  ,sum(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\"\n  ,sum(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 30 AND sr_returned_date_sk - ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\"\n  ,sum(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 60 AND sr_returned_date_sk - ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\"\n  ,sum(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 90 AND sr_returned_date_sk - ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\"\n  ,sum(CASE WHEN (sr_returned_date_sk - ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\"\nFROM store_sales\nJOIN store_returns ON ss_ticket_number = sr_ticket_number\n                   AND ss_item_sk = sr_item_sk\n                   AND ss_customer_sk = sr_customer_sk\nJOIN store ON ss_store_sk = s_store_sk\nJOIN d1_d2 ON ss_sold_date_sk = d1_d2.d1_date_sk\n          AND sr_returned_date_sk = d1_d2.d2_date_sk\nGROUP BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip\nORDER BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip\nLIMIT 100;"
      }
    ]
  }
}