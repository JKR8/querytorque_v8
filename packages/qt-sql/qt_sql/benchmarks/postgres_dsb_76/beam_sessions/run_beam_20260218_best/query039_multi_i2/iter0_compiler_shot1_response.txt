[
  {
    "plan_id": "compile_q1",
    "dialect": "postgres",
    "hypothesis": "Push d_moy filter into CTE to reduce groups materialized from 12 to 2, rewrite comma joins to explicit joins to improve join order flexibility, and move aggregate filter to HAVING to avoid extra subquery. This addresses CTE materialization fence and reduces nested‑loop input rows.",
    "target_ir": "Update inv node to filter d_moy IN (5,6) and use explicit joins; final_select unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": false
        },
        {
          "node_id": "inv",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "WITH inv AS (\n  SELECT\n    w.w_warehouse_name,\n    w.w_warehouse_sk,\n    i.i_item_sk,\n    d.d_moy,\n    stddev_samp(inv.inv_quantity_on_hand) AS stdev,\n    avg(inv.inv_quantity_on_hand) AS mean,\n    CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN NULL ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END AS cov\n  FROM inventory inv\n  JOIN item i ON inv.inv_item_sk = i.i_item_sk\n  JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n  JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n  WHERE d.d_year = 2002\n    AND i.i_category IN ('Shoes', 'Sports')\n    AND i.i_manager_id BETWEEN 42 AND 61\n    AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n    AND d.d_moy IN (5, 6)\n  GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n  HAVING CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN 0 ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END > 1\n)\nSELECT\n  inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n  inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov\nFROM inv inv1, inv inv2\nWHERE inv1.i_item_sk = inv2.i_item_sk\n  AND inv1.w_warehouse_sk = inv2.w_warehouse_sk\n  AND inv1.d_moy = 5\n  AND inv2.d_moy = 6\nORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n         inv2.d_moy, inv2.mean, inv2.cov"
        }
      ]
    },
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Self‑join decomposition with explicit joins and early d_moy filter.",
    "expected_explain_delta": "CTE scan rows drop from 187K to ~2 groups; nested‑loop join filter eliminated; parallel seq scan on inventory unchanged."
  },
  {
    "plan_id": "compile_q2",
    "dialect": "postgres",
    "hypothesis": "Same as first query rewrite, but add the extra condition inv1.cov > 1.5 in the final select. This preserves the full semantic contract for the second query.",
    "target_ir": "Update inv node as in compile_q1, and update final_select to include the extra condition.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": true,
          "sql": "WITH inv AS (\n  SELECT\n    w.w_warehouse_name,\n    w.w_warehouse_sk,\n    i.i_item_sk,\n    d.d_moy,\n    stddev_samp(inv.inv_quantity_on_hand) AS stdev,\n    avg(inv.inv_quantity_on_hand) AS mean,\n    CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN NULL ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END AS cov\n  FROM inventory inv\n  JOIN item i ON inv.inv_item_sk = i.i_item_sk\n  JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n  JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n  WHERE d.d_year = 2002\n    AND i.i_category IN ('Shoes', 'Sports')\n    AND i.i_manager_id BETWEEN 42 AND 61\n    AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n    AND d.d_moy IN (5, 6)\n  GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n  HAVING CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN 0 ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END > 1\n)\nSELECT\n  inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n  inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov\nFROM inv inv1, inv inv2\nWHERE inv1.i_item_sk = inv2.i_item_sk\n  AND inv1.w_warehouse_sk = inv2.w_warehouse_sk\n  AND inv1.d_moy = 5\n  AND inv2.d_moy = 6\n  AND inv1.cov > 1.5\nORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n         inv2.d_moy, inv2.mean, inv2.cov"
        },
        {
          "node_id": "inv",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": false
        }
      ]
    },
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Self‑join decomposition with explicit joins and early d_moy filter, plus extra cov filter.",
    "expected_explain_delta": "CTE scan rows drop from 187K to ~2 groups; nested‑loop join filter eliminated; parallel seq scan on inventory unchanged."
  }
]