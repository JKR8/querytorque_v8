[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Push d_moy filters into CTE definitions to avoid full materialization and use explicit joins for better join ordering.",
    "hypothesis": "Probes p01 and p02 identified CTE materialization fence and comma-join weakness. Self-join decomposition pushes month filters early, eliminating 187K group materialization before filtering. Explicit joins replace comma joins to let optimizer reorder.",
    "expected_explain_delta": "CTE materialization eliminated, nested loop removed, hash join with pre-filtered rows, zero rows early.",
    "target_ir": "Replace single CTE with two specialized CTEs (inv5, inv6) containing month filters, rewrite final join as explicit INNER JOIN.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv5", "inv6"],
          "outputs": ["inv1.w_warehouse_sk", "inv1.i_item_sk", "inv1.d_moy", "inv1.mean", "inv1.cov", "inv2.w_warehouse_sk", "inv2.i_item_sk", "inv2.d_moy", "inv2.mean", "inv2.cov"],
          "changed": true,
          "sql": "SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv5 inv1 INNER JOIN inv6 inv2 ON inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov"
        },
        {
          "node_id": "inv5",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END cov FROM (SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy, stddev_samp(inv.inv_quantity_on_hand) stdev, avg(inv.inv_quantity_on_hand) mean FROM inventory inv JOIN item i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND i.i_category IN ('Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 61 AND inv.inv_quantity_on_hand BETWEEN 791 AND 991 AND d.d_moy = 5 GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        },
        {
          "node_id": "inv6",
          "parent_node_id": "final_select",
          "sources": ["inventory", "item", "warehouse", "date_dim"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev/mean END cov FROM (SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy, stddev_samp(inv.inv_quantity_on_hand) stdev, avg(inv.inv_quantity_on_hand) mean FROM inventory inv JOIN item i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND i.i_category IN ('Shoes', 'Sports') AND i.i_manager_id BETWEEN 42 AND 61 AND inv.inv_quantity_on_hand BETWEEN 791 AND 991 AND d.d_moy = 6 GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p02",
    "strategy": "Dimension prefetch with explicit joins to reduce nested loop and enable predicate pushdown.",
    "hypothesis": "Probe p02 failed due to column reference error (d_moy missing from CTE). Fix by including all required columns in dimension CTEs and using explicit joins. This allows warehouse join to happen early and reduces inventory scan via better join order.",
    "expected_explain_delta": "Nested loop replaced by hash joins, warehouse filter applied early, reduced rows to inventory join.",
    "target_ir": "Replace comma joins with explicit JOINs, pre-filter dimensions into CTEs, join with inventory.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["inv"],
          "outputs": ["w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov", "w_warehouse_sk", "i_item_sk", "d_moy", "mean", "cov"],
          "changed": true,
          "sql": "SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM inv inv1, inv inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 6 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov"
        },
        {
          "node_id": "inv",
          "parent_node_id": "final_select",
          "sources": ["date_dim_cte", "item_cte", "warehouse_cte", "inventory"],
          "outputs": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"],
          "changed": true,
          "sql": "WITH date_dim_cte AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002), item_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61), warehouse_cte AS (SELECT w_warehouse_sk, w_warehouse_name FROM warehouse) SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy, stddev_samp(inv.inv_quantity_on_hand) AS stdev, avg(inv.inv_quantity_on_hand) AS mean, CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN NULL ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END AS cov FROM inventory inv JOIN item_cte i ON inv.inv_item_sk = i.i_item_sk JOIN warehouse_cte w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim_cte d ON inv.inv_date_sk = d.d_date_sk WHERE inv.inv_quantity_on_hand BETWEEN 791 AND 991 GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy HAVING CASE avg(inv.inv_quantity_on_hand) WHEN 0 THEN 0 ELSE stddev_samp(inv.inv_quantity_on_hand) / avg(inv.inv_quantity_on_hand) END > 1"
        },
        {
          "node_id": "date_dim_cte",
          "parent_node_id": "inv",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_moy"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2002"
        },
        {
          "node_id": "item_cte",
          "parent_node_id": "inv",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61"
        },
        {
          "node_id": "warehouse_cte",
          "parent_node_id": "inv",
          "sources": ["warehouse"],
          "outputs": ["w_warehouse_sk", "w_warehouse_name"],
          "changed": true,
          "sql": "SELECT w_warehouse_sk, w_warehouse_name FROM warehouse"
        }
      ]
    }
  }
]