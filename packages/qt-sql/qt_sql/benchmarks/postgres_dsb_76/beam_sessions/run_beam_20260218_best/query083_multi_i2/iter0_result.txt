{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.02708683,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 110253,
    "completion_tokens": 15459,
    "total_tokens": 125712,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 41280,
    "reasoning_tokens": 6311
  },
  "best_speedup": 7.93,
  "best_patch_id": "p01",
  "best_sql": "WITH date_keys AS (SELECT d_date_sk FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')), sr_items AS (SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns JOIN item ON sr_item_sk = i_item_sk JOIN date_keys ON sr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), cr_items AS (SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns JOIN item ON cr_item_sk = i_item_sk JOIN date_keys ON cr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns JOIN item ON wr_item_sk = i_item_sk JOIN date_keys ON wr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "shared_dimension_multi_channel",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 7.93,
      "semantic_passed": true,
      "error": null,
      "original_ms": 273.2,
      "patch_ms": 34.4,
      "output_sql": "WITH date_keys AS (SELECT d_date_sk FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')), sr_items AS (SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns JOIN item ON sr_item_sk = i_item_sk JOIN date_keys ON sr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), cr_items AS (SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns JOIN item ON cr_item_sk = i_item_sk JOIN date_keys ON cr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns JOIN item ON wr_item_sk = i_item_sk JOIN date_keys ON wr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Extract identical two-level date_dim subquery into a single shared CTE (date_keys) returning d_date_sk for the four target dates, then join store_returns and catalog_returns with date_keys CTE via d_date_sk."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.8,
      "status": "REGRESSION",
      "speedup": 0.62,
      "semantic_passed": true,
      "error": null,
      "original_ms": 273.2,
      "patch_ms": 438.3,
      "output_sql": "WITH wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns, item, date_dim WHERE wr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10', '1999-06-17', '1999-08-04', '1999-11-05'))) AND wr_returned_date_sk = d_date_sk AND i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), date_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')))), sr_items AS (SELECT i.i_item_id AS item_id, SUM(sr.sr_return_quantity) AS sr_item_qty FROM store_returns sr INNER JOIN item i ON sr.sr_item_sk = i.i_item_sk INNER JOIN date_filtered d ON sr.sr_returned_date_sk = d.d_date_sk WHERE i.i_category IN ('Children', 'Electronics') AND i.i_manager_id BETWEEN 15 AND 24 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 253 AND 282 AND sr.sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i.i_item_id), cr_items AS (SELECT i.i_item_id AS item_id, SUM(cr.cr_return_quantity) AS cr_item_qty FROM catalog_returns cr INNER JOIN item i ON cr.cr_item_sk = i.i_item_sk INNER JOIN date_filtered d ON cr.cr_returned_date_sk = d.d_date_sk WHERE i.i_category IN ('Children', 'Electronics') AND i.i_manager_id BETWEEN 15 AND 24 AND cr.cr_return_amount / cr.cr_return_quantity BETWEEN 253 AND 282 AND cr.cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i.i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins in sr_items and cr_items CTEs to explicit INNER JOIN syntax, and pre-filter date_dim via CTE (date_filtered) to create tiny hash table for join."
    },
    {
      "patch_id": "p03",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.65,
      "status": "REGRESSION",
      "speedup": 0.53,
      "semantic_passed": true,
      "error": null,
      "original_ms": 273.2,
      "patch_ms": 511.2,
      "output_sql": "WITH sr_items AS (SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns JOIN item ON sr_item_sk = i_item_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) AND sr_returned_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')))) GROUP BY i_item_id), cr_items AS (SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns, item, date_dim WHERE cr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10', '1999-06-17', '1999-08-04', '1999-11-05'))) AND cr_returned_date_sk = d_date_sk AND i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns, item, date_dim WHERE wr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10', '1999-06-17', '1999-08-04', '1999-11-05'))) AND wr_returned_date_sk = d_date_sk AND i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate store_returns by i_item_sk (and date_sk) after applying fact-level filters (ratio, reason_sk) before joining with item and date_dim."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.6,
      "status": "REGRESSION",
      "speedup": 0.63,
      "semantic_passed": true,
      "error": null,
      "original_ms": 273.2,
      "patch_ms": 436.4,
      "output_sql": "WITH item_filtered AS (select i_item_sk, i_item_id from item where i_category IN ('Children', 'Electronics') and i_manager_id BETWEEN 15 and 24), date_filtered2 AS (select d_date_sk, d_date from date_dim where d_date in (select d_date from date_dim where d_month_seq in (select d_month_seq from date_dim where d_date in ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')))), sr_items AS (select i_item_id item_id, sum(sr_return_quantity) sr_item_qty from store_returns sr join item_filtered i on sr.sr_item_sk = i.i_item_sk join date_filtered2 d on sr.sr_returned_date_sk = d.d_date_sk where sr.sr_return_amt / sr.sr_return_quantity between 253 and 282 and sr.sr_reason_sk in (7, 18, 19, 22, 36) group by i_item_id), cr_items AS (select i_item_id item_id, sum(cr_return_quantity) cr_item_qty from catalog_returns cr join item_filtered i on cr.cr_item_sk = i.i_item_sk join date_filtered2 d on cr.cr_returned_date_sk = d.d_date_sk where cr.cr_return_amount / cr.cr_return_quantity between 253 and 282 and cr.cr_reason_sk in (7, 18, 19, 22, 36) group by i_item_id), wr_items AS (select i_item_id item_id, sum(wr_return_quantity) wr_item_qty from web_returns wr join item_filtered i on wr.wr_item_sk = i.i_item_sk join date_filtered2 d on wr.wr_returned_date_sk = d.d_date_sk where wr.wr_return_amt / wr.wr_return_quantity between 253 and 282 and wr.wr_reason_sk in (7, 18, 19, 22, 36) group by i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter item table by category and manager_id into a CTE (item_filtered), and pre-filter date_dim via subquery into CTE (date_filtered2), then join both CTEs with store_returns and catalog_returns in separate steps."
    },
    {
      "patch_id": "compile_p01_based",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.74,
      "semantic_passed": true,
      "error": null,
      "original_ms": 344.0,
      "patch_ms": 466.2,
      "output_sql": "WITH date_keys AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05'))), sr_items AS (SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns JOIN item ON sr_item_sk = i_item_sk JOIN date_keys ON sr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), cr_items AS (SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns JOIN item ON cr_item_sk = i_item_sk JOIN date_keys ON cr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id), wr_items AS (SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns JOIN item ON wr_item_sk = i_item_sk JOIN date_keys ON wr_returned_date_sk = date_keys.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id) SELECT sr_items.item_id, sr_item_qty, sr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty / (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 * 100 AS wr_dev, (sr_item_qty + cr_item_qty + wr_item_qty) / 3.0 AS average FROM sr_items, cr_items, wr_items WHERE sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=0, time=37.06)\n  Seq Scan on date_dim  (rows=4, time=6.304)\n  Sort  (rows=0, time=37.058)\n    Nested Loop  (rows=0, time=37.04)\n      Nested Loop  (rows=0, time=37.038)\n        Aggregate  (rows=0, time=37.035)\n          Sort  (rows=0, time=37.033)\n            Nested Loop  (rows=0, time=37.028)\n              Nested Loop  (rows=1, time=37.009)\n                CTE Scan (date_keys)  (rows=4, time=6.313)\n                Index Scan on store_returns  (rows=0, time=7.672)\n              Inde",
    "p02": "Limit  (rows=0, time=280.631)\n  Hash Join  (rows=122, time=12.498)\n    Seq Scan on date_dim (date_dim_3)  (rows=73049, time=5.668)\n    Hash  (rows=122, time=3.945)\n      Nested Loop  (rows=122, time=3.933)\n        Aggregate  (rows=4, time=3.901)\n          Index Only Scan on date_dim (date_dim_5)  (rows=4, time=3.895)\n        Index Only Scan on date_dim (date_dim_4)  (rows=30, time=0.006)\n  Sort  (rows=0, time=280.626)\n    Merge Join  (rows=0, time=280.616)\n      Merge Join  (rows=0, time=280.613",
    "p03": "Limit  (rows=0, time=494.38)\n  Sort  (rows=0, time=494.378)\n    Nested Loop  (rows=0, time=494.358)\n      Nested Loop  (rows=0, time=494.354)\n        Aggregate  (rows=1, time=417.436)\n          Sort  (rows=1, time=417.431)\n            Nested Loop  (rows=1, time=417.424)\n              Nested Loop  (rows=84, time=416.637)\n                Aggregate  (rows=122, time=12.832)\n                  Hash Join  (rows=122, time=12.684)\n                    Seq Scan on date_dim  (rows=73049, time=6.086)\n       ",
    "p04": "Limit  (rows=0, time=281.611)\n  Seq Scan on item  (rows=3140, time=19.26)\n  Hash Join  (rows=122, time=11.693)\n    Seq Scan on date_dim  (rows=73049, time=5.221)\n    Hash  (rows=122, time=3.632)\n      Nested Loop  (rows=122, time=3.613)\n        Aggregate  (rows=4, time=3.588)\n          Index Only Scan on date_dim (date_dim_2)  (rows=4, time=3.584)\n        Index Only Scan on date_dim (date_dim_1)  (rows=30, time=0.004)\n  Sort  (rows=0, time=281.604)\n    Merge Join  (rows=0, time=281.595)\n      Me",
    "compile_p01_based": "Limit  (rows=0, time=471.283)\n  Nested Loop  (rows=122, time=4.43)\n    Aggregate  (rows=4, time=4.131)\n      Index Only Scan on date_dim (date_dim_1)  (rows=4, time=4.11)\n    Index Only Scan on date_dim  (rows=30, time=0.048)\n  Sort  (rows=0, time=471.278)\n    Merge Join  (rows=0, time=471.265)\n      Merge Join  (rows=0, time=471.262)\n        Aggregate  (rows=1, time=413.494)\n          Sort  (rows=1, time=413.487)\n            Nested Loop  (rows=1, time=413.477)\n              Nested Loop  (rows=8"
  }
}