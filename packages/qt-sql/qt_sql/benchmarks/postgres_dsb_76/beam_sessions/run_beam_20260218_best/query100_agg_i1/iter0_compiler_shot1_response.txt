[
  {
    "plan_id": "compile_p04",
    "dialect": "postgres",
    "confidence": 0.9,
    "based_on": "p04",
    "strategy": "Prefilter store_sales into CTEs to avoid repeated scans, convert comma joins to explicit joins, enable better join ordering.",
    "hypothesis": "Winner p04 (2.00x) directly targets the largest hotspot—repeated store_sales scans—by pushing ss_list_price filters into CTEs, removing comma-join lock and reducing row flow into the non-equi join.",
    "expected_explain_delta": "Merge Join and Sorts replaced by hash joins; Nested Loop cardinality estimates improved; early store_sales filter applied.",
    "target_ir": "Add filtered_s1 and filtered_s2 CTEs; rewrite final_select with explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_s1", "filtered_s2", "item", "customer", "customer_address", "customer_demographics", "date_dim"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH filtered_s1 AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122), filtered_s2 AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122) SELECT item1.i_item_sk, item2.i_item_sk, count(*) AS cnt FROM filtered_s1 s1 JOIN filtered_s2 s2 ON s1.ss_ticket_number = s2.ss_ticket_number JOIN item item1 ON s1.ss_item_sk = item1.i_item_sk JOIN item item2 ON s2.ss_item_sk = item2.i_item_sk JOIN customer c ON s1.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN date_dim d ON d.d_date_sk = s1.ss_sold_date_sk WHERE item1.i_item_sk < item2.i_item_sk AND item1.i_category IN ('Electronics', 'Jewelry') AND item2.i_manager_id BETWEEN 81 AND 100 AND d.d_year BETWEEN 1998 AND 1999 AND cd.cd_marital_status = 'S' AND cd.cd_education_status = 'College' GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        },
        {
          "node_id": "filtered_s1",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number", "ss_customer_sk", "ss_sold_date_sk"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122"
        },
        {
          "node_id": "filtered_s2",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p01_p04_hybrid",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p04",
    "strategy": "Combine date-dimension CTE from p01 with store_sales pre‑filter CTEs from p04; keep explicit join syntax.",
    "hypothesis": "Probes p01 (1.26x) and p04 (2.00x) are compatible; adding a small date‑dimension CTE may further reduce rows early and improve join‑order flexibility.",
    "expected_explain_delta": "Date‑dimension scan isolated; store_sales filters pushed; nested‑loop cardinality improved.",
    "target_ir": "Add date_filtered, filtered_s1, filtered_s2 CTEs; final_select uses explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_filtered", "filtered_s1", "filtered_s2", "item", "customer", "customer_address", "customer_demographics"],
          "outputs": ["i_item_sk", "i_item_sk", "cnt"],
          "changed": true,
          "sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 1999), filtered_s1 AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122), filtered_s2 AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122) SELECT item1.i_item_sk, item2.i_item_sk, count(*) AS cnt FROM date_filtered d JOIN filtered_s1 s1 ON d.d_date_sk = s1.ss_sold_date_sk JOIN filtered_s2 s2 ON s1.ss_ticket_number = s2.ss_ticket_number JOIN item item1 ON s1.ss_item_sk = item1.i_item_sk JOIN item item2 ON s2.ss_item_sk = item2.i_item_sk JOIN customer c ON s1.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE item1.i_item_sk < item2.i_item_sk AND item1.i_category IN ('Electronics', 'Jewelry') AND item2.i_manager_id BETWEEN 81 AND 100 AND cd.cd_marital_status = 'S' AND cd.cd_education_status = 'College' GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt"
        },
        {
          "node_id": "date_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1998 AND 1999"
        },
        {
          "node_id": "filtered_s1",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number", "ss_customer_sk", "ss_sold_date_sk"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122"
        },
        {
          "node_id": "filtered_s2",
          "parent_node_id": "final_select",
          "sources": ["store_sales"],
          "outputs": ["ss_item_sk", "ss_ticket_number"],
          "changed": true,
          "sql": "SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 108 AND 122"
        }
      ]
    }
  }
]