[
  {
    "plan_id": "compile_p02_enhanced",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02",
    "strategy": "Date CTE with explicit joins, removing redundant date filter, keep LEFT JOIN semantics.",
    "hypothesis": "WIN probe p02 (1.30x) addressed repeated date_dim scans and comma join weakness. Removing redundant date filter in channel CTEs may further reduce complexity. Promotion duplication remains but is minor (2.7ms total).",
    "expected_explain_delta": "Single date_dim scan via CTE; nested loops convert to hash joins; no duplicate promotion CTE introduced.",
    "target_ir": "Add date_cte node, update ssr/csr/wsr to explicit JOINs, remove redundant date predicate.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ssr", "csr", "wsr"],
          "outputs": ["channel", "id", "sales", "returns", "profit"],
          "changed": false
        },
        {
          "node_id": "ssr",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "date_cte", "store", "item", "promotion"],
          "outputs": ["store_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT s_store_id AS store_id,\n       sum(ss_ext_sales_price) AS sales,\n       sum(coalesce(sr_return_amt, 0)) AS returns,\n       sum(ss_net_profit - coalesce(sr_net_loss, 0)) AS profit\nFROM store_sales\nLEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)\nJOIN date_cte d ON ss_sold_date_sk = d.d_date_sk\nJOIN store ON ss_store_sk = s_store_sk\nJOIN item ON ss_item_sk = i_item_sk\nJOIN promotion ON ss_promo_sk = p_promo_sk\nWHERE i_current_price > 50\n  AND p_channel_email = 'N'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND ss_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY s_store_id"
        },
        {
          "node_id": "csr",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "catalog_returns", "date_cte", "catalog_page", "item", "promotion"],
          "outputs": ["catalog_page_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id,\n       sum(cs_ext_sales_price) AS sales,\n       sum(coalesce(cr_return_amount, 0)) AS returns,\n       sum(cs_net_profit - coalesce(cr_net_loss, 0)) AS profit\nFROM catalog_sales\nLEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)\nJOIN date_cte d ON cs_sold_date_sk = d.d_date_sk\nJOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk\nJOIN item ON cs_item_sk = i_item_sk\nJOIN promotion ON cs_promo_sk = p_promo_sk\nWHERE i_current_price > 50\n  AND p_channel_email = 'N'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND cs_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY cp_catalog_page_id"
        },
        {
          "node_id": "wsr",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "date_cte", "web_site", "item", "promotion"],
          "outputs": ["web_site_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT web_site_id,\n       sum(ws_ext_sales_price) AS sales,\n       sum(coalesce(wr_return_amt, 0)) AS returns,\n       sum(ws_net_profit - coalesce(wr_net_loss, 0)) AS profit\nFROM web_sales\nLEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)\nJOIN date_cte d ON ws_sold_date_sk = d.d_date_sk\nJOIN web_site ON ws_web_site_sk = web_site_sk\nJOIN item ON ws_item_sk = i_item_sk\nJOIN promotion ON ws_promo_sk = p_promo_sk\nWHERE i_current_price > 50\n  AND p_channel_email = 'N'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'\n  AND ws_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY web_site_id"
        },
        {
          "node_id": "date_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date\nFROM date_dim\nWHERE d_date BETWEEN cast('1998-08-29' AS date) AND cast('1998-08-29' AS date) + interval '30 day'"
        }
      ]
    }
  },
  {
    "plan_id": "compile_date_promo_cte",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02",
    "strategy": "Date CTE + promotion CTE, explicit joins, remove redundant filters.",
    "hypothesis": "Extend winning date_cte pattern to also share promotion scan (which is small but repeated). Avoid overâ€‘materialization that caused regression in p03 by keeping promotion CTE simple and not joining dimensions early.",
    "expected_explain_delta": "Single date_dim and promotion scan; channel CTEs join to both CTEs; reduced total scan volume.",
    "target_ir": "Add date_cte and promo_cte nodes, update channel CTEs to reference both CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ssr", "csr", "wsr"],
          "outputs": ["channel", "id", "sales", "returns", "profit"],
          "changed": false
        },
        {
          "node_id": "ssr",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "store_returns", "date_cte", "store", "item", "promo_cte"],
          "outputs": ["store_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT s_store_id AS store_id,\n       sum(ss_ext_sales_price) AS sales,\n       sum(coalesce(sr_return_amt, 0)) AS returns,\n       sum(ss_net_profit - coalesce(sr_net_loss, 0)) AS profit\nFROM store_sales\nLEFT OUTER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)\nJOIN date_cte d ON ss_sold_date_sk = d.d_date_sk\nJOIN store ON ss_store_sk = s_store_sk\nJOIN item ON ss_item_sk = i_item_sk\nJOIN promo_cte p ON ss_promo_sk = p.p_promo_sk\nWHERE i_current_price > 50\n  AND ss_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY s_store_id"
        },
        {
          "node_id": "csr",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "catalog_returns", "date_cte", "catalog_page", "item", "promo_cte"],
          "outputs": ["catalog_page_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id,\n       sum(cs_ext_sales_price) AS sales,\n       sum(coalesce(cr_return_amount, 0)) AS returns,\n       sum(cs_net_profit - coalesce(cr_net_loss, 0)) AS profit\nFROM catalog_sales\nLEFT OUTER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)\nJOIN date_cte d ON cs_sold_date_sk = d.d_date_sk\nJOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk\nJOIN item ON cs_item_sk = i_item_sk\nJOIN promo_cte p ON cs_promo_sk = p.p_promo_sk\nWHERE i_current_price > 50\n  AND cs_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY cp_catalog_page_id"
        },
        {
          "node_id": "wsr",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "date_cte", "web_site", "item", "promo_cte"],
          "outputs": ["web_site_id", "sales", "returns", "profit"],
          "changed": true,
          "sql": "SELECT web_site_id,\n       sum(ws_ext_sales_price) AS sales,\n       sum(coalesce(wr_return_amt, 0)) AS returns,\n       sum(ws_net_profit - coalesce(wr_net_loss, 0)) AS profit\nFROM web_sales\nLEFT OUTER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)\nJOIN date_cte d ON ws_sold_date_sk = d.d_date_sk\nJOIN web_site ON ws_web_site_sk = web_site_sk\nJOIN item ON ws_item_sk = i_item_sk\nJOIN promo_cte p ON ws_promo_sk = p.p_promo_sk\nWHERE i_current_price > 50\n  AND ws_wholesale_cost BETWEEN 23 AND 38\n  AND i_category IN ('Children', 'Sports')\nGROUP BY web_site_id"
        },
        {
          "node_id": "date_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date\nFROM date_dim\nWHERE d_date BETWEEN cast('1998-08-29' AS date) AND cast('1998-08-29' AS date) + interval '30 day'"
        },
        {
          "node_id": "promo_cte",
          "parent_node_id": "final_select",
          "sources": ["promotion"],
          "outputs": ["p_promo_sk"],
          "changed": true,
          "sql": "SELECT p_promo_sk\nFROM promotion\nWHERE p_channel_email = 'N'\n  AND p_channel_tv = 'N'\n  AND p_channel_radio = 'N'\n  AND p_channel_press = 'N'\n  AND p_channel_event = 'N'"
        }
      ]
    }
  }
]