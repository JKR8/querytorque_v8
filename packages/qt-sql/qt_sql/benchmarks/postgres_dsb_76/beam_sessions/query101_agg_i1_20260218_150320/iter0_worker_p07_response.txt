{
  "probe_id": "p12",
  "transform_id": "multi_date_range_cte",
  "family": "A",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Creating separate CTEs for d1 and d2 with their respective filters, and precomputing the date range join, will allow PostgreSQL to evaluate the non-equi condition earlier and reduce rows entering the main join.",
  "reasoning_trace": [
    "Assigned transform targets the non-equi date range join between d1 and d2.",
    "Separating d1 and d2 into individual CTEs with selective filters allows early pruning.",
    "Precomputing the date range relationship isolates the BETWEEN logic from the main query.",
    "Main query now references precomputed date keys, avoiding late non-equi evaluation."
  ],
  "target_ir": "CTEs d1_cte, d2_cte, and date_range_cte added; FROM clause replaced to use them.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_first_name, c_last_name, count(*) as cnt FROM store_sales ss JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk JOIN date_range_cte dr ON ss.ss_sold_date_sk = dr.d2_date_sk AND sr.sr_returned_date_sk = dr.d1_date_sk JOIN item i ON i.i_item_sk = ss.ss_item_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Electronics', 'Music') AND ca.ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX') AND hd.hd_income_band_sk BETWEEN 7 AND 13 AND hd.hd_buy_potential = '0-500' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 35 * 0.01 AND 55 * 0.01 GROUP BY c_customer_sk, c_first_name, c_last_name ORDER BY cnt"
      },
      {
        "node_id": "d1_cte",
        "parent_node_id": "date_range_cte",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998"
      },
      {
        "node_id": "d2_cte",
        "parent_node_id": "date_range_cte",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      },
      {
        "node_id": "date_range_cte",
        "parent_node_id": "final_select",
        "sources": ["d1_cte", "d2_cte"],
        "outputs": ["d1_date_sk", "d2_date_sk"],
        "changed": true,
        "sql": "SELECT d1.d_date_sk AS d1_date_sk, d2.d_date_sk AS d2_date_sk FROM d1_cte d1 JOIN d2_cte d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '90 day')"
      }
    ]
  }
}