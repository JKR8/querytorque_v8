{
  "plan_id": "wildcard_postgres_preagg_and_materialize_cte",
  "dialect": "postgres",
  "description": "Materialize frequent_ss_items CTE and retain preaggregated best_ss_customer CTE to eliminate redundant scans and reduce input rows to final join.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "frequent_ss_items_mat",
        "cte_query_sql": "SELECT substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt FROM store_sales,date_dim,item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 and 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30),i_item_sk,d_date HAVING count(*) >4"
      },
      "description": "Materialize frequent_ss_items CTE to avoid repeated scans"
    },
    {
      "step_id": "s2",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "838b446f5bb5aa2d"
      },
      "payload": {
        "expr_sql": "ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 and 63 AND i_category IN ('Men', 'Music', 'Sports')"
      },
      "description": "Retain original filter conditions in base frequent_ss_items definition"
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "(select cs_quantity*cs_list_price sales from catalog_sales,date_dim where d_year = 1999 and d_moy = 5 and cs_sold_date_sk = d_date_sk and cs_item_sk in (select item_sk from frequent_ss_items_mat) and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer) and cs_wholesale_cost BETWEEN 26 AND 36 union all select ws_quantity*ws_list_price sales from web_sales,date_dim where d_year = 1999 and d_moy = 5 and ws_sold_date_sk = d_date_sk and ws_item_sk in (select item_sk from frequent_ss_items_mat) and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer) and ws_wholesale_cost BETWEEN 26 AND 36) tmp2"
      },
      "description": "Rewrite main query FROM clause to reference materialized CTE"
    }
  ]
}