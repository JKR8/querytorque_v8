{
  "plan_id": "preagg_best_customer",
  "dialect": "postgres",
  "description": "Pre-aggregate store_sales by customer_sk before joining to customer. Eliminate per-row re-execution of max_store_sales subquery by precomputing it.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "agg_store_sales_by_customer",
        "cte_query_sql": "SELECT ss_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 1999 AND ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY ss_customer_sk"
      },
      "description": "Pre-aggregate store_sales by customer_sk with relevant filters"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "precomputed_max_sales",
        "cte_query_sql": "SELECT MAX(csales) AS tpcds_cmax FROM agg_store_sales_by_customer"
      },
      "description": "Precompute max sales to avoid correlated subquery"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "e2efc842d5bebfd9"
      },
      "payload": {
        "sql_fragment": "WITH frequent_ss_items AS (SELECT substring(i_item_desc,1,30) itemdesc,i_item_sk item_sk,d_date solddate,count(*) cnt FROM store_sales ,date_dim ,item WHERE ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND d_year = 1999 AND i_manager_id BETWEEN 44 and 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30),i_item_sk,d_date HAVING count(*) >4), max_store_sales AS (SELECT tpcds_cmax FROM precomputed_max_sales), best_ss_customer AS (SELECT c_customer_sk,sum(ss_quantity*ss_sales_price) ssales FROM store_sales ,customer WHERE ss_customer_sk = c_customer_sk AND c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk HAVING sum(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT * FROM max_store_sales)) select sum(sales) from (select cs_quantity*cs_list_price sales from catalog_sales ,date_dim where d_year = 1999 and d_moy = 5 and cs_sold_date_sk = d_date_sk and cs_item_sk in (select item_sk from frequent_ss_items) and cs_bill_customer_sk in (select c_customer_sk from best_ss_customer) and cs_wholesale_cost BETWEEN 26 AND 36 union all select ws_quantity*ws_list_price sales from web_sales ,date_dim where d_year = 1999 and d_moy = 5 and ws_sold_date_sk = d_date_sk and ws_item_sk in (select item_sk from frequent_ss_items) and ws_bill_customer_sk in (select c_customer_sk from best_ss_customer) and ws_wholesale_cost BETWEEN 26 AND 36) tmp2 limit 100"
      },
      "description": "Replace main query body with optimized version using precomputed CTEs"
    }
  ]
}