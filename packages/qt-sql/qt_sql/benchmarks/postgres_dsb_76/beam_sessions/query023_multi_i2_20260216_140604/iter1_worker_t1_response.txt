{
  "plan_id": "wildcard_preagg_early_filter",
  "dialect": "postgres",
  "description": "Pre-aggregate store_sales by item/date before joining to dimensions (cuts input rows from 312k to 46k) and remove unused substring/d_date columns. Targets the most expensive operator (Hash) in t1 winner's plan.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "agg_store_sales",
        "cte_query_sql": "SELECT ss_item_sk, ss_sold_date_sk, COUNT(*) AS cnt FROM store_sales GROUP BY ss_item_sk, ss_sold_date_sk"
      },
      "description": "Insert pre-aggregated CTE for store_sales"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_date",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999"
      },
      "description": "Insert filtered date dimension CTE"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_item",
        "cte_query_sql": "SELECT i_item_sk, i_item_desc FROM item WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports')"
      },
      "description": "Insert filtered item dimension CTE"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0",
        "by_cte_name": "frequent_ss_items"
      },
      "payload": {
        "from_sql": "agg_store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN filtered_item ON ss_item_sk = i_item_sk"
      },
      "description": "Replace FROM clause in frequent_ss_items with explicit JOINs on pre-filtered CTEs"
    },
    {
      "step_id": "s5",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_cte_name": "frequent_ss_items",
        "by_anchor_hash": "838b446f5bb5aa2d"
      },
      "payload": {
        "expr_sql": "ss_sold_date_sk = d_date_sk AND ss_item_sk = i_item_sk AND cnt > 4"
      },
      "description": "Replace WHERE clause to use pre-aggregated count"
    },
    {
      "step_id": "s6",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_cte_name": "frequent_ss_items",
        "by_anchor_hash": "groupby_expr_1"
      },
      "payload": {
        "expr_sql": "SUBSTRING(i_item_desc FROM 1 FOR 30), i_item_sk, d_date"
      },
      "description": "Retain only necessary GROUP BY columns"
    }
  ]
}