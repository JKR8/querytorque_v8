{
  "plan_id": "gold_postgres_explicit_join_prefetch_then_join",
  "dialect": "postgres",
  "description": "Convert comma joins to explicit INNER JOINs and prefetch dimensions into materialized CTEs. This enables better join order selection and reduces input rows to expensive hash joins by materializing filtered date and store dimensions before joining with the fact table.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_dates_period1",
        "cte_query_sql": "SELECT d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 AND 1187 + 11"
      },
      "description": "Insert CTE 'filtered_dates_period1' for first time period"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_dates_period2",
        "cte_query_sql": "SELECT d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1187 + 12 AND 1187 + 23"
      },
      "description": "Insert CTE 'filtered_dates_period2' for second time period"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_stores",
        "cte_query_sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store WHERE s_state IN ('AR','CO','IA','IL','NC','NY','PA','TX')"
      },
      "description": "Insert CTE 'filtered_stores' for store dimension filtering"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "period_agg",
        "cte_query_sql": "SELECT s_store_name AS s_store_name1, wss.d_week_seq AS d_week_seq1, s_store_id AS s_store_id1, sun_sales AS sun_sales1, mon_sales AS mon_sales1, tue_sales AS tue_sales1, wed_sales AS wed_sales1, thu_sales AS thu_sales1, fri_sales AS fri_sales1, sat_sales AS sat_sales1, 2 AS period FROM wss JOIN filtered_stores fs ON wss.ss_store_sk = fs.s_store_sk JOIN filtered_dates_period2 fd ON wss.d_week_seq = fd.d_week_seq UNION ALL SELECT s_store_name AS s_store_name2, wss.d_week_seq AS d_week_seq2, s_store_id AS s_store_id2, sun_sales AS sun_sales2, mon_sales AS mon_sales2, tue_sales AS tue_sales2, wed_sales AS wed_sales2, thu_sales AS thu_sales2, fri_sales AS fri_sales2, sat_sales AS sat_sales2, 1 AS period FROM wss JOIN filtered_stores fs ON wss.ss_store_sk = fs.s_store_sk JOIN filtered_dates_period1 fd ON wss.d_week_seq = fd.d_week_seq"
      },
      "description": "Insert CTE 'period_agg' combining both periods with period indicator"
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "(SELECT s_store_name1, s_store_id1, d_week_seq1, sun_sales1, mon_sales1, tue_sales1, wed_sales1, thu_sales1, fri_sales1, sat_sales1 FROM period_agg WHERE period = 1) y JOIN (SELECT s_store_name2, s_store_id2, d_week_seq2, sun_sales2, mon_sales2, tue_sales2, wed_sales2, thu_sales2, fri_sales2, sat_sales2 FROM period_agg WHERE period = 2) x ON y.s_store_id1 = x.s_store_id2 AND y.d_week_seq1 = x.d_week_seq2 - 52"
      },
      "description": "Replace FROM clause with explicit JOIN using period_agg CTE"
    },
    {
      "step_id": "s6",
      "op": "delete_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "0b824afb49a292d0"
      },
      "description": "Remove old WHERE clause (conditions now in JOIN)"
    }
  ]
}