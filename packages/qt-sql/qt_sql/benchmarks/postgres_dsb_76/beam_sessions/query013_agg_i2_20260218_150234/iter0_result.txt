{
  "iteration": 0,
  "n_api_calls": 9,
  "beam_cost_usd": 0.0357109,
  "beam_cost_priced_calls": 9,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 115022,
    "completion_tokens": 29924,
    "total_tokens": 144946,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 38592,
    "reasoning_tokens": 17730
  },
  "best_speedup": 1.11,
  "best_patch_id": "p03",
  "best_sql": "WITH filtered_sales AS (WITH filtered_sales AS (SELECT ss.ss_quantity, ss.ss_ext_sales_price, ss.ss_ext_wholesale_cost, ss.ss_net_profit, ss.ss_store_sk, ss.ss_cdemo_sk, ss.ss_addr_sk, ss.ss_sales_price, hd.hd_dep_count FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_year = 2001 AND hd.hd_dep_count IN (1, 3)) SELECT * FROM filtered_sales) SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM filtered_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));",
  "patches": [
    {
      "patch_id": "p02",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.55,
      "status": "NEUTRAL",
      "speedup": 0.96,
      "semantic_passed": true,
      "error": null,
      "original_ms": 611.8,
      "patch_ms": 638.9,
      "output_sql": "select avg(ss_quantity)\n,avg(ss_ext_sales_price)\n,avg(ss_ext_wholesale_cost)\n,sum(ss_ext_wholesale_cost)\nfrom store_sales\n   ,store\n   ,customer_demographics\n   ,household_demographics\n   ,customer_address\n   ,date_dim\nwhere s_store_sk = ss_store_sk\nand  ss_sold_date_sk = d_date_sk and d_year = 2001\nand((ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'M'\nand cd_education_status = '2 yr Degree'\nand ss_sales_price between 100.00 and 150.00\nand hd_dep_count = 3\n   )or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'S'\nand cd_education_status = 'Primary'\nand ss_sales_price between 50.00 and 100.00\nand hd_dep_count = 1\n   ) or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'W'\nand cd_education_status = 'Primary'\nand ss_sales_price between 150.00 and 200.00\nand hd_dep_count = 1\n   ))\nand((ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('GA', 'KY', 'SD')\nand ss_net_profit between 100 and 200\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('AR', 'IN', 'VA')\nand ss_net_profit between 150 and 300\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('KS', 'OH', 'SD')\nand ss_net_profit between 50 and 250\n   ));",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Decompose the three\u2011branch OR on customer_demographics/household_demographics into UNION ALL of three branches, each with its specific cd_marital_status, cd_education_status, hd_dep_count and ss_sales_price range. Keep the customer\u2011address OR separate as a later filter."
    },
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column \"cd_marital_status\" does not exist\nLINE 1: ...stomer_addr ON ss_addr_sk = ca_address_sk WHERE ((cd_marital...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH prefetch_household AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)), prefetch_customer_demo AS (SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'W' AND cd_education_status = 'Primary')), prefetch_customer_addr AS (SELECT ca_address_sk FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD')) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA')) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD'))), final_select AS (SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk AND d_year = 2001 JOIN prefetch_household ON ss_hdemo_sk = hd_demo_sk JOIN prefetch_customer_demo ON cd_demo_sk = ss_cdemo_sk JOIN prefetch_customer_addr ON ss_addr_sk = ca_address_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))) SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM final_select;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011filter household_demographics (hd_dep_count IN (1,3)), customer_demographics (cd_marital_status, cd_education_status), and customer_address (ca_country, ca_state) into separate CTEs before joining with store_sales and date_dim. Convert comma joins to explicit JOIN syntax."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.6,
      "status": "WIN",
      "speedup": 1.11,
      "semantic_passed": true,
      "error": null,
      "original_ms": 611.8,
      "patch_ms": 553.7,
      "output_sql": "WITH filtered_sales AS (WITH filtered_sales AS (SELECT ss.ss_quantity, ss.ss_ext_sales_price, ss.ss_ext_wholesale_cost, ss.ss_net_profit, ss.ss_store_sk, ss.ss_cdemo_sk, ss.ss_addr_sk, ss.ss_sales_price, hd.hd_dep_count FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk WHERE d.d_year = 2001 AND hd.hd_dep_count IN (1, 3)) SELECT * FROM filtered_sales) SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM filtered_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Create a CTE that joins store_sales with date_dim (d_year=2001) and pre\u2011filtered household_demographics (hd_dep_count IN (1,3)), then join that reduced fact set with customer_demographics and customer_address using explicit JOINs."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "materialize_cte",
      "relevance_score": 0.5,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH early_joins AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit, ss_hdemo_sk, ss_cdemo_sk, ss_addr_sk, hd_demo_sk, hd_dep_count FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN store ON s_store_sk = ss_store_sk WHERE d_year = 2001) SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM early_joins, customer_demographics, customer_address WHERE ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the join of store_sales, date_dim, household_demographics, and store into a CTE, then apply the customer_demographics and customer_address OR filters in the outer query. Use explicit JOIN syntax."
    },
    {
      "patch_id": "compile_p03_win",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.39,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1162.9,
      "patch_ms": 2968.0,
      "output_sql": "WITH filtered_sales AS (\n  SELECT ss.ss_quantity, ss.ss_ext_sales_price, ss.ss_ext_wholesale_cost, ss.ss_net_profit, ss.ss_store_sk, ss.ss_cdemo_sk, ss.ss_addr_sk, ss.ss_sales_price, hd.hd_dep_count\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk\n  JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk\n  WHERE d.d_year = 2001 AND hd.hd_dep_count IN (1, 3)\n)\nSELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost)\nFROM filtered_sales\nJOIN store ON s_store_sk = ss_store_sk\nJOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk\nJOIN customer_address ON ca_address_sk = ss_addr_sk\nWHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3)\n    OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1)\n    OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1))\n  AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200)\n    OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300)\n    OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p03_fixed",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 4 missing, 4 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_sales AS (\n  SELECT\n    ss.ss_quantity,\n    ss.ss_ext_sales_price,\n    ss.ss_ext_wholesale_cost,\n    ss.ss_net_profit,\n    ss.ss_sales_price,\n    ss.ss_store_sk,\n    ss.ss_cdemo_sk,\n    ss.ss_addr_sk,\n    hd.hd_dep_count\n  FROM store_sales ss\n  JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001\n  JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk AND hd.hd_dep_count IN (1, 3)\n)\nSELECT\n  avg(fs.ss_quantity),\n  avg(fs.ss_ext_sales_price),\n  avg(fs.ss_ext_wholesale_cost),\n  sum(fs.ss_ext_wholesale_cost)\nFROM filtered_sales fs\nJOIN store s ON s.s_store_sk = fs.ss_store_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = fs.ss_cdemo_sk\nJOIN customer_address ca ON ca.ca_address_sk = fs.ss_addr_sk\nWHERE\n  (\n    (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND fs.ss_sales_price BETWEEN 100.00 AND 150.00 AND fs.hd_dep_count = 3) OR\n    (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 50.00 AND 100.00 AND fs.hd_dep_count = 1) OR\n    (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 150.00 AND 200.00 AND fs.hd_dep_count = 1)\n  ) AND\n  (\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND fs.ss_net_profit BETWEEN 100 AND 200) OR\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND fs.ss_net_profit BETWEEN 150 AND 300) OR\n    (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND fs.ss_net_profit BETWEEN 50 AND 250)\n  );",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_aggressive_prefilter",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 4 missing, 4 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH prefetch_household AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)), prefetch_customer_demo AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status\n    FROM customer_demographics\n    WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR\n          (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR\n          (cd_marital_status = 'W' AND cd_education_status = 'Primary')), prefetch_customer_addr AS (SELECT ca_address_sk, ca_state\n    FROM customer_address\n    WHERE ca_country = 'United States' AND\n          ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH', 'SD')) WITH\n  prefetch_household AS (\n    SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)\n  ),\n  prefetch_customer_demo AS (\n    SELECT cd_demo_sk, cd_marital_status, cd_education_status\n    FROM customer_demographics\n    WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR\n          (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR\n          (cd_marital_status = 'W' AND cd_education_status = 'Primary')\n  ),\n  prefetch_customer_addr AS (\n    SELECT ca_address_sk, ca_state\n    FROM customer_address\n    WHERE ca_country = 'United States' AND\n          ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH', 'SD')\n  )\nSELECT\n  avg(ss.ss_quantity),\n  avg(ss.ss_ext_sales_price),\n  avg(ss.ss_ext_wholesale_cost),\n  sum(ss.ss_ext_wholesale_cost)\nFROM store_sales ss\nJOIN store s ON s.s_store_sk = ss.ss_store_sk\nJOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001\nJOIN prefetch_household hd ON ss.ss_hdemo_sk = hd.hd_demo_sk\nJOIN prefetch_customer_demo cd ON ss.ss_cdemo_sk = cd.cd_demo_sk\nJOIN prefetch_customer_addr ca ON ss.ss_addr_sk = ca.ca_address_sk\nWHERE\n  (\n    (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR\n    (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR\n    (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)\n  ) AND\n  (\n    (ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR\n    (ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR\n    (ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250)\n  );",
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {
    "p02": "Aggregate  (rows=1, time=626.591)\n  Gather  (rows=3, time=626.578)\n    Aggregate  (rows=1, time=406.26)\n      Nested Loop  (rows=22, time=406.177)\n        Nested Loop  (rows=980, time=397.18)\n          Hash Join  (rows=6247, time=359.169)\n            Hash Join  (rows=6265, time=358.074)\n              Nested Loop  (rows=56045, time=351.337)\n                Index Only Scan on date_dim  (rows=122, time=0.63)\n                Index Only Scan on store_sales  (rows=461, time=2.857)\n              Hash  ",
    "p03": "Aggregate  (rows=1, time=567.794)\n  Gather  (rows=65, time=567.61)\n    Nested Loop  (rows=22, time=368.159)\n      Nested Loop  (rows=124, time=366.532)\n        Hash Join  (rows=2708, time=341.889)\n          Hash Join  (rows=2714, time=341.047)\n            Nested Loop  (rows=56045, time=333.756)\n              Index Only Scan on date_dim (d)  (rows=122, time=0.667)\n              Index Only Scan on store_sales (ss)  (rows=461, time=2.713)\n            Hash  (rows=1440, time=0.657)\n              Seq ",
    "compile_p03_win": "Aggregate  (rows=1, time=2655.008)\n  Gather  (rows=1, time=2654.983)\n    Aggregate  (rows=1, time=2654.094)\n      Nested Loop  (rows=65, time=2653.533)\n        Nested Loop  (rows=65, time=2652.402)\n          Nested Loop  (rows=2944, time=2590.554)\n            Hash Join  (rows=18795, time=2235.698)\n              Nested Loop  (rows=168134, time=2165.86)\n                Index Only Scan on date_dim (d)  (rows=365, time=4.279)\n                Index Only Scan on store_sales (ss)  (rows=461, time=5.875"
  }
}