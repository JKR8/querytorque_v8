[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p04",
    "strategy": "Explicit JOIN syntax + early date filter",
    "hypothesis": "Original comma joins prevent optimal join ordering. Adding d1.d_year filter early reduces date_dim scan. EXPLAIN shows full date_dim scan (d1) contributing to nested loops.",
    "target_ir": "cross_sales CTE with explicit JOINs and d1.d_year filter",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_block_with_cte_pair",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "cross_sales",
          "sql_fragment": "SELECT i_product_name product_name, i_item_sk item_sk, s_store_name store_name, s_zip store_zip, ad1.ca_street_number b_street_number, ad1.ca_street_name b_street_name, ad1.ca_city b_city, ad1.ca_zip b_zip, ad2.ca_street_number c_street_number, ad2.ca_street_name c_street_name, ad2.ca_city c_city, ad2.ca_zip c_zip, d1.d_year as syear, d2.d_year as fsyear, d3.d_year s2year, COUNT(*) cnt, SUM(ss_wholesale_cost) s1, SUM(ss_list_price) s2, SUM(ss_coupon_amt) s3 FROM store_sales JOIN store_returns ON store_sales.ss_item_sk = store_returns.sr_item_sk AND store_sales.ss_ticket_number = store_returns.sr_ticket_number JOIN cs_ui ON store_sales.ss_item_sk = cs_ui.cs_item_sk JOIN date_dim d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON customer.c_first_sales_date_sk = d2.d_date_sk JOIN date_dim d3 ON customer.c_first_shipto_date_sk = d3.d_date_sk JOIN store ON store_sales.ss_store_sk = store.s_store_sk JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk JOIN customer_demographics cd1 ON store_sales.ss_cdemo_sk = cd1.cd_demo_sk JOIN customer_demographics cd2 ON customer.c_current_cdemo_sk = cd2.cd_demo_sk JOIN promotion ON store_sales.ss_promo_sk = promotion.p_promo_sk JOIN household_demographics hd1 ON store_sales.ss_hdemo_sk = hd1.hd_demo_sk JOIN household_demographics hd2 ON customer.c_current_hdemo_sk = hd2.hd_demo_sk JOIN customer_address ad1 ON store_sales.ss_addr_sk = ad1.ca_address_sk JOIN customer_address ad2 ON customer.c_current_addr_sk = ad2.ca_address_sk JOIN income_band ib1 ON hd1.hd_income_band_sk = ib1.ib_income_band_sk JOIN income_band ib2 ON hd2.hd_income_band_sk = ib2.ib_income_band_sk JOIN item ON store_sales.ss_item_sk = item.i_item_sk WHERE cd1.cd_marital_status <> cd2.cd_marital_status AND i_current_price BETWEEN 26 AND 26 + 10 AND p_channel_email = 'N' AND p_channel_tv = 'Y' AND p_channel_radio = 'N' AND ad2.ca_state IN ('IA','IL','TX') AND store_sales.ss_wholesale_cost BETWEEN 35 AND 55 AND cd1.cd_marital_status IN ('M', 'M', 'U') AND cd1.cd_education_status IN ('Unknown', 'Advanced Degree', 'College') AND cd2.cd_marital_status IN ('M', 'M', 'U') AND cd2.cd_education_status IN ('Unknown', 'Advanced Degree', 'College') AND d1.d_year IN (1998, 1999) GROUP BY i_product_name, i_item_sk, s_store_name, s_zip, ad1.ca_street_number, ad1.ca_street_name, ad1.ca_city, ad1.ca_zip, ad2.ca_street_number, ad2.ca_street_name, ad2.ca_city, ad2.ca_zip, d1.d_year, d2.d_year, d3.d_year"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p09",
    "strategy": "Fact table pre-join isolation",
    "hypothesis": "Hash Join between catalog_sales/catalog_returns (183s) dominates runtime. Pre-joining and filtering in CTE reduces row count before grouping.",
    "target_ir": "cs_ui CTE rewritten with filtered_catalog base",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_catalog",
          "cte_query_sql": "SELECT cs_item_sk, cs_order_number, cs_ext_list_price, cr_refunded_cash, cr_reversed_charge, cr_store_credit FROM catalog_sales JOIN catalog_returns ON cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number WHERE cs_wholesale_cost BETWEEN 35 AND 55"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_block_with_cte_pair",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "cs_ui",
          "sql_fragment": "SELECT cs_item_sk, SUM(cs_ext_list_price) AS sale, SUM(cr_refunded_cash+cr_reversed_charge+cr_store_credit) AS refund FROM filtered_catalog GROUP BY cs_item_sk HAVING SUM(cs_ext_list_price) > 2*SUM(cr_refunded_cash+cr_reversed_charge+cr_store_credit)"
        }
      }
    ]
  }
]