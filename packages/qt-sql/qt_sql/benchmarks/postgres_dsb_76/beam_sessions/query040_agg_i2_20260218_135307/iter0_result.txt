{
  "iteration": 0,
  "n_api_calls": 8,
  "beam_cost_usd": 0.02825073,
  "beam_cost_priced_calls": 8,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 98257,
    "completion_tokens": 22016,
    "total_tokens": 120273,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 37952,
    "reasoning_tokens": 11721
  },
  "best_speedup": 511.64,
  "best_patch_id": "compile_p04",
  "best_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse), filtered_catalog_sales AS (SELECT cs_order_number, cs_item_sk, cs_warehouse_sk, cs_sold_date_sk, cs_sales_price, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87), catalog_returns AS (SELECT cr_order_number, cr_item_sk, cr_refunded_cash, cr_reason_sk FROM catalog_returns) SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cr.cr_reason_sk = 40 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 3.24,
      "semantic_passed": true,
      "error": null,
      "original_ms": 427.5,
      "patch_ms": 132.1,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')) SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs JOIN filtered_date_dim dd ON cs.cs_sold_date_sk = dd.d_date_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE dd.d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day') AND i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND cs.cs_wholesale_cost BETWEEN 68 AND 87 AND cr.cr_reason_sk = 40 GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma-joined tables to explicit INNER JOIN syntax and materialize filtered date_dim as a CTE to create a tiny hash table, enabling better join order flexibility."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.8,
      "status": "WIN",
      "speedup": 3.24,
      "semantic_passed": true,
      "error": null,
      "original_ms": 427.5,
      "patch_ms": 132.1,
      "output_sql": "SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales INNER JOIN catalog_returns ON cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk JOIN item ON cs_item_sk = i_item_sk JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day') AND i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81 AND cs_wholesale_cost BETWEEN 68 AND 87 AND cr_reason_sk = 40 GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert LEFT JOIN catalog_returns to INNER JOIN because cr_reason_sk=40 in WHERE clause null-rejects outer rows, enabling join reorder and potentially better plan."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.6,
      "status": "WIN",
      "speedup": 3.24,
      "semantic_passed": true,
      "error": null,
      "original_ms": 427.5,
      "patch_ms": 132.1,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse), filtered_catalog_sales AS (SELECT cs_order_number, cs_item_sk, cs_warehouse_sk, cs_sold_date_sk, cs_sales_price, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87), catalog_returns AS (SELECT cr_order_number, cr_item_sk, cr_refunded_cash, cr_reason_sk FROM catalog_returns) SELECT w_state, i_item_id, SUM(CASE WHEN (CAST(d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs_sales_price - COALESCE(cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cr.cr_reason_sk = 40 GROUP BY w_state, i_item_id ORDER BY w_state, i_item_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, item, warehouse) into CTEs and join them with catalog_sales using explicit JOIN syntax, combining early filtering with join-order flexibility."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Row count: orig=0, patch=100",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), filtered_item AS (SELECT i_item_sk, i_item_id, i_category, i_manager_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse), filtered_catalog_sales AS (SELECT cs_order_number, cs_item_sk, cs_warehouse_sk, cs_sold_date_sk, cs_sales_price, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87), catalog_returns AS (SELECT cr_order_number, cr_item_sk, cr_refunded_cash, cr_reason_sk FROM catalog_returns WHERE cr_reason_sk = 40) SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk AND cr.cr_reason_sk = 40 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim, item, and warehouse into separate CTEs to apply selective predicates before joining to catalog_sales, reducing rows entering the main join."
    },
    {
      "patch_id": "compile_p01_p02_hybrid",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 0 missing, 0 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')) SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(dd.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(dd.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(dd.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs JOIN filtered_date_dim dd ON cs.cs_sold_date_sk = dd.d_date_sk INNER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk AND cr.cr_reason_sk = 40 JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND cs.cs_wholesale_cost BETWEEN 68 AND 87 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_p04",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 511.64,
      "semantic_passed": true,
      "error": null,
      "original_ms": 73764.4,
      "patch_ms": 144.2,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')), filtered_item AS (SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81), filtered_warehouse AS (SELECT w_warehouse_sk, w_state FROM warehouse), filtered_catalog_sales AS (SELECT cs_order_number, cs_item_sk, cs_warehouse_sk, cs_sold_date_sk, cs_sales_price, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87), catalog_returns AS (SELECT cr_order_number, cr_item_sk, cr_refunded_cash, cr_reason_sk FROM catalog_returns) SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cr.cr_reason_sk = 40 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Limit  (rows=0, time=119.785)\n  Aggregate  (rows=0, time=119.784)\n    Gather Merge  (rows=0, time=119.783)\n      Aggregate  (rows=0, time=119.461)\n        Sort  (rows=0, time=119.46)\n          Nested Loop  (rows=0, time=119.453)\n            Nested Loop  (rows=0, time=119.452)\n              Nested Loop  (rows=868, time=116.208)\n                Nested Loop  (rows=30343, time=73.453)\n                  Seq Scan on date_dim  (rows=61, time=6.413)\n                  Index Scan on catalog_sales (cs)  (r",
    "p02": "Limit  (rows=0, time=112.5)\n  Aggregate  (rows=0, time=112.499)\n    Gather Merge  (rows=0, time=112.499)\n      Aggregate  (rows=0, time=112.111)\n        Sort  (rows=0, time=112.11)\n          Nested Loop  (rows=0, time=112.102)\n            Nested Loop  (rows=0, time=112.1)\n              Nested Loop  (rows=868, time=109.068)\n                Nested Loop  (rows=30343, time=69.347)\n                  Seq Scan on date_dim  (rows=61, time=5.196)\n                  Index Scan on catalog_sales  (rows=497, ",
    "p04": "Limit  (rows=0, time=119.762)\n  Aggregate  (rows=0, time=119.761)\n    Gather Merge  (rows=0, time=119.761)\n      Aggregate  (rows=0, time=119.478)\n        Sort  (rows=0, time=119.477)\n          Nested Loop  (rows=0, time=119.471)\n            Nested Loop  (rows=0, time=119.47)\n              Nested Loop  (rows=868, time=116.146)\n                Nested Loop  (rows=30343, time=72.952)\n                  Seq Scan on date_dim  (rows=61, time=5.158)\n                  Index Scan on catalog_sales  (rows=4",
    "compile_p04": "Limit  (rows=0, time=135.624)\n  Aggregate  (rows=0, time=135.623)\n    Gather Merge  (rows=0, time=135.623)\n      Aggregate  (rows=0, time=135.299)\n        Sort  (rows=0, time=135.299)\n          Nested Loop  (rows=0, time=135.291)\n            Nested Loop  (rows=0, time=135.29)\n              Nested Loop  (rows=868, time=131.472)\n                Nested Loop  (rows=30343, time=74.017)\n                  Seq Scan on date_dim  (rows=61, time=6.268)\n                  Index Scan on catalog_sales  (rows=4"
  }
}