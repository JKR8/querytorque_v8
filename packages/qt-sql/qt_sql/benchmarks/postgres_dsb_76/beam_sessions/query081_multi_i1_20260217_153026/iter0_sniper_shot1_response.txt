[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Combine decorrelation with CTE join optimization",
    "hypothesis": "Decorrelate subquery using state_avg CTE to eliminate nested loops. Convert comma-joins to explicit INNER JOINs for better cardinality estimation. Push 'IA' filter to customer_address join.",
    "target_ir": "CTE with explicit joins; state_avg CTE for thresholds; main query with decorrelated JOINs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (\n  SELECT \n    cr_returning_customer_sk AS ctr_customer_sk,\n    ca_state AS ctr_state, \n    SUM(cr_return_amt_inc_tax) AS ctr_total_return\n  FROM catalog_returns\n  INNER JOIN date_dim ON cr_returned_date_sk = d_date_sk\n  INNER JOIN customer_address ON cr_returning_addr_sk = ca_address_sk\n  WHERE d_year = 2000\n  GROUP BY cr_returning_customer_sk, ca_state\n),\nstate_avg AS (\n  SELECT \n    ctr_state,\n    AVG(ctr_total_return)*1.2 AS threshold\n  FROM customer_total_return\n  GROUP BY ctr_state\n)\nSELECT \n  c_customer_id, c_salutation, c_first_name, c_last_name,\n  ca_street_number, ca_street_name, ca_street_type, ca_suite_number,\n  ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset,\n  ca_location_type, ctr_total_return\nFROM customer_total_return ctr1\nINNER JOIN customer_address ON ca_address_sk = c_current_addr_sk AND ca_state = 'IA'\nINNER JOIN customer ON ctr1.ctr_customer_sk = c_customer_sk\nINNER JOIN state_avg ON ctr1.ctr_state = state_avg.ctr_state\nWHERE ctr1.ctr_total_return > state_avg.threshold\nORDER BY \n  c_customer_id, c_salutation, c_first_name, c_last_name,\n  ca_street_number, ca_street_name, ca_street_type, ca_suite_number,\n  ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset,\n  ca_location_type, ctr_total_return\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p06",
    "strategy": "State prefiltering with CTE isolation",
    "hypothesis": "Pre-filter customer_address to 'IA' before main join to reduce early row counts while maintaining comma-join structure for compatibility",
    "target_ir": "Original CTE structure; prefiltered customer_address CTE; decorrelated state_avg CTE",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (\n  SELECT \n    cr_returning_customer_sk AS ctr_customer_sk,\n    ca_state AS ctr_state, \n    SUM(cr_return_amt_inc_tax) AS ctr_total_return\n  FROM catalog_returns,\n       date_dim,\n       customer_address\n  WHERE cr_returned_date_sk = d_date_sk \n    AND d_year = 2000\n    AND cr_returning_addr_sk = ca_address_sk \n  GROUP BY cr_returning_customer_sk, ca_state\n),\nstate_avg AS (\n  SELECT \n    ctr_state,\n    AVG(ctr_total_return)*1.2 AS threshold\n  FROM customer_total_return\n  GROUP BY ctr_state\n),\nfiltered_ca AS (\n  SELECT * \n  FROM customer_address \n  WHERE ca_state = 'IA'\n)\nSELECT \n  c_customer_id, c_salutation, c_first_name, c_last_name,\n  ca_street_number, ca_street_name, ca_street_type, ca_suite_number,\n  ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset,\n  ca_location_type, ctr_total_return\nFROM customer_total_return ctr1,\n     filtered_ca,\n     customer\nWHERE ctr1.ctr_total_return > (SELECT threshold FROM state_avg WHERE ctr_state = ctr1.ctr_state)\n  AND ca_address_sk = c_current_addr_sk\n  AND ctr1.ctr_customer_sk = c_customer_sk\nORDER BY \n  c_customer_id, c_salutation, c_first_name, c_last_name,\n  ca_street_number, ca_street_name, ca_street_type, ca_suite_number,\n  ca_city, ca_county, ca_state, ca_zip, ca_country, ca_gmt_offset,\n  ca_location_type, ctr_total_return\nLIMIT 100;"
        }
      }
    ]
  }
]