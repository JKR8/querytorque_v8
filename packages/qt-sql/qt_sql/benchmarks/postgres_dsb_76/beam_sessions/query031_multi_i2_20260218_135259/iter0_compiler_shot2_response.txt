[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p03",
    "strategy": "Decompose aggregated CTE into separate quarter-specific CTEs to eliminate post-aggregation filtering and reduce fact scan volume.",
    "hypothesis": "Original ss CTE aggregates all quarters then filters in final self-join; decomposing into three CTEs (ss1, ss2, ss3) with inline quarter filters reduces store_sales scan rows and aggregation load. Evidence from p03 shows intent but execution error; corrected syntax and explicit joins.",
    "expected_explain_delta": "Three separate aggregate scans on store_sales with quarter filters, eliminating late filtering and reducing nested-loop joins in final select.",
    "target_ir": "Replace ss and ws CTEs with six quarter-specific CTEs (ss1, ss2, ss3, ws1, ws2, ws3) and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss1", "ss2", "ss3", "ws1", "ws2", "ws3"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": true,
          "sql": "SELECT ss1.ca_county, ss1.d_year, ws2.web_sales / ws1.web_sales AS web_q1_q2_increase, ss2.store_sales / ss1.store_sales AS store_q1_q2_increase, ws3.web_sales / ws2.web_sales AS web_q2_q3_increase, ss3.store_sales / ss2.store_sales AS store_q2_q3_increase FROM ss1 JOIN ss2 ON ss1.ca_county = ss2.ca_county JOIN ss3 ON ss2.ca_county = ss3.ca_county JOIN ws1 ON ss1.ca_county = ws1.ca_county JOIN ws2 ON ws1.ca_county = ws2.ca_county JOIN ws3 ON ws1.ca_county = ws3.ca_county WHERE CASE WHEN ws1.web_sales > 0 THEN ws2.web_sales / ws1.web_sales ELSE NULL END > CASE WHEN ss1.store_sales > 0 THEN ss2.store_sales / ss1.store_sales ELSE NULL END AND CASE WHEN ws2.web_sales > 0 THEN ws3.web_sales / ws2.web_sales ELSE NULL END > CASE WHEN ss2.store_sales > 0 THEN ss3.store_sales / ss2.store_sales ELSE NULL END ORDER BY ss1.d_year"
        },
        {
          "node_id": "ss1",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ss.ss_ext_sales_price) AS store_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ss.ss_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 1 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ss2",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ss.ss_ext_sales_price) AS store_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ss.ss_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 2 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ss3",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ss.ss_ext_sales_price) AS store_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ss.ss_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 3 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ws1",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ws.ws_ext_sales_price) AS web_sales FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ws.ws_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 1 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ws2",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ws.ws_ext_sales_price) AS web_sales FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ws.ws_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 2 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ws3",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ws.ws_ext_sales_price) AS web_sales FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ws.ws_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy = 3 AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.55,
    "based_on": "p02,p01",
    "strategy": "Convert comma joins to explicit joins and push quarter/year filters into CTEs to reduce fact scan rows, while preserving CTE structure.",
    "hypothesis": "Original comma joins block predicate pushdown; converting to explicit joins and filtering date_dim to only required quarters (1,2,3) and year 1999 reduces store_sales scan volume. Evidence from p02 (0.83x) suggests explicit join conversion alone insufficient; adding early quarter filtering targets the main hotspot.",
    "expected_explain_delta": "Explicit joins with date_dim index scan for d_qoy IN (1,2,3) and d_year=1999, reducing store_sales sequential scan rows.",
    "target_ir": "Update ss and ws CTEs with explicit joins and inline quarter/year filters, keep final_select unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss", "ws"],
          "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
          "changed": false
        },
        {
          "node_id": "ss",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ss.ss_ext_sales_price) AS store_sales FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ss.ss_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy IN (1, 2, 3) AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        },
        {
          "node_id": "ws",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim", "customer_address", "item"],
          "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
          "changed": true,
          "sql": "SELECT ca.ca_county, d.d_qoy, d.d_year, SUM(ws.ws_ext_sales_price) AS web_sales FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk JOIN item i ON ws.ws_item_sk = i.i_item_sk WHERE i.i_color IN ('dark', 'puff') AND i.i_manager_id BETWEEN 15 AND 34 AND ws.ws_list_price BETWEEN 244 AND 258 AND ca.ca_state IN ('KS', 'OH') AND d.d_qoy IN (1, 2, 3) AND d.d_year = 1999 GROUP BY ca.ca_county, d.d_qoy, d.d_year"
        }
      ]
    }
  }
]