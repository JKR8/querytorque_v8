{
  "probe_id": "p0",
  "transform_id": "early_filter",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering dimension tables (date_dim, store, item) into CTEs before joining with fact tables can reduce fact table scan sizes and improve join selectivity. This aligns with the observed poor cardinality estimates and nested loop dominance in the execution plan.",
  "reasoning_trace": [
    "Assigned transform targets early filtering of dimensions to reduce fact table I/O.",
    "Comma-join syntax contributes to poor cardinality estimates; explicit joins with pre-filtered CTEs can help.",
    "Dimension tables (date_dim, store, item) are filtered early using selective predicates.",
    "Fact tables (store_sales, store_returns, catalog_sales) remain unchanged but benefit from smaller dimension inputs."
  ],
  "target_ir": "Dimension tables filtered into CTEs; fact tables joined explicitly with pre-filtered dimensions.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales_filtered", "store_returns_filtered", "catalog_sales_filtered", "d1_filtered", "d2_filtered", "d3_filtered", "store_filtered", "item_filtered"],
        "outputs": ["i_item_id", "i_item_desc", "s_store_id", "s_store_name", "store_sales_profit", "store_returns_loss", "catalog_sales_profit"],
        "changed": true,
        "sql": "SELECT i_item_id, i_item_desc, s_store_id, s_store_name, MAX(ss_net_profit) AS store_sales_profit, MAX(sr_net_loss) AS store_returns_loss, MAX(cs_net_profit) AS catalog_sales_profit FROM store_sales_filtered ss JOIN store_returns_filtered sr ON ss.ss_customer_sk = sr.sr_customer_sk AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN catalog_sales_filtered cs ON sr.sr_customer_sk = cs.cs_bill_customer_sk AND sr.sr_item_sk = cs.cs_item_sk JOIN d1_filtered d1 ON d1.d_date_sk = ss.ss_sold_date_sk JOIN d2_filtered d2 ON d2.d_date_sk = sr.sr_returned_date_sk JOIN d3_filtered d3 ON d3.d_date_sk = cs.cs_sold_date_sk JOIN store_filtered s ON s.s_store_sk = ss.ss_store_sk JOIN item_filtered i ON i.i_item_sk = ss.ss_item_sk GROUP BY i_item_id, i_item_desc, s_store_id, s_store_name ORDER BY i_item_id, i_item_desc, s_store_id, s_store_name LIMIT 100"
      },
      {
        "node_id": "d1_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_moy = 3 AND d_year = 1999"
      },
      {
        "node_id": "d2_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 3 AND 3 + 2 AND d_year = 1999"
      },
      {
        "node_id": "d3_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 3 AND 3 + 2 AND d_year = 1999"
      },
      {
        "node_id": "store_filtered",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_store_id", "s_store_name"],
        "changed": true,
        "sql": "SELECT s_store_sk, s_store_id, s_store_name FROM store"
      },
      {
        "node_id": "item_filtered",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_item_id", "i_item_desc"],
        "changed": true,
        "sql": "SELECT i_item_sk, i_item_id, i_item_desc FROM item"
      },
      {
        "node_id": "store_sales_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_sales"],
        "outputs": ["ss_sold_date_sk", "ss_item_sk", "ss_store_sk", "ss_customer_sk", "ss_ticket_number", "ss_net_profit"],
        "changed": true,
        "sql": "SELECT ss_sold_date_sk, ss_item_sk, ss_store_sk, ss_customer_sk, ss_ticket_number, ss_net_profit FROM store_sales"
      },
      {
        "node_id": "store_returns_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_returns"],
        "outputs": ["sr_returned_date_sk", "sr_item_sk", "sr_customer_sk", "sr_ticket_number", "sr_net_loss"],
        "changed": true,
        "sql": "SELECT sr_returned_date_sk, sr_item_sk, sr_customer_sk, sr_ticket_number, sr_net_loss FROM store_returns"
      },
      {
        "node_id": "catalog_sales_filtered",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales"],
        "outputs": ["cs_sold_date_sk", "cs_item_sk", "cs_bill_customer_sk", "cs_net_profit"],
        "changed": true,
        "sql": "SELECT cs_sold_date_sk, cs_item_sk, cs_bill_customer_sk, cs_net_profit FROM catalog_sales"
      }
    ]
  }
}