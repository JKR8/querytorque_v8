{
  "plan_id": "eliminate_self_join_via_pivot",
  "dialect": "postgres",
  "description": "Restructure CTEs to compute quarterly aggregates in a single row per county, eliminating self-joins.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "ss"
      },
      "payload": {
        "sql_fragment": "ss AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS q1_store, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS q2_store, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS q3_store FROM store_sales, date_dim, customer_address, item WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk AND ss_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year)"
      },
      "description": "Replace CTE 'ss' with pivoted quarterly aggregates"
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0",
        "by_label": "ws"
      },
      "payload": {
        "sql_fragment": "ws AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price ELSE 0 END) AS q1_web, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price ELSE 0 END) AS q2_web, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price ELSE 0 END) AS q3_web FROM web_sales, date_dim, customer_address, item WHERE ws_sold_date_sk = d_date_sk AND ws_bill_addr_sk = ca_address_sk AND ws_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA','IL') AND d_year = 1998 AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year)"
      },
      "description": "Replace CTE 'ws' with pivoted quarterly aggregates"
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "ss, ws"
      },
      "description": "Replace FROM clause to join only once per CTE"
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "expr_sql": "ss.ca_county = ws.ca_county AND ss.d_year = ws.d_year AND (CASE WHEN ws.q1_web > 0 THEN ws.q2_web / ws.q1_web ELSE NULL END) > (CASE WHEN ss.q1_store > 0 THEN ss.q2_store / ss.q1_store ELSE NULL END) AND (CASE WHEN ws.q2_web > 0 THEN ws.q3_web / ws.q2_web ELSE NULL END) > (CASE WHEN ss.q2_store > 0 THEN ss.q3_store / ss.q2_store ELSE NULL END)"
      },
      "description": "Replace WHERE clause with simplified conditions using pivoted columns"
    }
  ]
}