Worker Role: W4
Family: B+A
Transform: pivot_quarters_with_early_filters
Status: OK

--- OUTPUT SQL ---
WITH ss AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM store_sales, date_dim, customer_address, item WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk AND ss_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') GROUP BY ca_county, d_qoy, d_year), ws AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM web_sales, date_dim, customer_address, item WHERE ws_sold_date_sk = d_date_sk AND ws_bill_addr_sk = ca_address_sk AND ws_item_sk = i_item_sk AND i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') GROUP BY ca_county, d_qoy, d_year), ss_filtered AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN item ON ss_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ss_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') AND d_year = 1998 AND d_qoy IN (1, 2, 3) GROUP BY ca_county, d_qoy, d_year), ws_filtered AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk JOIN item ON ws_item_sk = i_item_sk WHERE i_color IN ('navajo', 'orchid') AND i_manager_id BETWEEN 8 AND 27 AND ws_list_price BETWEEN 86 AND 100 AND ca_state IN ('IA', 'IL') AND d_year = 1998 AND d_qoy IN (1, 2, 3) GROUP BY ca_county, d_qoy, d_year), ss_pivoted AS (SELECT ca_county, MAX(CASE WHEN d_qoy = 1 THEN store_sales END) AS q1_store_sales, MAX(CASE WHEN d_qoy = 2 THEN store_sales END) AS q2_store_sales, MAX(CASE WHEN d_qoy = 3 THEN store_sales END) AS q3_store_sales FROM ss_filtered GROUP BY ca_county), ws_pivoted AS (SELECT ca_county, MAX(CASE WHEN d_qoy = 1 THEN web_sales END) AS q1_web_sales, MAX(CASE WHEN d_qoy = 2 THEN web_sales END) AS q2_web_sales, MAX(CASE WHEN d_qoy = 3 THEN web_sales END) AS q3_web_sales FROM ws_filtered GROUP BY ca_county) SELECT ss_pivoted.ca_county, 1998 AS d_year, (CAST(q2_web_sales AS DOUBLE PRECISION) / NULLIF(q1_web_sales, 0)) AS web_q1_q2_increase, (CAST(q2_store_sales AS DOUBLE PRECISION) / NULLIF(q1_store_sales, 0)) AS store_q1_q2_increase, (CAST(q3_web_sales AS DOUBLE PRECISION) / NULLIF(q2_web_sales, 0)) AS web_q2_q3_increase, (CAST(q3_store_sales AS DOUBLE PRECISION) / NULLIF(q2_store_sales, 0)) AS store_q2_q3_increase FROM ss_pivoted JOIN ws_pivoted ON ss_pivoted.ca_county = ws_pivoted.ca_county WHERE (CASE WHEN q1_web_sales > 0 THEN CAST(q2_web_sales AS DOUBLE PRECISION) / q1_web_sales ELSE NULL END) > (CASE WHEN q1_store_sales > 0 THEN CAST(q2_store_sales AS DOUBLE PRECISION) / q1_store_sales ELSE NULL END) AND (CASE WHEN q2_web_sales > 0 THEN CAST(q3_web_sales AS DOUBLE PRECISION) / q2_web_sales ELSE NULL END) > (CASE WHEN q2_store_sales > 0 THEN CAST(q3_store_sales AS DOUBLE PRECISION) / q2_store_sales ELSE NULL END) ORDER BY d_year;