### Step 1 — Compare EXPLAIN Plans

**Analysis of t2 (REGRESSION):**
- **Original expensive operator:**  
  `CTE Scan (ss1)  (rows=10, time=414.272)`  
  **t2 regression operator:**  
  `CTE Scan (ss1)  (rows=10, time=620.859)`  
- **Why regression occurred:**  
  Pushing `d_year=1998` and `d_qoy IN (1,2,3)` into CTEs (Family A) caused the planner to abandon efficient index scans on `item` and `store_sales`. Instead, it used a sequential scan on `date_dim` and index-only scan on `store_sales`, increasing intermediate rows from 134 → 137 (`date_dim`) and 12 → 1,106 (`store_sales`). This inflated the CTE build cost.

**Other patches (FAIL):**  
- **t1/syn_w2 (Family B/F):** Failed due to syntax errors in pivot logic, but core idea (eliminating 6 self-joins via quarterly pivoting) was structurally sound.  
- **t3 (Family E):** Failed due to transaction errors, but prefetching dimensions could reduce fact-table scans if implemented correctly.

**No winners yet** — all patches failed or regressed. Focus shifts to combining structural insights.

---

### Step 2 — Design Targets

**Primary Bottleneck:**  
`CTE Scan (ss1)` (414 ms) due to expensive `store_sales` join aggregation. Secondary issue: self-joins over CTEs.

**Target 1: Combine Family B + Family A (Rescue pivot + filter pushdown)**  
- **Hypothesis:** Pivot quarterly sales in CTEs (B) to eliminate 6 self-joins, while pushing `d_year`/`d_qoy` filters (A) to reduce CTE build cost. Targets `ss1` CTE scan (414 ms) and self-join nested loops.  
- **Target IR:**  
  `S0:by_anchor_hash(77303f134dcec6fc)` (main query WHERE) for pivot +  
  `S0:by_anchor_hash(e330e84b5ecc3b92)` (ss CTE WHERE) for filter pushdown  

**Target 2: Family E + Family B (Prefetch dimensions + pivot)**  
- **Hypothesis:** Prefilter small dimensions (`item`, `customer_address`) to reduce fact-table rows (E), then apply quarterly pivot (B) to eliminate self-joins. Targets `Index Scan on item` (74 ms) and `CTE Scan (ss1)`.  
- **Target IR:**  
  `S0:by_node_id(S0)` for dimension CTEs +  
  `S0:by_anchor_hash(77303f134dcec6fc)` for pivot  

**Target 3: Family F + Family A (Explicit joins + filter pushdown)**  
- **Hypothesis:** Replace comma joins with explicit `INNER JOIN` and enforce optimal dimension→fact order (F) while pushing `d_year`/`d_qoy` filters (A). Targets `Nested Loop` on `store_sales` (402 ms).  
- **Target IR:**  
  `S0:by_anchor_hash(e330e84b5ecc3b92)` (ss CTE FROM) for join order  

**Target 4: Family C (Aggregation pushdown for web_sales)**  
- **Hypothesis:** Aggregate `web_sales` before joining to `date_dim`/`customer_address` since `ca_county` is a join key. Reduces rows early for `ws` CTE.  
- **Target IR:**  
  `S0:by_anchor_hash(51cf109531413dcd)` (ws CTE GROUP BY)  

```json
[
  {
    "family": "B+A",
    "transform": "pivot_quarters_with_early_filters",
    "target_id": "t1",
    "relevance_score": 0.95,
    "hypothesis": "Eliminate 6 self-joins via quarterly pivoting (B) while pushing year/quarter filters into CTEs (A) to reduce build cost. Targets CTE Scan (ss1) (414ms) and nested loops.",
    "target_ir": "S0:by_anchor_hash(77303f134dcec6fc) + S0:by_anchor_hash(e330e84b5ecc3b92)",
    "recommended_examples": ["shared_scan_decorrelate", "pg_date_cte_explicit_join"]
  },
  {
    "family": "E+B",
    "transform": "prefilter_dimensions_then_pivot",
    "target_id": "t2",
    "relevance_score": 0.85,
    "hypothesis": "Prefetch filtered dimensions (E) to reduce fact-table rows, then apply quarterly pivot (B) to eliminate self-joins. Targets Index Scan on item (74ms) and CTE Scan (ss1).",
    "target_ir": "S0:by_node_id(S0) + S0:by_anchor_hash(77303f134dcec6fc)",
    "recommended_examples": ["multi_dimension_prefetch", "pg_shared_scan_decorrelate"]
  },
  {
    "family": "F+A",
    "transform": "explicit_joins_with_filter_pushdown",
    "target_id": "t3",
    "relevance_score": 0.80,
    "hypothesis": "Enforce optimal dimension→fact join order via explicit JOINs (F) while pushing year/quarter filters (A). Targets Nested Loop on store_sales (402ms).",
    "target_ir": "S0:by_anchor_hash(e330e84b5ecc3b92)",
    "recommended_examples": ["pg_explicit_join_materialized", "pg_date_cte_explicit_join"]
  },
  {
    "family": "C",
    "transform": "early_aggregate_web_sales",
    "target_id": "t4",
    "relevance_score": 0.75,
    "hypothesis": "Aggregate web_sales before joining to dimensions since ca_county is a join key. Reduces input rows to ws CTE.",
    "target_ir": "S0:by_anchor_hash(51cf109531413dcd)",
    "recommended_examples": ["pg_materialized_dimension_fact_prefilter"]
  }
]
```