{
  "probe_id": "p0",
  "transform_id": "union_cte_split",
  "family": "D",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Splitting the ss and ws CTEs into specialized variants by d_qoy and d_year reduces redundant computation and avoids post-grouping filters.",
  "reasoning_trace": [
    "Assigned transform targets CTE specialization to avoid post-aggregation filtering.",
    "Each CTE (ss, ws) is scanned multiple times with different quarter/year filters.",
    "Embedding filters directly in new CTEs aligns with specialization principle.",
    "New CTEs preserve all required columns and grouping keys for downstream joins."
  ],
  "target_ir": "ss and ws CTEs split into ss_q1, ss_q2, ss_q3 and ws_q1, ws_q2, ws_q3 specialized by d_qoy and d_year.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["ss_q1", "ss_q2", "ss_q3", "ws_q1", "ws_q2", "ws_q3"],
        "outputs": ["ca_county", "d_year", "web_q1_q2_increase", "store_q1_q2_increase", "web_q2_q3_increase", "store_q2_q3_increase"],
        "changed": true,
        "sql": "select\n        ss1.ca_county\n       ,ss1.d_year\n       ,ws2.web_sales/ws1.web_sales web_q1_q2_increase\n       ,ss2.store_sales/ss1.store_sales store_q1_q2_increase\n       ,ws3.web_sales/ws2.web_sales web_q2_q3_increase\n       ,ss3.store_sales/ss2.store_sales store_q2_q3_increase\n from\n        ss_q1 ss1\n       ,ss_q2 ss2\n       ,ss_q3 ss3\n       ,ws_q1 ws1\n       ,ws_q2 ws2\n       ,ws_q3 ws3\n where\n    ss1.d_qoy = 1\n    and ss1.d_year = 1998\n    and ss1.ca_county = ss2.ca_county\n    and ss2.d_qoy = 2\n    and ss2.d_year = 1998\n and ss2.ca_county = ss3.ca_county\n    and ss3.d_qoy = 3\n    and ss3.d_year = 1998\n    and ss1.ca_county = ws1.ca_county\n    and ws1.d_qoy = 1\n    and ws1.d_year = 1998\n    and ws1.ca_county = ws2.ca_county\n    and ws2.d_qoy = 2\n    and ws2.d_year = 1998\n    and ws1.ca_county = ws3.ca_county\n    and ws3.d_qoy = 3\n    and ws3.d_year =1998\n    and case when ws1.web_sales > 0 then ws2.web_sales/ws1.web_sales else null end\n       > case when ss1.store_sales > 0 then ss2.store_sales/ss1.store_sales else null end\n    and case when ws2.web_sales > 0 then ws3.web_sales/ws2.web_sales else null end\n       > case when ss2.store_sales > 0 then ss3.store_sales/ss2.store_sales else null end\n order by ss1.d_year"
      },
      {
        "node_id": "ss_q1",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ss_ext_sales_price) as store_sales\n from store_sales,date_dim,customer_address, item\n where ss_sold_date_sk = d_date_sk\n  and ss_addr_sk=ca_address_sk\n  and ss_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ss_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 1\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      },
      {
        "node_id": "ss_q2",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ss_ext_sales_price) as store_sales\n from store_sales,date_dim,customer_address, item\n where ss_sold_date_sk = d_date_sk\n  and ss_addr_sk=ca_address_sk\n  and ss_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ss_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 2\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      },
      {
        "node_id": "ss_q3",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "store_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ss_ext_sales_price) as store_sales\n from store_sales,date_dim,customer_address, item\n where ss_sold_date_sk = d_date_sk\n  and ss_addr_sk=ca_address_sk\n  and ss_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ss_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 3\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      },
      {
        "node_id": "ws_q1",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ws_ext_sales_price) as web_sales\n from web_sales,date_dim,customer_address, item\n where ws_sold_date_sk = d_date_sk\n  and ws_bill_addr_sk=ca_address_sk\n  and ws_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ws_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 1\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      },
      {
        "node_id": "ws_q2",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ws_ext_sales_price) as web_sales\n from web_sales,date_dim,customer_address, item\n where ws_sold_date_sk = d_date_sk\n  and ws_bill_addr_sk=ca_address_sk\n  and ws_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ws_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 2\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      },
      {
        "node_id": "ws_q3",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "customer_address", "item"],
        "outputs": ["ca_county", "d_qoy", "d_year", "web_sales"],
        "changed": true,
        "sql": "select ca_county,d_qoy, d_year,sum(ws_ext_sales_price) as web_sales\n from web_sales,date_dim,customer_address, item\n where ws_sold_date_sk = d_date_sk\n  and ws_bill_addr_sk=ca_address_sk\n  and ws_item_sk = i_item_sk\n  and i_color IN ('navajo', 'orchid')\n  and i_manager_id BETWEEN 8 and 27\n  and ws_list_price between 86 and 100\n  and ca_state in ('IA','IL')\n  and d_qoy = 3\n  and d_year = 1998\ngroup by ca_county,d_qoy, d_year"
      }
    ]
  }
}