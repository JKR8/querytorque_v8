{
  "probe_id": "p12",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Converting comma joins in final select to explicit JOIN syntax and isolating date dimension filters into CTEs enables better optimizer decisions and early filtering.",
  "reasoning_trace": [
    "Assigned transform targets comma joins in final select for explicit JOIN conversion.",
    "Date dimension filters are isolated into CTEs to enable early filtering and better cardinality estimates.",
    "Explicit JOIN syntax allows better join ordering and avoids nested loop amplification."
  ],
  "target_ir": "final_select node rewritten with explicit JOINs and date filters isolated in new CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "cross_items",
        "parent_node_id": "final_select",
        "sources": ["item", "web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["ss_item_sk"],
        "changed": false
      },
      {
        "node_id": "avg_sales",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["average_sales"],
        "changed": false
      },
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "item", "date_dim", "avg_sales", "cross_items"],
        "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
        "changed": true,
        "sql": "with date_filter_this_year as (\n  select d_date_sk\n  from date_dim\n  where d_year = 1999 + 1\n    and d_moy = 12\n    and d_dom = 20\n),\ndate_filter_last_year as (\n  select d_date_sk\n  from date_dim\n  where d_year = 1999\n    and d_moy = 12\n    and d_dom = 20\n)\nselect \n  this_year.channel ty_channel,\n  this_year.i_brand_id ty_brand,\n  this_year.i_class_id ty_class,\n  this_year.i_category_id ty_category,\n  this_year.sales ty_sales,\n  this_year.number_sales ty_number_sales,\n  last_year.channel ly_channel,\n  last_year.i_brand_id ly_brand,\n  last_year.i_class_id ly_class,\n  last_year.i_category_id ly_category,\n  last_year.sales ly_sales,\n  last_year.number_sales ly_number_sales\nfrom (\n  select 'store' channel, i_brand_id, i_class_id, i_category_id,\n         sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n  from store_sales\n  join item on ss_item_sk = i_item_sk\n  join date_filter_this_year on ss_sold_date_sk = d_date_sk\n  where ss_item_sk in (select ss_item_sk from cross_items)\n    and i_category IN ('Electronics', 'Jewelry', 'Men')\n    and i_manager_id BETWEEN 91 and 100\n    and ss_wholesale_cost BETWEEN 35 AND 55\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)\n) this_year\njoin (\n  select 'store' channel, i_brand_id, i_class_id, i_category_id,\n         sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n  from store_sales\n  join item on ss_item_sk = i_item_sk\n  join date_filter_last_year on ss_sold_date_sk = d_date_sk\n  where ss_item_sk in (select ss_item_sk from cross_items)\n    and i_category IN ('Electronics', 'Jewelry', 'Men')\n    and i_manager_id BETWEEN 91 and 100\n    and ss_wholesale_cost BETWEEN 35 AND 55\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)\n) last_year on this_year.i_brand_id = last_year.i_brand_id\n  and this_year.i_class_id = last_year.i_class_id\n  and this_year.i_category_id = last_year.i_category_id\norder by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\nlimit 100"
      }
    ]
  }
}