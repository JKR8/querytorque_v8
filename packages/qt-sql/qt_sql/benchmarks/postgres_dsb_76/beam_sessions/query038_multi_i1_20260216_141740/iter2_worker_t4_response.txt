{
  "plan_id": "postgres_explicit_join_materialized_hot_cust",
  "dialect": "postgres",
  "description": "Restructure comma joins to explicit INNER JOINs and materialize filtered customer and date dimensions into CTEs. This leverages index access paths on customer and reduces the scan size of sales tables.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_customers",
        "cte_query_sql": "SELECT c_customer_sk, c_first_name, c_last_name FROM customer WHERE c_birth_month IN (1, 2, 5, 12)"
      },
      "description": "Insert CTE 'filtered_customers' to prefilter customer rows based on birth month"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1200 + 11"
      },
      "description": "Insert CTE 'filtered_dates' to prefilter date dimension"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "WITH filtered_customers AS (SELECT c_customer_sk, c_first_name, c_last_name FROM customer WHERE c_birth_month IN (1, 2, 5, 12)), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1200 + 11) SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales INNER JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk INNER JOIN filtered_customers ON store_sales.ss_customer_sk = filtered_customers.c_customer_sk WHERE ss_list_price BETWEEN 193 AND 252 AND ss_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales INNER JOIN filtered_dates ON catalog_sales.cs_sold_date_sk = filtered_dates.d_date_sk INNER JOIN filtered_customers ON catalog_sales.cs_bill_customer_sk = filtered_customers.c_customer_sk WHERE cs_list_price BETWEEN 193 AND 252 AND cs_wholesale_cost BETWEEN 35 AND 55 INTERSECT SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales INNER JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk INNER JOIN filtered_customers ON web_sales.ws_bill_customer_sk = filtered_customers.c_customer_sk WHERE ws_list_price BETWEEN 193 AND 252 AND ws_wholesale_cost BETWEEN 35 AND 55) hot_cust LIMIT 100"
      },
      "description": "Replace main query body with rewritten version using explicit joins and referencing materialized CTEs"
    }
  ]
}