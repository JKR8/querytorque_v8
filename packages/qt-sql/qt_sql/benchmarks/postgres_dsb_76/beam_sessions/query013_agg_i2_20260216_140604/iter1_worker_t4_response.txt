{
  "plan_id": "postgres_fact_table_materialize",
  "dialect": "postgres",
  "description": "Materialize store_sales after date filter to avoid repeated index scans. Join pre-aggregated fact rows with dimensions to reduce nested loop cost.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_dates",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
      },
      "description": "Insert CTE 'filtered_dates' for date dimension filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_sales",
        "cte_query_sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_hdemo_sk, ss_cdemo_sk, ss_addr_sk, ss_store_sk, ss_net_profit FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk"
      },
      "description": "Insert CTE 'filtered_sales' containing fact table rows post date filtering"
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "filtered_sales fs JOIN store s ON fs.ss_store_sk = s.s_store_sk JOIN customer_demographics cd ON fs.ss_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON fs.ss_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON fs.ss_addr_sk = ca.ca_address_sk"
      },
      "description": "Replace FROM clause with explicit JOINs using filtered_sales CTE"
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "a6beaa832eeb7899"
      },
      "payload": {
        "expr_sql": "((hd.hd_demo_sk = fs.ss_hdemo_sk AND cd.cd_demo_sk = fs.ss_cdemo_sk AND cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND fs.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (hd.hd_demo_sk = fs.ss_hdemo_sk AND cd.cd_demo_sk = fs.ss_cdemo_sk AND cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (hd.hd_demo_sk = fs.ss_hdemo_sk AND cd.cd_demo_sk = fs.ss_cdemo_sk AND cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND fs.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ca.ca_address_sk = fs.ss_addr_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND fs.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_address_sk = fs.ss_addr_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND fs.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_address_sk = fs.ss_addr_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND fs.ss_net_profit BETWEEN 50 AND 250))"
      },
      "description": "Replace WHERE clause with rewritten predicates referencing CTE aliases"
    }
  ]
}