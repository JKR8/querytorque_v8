[  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p05",
    "strategy": "Explicit joins with early d_moy filter",
    "hypothesis": "Explicit JOINs improve optimizer's join order selection; filtering d_moy early reduces CTE's aggregation workload",
    "target_ir": "CTE with explicit JOINs and d_moy pre-filter",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM inventory JOIN item ON inventory.inv_item_sk = item.i_item_sk JOIN warehouse ON inventory.inv_warehouse_sk = warehouse.w_warehouse_sk JOIN date_dim ON inventory.inv_date_sk = date_dim.d_date_sk"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "ceb681f4fee117f7"},
        "payload": {
          "sql_fragment": "d_moy IN (5, 6)"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p07",
    "strategy": "Decompose CTE into month-specific CTEs",
    "hypothesis": "Split aggregation into separate CTEs for each d_moy, reducing processed data per CTE",
    "target_ir": "Two CTEs (inv5, inv6) filtered by d_moy",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_block_with_cte_pair",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte1_name": "inv5",
          "cte1_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) stdev, AVG(inv_quantity_on_hand) mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 AND d_moy = 5 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1",
          "cte2_name": "inv6",
          "cte2_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, stdev, mean, CASE mean WHEN 0 THEN NULL ELSE stdev / mean END cov FROM (SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, STDDEV_SAMP(inv_quantity_on_hand) stdev, AVG(inv_quantity_on_hand) mean FROM inventory JOIN item ON inv_item_sk = i_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN date_dim ON inv_date_sk = d_date_sk WHERE d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991 AND d_moy = 6 GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy) foo WHERE CASE mean WHEN 0 THEN 0 ELSE stdev / mean END > 1"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM inv5, inv6"
        }
      }
    ]
  }
]