[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p05",
    "strategy": "Explicit joins with early d_moy filter",
    "hypothesis": "Convert comma joins to explicit JOINs and push d_moy filter into CTE to reduce aggregation rows. EXPLAIN showed full scan without early filtering, reducing rows before aggregation should lower memory/cpu.",
    "target_ir": "CTE with explicit joins and d_moy filter, main query with explicit join",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH inv AS (\n  SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n         stdev, mean,\n         CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n  FROM (\n    SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n           STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n           AVG(inv.inv_quantity_on_hand) AS mean\n    FROM inventory inv\n    JOIN item i ON inv.inv_item_sk = i.i_item_sk\n    JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n    JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n    WHERE d.d_year = 2002\n      AND i.i_category IN ('Shoes', 'Sports')\n      AND i.i_manager_id BETWEEN 42 AND 61\n      AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n      AND d.d_moy IN (5, 6)\n    GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n  ) AS foo\n  WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n)\nSELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n       inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov\nFROM inv inv1\nJOIN inv inv2 \n  ON inv1.i_item_sk = inv2.i_item_sk\n AND inv1.w_warehouse_sk = inv2.w_warehouse_sk\nWHERE inv1.d_moy = 5\n  AND inv2.d_moy = 6\nORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n         inv2.d_moy, inv2.mean, inv2.cov;"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "WITH inv AS (\n  SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n         stdev, mean,\n         CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n  FROM (\n    SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n           STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n           AVG(inv.inv_quantity_on_hand) AS mean\n    FROM inventory inv\n    JOIN item i ON inv.inv_item_sk = i.i_item_sk\n    JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n    JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n    WHERE d.d_year = 2002\n      AND i.i_category IN ('Shoes', 'Sports')\n      AND i.i_manager_id BETWEEN 42 AND 61\n      AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n      AND d.d_moy IN (5, 6)\n    GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n  ) AS foo\n  WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n)\nSELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n       inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov\nFROM inv inv1\nJOIN inv inv2 \n  ON inv1.i_item_sk = inv2.i_item_sk\n AND inv1.w_warehouse_sk = inv2.w_warehouse_sk\nWHERE inv1.d_moy = 5\n  AND inv2.d_moy = 6\n  AND inv1.cov > 1.5\nORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov,\n         inv2.d_moy, inv2.mean, inv2.cov;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p07",
    "strategy": "Month-split CTE decomposition",
    "hypothesis": "Split CTE into month-specific aggregates to avoid materializing unused months. EXPLAIN showed full CTE scan for all months before self-join filtering.",
    "target_ir": "Two CTEs (inv5/inv6) with month filters, main query joining them directly",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH \n  inv5 AS (\n    SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n           stdev, mean,\n           CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n    FROM (\n      SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n             STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n             AVG(inv.inv_quantity_on_hand) AS mean\n      FROM inventory inv\n      JOIN item i ON inv.inv_item_sk = i.i_item_sk\n      JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n      JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n      WHERE d.d_year = 2002\n        AND i.i_category IN ('Shoes', 'Sports')\n        AND i.i_manager_id BETWEEN 42 AND 61\n        AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n        AND d.d_moy = 5\n      GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n    ) AS foo\n    WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n  ),\n  inv6 AS (\n    SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n           stdev, mean,\n           CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n    FROM (\n      SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n             STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n             AVG(inv.inv_quantity_on_hand) AS mean\n      FROM inventory inv\n      JOIN item i ON inv.inv_item_sk = i.i_item_sk\n      JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n      JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n      WHERE d.d_year = 2002\n        AND i.i_category IN ('Shoes', 'Sports')\n        AND i.i_manager_id BETWEEN 42 AND 61\n        AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n        AND d.d_moy = 6\n      GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n    ) AS foo\n    WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n  )\nSELECT \n  inv5.w_warehouse_sk, inv5.i_item_sk, inv5.d_moy, inv5.mean, inv5.cov,\n  inv6.w_warehouse_sk, inv6.i_item_sk, inv6.d_moy, inv6.mean, inv6.cov\nFROM inv5\nJOIN inv6 \n  ON inv5.i_item_sk = inv6.i_item_sk\n AND inv5.w_warehouse_sk = inv6.w_warehouse_sk\nORDER BY \n  inv5.w_warehouse_sk, inv5.i_item_sk, inv5.d_moy, inv5.mean, inv5.cov,\n  inv6.d_moy, inv6.mean, inv6.cov;"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "S1"},
        "payload": {
          "sql_fragment": "WITH \n  inv5 AS (\n    SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n           stdev, mean,\n           CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n    FROM (\n      SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n             STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n             AVG(inv.inv_quantity_on_hand) AS mean\n      FROM inventory inv\n      JOIN item i ON inv.inv_item_sk = i.i_item_sk\n      JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n      JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n      WHERE d.d_year = 2002\n        AND i.i_category IN ('Shoes', 'Sports')\n        AND i.i_manager_id BETWEEN 42 AND 61\n        AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n        AND d.d_moy = 5\n      GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n    ) AS foo\n    WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n  ),\n  inv6 AS (\n    SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy,\n           stdev, mean,\n           CASE mean WHEN 0 THEN NULL ELSE stdev/mean END AS cov\n    FROM (\n      SELECT w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy,\n             STDDEV_SAMP(inv.inv_quantity_on_hand) AS stdev,\n             AVG(inv.inv_quantity_on_hand) AS mean\n      FROM inventory inv\n      JOIN item i ON inv.inv_item_sk = i.i_item_sk\n      JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk\n      JOIN date_dim d ON inv.inv_date_sk = d.d_date_sk\n      WHERE d.d_year = 2002\n        AND i.i_category IN ('Shoes', 'Sports')\n        AND i.i_manager_id BETWEEN 42 AND 61\n        AND inv.inv_quantity_on_hand BETWEEN 791 AND 991\n        AND d.d_moy = 6\n      GROUP BY w.w_warehouse_name, w.w_warehouse_sk, i.i_item_sk, d.d_moy\n    ) AS foo\n    WHERE CASE mean WHEN 0 THEN 0 ELSE stdev/mean END > 1\n  )\nSELECT \n  inv5.w_warehouse_sk, inv5.i_item_sk, inv5.d_moy, inv5.mean, inv5.cov,\n  inv6.w_warehouse_sk, inv6.i_item_sk, inv6.d_moy, inv6.mean, inv6.cov\nFROM inv5\nJOIN inv6 \n  ON inv5.i_item_sk = inv6.i_item_sk\n AND inv5.w_warehouse_sk = inv6.w_warehouse_sk\nWHERE inv5.cov > 1.5\nORDER BY \n  inv5.w_warehouse_sk, inv5.i_item_sk, inv5.d_moy, inv5.mean, inv5.cov,\n  inv6.d_moy, inv6.mean, inv6.cov;"
        }
      }
    ]
  }
]