{
  "probe_id": "p01",
  "transform_id": "self_join_decomposition",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Split the single CTE into a base aggregation CTE and two filtered CTEs (inv5, inv6) to avoid full materialization of unused months and enable index-friendly filtering before self-join.",
  "reasoning_trace": [
    "Original query self-joins the same CTE with d_moy=5 and d_moy=6, causing full CTE materialization.",
    "Decompose into inv_base (aggregation without d_moy filter), then derive inv5 and inv6 with WHERE clauses.",
    "Preserve cov calculation and d_year=2002 filter in base CTE."
  ],
  "target_ir": "CTE inv_base computes aggregates; inv5 and inv6 are filtered projections; main query joins inv5 and inv6.",
  "steps": [
    {
      "step_id": "s1",
      "op": "wrap_query_with_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "inv_base",
        "cte_query_sql": "SELECT w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean FROM inventory,item,warehouse,date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 and 61 AND inv_quantity_on_hand between 791 and 991 GROUP BY w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "inv5",
        "cte_query_sql": "SELECT *, case mean when 0 then null else stdev/mean end cov FROM inv_base WHERE d_moy = 5 AND case mean when 0 then 0 else stdev/mean end > 1"
      }
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "inv6",
        "cte_query_sql": "SELECT *, case mean when 0 then null else stdev/mean end cov FROM inv_base WHERE d_moy = 6 AND case mean when 0 then 0 else stdev/mean end > 1"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "inv5, inv6"
      }
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "inv5.i_item_sk = inv6.i_item_sk AND inv5.w_warehouse_sk = inv6.w_warehouse_sk"
      }
    }
  ]
}