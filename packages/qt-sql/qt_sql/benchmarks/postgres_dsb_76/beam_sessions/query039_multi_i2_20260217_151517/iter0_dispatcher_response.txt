{
  "dispatch": {
    "dialect": "postgres",
    "importance_stars": 2,
    "probe_count": 10,
    "early_stop": false,
    "equivalence_tier": "unordered",
    "hypothesis": "Bottleneck likely in CTE materialization and self-join. The CTE aggregates 133M+ inventory rows after joining 4 tables with filters. Self-join then processes two full CTE instances. Late d_moy filtering wastes aggregation work on unused months.",
    "reasoning_trace": [
      "CTE scans inventory (133M rows) joined with 3 dimensions",
      "Self-join on CTE output requires full materialization before filtering d_moy",
      "Comma joins in CTE prevent optimal join ordering",
      "No index usage evident on inventory filters"
    ],
    "cost_spine": ["CTE aggregation → CTE materialization → Self-join"],
    "hotspots": [
      {"op": "CTE Materialization", "why": "Full year aggregation materialized before month filter", "evidence": "inventory=133M rows, d_moy filtered late"},
      {"op": "Self-Join", "why": "Cartesian risk on warehouse-item combinations", "evidence": "No join condition pushdown into CTE"}
    ],
    "do_not_do": ["or_to_union (bitmap capable)", "exists_to_materialized_cte"]
  },
  "probe_summary_schema": [
    "probe_id",
    "transform_id",
    "family",
    "status",
    "speedup",
    "expected_explain_delta",
    "ops_used",
    "confidence",
    "exploration",
    "failure_reason",
    "target"
  ],
  "probes": [
    {
      "probe_id": "p01",
      "transform_id": "date_cte_explicit_join",
      "family": "F",
      "target": "Replace comma joins with explicit JOIN syntax in CTE definition. Preserve all existing WHERE conditions.",
      "node_contract": {
        "from_must_include": ["inventory", "item", "warehouse", "date_dim"],
        "where_must_preserve": ["inv_item_sk = i_item_sk", "inv_warehouse_sk = w_warehouse_sk", "inv_date_sk = d_date_sk", "d_year=2002", "i_category IN ('Shoes','Sports')", "i_manager_id BETWEEN 42 AND 61", "inv_quantity_on_hand BETWEEN 791 AND 991"],
        "output_must_preserve": ["w_warehouse_name", "w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean", "cov"]
      },
      "gates_checked": ["comma_join_weakness:PASS"],
      "exploration": false,
      "confidence": 0.92,
      "expected_explain_delta": "Nested Loop replaced by Hash Join, better row estimates",
      "recommended_patch_ops": ["replace_from"],
      "gold_example_id": "postgres_comma_join_fix"
    },
    {
      "probe_id": "p02",
      "transform_id": "pg_self_join_decomposition",
      "family": "E",
      "target": "Materialize filtered monthly aggregates separately: inv5 CTE for d_moy=5, inv6 CTE for d_moy=6. Preserve original cov calculation.",
      "node_contract": {
        "from_must_include": ["inventory", "item", "warehouse", "date_dim"],
        "where_must_preserve": ["d_year=2002", "i_category IN ('Shoes','Sports')", "i_manager_id BETWEEN 42 AND 61", "inv_quantity_on_hand BETWEEN 791 AND 991"],
        "output_must_preserve": ["w_warehouse_sk", "i_item_sk", "mean", "cov"]
      },
      "gates_checked": ["cte_materialization_fence:PASS"],
      "exploration": false,
      "confidence": 0.88,
      "expected_explain_delta": "Eliminate self-join, reduce CTE output size by 10x+",
      "recommended_patch_ops": ["replace_block_with_cte_pair"],
      "gold_example_id": "tpcds_self_join_materialize"
    },
    {
      "probe_id": "p03",
      "transform_id": "dimension_prefetch_star",
      "family": "F",
      "target": "Pre-filter dimensions into CTEs before joining: filtered_date (d_date_sk WHERE d_year=2002), filtered_item (i_item_sk WHERE i_category/managers), tiny_warehouse (all). Preserve join conditions.",
      "node_contract": {
        "from_must_include": ["inventory"],
        "where_must_preserve": ["inv_quantity_on_hand BETWEEN 791 AND 991"],
        "output_must_preserve": ["w_warehouse_sk", "i_item_sk", "d_moy", "stdev", "mean"]
      },
      "gates_checked": ["cross_cte_predicate_blindness:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Plan shows sequential dimension scans. Pre-filtered CTEs create small hash tables for nested loop joins.",
      "confidence": 0.75,
      "expected_explain_delta": "Dimension scans replaced by CTE scans, faster inventory probe",
      "recommended_patch_ops": ["insert_cte", "replace_from"]
    },
    {
      "probe_id": "p04",
      "transform_id": "aggregate_pushdown",
      "family": "C",
      "target": "Pre-aggregate inventory by inv_item_sk/inv_warehouse_sk/inv_date_sk before joining dimensions. Preserve stddev_samp/avg calculations.",
      "node_contract": {
        "from_must_include": ["inventory"],
        "where_must_preserve": ["inv_quantity_on_hand BETWEEN 791 AND 991"],
        "output_must_preserve": ["inv_item_sk", "inv_warehouse_sk", "inv_date_sk", "stdev", "mean"]
      },
      "gates_checked": ["aggregate_below_join_blindness:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Large inventory scan dominates. Pre-aggregation reduces rows before expensive 3-table join.",
      "confidence": 0.68,
      "expected_explain_delta": "Aggregate node moves below joins, reduces join input rows",
      "recommended_patch_ops": ["replace_body"]
    },
    {
      "probe_id": "p05",
      "transform_id": "early_filter",
      "family": "A",
      "target": "Add d_moy IN (5,6) to CTE WHERE clause. Preserve all other filters and calculations.",
      "node_contract": {
        "where_must_preserve": ["d_year=2002"],
        "output_must_preserve": ["d_moy", "cov"]
      },
      "gates_checked": ["no_secondary_filter:PASS"],
      "exploration": false,
      "confidence": 0.95,
      "expected_explain_delta": "Fewer rows aggregated in CTE, smaller materialization",
      "recommended_patch_ops": ["replace_where_predicate"],
      "gold_example_id": "tpcds_early_month_filter"
    },
    {
      "probe_id": "p06",
      "transform_id": "materialize_cte",
      "family": "E",
      "target": "Add MATERIALIZED keyword to CTE definition. Preserve entire CTE logic.",
      "node_contract": {
        "output_must_preserve": ["*"]
      },
      "gates_checked": ["cte_materialization_fence:PASS"],
      "exploration": false,
      "confidence": 0.85,
      "expected_explain_delta": "CTE scan shows Materialize node in EXPLAIN",
      "recommended_patch_ops": ["replace_expr_subtree"]
    },
    {
      "probe_id": "p07",
      "transform_id": "self_join_decomposition",
      "family": "F",
      "target": "Split CTE into inv_base (all except d_moy filter) then derive inv5/inv6 via WHERE d_moy. Preserve cov calculation.",
      "node_contract": {
        "where_must_preserve": ["d_year=2002"],
        "output_must_preserve": ["cov"]
      },
      "gates_checked": ["no_double_scan:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Avoid recalculating aggregates for shared warehouse-item pairs across months",
      "confidence": 0.7,
      "expected_explain_delta": "Single aggregation pass followed by filtered CTEs",
      "recommended_patch_ops": ["wrap_query_with_cte_pair"]
    },
    {
      "probe_id": "p08",
      "transform_id": "sf_sk_pushdown_multi_fact",
      "family": "A",
      "target": "Add d_date_sk BETWEEN to inventory join condition. Preserve existing filters.",
      "node_contract": {
        "where_must_preserve": ["d_year=2002"],
        "output_must_preserve": ["*"]
      },
      "gates_checked": ["non_indexed_date:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Date dimension join may not push d_year to inventory. Explicit key range enables index usage.",
      "confidence": 0.6,
      "expected_explain_delta": "Index scan on inv_date_sk replacing seq scan",
      "recommended_patch_ops": ["replace_join_condition"]
    },
    {
      "probe_id": "p09",
      "transform_id": "inner_join_conversion",
      "family": "F",
      "target": "Convert main query comma join to explicit INNER JOIN. Preserve join conditions and filters.",
      "node_contract": {
        "from_must_include": ["inv inv1", "inv inv2"],
        "where_must_preserve": ["inv1.i_item_sk=inv2.i_item_sk", "inv1.w_warehouse_sk=inv2.w_warehouse_sk"]
      },
      "gates_checked": ["comma_join_weakness:PASS"],
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "Hash join instead of nested loop in main query",
      "recommended_patch_ops": ["replace_from"]
    },
    {
      "probe_id": "p10",
      "transform_id": "deferred_window_aggregation",
      "family": "C",
      "target": "Move stddev_samp/avg calculation to main query after joins. Preserve mathematical equivalence.",
      "node_contract": {
        "output_must_preserve": ["stdev", "mean", "cov"],
        "where_must_preserve": ["inv_quantity_on_hand BETWEEN 791 AND 991"]
      },
      "gates_checked": ["aggregation_equivalence:PASS"],
      "exploration": true,
      "exploration_hypothesis": "Avoid aggregating before dimension joins. Compute stats on pre-filtered dataset.",
      "confidence": 0.65,
      "expected_explain_delta": "Aggregate node moves to final query, CTE outputs raw quantities",
      "recommended_patch_ops": ["replace_select", "replace_body"]
    }
  ],
  "dropped": [
    {"transform_id": "or_to_union", "family": "D", "reason": "PostgreSQL bitmap-or capability"},
    {"transform_id": "intersect_to_exists", "family": "D", "reason": "No INTERSECT operations present"}
  ]
}