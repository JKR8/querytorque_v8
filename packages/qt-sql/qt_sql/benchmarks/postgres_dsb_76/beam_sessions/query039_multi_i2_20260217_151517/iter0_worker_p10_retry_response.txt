{
  "probe_id": "p10",
  "transform_id": "deferred_window_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Defer aggregation to after join filtering to reduce redundant computation on unfiltered inventory rows.",
  "reasoning_trace": [
    "Original CTE aggregates all inventory rows before filtering by d_moy in main query.",
    "PostgreSQL CTE materialization forces full scan and group-by before join pruning."
  ],
  "target_ir": "Raw inventory data in CTE; aggregation moved to derived tables in FROM clause of main query.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "raw_inventory",
        "cte_query_sql": "SELECT w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy, inv_quantity_on_hand FROM inventory, item, warehouse, date_dim WHERE inv_item_sk = i_item_sk AND inv_warehouse_sk = w_warehouse_sk AND inv_date_sk = d_date_sk AND d_year = 2002 AND i_category IN ('Shoes', 'Sports') AND i_manager_id BETWEEN 42 AND 61 AND inv_quantity_on_hand BETWEEN 791 AND 991"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_body",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "SELECT inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.w_warehouse_sk, inv2.i_item_sk, inv2.d_moy, inv2.mean, inv2.cov FROM (SELECT w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean, CASE avg(inv_quantity_on_hand) WHEN 0 THEN NULL ELSE stddev_samp(inv_quantity_on_hand)/avg(inv_quantity_on_hand) END AS cov FROM raw_inventory GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy HAVING CASE avg(inv_quantity_on_hand) WHEN 0 THEN 0 ELSE stddev_samp(inv_quantity_on_hand)/avg(inv_quantity_on_hand) END > 1) inv1, (SELECT w_warehouse_sk, i_item_sk, d_moy, stddev_samp(inv_quantity_on_hand) AS stdev, avg(inv_quantity_on_hand) AS mean, CASE avg(inv_quantity_on_hand) WHEN 0 THEN NULL ELSE stddev_samp(inv_quantity_on_hand)/avg(inv_quantity_on_hand) END AS cov FROM raw_inventory GROUP BY w_warehouse_name, w_warehouse_sk, i_item_sk, d_moy HAVING CASE avg(inv_quantity_on_hand) WHEN 0 THEN 0 ELSE stddev_samp(inv_quantity_on_hand)/avg(inv_quantity_on_hand) END > 1) inv2 WHERE inv1.i_item_sk = inv2.i_item_sk AND inv1.w_warehouse_sk = inv2.w_warehouse_sk AND inv1.d_moy = 5 AND inv2.d_moy = 6 AND inv1.cov > 1.5 ORDER BY inv1.w_warehouse_sk, inv1.i_item_sk, inv1.d_moy, inv1.mean, inv1.cov, inv2.d_moy, inv2.mean, inv2.cov"
      }
    }
  ]
}