{
  "probe_id": "p01",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Decompose the self-join of the large CTE into two month-specific CTEs to eliminate redundant aggregation and reduce materialization size.",
  "reasoning_trace": [
    "Original CTE aggregates all months before filtering, causing redundant work.",
    "Self-join on full CTE forces materialization of unused rows.",
    "Separating d_moy=5 and d_moy=6 into dedicated CTEs avoids cross-month data in each branch."
  ],
  "target_ir": "Two filtered CTEs (inv5, inv6) with d_moy conditions pushed down; main query joins them without self-join.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_block_with_cte_pair",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "with inv5 as\n(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_quantity_on_hand between 791 and 991\n        and d_moy = 5\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo\n where case mean when 0 then 0 else stdev/mean end > 1),\ninv6 as\n(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n       ,stdev,mean, case mean when 0 then null else stdev/mean end cov\n from(select w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy\n            ,stddev_samp(inv_quantity_on_hand) stdev,avg(inv_quantity_on_hand) mean\n      from inventory\n          ,item\n          ,warehouse\n          ,date_dim\n      where inv_item_sk = i_item_sk\n        and inv_warehouse_sk = w_warehouse_sk\n        and inv_date_sk = d_date_sk\n        and d_year =2002\n        and i_category IN ('Shoes', 'Sports')\n        and i_manager_id BETWEEN 42 and 61\n        and inv_quantity_on_hand between 791 and 991\n        and d_moy = 6\n      group by w_warehouse_name,w_warehouse_sk,i_item_sk,d_moy) foo2\n where case mean when 0 then 0 else stdev/mean end > 1)\nselect inv5.w_warehouse_sk,inv5.i_item_sk,inv5.d_moy,inv5.mean, inv5.cov\n        ,inv6.w_warehouse_sk,inv6.i_item_sk,inv6.d_moy,inv6.mean, inv6.cov\nfrom inv5, inv6\nwhere inv5.i_item_sk = inv6.i_item_sk\n  and inv5.w_warehouse_sk =  inv6.w_warehouse_sk\norder by inv5.w_warehouse_sk,inv5.i_item_sk,inv5.d_moy,inv5.mean,inv5.cov\n        ,inv6.d_moy,inv6.mean, inv6.cov"
      }
    }
  ]
}