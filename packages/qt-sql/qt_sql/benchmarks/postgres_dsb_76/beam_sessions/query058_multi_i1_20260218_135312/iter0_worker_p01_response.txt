{
  "probe_id": "p0",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Creating a materialized CTE for the shared date_dim filter and converting comma joins to explicit JOINs will reduce redundant scans and improve join planning.",
  "reasoning_trace": [
    "Three CTEs (ss_items, cs_items, ws_items) each perform identical correlated subqueries on date_dim.",
    "Each subquery executes a full scan of date_dim (36k rows) leading to repeated I/O and CPU.",
    "Materializing the shared date filter into one CTE allows reuse and smaller hash join build side.",
    "Converting comma joins to explicit JOIN syntax enables better join reordering and selectivity propagation."
  ],
  "target_ir": "Add a new CTE `date_filter` that computes the shared d_month_seq filter; rewrite all three channel CTEs to reference it via explicit JOIN.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["ss_items", "cs_items", "ws_items"],
        "outputs": ["item_id", "birth_year", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"],
        "changed": false
      },
      {
        "node_id": "ss_items",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item", "date_filter", "customer"],
        "outputs": ["item_id", "birth_year", "ss_item_rev"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ss_ext_sales_price) AS ss_item_rev FROM store_sales JOIN item ON ss_item_sk = i_item_sk JOIN date_filter ON ss_sold_date_sk = date_filter.d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE ss_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year"
      },
      {
        "node_id": "cs_items",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "item", "date_filter", "customer"],
        "outputs": ["item_id", "birth_year", "cs_item_rev"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(cs_ext_sales_price) AS cs_item_rev FROM catalog_sales JOIN item ON cs_item_sk = i_item_sk JOIN date_filter ON cs_sold_date_sk = date_filter.d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE cs_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year"
      },
      {
        "node_id": "ws_items",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "item", "date_filter", "customer"],
        "outputs": ["item_id", "birth_year", "ws_item_rev"],
        "changed": true,
        "sql": "SELECT i_item_id AS item_id, c_birth_year AS birth_year, SUM(ws_ext_sales_price) AS ws_item_rev FROM web_sales JOIN item ON ws_item_sk = i_item_sk JOIN date_filter ON ws_sold_date_sk = date_filter.d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE ws_list_price BETWEEN 242 AND 271 AND i_manager_id BETWEEN 71 AND 100 AND c_birth_year BETWEEN 1945 AND 1951 GROUP BY i_item_id, c_birth_year"
      },
      {
        "node_id": "date_filter",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')"
      }
    ]
  }
}