{
  "probe_id": "scout_1",
  "transform_id": "materialized_dimension_fact_prefilter",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing selective filters on dimension tables (date_dim, household_demographics, customer_demographics, item) into CTEs reduces non-equi join input sizes. This preserves all output semantics while enabling earlier filtering.",
  "reasoning_trace": [
    "Non-equi join conditions (inv_quantity_on_hand < cs_quantity, d3.d_date > d1.d_date + 3 days) cause row explosion before aggregation.",
    "Selective dimension filters can be pre-applied in MATERIALIZED CTEs to shrink both sides of the non-equi join.",
    "PostgreSQL's materialization ensures filter reuse and avoids recomputation in nested loops."
  ],
  "target_ir": "Dimension tables pre-filtered into MATERIALIZED CTEs; fact tables joined after reduction.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["reduced_catalog_sales", "reduced_inventory"],
        "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
        "changed": true,
        "sql": "SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM reduced_catalog_sales cs JOIN reduced_inventory inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN item i ON i.i_item_sk = cs.cs_item_sk JOIN date_dim d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON inv.inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk LEFT JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 day' GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100"
      },
      {
        "node_id": "reduced_catalog_sales",
        "parent_node_id": "final_select",
        "sources": ["cs_prefiltered"],
        "outputs": ["cs_item_sk", "cs_order_number", "cs_wholesale_cost", "cs_quantity", "cs_bill_cdemo_sk", "cs_bill_hdemo_sk", "cs_sold_date_sk", "cs_ship_date_sk", "cs_promo_sk"],
        "changed": true,
        "sql": "WITH cs_prefiltered AS MATERIALIZED (SELECT cs_item_sk, cs_order_number, cs_wholesale_cost, cs_quantity, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 35 AND 55) SELECT * FROM cs_prefiltered"
      },
      {
        "node_id": "reduced_inventory",
        "parent_node_id": "final_select",
        "sources": ["inv_prefiltered"],
        "outputs": ["inv_item_sk", "inv_warehouse_sk", "inv_date_sk", "inv_quantity_on_hand"],
        "changed": true,
        "sql": "WITH inv_prefiltered AS MATERIALIZED (SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand FROM inventory) SELECT * FROM inv_prefiltered"
      },
      {
        "node_id": "d1_filtered",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_week_seq", "d_year"],
        "changed": true,
        "sql": "WITH d1_filtered AS MATERIALIZED (SELECT d_date_sk, d_week_seq, d_year FROM date_dim WHERE d_year = 1998) SELECT * FROM d1_filtered"
      },
      {
        "node_id": "d2_filtered",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_week_seq"],
        "changed": true,
        "sql": "WITH d2_filtered AS MATERIALIZED (SELECT d_date_sk, d_week_seq FROM date_dim) SELECT * FROM d2_filtered"
      },
      {
        "node_id": "d3_filtered",
        "parent_node_id": null,
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "WITH d3_filtered AS MATERIALIZED (SELECT d_date_sk FROM date_dim) SELECT * FROM d3_filtered"
      },
      {
        "node_id": "hd_filtered",
        "parent_node_id": null,
        "sources": ["household_demographics"],
        "outputs": ["hd_demo_sk", "hd_buy_potential"],
        "changed": true,
        "sql": "WITH hd_filtered AS MATERIALIZED (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT * FROM hd_filtered"
      },
      {
        "node_id": "cd_filtered",
        "parent_node_id": null,
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk", "cd_marital_status", "cd_dep_count"],
        "changed": true,
        "sql": "WITH cd_filtered AS MATERIALIZED (SELECT cd_demo_sk, cd_marital_status, cd_dep_count FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11) SELECT * FROM cd_filtered"
      },
      {
        "node_id": "item_filtered",
        "parent_node_id": null,
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_item_desc", "i_category"],
        "changed": true,
        "sql": "WITH item_filtered AS MATERIALIZED (SELECT i_item_sk, i_item_desc, i_category FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')) SELECT * FROM item_filtered"
      }
    ]
  }
}