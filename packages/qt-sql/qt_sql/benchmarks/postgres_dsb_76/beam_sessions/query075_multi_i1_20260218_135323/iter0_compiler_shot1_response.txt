[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "hypothesis": "Primary hotspot is sequential scans of large returns tables (store_returns, catalog_returns, web_returns) without date pruning; secondary hotspot is aggregating all years in the CTE before filtering to 1999/1998. This rewrite pushes year filter (1998,1999) into each UNION branch via date_dim and converts LEFT JOIN to INNER JOIN (safe due to WHERE clause on returns.reason_sk), reducing I/O and aggregation work.",
    "target_ir": "Modify all_sales CTE to filter date_dim to years 1998-1999 and change LEFT JOIN to INNER JOIN; keep final self-join structure with explicit JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["all_sales"],
          "outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"],
          "changed": true,
          "sql": "SELECT prev_yr.d_year AS prev_year, curr_yr.d_year AS year, curr_yr.i_brand_id, curr_yr.i_class_id, curr_yr.i_category_id, curr_yr.i_manufact_id, prev_yr.sales_cnt AS prev_yr_cnt, curr_yr.sales_cnt AS curr_yr_cnt, curr_yr.sales_cnt - prev_yr.sales_cnt AS sales_cnt_diff, curr_yr.sales_amt - prev_yr.sales_amt AS sales_amt_diff FROM all_sales curr_yr JOIN all_sales prev_yr ON curr_yr.i_brand_id = prev_yr.i_brand_id AND curr_yr.i_class_id = prev_yr.i_class_id AND curr_yr.i_category_id = prev_yr.i_category_id AND curr_yr.i_manufact_id = prev_yr.i_manufact_id WHERE curr_yr.d_year = 1999 AND prev_yr.d_year = 1998 AND prev_yr.sales_cnt > 0 AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2))/CAST(prev_yr.sales_cnt AS DECIMAL(17,2)) < 0.9 ORDER BY sales_cnt_diff, sales_amt_diff LIMIT 100"
        },
        {
          "node_id": "all_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "item", "date_dim", "catalog_returns", "store_sales", "store_returns", "web_sales", "web_returns"],
          "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
          "changed": true,
          "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM (SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt, cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk INNER JOIN catalog_returns ON cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk WHERE i_category = 'Home' AND cs_sales_price / cs_list_price BETWEEN 34 * 0.01 AND 54 * 0.01 AND cr_reason_sk IN (7, 25, 26, 52, 69) AND d_year IN (1998,1999) UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt, ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt FROM store_sales JOIN item ON i_item_sk = ss_item_sk JOIN date_dim ON d_date_sk = ss_sold_date_sk INNER JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk WHERE i_category = 'Home' AND ss_sales_price / ss_list_price BETWEEN 34 * 0.01 AND 54 * 0.01 AND sr_reason_sk IN (7, 25, 26, 52, 69) AND d_year IN (1998,1999) UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt, ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk INNER JOIN web_returns ON ws_order_number = wr_order_number AND ws_item_sk = wr_item_sk WHERE i_category = 'Home' AND ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 54 * 0.01 AND wr_reason_sk IN (7, 25, 26, 52, 69) AND d_year IN (1998,1999)) sales_detail GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id"
        }
      ]
    },
    "confidence": 0.75,
    "based_on": "p02,p04",
    "strategy": "Push year filter into CTE branches and convert LEFT JOIN to INNER JOIN to reduce rows processed and enable better join planning.",
    "expected_explain_delta": "Index scans on date_dim for 1998-1999, reduced rows from returns tables, and earlier filtering; CTE materializes only two years of data."
  }
]