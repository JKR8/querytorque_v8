[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.62,
    "based_on": "p02,p04",
    "strategy": "Filter years 1998-1999 early in CTE and convert LEFT JOIN to INNER JOIN because WHERE clause filters on returns.reason_sk.",
    "hypothesis": "Probes p02 (timeout) and p04 (semantic violation) together suggest early year filtering and join conversion are safe. The largest hotspot—full sequential scans of returns tables—is reduced by pushing date filter into CTE, cutting aggregation volume.",
    "expected_explain_delta": "Returns table scans become index scans via join with filtered sales; all_sales CTE aggregates only two years; self-join uses explicit JOIN.",
    "target_ir": "Modify all_sales CTE to filter d_year IN (1998,1999) and change LEFT JOIN to INNER JOIN with reason_sk in ON clause; rewrite final_select as explicit INNER JOIN.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["all_sales"],
          "outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"],
          "changed": true,
          "sql": "SELECT prev_yr.d_year AS prev_year, curr_yr.d_year AS year, curr_yr.i_brand_id, curr_yr.i_class_id, curr_yr.i_category_id, curr_yr.i_manufact_id, prev_yr.sales_cnt AS prev_yr_cnt, curr_yr.sales_cnt AS curr_yr_cnt, curr_yr.sales_cnt - prev_yr.sales_cnt AS sales_cnt_diff, curr_yr.sales_amt - prev_yr.sales_amt AS sales_amt_diff FROM all_sales curr_yr INNER JOIN all_sales prev_yr ON curr_yr.i_brand_id = prev_yr.i_brand_id AND curr_yr.i_class_id = prev_yr.i_class_id AND curr_yr.i_category_id = prev_yr.i_category_id AND curr_yr.i_manufact_id = prev_yr.i_manufact_id WHERE curr_yr.d_year = 1999 AND prev_yr.d_year = 1998 AND prev_yr.sales_cnt > 0 AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2)) / CAST(prev_yr.sales_cnt AS DECIMAL(17,2)) < 0.9 ORDER BY sales_cnt_diff, sales_amt_diff LIMIT 100"
        },
        {
          "node_id": "all_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "item", "date_dim", "catalog_returns", "store_sales", "store_returns", "web_sales", "web_returns"],
          "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
          "changed": true,
          "sql": "WITH all_sales AS ( SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM ( SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt, cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk JOIN catalog_returns ON (cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk AND cr_reason_sk IN (7, 25, 26, 52, 69)) WHERE i_category = 'Home' AND cs_sales_price / cs_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) UNION SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt, ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt FROM store_sales JOIN item ON i_item_sk = ss_item_sk JOIN date_dim ON d_date_sk = ss_sold_date_sk JOIN store_returns ON (ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND sr_reason_sk IN (7, 25, 26, 52, 69)) WHERE i_category = 'Home' AND ss_sales_price / ss_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) UNION SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt, ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk JOIN web_returns ON (ws_order_number = wr_order_number AND ws_item_sk = wr_item_sk AND wr_reason_sk IN (7, 25, 26, 52, 69)) WHERE i_category = 'Home' AND ws_sales_price / ws_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) ) sales_detail GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id )"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.55,
    "based_on": "p02,p03",
    "strategy": "Filter years early but keep LEFT JOIN semantics; materialize filtered CTEs for self-join.",
    "hypothesis": "Probe p03 showed neutral performance but p02 timed out. This attempt keeps LEFT JOINs (semantic safety) and creates two filtered CTEs to avoid scanning all years in self-join, addressing secondary hotspot.",
    "expected_explain_delta": "Returns scans remain but CTE size shrinks; self-join uses pre-filtered CTEs; explicit JOIN replaces comma join.",
    "target_ir": "Create curr_yr_1999 and prev_yr_1998 CTEs from all_sales filtered by year; rewrite final_select to join these CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["curr_yr_1999", "prev_yr_1998"],
          "outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"],
          "changed": true,
          "sql": "SELECT prev.d_year AS prev_year, curr.d_year AS year, curr.i_brand_id, curr.i_class_id, curr.i_category_id, curr.i_manufact_id, prev.sales_cnt AS prev_yr_cnt, curr.sales_cnt AS curr_yr_cnt, curr.sales_cnt - prev.sales_cnt AS sales_cnt_diff, curr.sales_amt - prev.sales_amt AS sales_amt_diff FROM curr_yr_1999 curr INNER JOIN prev_yr_1998 prev ON curr.i_brand_id = prev.i_brand_id AND curr.i_class_id = prev.i_class_id AND curr.i_category_id = prev.i_category_id AND curr.i_manufact_id = prev.i_manufact_id WHERE prev.sales_cnt > 0 AND CAST(curr.sales_cnt AS DECIMAL(17,2)) / CAST(prev.sales_cnt AS DECIMAL(17,2)) < 0.9 ORDER BY sales_cnt_diff, sales_amt_diff LIMIT 100"
        },
        {
          "node_id": "curr_yr_1999",
          "parent_node_id": "final_select",
          "sources": ["all_sales"],
          "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
          "changed": true,
          "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM all_sales WHERE d_year = 1999"
        },
        {
          "node_id": "prev_yr_1998",
          "parent_node_id": "final_select",
          "sources": ["all_sales"],
          "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
          "changed": true,
          "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM all_sales WHERE d_year = 1998"
        },
        {
          "node_id": "all_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "item", "date_dim", "catalog_returns", "store_sales", "store_returns", "web_sales", "web_returns"],
          "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
          "changed": true,
          "sql": "WITH all_sales AS ( SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM ( SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity - COALESCE(cr_return_quantity,0) AS sales_cnt, cs_ext_sales_price - COALESCE(cr_return_amount,0.0) AS sales_amt FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk LEFT JOIN catalog_returns ON (cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk) WHERE i_category = 'Home' AND cs_sales_price / cs_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) AND cr_reason_sk IN (7, 25, 26, 52, 69) UNION SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity - COALESCE(sr_return_quantity,0) AS sales_cnt, ss_ext_sales_price - COALESCE(sr_return_amt,0.0) AS sales_amt FROM store_sales JOIN item ON i_item_sk = ss_item_sk JOIN date_dim ON d_date_sk = ss_sold_date_sk LEFT JOIN store_returns ON (ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk) WHERE i_category = 'Home' AND ss_sales_price / ss_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) AND sr_reason_sk IN (7, 25, 26, 52, 69) UNION SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity - COALESCE(wr_return_quantity,0) AS sales_cnt, ws_ext_sales_price - COALESCE(wr_return_amt,0.0) AS sales_amt FROM web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_dim ON d_date_sk = ws_sold_date_sk LEFT JOIN web_returns ON (ws_order_number = wr_order_number AND ws_item_sk = wr_item_sk) WHERE i_category = 'Home' AND ws_sales_price / ws_list_price BETWEEN 0.34 AND 0.54 AND d_year IN (1998, 1999) AND wr_reason_sk IN (7, 25, 26, 52, 69) ) sales_detail GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id )"
        }
      ]
    }
  }
]