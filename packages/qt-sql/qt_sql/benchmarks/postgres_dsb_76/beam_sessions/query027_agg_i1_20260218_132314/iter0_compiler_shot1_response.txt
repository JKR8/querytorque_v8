[
  {
    "plan_id": "compile_p1",
    "dialect": "postgresql",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Explicit join conversion with early date_dim filtering to improve cardinality propagation.",
    "hypothesis": "Probes show that converting comma joins to explicit JOINs and pushing the d_year filter into a CTE reduces plan confusion and avoids nested loop traps. This addresses the primary hotspot of late date_dim scanning and misestimated joins.",
    "expected_explain_delta": "Nested Loop operators replaced with Hash Join; Index Only Scan on date_dim moved earlier with reduced output.",
    "target_ir": "Introduce filtered_date_dim CTE and convert all comma joins to explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "filtered_date_dim", "item", "store", "customer_demographics"],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "SELECT i_item_id, s_state, grouping(s_state) g_state, avg(ss_quantity) agg1, avg(ss_list_price) agg2, avg(ss_coupon_amt) agg3, avg(ss_sales_price) agg4 FROM store_sales JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk JOIN store ON ss_store_sk = s_store_sk JOIN customer_demographics ON ss_cdemo_sk = cd_demo_sk WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary' AND s_state = 'IA' AND i_category = 'Sports' GROUP BY rollup (i_item_id, s_state) ORDER BY i_item_id, s_state LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgresql",
    "confidence": 0.78,
    "based_on": "p02",
    "strategy": "Dimension prefetch with explicit joins to reduce fact-table probe volume.",
    "hypothesis": "Prefetching all selective dimensions into CTEs before joining with store_sales reduces repeated zero-row nested loop work. Although prior probe regressed, structure is sound; execution plan should benefit from explicit join clarity.",
    "expected_explain_delta": "Nested loops replaced by hash joins; dimension scans occur once and early.",
    "target_ir": "Introduce prefetch CTEs for all dimensions and convert to explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "date_dim_prefetch", "store_prefetch", "item_prefetch", "customer_demographics_prefetch"],
          "outputs": ["i_item_id", "s_state", "g_state", "agg1", "agg2", "agg3", "agg4"],
          "changed": true,
          "sql": "SELECT i.i_item_id, s.s_state, GROUPING(s.s_state) AS g_state, AVG(ss.ss_quantity) AS agg1, AVG(ss.ss_list_price) AS agg2, AVG(ss.ss_coupon_amt) AS agg3, AVG(ss.ss_sales_price) AS agg4 FROM store_sales ss JOIN date_dim_prefetch d ON ss.ss_sold_date_sk = d.d_date_sk JOIN store_prefetch s ON ss.ss_store_sk = s.s_store_sk JOIN item_prefetch i ON ss.ss_item_sk = i.i_item_sk JOIN customer_demographics_prefetch cd ON ss.ss_cdemo_sk = cd.cd_demo_sk GROUP BY ROLLUP (i.i_item_id, s.s_state) ORDER BY i.i_item_id, s.s_state LIMIT 100"
        },
        {
          "node_id": "date_dim_prefetch",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        },
        {
          "node_id": "store_prefetch",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk", "s_state"],
          "changed": true,
          "sql": "SELECT s_store_sk, s_state FROM store WHERE s_state = 'IA'"
        },
        {
          "node_id": "item_prefetch",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_id", "i_category"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_id, i_category FROM item WHERE i_category = 'Sports'"
        },
        {
          "node_id": "customer_demographics_prefetch",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_gender", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_gender, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'M' AND cd_education_status = 'Primary'"
        }
      ]
    }
  }
]