[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02,p04,p06",
    "strategy": "CTE filter isolation + explicit JOINs",
    "hypothesis": "Eliminate repeated date_dim/customer scans via shared CTEs and enforce explicit JOIN syntax to improve join order selection",
    "target_ir": "WITH filtered_dates + filtered_customers; All sales branches use explicit JOINs to CTEs instead of comma joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_dates",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1207 + 11"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_customers",
          "cte_query_sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_month IN (2,3,4,10)"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_customers ON ss_customer_sk = c_customer_sk"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p12",
    "strategy": "INTERSECT→key intersection CTEs",
    "hypothesis": "Replace INTERSECT with key-based CTE intersections followed by single dimension join",
    "target_ir": "Three CTE key channels → inner joined common keys → final projection",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH store AS (SELECT DISTINCT ss_customer_sk, ss_sold_date_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer ON ss_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2,3,4,10) AND ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96), catalog AS (SELECT DISTINCT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2,3,4,10) AND cs_list_price BETWEEN 241 AND 300 AND cs_wholesale_cost BETWEEN 76 AND 96), web AS (SELECT DISTINCT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE d_month_seq BETWEEN 1207 AND 1218 AND c_birth_month IN (2,3,4,10) AND ws_list_price BETWEEN 241 AND 300 AND ws_wholesale_cost BETWEEN 76 AND 96), common AS (SELECT s.ss_customer_sk AS cust_sk, s.ss_sold_date_sk AS date_sk FROM store s JOIN catalog c ON s.ss_customer_sk = c.cs_bill_customer_sk AND s.ss_sold_date_sk = c.cs_sold_date_sk JOIN web w ON s.ss_customer_sk = w.ws_bill_customer_sk AND s.ss_sold_date_sk = w.ws_sold_date_sk) SELECT COUNT(*) FROM (SELECT DISTINCT c_last_name, c_first_name, d_date FROM common JOIN customer ON cust_sk = c_customer_sk JOIN date_dim ON date_sk = d_date_sk) hot_cust LIMIT 100"
        }
      }
    ]
  }
]