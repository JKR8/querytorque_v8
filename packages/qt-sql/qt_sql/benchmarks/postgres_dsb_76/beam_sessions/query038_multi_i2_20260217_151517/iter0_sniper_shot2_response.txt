[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p05,p10",
    "strategy": "Combine dimension isolation with fact prefiltering and explicit joins",
    "hypothesis": "Original plan shows repeated full scans of date_dim and late customer filtering. Creating CTEs for prefiltered dimensions and facts reduces base table sizes, while explicit joins improve join order flexibility. INTERSECT remains but operates on pre-reduced datasets.",
    "target_ir": "CTE-driven structure with filtered_dates, filtered_customers, and prefiltered sales CTEs, using explicit JOINs in branches",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1207 + 11), filtered_customers AS (SELECT c_customer_sk, c_first_name, c_last_name FROM customer WHERE c_birth_month IN (2, 3, 4, 10)), store_sales_f AS (SELECT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96), catalog_sales_f AS (SELECT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 241 AND 300 AND cs_wholesale_cost BETWEEN 76 AND 96), web_sales_f AS (SELECT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 241 AND 300 AND ws_wholesale_cost BETWEEN 76 AND 96) SELECT COUNT(*) FROM ((SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM store_sales_f ss JOIN filtered_dates d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_customers c ON ss.ss_customer_sk = c.c_customer_sk) INTERSECT (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM catalog_sales_f cs JOIN filtered_dates d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_customers c ON cs.cs_bill_customer_sk = c.c_customer_sk) INTERSECT (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM web_sales_f ws JOIN filtered_dates d ON ws.ws_sold_date_sk = d.d_date_sk JOIN filtered_customers c ON ws.ws_bill_customer_sk = c.c_customer_sk)) AS hot_cust LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p12",
    "strategy": "Replace INTERSECT with key-based EXISTS joins",
    "hypothesis": "INTERSECT materialization dominates runtime (151s). Converting to EXISTS with prefiltered CTEs avoids large intermediate sets. Key-based joins align with engine strengths while preserving semantics through customer/date existence checks.",
    "target_ir": "Single-pass join between customer/date with EXISTS subqueries against prefiltered sales CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1207 AND 1207 + 11), filtered_customers AS (SELECT c_customer_sk, c_first_name, c_last_name FROM customer WHERE c_birth_month IN (2, 3, 4, 10)), store_sales_f AS (SELECT ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 241 AND 300 AND ss_wholesale_cost BETWEEN 76 AND 96), catalog_sales_f AS (SELECT cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 241 AND 300 AND cs_wholesale_cost BETWEEN 76 AND 96), web_sales_f AS (SELECT ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 241 AND 300 AND ws_wholesale_cost BETWEEN 76 AND 96) SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM filtered_customers c JOIN filtered_dates d ON 1=1 WHERE EXISTS (SELECT 1 FROM store_sales_f ss WHERE ss.ss_customer_sk = c.c_customer_sk AND ss.ss_sold_date_sk = d.d_date_sk) AND EXISTS (SELECT 1 FROM catalog_sales_f cs WHERE cs.cs_bill_customer_sk = c.c_customer_sk AND cs.cs_sold_date_sk = d.d_date_sk) AND EXISTS (SELECT 1 FROM web_sales_f ws WHERE ws.ws_bill_customer_sk = c.c_customer_sk AND ws.ws_sold_date_sk = d.d_date_sk)) AS hot_cust LIMIT 100;"
        }
      }
    ]
  }
]