{
  "iteration": 0,
  "n_api_calls": 11,
  "beam_cost_usd": 0.0347999,
  "beam_cost_priced_calls": 11,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 150679,
    "completion_tokens": 20339,
    "total_tokens": 171018,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 61184,
    "reasoning_tokens": 9350
  },
  "best_speedup": 1.07,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000) SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM filtered_d1 d1 INNER JOIN store_returns sr ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN store_sales ss ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND ws.ws_item_sk = sr.sr_item_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Home', 'Women') AND ca.ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA') AND hd.hd_income_band_sk BETWEEN 8 AND 14 AND hd.hd_buy_potential = '501-1000' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.41,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1547.2,
      "patch_ms": 3762.2,
      "output_sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000) SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, count(*) as cnt FROM filtered_d1 d1 INNER JOIN store_returns sr ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN store_sales ss ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk INNER JOIN web_sales ws ON ws.ws_bill_customer_sk = ss.ss_customer_sk AND ws.ws_item_sk = sr.sr_item_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '90 day') INNER JOIN item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Home', 'Women') AND ca.ca_state in ('AR', 'GA', 'IN', 'KY', 'VA') AND hd.hd_income_band_sk BETWEEN 8 AND 14 AND hd.hd_buy_potential = '501-1000' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Extract selective date_dim filters (d1.d_year=2000) into a CTE, convert comma joins to explicit INNER JOIN syntax, and push the CTE result as a tiny hash table into the main join graph."
    },
    {
      "patch_id": "p04",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.55,
      "status": "NEUTRAL",
      "speedup": 1.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1547.2,
      "patch_ms": 1523.9,
      "output_sql": "select  c_customer_sk, c_first_name, c_last_name, count(*) as cnt\nFROM\nstore_sales,\nstore_returns,\nweb_sales,\ndate_dim d1,\ndate_dim d2,\nitem,\ncustomer,\ncustomer_address,\nhousehold_demographics\nWHERE\nss_ticket_number = sr_ticket_number\nAND ss_customer_sk = ws_bill_customer_sk\nAND ss_customer_sk = c_customer_sk\nAND c_current_addr_sk = ca_address_sk\nAND c_current_hdemo_sk = hd_demo_sk\nAND ss_item_sk = sr_item_sk\nAND sr_item_sk = ws_item_sk\nAND i_item_sk = ss_item_sk\nAND i_category IN ('Children', 'Home', 'Women')\nAND sr_returned_date_sk = d1.d_date_sk\nAND ws_sold_date_sk = d2.d_date_sk\nAND d2.d_date between d1.d_date AND (d1.d_date + interval '90 day')\nAND ca_state in ('AR', 'GA', 'IN', 'KY', 'VA')\nAND d1.d_year = 2000\nAND hd_income_band_sk BETWEEN 8 AND 14\nAND hd_buy_potential = '501-1000'\nAND ss_sales_price / ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01\nGROUP BY c_customer_sk, c_first_name, c_last_name\nORDER BY cnt;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Exploration: push selective dimension filters into CTEs and pre-join fact tables to reduce rows before the non-equi join, even though no correlated subquery exists. Use MATERIALIZED hint to prevent inlining."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.82,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": true,
      "error": null,
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select  c_customer_sk, c_first_name, c_last_name, count(*) as cnt\nFROM\nstore_sales,\nstore_returns,\nweb_sales,\ndate_dim d1,\ndate_dim d2,\nitem,\ncustomer,\ncustomer_address,\nhousehold_demographics\nWHERE\nss_ticket_number = sr_ticket_number\nAND ss_customer_sk = ws_bill_customer_sk\nAND ss_customer_sk = c_customer_sk\nAND c_current_addr_sk = ca_address_sk\nAND c_current_hdemo_sk = hd_demo_sk\nAND ss_item_sk = sr_item_sk\nAND sr_item_sk = ws_item_sk\nAND i_item_sk = ss_item_sk\nAND i_category IN ('Children', 'Home', 'Women')\nAND sr_returned_date_sk = d1.d_date_sk\nAND ws_sold_date_sk = d2.d_date_sk\nAND d2.d_date between d1.d_date AND (d1.d_date + interval '90 day')\nAND ca_state in ('AR', 'GA', 'IN', 'KY', 'VA')\nAND d1.d_year = 2000\nAND hd_income_band_sk BETWEEN 8 AND 14\nAND hd_buy_potential = '501-1000'\nAND ss_sales_price / ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01\nGROUP BY c_customer_sk, c_first_name, c_last_name\nORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered date_dim d1 and d2 into separate CTEs, then pre-join store_returns and store_sales with these CTEs before the non-equi BETWEEN join to reduce input cardinality."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.78,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column sr.ws_bill_customer_sk does not exist\nLINE 1: ..._dim), sales_joined AS (SELECT ss.ss_customer_sk, sr.ws_bill...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_address_prefetch AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')), household_demographics_prefetch AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 8 AND 14 AND hd_buy_potential = '501-1000'), date_dim_prefetch_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000), date_dim_prefetch_d2 AS (SELECT d_date_sk, d_date FROM date_dim), sales_joined AS (SELECT ss.ss_customer_sk, sr.ws_bill_customer_sk, sr.sr_item_sk, d1.d_date AS d1_date FROM store_sales ss JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk JOIN item i ON i.i_item_sk = ss.ss_item_sk JOIN date_dim_prefetch_d1 d1 ON sr.sr_returned_date_sk = d1.d_date_sk WHERE i.i_category IN ('Children', 'Home', 'Women') AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01) SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, count(*) as cnt FROM customer c JOIN customer_address_prefetch ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN household_demographics_prefetch hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN sales_joined ssr ON c.c_customer_sk = ssr.ss_customer_sk JOIN web_sales ws ON ssr.ws_bill_customer_sk = ws.ws_bill_customer_sk AND ws.ws_item_sk = ssr.sr_item_sk JOIN date_dim_prefetch_d2 d2 ON ws.ws_sold_date_sk = d2.d_date_sk WHERE d2.d_date BETWEEN ssr.d1_date AND (ssr.d1_date + interval '90 day') GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim d1, item, customer_address, household_demographics) into separate CTEs, then join fact tables (store_sales, store_returns, web_sales) to these tiny CTEs using explicit JOIN syntax."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.82,
      "semantic_passed": true,
      "error": null,
      "original_ms": 4286.0,
      "patch_ms": 5229.6,
      "output_sql": "SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM store_sales ss INNER JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ws.ws_bill_customer_sk = ss.ss_customer_sk AND ws.ws_item_sk = sr.sr_item_sk INNER JOIN date_dim d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Home', 'Women') AND ca.ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA') AND d1.d_year = 2000 AND hd.hd_income_band_sk BETWEEN 8 AND 14 AND hd.hd_buy_potential = '501-1000' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "IMPROVED",
      "speedup": 1.07,
      "semantic_passed": true,
      "error": null,
      "original_ms": 4286.0,
      "patch_ms": 4011.5,
      "output_sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000) SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM filtered_d1 d1 INNER JOIN store_returns sr ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN store_sales ss ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND ws.ws_item_sk = sr.sr_item_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Home', 'Women') AND ca.ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA') AND hd.hd_income_band_sk BETWEEN 8 AND 14 AND hd.hd_buy_potential = '501-1000' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.82,
      "semantic_passed": true,
      "error": null,
      "original_ms": 4286.0,
      "patch_ms": 5245.4,
      "output_sql": "WITH filtered_d1 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women')), filtered_ca AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 8 AND 14 AND hd_buy_potential = '501-1000') SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM store_sales ss INNER JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN filtered_d1 d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN filtered_item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON c.c_customer_sk = ss.ss_customer_sk INNER JOIN filtered_ca ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN filtered_hd hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Sort  (rows=0, time=4089.221)\n  Aggregate  (rows=0, time=4089.21)\n    Nested Loop  (rows=0, time=4089.208)\n      Nested Loop  (rows=0, time=4089.207)\n        Nested Loop  (rows=5, time=4089.113)\n          Nested Loop  (rows=5, time=4089.023)\n            Nested Loop  (rows=34, time=4088.591)\n              Gather Merge  (rows=24544, time=1052.043)\n                Sort  (rows=8181, time=433.969)\n                  Nested Loop  (rows=8181, time=429.813)\n                    Hash Join  (rows=74035, tim",
    "p04": "Sort  (rows=0, time=1530.689)\n  Aggregate  (rows=0, time=1530.677)\n    Nested Loop  (rows=0, time=1530.675)\n      Nested Loop  (rows=0, time=1530.674)\n        Gather Merge  (rows=107, time=1517.957)\n          Sort  (rows=36, time=623.715)\n            Nested Loop  (rows=36, time=623.58)\n              Nested Loop  (rows=639, time=618.203)\n                Nested Loop  (rows=10493, time=601.735)\n                  Nested Loop  (rows=10609, time=538.144)\n                    Hash Join  (rows=74035, tim",
    "compile_p1": "Sort  (rows=0, time=3815.31)\n  Aggregate  (rows=0, time=3815.261)\n    Sort  (rows=0, time=3815.259)\n      Nested Loop  (rows=0, time=3815.201)\n        Nested Loop  (rows=0, time=3815.199)\n          Gather  (rows=0, time=3815.198)\n            Nested Loop  (rows=0, time=3813.953)\n              Nested Loop  (rows=2853, time=3266.31)\n                Nested Loop  (rows=31479, time=3004.986)\n                  Nested Loop  (rows=31826, time=2718.064)\n                    Hash Join  (rows=222105, time=55",
    "compile_p2": "Sort  (rows=0, time=5214.862)\n  Aggregate  (rows=0, time=5214.821)\n    Sort  (rows=0, time=5214.819)\n      Nested Loop  (rows=0, time=5214.798)\n        Nested Loop  (rows=0, time=5214.797)\n          Gather  (rows=0, time=5214.795)\n            Nested Loop  (rows=0, time=5213.618)\n              Nested Loop  (rows=2853, time=4425.009)\n                Nested Loop  (rows=31479, time=4092.983)\n                  Nested Loop  (rows=31826, time=3653.646)\n                    Hash Join  (rows=222105, time="
  }
}