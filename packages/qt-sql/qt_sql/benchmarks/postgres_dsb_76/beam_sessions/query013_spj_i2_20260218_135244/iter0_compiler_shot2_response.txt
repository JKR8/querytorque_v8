[
  {
    "plan_id": "compile_p01",
    "dialect": "postgres",
    "hypothesis": "Winning probe p01 (1.19x) converts comma joins to explicit JOINs and isolates date_dim filter into a CTE, enabling better join planning and cardinality estimates. This directly targets the comma‑join weakness and the largest hotspot (hash join with under‑estimation).",
    "target_ir": "Add date_filtered CTE and rewrite final_select with explicit JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_filtered", "store_sales", "store", "customer_demographics", "household_demographics", "customer_address"],
          "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales ss JOIN store s ON s.s_store_sk = ss.ss_store_sk JOIN customer_demographics cd ON cd.cd_demo_sk = ss.ss_cdemo_sk JOIN household_demographics hd ON hd.hd_demo_sk = ss.ss_hdemo_sk JOIN customer_address ca ON ca.ca_address_sk = ss.ss_addr_sk JOIN date_filtered df ON df.d_date_sk = ss.ss_sold_date_sk WHERE ( (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250) )"
        },
        {
          "node_id": "date_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        }
      ]
    },
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Explicit join + date CTE to arm the optimizer.",
    "expected_explain_delta": "Hash join input reduced by early date filter; explicit join ordering may reduce nested loops."
  },
  {
    "plan_id": "compile_p02_fixed",
    "dialect": "postgres",
    "hypothesis": "Extends p01 by also pre‑filtering all selective dimensions (customer_demographics, household_demographics, customer_address) into CTEs before joining, further reducing input size and improving join order. This addresses the same comma‑join weakness with more aggressive early filtering.",
    "target_ir": "Add four dimension CTEs and rewrite final_select with explicit joins and pre‑filtered dimensions.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["date_filtered", "cd_filtered", "hd_filtered", "ca_filtered", "store_sales", "store"],
          "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), cd_filtered AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M','S','W') AND cd_education_status IN ('2 yr Degree','Primary')), hd_filtered AS (SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3,1)), ca_filtered AS (SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA','KY','SD','AR','IN','VA','KS','OH','SD')) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales ss JOIN store s ON s.s_store_sk = ss.ss_store_sk JOIN cd_filtered cd ON cd.cd_demo_sk = ss.ss_cdemo_sk JOIN hd_filtered hd ON hd.hd_demo_sk = ss.ss_hdemo_sk JOIN ca_filtered ca ON ca.ca_address_sk = ss.ss_addr_sk JOIN date_filtered df ON df.d_date_sk = ss.ss_sold_date_sk WHERE ( (cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250) )"
        },
        {
          "node_id": "date_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "cd_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M','S','W') AND cd_education_status IN ('2 yr Degree','Primary')"
        },
        {
          "node_id": "hd_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["hd_demo_sk", "hd_dep_count"],
          "changed": true,
          "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3,1)"
        },
        {
          "node_id": "ca_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["ca_address_sk", "ca_country", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA','KY','SD','AR','IN','VA','KS','OH','SD')"
        }
      ]
    },
    "confidence": 0.75,
    "based_on": "p02",
    "strategy": "Multi‑dimension CTE prefetch to shrink join inputs.",
    "expected_explain_delta": "Further reduction of rows entering the main join by pre‑filtering all selective dimensions; may shift join order and reduce hash‑join cost."
  }
]