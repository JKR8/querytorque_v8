[
  {
    "plan_id": "compile_p01",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01",
    "strategy": "Explicit join conversion with date CTE to improve join planning.",
    "hypothesis": "Probe p01 (WIN, 1.19x) shows explicit JOIN syntax plus date-dimension CTE reduces nested-loop amplification. Original plan shows large hash join and nested loop due to comma-join cardinality misestimation.",
    "expected_explain_delta": "Nested Loop replaced by hash joins, reduced row amplification before aggregation.",
    "target_ir": "Replace comma joins with explicit JOIN ON and isolate date filter into CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "date_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store", "customer_demographics", "household_demographics", "customer_address", "date_filtered"],
          "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "SELECT MIN(ss.ss_quantity), MIN(ss.ss_ext_sales_price), MIN(ss.ss_ext_wholesale_cost), MIN(ss.ss_ext_wholesale_cost) FROM store_sales ss JOIN store s ON s.s_store_sk = ss.ss_store_sk JOIN customer_demographics cd ON cd.cd_demo_sk = ss.ss_cdemo_sk JOIN household_demographics hd ON hd.hd_demo_sk = ss.ss_hdemo_sk JOIN customer_address ca ON ca.ca_address_sk = ss.ss_addr_sk JOIN date_filtered df ON df.d_date_sk = ss.ss_sold_date_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02_fixed",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p02",
    "strategy": "Prefilter selective dimensions into CTEs before final join to reduce input size early.",
    "hypothesis": "Probe p02 (WIN, 1.19x) demonstrates dimension prefetch can reduce rows before joining. Fixed version correctly uses prefetch CTEs for all dimensions to avoid scanning full tables.",
    "expected_explain_delta": "Earlier reduction of dimension rows, smaller hash tables, and better join order.",
    "target_ir": "Introduce CTEs for date_dim, customer_demographics, household_demographics, customer_address; join with store_sales and store.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "date_dim_prefetch",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "customer_demographics_prefetch",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('M', 'S', 'W') AND cd_education_status IN ('2 yr Degree', 'Primary')"
        },
        {
          "node_id": "household_demographics_prefetch",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk", "hd_dep_count"],
          "changed": true,
          "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3, 1)"
        },
        {
          "node_id": "customer_address_prefetch",
          "parent_node_id": "final_select",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk", "ca_country", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH', 'SD')"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store", "date_dim_prefetch", "customer_demographics_prefetch", "household_demographics_prefetch", "customer_address_prefetch"],
          "outputs": ["MIN(ss_quantity)", "MIN(ss_ext_sales_price)", "MIN(ss_ext_wholesale_cost)", "MIN(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "SELECT MIN(ss.ss_quantity), MIN(ss.ss_ext_sales_price), MIN(ss.ss_ext_wholesale_cost), MIN(ss.ss_ext_wholesale_cost) FROM store_sales ss JOIN store s ON s.s_store_sk = ss.ss_store_sk JOIN date_dim_prefetch d ON d.d_date_sk = ss.ss_sold_date_sk JOIN customer_demographics_prefetch cd ON cd.cd_demo_sk = ss.ss_cdemo_sk JOIN household_demographics_prefetch hd ON hd.hd_demo_sk = ss.ss_hdemo_sk JOIN customer_address_prefetch ca ON ca.ca_address_sk = ss.ss_addr_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  }
]