{
  "probe_id": "p01",
  "transform_id": "early_filter_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pushing the date filter into the CTE and decorrelating the subquery by precomputing per-state average in a separate CTE reduces the size of the main CTE and replaces the correlated subquery with a join.",
  "reasoning_trace": [
    "The correlated subquery executes once per row in the CTE, causing performance issues due to repeated scans.",
    "Precomputing the average return per state in a separate CTE allows us to join it with the main CTE, eliminating the need for the correlated subquery.",
    "Pushing the date filter into the CTE reduces the number of rows processed early in the query execution."
  ],
  "target_ir": "customer_total_return CTE includes date filter; new CTE avg_state_return computes per-state averages; final select joins with avg_state_return instead of using correlated subquery.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_total_return", "avg_state_return", "customer_address", "customer"],
        "outputs": ["c_customer_id", "c_salutation", "c_first_name", "c_last_name", "ca_street_number", "ca_street_name", "ca_street_type", "ca_suite_number", "ca_city", "ca_county", "ca_state", "ca_zip", "ca_country", "ca_gmt_offset", "ca_location_type", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT c_customer_id,c_salutation,c_first_name,c_last_name,ca_street_number,ca_street_name\n                   ,ca_street_type,ca_suite_number,ca_city,ca_county,ca_state,ca_zip,ca_country,ca_gmt_offset\n                  ,ca_location_type,ctr_total_return\n FROM customer_total_return ctr1\n     ,customer_address\n     ,customer\n     ,avg_state_return\n where ctr1.ctr_total_return > avg_state_return.avg_return * 1.2\n       and ca_address_sk = c_current_addr_sk\n       and ca_state = 'IA'\n       and ctr1.ctr_customer_sk = c_customer_sk\n       and ctr1.ctr_state = avg_state_return.ctr_state\n order by c_customer_id,c_salutation,c_first_name,c_last_name,ca_street_number,ca_street_name\n                   ,ca_street_type,ca_suite_number,ca_city,ca_county,ca_state,ca_zip,ca_country,ca_gmt_offset\n                  ,ca_location_type,ctr_total_return\n limit 100"
      },
      {
        "node_id": "customer_total_return",
        "parent_node_id": "final_select",
        "sources": ["catalog_returns", "date_dim", "customer_address"],
        "outputs": ["ctr_customer_sk", "ctr_state", "ctr_total_return"],
        "changed": true,
        "sql": "select cr_returning_customer_sk as ctr_customer_sk\n        ,ca_state as ctr_state, \n \tsum(cr_return_amt_inc_tax) as ctr_total_return\n from catalog_returns\n     ,date_dim\n     ,customer_address\n where cr_returned_date_sk = d_date_sk \n   and d_year =2000\n   and cr_returning_addr_sk = ca_address_sk \n group by cr_returning_customer_sk\n         ,ca_state"
      },
      {
        "node_id": "avg_state_return",
        "parent_node_id": "final_select",
        "sources": ["customer_total_return"],
        "outputs": ["ctr_state", "avg_return"],
        "changed": true,
        "sql": "SELECT ctr_state, AVG(ctr_total_return) AS avg_return FROM customer_total_return GROUP BY ctr_state"
      }
    ]
  }
}