{
  "plan_id": "postgres_explicit_join_materialized_sales_last",
  "dialect": "postgres",
  "description": "Restructure comma joins to explicit INNER JOINs, delay sales table access via LEFT JOIN, and materialize shared date scans into CTEs. This defers expensive sales processing until after customer filtering, reducing nested loop iterations.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "date_filter",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5"
      },
      "description": "Insert CTE 'date_filter' for shared date dimension filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_customers",
        "cte_query_sql": "SELECT c.c_customer_sk, c.c_current_cdemo_sk, c.c_current_addr_sk FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE ca_state IN ('GA','KY','SD')"
      },
      "description": "Insert CTE 'filtered_customers' to pre-filter customer and address join"
    },
    {
      "step_id": "s3",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5), filtered_customers AS (SELECT c.c_customer_sk, c.c_current_cdemo_sk, c.c_current_addr_sk FROM customer c INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE ca_state IN ('GA','KY','SD')) SELECT cd_gender, cd_marital_status, cd_education_status, count(*) cnt1, cd_purchase_estimate, count(*) cnt2, cd_credit_rating, count(*) cnt3 FROM filtered_customers fc INNER JOIN customer_demographics cd ON fc.c_current_cdemo_sk = cd.cd_demo_sk LEFT JOIN store_sales ss ON fc.c_customer_sk = ss.ss_customer_sk AND ss.ss_sold_date_sk IN (SELECT d_date_sk FROM date_filter) AND ss.ss_list_price BETWEEN 52 AND 141 WHERE cd_marital_status IN ('D', 'W', 'U') AND cd_education_status IN ('Primary', 'College') AND ss.ss_customer_sk IS NOT NULL AND NOT EXISTS (SELECT 1 FROM web_sales ws INNER JOIN date_filter df ON ws.ws_sold_date_sk = df.d_date_sk WHERE ws.ws_bill_customer_sk = fc.c_customer_sk AND ws.ws_list_price BETWEEN 52 AND 141) AND NOT EXISTS (SELECT 1 FROM catalog_sales cs INNER JOIN date_filter df ON cs.cs_sold_date_sk = df.d_date_sk WHERE cs.cs_ship_customer_sk = fc.c_customer_sk AND cs.cs_list_price BETWEEN 52 AND 141) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
      },
      "description": "Replace entire query body with explicit JOINs, LEFT JOIN for sales, and materialized filters"
    }
  ]
}