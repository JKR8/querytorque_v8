{
  "probe_id": "p12",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing the filtered date range into a CTE and converting comma joins to explicit JOIN syntax will reduce redundant scans and improve join planning.",
  "reasoning_trace": [
    "Assigned transform targets comma-join conversion and date filter materialization.",
    "The original query uses comma-separated FROM clause with join conditions in WHERE, matching G_PG_COMMA_JOIN_PRESENT.",
    "Date filter is repeated in outer query and subquery; materializing it once into a CTE avoids duplication.",
    "Explicit JOIN syntax enables better cardinality estimates and join order flexibility per PostgreSQL engine profile."
  ],
  "target_ir": "date_dim scan becomes CTE; FROM comma joins become explicit JOINs; subquery references CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_dates", "catalog_sales", "item"],
        "outputs": ["excess discount amount"],
        "changed": true,
        "sql": "WITH filtered_dates AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_date BETWEEN '1998-01-06' AND CAST('1998-01-06' AS DATE) + INTERVAL '90 day'\n)\nSELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\"\nFROM catalog_sales\nJOIN item ON i_item_sk = cs_item_sk\nJOIN filtered_dates ON d_date_sk = cs_sold_date_sk\nWHERE (i_manufact_id IN (47, 226, 612, 676, 818)\n       OR i_manager_id BETWEEN 71 AND 100)\n  AND cs_ext_discount_amt > (\n    SELECT 1.3 * AVG(cs_ext_discount_amt)\n    FROM catalog_sales\n    JOIN filtered_dates ON d_date_sk = cs_sold_date_sk\n    WHERE cs_item_sk = i_item_sk\n      AND cs_list_price BETWEEN 108 AND 137\n      AND cs_sales_price / cs_list_price BETWEEN 23 * 0.01 AND 43 * 0.01\n  )\nORDER BY SUM(cs_ext_discount_amt)\nLIMIT 100"
      }
    ]
  }
}