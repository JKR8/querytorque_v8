{
  "probe_id": "inline_decorrelate_materialized",
  "transform_id": "inline_decorrelate_materialized",
  "family": "B",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Decomposing the correlated scalar subquery into 3 MATERIALIZED CTEs will eliminate the nested loop and correlated re-execution by precomputing per-store thresholds.",
  "reasoning_trace": [
    "Correlated scalar subquery executes 2,902 times with 2,394 row scans each, causing 6.95M rescans.",
    "Assigned transform targets decomposition into threshold CTEs to replace nested loop with hash join.",
    "MATERIALIZED CTEs prevent PostgreSQL from inlining back to correlated form.",
    "Final query joins precomputed threshold CTE via store_sk, preserving all original filters and output semantics."
  ],
  "target_ir": "Three new MATERIALIZED CTEs: (1) filtered store_returns+date_dim, (2) per-store threshold avg(ctr_total_return)*1.2, (3) main query joining threshold CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["ctr1_filtered", "store", "customer", "customer_demographics", "threshold"],
        "outputs": ["c_customer_id"],
        "changed": true,
        "sql": "SELECT c_customer_id FROM ctr1_filtered, store, customer, customer_demographics, threshold WHERE ctr1_filtered.ctr_total_return > threshold.avg_return AND ctr1_filtered.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1_filtered.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1_filtered.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100"
      },
      {
        "node_id": "ctr1_filtered",
        "parent_node_id": "final_select",
        "sources": ["store_returns", "date_dim"],
        "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk"
      },
      {
        "node_id": "threshold",
        "parent_node_id": "final_select",
        "sources": ["ctr1_filtered"],
        "outputs": ["ctr_store_sk", "avg_return"],
        "changed": true,
        "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM ctr1_filtered GROUP BY ctr_store_sk"
      },
      {
        "node_id": "store",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["s_store_sk", "s_state"],
        "changed": false
      },
      {
        "node_id": "customer",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["c_customer_sk", "c_customer_id", "c_current_cdemo_sk", "c_birth_month", "c_birth_year"],
        "changed": false
      },
      {
        "node_id": "customer_demographics",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": ["cd_demo_sk", "cd_gender", "cd_marital_status", "cd_education_status"],
        "changed": false
      }
    ]
  }
}