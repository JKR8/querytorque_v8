[
  {
    "plan_id": "compile_decorr",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Decorrelation via precomputed store averages, preserving original join multiplicity.",
    "hypothesis": "Primary hotspot is correlated subquery executing 2,902 times. Decorrelate by precomputing per-store average threshold in separate CTE, then join. This removes nested-loop rescans of ~6.95M rows.",
    "expected_explain_delta": "Correlated SubPlan eliminated; Nested Loop replaced by Hash Join between customer_total_return and store_averages.",
    "target_ir": "Add store_averages node and update final_select join graph to use explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "store_averages", "store", "customer", "customer_demographics"],
          "outputs": ["c_customer_id"],
          "changed": true,
          "sql": "SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE ctr1.ctr_total_return > sa.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s.s_state IN ('IA', 'KY', 'NE') AND cd.cd_marital_status IN ('S', 'S') AND cd.cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd.cd_gender = 'M' AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c.c_customer_id LIMIT 100"
        },
        {
          "node_id": "store_averages",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_store_sk", "avg_threshold"],
          "changed": true,
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "date_dim"],
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_decorr_prefilter",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p02,p05",
    "strategy": "Decorrelation plus early dimension filtering via prefetch CTEs to reduce rows before final join.",
    "hypothesis": "Secondary hotspot is late dimension filters. Pre-filter store, customer, and customer_demographics into separate CTEs before final join, while maintaining decorrelation of the subquery.",
    "expected_explain_delta": "Correlated SubPlan eliminated; dimension filters applied earlier via small CTE scans; final join cardinality reduced.",
    "target_ir": "Add filtered_store, filtered_customer, filtered_customer_demographics nodes and update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "store_averages", "filtered_store", "filtered_customer", "filtered_customer_demographics"],
          "outputs": ["c_customer_id"],
          "changed": true,
          "sql": "SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN filtered_store fs ON ctr1.ctr_store_sk = fs.s_store_sk JOIN filtered_customer fc ON ctr1.ctr_customer_sk = fc.c_customer_sk JOIN filtered_customer_demographics fcd ON fc.c_current_cdemo_sk = fcd.cd_demo_sk WHERE ctr1.ctr_total_return > sa.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 ORDER BY c.c_customer_id LIMIT 100"
        },
        {
          "node_id": "store_averages",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_store_sk", "avg_threshold"],
          "changed": true,
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk"
        },
        {
          "node_id": "filtered_store",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk"],
          "changed": true,
          "sql": "SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')"
        },
        {
          "node_id": "filtered_customer",
          "parent_node_id": "final_select",
          "sources": ["customer"],
          "outputs": ["c_customer_sk", "c_current_cdemo_sk", "c_customer_id"],
          "changed": true,
          "sql": "SELECT c_customer_sk, c_current_cdemo_sk, c_customer_id FROM customer WHERE c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993"
        },
        {
          "node_id": "filtered_customer_demographics",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M'"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "date_dim"],
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
          "changed": false
        }
      ]
    }
  }
]