Worker Role: W2
Family: C
Transform: pre_aggregate_customer_sales
Status: OK

--- OUTPUT SQL ---
WITH aggregated_sales AS (SELECT ss_customer_sk, ws_bill_customer_sk, ss_item_sk, ws_item_sk, ss_sold_date_sk, ws_sold_date_sk, ss_quantity, inv_quantity_on_hand FROM store_sales JOIN web_sales ON ss_item_sk = ws_item_sk JOIN inventory ON inv_item_sk = ss_item_sk AND inv_date_sk = ss_sold_date_sk WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1998) AND ws_wholesale_cost BETWEEN 76 AND 96 AND inv_quantity_on_hand >= ss_quantity), filtered_customers AS (SELECT c_customer_sk, cd_demo_sk, hd_demo_sk, ca_address_sk FROM customer JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM aggregated_sales AS sales JOIN filtered_customers AS c ON sales.ss_customer_sk = c.c_customer_sk AND sales.ws_bill_customer_sk = c.c_customer_sk JOIN customer_demographics AS cd ON c.cd_demo_sk = cd.cd_demo_sk JOIN household_demographics AS hd ON c.hd_demo_sk = hd.hd_demo_sk JOIN item AS i ON sales.ss_item_sk = i.i_item_sk JOIN store AS s ON s_state = (SELECT w_state FROM warehouse WHERE w_warehouse_sk = sales.ws_warehouse_sk) JOIN date_dim AS d1 ON sales.ss_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON sales.ws_sold_date_sk = d2.d_date_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') AND i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98) GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt;