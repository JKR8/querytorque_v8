[
  {
    "plan_id": "compile_p04_fixed",
    "dialect": "postgres",
    "confidence": 0.82,
    "based_on": "p04",
    "strategy": "Fix p04's correlated date predicate by preserving original join condition while isolating date_dim scans.",
    "hypothesis": "Winning probe p04 showed 6.27x speedup by isolating date_dim scans but incorrectly globalized the correlated d3 condition. Preserving original d3.d_date > d1.d_date + interval '3 day' maintains semantics while keeping CTE benefits.",
    "expected_explain_delta": "Eliminate repeated date_dim scans; reduce nested-loop amplification; maintain hash join for selective dimensions.",
    "target_ir": "Add d1_cte and d2_cte CTEs, keep d3 as base table with original join condition, update final_select joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["d1_cte", "d2_cte", "catalog_sales", "inventory", "warehouse", "item", "customer_demographics", "household_demographics", "date_dim", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH d1_cte AS (SELECT * FROM date_dim WHERE d_year = 1998), d2_cte AS (SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item ON i_item_sk = cs_item_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN d1_cte d1 ON cs_sold_date_sk = d1.d_date_sk JOIN d2_cte d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 day' AND hd_buy_potential = '>10000' AND cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "d1_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT * FROM date_dim WHERE d_year = 1998"
        },
        {
          "node_id": "d2_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d2.*"],
          "changed": true,
          "sql": "SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq"
        }
      ]
    }
  },
  {
    "plan_id": "compile_dimension_prefilter",
    "dialect": "postgres",
    "confidence": 0.68,
    "based_on": "p02",
    "strategy": "Address residual customer_demographics nested-loop hotspot by pre-filtering selective dimensions into CTEs while fixing column reference.",
    "hypothesis": "Probe p02 failed due to column reference error. Pre-filtering household_demographics, customer_demographics, and item reduces rows early before joining with large fact tables, targeting the 4000ms nested loop. Fix d3.d_date_sk reference and keep d3 correlated condition.",
    "expected_explain_delta": "Reduce nested-loop input rows; push selective filters before joins; maintain join semantics.",
    "target_ir": "Add filtered CTEs for household_demographics, customer_demographics, item; keep d1/d2 CTEs from p04; update final_select joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["d1_cte", "d2_cte", "hd_cte", "cd_cte", "item_cte", "catalog_sales", "inventory", "warehouse", "date_dim", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH d1_cte AS (SELECT * FROM date_dim WHERE d_year = 1998), d2_cte AS (SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq), hd_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), cd_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11), item_cte AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')) SELECT i.i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item_cte i ON i.i_item_sk = cs_item_sk JOIN cd_cte cd ON cs_bill_cdemo_sk = cd.cd_demo_sk JOIN hd_cte hd ON cs_bill_hdemo_sk = hd.hd_demo_sk JOIN d1_cte d1 ON cs_sold_date_sk = d1.d_date_sk JOIN d2_cte d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 day' AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i.i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "d1_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["*"],
          "changed": true,
          "sql": "SELECT * FROM date_dim WHERE d_year = 1998"
        },
        {
          "node_id": "d2_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d2.*"],
          "changed": true,
          "sql": "SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq"
        },
        {
          "node_id": "hd_cte",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk"],
          "changed": true,
          "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'"
        },
        {
          "node_id": "cd_cte",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11"
        },
        {
          "node_id": "item_cte",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_desc"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')"
        }
      ]
    }
  }
]