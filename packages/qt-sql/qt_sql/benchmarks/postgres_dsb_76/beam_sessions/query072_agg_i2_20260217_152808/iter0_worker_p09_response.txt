{
  "probe_id": "p01",
  "transform_id": "dimension_cte_isolate",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Isolate selective dimension filters into CTEs to reduce row count before expensive non-equi join and improve hash join efficiency.",
  "reasoning_trace": [
    "Multiple dimension tables (household_demographics, customer_demographics, item, date_dim) are joined directly with large fact tables.",
    "Each dimension has selective WHERE conditions that can be pushed into dedicated CTEs returning only surrogate keys.",
    "This reduces input size to the main fact table joins and avoids late filtering."
  ],
  "target_ir": "Multiple small filtered CTEs for each dimension joined via surrogate keys; original projection and aggregation preserved.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "hd_cte",
        "cte_query_sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "cd_cte",
        "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11"
      }
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "i_cte",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')"
      }
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "d1_cte",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999"
      }
    },
    {
      "step_id": "s5",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "d2_cte",
        "cte_query_sql": "SELECT d_date_sk, d_week_seq FROM date_dim"
      }
    },
    {
      "step_id": "s6",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "d3_cte",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim"
      }
    },
    {
      "step_id": "s7",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "catalog_sales cs JOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk AND inv.inv_quantity_on_hand < cs.cs_quantity JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN i_cte i ON i.i_item_sk = cs.cs_item_sk JOIN cd_cte cd ON cd.cd_demo_sk = cs.cs_bill_cdemo_sk JOIN hd_cte hd ON hd.hd_demo_sk = cs.cs_bill_hdemo_sk JOIN d1_cte d1 ON d1.d_date_sk = cs.cs_sold_date_sk JOIN d2_cte d2 ON d2.d_date_sk = inv.inv_date_sk JOIN d3_cte d3 ON d3.d_date_sk = cs.cs_ship_date_sk LEFT JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk LEFT JOIN catalog_returns cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number"
      }
    }
  ]
}