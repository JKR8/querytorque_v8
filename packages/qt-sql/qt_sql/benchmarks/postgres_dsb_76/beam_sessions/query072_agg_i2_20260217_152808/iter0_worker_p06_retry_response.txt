{
  "probe_id": "p06",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregating catalog_sales on surrogate keys before joining with dimensions reduces row count entering the expensive non-equi inventory join.",
  "reasoning_trace": [
    "catalog_sales is the largest fact table and central to multiple joins",
    "Group-by keys (i_item_sk, w_warehouse_sk, d_date_sk) align with join keys",
    "Aggregation can be pushed down to reduce rows before non-equi filter inv_quantity_on_hand < cs_quantity"
  ],
  "target_ir": "CTE with pre-aggregated catalog_sales grouped by i_item_sk, w_warehouse_sk, d_date_sk; main query joins this CTE with dimensions",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "agg_catalog_sales",
        "cte_query_sql": "SELECT cs_item_sk, cs_bill_warehouse_sk AS w_warehouse_sk, cs_sold_date_sk AS d_date_sk, SUM(cs_quantity) AS total_quantity, COUNT(*) AS cnt FROM catalog_sales GROUP BY cs_item_sk, cs_bill_warehouse_sk, cs_sold_date_sk"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "agg_catalog_sales acs JOIN inventory ON (acs.cs_item_sk = inv_item_sk AND acs.w_warehouse_sk = inv_warehouse_sk) JOIN warehouse w ON (acs.w_warehouse_sk = w.w_warehouse_sk) JOIN item i ON (acs.cs_item_sk = i.i_item_sk) JOIN customer_demographics cd ON (acs.cs_bill_cdemo_sk = cd.cd_demo_sk) JOIN household_demographics hd ON (acs.cs_bill_hdemo_sk = hd.hd_demo_sk) JOIN date_dim d1 ON (acs.d_date_sk = d1.d_date_sk) JOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim d3 ON (acs.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion p ON (acs.cs_promo_sk = p.p_promo_sk) LEFT OUTER JOIN catalog_returns cr ON (acs.cs_item_sk = cr.cr_item_sk AND acs.cs_order_number = cr.cr_order_number)"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < acs.total_quantity AND d3.d_date > d1.d_date + interval '3 day' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND acs.cs_wholesale_cost BETWEEN 76 AND 96"
      }
    }
  ]
}