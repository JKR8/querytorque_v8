{
  "probe_id": "p01",
  "transform_id": "inner_join_conversion",
  "family": "F",
  "dialect": "postgres",
  "hypothesis": "Convert the promotion LEFT JOIN to an INNER JOIN by pre-filtering non-null promo_sk values in a CTE, reducing unnecessary outer rows that are filtered post-join.",
  "reasoning_trace": [
    "The WHERE clause includes a condition that functionally turns the LEFT JOIN into an INNER JOIN (p_promo_sk is checked for NULL vs NOT NULL).",
    "Pre-filtering promotion in a CTE allows the optimizer to treat the join as INNER from the start, avoiding wasted outer row production."
  ],
  "target_ir": "CTE with filtered promotion records; main query uses INNER JOIN on that CTE; original GROUP BY and SELECT preserved.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "valid_promos",
        "cte_query_sql": "SELECT p_promo_sk FROM promotion WHERE p_promo_sk IS NOT NULL"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk=inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk) INNER JOIN valid_promos ON (cs_promo_sk = valid_promos.p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number)"
      }
    }
  ]
}