[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "original",
    "strategy": "Foundation: Pre-filter fact table with selective dimensions and date d1",
    "hypothesis": "Reducing the fact table early by applying selective filters in a CTE will reduce the row count in the expensive nested loop and hash join. BDA shows workers missed this opportunity due to validation failures, but EXPLAIN indicates d1-catalog_sales join dominates runtime.",
    "target_ir": "CTE filtered_cs with catalog_sales pre-joined with selective dimensions and d1, then main joins to inventory, warehouse, d2, d3, and left joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_cs AS (SELECT cs_item_sk, cs_order_number, cs_quantity, cs_wholesale_cost, cs_promo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, d1.d_week_seq AS d_week_seq, d1.d_date AS sold_date, i_item_desc FROM catalog_sales JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN item ON i_item_sk = cs_item_sk JOIN date_dim d1 ON cs_sold_date_sk = d1.d_date_sk WHERE hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 AND d1.d_year = 1999) SELECT i_item_desc, w_warehouse_name, d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_cs JOIN inventory ON filtered_cs.cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN date_dim d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim d3 ON filtered_cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON filtered_cs.cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = filtered_cs.cs_item_sk AND cr_order_number = filtered_cs.cs_order_number WHERE d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > sold_date + interval '3 day' GROUP BY i_item_desc, w_warehouse_name, d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "original",
    "strategy": "Alternative: Precompute inventory for weeks in 1999",
    "hypothesis": "Pre-filtering inventory to 1999 weeks reduces input size for non-equi join. BDA shows workers didn't address inventory blindness; EXPLAIN shows d2 scan is cheap but inventory join may be masked.",
    "target_ir": "CTE inventory_cte with inventory pre-joined with d2 and filtered by week in 1999, then main query with adjusted join condition on d_week_seq",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH inventory_cte AS (SELECT inv_item_sk, inv_warehouse_sk, inv_quantity_on_hand, inv_date_sk, d2.d_week_seq FROM inventory JOIN date_dim d2 ON inv_date_sk = d2.d_date_sk WHERE d2.d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_year=1999)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory_cte ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item ON i_item_sk = cs_item_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN date_dim d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = inventory_cte.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + interval '3 day' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100"
        }
      }
    ]
  }
]