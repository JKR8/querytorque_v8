[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p07,p01",
    "strategy": "Explicit JOIN syntax + dimension CTEs",
    "hypothesis": "Convert comma joins to explicit JOINs for better cardinality estimation and isolate selective dimension filters in CTEs to reduce nested loop input size",
    "target_ir": "Explicit JOIN tree with pre-filtered dimension CTEs and preserved date relationships",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_hd",
          "cte_query_sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_cd",
          "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "catalog_sales\nJOIN inventory ON (cs_item_sk = inv_item_sk)\nJOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk)\nJOIN item ON (i_item_sk = cs_item_sk)\nJOIN filtered_cd ON (cs_bill_cdemo_sk = filtered_cd.cd_demo_sk)\nJOIN filtered_hd ON (cs_bill_hdemo_sk = filtered_hd.hd_demo_sk)\nJOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk)\nJOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk)\nJOIN date_dim d3 ON (cs_ship_date_sk = d3.d_date_sk)\nLEFT JOIN promotion ON (cs_promo_sk = p_promo_sk)\nLEFT JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number)"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "strategy": "Staged fact reduction for non-equi join",
    "hypothesis": "Materialize filtered catalog_sales early to reduce input size before inventory join, enabling better join planning for quantity comparison",
    "target_ir": "Fact CTE with dimensional filters applied before inventory join",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT cs_item_sk, cs_order_number, cs_quantity, cs_wholesale_cost, cs_promo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk FROM catalog_sales JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim d1 ON (cs_sold_date_sk = d1.d_date_sk) WHERE hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 AND d1.d_year = 1999"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "filtered_sales\nJOIN inventory ON (filtered_sales.cs_item_sk = inv_item_sk AND inv_quantity_on_hand < filtered_sales.cs_quantity)\nJOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk)\nJOIN date_dim d1 ON (filtered_sales.cs_sold_date_sk = d1.d_date_sk)\nJOIN date_dim d2 ON (inv_date_sk = d2.d_date_sk)\nJOIN date_dim d3 ON (filtered_sales.cs_ship_date_sk = d3.d_date_sk)\nLEFT JOIN promotion ON (filtered_sales.cs_promo_sk = p_promo_sk)\nLEFT JOIN catalog_returns ON (cr_item_sk = filtered_sales.cs_item_sk AND cr_order_number = filtered_sales.cs_order_number)"
        }
      }
    ]
  }
]