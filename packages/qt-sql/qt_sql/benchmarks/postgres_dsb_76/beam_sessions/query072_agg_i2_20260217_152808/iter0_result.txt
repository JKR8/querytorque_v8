{
  "iteration": 0,
  "n_api_calls": 16,
  "beam_cost_usd": 0.09848756,
  "beam_cost_priced_calls": 16,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 85870,
    "completion_tokens": 33006,
    "total_tokens": 118876,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 23488
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p05",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_dims AS (SELECT cd_demo_sk, hd_demo_sk FROM customer_demographics, household_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN filtered_dims AS fd ON cs_bill_cdemo_sk = fd.cd_demo_sk AND cs_bill_hdemo_sk = fd.hd_demo_sk JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item ON i_item_sk = cs_item_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "CTE chain: dims_cte = (hd_cte JOIN cd_cte), fact_cte = (catalog_sales JOIN dims_cte). Preserve all original JOIN conditions in staged reduction."
    },
    {
      "patch_id": "p08",
      "family": "A",
      "transform": "date_cte_isolate",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH d1_cte AS (SELECT * FROM date_dim WHERE d_year = 1999), d2_cte AS (SELECT * FROM date_dim), d3_cte AS (SELECT * FROM date_dim) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN d1_cte AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN d2_cte AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN d3_cte AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Materialize d1_cte (d_year=1999), d2_cte (unfiltered), d3_cte (unfiltered). Preserve date conditions in main WHERE clause."
    },
    {
      "patch_id": "p12",
      "family": "F",
      "transform": "inner_join_conversion",
      "relevance_score": 0.7,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH valid_promos AS (SELECT p_promo_sk FROM promotion WHERE NOT p_promo_sk IS NULL) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) INNER JOIN valid_promos ON (cs_promo_sk = valid_promos.p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Convert promotion LEFT JOIN to INNER JOIN + CTE. WHERE clause functionally makes it inner. Preserve promo count semantics."
    },
    {
      "patch_id": "p06",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.7,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH agg_catalog_sales AS (SELECT cs_item_sk, cs_bill_warehouse_sk AS w_warehouse_sk, cs_sold_date_sk AS d_date_sk, SUM(cs_quantity) AS total_quantity, COUNT(*) AS cnt FROM catalog_sales GROUP BY cs_item_sk, cs_bill_warehouse_sk, cs_sold_date_sk) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM agg_catalog_sales AS acs JOIN inventory ON (acs.cs_item_sk = inv_item_sk AND acs.w_warehouse_sk = inv_warehouse_sk) JOIN warehouse AS w ON (acs.w_warehouse_sk = w.w_warehouse_sk) JOIN item AS i ON (acs.cs_item_sk = i.i_item_sk) JOIN customer_demographics AS cd ON (acs.cs_bill_cdemo_sk = cd.cd_demo_sk) JOIN household_demographics AS hd ON (acs.cs_bill_hdemo_sk = hd.hd_demo_sk) JOIN date_dim AS d1 ON (acs.d_date_sk = d1.d_date_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (acs.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion AS p ON (acs.cs_promo_sk = p.p_promo_sk) LEFT OUTER JOIN catalog_returns AS cr ON (acs.cs_item_sk = cr.cr_item_sk AND acs.cs_order_number = cr.cr_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < acs.total_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND acs.cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Push aggregation to after catalog_sales joins with d1/hd/cd/item. Group by surrogate keys (i_item_sk, w_warehouse_sk, d_date_sk). Preserve counts for later combination."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "multi_date_range_cte",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH d1_cte AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), d2_cte AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_year = 1999), d3_cte AS (SELECT d_date_sk, d_date FROM date_dim) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN d1_cte AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN d2_cte AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN d3_cte AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Create filtered CTEs: d1_cte (d_year=1999), d2_cte (d_year=1999 via d_week_seq=d1), d3_cte (d_date>d1+3). Preserve date relationships in main JOIN."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH d1_cte AS (SELECT * FROM date_dim WHERE d_year = 1999), d2_cte AS (SELECT * FROM date_dim), d3_cte AS (SELECT * FROM date_dim) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN d1_cte AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN d2_cte AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN d3_cte AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Materialize d1_cte (d_year=1999), d2_cte (no filter), d3_cte (no filter). Use explicit JOIN syntax between date CTEs and main tables."
    },
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.85,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH hd_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), cd_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), i_cte AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), d1_cte AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_year = 1999) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN i_cte ON (i_item_sk = cs_item_sk) JOIN cd_cte ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN hd_cte ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN d1_cte AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Create CTEs for all selective dimensions: hd_cte (hd_demo_sk), cd_cte (cd_demo_sk), i_cte (i_item_sk), d1_cte (d_date_sk). Preserve join conditions during reassembly."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.8,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH fact_cte AS (SELECT cs_item_sk, cs_order_number, cs_quantity, cs_wholesale_cost, cs_sold_date_sk, cs_ship_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_promo_sk FROM catalog_sales JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) WHERE hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND cs_wholesale_cost BETWEEN 76 AND 96), inv_cte AS (SELECT inv_item_sk, inv_warehouse_sk, inv_quantity_on_hand, inv_date_sk FROM inventory JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM fact_cte JOIN inv_cte ON (fact_cte.cs_item_sk = inv_cte.inv_item_sk AND inv_cte.inv_quantity_on_hand < fact_cte.cs_quantity) JOIN warehouse ON (w_warehouse_sk = inv_cte.inv_warehouse_sk) JOIN item ON (i_item_sk = fact_cte.cs_item_sk) JOIN date_dim AS d1 ON (fact_cte.cs_sold_date_sk = d1.d_date_sk) JOIN date_dim AS d3 ON (fact_cte.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (fact_cte.cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = fact_cte.cs_item_sk AND cr_order_number = fact_cte.cs_order_number) WHERE d1.d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date_sk = inv_cte.inv_date_sk) AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND d1.d_year = 1999 AND i_category IN ('Men', 'Shoes', 'Sports') GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Create fact_cte = catalog_sales JOIN d1_cte. Create inv_cte = inventory JOIN d2_cte. Apply non-equi join (inv_quantity_on_hand < cs_quantity) between materialized CTEs."
    },
    {
      "patch_id": "p10",
      "family": "A",
      "transform": "multi_dimension_prefetch",
      "relevance_score": 0.5,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales AS cs JOIN filtered_household_demographics AS fhd ON cs.cs_bill_hdemo_sk = fhd.hd_demo_sk JOIN filtered_customer_demographics AS fcd ON cs.cs_bill_cdemo_sk = fcd.cd_demo_sk JOIN filtered_item AS fi ON cs.cs_item_sk = fi.i_item_sk JOIN inventory AS inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse AS w ON inv.inv_warehouse_sk = w.w_warehouse_sk JOIN date_dim AS d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv.inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk LEFT JOIN catalog_returns AS cr ON cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Combine hd/cd/i dimension filters into single CTE. Join with catalog_sales before other tables. Preserve join conditions."
    },
    {
      "patch_id": "p07",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.5,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_d1_dates AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_year = 1999) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN filtered_item AS fi ON (fi.i_item_sk = cs_item_sk) JOIN filtered_customer_demographics AS fcd ON (cs_bill_cdemo_sk = fcd.cd_demo_sk) JOIN filtered_household_demographics AS fhd ON (cs_bill_hdemo_sk = fhd.hd_demo_sk) JOIN filtered_d1_dates AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Move all dimension filters (hd, cd, item, d1) into CTE definitions. Ensure filters execute before main joins."
    },
    {
      "patch_id": "p09",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH hd_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), cd_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), i_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), d1_cte AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), d2_cte AS (SELECT d_date_sk, d_week_seq FROM date_dim), d3_cte AS (SELECT d_date_sk, d_date FROM date_dim) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales AS cs JOIN inventory AS inv ON cs.cs_item_sk = inv.inv_item_sk AND inv.inv_quantity_on_hand < cs.cs_quantity JOIN warehouse AS w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN i_cte AS i ON i.i_item_sk = cs.cs_item_sk JOIN cd_cte AS cd ON cd.cd_demo_sk = cs.cs_bill_cdemo_sk JOIN hd_cte AS hd ON hd.hd_demo_sk = cs.cs_bill_hdemo_sk JOIN d1_cte AS d1 ON d1.d_date_sk = cs.cs_sold_date_sk JOIN d2_cte AS d2 ON d2.d_date_sk = inv.inv_date_sk JOIN d3_cte AS d3 ON d3.d_date_sk = cs.cs_ship_date_sk LEFT JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk LEFT JOIN catalog_returns AS cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Create CTEs for all dimensions: hd_cte, cd_cte, i_cte, w_cte, p_cte, d1_cte, d2_cte, d3_cte with base filters. Maintain original join relationships."
    },
    {
      "patch_id": "p11",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.45,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_sales AS (SELECT cs_item_sk, cs_order_number, cs_quantity, cs_wholesale_cost, cs_promo_sk, cs_sold_date_sk, d1.d_week_seq FROM catalog_sales JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk WHERE d1.d_year = 1999) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_sales AS fs JOIN inventory ON (fs.cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = fs.cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (fs.cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = fs.cs_item_sk AND cr_order_number = fs.cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < fs.cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND fs.cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": "Materialize filtered fact-dimension join (catalog_sales + d1 + hd + cd) as base_cte. Derive aggregates from single materialization."
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_cs AS (SELECT cs_item_sk, cs_order_number, cs_quantity, cs_wholesale_cost, cs_promo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, d1.d_week_seq AS d_week_seq, d1.d_date AS sold_date, i_item_desc FROM catalog_sales JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN item ON i_item_sk = cs_item_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk WHERE hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 AND d1.d_year = 1999) SELECT i_item_desc, w_warehouse_name, d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_cs JOIN inventory ON filtered_cs.cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON filtered_cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON filtered_cs.cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = filtered_cs.cs_item_sk AND cr_order_number = filtered_cs.cs_order_number WHERE d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > sold_date + INTERVAL '3 DAY' GROUP BY i_item_desc, w_warehouse_name, d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context'",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH inventory_cte AS (SELECT inv_item_sk, inv_warehouse_sk, inv_quantity_on_hand, inv_date_sk, d2.d_week_seq FROM inventory JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk WHERE d2.d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_year = 1999)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory_cte ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item ON i_item_sk = cs_item_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = inventory_cte.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s3 failed: replace_from requires from_sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Step s2 failed: replace_from requires from_sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {}
}