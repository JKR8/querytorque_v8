[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p11",
    "strategy": "Explicit join syntax + date filter CTE",
    "hypothesis": "Original comma joins prevent optimal join ordering. Isolating date_dim filter reduces rows early. EXPLAIN shows IndexOnlyScan on date_dim is effective but gets amplified in nested loops.",
    "target_ir": "CTE for filtered_date_dim + explicit INNER JOINs replacing comma joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date_dim",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "store_sales\nJOIN store ON s_store_sk = ss_store_sk\nJOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk\nJOIN household_demographics ON ss_hdemo_sk = hd_demo_sk\nJOIN customer_address ON ss_addr_sk = ca_address_sk\nJOIN filtered_date_dim ON ss_sold_date_sk = filtered_date_dim.d_date_sk"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "predicate_sql": "((ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk=hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02,p03",
    "strategy": "Partial OR decomposition + CTE prefetch",
    "hypothesis": "OR conditions prevent index usage on customer_demographics/household_demographics. EXPLAIN shows SeqScan on these tables. Splitting ORs reduces branch complexity while prefetching filters avoids CTE fencing.",
    "target_ir": "UNION ALL for demographics branches + CTEs for store/date_dim",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_store AS (SELECT s_store_sk FROM store) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM (\n  /* Branch 1 */\n  SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit FROM store_sales\n  JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_store ON s_store_sk = ss_store_sk\n  JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree'\n  JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 3\n  JOIN customer_address ON ss_addr_sk = ca_address_sk\n  WHERE ss_sales_price BETWEEN 100.00 AND 150.00\n    AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))\n  UNION ALL\n  /* Branch 2 */\n  SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit FROM store_sales\n  JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_store ON s_store_sk = ss_store_sk\n  JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary'\n  JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1\n  JOIN customer_address ON ss_addr_sk = ca_address_sk\n  WHERE ss_sales_price BETWEEN 50.00 AND 100.00\n    AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))\n  UNION ALL\n  /* Branch 3 */\n  SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit FROM store_sales\n  JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_store ON s_store_sk = ss_store_sk\n  JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary'\n  JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk AND hd_dep_count = 1\n  JOIN customer_address ON ss_addr_sk = ca_address_sk\n  WHERE ss_sales_price BETWEEN 150.00 AND 200.00\n    AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))\n) AS combined_data"
        }
      }
    ]
  }
]