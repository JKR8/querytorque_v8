[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p03,p12",
    "strategy": "Convert to explicit JOINs and split address OR into UNION ALL",
    "hypothesis": "Splitting address OR conditions into UNION ALL enables index scans on each branch while explicit JOIN syntax improves join reordering. Retaining demographics OR allows BITMAP_OR_SCAN optimization.",
    "target_ir": "Three UNION ALL branches handling address conditions, explicit JOINs, single demographics OR",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN store ON s_store_sk = ss_store_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_block_with_cte_pair",
        "target": {"by_anchor_hash": "a6beaa832eeb7899"},
        "payload": {
          "sql_fragment": "(ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) UNION ALL (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) UNION ALL (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250)"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p09,p10,p11",
    "strategy": "Early dimension filtering with CTEs and explicit JOINs",
    "hypothesis": "Materializing filtered dimensions and date reduces nested loop rows. Explicit JOINs unlock better join orders.",
    "target_ir": "CTEs for date, households, customer_demographics; explicit star-join structure",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_hd",
          "cte_query_sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1,3)"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_cd",
          "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status, cd_education_status) IN (('M','2 yr Degree'), ('S','Primary'), ('W','Primary'))"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN store ON s_store_sk = ss_store_sk JOIN filtered_cd ON cd_demo_sk = ss_cdemo_sk JOIN filtered_hd ON hd_demo_sk = ss_hdemo_sk"
        }
      }
    ]
  }
]