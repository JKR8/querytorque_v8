{
  "iteration": 2,
  "n_api_calls": 4,
  "best_speedup": 1.05,
  "best_patch_id": "t2",
  "best_sql": "WITH date_dim_d1 AS (SELECT * FROM date_dim WHERE d_year = 1999), date_dim_d2 AS (SELECT * FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_year = 1999)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim_d1 AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim_d2 AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
  "patches": [
    {
      "patch_id": "t1",
      "family": "E+F+C",
      "transform": "prefetch_plus_agg_pushdown",
      "relevance_score": 0.95,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite \u2014 ['inv_date_sk']. The rewrite references different table columns.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), cs_filtered AS (SELECT cs_item_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_quantity, cs_wholesale_cost, cs_order_number FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96), preagg_inventory AS (SELECT inv_item_sk, inv_warehouse_sk, SUM(inv_quantity_on_hand) AS total_inv_qty FROM inventory GROUP BY inv_item_sk, inv_warehouse_sk) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM cs_filtered AS cs JOIN preagg_inventory AS inv ON cs.cs_item_sk = inv.inv_item_sk JOIN warehouse AS w ON w.w_warehouse_sk = inv.inv_warehouse_sk JOIN filtered_item AS i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_cd AS cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_hd AS hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_date AS d1 ON cs.cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv.inv_item_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs.cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion AS p ON cs.cs_promo_sk = p.p_promo_sk LEFT OUTER JOIN catalog_returns AS cr ON cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv.total_inv_qty < cs.cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t2",
      "family": "A",
      "transform": "push_week_filter",
      "relevance_score": 0.9,
      "status": "NEUTRAL",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 567.3,
      "patch_ms": 541.9,
      "output_sql": "WITH date_dim_d1 AS (SELECT * FROM date_dim WHERE d_year = 1999), date_dim_d2 AS (SELECT * FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_year = 1999)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN date_dim_d1 AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN date_dim_d2 AS d2 ON (inv_date_sk = d2.d_date_sk) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t3",
      "family": "E+F+A",
      "transform": "prefetch_dates_fixed+materialize_group_keys",
      "relevance_score": 0.85,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Equivalence execution error: column d3.d_date does not exist\nLINE 1: ...q AND i.inv_quantity_on_hand < ps.cs_quantity AND d3.d_date ...\n                                                             ^\nHINT:  Perhaps you meant to reference the column \"d3.d_date_sk\".\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_year = 1999), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_items AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), preaggregated_sales AS (SELECT cs_item_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_order_number, cs_quantity, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM preaggregated_sales AS ps JOIN inventory AS i ON ps.cs_item_sk = i.inv_item_sk JOIN warehouse AS w ON i.inv_warehouse_sk = w.w_warehouse_sk JOIN filtered_items AS it ON ps.cs_item_sk = it.i_item_sk JOIN filtered_customer_demographics AS cd ON ps.cs_bill_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics AS hd ON ps.cs_bill_hdemo_sk = hd.hd_demo_sk JOIN filtered_dates AS d1 ON ps.cs_sold_date_sk = d1.d_date_sk JOIN filtered_dates AS d2 ON i.inv_date_sk = d2.d_date_sk JOIN filtered_dates AS d3 ON ps.cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion AS p ON ps.cs_promo_sk = p.p_promo_sk LEFT JOIN catalog_returns AS cr ON ps.cs_item_sk = cr.cr_item_sk AND ps.cs_order_number = cr.cr_order_number WHERE d1.d_week_seq = d2.d_week_seq AND i.inv_quantity_on_hand < ps.cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false
    }
  ],
  "explains": {
    "t2": "Limit  (rows=0, time=551.108)\n  Sort  (rows=0, time=551.107)\n    Aggregate  (rows=0, time=551.071)\n      Nested Loop  (rows=0, time=551.069)\n        Nested Loop  (rows=0, time=551.065)\n          Gather Merge  (rows=0, time=551.062)\n            Sort  (rows=0, time=542.403)\n              Nested Loop  (rows=0, time=542.355)\n                Nested Loop  (rows=0, time=542.353)\n                  Nested Loop  (rows=0, time=542.352)\n                    Hash Join  (rows=0, time=542.35)\n                  "
  }
}