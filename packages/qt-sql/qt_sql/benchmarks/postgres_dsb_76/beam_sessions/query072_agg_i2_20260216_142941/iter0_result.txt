{
  "iteration": 0,
  "n_api_calls": 5,
  "best_speedup": 3.63,
  "best_patch_id": "t2",
  "best_sql": "WITH base_dates AS (SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim WHERE d_year = 1999), d2_dates AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM base_dates)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN base_dates AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN d2_dates AS d2 ON (inv_date_sk = d2.d_date_sk AND d1.d_week_seq = d2.d_week_seq) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
  "patches": [
    {
      "patch_id": "t1",
      "family": "A",
      "transform": "predicate_pushback",
      "relevance_score": 0.95,
      "status": "NEUTRAL",
      "speedup": 0.97,
      "semantic_passed": true,
      "error": null,
      "original_ms": 567.5,
      "patch_ms": 583.8,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN filtered_item ON cs_item_sk = i_item_sk JOIN filtered_cd ON cs_bill_cdemo_sk = cd_demo_sk JOIN filtered_hd ON cs_bill_hdemo_sk = hd_demo_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion ON cs_promo_sk = p_promo_sk LEFT JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND d1.d_year = 1999 AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "t3",
      "family": "C",
      "transform": "fact_agg_pushdown",
      "relevance_score": 0.8,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1 structural: COLUMN REF MISMATCH: Original columns missing from rewrite \u2014 ['inv_date_sk']. The rewrite references different table columns.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH agg_facts AS (SELECT cs_item_sk, inv_warehouse_sk, cs_sold_date_sk, SUM(CASE WHEN cs_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT cs_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk WHERE cs_wholesale_cost BETWEEN 76 AND 96 AND inv_quantity_on_hand < cs_quantity GROUP BY cs_item_sk, inv_warehouse_sk, cs_sold_date_sk) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM agg_facts JOIN item ON i_item_sk = cs_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN customer_demographics ON cd_demo_sk = cs_bill_cdemo_sk JOIN household_demographics ON hd_demo_sk = cs_bill_hdemo_sk JOIN date_dim AS d2 ON d2.d_date_sk = cs_sold_date_sk JOIN date_dim AS d3 ON d3.d_date_sk = cs_ship_date_sk LEFT OUTER JOIN promotion ON p_promo_sk = cs_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": false
    },
    {
      "patch_id": "t2",
      "family": "E+F",
      "transform": "date_prefetch+join_restructure",
      "relevance_score": 0.9,
      "status": "WIN",
      "speedup": 3.63,
      "semantic_passed": true,
      "error": null,
      "original_ms": 567.5,
      "patch_ms": 156.4,
      "output_sql": "WITH base_dates AS (SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim WHERE d_year = 1999), d2_dates AS (SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM base_dates)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON (cs_item_sk = inv_item_sk) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN customer_demographics ON (cs_bill_cdemo_sk = cd_demo_sk) JOIN household_demographics ON (cs_bill_hdemo_sk = hd_demo_sk) JOIN base_dates AS d1 ON (cs_sold_date_sk = d1.d_date_sk) JOIN d2_dates AS d2 ON (inv_date_sk = d2.d_date_sk AND d1.d_week_seq = d2.d_week_seq) JOIN date_dim AS d3 ON (cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Men', 'Shoes', 'Sports') AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    },
    {
      "patch_id": "syn_w1",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.3,
      "status": "WIN",
      "speedup": 1.2,
      "semantic_passed": true,
      "error": null,
      "original_ms": 567.5,
      "patch_ms": 472.2,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000') SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON inv_warehouse_sk = w_warehouse_sk JOIN filtered_item ON cs_item_sk = i_item_sk JOIN filtered_cd ON cs_bill_cdemo_sk = cd_demo_sk JOIN filtered_hd ON cs_bill_hdemo_sk = hd_demo_sk JOIN date_dim AS d1 ON cs_sold_date_sk = d1.d_date_sk JOIN date_dim AS d2 ON inv_date_sk = d2.d_date_sk JOIN date_dim AS d3 ON cs_ship_date_sk = d3.d_date_sk LEFT OUTER JOIN promotion ON cs_promo_sk = p_promo_sk LEFT OUTER JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE d1.d_week_seq = d2.d_week_seq AND inv_quantity_on_hand < cs_quantity AND d3.d_date > d1.d_date + INTERVAL '3 DAY' AND d1.d_year = 1999 AND cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100;",
      "has_explain": true
    }
  ],
  "explains": {
    "t1": "Limit  (rows=0, time=501.918)\n  Sort  (rows=0, time=501.916)\n    Aggregate  (rows=0, time=501.883)\n      Nested Loop  (rows=0, time=501.882)\n        Gather Merge  (rows=0, time=501.88)\n          Sort  (rows=0, time=494.742)\n            Nested Loop  (rows=0, time=494.7)\n              Nested Loop  (rows=0, time=494.696)\n                Nested Loop  (rows=0, time=494.695)\n                  Nested Loop  (rows=0, time=494.694)\n                    Hash Join  (rows=0, time=494.693)\n                    ",
    "t2": "Limit  (rows=0, time=83.445)\n  Index Scan on date_dim (date_dim_1)  (rows=365, time=0.116)\n  Sort  (rows=0, time=83.442)\n    Aggregate  (rows=0, time=83.426)\n      Incremental Sort  (rows=0, time=83.425)\n        Nested Loop  (rows=0, time=83.419)\n          Nested Loop  (rows=0, time=83.418)\n            Nested Loop  (rows=0, time=83.417)\n              Nested Loop  (rows=0, time=83.416)\n                Nested Loop  (rows=0, time=83.414)\n                  Gather Merge  (rows=34665, time=33.097)\n   ",
    "syn_w1": "Limit  (rows=0, time=475.163)\n  Sort  (rows=0, time=475.161)\n    Aggregate  (rows=0, time=475.145)\n      Nested Loop  (rows=0, time=475.143)\n        Gather Merge  (rows=0, time=475.141)\n          Sort  (rows=0, time=468.379)\n            Nested Loop  (rows=0, time=468.34)\n              Nested Loop  (rows=0, time=468.339)\n                Nested Loop  (rows=0, time=468.338)\n                  Nested Loop  (rows=0, time=468.337)\n                    Hash Join  (rows=0, time=468.335)\n                  "
  }
}