{
  "probe_id": "scout_1",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing the filtered customer–address–demographics join once as a CTE reduces repeated scans. Precomputing channel key sets avoids recomputation for each channel check.",
  "reasoning_trace": [
    "Assigned transform targets materialization of shared dimension scan.",
    "Three correlated subqueries cause repeated scans of customer dimensions.",
    "CTE reuse aligns with PostgreSQL default materialization behavior.",
    "Channel key sets can be precomputed to reduce per-channel overhead."
  ],
  "target_ir": "Introduce cte_customers and cte_channel_keys; final_select joins with them.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["cte_customers", "cte_store_keys", "cte_web_keys", "cte_catalog_keys"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
        "changed": true,
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) cnt1, cd_purchase_estimate, COUNT(*) cnt2, cd_credit_rating, COUNT(*) cnt3 FROM cte_customers c JOIN cte_store_keys sk ON c.c_customer_sk = sk.ss_customer_sk LEFT JOIN cte_web_keys wk ON c.c_customer_sk = wk.ws_bill_customer_sk LEFT JOIN cte_catalog_keys ck ON c.c_customer_sk = ck.cs_ship_customer_sk WHERE sk.ss_customer_sk IS NOT NULL AND wk.ws_bill_customer_sk IS NULL AND ck.cs_ship_customer_sk IS NULL GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
      },
      {
        "node_id": "cte_customers",
        "parent_node_id": "final_select",
        "sources": ["customer", "customer_address", "customer_demographics"],
        "outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"],
        "changed": true,
        "sql": "SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('CO','NC','TX') AND cd.cd_marital_status IN ('S', 'M', 'U') AND cd.cd_education_status IN ('Primary', 'College')"
      },
      {
        "node_id": "cte_store_keys",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "date_dim"],
        "outputs": ["ss_customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT ss.ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND ss.ss_list_price BETWEEN 80 AND 169"
      },
      {
        "node_id": "cte_web_keys",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim"],
        "outputs": ["ws_bill_customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT ws.ws_bill_customer_sk FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND ws.ws_list_price BETWEEN 80 AND 169"
      },
      {
        "node_id": "cte_catalog_keys",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "date_dim"],
        "outputs": ["cs_ship_customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT cs.cs_ship_customer_sk FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND cs.cs_list_price BETWEEN 80 AND 169"
      }
    ]
  }
}