[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01,p04",
    "strategy": "Decorrelation via precomputed distinct customer keys and explicit JOINs, breaking nested-loop correlation.",
    "hypothesis": "All probes failed due to execution errors, but decorrelation hypothesis is sound. Original plan shows nested-loop amplification (77.7s) from three correlated subqueries. Precomputing distinct customer keys per channel and converting to explicit anti/semi-joins removes correlation, allows hash joins, and reduces repeated fact-table scans.",
    "expected_explain_delta": "Nested-loop correlation operators replaced by hash joins; repeated date_dim and fact-table index scans eliminated; sequential scan on customer reduced by early filtering.",
    "target_ir": "Add CTEs for filtered_customers, store_customers, web_customers, catalog_customers; rewrite final_select with explicit joins and NULL checks.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_customers", "store_customers", "web_customers", "catalog_customers"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
          "changed": true,
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3 FROM filtered_customers c JOIN store_customers ss ON c.c_customer_sk = ss.ss_customer_sk LEFT JOIN web_customers ws ON c.c_customer_sk = ws.ws_bill_customer_sk LEFT JOIN catalog_customers cs ON c.c_customer_sk = cs.cs_ship_customer_sk WHERE ws.ws_bill_customer_sk IS NULL AND cs.cs_ship_customer_sk IS NULL GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
        },
        {
          "node_id": "filtered_customers",
          "parent_node_id": "final_select",
          "sources": ["customer", "customer_address", "customer_demographics"],
          "outputs": ["c_customer_sk", "c_current_cdemo_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, c.c_current_cdemo_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('CO','NC','TX') AND cd.cd_marital_status IN ('S', 'M', 'U') AND cd.cd_education_status IN ('Primary', 'College')"
        },
        {
          "node_id": "store_customers",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["ss_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ss_customer_sk FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND ss.ss_list_price BETWEEN 80 AND 169"
        },
        {
          "node_id": "web_customers",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_dim"],
          "outputs": ["ws_bill_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ws_bill_customer_sk FROM web_sales ws JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND ws.ws_list_price BETWEEN 80 AND 169"
        },
        {
          "node_id": "catalog_customers",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_dim"],
          "outputs": ["cs_ship_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d.d_year = 2002 AND d.d_moy BETWEEN 10 AND 12 AND cs.cs_list_price BETWEEN 80 AND 169"
        }
      ]
    }
  }
]