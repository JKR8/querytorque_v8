{
  "probe_id": "scout_lane_default",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing each date_dim instance (d1, d2, d3) into separate CTEs with explicit filters enables the optimizer to build tiny hash tables. Converting comma joins to explicit JOIN syntax improves join planning and predicate pushdown.",
  "reasoning_trace": [
    "Assigned transform targets comma-join pattern with repeated date_dim scans and poor estimates.",
    "Each date_dim instance is filtered early and can be materialized into a small CTE.",
    "Explicit JOIN syntax helps PostgreSQL's planner better estimate and execute hash joins.",
    "CTE materialization avoids repeated scans and enables reuse across joins."
  ],
  "target_ir": "Three MATERIALIZED CTEs for d1, d2, d3 with explicit filters; main query uses explicit JOIN syntax.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["d1_filtered", "d2_filtered", "d3_filtered", "catalog_sales", "inventory", "warehouse", "item", "customer_demographics", "household_demographics", "promotion", "catalog_returns"],
        "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
        "changed": true,
        "sql": "SELECT i_item_desc ,w_warehouse_name ,d1.d_week_seq ,sum(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) no_promo ,sum(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) promo ,count(*) total_cnt FROM catalog_sales cs JOIN inventory inv ON (cs.cs_item_sk = inv.inv_item_sk) JOIN warehouse w ON (w.w_warehouse_sk=inv.inv_warehouse_sk) JOIN item i ON (i.i_item_sk = cs.cs_item_sk) JOIN customer_demographics cd ON (cs.cs_bill_cdemo_sk = cd.cd_demo_sk) JOIN household_demographics hd ON (cs.cs_bill_hdemo_sk = hd.hd_demo_sk) JOIN d1_filtered d1 ON (cs.cs_sold_date_sk = d1.d_date_sk) JOIN d2_filtered d2 ON (inv.inv_date_sk = d2.d_date_sk) JOIN d3_filtered d3 ON (cs.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion p ON (cs.cs_promo_sk=p.p_promo_sk) LEFT OUTER JOIN catalog_returns cr ON (cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + interval '3 day' AND hd.hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd.cd_marital_status = 'S' AND cd.cd_dep_count BETWEEN 9 AND 11 AND i.i_category IN ('Men', 'Shoes', 'Sports') AND cs.cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_item_desc,w.w_warehouse_name,d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100"
      },
      {
        "node_id": "d1_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_week_seq", "d_date", "d_year"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_week_seq, d_date, d_year FROM date_dim WHERE d_year = 1999"
      },
      {
        "node_id": "d2_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_week_seq"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_week_seq FROM date_dim"
      },
      {
        "node_id": "d3_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      }
    ]
  }
}