```json
[
  {
    "plan_id": "compile_p04",
    "dialect": "postgres",
    "confidence": 0.82,
    "based_on": "p04",
    "strategy": "Pre-filter date_dim tables via CTEs to avoid repeated scans, reduce join input, and enable better join planning.",
    "hypothesis": "WIN probe p04 (6.27x) successfully addressed date_dim self-join hotspots by materializing filtered date_dim CTEs. Residual dimension-table scans (customer_demographics, household_demographics, item) remain unaddressed but are smaller; this single-pathway rewrite is semantically safe and executable.",
    "expected_explain_delta": "Eliminate repeated date_dim Seq Scan, reduce Nested Loop amplification, earlier filter application.",
    "target_ir": "Add d1_cte, d2_cte, d3_cte nodes; update final_select to reference CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "inventory", "warehouse", "item", "customer_demographics", "household_demographics", "d1_cte", "d2_cte", "d3_cte", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH d1_cte AS (SELECT * FROM date_dim WHERE d_year = 1998), d2_cte AS (SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq), d3_cte AS (SELECT * FROM date_dim WHERE d_date > (SELECT MIN(d_date + interval '3 day') FROM d1_cte)) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item ON i_item_sk = cs_item_sk JOIN customer_demographics ON cs_bill_cdemo_sk = cd_demo_sk JOIN household_demographics ON cs_bill_hdemo_sk = hd_demo_sk JOIN d1_cte d1 ON cs_sold_date_sk = d1.d_date_sk JOIN d2_cte d2 ON inv_date_sk = d2.d_date_sk JOIN d3_cte d3 ON cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion ON cs_promo_sk = p_promo_sk LEFT JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE inv_quantity_on_hand < cs_quantity AND hd_buy_potential = '>10000' AND cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11 AND i_category IN ('Children', 'Jewelry', 'Men') AND cs_wholesale_cost BETWEEN 35 AND 55 GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "d1_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_week_seq", "d_date", "d_year"],
          "changed": true,
          "sql": "SELECT * FROM date_dim WHERE d_year = 1998"
        },
        {
          "node_id": "d2_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d_date_sk", "d_week_seq"],
          "changed": true,
          "sql": "SELECT d2.* FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq"
        },
        {
          "node_id": "d3_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT * FROM date_dim WHERE d_date > (SELECT MIN(d_date + interval '3 day') FROM d1_cte)"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p04_extended",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p04",
    "strategy": "Extend winning date_dim CTE pattern with pre‑filtered dimension CTEs to address remaining customer_demographics nested‑loop hotspot.",
    "hypothesis": "Probe p04 addressed date_dim scans; residual hotspot is nested‑loop join with customer_demographics (4000 ms). Adding filtered CTEs for customer_demographics, household_demographics, and item reduces early‑join cardinality and may further improve join order.",
    "expected_explain_delta": "Reduce Nested Loop cost on customer_demographics; earlier filtering on all selective dimensions.",
    "target_ir": "Add d1_cte, d2_cte, d3_cte, hd_cte, cd_cte, item_cte nodes; update final_select to reference all filtered CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "inventory", "warehouse", "item_cte", "cd_cte", "hd_cte", "d1_cte", "d2_cte", "d3_cte", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH d1_cte AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1998), d2_cte AS (SELECT d2.d_date_sk, d2.d_week_seq FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq), d3_cte AS (SELECT d3.d_date_sk, d3.d_date FROM date_dim d3 WHERE d3.d_date > (SELECT MIN(d1.d_date + interval '3 day') FROM d1_cte d1)), hd_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'), cd_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11), item_cte AS (SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')) SELECT i_item_desc, w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales JOIN inventory ON cs_item_sk = inv_item_sk JOIN warehouse ON w_warehouse_sk = inv_warehouse_sk JOIN item_cte item ON i_item_sk = cs_item_sk JOIN cd_cte cd ON cs_bill_cdemo_sk = cd_demo_sk JOIN hd_cte hd ON cs_bill_hdemo_sk = hd_demo_sk JOIN d1_cte d1 ON cs_sold_date_sk = d1.d_date_sk JOIN d2_cte d2 ON inv_date_sk = d2.d_date_sk JOIN d3_cte d3 ON cs_ship_date_sk = d3.d_date_sk LEFT JOIN promotion ON cs_promo_sk = p_promo_sk LEFT JOIN catalog_returns ON cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number WHERE inv_quantity_on_hand < cs_quantity AND cs_wholesale_cost BETWEEN 35 AND 55 AND d3.d_date > d1.d_date + interval '3 day' GROUP BY i_item_desc, w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "d1_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_week_seq", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1998"
        },
        {
          "node_id": "d2_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d_date_sk", "d_week_seq"],
          "changed": true,
          "sql": "SELECT d2.d_date_sk, d2.d_week_seq FROM date_dim d2 JOIN d1_cte d1 ON d1.d_week_seq = d2.d_week_seq"
        },
        {
          "node_id": "d3_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim", "d1_cte"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d3.d_date_sk, d3.d_date FROM date_dim d3 WHERE d3.d_date > (SELECT MIN(d1.d_date + interval '3 day') FROM d1_cte d1)"
        },
        {
          "node_id": "hd_cte",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk"],
          "changed": true,
          "sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '>10000'"
        },
        {
          "node_id": "cd_cte",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'U' AND cd_dep_count BETWEEN 9 AND 11"
        },
        {
          "node_id": "item_cte",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_desc"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_desc FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men')"
        }
      ]
    }
  }
]
```