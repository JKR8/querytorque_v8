[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p04",
    "strategy": "Decorrelation via precomputed customer key sets with explicit joins and anti-join conditions.",
    "hypothesis": "Primary hotspot is nested-loop correlation amplifying 1105 outer rows into 310K inner rows. Precomputing distinct customer keys for each channel breaks correlation and allows hash joins. Evidence from failed probes suggests decorrelation is viable; we correct syntax and preserve EXISTS/NOT EXISTS semantics via LEFT JOIN ... IS NULL.",
    "expected_explain_delta": "Nested-loop correlation operators replaced by hash joins; repeated date_dim scans reduced to one; outer sequential scan on customer eliminated via early filtered CTE.",
    "target_ir": "Add CTEs for date range, store_customers, web_customers, catalog_customers, and filtered_customers; rewrite final_select as explicit joins with anti-join conditions.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_customers", "store_customers", "web_customers", "catalog_customers"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
          "changed": true,
          "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) cnt1, cd_purchase_estimate, COUNT(*) cnt2, cd_credit_rating, COUNT(*) cnt3 FROM filtered_customers fc INNER JOIN store_customers sc ON fc.c_customer_sk = sc.ss_customer_sk LEFT JOIN web_customers wc ON fc.c_customer_sk = wc.ws_bill_customer_sk LEFT JOIN catalog_customers cc ON fc.c_customer_sk = cc.cs_ship_customer_sk WHERE wc.ws_bill_customer_sk IS NULL AND cc.cs_ship_customer_sk IS NULL GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
        },
        {
          "node_id": "filtered_customers",
          "parent_node_id": "final_select",
          "sources": ["customer", "customer_address", "customer_demographics"],
          "outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('CO','NC','TX') AND cd.cd_marital_status IN ('S','M','U') AND cd.cd_education_status IN ('Primary','College')"
        },
        {
          "node_id": "date_range",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy BETWEEN 10 AND 12"
        },
        {
          "node_id": "store_customers",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_range"],
          "outputs": ["ss_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ss_customer_sk FROM store_sales ss JOIN date_range dr ON ss.ss_sold_date_sk = dr.d_date_sk WHERE ss.ss_list_price BETWEEN 80 AND 169"
        },
        {
          "node_id": "web_customers",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "date_range"],
          "outputs": ["ws_bill_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT ws_bill_customer_sk FROM web_sales ws JOIN date_range dr ON ws.ws_sold_date_sk = dr.d_date_sk WHERE ws.ws_list_price BETWEEN 80 AND 169"
        },
        {
          "node_id": "catalog_customers",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "date_range"],
          "outputs": ["cs_ship_customer_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales cs JOIN date_range dr ON cs.cs_sold_date_sk = dr.d_date_sk WHERE cs.cs_list_price BETWEEN 80 AND 169"
        }
      ]
    }
  }
]