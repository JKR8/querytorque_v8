{
  "probe_id": "scout_01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Consolidating multiple aggregations in the main query into a single pass reduces repeated scans of store_sales and improves performance.",
  "reasoning_trace": [
    "Main query performs two separate aggregations on store_sales with identical filters and joins.",
    "Both aggregations compute sum(ss_quantity*ss_list_price) and count(*) with same GROUP BY keys.",
    "Single-pass aggregation using CASE expressions can compute both metrics in one scan."
  ],
  "target_ir": "Combine this_year and last_year aggregations into a single CTE with conditional aggregation.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["combined_sales", "avg_sales", "cross_items"],
        "outputs": ["ty_channel", "ty_brand", "ty_class", "ty_category", "ty_sales", "ty_number_sales", "ly_channel", "ly_brand", "ly_class", "ly_category", "ly_sales", "ly_number_sales"],
        "changed": true,
        "sql": "SELECT \n  this_year.ty_channel,\n  this_year.ty_brand,\n  this_year.ty_class,\n  this_year.ty_category,\n  this_year.ty_sales,\n  this_year.ty_number_sales,\n  last_year.ly_channel,\n  last_year.ly_brand,\n  last_year.ly_class,\n  last_year.ly_category,\n  last_year.ly_sales,\n  last_year.ly_number_sales\nFROM (\n  SELECT \n    'store' AS channel,\n    i_brand_id,\n    i_class_id,\n    i_category_id,\n    SUM(CASE WHEN d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12 THEN ss_quantity * ss_list_price ELSE 0 END) AS ty_sales,\n    SUM(CASE WHEN d_year = 1999 AND d_moy = 12 AND d_dom = 12 THEN ss_quantity * ss_list_price ELSE 0 END) AS ly_sales,\n    SUM(CASE WHEN d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12 THEN 1 ELSE 0 END) AS ty_number_sales,\n    SUM(CASE WHEN d_year = 1999 AND d_moy = 12 AND d_dom = 12 THEN 1 ELSE 0 END) AS ly_number_sales\n  FROM store_sales\n  JOIN item ON ss_item_sk = i_item_sk\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items)\n    AND d_week_seq IN (\n      SELECT d_week_seq\n      FROM date_dim\n      WHERE (d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12)\n         OR (d_year = 1999 AND d_moy = 12 AND d_dom = 12)\n    )\n    AND i_category IN ('Electronics', 'Shoes', 'Sports')\n    AND i_manager_id BETWEEN 42 AND 51\n    AND ss_wholesale_cost BETWEEN 76 AND 96\n  GROUP BY i_brand_id, i_class_id, i_category_id\n  HAVING SUM(CASE WHEN d_year = 1999 + 1 AND d_moy = 12 AND d_dom = 12 THEN ss_quantity * ss_list_price ELSE 0 END) > (SELECT average_sales FROM avg_sales)\n     AND SUM(CASE WHEN d_year = 1999 AND d_moy = 12 AND d_dom = 12 THEN ss_quantity * ss_list_price ELSE 0 END) > (SELECT average_sales FROM avg_sales)\n) combined_sales\nJOIN (\n  SELECT \n    i_brand_id AS ty_brand,\n    i_class_id AS ty_class,\n    i_category_id AS ty_category\n  FROM combined_sales\n) this_year ON combined_sales.i_brand_id = this_year.ty_brand\n              AND combined_sales.i_class_id = this_year.ty_class\n              AND combined_sales.i_category_id = this_year.ty_category\nJOIN (\n  SELECT \n    i_brand_id AS ly_brand,\n    i_class_id AS ly_class,\n    i_category_id AS ly_category\n  FROM combined_sales\n) last_year ON this_year.ty_brand = last_year.ly_brand\n              AND this_year.ty_class = last_year.ly_class\n              AND this_year.ty_category = last_year.ly_category\nORDER BY this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\nLIMIT 100"
      },
      {
        "node_id": "cross_items",
        "parent_node_id": "final_select",
        "sources": ["item", "web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["ss_item_sk"],
        "changed": false
      },
      {
        "node_id": "avg_sales",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim", "store_sales", "catalog_sales"],
        "outputs": ["average_sales"],
        "changed": false
      }
    ]
  }
}