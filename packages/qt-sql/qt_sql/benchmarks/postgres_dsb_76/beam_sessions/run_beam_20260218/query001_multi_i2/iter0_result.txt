{
  "iteration": 0,
  "n_api_calls": 25,
  "beam_cost_usd": 0.08437594,
  "beam_cost_priced_calls": 25,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 306312,
    "completion_tokens": 38353,
    "total_tokens": 344665,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 93139,
    "reasoning_tokens": 14497
  },
  "best_speedup": 128.76,
  "best_patch_id": "p02",
  "best_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim, store, customer_demographics WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND s_store_sk = sr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND sr_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_threshold AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN ctr_threshold thr ON ctr1.ctr_store_sk = thr.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > thr.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.95,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Unchanged node `store` must omit sql",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Decompose correlated scalar subquery into 3 MATERIALIZED CTEs: (1) pre-filtered store_returns with date_dim, (2) per-store_sk average threshold (avg(ctr_total_return)*1.2), (3) main query joining threshold CTE via store_sk."
    },
    {
      "patch_id": "p02",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 128.76,
      "semantic_passed": true,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2329.9,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim, store, customer_demographics WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND s_store_sk = sr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND sr_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_threshold AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN ctr_threshold thr ON ctr1.ctr_store_sk = thr.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > thr.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push dimension filters into CTE definitions before materialization, and decorrelate subquery by pre-computing thresholds in separate CTE with early filtering."
    },
    {
      "patch_id": "p06",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.55,
      "status": "WIN",
      "speedup": 6.89,
      "semantic_passed": true,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 43553.3,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(sr_return_amt_inc_tax) AS ctr_total_return FROM store_returns sr JOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk WHERE d.d_year = 2000 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-aggregate store_returns by customer_sk, store_sk, reason_sk before joining with date_dim, pushing aggregation below the date join."
    },
    {
      "patch_id": "p09",
      "family": "C",
      "transform": "single_pass_aggregation",
      "relevance_score": 0.55,
      "status": "WIN",
      "speedup": 6.86,
      "semantic_passed": true,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 43705.3,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Consolidate the two aggregates (customer_total_return CTE and subquery threshold) into a single CTE that computes both per-store aggregates in one pass over store_returns."
    },
    {
      "patch_id": "p03",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: relation \"customer_total_return\" does not exist\nLINE 1: ...store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_t...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH shared_scan AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SR_RETURN_AMT_INC_TAX FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174), shared_scan_agg AS (SELECT sr_customer_sk, sr_store_sk, sr_reason_sk, SR_RETURN_AMT_INC_TAX FROM shared_scan), ctr1 AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM shared_scan GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the store_returns + date_dim scan once as a CTE, then derive both ctr1 and ctr2 aggregates from the same materialized result to avoid re-scanning store_returns."
    },
    {
      "patch_id": "p05",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns sr JOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk WHERE d.d_year = 2000 AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 115 AND 174 AND sr.sr_reason_sk BETWEEN 17 AND 20 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_dimensions AS (SELECT s.s_store_sk, cd.cd_demo_sk FROM store s, customer_demographics cd WHERE s.s_state IN ('IA', 'KY', 'NE') AND cd.cd_marital_status IN ('S') AND cd.cd_education_status IN ('4 yr Degree') AND cd.cd_gender = 'M'), customer AS (SELECT c_customer_sk, c_customer_id, c_current_cdemo_sk, c_birth_month, c_birth_year FROM customer) SELECT c.c_customer_id FROM filtered_customer_total_return ctr1, filtered_dimensions dim, customer c WHERE ctr1.ctr_total_return > (SELECT AVG(ctr2.ctr_total_return) * 1.2 FROM filtered_customer_total_return ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_customer_sk = c.c_customer_sk AND c.c_current_cdemo_sk = dim.cd_demo_sk AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c.c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Stage reduction via MATERIALIZED CTEs for both dimension filters and fact table before the non-equi join (ctr_total_return > threshold)."
    },
    {
      "patch_id": "p05",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.65,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk FROM customer WHERE c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M') SELECT c.c_customer_id\nFROM customer_total_return ctr1\nJOIN filtered_store s ON s.s_store_sk = ctr1.ctr_store_sk\nJOIN filtered_customer c ON ctr1.ctr_customer_sk = c.c_customer_sk\nJOIN filtered_customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk\nWHERE ctr1.ctr_total_return > (\n  SELECT AVG(ctr2.ctr_total_return) * 1.2\n  FROM customer_total_return ctr2\n  WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk\n)\nAND ctr1.ctr_reason_sk BETWEEN 17 AND 20\nORDER BY c.c_customer_id\nLIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (store, customer, customer_demographics) into separate CTEs before joining with fact CTEs, using explicit JOIN syntax."
    },
    {
      "patch_id": "p07",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.5,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Build a CTE chain: first CTE filters date_dim, second CTE pre-joins filtered date keys with store_returns, third CTE aggregates, staging progressive reduction."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.7,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated joins to explicit JOIN syntax and isolate selective date_dim filter into a tiny CTE to create small hash table for store_returns probe."
    },
    {
      "patch_id": "p10",
      "family": "C",
      "transform": "channel_bitmap_aggregation",
      "relevance_score": 0.45,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Consolidate store_returns scan with conditional aggregation for both the main CTE and threshold computation using CASE expressions."
    },
    {
      "patch_id": "p08",
      "family": "A",
      "transform": "dimension_cte_isolate",
      "relevance_score": 0.5,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter store, customer, customer_demographics into separate CTEs returning only surrogate keys before joining with fact CTEs."
    },
    {
      "patch_id": "p11",
      "family": "C",
      "transform": "deferred_window_aggregation",
      "relevance_score": 0.4,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer, customer_demographics WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s_store_sk = ctr1.ctr_store_sk AND s_state IN ('IA', 'KY', 'NE') AND ctr1.ctr_customer_sk = c_customer_sk AND c_current_cdemo_sk = cd_demo_sk AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' AND c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Delay aggregation until after dimension joins, using window functions or subqueries to compute per-store averages after rows are reduced."
    },
    {
      "patch_id": "compile_decorr",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 114.32,
      "semantic_passed": true,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2624.2,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE ctr1.ctr_total_return > sa.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND s.s_state IN ('IA', 'KY', 'NE') AND cd.cd_marital_status IN ('S', 'S') AND cd.cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd.cd_gender = 'M' AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c.c_customer_id LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_decorr_prefilter",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: missing FROM-clause entry for table \"c\"\nLINE 1: ...stomer_total_return GROUP BY ctr_store_sk) SELECT c.c_custom...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('IA', 'KY', 'NE')), filtered_customer AS (SELECT c_customer_sk, c_current_cdemo_sk, c_customer_id FROM customer WHERE c_birth_month = 4 AND c_birth_year BETWEEN 1987 AND 1993), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M'), customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN store_averages sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN filtered_store fs ON ctr1.ctr_store_sk = fs.s_store_sk JOIN filtered_customer fc ON ctr1.ctr_customer_sk = fc.c_customer_sk JOIN filtered_customer_demographics fcd ON fc.c_current_cdemo_sk = fcd.cd_demo_sk WHERE ctr1.ctr_total_return > sa.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 ORDER BY c.c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_p02_decorr",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(sr_return_amt_inc_tax) AS ctr_total_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk JOIN store ON s_store_sk = sr_store_sk JOIN customer_demographics ON sr_cdemo_sk = cd_demo_sk WHERE d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND s_state IN ('IA', 'KY', 'NE') AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk), ctr_threshold AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return ctr1 JOIN ctr_threshold thr ON ctr1.ctr_store_sk = thr.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > thr.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100;",
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {
    "p02": "Limit  (rows=0, time=2428.584)\n  Aggregate  (rows=231, time=2427.935)\n    Sort  (rows=231, time=2427.811)\n      Gather  (rows=231, time=2426.69)\n        Nested Loop  (rows=77, time=1470.003)\n          Nested Loop  (rows=2412, time=1430.483)\n            Nested Loop  (rows=31155, time=1418.749)\n              Index Only Scan on date_dim  (rows=122, time=1.592)\n              Index Scan on store_returns  (rows=255, time=11.579)\n            Memoize  (rows=0, time=0.0)\n              Index Scan on store",
    "p06": "Limit  (rows=0, time=40974.763)\n  Aggregate  (rows=93169, time=2278.008)\n    Gather Merge  (rows=93235, time=2241.418)\n      Aggregate  (rows=31078, time=1403.087)\n        Sort  (rows=31155, time=1388.416)\n          Nested Loop  (rows=31155, time=1369.385)\n            Index Only Scan on date_dim (d)  (rows=122, time=1.352)\n            Index Scan on store_returns (sr)  (rows=255, time=11.175)\n  Sort  (rows=0, time=40974.646)\n    Nested Loop  (rows=0, time=40974.627)\n      Nested Loop  (rows=6, ti",
    "p09": "Limit  (rows=0, time=41459.55)\n  Aggregate  (rows=93169, time=2140.142)\n    Gather Merge  (rows=93235, time=2103.755)\n      Aggregate  (rows=31078, time=1306.785)\n        Sort  (rows=31155, time=1292.107)\n          Nested Loop  (rows=31155, time=1272.922)\n            Index Only Scan on date_dim  (rows=122, time=1.392)\n            Index Scan on store_returns  (rows=255, time=10.387)\n  Sort  (rows=0, time=41459.437)\n    Nested Loop  (rows=0, time=41459.417)\n      Nested Loop  (rows=6, time=41459.2",
    "compile_decorr": "Limit  (rows=0, time=2382.173)\n  Aggregate  (rows=93169, time=2337.119)\n    Gather Merge  (rows=93235, time=2300.283)\n      Aggregate  (rows=31078, time=1465.912)\n        Sort  (rows=31155, time=1451.515)\n          Nested Loop  (rows=31155, time=1429.991)\n            Index Only Scan on date_dim  (rows=122, time=1.22)\n            Index Scan on store_returns  (rows=255, time=11.664)\n  Sort  (rows=0, time=2382.046)\n    Nested Loop  (rows=0, time=2382.013)\n      Nested Loop  (rows=6, time=2381.865)\n"
  }
}