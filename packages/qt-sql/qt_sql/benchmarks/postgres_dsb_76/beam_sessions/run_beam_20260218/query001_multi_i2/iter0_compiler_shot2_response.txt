[
  {
    "plan_id": "compile_p02_decorr",
    "dialect": "postgres",
    "confidence": 0.92,
    "based_on": "p02",
    "strategy": "Decorrelation with early dimension filter pushdown and explicit join syntax.",
    "hypothesis": "Winning probe p02 (128.76x) decorrelates the scalar subquery by precomputing per-store average threshold and pushes store/customer_demographics filters into the CTE, removing nested-loop rescans and reducing CTE cardinality early.",
    "expected_explain_delta": "Nested-loop correlated subplan replaced by hash join between customer_total_return and ctr_threshold; store and customer_demographics filters move into CTE scan; overall row count reduced before final join.",
    "target_ir": "Add ctr_threshold node; modify customer_total_return to include store and customer_demographics joins; update final_select join graph.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return", "ctr_threshold", "customer"],
          "outputs": ["c_customer_id"],
          "changed": true,
          "sql": "SELECT c_customer_id FROM customer_total_return ctr1 JOIN ctr_threshold thr ON ctr1.ctr_store_sk = thr.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > thr.avg_threshold AND ctr1.ctr_reason_sk BETWEEN 17 AND 20 AND c.c_birth_month = 4 AND c.c_birth_year BETWEEN 1987 AND 1993 ORDER BY c_customer_id LIMIT 100"
        },
        {
          "node_id": "ctr_threshold",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return"],
          "outputs": ["ctr_store_sk", "avg_threshold"],
          "changed": true,
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_threshold FROM customer_total_return GROUP BY ctr_store_sk"
        },
        {
          "node_id": "customer_total_return",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "date_dim", "store", "customer_demographics"],
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(sr_return_amt_inc_tax) AS ctr_total_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk JOIN store ON s_store_sk = sr_store_sk JOIN customer_demographics ON sr_cdemo_sk = cd_demo_sk WHERE d_year = 2000 AND sr_return_amt / sr_return_quantity BETWEEN 115 AND 174 AND s_state IN ('IA', 'KY', 'NE') AND cd_marital_status IN ('S', 'S') AND cd_education_status IN ('4 yr Degree', '4 yr Degree') AND cd_gender = 'M' GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk"
        }
      ]
    }
  }
]