[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p03",
    "strategy": "Pre‑filter dimensions in CTEs, keep comma‑join syntax.",
    "hypothesis": "Winning probe p03 (20.27×) shows that materializing filtered dimension tables as CTEs allows the planner to reorder joins and avoid the large sequential scan on customer, even without explicit‑join syntax.",
    "expected_explain_delta": "Sequential scan on customer replaced by hash join; nested‑loop amplification removed.",
    "target_ir": "Add four CTE nodes for filtered dimensions and update final_select to reference them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "store_returns", "ca_filtered", "ib_filtered", "hd_filtered", "cd_filtered"],
          "outputs": ["customer_id", "customername"],
          "changed": true,
          "sql": "SELECT c_customer_id AS customer_id, COALESCE(c_last_name, '') || ', ' || COALESCE(c_first_name, '') AS customername FROM customer, ca_filtered, cd_filtered, hd_filtered, ib_filtered, store_returns WHERE c_current_addr_sk = ca_address_sk AND ib_income_band_sk = hd_income_band_sk AND cd_demo_sk = c_current_cdemo_sk AND hd_demo_sk = c_current_hdemo_sk AND sr_cdemo_sk = cd_demo_sk ORDER BY c_customer_id LIMIT 100"
        },
        {
          "node_id": "ca_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["ca_address_sk"],
          "changed": true,
          "sql": "SELECT * FROM customer_address WHERE ca_city = 'Jackson'"
        },
        {
          "node_id": "ib_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["ib_income_band_sk"],
          "changed": true,
          "sql": "SELECT * FROM income_band WHERE ib_lower_bound >= 23567 AND ib_upper_bound <= 23567 + 50000"
        },
        {
          "node_id": "hd_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["hd_demo_sk", "hd_income_band_sk"],
          "changed": true,
          "sql": "SELECT * FROM household_demographics"
        },
        {
          "node_id": "cd_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT * FROM customer_demographics"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "COMMA_JOIN_WEAKNESS pattern",
    "strategy": "Convert comma joins to explicit INNER JOINs and push filters into JOIN conditions.",
    "hypothesis": "Explicit join syntax may improve join‑order flexibility and allow better use of indexes; this pathway is distinct from the CTE‑based winner and addresses the same large‑scan hotspot.",
    "expected_explain_delta": "Sequential scan on customer replaced by hash join; nested loops removed; join order may be re‑estimated.",
    "target_ir": "Update final_select to use explicit joins with filters moved to ON clauses.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "customer_address", "customer_demographics", "household_demographics", "income_band", "store_returns"],
          "outputs": ["customer_id", "customername"],
          "changed": true,
          "sql": "SELECT c_customer_id AS customer_id, COALESCE(c_last_name, '') || ', ' || COALESCE(c_first_name, '') AS customername FROM customer JOIN customer_address ON c_current_addr_sk = ca_address_sk AND ca_city = 'Jackson' JOIN customer_demographics ON cd_demo_sk = c_current_cdemo_sk JOIN household_demographics ON hd_demo_sk = c_current_hdemo_sk JOIN income_band ON ib_income_band_sk = hd_income_band_sk AND ib_lower_bound >= 23567 AND ib_upper_bound <= 23567 + 50000 JOIN store_returns ON sr_cdemo_sk = cd_demo_sk ORDER BY c_customer_id LIMIT 100"
        }
      ]
    }
  }
]