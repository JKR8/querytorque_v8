[
  {
    "plan_id": "compile_nochange",
    "dialect": "postgres",
    "confidence": 0.95,
    "based_on": "",
    "strategy": "No change; baseline is low (<100ms) and all probes regressed.",
    "hypothesis": "Original query runs in 58ms baseline. All four probes regressed (0.80x-0.81x). PostgreSQL's comma-join reordering and index usage are already effective. The largest hotspot (my_customers nested loop) was addressed by probes but regressed, indicating the optimizer's chosen plan is near-optimal at this scale.",
    "expected_explain_delta": "No change; preserve original plan shape.",
    "target_ir": "Preserve all CTE structures and comma joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["segments"],
          "outputs": ["segment", "num_customers", "segment_base"],
          "changed": false
        },
        {
          "node_id": "segments",
          "parent_node_id": "final_select",
          "sources": ["my_revenue"],
          "outputs": ["segment"],
          "changed": false
        },
        {
          "node_id": "my_revenue",
          "parent_node_id": "segments",
          "sources": ["my_customers", "store_sales", "customer_address", "store", "date_dim"],
          "outputs": ["c_customer_sk", "revenue"],
          "changed": false
        },
        {
          "node_id": "my_customers",
          "parent_node_id": "my_revenue",
          "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
          "outputs": ["c_customer_sk", "c_current_addr_sk"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_explicit_join",
    "dialect": "postgres",
    "confidence": 0.30,
    "based_on": "p01,p02",
    "strategy": "Explicit JOIN syntax without extra CTE materialization, targeting comma-join weakness.",
    "hypothesis": "Probes p01 and p02 regressed but introduced unnecessary CTE materialization. This attempt converts comma joins to explicit INNER JOINs without additional CTEs, allowing the optimizer to reorder freely while preserving predicate pushdown. Low confidence due to regression evidence, but required for residual gap coverage.",
    "expected_explain_delta": "Nested Loop may become Hash Join; date_dim Index Only Scan remains early.",
    "target_ir": "Change my_customers and my_revenue to explicit JOINs, keep all other nodes unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["segments"],
          "outputs": ["segment", "num_customers", "segment_base"],
          "changed": false
        },
        {
          "node_id": "segments",
          "parent_node_id": "final_select",
          "sources": ["my_revenue"],
          "outputs": ["segment"],
          "changed": false
        },
        {
          "node_id": "my_revenue",
          "parent_node_id": "segments",
          "sources": ["my_customers", "store_sales", "customer_address", "store", "date_dim"],
          "outputs": ["c_customer_sk", "revenue"],
          "changed": true,
          "sql": "SELECT c_customer_sk, SUM(ss_ext_sales_price) AS revenue FROM my_customers INNER JOIN store_sales ON my_customers.c_customer_sk = store_sales.ss_customer_sk INNER JOIN customer_address ON my_customers.c_current_addr_sk = customer_address.ca_address_sk INNER JOIN store ON customer_address.ca_county = store.s_county AND customer_address.ca_state = store.s_state INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk WHERE store_sales.ss_wholesale_cost BETWEEN 35 AND 65 AND store.s_state IN ('AR','CO','IA','IL','KY','NC','NM','NY','PA','TX') AND date_dim.d_month_seq BETWEEN (SELECT DISTINCT d_month_seq+1 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) AND (SELECT DISTINCT d_month_seq+3 FROM date_dim WHERE d_year = 1998 AND d_moy = 1) GROUP BY c_customer_sk"
        },
        {
          "node_id": "my_customers",
          "parent_node_id": "my_revenue",
          "sources": ["item", "date_dim", "customer", "catalog_sales", "web_sales"],
          "outputs": ["c_customer_sk", "c_current_addr_sk"],
          "changed": true,
          "sql": "SELECT DISTINCT c.c_customer_sk, c.c_current_addr_sk FROM (SELECT cs_sold_date_sk AS sold_date_sk, cs_bill_customer_sk AS customer_sk, cs_item_sk AS item_sk, cs_wholesale_cost AS wholesale_cost FROM catalog_sales UNION ALL SELECT ws_sold_date_sk AS sold_date_sk, ws_bill_customer_sk AS customer_sk, ws_item_sk AS item_sk, ws_wholesale_cost AS wholesale_cost FROM web_sales) cs_or_ws_sales INNER JOIN date_dim d ON cs_or_ws_sales.sold_date_sk = d.d_date_sk INNER JOIN item i ON cs_or_ws_sales.item_sk = i.i_item_sk INNER JOIN customer c ON cs_or_ws_sales.customer_sk = c.c_customer_sk WHERE i.i_category = 'Electronics' AND i.i_class = 'personal' AND d.d_moy = 1 AND d.d_year = 1998 AND cs_or_ws_sales.wholesale_cost BETWEEN 35 AND 65 AND c.c_birth_year BETWEEN 1928 AND 1941"
        }
      ]
    }
  }
]