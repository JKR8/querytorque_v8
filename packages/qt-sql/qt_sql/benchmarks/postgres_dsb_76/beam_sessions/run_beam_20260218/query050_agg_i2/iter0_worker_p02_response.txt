{
  "probe_id": "dimension_prefetch_star",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering selective dimensions (date_dim d1, date_dim d2, store) into CTEs reduces input cardinality to the main join and aggregation. Explicit JOIN syntax enables better join reordering and selectivity estimation.",
  "reasoning_trace": [
    "Assigned transform targets dimension pre-filtering to reduce row input to expensive sort and aggregation.",
    "Comma-join syntax and non-equi join condition between d1 and d2 cause poor cardinality estimates.",
    "CTEs for small selective dimensions enable PostgreSQL to build efficient hash tables.",
    "Explicit JOINs preserve all original predicates and allow better optimization."
  ],
  "target_ir": "Three CTEs introduced for d1, d2, and store with selective filters; main query uses explicit JOINs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["store_sales", "store_returns", "d1_filtered", "d2_filtered", "store_filtered"],
        "outputs": ["s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
        "changed": true,
        "sql": "SELECT s.s_store_name ,s.s_company_id ,s.s_street_number ,s.s_street_name ,s.s_street_type ,s.s_suite_number ,s.s_city ,s.s_county ,s.s_state ,s.s_zip ,sum(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\" ,sum(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 30) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\" ,sum(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 60) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\" ,sum(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 90) AND (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\" ,sum(CASE WHEN (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM store_sales ss JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN d1_filtered d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN d2_filtered d2 ON sr.sr_returned_date_sk = d2.d_date_sk JOIN store_filtered s ON ss.ss_store_sk = s.s_store_sk WHERE d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date GROUP BY s.s_store_name ,s.s_company_id ,s.s_street_number ,s.s_street_name ,s.s_street_type ,s.s_suite_number ,s.s_city ,s.s_county ,s.s_state ,s.s_zip ORDER BY s.s_store_name ,s.s_company_id ,s.s_street_number ,s.s_street_name ,s.s_street_type ,s.s_suite_number ,s.s_city ,s.s_county ,s.s_state ,s.s_zip LIMIT 100"
      },
      {
        "node_id": "d1_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim"
      },
      {
        "node_id": "d2_filtered",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk", "d_date"],
        "changed": true,
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
      },
      {
        "node_id": "store_filtered",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_store_name", "s_company_id", "s_street_number", "s_street_name", "s_street_type", "s_suite_number", "s_city", "s_county", "s_state", "s_zip"],
        "changed": true,
        "sql": "SELECT s_store_sk, s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip FROM store"
      }
    ]
  }
}