{
  "probe_id": "p0",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Shared dimension filters (date_dim, item) are scanned repeatedly across three correlated EXISTS branches. Materializing them once into CTEs should reduce redundant I/O while preserving all output semantics.",
  "reasoning_trace": [
    "Three correlated EXISTS subqueries each scan date_dim and item with identical filters.",
    "PostgreSQL materializes CTEs by default, enabling reuse without repeated scans.",
    "Each CTE includes required join keys and filter columns to maintain downstream compatibility."
  ],
  "target_ir": "Two new CTEs (filtered_date, filtered_item) encapsulate shared dimension scans. Original EXISTS branches now reference these CTEs instead of base tables.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": [
          "cd_gender",
          "cd_marital_status",
          "cd_education_status",
          "cnt1",
          "cd_purchase_estimate",
          "cnt2",
          "cd_credit_rating",
          "cnt3",
          "cd_dep_count",
          "cnt4",
          "cd_dep_employed_count",
          "cnt5",
          "cd_dep_college_count",
          "cnt6"
        ],
        "changed": true,
        "sql": "WITH filtered_date AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11\n),\nfiltered_item AS (\n  SELECT i_item_sk\n  FROM item\n  WHERE i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75\n)\nselect \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3,\n  cd_dep_count,\n  count(*) cnt4,\n  cd_dep_employed_count,\n  count(*) cnt5,\n  cd_dep_college_count,\n  count(*) cnt6\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  ca_county in ('Grays Harbor County','Kootenai County','Pike County','Thomas County','Uinta County') and\n  c.c_birth_month in (1, 5) and\n  cd_demo_sk = c.c_current_cdemo_sk\n  and cd_marital_status in ('U', 'U', 'M')\n  and cd_education_status in ('College', 'Primary', '2 yr Degree')\n  and cd_gender = 'M' and\n  exists (select *\n          from store_sales,filtered_date, filtered_item\n          where c.c_customer_sk = ss_customer_sk and\n                ss_sold_date_sk = d_date_sk and\n                ss_item_sk = i_item_sk and\n                ss_sales_price / ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n                ) and\n   (exists (select *\n            from web_sales,filtered_date, filtered_item\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_sold_date_sk = d_date_sk and\n                  ws_item_sk = i_item_sk and\n                  ws_sales_price / ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n                  ) or\n    exists (select *\n            from catalog_sales,filtered_date, filtered_item\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_sold_date_sk = d_date_sk and\n                  cs_item_sk = i_item_sk and\n                  cs_sales_price / cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01\n                  ))\n group by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\n order by cd_gender,\n          cd_marital_status,\n          cd_education_status,\n          cd_purchase_estimate,\n          cd_credit_rating,\n          cd_dep_count,\n          cd_dep_employed_count,\n          cd_dep_college_count\nlimit 100;"
      }
    ]
  }
}