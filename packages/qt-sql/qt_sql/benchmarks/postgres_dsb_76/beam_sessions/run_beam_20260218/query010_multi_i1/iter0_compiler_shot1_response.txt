[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.5,
    "based_on": "p02,p03",
    "strategy": "Materialize shared dimension filters into CTEs and convert comma joins to explicit joins within EXISTS subqueries to avoid repeated scans.",
    "hypothesis": "Probes p02 and p03 attempted to reduce repeated dimension scans but regressed, possibly due to CTE materialization fences. This attempt keeps dimension CTEs but uses explicit joins inside EXISTS to preserve semi-join shape and avoid over-materialization.",
    "expected_explain_delta": "Nested-loop inner side scans of date_dim and item should become CTE scans; repeated index scans on these dimensions should disappear.",
    "target_ir": "Add filtered_date and filtered_item CTEs; update EXISTS subqueries to use explicit joins with these CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "customer_address", "customer_demographics", "filtered_date", "filtered_item"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
          "changed": true,
          "sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75) SELECT cd_gender, cd_marital_status, cd_education_status, count(*) cnt1, cd_purchase_estimate, count(*) cnt2, cd_credit_rating, count(*) cnt3, cd_dep_count, count(*) cnt4, cd_dep_employed_count, count(*) cnt5, cd_dep_college_count, count(*) cnt6 FROM customer c, customer_address ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Grays Harbor County','Kootenai County','Pike County','Thomas County','Uinta County') AND c.c_birth_month IN (1, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'U', 'M') AND cd_education_status IN ('College', 'Primary', '2 yr Degree') AND cd_gender = 'M' AND EXISTS (SELECT 1 FROM store_sales JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk JOIN filtered_item ON ss_item_sk = filtered_item.i_item_sk WHERE c.c_customer_sk = ss_customer_sk AND ss_sales_price / ss_list_price BETWEEN 20 * 0.01 AND 30 * 0.01) AND (EXISTS (SELECT 1 FROM web_sales JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk JOIN filtered_item ON ws_item_sk = filtered_item.i_item_sk WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sales_price / ws_list_price BETWEEN 20 * 0.01 AND 30 * 0.01) OR EXISTS (SELECT 1 FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk JOIN filtered_item ON cs_item_sk = filtered_item.i_item_sk WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sales_price / cs_list_price BETWEEN 20 * 0.01 AND 30 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100"
        },
        {
          "node_id": "filtered_date",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 8 AND 11"
        },
        {
          "node_id": "filtered_item",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk"],
          "changed": true,
          "sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music') AND i_manager_id BETWEEN 66 AND 75"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.2,
    "based_on": "",
    "strategy": "No-change fallback due to insufficient safe evidence.",
    "hypothesis": "All probes failed or regressed; no validated safe pathway exists. Original plan uses PostgreSQL semi-join EXISTS and BitmapOr for OR branches; aggressive decorrelation or CTE materialization risks regression.",
    "expected_explain_delta": "None.",
    "target_ir": "Preserve original tree.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
          "changed": false
        }
      ]
    }
  }
]