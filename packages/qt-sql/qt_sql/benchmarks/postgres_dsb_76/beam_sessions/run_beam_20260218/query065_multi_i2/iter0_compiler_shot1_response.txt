[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Single-pass aggregation via CTE to eliminate duplicate fact-table scans and aggregations.",
    "hypothesis": "The original plan shows duplicate nested-loop scans of store_sales and date_dim for subqueries sb and sc, each taking ~2.4s. Consolidating into a single CTE eliminates one scan and reduces Merge Join input from two large streams to one.",
    "expected_explain_delta": "Remove one Nested Loop (store_sales+date_dim) and its Aggregate, reducing Merge Join input rows.",
    "target_ir": "Replace two identical subqueries (sa and sc) with a single CTE (revenue_by_store_item), compute store-level average in a second CTE, join once.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store", "item", "revenue_by_store_item", "store_average"],
          "outputs": ["s_store_name", "i_item_desc", "revenue", "i_current_price", "i_wholesale_cost", "i_brand"],
          "changed": true,
          "sql": "WITH revenue_by_store_item AS (\n    SELECT ss_store_sk, ss_item_sk, SUM(ss_sales_price) AS revenue\n    FROM store_sales\n    JOIN date_dim ON ss_sold_date_sk = d_date_sk\n    WHERE d_month_seq BETWEEN 1215 AND 1215+11\n      AND ss_sales_price / ss_list_price BETWEEN 79 * 0.01 AND 89 * 0.01\n    GROUP BY ss_store_sk, ss_item_sk\n),\nstore_average AS (\n    SELECT ss_store_sk, AVG(revenue) AS ave\n    FROM revenue_by_store_item\n    GROUP BY ss_store_sk\n)\nSELECT s.s_store_name, i.i_item_desc, r.revenue, i.i_current_price, i.i_wholesale_cost, i.i_brand\nFROM store s\nJOIN revenue_by_store_item r ON s.s_store_sk = r.ss_store_sk\nJOIN store_average sa ON r.ss_store_sk = sa.ss_store_sk\nJOIN item i ON i.i_item_sk = r.ss_item_sk\nWHERE s.s_state IN ('KS','OH','SD')\n  AND i.i_manager_id BETWEEN 10 AND 14\n  AND r.revenue <= 0.1 * sa.ave\nORDER BY s.s_store_name, i.i_item_desc\nLIMIT 100"
        }
      ]
    }
  }
]