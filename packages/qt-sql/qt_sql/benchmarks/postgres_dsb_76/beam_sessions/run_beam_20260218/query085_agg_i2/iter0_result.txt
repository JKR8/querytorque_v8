{
  "iteration": 0,
  "n_api_calls": 13,
  "beam_cost_usd": 0.02626274,
  "beam_cost_priced_calls": 9,
  "beam_cost_unpriced_calls": 4,
  "beam_token_totals": {
    "prompt_tokens": 114474,
    "completion_tokens": 15676,
    "total_tokens": 130150,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 58368,
    "reasoning_tokens": 3356
  },
  "best_speedup": 0.0,
  "best_patch_id": null,
  "best_sql": null,
  "patches": [
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.0,
      "semantic_passed": true,
      "error": null,
      "original_ms": 807.9,
      "patch_ms": 176725.9,
      "output_sql": "WITH date_dim_cte AS MATERIALIZED (SELECT d_date_sk, d_year FROM date_dim WHERE d_year = 2002),\n     cd1_cte AS MATERIALIZED (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S','M','U') AND cd_education_status IN ('Primary','Secondary','2 yr Degree')),\n     cd2_cte AS MATERIALIZED (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status IN ('S','M','U') AND cd_education_status IN ('Primary','Secondary','2 yr Degree')),\n     ca_cte AS MATERIALIZED (SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')),\n     reason_cte AS MATERIALIZED (SELECT r_reason_sk, r_reason_desc FROM reason),\n     web_page_cte AS MATERIALIZED (SELECT wp_web_page_sk FROM web_page)\nSELECT\n  substring(r_reason_desc,1,20),\n  avg(ws_quantity),\n  avg(wr_refunded_cash),\n  avg(wr_fee)\nFROM web_sales\nJOIN web_returns ON web_sales.ws_item_sk = web_returns.wr_item_sk AND web_sales.ws_order_number = web_returns.wr_order_number\nJOIN web_page_cte ON web_sales.ws_web_page_sk = web_page_cte.wp_web_page_sk\nJOIN cd1_cte ON cd1_cte.cd_demo_sk = web_returns.wr_refunded_cdemo_sk\nJOIN cd2_cte ON cd2_cte.cd_demo_sk = web_returns.wr_returning_cdemo_sk\nJOIN ca_cte ON ca_cte.ca_address_sk = web_returns.wr_refunded_addr_sk\nJOIN reason_cte ON reason_cte.r_reason_sk = web_returns.wr_reason_sk\nJOIN date_dim_cte ON web_sales.ws_sold_date_sk = date_dim_cte.d_date_sk\nWHERE (\n  (cd1_cte.cd_marital_status = 'S' AND cd1_cte.cd_marital_status = cd2_cte.cd_marital_status AND cd1_cte.cd_education_status = 'Primary' AND cd1_cte.cd_education_status = cd2_cte.cd_education_status AND web_sales.ws_sales_price BETWEEN 100.00 AND 150.00)\n  OR\n  (cd1_cte.cd_marital_status = 'M' AND cd1_cte.cd_marital_status = cd2_cte.cd_marital_status AND cd1_cte.cd_education_status = 'Secondary' AND cd1_cte.cd_education_status = cd2_cte.cd_education_status AND web_sales.ws_sales_price BETWEEN 50.00 AND 100.00)\n  OR\n  (cd1_cte.cd_marital_status = 'U' AND cd1_cte.cd_marital_status = cd2_cte.cd_marital_status AND cd1_cte.cd_education_status = '2 yr Degree' AND cd1_cte.cd_education_status = cd2_cte.cd_education_status AND web_sales.ws_sales_price BETWEEN 150.00 AND 200.00)\n) AND (\n  (ca_cte.ca_country = 'United States' AND ca_cte.ca_state IN ('KY', 'NC', 'SD') AND web_sales.ws_net_profit BETWEEN 100 AND 200)\n  OR\n  (ca_cte.ca_country = 'United States' AND ca_cte.ca_state IN ('AR', 'GA', 'IN') AND web_sales.ws_net_profit BETWEEN 150 AND 300)\n  OR\n  (ca_cte.ca_country = 'United States' AND ca_cte.ca_state IN ('KS', 'OH', 'VA') AND web_sales.ws_net_profit BETWEEN 50 AND 250)\n)\nGROUP BY r_reason_desc\nORDER BY substring(r_reason_desc,1,20), avg(ws_quantity), avg(wr_refunded_cash), avg(wr_fee)\nLIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, cd1, cd2, customer_address, reason, web_page) into CTEs with MATERIALIZED, then join fact tables (web_sales, web_returns) via explicit INNER JOIN syntax."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.75,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column \"ws_quantity\" does not exist\nLINE 1: ...ason) SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantit...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), web_sales AS (SELECT ws_item_sk, ws_order_number, ws_web_page_sk, ws_sold_date_sk, ws_sales_price, ws_net_profit FROM web_sales), web_returns AS (SELECT wr_item_sk, wr_order_number, wr_refunded_cdemo_sk, wr_returning_cdemo_sk, wr_refunded_addr_sk, wr_reason_sk, wr_refunded_cash, wr_fee FROM web_returns), web_page AS (SELECT wp_web_page_sk FROM web_page), customer_demographics_cd1 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics), customer_demographics_cd2 AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics), customer_address AS (SELECT ca_address_sk, ca_country, ca_state FROM customer_address), reason AS (SELECT r_reason_sk, r_reason_desc FROM reason) SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM web_sales INNER JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number INNER JOIN web_page ON ws_web_page_sk = wp_web_page_sk INNER JOIN customer_demographics AS cd1 ON cd1.cd_demo_sk = wr_refunded_cdemo_sk INNER JOIN customer_demographics AS cd2 ON cd2.cd_demo_sk = wr_returning_cdemo_sk INNER JOIN customer_address ON ca_address_sk = wr_refunded_addr_sk INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk INNER JOIN reason ON r_reason_sk = wr_reason_sk WHERE ((cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD') AND ws_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'GA', 'IN') AND ws_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'VA') AND ws_net_profit BETWEEN 50 AND 250)) GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Isolate date_dim filter into a MATERIALIZED CTE, convert comma joins to explicit INNER JOINs, and join fact tables with date keys first."
    },
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "early_filter",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH cd1_filtered AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary') OR (cd_marital_status = 'U' AND cd_education_status = '2 yr Degree')), cd2_filtered AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary') OR (cd_marital_status = 'U' AND cd_education_status = '2 yr Degree')), ca_filtered AS (SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD')) OR (ca_country = 'United States' AND ca_state IN ('AR', 'GA', 'IN')) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'VA'))), web_sales AS (SELECT ws_item_sk, ws_order_number, ws_web_page_sk, ws_sold_date_sk, ws_quantity, ws_sales_price, ws_net_profit FROM web_sales), web_returns AS (SELECT wr_item_sk, wr_order_number, wr_refunded_cdemo_sk, wr_returning_cdemo_sk, wr_refunded_addr_sk, wr_reason_sk, wr_refunded_cash, wr_fee FROM web_returns), web_page AS (SELECT wp_web_page_sk FROM web_page), date_dim AS (SELECT d_date_sk, d_year FROM date_dim), reason AS (SELECT r_reason_sk, r_reason_desc FROM reason) SELECT SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM web_sales JOIN web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number JOIN web_page ON ws_web_page_sk = wp_web_page_sk JOIN cd1_filtered ON cd1_filtered.cd_demo_sk = wr_refunded_cdemo_sk JOIN cd2_filtered ON cd2_filtered.cd_demo_sk = wr_returning_cdemo_sk JOIN ca_filtered ON ca_filtered.ca_address_sk = wr_refunded_addr_sk JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN reason ON r_reason_sk = wr_reason_sk WHERE d_year = 2002 GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc, 1, 20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter customer_demographics and customer_address with their complex OR conditions into separate CTEs before joining to fact tables."
    },
    {
      "patch_id": "p04",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.5,
      "status": "REGRESSION",
      "speedup": 0.84,
      "semantic_passed": true,
      "error": null,
      "original_ms": 807.9,
      "patch_ms": 956.7,
      "output_sql": "select  substring(r_reason_desc,1,20)\n       ,avg(ws_quantity)\n       ,avg(wr_refunded_cash)\n       ,avg(wr_fee)\n from web_sales, web_returns, web_page, customer_demographics cd1,\n      customer_demographics cd2, customer_address, date_dim, reason\n where ws_web_page_sk = wp_web_page_sk\n   and ws_item_sk = wr_item_sk\n   and ws_order_number = wr_order_number\n   and ws_sold_date_sk = d_date_sk and d_year = 2002\n   and cd1.cd_demo_sk = wr_refunded_cdemo_sk\n   and cd2.cd_demo_sk = wr_returning_cdemo_sk\n   and ca_address_sk = wr_refunded_addr_sk\n   and r_reason_sk = wr_reason_sk\n   and\n   (\n    (\n     cd1.cd_marital_status = 'S'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = 'Primary'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 100.00 and 150.00\n    )\n   or\n    (\n     cd1.cd_marital_status = 'M'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = 'Secondary'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 50.00 and 100.00\n    )\n   or\n    (\n     cd1.cd_marital_status = 'U'\n     and\n     cd1.cd_marital_status = cd2.cd_marital_status\n     and\n     cd1.cd_education_status = '2 yr Degree'\n     and\n     cd1.cd_education_status = cd2.cd_education_status\n     and\n     ws_sales_price between 150.00 and 200.00\n    )\n   )\n   and\n   (\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('KY', 'NC', 'SD')\n     and ws_net_profit between 100 and 200\n    )\n    or\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('AR', 'GA', 'IN')\n     and ws_net_profit between 150 and 300\n    )\n    or\n    (\n     ca_country = 'United States'\n     and\n     ca_state in ('KS', 'OH', 'VA')\n     and ws_net_profit between 50 and 250\n    )\n   )\ngroup by r_reason_desc\norder by substring(r_reason_desc,1,20)\n        ,avg(ws_quantity)\n        ,avg(wr_refunded_cash)\n        ,avg(wr_fee)\nlimit 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered dimension joins into a single CTE to avoid repeated evaluation of OR predicates across nested loops."
    }
  ],
  "explains": {
    "p01": "Limit  (rows=16, time=187001.444)\n  Index Only Scan on date_dim  (rows=365, time=0.121)\n  Seq Scan on customer_demographics  (rows=493920, time=291.807)\n  Seq Scan on customer_demographics (customer_demographics_1)  (rows=493920, time=467.961)\n  Seq Scan on customer_address  (rows=73297, time=33.489)\n  Seq Scan on reason  (rows=45, time=0.026)\n  Seq Scan on web_page  (rows=200, time=0.035)\n  Sort  (rows=16, time=187001.437)\n    Aggregate  (rows=16, time=187001.395)\n      Sort  (rows=21, time=187",
    "p04": "Limit  (rows=16, time=13881.467)\n  Sort  (rows=16, time=13881.463)\n    Aggregate  (rows=16, time=13881.429)\n      Gather Merge  (rows=20, time=13881.365)\n        Aggregate  (rows=7, time=12943.323)\n          Sort  (rows=7, time=12943.302)\n            Nested Loop  (rows=7, time=12943.256)\n              Nested Loop  (rows=7, time=12943.169)\n                Nested Loop  (rows=7, time=12943.124)\n                  Nested Loop  (rows=7, time=12937.043)\n                    Nested Loop  (rows=348, time="
  }
}