{
  "probe_id": "scout_1",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing the filtered store_sales + item1 + date_dim + customer + customer_demographics + customer_address chain into a CTE reduces repeated scans and enables accurate cardinality estimation for the self-join on ss_ticket_number.",
  "reasoning_trace": [
    "Assigned transform targets self-join decomposition with materialization.",
    "CTE reuse is validated by G_PG_CTE_REUSE_REQUIRED:PASS.",
    "No duplication risk per G_PG_CTE_DUPLICATION_BLOCK:PASS."
  ],
  "target_ir": "Introduce materialized CTE for shared scan path; self-join rewritten to reference CTE twice.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["self_join_cte"],
        "outputs": ["item1.i_item_sk", "item2.i_item_sk", "count(*) as cnt"],
        "changed": true,
        "sql": "SELECT cte1.i_item_sk AS i_item_sk1, cte2.i_item_sk AS i_item_sk2, COUNT(*) AS cnt FROM self_join_cte cte1 JOIN self_join_cte cte2 ON cte1.ss_ticket_number = cte2.ss_ticket_number WHERE cte1.i_item_sk < cte2.i_item_sk GROUP BY cte1.i_item_sk, cte2.i_item_sk ORDER BY cnt"
      },
      {
        "node_id": "self_join_cte",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "item", "date_dim", "customer", "customer_address", "customer_demographics"],
        "outputs": [
          "ss_ticket_number",
          "i_item_sk",
          "ss_list_price"
        ],
        "changed": true,
        "sql": "SELECT s1.ss_ticket_number, item1.i_item_sk, s1.ss_list_price FROM store_sales s1 JOIN item item1 ON s1.ss_item_sk = item1.i_item_sk JOIN date_dim d ON s1.ss_sold_date_sk = d.d_date_sk JOIN customer c ON s1.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE d.d_year BETWEEN 1999 AND 2000 AND item1.i_category IN ('Electronics', 'Men') AND cd.marital_status = 'D' AND cd.education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129"
      }
    ]
  }
}