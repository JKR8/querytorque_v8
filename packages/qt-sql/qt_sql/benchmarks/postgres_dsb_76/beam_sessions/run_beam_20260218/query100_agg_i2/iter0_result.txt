{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.03366685,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 127536,
    "completion_tokens": 24989,
    "total_tokens": 152525,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 46784,
    "reasoning_tokens": 13252
  },
  "best_speedup": 1.15,
  "best_patch_id": "p01",
  "best_sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year BETWEEN 1999 AND 1999 + 1\n)\nSELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt\nFROM item AS item1\nJOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk\nJOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk\nJOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number\nJOIN customer ON s1.ss_customer_sk = c_customer_sk\nJOIN customer_address ON c_current_addr_sk = ca_address_sk\nJOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk\nJOIN filtered_date_dim ON d_date_sk = s1.ss_sold_date_sk\nWHERE item1.i_category IN ('Electronics', 'Men')\n  AND item2.i_manager_id BETWEEN 44 AND 63\n  AND cd_marital_status = 'D'\n  AND cd_education_status = 'College'\n  AND s1.ss_list_price BETWEEN 115 AND 129\n  AND s2.ss_list_price BETWEEN 115 AND 129\nGROUP BY item1.i_item_sk, item2.i_item_sk\nORDER BY cnt;",
  "patches": [
    {
      "patch_id": "p01",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 1.15,
      "semantic_passed": true,
      "error": null,
      "original_ms": 2990.9,
      "patch_ms": 2609.2,
      "output_sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year BETWEEN 1999 AND 1999 + 1\n)\nSELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt\nFROM item AS item1\nJOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk\nJOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk\nJOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number\nJOIN customer ON s1.ss_customer_sk = c_customer_sk\nJOIN customer_address ON c_current_addr_sk = ca_address_sk\nJOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk\nJOIN filtered_date_dim ON d_date_sk = s1.ss_sold_date_sk\nWHERE item1.i_category IN ('Electronics', 'Men')\n  AND item2.i_manager_id BETWEEN 44 AND 63\n  AND cd_marital_status = 'D'\n  AND cd_education_status = 'College'\n  AND s1.ss_list_price BETWEEN 115 AND 129\n  AND s2.ss_list_price BETWEEN 115 AND 129\nGROUP BY item1.i_item_sk, item2.i_item_sk\nORDER BY cnt;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma-separated FROM to explicit JOIN syntax and isolate filtered date_dim into a materialized CTE to create a tiny hash table for early join."
    },
    {
      "patch_id": "p03",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 1 missing, 2 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH self_join_cte AS (SELECT s1.ss_ticket_number, item1.i_item_sk, s1.ss_list_price FROM store_sales s1 JOIN item item1 ON s1.ss_item_sk = item1.i_item_sk JOIN date_dim d ON s1.ss_sold_date_sk = d.d_date_sk JOIN customer c ON s1.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE d.d_year BETWEEN 1999 AND 2000 AND item1.i_category IN ('Electronics', 'Men') AND cd.cd_marital_status = 'D' AND cd.cd_education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129) SELECT cte1.i_item_sk AS item1_i_item_sk, cte2.i_item_sk AS item2_i_item_sk, COUNT(*) AS cnt FROM self_join_cte cte1 JOIN self_join_cte cte2 ON cte1.ss_ticket_number = cte2.ss_ticket_number WHERE cte1.i_item_sk < cte2.i_item_sk GROUP BY cte1.i_item_sk, cte2.i_item_sk ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the filtered store_sales + item1 + date_dim + customer + customer_demographics + customer_address chain into a CTE, then self-join on ss_ticket_number with item2 to satisfy item1.i_item_sk < item2.i_item_sk."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Row count: orig=368, patch=317206",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_data AS (SELECT i.i_item_sk, s.ss_ticket_number, s.ss_customer_sk, s.ss_list_price FROM store_sales s JOIN item i ON s.ss_item_sk = i.i_item_sk JOIN date_dim d ON s.ss_sold_date_sk = d.d_date_sk JOIN customer c ON s.ss_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE d.d_year BETWEEN 1999 AND 2000 AND i.i_category IN ('Electronics', 'Men') AND i.i_manager_id BETWEEN 44 AND 63 AND cd.cd_marital_status = 'D' AND cd.cd_education_status = 'College' AND s.ss_list_price BETWEEN 115 AND 129) SELECT item1.i_item_sk, item2.i_item_sk, count(*) as cnt FROM filtered_data AS item1 JOIN filtered_data AS item2 ON item1.i_item_sk < item2.i_item_sk GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create a materialized CTE that pre-filters date_dim, customer, customer_demographics, customer_address and joins with store_sales s1 and item1, then join with store_sales s2 and item2 using explicit joins and the non-equi condition item1.i_item_sk < item2.i_item_sk."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.8,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column cd.marital_status does not exist\nLINE 1: ...en') AND item2.i_manager_id BETWEEN 44 AND 63 AND cd.marital...\n                                                             ^\nHINT:  Perhaps you meant to reference the column \"cd.cd_marital_status\".\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH prefetch_date_dim AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1), prefetch_customer AS (SELECT c_customer_sk, c_current_addr_sk, c_current_cdemo_sk FROM customer), prefetch_customer_demographics AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE cd_marital_status = 'D' AND cd_education_status = 'College'), prefetch_customer_address AS (SELECT ca_address_sk FROM customer_address), item1 AS (SELECT i_item_sk, i_category FROM item WHERE i_category IN ('Electronics', 'Men')), item2 AS (SELECT i_item_sk, i_manager_id FROM item WHERE i_manager_id BETWEEN 44 AND 63), s1 AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_list_price, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129), s2 AS (SELECT ss_item_sk, ss_ticket_number, ss_list_price FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129) SELECT item1.i_item_sk, item2.i_item_sk, count(*) as cnt FROM item AS item1 JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN prefetch_date_dim AS d ON d.d_date_sk = s1.ss_sold_date_sk JOIN prefetch_customer AS c ON s1.ss_customer_sk = c.c_customer_sk JOIN prefetch_customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN prefetch_customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE d.d_year BETWEEN 1999 AND 1999 + 1 AND item1.i_category IN ('Electronics', 'Men') AND item2.i_manager_id BETWEEN 44 AND 63 AND cd.marital_status = 'D' AND cd.education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129 AND s2.ss_list_price BETWEEN 115 AND 129 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, customer, customer_demographics, customer_address) into separate materialized CTEs, then join them with fact tables using explicit JOIN syntax."
    },
    {
      "patch_id": "compile_p01",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.81,
      "semantic_passed": true,
      "error": null,
      "original_ms": 5294.4,
      "patch_ms": 6528.4,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1) SELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt FROM item AS item1 JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN customer ON s1.ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN filtered_date_dim ON d_date_sk = s1.ss_sold_date_sk WHERE item1.i_category IN ('Electronics', 'Men') AND item2.i_manager_id BETWEEN 44 AND 63 AND cd_marital_status = 'D' AND cd_education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129 AND s2.ss_list_price BETWEEN 115 AND 129 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p01",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "NEUTRAL",
      "speedup": 0.95,
      "semantic_passed": true,
      "error": null,
      "original_ms": 5294.4,
      "patch_ms": 5556.1,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1) SELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt FROM item AS item1 JOIN item AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN store_sales AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN store_sales AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN customer ON s1.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk JOIN filtered_date_dim ON filtered_date_dim.d_date_sk = s1.ss_sold_date_sk WHERE item1.i_category IN ('Electronics', 'Men') AND item2.i_manager_id BETWEEN 44 AND 63 AND customer_demographics.cd_marital_status = 'D' AND customer_demographics.cd_education_status = 'College' AND s1.ss_list_price BETWEEN 115 AND 129 AND s2.ss_list_price BETWEEN 115 AND 129 GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p02_fixed",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.81,
      "semantic_passed": true,
      "error": null,
      "original_ms": 5294.4,
      "patch_ms": 6526.4,
      "output_sql": "WITH prefetch_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 1999 AND 1999 + 1), prefetch_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'D' AND cd_education_status = 'College'), prefetch_item1 AS (SELECT i_item_sk FROM item WHERE i_category IN ('Electronics', 'Men')), prefetch_item2 AS (SELECT i_item_sk FROM item WHERE i_manager_id BETWEEN 44 AND 63), prefetch_s1 AS (SELECT ss_item_sk, ss_ticket_number, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129), prefetch_s2 AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales WHERE ss_list_price BETWEEN 115 AND 129) SELECT item1.i_item_sk, item2.i_item_sk, COUNT(*) AS cnt FROM prefetch_item1 AS item1 JOIN prefetch_item2 AS item2 ON item1.i_item_sk < item2.i_item_sk JOIN prefetch_s1 AS s1 ON s1.ss_item_sk = item1.i_item_sk JOIN prefetch_s2 AS s2 ON s2.ss_item_sk = item2.i_item_sk AND s1.ss_ticket_number = s2.ss_ticket_number JOIN customer ON s1.ss_customer_sk = customer.c_customer_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk JOIN prefetch_customer_demographics AS cd ON customer.c_current_cdemo_sk = cd.cd_demo_sk JOIN prefetch_date_dim AS d ON s1.ss_sold_date_sk = d.d_date_sk GROUP BY item1.i_item_sk, item2.i_item_sk ORDER BY cnt;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Sort  (rows=368, time=3133.727)\n  Aggregate  (rows=368, time=3133.6)\n    Gather Merge  (rows=838, time=3133.432)\n      Incremental Sort  (rows=279, time=2681.298)\n        Nested Loop  (rows=279, time=2680.18)\n          Nested Loop  (rows=279, time=2676.224)\n            Nested Loop  (rows=6540, time=2637.254)\n              Nested Loop  (rows=3655, time=2561.146)\n                Nested Loop  (rows=84279, time=1713.651)\n                  Merge Join  (rows=85310, time=963.093)\n                    So",
    "compile_p01": "Sort  (rows=368, time=4329.015)\n  Aggregate  (rows=368, time=4328.902)\n    Gather Merge  (rows=838, time=4328.735)\n      Incremental Sort  (rows=419, time=4049.069)\n        Nested Loop  (rows=419, time=4047.792)\n          Nested Loop  (rows=419, time=4043.35)\n            Nested Loop  (rows=9810, time=3990.988)\n              Nested Loop  (rows=5482, time=3813.404)\n                Nested Loop  (rows=126418, time=2629.148)\n                  Merge Join  (rows=127965, time=1630.632)\n                 ",
    "compile_p02_fixed": "Sort  (rows=368, time=3515.042)\n  Aggregate  (rows=368, time=3514.943)\n    Gather Merge  (rows=838, time=3514.783)\n      Incremental Sort  (rows=419, time=3180.813)\n        Nested Loop  (rows=419, time=3179.781)\n          Nested Loop  (rows=419, time=3176.366)\n            Nested Loop  (rows=9810, time=3136.632)\n              Nested Loop  (rows=5482, time=3054.426)\n                Nested Loop  (rows=126418, time=2130.456)\n                  Merge Join  (rows=127965, time=1368.965)\n                "
  }
}