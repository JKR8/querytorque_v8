[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p06",
    "strategy": "Materialize filtered fact and date dimension CTEs to break nested-loop correlation.",
    "hypothesis": "Winning probe p06 (1.27x) addressed primary hotspot by prefiltering catalog_sales and date_dim, removing repeated index scans. Keep comma join syntax as original but apply early filters via CTEs.",
    "expected_explain_delta": "Nested-loop replaced by hash join; filtered_catalog_sales scan reduces input rows; date_dim scan moves to CTE index-only scan.",
    "target_ir": "Add filtered_date_dim and filtered_catalog_sales CTEs, update final_select to reference them.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_catalog_sales", "warehouse", "ship_mode", "call_center", "filtered_date_dim"],
          "outputs": ["SUBSTRING(w_warehouse_name FROM 1 FOR 20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "changed": true,
          "sql": "SELECT substring(w_warehouse_name,1,20), sm_type, cc_name, sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end) as \"30 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end ) as \"31-60 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end) as \">120 days\" FROM filtered_catalog_sales cs, warehouse w, ship_mode sm, call_center cc, filtered_date_dim d WHERE cs_ship_date_sk = d_date_sk AND cs_warehouse_sk = w_warehouse_sk AND cs_ship_mode_sk = sm_ship_mode_sk AND cs_call_center_sk = cc_call_center_sk AND sm_type = 'LIBRARY' AND cc_class = 'medium' AND w_gmt_offset = -5 GROUP BY substring(w_warehouse_name,1,20), sm_type, cc_name ORDER BY substring(w_warehouse_name,1,20), sm_type, cc_name LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales"],
          "outputs": ["cs_ship_date_sk", "cs_sold_date_sk", "cs_warehouse_sk", "cs_ship_mode_sk", "cs_call_center_sk", "cs_list_price"],
          "changed": true,
          "sql": "SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk, cs_list_price FROM catalog_sales WHERE cs_list_price BETWEEN 244 AND 273"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p06",
    "strategy": "Same CTE prefiltering but convert to explicit JOIN syntax to aid optimizer join reordering.",
    "hypothesis": "Explicit JOINs may improve join order flexibility while retaining early filter benefits. No evidence of regression from explicit joins in probes; safe semantic transformation.",
    "expected_explain_delta": "Same CTE scan reduction, but join operators may reorder more freely.",
    "target_ir": "Add filtered_date_dim and filtered_catalog_sales CTEs, rewrite final_select with explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_catalog_sales", "warehouse", "ship_mode", "call_center", "filtered_date_dim"],
          "outputs": ["SUBSTRING(w_warehouse_name FROM 1 FOR 20)", "sm_type", "cc_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"],
          "changed": true,
          "sql": "SELECT substring(w_warehouse_name,1,20), sm_type, cc_name, sum(case when (cs_ship_date_sk - cs_sold_date_sk <= 30 ) then 1 else 0 end) as \"30 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 30) and (cs_ship_date_sk - cs_sold_date_sk <= 60) then 1 else 0 end ) as \"31-60 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 60) and (cs_ship_date_sk - cs_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk > 90) and (cs_ship_date_sk - cs_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\", sum(case when (cs_ship_date_sk - cs_sold_date_sk  > 120) then 1 else 0 end) as \">120 days\" FROM filtered_catalog_sales cs JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN ship_mode sm ON cs.cs_ship_mode_sk = sm.sm_ship_mode_sk JOIN call_center cc ON cs.cs_call_center_sk = cc.cc_call_center_sk JOIN filtered_date_dim d ON cs.cs_ship_date_sk = d.d_date_sk WHERE sm.sm_type = 'LIBRARY' AND cc.cc_class = 'medium' AND w.w_gmt_offset = -5 GROUP BY substring(w_warehouse_name,1,20), sm_type, cc_name ORDER BY substring(w_warehouse_name,1,20), sm_type, cc_name LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1191 AND 1191 + 23"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales"],
          "outputs": ["cs_ship_date_sk", "cs_sold_date_sk", "cs_warehouse_sk", "cs_ship_mode_sk", "cs_call_center_sk", "cs_list_price"],
          "changed": true,
          "sql": "SELECT cs_ship_date_sk, cs_sold_date_sk, cs_warehouse_sk, cs_ship_mode_sk, cs_call_center_sk, cs_list_price FROM catalog_sales WHERE cs_list_price BETWEEN 244 AND 273"
        }
      ]
    }
  }
]