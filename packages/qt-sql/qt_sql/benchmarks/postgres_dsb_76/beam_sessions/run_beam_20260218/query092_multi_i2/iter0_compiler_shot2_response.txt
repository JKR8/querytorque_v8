[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p01",
    "strategy": "Decorrelation via precomputed per-item threshold using LEFT JOIN to preserve NULL semantics.",
    "hypothesis": "Correlated scalar subquery (SubPlan) executes 136 times with nested loops. Precomputing threshold per item and joining eliminates per-row re-execution, addressing the primary hotspot. Syntax error in p01 fixed by fully qualifying ambiguous column references.",
    "expected_explain_delta": "SubPlan nested loops disappear; replaced by a single hash aggregation and hash join.",
    "target_ir": "Replace correlated scalar subquery with precomputed CTE and LEFT JOIN.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["web_sales", "item", "date_dim", "item_avg_discount"],
          "outputs": ["Excess Discount Amount"],
          "changed": true,
          "sql": "WITH item_avg_discount AS (\n    SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM web_sales ws2\n    JOIN date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk\n    WHERE d2.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n      AND ws2.ws_wholesale_cost BETWEEN 35 AND 55\n      AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n    GROUP BY ws_item_sk\n)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales ws\nJOIN item i ON ws.ws_item_sk = i.i_item_sk\nJOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nLEFT JOIN item_avg_discount avgd ON ws.ws_item_sk = avgd.ws_item_sk\nWHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports'))\n  AND d.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\n  AND ws.ws_ext_discount_amt > avgd.threshold\nORDER BY SUM(ws.ws_ext_discount_amt)\nLIMIT 100;"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02",
    "strategy": "Explicit JOIN with filtered date dimension CTE to improve predicate pushdown.",
    "hypothesis": "Comma-join syntax may hinder predicate pushdown. Explicit JOIN with filtered date CTE allows better cardinality estimation and reduces build side of hash join. Addresses secondary hotspot (large item hash table).",
    "expected_explain_delta": "Hash join build side shrinks; date filter applied earlier; join order may improve.",
    "target_ir": "Convert comma joins to explicit INNER JOINs with filtered date CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_date_dim", "web_sales", "item"],
          "outputs": ["Excess Discount Amount"],
          "changed": true,
          "sql": "WITH filtered_date_dim AS (\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales ws\nJOIN item i ON ws.ws_item_sk = i.i_item_sk\nJOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nWHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports'))\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\n  AND ws.ws_ext_discount_amt > (\n      SELECT 1.3 * AVG(ws2.ws_ext_discount_amt)\n      FROM web_sales ws2\n      JOIN filtered_date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk\n      WHERE ws2.ws_item_sk = i.i_item_sk\n        AND ws2.ws_wholesale_cost BETWEEN 35 AND 55\n        AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n  )\nORDER BY SUM(ws.ws_ext_discount_amt)\nLIMIT 100;"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk\nFROM date_dim\nWHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'"
        }
      ]
    }
  }
]