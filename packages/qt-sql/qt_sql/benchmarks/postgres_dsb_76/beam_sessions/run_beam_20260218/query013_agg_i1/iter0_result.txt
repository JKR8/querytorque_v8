{
  "iteration": 0,
  "n_api_calls": 10,
  "beam_cost_usd": 0.03472262,
  "beam_cost_priced_calls": 10,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 128191,
    "completion_tokens": 25212,
    "total_tokens": 153403,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 45760,
    "reasoning_tokens": 12196
  },
  "best_speedup": 1.36,
  "best_patch_id": "compile_explicit_joins",
  "best_sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2001 AND ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
  "patches": [
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.85,
      "status": "REGRESSION",
      "speedup": 0.92,
      "semantic_passed": true,
      "error": null,
      "original_ms": 567.0,
      "patch_ms": 616.9,
      "output_sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN date_filter ON ss_sold_date_sk = d_date_sk WHERE ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert comma joins to explicit INNER JOINs and pre-filter date_dim into a CTE, creating a tiny hash table for the fact-table probe."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.7,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column \"hd_dep_count\" does not exist\nLINE 1: ... AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_cou...\n                                                             ^\nHINT:  Perhaps you meant to reference the column \"customer_demographics.cd_dep_count\".\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_store_sales AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit, ss_cdemo_sk, ss_addr_sk, ss_hdemo_sk, ss_sales_price FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN store ON s_store_sk = ss_store_sk WHERE d_year = 2001) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM filtered_store_sales JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create a CTE that joins store_sales with filtered date_dim, household_demographics, and store, then join the result with filtered customer_demographics and customer_address."
    },
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.8,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year = 2001), filtered_store AS (SELECT s_store_sk FROM store), filtered_customer_demographics AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics), filtered_household_demographics AS (SELECT hd_demo_sk, hd_dep_count FROM household_demographics), filtered_customer_address AS (SELECT ca_address_sk, ca_country, ca_state FROM customer_address), joined_data AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales ss JOIN filtered_date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_store s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_customer_demographics cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN filtered_customer_address ca ON ss.ss_addr_sk = ca.ca_address_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'U' AND cd.cd_education_status = 'College' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Unknown' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('CO', 'NC', 'TX') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'NY', 'TX') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('IA', 'IL', 'NC') AND ss.ss_net_profit BETWEEN 50 AND 250))) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM joined_data;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions (date_dim, household_demographics, store, customer_demographics, customer_address) into separate CTEs, then join them with store_sales using explicit JOINs."
    },
    {
      "patch_id": "p03",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select avg(ss_quantity)\n,avg(ss_ext_sales_price)\n,avg(ss_ext_wholesale_cost)\n,sum(ss_ext_wholesale_cost)\nfrom store_sales\n   ,store\n   ,customer_demographics\n   ,household_demographics\n   ,customer_address\n   ,date_dim\nwhere s_store_sk = ss_store_sk\nand  ss_sold_date_sk = d_date_sk and d_year = 2001\nand((ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'M'\nand cd_education_status = '2 yr Degree'\nand ss_sales_price between 100.00 and 150.00\nand hd_dep_count = 3\n   )or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'U'\nand cd_education_status = 'College'\nand ss_sales_price between 50.00 and 100.00\nand hd_dep_count = 1\n   ) or\n   (ss_hdemo_sk=hd_demo_sk\nand cd_demo_sk = ss_cdemo_sk\nand cd_marital_status = 'S'\nand cd_education_status = 'Unknown'\nand ss_sales_price between 150.00 and 200.00\nand hd_dep_count = 1\n   ))\nand((ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('CO', 'NC', 'TX')\nand ss_net_profit between 100 and 200\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('AR', 'NY', 'TX')\nand ss_net_profit between 150 and 300\n   ) or\n   (ss_addr_sk = ca_address_sk\nand ca_country = 'United States'\nand ca_state in ('IA', 'IL', 'NC')\nand ss_net_profit between 50 and 250\n   ));",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Split the three OR branches on customer_demographics/household_demographics and the three OR branches on customer_address into separate UNION ALL subqueries, each with a single set of conditions."
    },
    {
      "patch_id": "compile_explicit_joins",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.36,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1915.2,
      "patch_ms": 1411.3,
      "output_sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2001 AND ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_cte_prefilter",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: Column mismatch: 4 missing, 4 extra",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_store_sales AS (SELECT ss.ss_quantity, ss.ss_ext_sales_price, ss.ss_ext_wholesale_cost, ss.ss_net_profit, ss.ss_cdemo_sk, ss.ss_addr_sk, ss.ss_sales_price, hd.hd_dep_count FROM store_sales ss JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN household_demographics hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN store s ON s.s_store_sk = ss.ss_store_sk WHERE d.d_year = 2001) SELECT AVG(fss.ss_quantity), AVG(fss.ss_ext_sales_price), AVG(fss.ss_ext_wholesale_cost), SUM(fss.ss_ext_wholesale_cost) FROM filtered_store_sales fss JOIN customer_demographics cd ON cd.cd_demo_sk = fss.ss_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = fss.ss_addr_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND fss.ss_sales_price BETWEEN 100.00 AND 150.00 AND fss.hd_dep_count = 3) OR (cd.cd_marital_status = 'U' AND cd.cd_education_status = 'College' AND fss.ss_sales_price BETWEEN 50.00 AND 100.00 AND fss.hd_dep_count = 1) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Unknown' AND fss.ss_sales_price BETWEEN 150.00 AND 200.00 AND fss.hd_dep_count = 1)) AND ((ca.ca_country = 'United States' AND ca.ca_state IN ('CO', 'NC', 'TX') AND fss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'NY', 'TX') AND fss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('IA', 'IL', 'NC') AND fss.ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "compile_attempt1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.36,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1915.2,
      "patch_ms": 1411.7,
      "output_sql": "SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk WHERE d_year = 2001 AND ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_attempt2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 1.36,
      "semantic_passed": true,
      "error": null,
      "original_ms": 1915.2,
      "patch_ms": 1411.6,
      "output_sql": "WITH filtered_store_sales AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_net_profit, ss_cdemo_sk, ss_addr_sk, ss_sales_price, hd_dep_count FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON s_store_sk = ss_store_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk WHERE d_year = 2001) SELECT AVG(ss_quantity), AVG(ss_ext_sales_price), AVG(ss_ext_wholesale_cost), SUM(ss_ext_wholesale_cost) FROM filtered_store_sales JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250));",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Aggregate  (rows=1, time=618.49)\n  Gather  (rows=3, time=618.48)\n    Aggregate  (rows=1, time=405.333)\n      Nested Loop  (rows=28, time=405.232)\n        Nested Loop  (rows=1079, time=395.625)\n          Hash Join  (rows=6247, time=357.913)\n            Hash Join  (rows=6265, time=356.808)\n              Nested Loop  (rows=56045, time=349.841)\n                Index Only Scan on date_dim  (rows=122, time=0.692)\n                Index Only Scan on store_sales  (rows=461, time=2.845)\n              Hash",
    "compile_explicit_joins": "Aggregate  (rows=1, time=1270.366)\n  Gather  (rows=1, time=1270.358)\n    Aggregate  (rows=1, time=1269.699)\n      Nested Loop  (rows=85, time=1269.511)\n        Nested Loop  (rows=3238, time=1243.02)\n          Hash Join  (rows=18741, time=1135.882)\n            Hash Join  (rows=18795, time=1132.184)\n              Nested Loop  (rows=168134, time=1111.947)\n                Index Only Scan on date_dim  (rows=365, time=1.552)\n                Index Only Scan on store_sales  (rows=461, time=3.014)\n      ",
    "compile_attempt1": "Aggregate  (rows=1, time=1985.987)\n  Gather  (rows=1, time=1985.968)\n    Aggregate  (rows=1, time=1985.551)\n      Nested Loop  (rows=85, time=1985.136)\n        Nested Loop  (rows=3238, time=1929.339)\n          Hash Join  (rows=18741, time=1710.384)\n            Hash Join  (rows=18795, time=1703.297)\n              Nested Loop  (rows=168134, time=1655.799)\n                Index Only Scan on date_dim  (rows=365, time=2.43)\n                Index Only Scan on store_sales  (rows=461, time=4.49)\n       ",
    "compile_attempt2": "Aggregate  (rows=1, time=997.272)\n  Gather  (rows=3, time=997.259)\n    Aggregate  (rows=1, time=660.056)\n      Nested Loop  (rows=28, time=659.922)\n        Nested Loop  (rows=1079, time=642.566)\n          Hash Join  (rows=6247, time=567.689)\n            Hash Join  (rows=6265, time=565.276)\n              Nested Loop  (rows=56045, time=550.784)\n                Index Only Scan on date_dim  (rows=122, time=1.656)\n                Index Only Scan on store_sales  (rows=461, time=4.475)\n              Ha"
  }
}