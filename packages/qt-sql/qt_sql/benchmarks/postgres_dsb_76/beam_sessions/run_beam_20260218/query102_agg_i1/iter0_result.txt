{
  "iteration": 0,
  "n_api_calls": 11,
  "beam_cost_usd": 0.03988408,
  "beam_cost_priced_calls": 11,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 162125,
    "completion_tokens": 26673,
    "total_tokens": 188798,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 68800,
    "reasoning_tokens": 15235
  },
  "best_speedup": 2.83,
  "best_patch_id": "p01",
  "best_sql": "select \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    count(*) as cnt\nfrom\n    store_sales,\n    web_sales,\n    date_dim d1,\n    date_dim d2,\n    customer,\n    inventory,\n    store,\n    warehouse,\n    item,\n    customer_demographics,\n    household_demographics,\n    customer_address\n    where\n      ss_item_sk = i_item_sk\n      and ws_item_sk = ss_item_sk\n      and ss_sold_date_sk = d1.d_date_sk\n      and ws_sold_date_sk = d2.d_date_sk\n\t\t\tand d2.d_date between d1.d_date and (d1.d_date + interval '30 day')\n      and ss_customer_sk = c_customer_sk\n      and ws_bill_customer_sk = c_customer_sk\n      and ws_warehouse_sk = inv_warehouse_sk\n      and ws_warehouse_sk = w_warehouse_sk\n      and inv_item_sk = ss_item_sk\n      and inv_date_sk = ss_sold_date_sk\n      and inv_quantity_on_hand >= ss_quantity\n      and s_state = w_state\n      AND i_category IN ('Children', 'Jewelry', 'Men')\n      and i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n      and c_current_cdemo_sk = cd_demo_sk\n      and c_current_hdemo_sk = hd_demo_sk\n      and c_current_addr_sk = ca_address_sk\n      and ca_state in ('AZ', 'KS', 'OH', 'TX', 'WA')\n      and d1.d_year = 2001\n      and ws_wholesale_cost BETWEEN 35 AND 55\n    group by cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\n    order by cnt;",
  "patches": [
    {
      "patch_id": "p02",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.72,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: column \"c_customer_sk\" does not exist\nLINE 1: ...ws_item_sk = ss_item_sk AND ws_bill_customer_sk = c_customer...\n                                                             ^\nHINT:  Perhaps you meant to reference the column \"store_sales.ss_customer_sk\".\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH item_prefetch AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Jewelry', 'Men') AND i_manager_id IN (21,22,38,39,46,47,66,67,74,93)), household_demographics_prefetch AS (SELECT hd_demo_sk, hd_vehicle_count FROM household_demographics), customer_address_prefetch AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AZ','KS','OH','TX','WA')) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, count(*) as cnt FROM store_sales JOIN web_sales ON ws_item_sk = ss_item_sk AND ws_bill_customer_sk = c_customer_sk AND ws_warehouse_sk = inv_warehouse_sk AND ws_warehouse_sk = w_warehouse_sk AND ws_wholesale_cost BETWEEN 35 AND 55 JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk JOIN date_dim d2 ON ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day') JOIN customer ON ss_customer_sk = c_customer_sk JOIN inventory ON inv_item_sk = ss_item_sk AND inv_date_sk = ss_sold_date_sk AND inv_quantity_on_hand >= ss_quantity JOIN store ON s_state = w_state JOIN warehouse ON w_warehouse_sk = ws_warehouse_sk JOIN item_prefetch ON ss_item_sk = item_prefetch.i_item_sk JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk JOIN household_demographics_prefetch ON c_current_hdemo_sk = household_demographics_prefetch.hd_demo_sk JOIN customer_address_prefetch ON c_current_addr_sk = customer_address_prefetch.ca_address_sk WHERE d1.d_year = 2001 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter all selective dimensions into separate CTEs, convert comma joins to explicit JOIN syntax, and join CTEs in a star pattern to improve cardinality estimates and join order."
    },
    {
      "patch_id": "p01",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.78,
      "status": "WIN",
      "speedup": 2.83,
      "semantic_passed": true,
      "error": null,
      "original_ms": 2463.5,
      "patch_ms": 869.1,
      "output_sql": "select \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    count(*) as cnt\nfrom\n    store_sales,\n    web_sales,\n    date_dim d1,\n    date_dim d2,\n    customer,\n    inventory,\n    store,\n    warehouse,\n    item,\n    customer_demographics,\n    household_demographics,\n    customer_address\n    where\n      ss_item_sk = i_item_sk\n      and ws_item_sk = ss_item_sk\n      and ss_sold_date_sk = d1.d_date_sk\n      and ws_sold_date_sk = d2.d_date_sk\n\t\t\tand d2.d_date between d1.d_date and (d1.d_date + interval '30 day')\n      and ss_customer_sk = c_customer_sk\n      and ws_bill_customer_sk = c_customer_sk\n      and ws_warehouse_sk = inv_warehouse_sk\n      and ws_warehouse_sk = w_warehouse_sk\n      and inv_item_sk = ss_item_sk\n      and inv_date_sk = ss_sold_date_sk\n      and inv_quantity_on_hand >= ss_quantity\n      and s_state = w_state\n      AND i_category IN ('Children', 'Jewelry', 'Men')\n      and i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n      and c_current_cdemo_sk = cd_demo_sk\n      and c_current_hdemo_sk = hd_demo_sk\n      and c_current_addr_sk = ca_address_sk\n      and ca_state in ('AZ', 'KS', 'OH', 'TX', 'WA')\n      and d1.d_year = 2001\n      and ws_wholesale_cost BETWEEN 35 AND 55\n    group by cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\n    order by cnt;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Create MATERIALIZED CTEs for selective dimensions (date_dim d1, item, customer_address, household_demographics) and pre-join with fact tables (store_sales, web_sales) to reduce rows before the non-equi date join and final Merge Join."
    },
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.68,
      "status": "ERROR",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH d1_filtered AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2001), d2_filtered AS (SELECT d_date_sk, d_date FROM date_dim), main_query AS (SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, hd.hd_vehicle_count FROM store_sales ss JOIN web_sales ws ON ss.ss_item_sk = ws.ws_item_sk AND ss.ss_customer_sk = ws.ws_bill_customer_sk JOIN d1_filtered d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN d2_filtered d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day') JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN inventory inv ON inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk AND inv.inv_quantity_on_hand >= ss.ss_quantity JOIN store s ON s.s_state = (SELECT w_state FROM warehouse w WHERE w.w_warehouse_sk = ws.ws_warehouse_sk LIMIT 1) JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE i.i_category IN ('Children', 'Jewelry', 'Men') AND i.i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93) AND ca.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA') AND ws.ws_wholesale_cost BETWEEN 35 AND 55) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, count(*) as cnt FROM main_query GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Isolate date_dim filters into CTEs, convert comma joins to explicit JOINs, and push date\u2011range predicate earlier into the join graph."
    },
    {
      "patch_id": "p04",
      "family": "A",
      "transform": "multi_date_range_cte",
      "relevance_score": 0.52,
      "status": "DEDUP",
      "speedup": null,
      "semantic_passed": false,
      "error": "Execution: current transaction is aborted, commands ignored until end of transaction block\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    count(*) as cnt\nfrom\n    store_sales,\n    web_sales,\n    date_dim d1,\n    date_dim d2,\n    customer,\n    inventory,\n    store,\n    warehouse,\n    item,\n    customer_demographics,\n    household_demographics,\n    customer_address\n    where\n      ss_item_sk = i_item_sk\n      and ws_item_sk = ss_item_sk\n      and ss_sold_date_sk = d1.d_date_sk\n      and ws_sold_date_sk = d2.d_date_sk\n\t\t\tand d2.d_date between d1.d_date and (d1.d_date + interval '30 day')\n      and ss_customer_sk = c_customer_sk\n      and ws_bill_customer_sk = c_customer_sk\n      and ws_warehouse_sk = inv_warehouse_sk\n      and ws_warehouse_sk = w_warehouse_sk\n      and inv_item_sk = ss_item_sk\n      and inv_date_sk = ss_sold_date_sk\n      and inv_quantity_on_hand >= ss_quantity\n      and s_state = w_state\n      AND i_category IN ('Children', 'Jewelry', 'Men')\n      and i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n      and c_current_cdemo_sk = cd_demo_sk\n      and c_current_hdemo_sk = hd_demo_sk\n      and c_current_addr_sk = ca_address_sk\n      and ca_state in ('AZ', 'KS', 'OH', 'TX', 'WA')\n      and d1.d_year = 2001\n      and ws_wholesale_cost BETWEEN 35 AND 55\n    group by cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\n    order by cnt;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Create separate CTEs for d1 and d2 with their respective filters, then join each CTE to its fact table (store_sales with d1, web_sales with d2) before the final join, to push date filters earlier."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.61,
      "semantic_passed": true,
      "error": null,
      "original_ms": 3402.2,
      "patch_ms": 5570.4,
      "output_sql": "select \n    cd_gender,\n    cd_marital_status,\n    cd_education_status,\n    hd_vehicle_count,\n    count(*) as cnt\nfrom\n    store_sales,\n    web_sales,\n    date_dim d1,\n    date_dim d2,\n    customer,\n    inventory,\n    store,\n    warehouse,\n    item,\n    customer_demographics,\n    household_demographics,\n    customer_address\n    where\n      ss_item_sk = i_item_sk\n      and ws_item_sk = ss_item_sk\n      and ss_sold_date_sk = d1.d_date_sk\n      and ws_sold_date_sk = d2.d_date_sk\n\t\t\tand d2.d_date between d1.d_date and (d1.d_date + interval '30 day')\n      and ss_customer_sk = c_customer_sk\n      and ws_bill_customer_sk = c_customer_sk\n      and ws_warehouse_sk = inv_warehouse_sk\n      and ws_warehouse_sk = w_warehouse_sk\n      and inv_item_sk = ss_item_sk\n      and inv_date_sk = ss_sold_date_sk\n      and inv_quantity_on_hand >= ss_quantity\n      and s_state = w_state\n      AND i_category IN ('Children', 'Jewelry', 'Men')\n      and i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93)\n      and c_current_cdemo_sk = cd_demo_sk\n      and c_current_hdemo_sk = hd_demo_sk\n      and c_current_addr_sk = ca_address_sk\n      and ca_state in ('AZ', 'KS', 'OH', 'TX', 'WA')\n      and d1.d_year = 2001\n      and ws_wholesale_cost BETWEEN 35 AND 55\n    group by cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count\n    order by cnt;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "REGRESSION",
      "speedup": 0.02,
      "semantic_passed": true,
      "error": null,
      "original_ms": 3402.2,
      "patch_ms": 174331.3,
      "output_sql": "WITH filtered_store_sales AS (SELECT ss.ss_item_sk, ss.ss_customer_sk, ss.ss_sold_date_sk, ss.ss_quantity FROM store_sales ss JOIN date_dim d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN inventory inv ON ss.ss_item_sk = inv.inv_item_sk AND ss.ss_sold_date_sk = inv.inv_date_sk WHERE d1.d_year = 2001 AND i.i_category IN ('Children', 'Jewelry', 'Men') AND i.i_manager_id IN (21, 22, 38, 39, 46, 47, 66, 67, 74, 93) AND inv.inv_quantity_on_hand >= ss.ss_quantity), filtered_web_sales AS (SELECT ws.ws_item_sk, ws.ws_bill_customer_sk, ws.ws_warehouse_sk, ws.ws_wholesale_cost, w.w_state FROM web_sales ws JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk JOIN filtered_store_sales ss ON ws.ws_item_sk = ss.ss_item_sk AND ws.ws_bill_customer_sk = ss.ss_customer_sk WHERE d2.d_date BETWEEN (SELECT d_date FROM date_dim WHERE d_date_sk = ss.ss_sold_date_sk) AND (SELECT d_date + INTERVAL '30 day' FROM date_dim WHERE d_date_sk = ss.ss_sold_date_sk)) SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM filtered_store_sales ss JOIN filtered_web_sales ws ON ss.ss_item_sk = ws.ws_item_sk AND ss.ss_customer_sk = ws.ws_bill_customer_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN store s ON s.s_state = ws.w_state JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ca.ca_state IN ('AZ', 'KS', 'OH', 'TX', 'WA') GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p01": "Sort  (rows=0, time=902.818)\n  Aggregate  (rows=0, time=902.78)\n    Gather Merge  (rows=0, time=902.776)\n      Sort  (rows=0, time=890.249)\n        Nested Loop  (rows=0, time=890.188)\n          Nested Loop  (rows=0, time=890.186)\n            Nested Loop  (rows=0, time=890.185)\n              Nested Loop  (rows=0, time=890.183)\n                Nested Loop  (rows=0, time=890.181)\n                  Merge Join  (rows=0, time=890.178)\n                    Sort  (rows=0, time=890.141)\n                  ",
    "compile_p1": "Sort  (rows=0, time=217807.017)\n  Gather  (rows=335457, time=10040.137)\n    Nested Loop  (rows=167728, time=8148.559)\n      Hash Join  (rows=133128, time=7558.328)\n        Nested Loop  (rows=2513230, time=7350.254)\n          Index Only Scan on date_dim (d1)  (rows=182, time=38.022)\n          Index Only Scan on store_sales (ss_2)  (rows=13771, time=39.282)\n        Hash  (rows=1179, time=14.085)\n          Seq Scan on item (i)  (rows=1179, time=13.835)\n      Index Scan on inventory (inv)  (rows=1, "
  }
}