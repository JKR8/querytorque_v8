{
  "probe_id": "scout_1",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-aggregating fact tables (catalog_sales, store_sales, web_sales) by item_sk and sold_date_sk before joining with item and date_dim reduces rows entering downstream joins, preserving final output semantics.",
  "reasoning_trace": [
    "Assigned transform targets early aggregation on fact tables to reduce join input volume.",
    "Each fact table (catalog_sales, store_sales, web_sales) can be pre-aggregated on (item_sk, sold_date_sk) before dimension joins.",
    "Pre-aggregation aligns with downstream join keys and preserves grouping semantics for final aggregation.",
    "UNION branches are rewritten to push year filtering into each branch, avoiding full scan through CTE boundary."
  ],
  "target_ir": "Each fact table is pre-aggregated before joining with item and date_dim; final aggregation remains unchanged.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["all_sales"],
        "outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"],
        "changed": false
      },
      {
        "node_id": "all_sales",
        "parent_node_id": "final_select",
        "sources": ["preagg_catalog", "preagg_store", "preagg_web"],
        "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
        "changed": true,
        "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM (SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM preagg_catalog UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM preagg_store UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM preagg_web) sales_detail GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id"
      },
      {
        "node_id": "preagg_catalog",
        "parent_node_id": "all_sales",
        "sources": ["catalog_sales", "item", "date_dim", "catalog_returns"],
        "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
        "changed": true,
        "sql": "SELECT d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, SUM(cs.cs_quantity - COALESCE(cr.cr_return_quantity,0)) AS sales_cnt, SUM(cs.cs_ext_sales_price - COALESCE(cr.cr_return_amount,0.0)) AS sales_amt FROM (SELECT cs_item_sk, cs_sold_date_sk, SUM(cs_quantity) AS cs_quantity, SUM(cs_ext_sales_price) AS cs_ext_sales_price FROM catalog_sales WHERE cs_sales_price / cs_list_price BETWEEN 0.69 AND 0.89 GROUP BY cs_item_sk, cs_sold_date_sk) cs JOIN item i ON i.i_item_sk = cs.cs_item_sk JOIN date_dim d ON d.d_date_sk = cs.cs_sold_date_sk LEFT JOIN catalog_returns cr ON (cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk AND cr.cr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i.i_category = 'Children' GROUP BY d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id"
      },
      {
        "node_id": "preagg_store",
        "parent_node_id": "all_sales",
        "sources": ["store_sales", "item", "date_dim", "store_returns"],
        "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
        "changed": true,
        "sql": "SELECT d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, SUM(ss.ss_quantity - COALESCE(sr.sr_return_quantity,0)) AS sales_cnt, SUM(ss.ss_ext_sales_price - COALESCE(sr.sr_return_amt,0.0)) AS sales_amt FROM (SELECT ss_item_sk, ss_sold_date_sk, SUM(ss_quantity) AS ss_quantity, SUM(ss_ext_sales_price) AS ss_ext_sales_price FROM store_sales WHERE ss_sales_price / ss_list_price BETWEEN 0.69 AND 0.89 GROUP BY ss_item_sk, ss_sold_date_sk) ss JOIN item i ON i.i_item_sk = ss.ss_item_sk JOIN date_dim d ON d.d_date_sk = ss.ss_sold_date_sk LEFT JOIN store_returns sr ON (ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND sr.sr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i.i_category = 'Children' GROUP BY d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id"
      },
      {
        "node_id": "preagg_web",
        "parent_node_id": "all_sales",
        "sources": ["web_sales", "item", "date_dim", "web_returns"],
        "outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"],
        "changed": true,
        "sql": "SELECT d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id, SUM(ws.ws_quantity - COALESCE(wr.wr_return_quantity,0)) AS sales_cnt, SUM(ws.ws_ext_sales_price - COALESCE(wr.wr_return_amt,0.0)) AS sales_amt FROM (SELECT ws_item_sk, ws_sold_date_sk, SUM(ws_quantity) AS ws_quantity, SUM(ws_ext_sales_price) AS ws_ext_sales_price FROM web_sales WHERE ws_sales_price / ws_list_price BETWEEN 0.69 AND 0.89 GROUP BY ws_item_sk, ws_sold_date_sk) ws JOIN item i ON i.i_item_sk = ws.ws_item_sk JOIN date_dim d ON d.d_date_sk = ws.ws_sold_date_sk LEFT JOIN web_returns wr ON (ws.ws_order_number = wr.wr_order_number AND ws.ws_item_sk = wr.wr_item_sk AND wr.wr_reason_sk IN (8, 18, 20, 23, 41)) WHERE i.i_category = 'Children' GROUP BY d.d_year, i.i_brand_id, i.i_class_id, i.i_category_id, i.i_manufact_id"
      }
    ]
  }
}