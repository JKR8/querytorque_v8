[
  {
    "plan_id": "compile_p01_p02_hybrid",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p02",
    "strategy": "Explicit join conversion with date CTE and inner join conversion.",
    "hypothesis": "Probes p01 and p02 both show 3.24x speedup by converting comma join to explicit joins and converting the null-rejecting left join to inner join. This hybrid uses a CTE for date_dim to create a small hash table and explicit INNER JOIN for catalog_returns with condition in ON clause, removing redundant date filter.",
    "expected_explain_delta": "Nested Loop between date_dim and catalog_sales replaced by hash join; join order flexibility improved; left join removed.",
    "target_ir": "Add filtered_date_dim CTE node and update final_select with explicit INNER JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_date_dim", "catalog_sales", "catalog_returns", "warehouse", "item"],
          "outputs": ["w_state", "i_item_id", "sales_before", "sales_after"],
          "changed": true,
          "sql": "SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(dd.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(dd.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(dd.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM catalog_sales cs JOIN filtered_date_dim dd ON cs.cs_sold_date_sk = dd.d_date_sk INNER JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk AND cr.cr_reason_sk = 40 JOIN warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk JOIN item i ON cs.cs_item_sk = i.i_item_sk WHERE i.i_category = 'Shoes' AND i.i_manager_id BETWEEN 42 AND 81 AND cs.cs_wholesale_cost BETWEEN 68 AND 87 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p04",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p04",
    "strategy": "Dimension prefetch star with multiple CTEs for early filtering.",
    "hypothesis": "Probe p04 shows 3.24x speedup by pre-filtering all selective dimensions (date_dim, item, warehouse, catalog_sales) into CTEs, reducing rows early and using explicit joins. This pathway is distinct in using multiple CTEs for broader early filtering.",
    "expected_explain_delta": "Multiple sequential scans replaced by small hash tables; join order optimized; left join null-rejected in WHERE.",
    "target_ir": "Add CTE nodes for filtered_date_dim, filtered_item, filtered_warehouse, filtered_catalog_sales, and catalog_returns; update final_select to join CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_catalog_sales", "filtered_date_dim", "filtered_item", "filtered_warehouse", "catalog_returns"],
          "outputs": ["w_state", "i_item_id", "sales_before", "sales_after"],
          "changed": true,
          "sql": "SELECT w.w_state, i.i_item_id, SUM(CASE WHEN (CAST(d.d_date AS DATE) < CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_before, SUM(CASE WHEN (CAST(d.d_date AS DATE) >= CAST('2002-02-20' AS DATE)) THEN cs.cs_sales_price - COALESCE(cr.cr_refunded_cash, 0) ELSE 0 END) AS sales_after FROM filtered_catalog_sales cs JOIN filtered_date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_warehouse w ON cs.cs_warehouse_sk = w.w_warehouse_sk LEFT JOIN catalog_returns cr ON cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk WHERE cr.cr_reason_sk = 40 GROUP BY w.w_state, i.i_item_id ORDER BY w.w_state, i.i_item_id LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN (CAST('2002-02-20' AS DATE) - INTERVAL '30 day') AND (CAST('2002-02-20' AS DATE) + INTERVAL '30 day')"
        },
        {
          "node_id": "filtered_item",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_id"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_category = 'Shoes' AND i_manager_id BETWEEN 42 AND 81"
        },
        {
          "node_id": "filtered_warehouse",
          "parent_node_id": "final_select",
          "sources": ["warehouse"],
          "outputs": ["w_warehouse_sk", "w_state"],
          "changed": true,
          "sql": "SELECT w_warehouse_sk, w_state FROM warehouse"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales"],
          "outputs": ["cs_order_number", "cs_item_sk", "cs_warehouse_sk", "cs_sold_date_sk", "cs_sales_price", "cs_wholesale_cost"],
          "changed": true,
          "sql": "SELECT cs_order_number, cs_item_sk, cs_warehouse_sk, cs_sold_date_sk, cs_sales_price, cs_wholesale_cost FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 68 AND 87"
        },
        {
          "node_id": "catalog_returns",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns"],
          "outputs": ["cr_order_number", "cr_item_sk", "cr_refunded_cash", "cr_reason_sk"],
          "changed": true,
          "sql": "SELECT cr_order_number, cr_item_sk, cr_refunded_cash, cr_reason_sk FROM catalog_returns"
        }
      ]
    }
  }
]