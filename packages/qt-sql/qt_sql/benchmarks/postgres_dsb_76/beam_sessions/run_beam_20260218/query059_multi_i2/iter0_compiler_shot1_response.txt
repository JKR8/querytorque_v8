[
  {
    "plan_id": "compile_p04_based",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p04",
    "strategy": "Materialize filtered store_sales join with date_dim and store, pre‑aggregate, reuse for both date ranges.",
    "hypothesis": "WIN probe p04 (1.61x) showed the largest speedup by pushing store.state filter into the fact scan and avoiding repeated correlated work. This attempt adopts its proven shape, replacing the fence‑blocked wss CTE with a pre‑filtered aggregate CTE.",
    "expected_explain_delta": "Sequential scan of store_sales now filtered by store.state; CTE fence removed; hash join with small dimension tables replaces nested loop with large mis‑estimate.",
    "target_ir": "Replace wss node with filtered_store_sales CTE, keep final_select join structure.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "filtered_store_sales",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim", "store"],
          "outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
          "changed": true,
          "sql": "SELECT d_week_seq,\n        ss_store_sk,\n        SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) sun_sales,\n        SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) mon_sales,\n        SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) tue_sales,\n        SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) wed_sales,\n        SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) thu_sales,\n        SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) fri_sales,\n        SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) sat_sales\n FROM store_sales\n JOIN date_dim ON d_date_sk = ss_sold_date_sk\n JOIN store ON ss_store_sk = s_store_sk\n WHERE ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01\n   AND s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n GROUP BY d_week_seq, ss_store_sk"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_store_sales", "store", "date_dim"],
          "outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_sales1 / sun_sales2", "mon_sales1 / mon_sales2", "tue_sales1 / tue_sales2", "wed_sales1 / wed_sales2", "thu_sales1 / thu_sales2", "fri_sales1 / fri_sales2", "sat_sales1 / sat_sales2"],
          "changed": true,
          "sql": "WITH filtered_store_sales AS (SELECT d_week_seq,\n        ss_store_sk,\n        SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) sun_sales,\n        SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) mon_sales,\n        SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) tue_sales,\n        SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) wed_sales,\n        SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) thu_sales,\n        SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) fri_sales,\n        SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) sat_sales\n FROM store_sales\n JOIN date_dim ON d_date_sk = ss_sold_date_sk\n JOIN store ON ss_store_sk = s_store_sk\n WHERE ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01\n   AND s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n GROUP BY d_week_seq, ss_store_sk)\n SELECT s_store_name1,s_store_id1,d_week_seq1\n       ,sun_sales1/sun_sales2,mon_sales1/mon_sales2\n       ,tue_sales1/tue_sales2,wed_sales1/wed_sales2,thu_sales1/thu_sales2\n       ,fri_sales1/fri_sales2,sat_sales1/sat_sales2\n FROM\n (SELECT s_store_name s_store_name1,filtered_store_sales.d_week_seq d_week_seq1\n        ,s_store_id s_store_id1,sun_sales sun_sales1\n        ,mon_sales mon_sales1,tue_sales tue_sales1\n        ,wed_sales wed_sales1,thu_sales thu_sales1\n        ,fri_sales fri_sales1,sat_sales sat_sales1\n  FROM filtered_store_sales\n  JOIN store ON filtered_store_sales.ss_store_sk = s_store_sk\n  JOIN date_dim d ON d.d_week_seq = filtered_store_sales.d_week_seq\n  WHERE d_month_seq BETWEEN 1183 AND 1183 + 11\n    AND s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n ) y,\n (SELECT s_store_name s_store_name2,filtered_store_sales.d_week_seq d_week_seq2\n        ,s_store_id s_store_id2,sun_sales sun_sales2\n        ,mon_sales mon_sales2,tue_sales tue_sales2\n        ,wed_sales wed_sales2,thu_sales thu_sales2\n        ,fri_sales fri_sales2,sat_sales sat_sales2\n  FROM filtered_store_sales\n  JOIN store ON filtered_store_sales.ss_store_sk = s_store_sk\n  JOIN date_dim d ON d.d_week_seq = filtered_store_sales.d_week_seq\n  WHERE d_month_seq BETWEEN 1183 + 12 AND 1183 + 23\n    AND s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n ) x\n WHERE s_store_id1=s_store_id2\n   AND d_week_seq1=d_week_seq2-52\n ORDER BY s_store_name1,s_store_id1,d_week_seq1\n LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p02_based",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p02",
    "strategy": "Prefilter dimension tables into CTEs, then join with wss using explicit joins for better cardinality estimation.",
    "hypothesis": "WIN probe p02 (1.31x) reduced hash‑join input size by pre‑filtering date_dim and store, enabling join‑order flexibility. This distinct pathway avoids CTE duplication and preserves the original wss shape while improving join planning.",
    "expected_explain_delta": "Dimension tables scanned early; hash joins with small filtered dimension CTEs replace nested loop; wss CTE scan remains but join order improves.",
    "target_ir": "Add filtered_date_dim and filtered_store CTEs, rewrite final_select with explicit joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "wss",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "date_dim"],
          "outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
          "changed": false
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_week_seq", "d_month_seq"],
          "changed": true,
          "sql": "SELECT d_week_seq, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN 1183 AND 1183 + 23"
        },
        {
          "node_id": "filtered_store",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk", "s_store_id", "s_store_name", "s_state"],
          "changed": true,
          "sql": "SELECT s_store_sk, s_store_id, s_store_name, s_state FROM store WHERE s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["wss", "filtered_date_dim", "filtered_store"],
          "outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_sales1 / sun_sales2", "mon_sales1 / mon_sales2", "tue_sales1 / tue_sales2", "wed_sales1 / wed_sales2", "thu_sales1 / thu_sales2", "fri_sales1 / fri_sales2", "sat_sales1 / sat_sales2"],
          "changed": true,
          "sql": "WITH wss AS (SELECT d_week_seq,\n        ss_store_sk,\n        SUM(CASE WHEN (d_day_name='Sunday') THEN ss_sales_price ELSE NULL END) sun_sales,\n        SUM(CASE WHEN (d_day_name='Monday') THEN ss_sales_price ELSE NULL END) mon_sales,\n        SUM(CASE WHEN (d_day_name='Tuesday') THEN ss_sales_price ELSE NULL END) tue_sales,\n        SUM(CASE WHEN (d_day_name='Wednesday') THEN ss_sales_price ELSE NULL END) wed_sales,\n        SUM(CASE WHEN (d_day_name='Thursday') THEN ss_sales_price ELSE NULL END) thu_sales,\n        SUM(CASE WHEN (d_day_name='Friday') THEN ss_sales_price ELSE NULL END) fri_sales,\n        SUM(CASE WHEN (d_day_name='Saturday') THEN ss_sales_price ELSE NULL END) sat_sales\n FROM store_sales, date_dim\n WHERE d_date_sk = ss_sold_date_sk\n AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 85 * 0.01\n GROUP BY d_week_seq, ss_store_sk),\n filtered_date_dim AS (SELECT d_week_seq, d_month_seq FROM date_dim WHERE d_month_seq BETWEEN 1183 AND 1183 + 23),\n filtered_store AS (SELECT s_store_sk, s_store_id, s_store_name, s_state FROM store WHERE s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA'))\n SELECT s_store_name1,s_store_id1,d_week_seq1\n       ,sun_sales1/sun_sales2,mon_sales1/mon_sales2\n       ,tue_sales1/tue_sales2,wed_sales1/wed_sales2,thu_sales1/thu_sales2\n       ,fri_sales1/fri_sales2,sat_sales1/sat_sales2\n FROM\n (SELECT s_store_name s_store_name1,wss.d_week_seq d_week_seq1\n        ,s_store_id s_store_id1,sun_sales sun_sales1\n        ,mon_sales mon_sales1,tue_sales tue_sales1\n        ,wed_sales wed_sales1,thu_sales thu_sales1\n        ,fri_sales fri_sales1,sat_sales sat_sales1\n  FROM wss\n  JOIN filtered_store fs1 ON ss_store_sk = fs1.s_store_sk\n  JOIN filtered_date_dim fd1 ON fd1.d_week_seq = wss.d_week_seq\n  WHERE fd1.d_month_seq BETWEEN 1183 AND 1183 + 11\n    AND fs1.s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n ) y\n JOIN\n (SELECT s_store_name s_store_name2,wss.d_week_seq d_week_seq2\n        ,s_store_id s_store_id2,sun_sales sun_sales2\n        ,mon_sales mon_sales2,tue_sales tue_sales2\n        ,wed_sales wed_sales2,thu_sales thu_sales2\n        ,fri_sales fri_sales2,sat_sales sat_sales2\n  FROM wss\n  JOIN filtered_store fs2 ON ss_store_sk = fs2.s_store_sk\n  JOIN filtered_date_dim fd2 ON fd2.d_week_seq = wss.d_week_seq\n  WHERE fd2.d_month_seq BETWEEN 1183 + 12 AND 1183 + 23\n    AND fs2.s_state IN ('AR','GA','IN','KS','KY','OH','SD','VA')\n ) x\n ON s_store_id1=s_store_id2 AND d_week_seq1=d_week_seq2-52\n ORDER BY s_store_name1,s_store_id1,d_week_seq1\n LIMIT 100"
        }
      ]
    }
  }
]