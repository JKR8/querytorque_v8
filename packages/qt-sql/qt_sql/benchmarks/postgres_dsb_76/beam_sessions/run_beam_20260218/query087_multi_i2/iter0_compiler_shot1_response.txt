[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.45,
    "based_on": "p01,p03",
    "strategy": "Shared filtered dimension CTEs with explicit JOIN syntax.",
    "hypothesis": "p01 showed neutral speedup by reusing filtered date and customer CTEs, while p03 regressed with date CTE alone. Combining dimension CTEs and explicit JOINs may improve cardinality estimates while avoiding repeated scans.",
    "expected_explain_delta": "Reduce three separate date_dim and customer scans to one each; explicit joins may enable better join ordering.",
    "target_ir": "Replace comma joins with explicit JOINs and introduce filtered_dates/filtered_customers CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["count"],
          "changed": true,
          "sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1213+11), filtered_customers AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974) SELECT COUNT(*) FROM ((SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_customers ON store_sales.ss_customer_sk = filtered_customers.c_customer_sk WHERE ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON catalog_sales.cs_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_customers ON catalog_sales.cs_bill_customer_sk = filtered_customers.c_customer_sk WHERE cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_customers ON web_sales.ws_bill_customer_sk = filtered_customers.c_customer_sk WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86)) cool_cust"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.35,
    "based_on": "p03",
    "strategy": "Date CTE with explicit JOINs only, no customer CTE.",
    "hypothesis": "p03 regressed but may have over-materialized; keep date CTE for shared filter and explicit joins, but avoid customer CTE to preserve index scan on customer.c_birth_year.",
    "expected_explain_delta": "Reduce three date_dim scans to one; preserve nested loop index scan on customer.",
    "target_ir": "Replace comma joins with explicit JOINs and add date CTE; leave customer joins unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": ["count"],
          "changed": true,
          "sql": "WITH filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1213+11) SELECT COUNT(*) FROM ((SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_dates ON store_sales.ss_sold_date_sk = filtered_dates.d_date_sk, customer WHERE store_sales.ss_customer_sk = customer.c_customer_sk AND ss_list_price BETWEEN 168 AND 197 AND c_birth_year BETWEEN 1968 AND 1974 AND ss_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_dates ON catalog_sales.cs_sold_date_sk = filtered_dates.d_date_sk, customer WHERE catalog_sales.cs_bill_customer_sk = customer.c_customer_sk AND cs_list_price BETWEEN 168 AND 197 AND c_birth_year BETWEEN 1968 AND 1974 AND cs_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk, customer WHERE web_sales.ws_bill_customer_sk = customer.c_customer_sk AND ws_list_price BETWEEN 168 AND 197 AND c_birth_year BETWEEN 1968 AND 1974 AND ws_wholesale_cost BETWEEN 76 AND 86)) cool_cust"
        }
      ]
    }
  }
]