{
  "probe_id": "p01",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering selective dimensions (date_dim, item, promotion) into materialized CTEs and rewriting comma joins to explicit JOIN syntax in channel CTEs (ssr, csr, wsr) will improve cardinality estimates and reduce intermediate row counts.",
  "reasoning_trace": [
    "Assigned transform targets comma joins in channel CTEs with evidence of poor cardinality estimates.",
    "Dimension prefetching aligns with PostgreSQL optimizer strengths for small covering indexes.",
    "Explicit JOIN syntax preserves all original filters and enables better selectivity propagation."
  ],
  "target_ir": "date_dim_prefetch, item_prefetch, and promotion_prefetch CTEs added; ssr, csr, wsr FROM clauses rewritten to explicit JOINs with these CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": false,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["wsr", "ssr", "csr"],
        "outputs": ["channel", "id", "sales", "returns", "profit"],
        "changed": false
      },
      {
        "node_id": "ssr",
        "parent_node_id": "final_select",
        "sources": ["store_sales", "store_returns", "date_dim_prefetch", "store", "item_prefetch", "promotion_prefetch"],
        "outputs": ["store_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  s_store_id as store_id,\n         sum(ss_ext_sales_price) as sales,\n         sum(coalesce(sr_return_amt, 0)) as returns,\n         sum(ss_net_profit - coalesce(sr_net_loss, 0)) as profit\n from store_sales left outer join store_returns on\n        (ss_item_sk = sr_item_sk and ss_ticket_number = sr_ticket_number)\n join date_dim_prefetch on ss_sold_date_sk = d_date_sk\n join store on ss_store_sk = s_store_sk\n join item_prefetch on ss_item_sk = i_item_sk\n join promotion_prefetch on ss_promo_sk = p_promo_sk\ngroup by s_store_id"
      },
      {
        "node_id": "csr",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales", "catalog_returns", "date_dim_prefetch", "catalog_page", "item_prefetch", "promotion_prefetch"],
        "outputs": ["catalog_page_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  cp_catalog_page_id as catalog_page_id,\n         sum(cs_ext_sales_price) as sales,\n         sum(coalesce(cr_return_amount, 0)) as returns,\n         sum(cs_net_profit - coalesce(cr_net_loss, 0)) as profit\n from catalog_sales left outer join catalog_returns on\n        (cs_item_sk = cr_item_sk and cs_order_number = cr_order_number)\n join date_dim_prefetch on cs_sold_date_sk = d_date_sk\n join catalog_page on cs_catalog_page_sk = cp_catalog_page_sk\n join item_prefetch on cs_item_sk = i_item_sk\n join promotion_prefetch on cs_promo_sk = p_promo_sk\ngroup by cp_catalog_page_id"
      },
      {
        "node_id": "wsr",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "web_returns", "date_dim_prefetch", "web_site", "item_prefetch", "promotion_prefetch"],
        "outputs": ["web_site_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "select  web_site_id,\n         sum(ws_ext_sales_price) as sales,\n         sum(coalesce(wr_return_amt, 0)) as returns,\n         sum(ws_net_profit - coalesce(wr_net_loss, 0)) as profit\n from web_sales left outer join web_returns on\n        (ws_item_sk = wr_item_sk and ws_order_number = wr_order_number)\n join date_dim_prefetch on ws_sold_date_sk = d_date_sk\n join web_site on ws_web_site_sk = web_site_sk\n join item_prefetch on ws_item_sk = i_item_sk\n join promotion_prefetch on ws_promo_sk = p_promo_sk\ngroup by web_site_id"
      },
      {
        "node_id": "date_dim_prefetch",
        "parent_node_id": "final_select",
        "sources": ["date_dim"],
        "outputs": ["d_date_sk"],
        "changed": true,
        "sql": "select d_date_sk\nfrom date_dim\nwhere d_date between cast('1999-10-21' as date)\n           and cast('1999-10-21' as date) + interval '30 day'"
      },
      {
        "node_id": "item_prefetch",
        "parent_node_id": "final_select",
        "sources": ["item"],
        "outputs": ["i_item_sk", "i_current_price", "i_category"],
        "changed": true,
        "sql": "select i_item_sk, i_current_price, i_category\nfrom item\nwhere i_current_price > 50\n  and i_category IN ('Men', 'Music')"
      },
      {
        "node_id": "promotion_prefetch",
        "parent_node_id": "final_select",
        "sources": ["promotion"],
        "outputs": ["p_promo_sk", "p_channel_email", "p_channel_tv", "p_channel_radio", "p_channel_press", "p_channel_event"],
        "changed": true,
        "sql": "select p_promo_sk, p_channel_email, p_channel_tv, p_channel_radio, p_channel_press, p_channel_event\nfrom promotion\nwhere p_channel_email = 'Y'\n  and p_channel_tv = 'N'\n  and p_channel_radio = 'N'\n  and p_channel_press = 'N'\n  and p_channel_event = 'N'"
      }
    ]
  }
}