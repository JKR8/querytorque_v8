[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Materialized dimension prefilter to reduce large nested-loop input before non-equi join.",
    "hypothesis": "Probe p01 achieved 4.46x speedup by pre‑filtering selective dimensions (d1, household_demographics, customer_demographics, item, catalog_sales) into CTEs, shrinking the nested‑loop input from 113k rows. This addresses the primary hotspot identified in the original plan.",
    "expected_explain_delta": "Nested‑loop between date_dim d1 and catalog_sales should shrink; hash join with household_demographics and customer_demographics reduced; non‑equi join condition applied on pre‑filtered rows.",
    "target_ir": "Add five materialized CTEs for selective dimensions and catalog_sales, keep final join spine unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["filtered_catalog_sales", "inventory", "warehouse", "filtered_item", "filtered_customer_demographics", "filtered_household_demographics", "filtered_d1", "date_dim d2", "date_dim d3", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH filtered_d1 AS MATERIALIZED (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), filtered_household_demographics AS MATERIALIZED (SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential = '>10000'), filtered_customer_demographics AS MATERIALIZED (SELECT cd_demo_sk, cd_marital_status, cd_dep_count FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11), filtered_item AS MATERIALIZED (SELECT i_item_sk, i_item_desc, i_category FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')), filtered_catalog_sales AS MATERIALIZED (SELECT cs_item_sk, cs_order_number, cs_wholesale_cost, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_quantity FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96) SELECT i.i_item_desc, w.w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_catalog_sales cs JOIN inventory inv ON (cs.cs_item_sk = inv.inv_item_sk) JOIN warehouse w ON (w.w_warehouse_sk = inv.inv_warehouse_sk) JOIN filtered_item i ON (i.i_item_sk = cs.cs_item_sk) JOIN filtered_customer_demographics cd ON (cs.cs_bill_cdemo_sk = cd.cd_demo_sk) JOIN filtered_household_demographics hd ON (cs.cs_bill_hdemo_sk = hd.hd_demo_sk) JOIN filtered_d1 d1 ON (cs.cs_sold_date_sk = d1.d_date_sk) JOIN date_dim d2 ON (inv.inv_date_sk = d2.d_date_sk) JOIN date_dim d3 ON (cs.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion p ON (cs.cs_promo_sk = p.p_promo_sk) LEFT OUTER JOIN catalog_returns cr ON (cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + interval '3 day' GROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "filtered_d1",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk", "d_week_seq", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "filtered_household_demographics",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["hd_demo_sk", "hd_buy_potential"],
          "changed": true,
          "sql": "SELECT hd_demo_sk, hd_buy_potential FROM household_demographics WHERE hd_buy_potential = '>10000'"
        },
        {
          "node_id": "filtered_customer_demographics",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_dep_count"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_dep_count FROM customer_demographics WHERE cd_marital_status = 'S' AND cd_dep_count BETWEEN 9 AND 11"
        },
        {
          "node_id": "filtered_item",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["i_item_sk", "i_item_desc", "i_category"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_desc, i_category FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports')"
        },
        {
          "node_id": "filtered_catalog_sales",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["cs_item_sk", "cs_order_number", "cs_wholesale_cost", "cs_bill_cdemo_sk", "cs_bill_hdemo_sk", "cs_sold_date_sk", "cs_ship_date_sk", "cs_promo_sk", "cs_quantity"],
          "changed": true,
          "sql": "SELECT cs_item_sk, cs_order_number, cs_wholesale_cost, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_promo_sk, cs_quantity FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 76 AND 96"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02,p04",
    "strategy": "Materialize all three date_dim scans into separate CTEs to avoid repeated base‑table scans, while preserving explicit join syntax.",
    "hypothesis": "Probe p02 targeted the secondary hotspot of repeated date_dim scans (d1, d2, d3) but failed due to tree‑structure issues. This corrected version materializes each date_dim scan once, reducing I/O and enabling the optimizer to see tiny filtered CTEs early.",
    "expected_explain_delta": "Seq Scan on date_dim d2 and Index Scan on date_dim d3 replaced by CTE scans; early materialization of d1 filter reduces nested‑loop input.",
    "target_ir": "Add three date_dim CTEs and keep other joins unchanged.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "inventory", "warehouse", "item", "customer_demographics", "household_demographics", "d1_filtered", "d2_filtered", "d3_filtered", "promotion", "catalog_returns"],
          "outputs": ["i_item_desc", "w_warehouse_name", "d_week_seq", "no_promo", "promo", "total_cnt"],
          "changed": true,
          "sql": "WITH d1_filtered AS MATERIALIZED (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999), d2_filtered AS MATERIALIZED (SELECT d_date_sk, d_week_seq FROM date_dim), d3_filtered AS MATERIALIZED (SELECT d_date_sk, d_date FROM date_dim) SELECT i.i_item_desc, w.w_warehouse_name, d1.d_week_seq, SUM(CASE WHEN p.p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p.p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM catalog_sales cs JOIN inventory inv ON (cs.cs_item_sk = inv.inv_item_sk) JOIN warehouse w ON (w.w_warehouse_sk = inv.inv_warehouse_sk) JOIN item i ON (i.i_item_sk = cs.cs_item_sk) JOIN customer_demographics cd ON (cs.cs_bill_cdemo_sk = cd.cd_demo_sk) JOIN household_demographics hd ON (cs.cs_bill_hdemo_sk = hd.hd_demo_sk) JOIN d1_filtered d1 ON (cs.cs_sold_date_sk = d1.d_date_sk) JOIN d2_filtered d2 ON (inv.inv_date_sk = d2.d_date_sk) JOIN d3_filtered d3 ON (cs.cs_ship_date_sk = d3.d_date_sk) LEFT OUTER JOIN promotion p ON (cs.cs_promo_sk = p.p_promo_sk) LEFT OUTER JOIN catalog_returns cr ON (cr.cr_item_sk = cs.cs_item_sk AND cr.cr_order_number = cs.cs_order_number) WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + interval '3 day' AND hd.hd_buy_potential = '>10000' AND d1.d_year = 1999 AND cd.cd_marital_status = 'S' AND cd.cd_dep_count BETWEEN 9 AND 11 AND i.i_category IN ('Men', 'Shoes', 'Sports') AND cs.cs_wholesale_cost BETWEEN 76 AND 96 GROUP BY i.i_item_desc, w.w_warehouse_name, d1.d_week_seq ORDER BY total_cnt DESC, i.i_item_desc, w.w_warehouse_name, d1.d_week_seq LIMIT 100"
        },
        {
          "node_id": "d1_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk", "d_week_seq", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "d2_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk", "d_week_seq"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_week_seq FROM date_dim"
        },
        {
          "node_id": "d3_filtered",
          "parent_node_id": "final_select",
          "sources": [],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim"
        }
      ]
    }
  }
]