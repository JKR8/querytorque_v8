{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering all dimension tables with selective filters into CTEs before joining them with store_sales reduces row count early and avoids late filtering due to comma-join pattern.",
  "reasoning_trace": [
    "Assigned transform targets prefetching of selective dimensions into CTEs.",
    "All dimension tables have selective filters that can be pushed into CTEs.",
    "CTEs will be joined together before joining to store_sales, reducing fact table scan size.",
    "Explicit JOINs replace comma-join pattern, enabling better optimization."
  ],
  "target_ir": "Dimension tables filtered into CTEs; explicit JOINs used; store_sales joined last.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["dim_joins", "store_sales"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "hd_vehicle_count", "cnt"],
        "changed": true,
        "sql": "SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, hd.hd_vehicle_count, COUNT(*) AS cnt FROM dim_joins dj JOIN store_sales ss ON dj.ss_item_sk = ss.ss_item_sk AND dj.ss_customer_sk = ss.ss_customer_sk AND dj.ss_sold_date_sk = ss.ss_sold_date_sk AND dj.inv_item_sk = ss.ss_item_sk AND dj.inv_date_sk = ss.ss_sold_date_sk AND dj.inv_quantity_on_hand >= ss.ss_quantity JOIN web_sales ws ON ss.ss_item_sk = ws.ws_item_sk AND ws.ws_sold_date_sk = dj.d2_date_sk AND ws.ws_bill_customer_sk = dj.c_customer_sk AND ws.ws_warehouse_sk = dj.w_warehouse_sk AND ws.ws_wholesale_cost BETWEEN 76 AND 96 JOIN date_dim d1 ON dj.d1_date_sk = d1.d_date_sk AND d1.d_year = 1998 JOIN store s ON dj.s_store_sk = s.s_store_sk AND s.s_state = dj.w_state JOIN warehouse w ON dj.w_warehouse_sk = w.w_warehouse_sk JOIN item i ON dj.i_item_sk = i.i_item_sk AND i.i_category IN ('Men', 'Shoes', 'Sports') AND i.i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98) JOIN customer c ON dj.c_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON dj.cd_demo_sk = cd.cd_demo_sk JOIN household_demographics hd ON dj.hd_demo_sk = hd.hd_demo_sk JOIN customer_address ca ON dj.ca_address_sk = ca.ca_address_sk AND ca.ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA') GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, hd.hd_vehicle_count ORDER BY cnt"
      },
      {
        "node_id": "dim_joins",
        "parent_node_id": "final_select",
        "sources": [],
        "outputs": [
          "ss_item_sk",
          "ss_customer_sk",
          "ss_sold_date_sk",
          "inv_item_sk",
          "inv_date_sk",
          "inv_quantity_on_hand",
          "d2_date_sk",
          "c_customer_sk",
          "w_warehouse_sk",
          "i_item_sk",
          "c_customer_sk",
          "cd_demo_sk",
          "hd_demo_sk",
          "ca_address_sk",
          "d1_date_sk",
          "s_store_sk",
          "w_state"
        ],
        "changed": true,
        "sql": "WITH customer_filtered AS (SELECT c_customer_sk, c_current_cdemo_sk, c_current_hdemo_sk, c_current_addr_sk FROM customer WHERE c_current_cdemo_sk IS NOT NULL AND c_current_hdemo_sk IS NOT NULL AND c_current_addr_sk IS NOT NULL), customer_address_filtered AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')), customer_demographics_filtered AS (SELECT cd_demo_sk, cd_gender, cd_marital_status, cd_education_status FROM customer_demographics), household_demographics_filtered AS (SELECT hd_demo_sk, hd_vehicle_count FROM household_demographics), item_filtered AS (SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)), store_filtered AS (SELECT s_store_sk FROM store), warehouse_filtered AS (SELECT w_warehouse_sk, w_state FROM warehouse), date_dim_d1 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1998), date_dim_d2 AS (SELECT d_date_sk FROM date_dim), inventory_filtered AS (SELECT inv_item_sk, inv_date_sk, inv_warehouse_sk, inv_quantity_on_hand FROM inventory), web_sales_filtered AS (SELECT ws_item_sk, ws_sold_date_sk, ws_bill_customer_sk, ws_warehouse_sk FROM web_sales WHERE ws_wholesale_cost BETWEEN 76 AND 96) SELECT ss.ss_item_sk, ss.ss_customer_sk, ss.ss_sold_date_sk, inv.inv_item_sk, inv.inv_date_sk, inv.inv_quantity_on_hand, d2.d_date_sk AS d2_date_sk, c.c_customer_sk, w.w_warehouse_sk, i.i_item_sk, c.c_customer_sk, cd.cd_demo_sk, hd.hd_demo_sk, ca.ca_address_sk, d1.d_date_sk AS d1_date_sk, s.s_store_sk, w.w_state FROM store_sales ss JOIN customer_filtered c ON ss.ss_customer_sk = c.c_customer_sk JOIN customer_address_filtered ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics_filtered cd ON c.c_current_cdemo_sk = cd.cd_demo_sk JOIN household_demographics_filtered hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN item_filtered i ON ss.ss_item_sk = i.i_item_sk JOIN store_filtered s ON ss.ss_store_sk = s.s_store_sk JOIN warehouse_filtered w ON ss.ss_store_sk = w.w_arehouse_sk JOIN date_dim_d1 d1 ON ss.ss_sold_date_sk = d1.d_date_sk JOIN date_dim_d2 d2 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + interval '30 day') JOIN inventory_filtered inv ON inv.inv_item_sk = ss.ss_item_sk AND inv.inv_date_sk = ss.ss_sold_date_sk AND inv.inv_quantity_on_hand >= ss.ss_quantity JOIN web_sales_filtered ws ON ss.ss_item_sk = ws.ws_item_sk AND ws.ws_sold_date_sk = d2.d_date_sk AND ws.ws_bill_customer_sk = c.c_customer_sk AND ws.ws_warehouse_sk = w.w_warehouse_sk"
      }
    ]
  }
}