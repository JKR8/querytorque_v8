{
  "dispatch": {
    "dialect": "postgres",
    "importance_stars": 3,
    "probe_count": 12,
    "early_stop": false,
    "equivalence_tier": "unordered",
    "hypothesis": "Nested loops with correlated EXISTS subqueries dominate runtime. Decorrelating subqueries and converting comma joins to explicit JOINs with pre-filtered CTEs should reduce row amplification.",
    "reasoning_trace": [
      "Cost spine dominated by Nested Loop Anti on store_sales/date_dim path (27.8s)",
      "Multiple correlated EXISTS with expensive inner index scans (web_sales/catalog_sales)",
      "Comma-join structure prevents optimal join order planning"
    ],
    "cost_spine": [
      "Gather → Nested Loop → Aggregate → Nested Loop → Index Only Scan on date_dim"
    ],
    "hotspots": [
      {"op": "Nested Loop", "why": "Correlated EXISTS re-execution", "evidence": "time=52778ms, rows=1942"},
      {"op": "Comma Join", "why": "Poor cardinality estimates", "evidence": "FROM clause with implicit joins"}
    ],
    "do_not_do": ["or_to_union", "exists_to_in_cte"]
  },
  "probe_summary_schema": [
    "probe_id",
    "transform_id",
    "family",
    "status",
    "speedup",
    "expected_explain_delta",
    "ops_used",
    "confidence",
    "exploration",
    "failure_reason",
    "target"
  ],
  "probes": [
    {
      "probe_id": "p01",
      "transform_id": "inline_decorrelate_materialized",
      "family": "B",
      "target": "Convert store_sales EXISTS to MATERIALIZED CTE with date_dim filter",
      "node_contract": {
        "from_must_include": ["store_sales", "date_dim"],
        "where_must_preserve": ["ss_sold_date_sk = d_date_sk", "d_year=1999"],
        "output_must_preserve": ["All original EXISTS logic"]
      },
      "gates_checked": ["no_or_to_union:PASS", "not_simple_exists:PASS"],
      "exploration": false,
      "confidence": 0.92,
      "expected_explain_delta": "Replace nested loop with hash semi-join to CTE"
    },
    {
      "probe_id": "p02",
      "transform_id": "early_filter_decorrelate",
      "family": "B",
      "target": "Materialize web_sales EXISTS as CTE with pre-joined date_dim",
      "node_contract": {
        "from_must_include": ["web_sales", "date_dim"],
        "where_must_preserve": ["ws_sold_date_sk = d_date_sk"],
        "output_must_preserve": ["Original OR logic between channels"]
      },
      "exploration": false,
      "confidence": 0.88,
      "expected_explain_delta": "Merge web_sales nested loop into single CTE scan"
    },
    {
      "probe_id": "p03",
      "transform_id": "dimension_prefetch_star",
      "family": "F",
      "target": "Convert comma joins to explicit INNER JOIN with CTE-isolated customer_address",
      "node_contract": {
        "from_must_include": ["customer c", "customer_address ca"],
        "where_must_preserve": ["c.c_current_addr_sk = ca.ca_address_sk"],
        "output_must_preserve": ["All county filter semantics"]
      },
      "exploration": false,
      "confidence": 0.85,
      "expected_explain_delta": "Show hash join instead of nested loop on ca"
    },
    {
      "probe_id": "p04",
      "transform_id": "shared_dimension_multi_channel",
      "family": "A",
      "target": "Create shared date_dim CTE for all sales channels",
      "node_contract": {
        "from_must_include": ["date_dim"],
        "where_must_preserve": ["d_year=1999", "d_moy BETWEEN 8 AND 11"],
        "output_must_preserve": ["Date key relationships"]
      },
      "exploration": true,
      "confidence": 0.75,
      "expected_explain_delta": "Single date_dim scan reused across channels"
    },
    {
      "probe_id": "p05",
      "transform_id": "materialized_dimension_fact_prefilter",
      "family": "F",
      "target": "Pre-filter item CTE with manager_id and category conditions",
      "node_contract": {
        "from_must_include": ["item"],
        "where_must_preserve": ["i_manager_id BETWEEN 66 AND 75", "i_category IN (...)"],
        "output_must_preserve": ["Item key relationships"]
      },
      "exploration": false,
      "confidence": 0.9,
      "expected_explain_delta": "Replace repeated item scans with CTE materialization"
    },
    {
      "probe_id": "p06",
      "transform_id": "pg_self_join_decomposition",
      "family": "E",
      "target": "Materialize base customer-CTE with birth_month filter",
      "node_contract": {
        "from_must_include": ["customer"],
        "where_must_preserve": ["c_birth_month IN (1,5)"],
        "output_must_preserve": ["All customer demographics joins"]
      },
      "exploration": false,
      "confidence": 0.83,
      "expected_explain_delta": "Remove redundant customer scans"
    },
    {
      "probe_id": "p07",
      "transform_id": "composite_decorrelate_union",
      "family": "B",
      "target": "Combine web/catalog sales EXISTS into UNION CTE",
      "node_contract": {
        "from_must_include": ["web_sales", "catalog_sales"],
        "where_must_preserve": ["OR logic between channels"],
        "output_must_preserve": ["Original EXISTS semantics"]
      },
      "exploration": true,
      "confidence": 0.68,
      "expected_explain_delta": "Merge two EXISTS checks into single CTE"
    },
    {
      "probe_id": "p08",
      "transform_id": "multi_date_range_cte",
      "family": "A",
      "target": "Create partitioned date_dim CTEs by month range",
      "node_contract": {
        "from_must_include": ["date_dim"],
        "where_must_preserve": ["d_moy ranges"],
        "output_must_preserve": ["Date key relationships"]
      },
      "exploration": true,
      "confidence": 0.6,
      "expected_explain_delta": "Month-specific date_dim scans"
    },
    {
      "probe_id": "p09",
      "transform_id": "decorrelate",
      "family": "B",
      "target": "Convert catalog_sales EXISTS to LEFT JOIN CTE",
      "node_contract": {
        "from_must_include": ["catalog_sales"],
        "where_must_preserve": ["cs_ship_customer_sk relationship"],
        "output_must_preserve": ["Sales ratio filter"]
      },
      "exploration": false,
      "confidence": 0.78,
      "expected_explain_delta": "Replace nested loop with anti-join"
    },
    {
      "probe_id": "p10",
      "transform_id": "sf_sk_pushdown_union_all",
      "family": "A",
      "target": "Push date_sk filter into UNION branches",
      "node_contract": {
        "from_must_include": ["date_dim"],
        "where_must_preserve": ["d_date_sk ranges"],
        "output_must_preserve": ["Date key joins"]
      },
      "exploration": true,
      "confidence": 0.55,
      "expected_explain_delta": "Earlier date_sk pruning"
    },
    {
      "probe_id": "p11",
      "transform_id": "early_filter",
      "family": "A",
      "target": "Pre-filter customer_demographics in CTE",
      "node_contract": {
        "from_must_include": ["customer_demographics"],
        "where_must_preserve": ["cd_marital_status", "cd_education_status"],
        "output_must_preserve": ["Demographic group columns"]
      },
      "exploration": false,
      "confidence": 0.87,
      "expected_explain_delta": "Replace full demographics scan with CTE"
    },
    {
      "probe_id": "p12",
      "transform_id": "aggregate_pushdown",
      "family": "C",
      "target": "Pre-aggregate sales counts per customer before main query",
      "node_contract": {
        "from_must_include": ["store_sales", "web_sales", "catalog_sales"],
        "where_must_preserve": ["Sales ratio filters"],
        "output_must_preserve": ["Customer key relationships"]
      },
      "exploration": true,
      "confidence": 0.65,
      "expected_explain_delta": "Reduce join cardinality via early aggregation"
    }
  ],
  "dropped": [
    {"transform_id": "or_to_union", "reason": "Regression registry: OR uses index scans"},
    {"transform_id": "intersect_to_exists", "reason": "No INTERSECT in original query"}
  ]
}