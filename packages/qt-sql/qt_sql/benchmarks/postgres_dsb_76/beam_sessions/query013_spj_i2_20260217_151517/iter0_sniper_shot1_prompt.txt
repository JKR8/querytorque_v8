## Role

You are the **Beam Sniper** for SQL optimization on the target runtime dialect.

You receive the full Battle Damage Assessment (BDA) from 4-16 single-transform probes.
You are an evidence-informed analyst: you now have both wide knowledge and query-specific empirical results.

Your task: produce **exactly TWO optimization attempts** as compound PatchPlan candidates.

You may:
- combine winning worker ideas into one SQL patch when compatible
- introduce a new transform not tried by workers when evidence shows workers missed the real bottleneck

You must:
- ground decisions in BDA plus explain deltas
- preserve semantics
- avoid known regressions

---

## Prompt Map (cache friendly)

### Phase A - Cached Context (static)
A1. Dialect reminders plus regression registry
A2. Combination hazards (duplication, multiplicity, CTE fences)
A3. Evidence-first decision procedure (mechanical)
A4. Sniper output contract (strict JSON array)

### Phase B - Query-Specific Input (dynamic; after cache boundary)
B1. Importance star rating (1-3)
B2. Original SQL plus original plan
B3. IR structure plus anchor hashes
B4. BDA table (ALL probes: status, speedup, explain delta, failure reasons)
B5. Worker SQL patch outcomes (full rewritten SQL per probe plus top EXPLAIN nodes plus model description)
B6. Engine-specific knowledge profile (strengths, gaps, contraindications)

---

## Dialect reminders

Use runtime-injected **Engine-Specific Knowledge** as authoritative.
If static defaults conflict with runtime profile, follow runtime profile.

---

## Regression Registry (hard bans)

Do not produce a sniper plan that:
- forces materialization of a simple EXISTS already planned as a semi-join
- duplicates base scans (orphaned original scans after replacement)
- introduces unfiltered massive CTEs
- builds over-deep fact chains that lock join order
- applies same-column OR to UNION ALL by default on PostgreSQL

OR to UNION exception for PostgreSQL:
- only consider it when EXPLAIN evidence shows OR blocks index usage and UNION branches become index scans

---

## Combination hazards (what to watch)

- **Duplicate sources**: merging two plans that each add a filtered fact CTE can scan the same fact twice.
- **Join multiplicity**: turning EXISTS into JOIN can multiply rows unless keys are unique or aggregated.
- **CTE fences**: materialized CTEs can block pushdown and join reorder.
- **Overlapping edits**: if two probes edit the same anchor or predicate, unify them in one rewrite.

---

## Evidence-first decision procedure (mechanical)

1) Read the BDA table:
   - identify best verified winners: PASS/WIN with real speedup and stable equivalence
   - identify what still dominates: use explain deltas and original plan to find remaining hotspot

2) Choose a foundation:
   - prefer the best verified winner as the base
   - if none pass, base on the original query and propose the most justified fix

3) Decide the next move:
   - **combine** one compatible improvement from another passing probe if it targets a different hotspot and avoids hazards
   - **invent** one new transform not attempted if workers missed the hotspot, justified by plan evidence
   - for portability-style moves, proceed only when beam evidence and EXPLAIN deltas support transferability and runtime engine knowledge does not contradict it

4) Produce exactly two PatchPlans:
   - prefer 1-3 steps per plan; if more than 3, justify in `risk_notes`
   - use operationally targeted edits (prefer insert_cte/replace_from/replace_where_predicate)
   - payload SQL must be complete and executable

5) Provide expected EXPLAIN deltas and risks:
   - what should change if it works (operators, loops, rows)
   - biggest semantic risks
   - optional fallback probe if compound plan fails

---

## Sniper Output Contract (MUST follow)

Tier-0 output contract:
- response must be valid JSON
- first character must be `[` (no leading whitespace or newlines)
- top-level value must be an array of exactly two objects
- no markdown fences, no prose, no commentary

Schema rules:
- each object must include: `plan_id`, `dialect`, `hypothesis`, `target_ir`, `steps`
- optional `based_on` must be a string, never an array
- do not emit key `sql`; use `sql_fragment` where SQL fragment payload is required
- steps must target `{"by_node_id":"S0"}` unless an anchor hash is explicitly required

Allowed ops:
- insert_cte
- replace_from
- replace_where_predicate
- replace_body
- replace_expr_subtree
- delete_expr_subtree
- replace_join_condition
- replace_select
- replace_block_with_cte_pair
- wrap_query_with_cte

SQL payload rules:
- `replace_body`, `replace_select`, and `replace_block_with_cte_pair` must place SQL in `payload.sql_fragment`
- payload SQL must be complete and executable

Output JSON shape:
[
  {
    "plan_id": "snipe_p1",
    "dialect": "<target_dialect>",
    "confidence": 0.81,
    "based_on": "p03,p11",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Plan evidence and expected win mechanism",
    "target_ir": "Short structural description of final query shape",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {"sql_fragment": "SELECT c_customer_sk FROM customer"}
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "<target_dialect>",
    "confidence": 0.73,
    "based_on": "p07",
    "strategy": "Alternative independent pathway",
    "hypothesis": "Plan evidence for second pathway",
    "target_ir": "Alternative structural description",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT ss_customer_sk FROM store_sales WHERE ss_quantity > 0"
        }
      }
    ]
  }
]

---

## Cache Boundary
Everything below is query-specific input.

## Query ID
query013_spj_i2

## Runtime Dialect Contract
- target_dialect: postgres
- runtime_dialect_is_source_of_truth: true
- if static examples conflict, follow runtime dialect behavior

## Importance
- importance_stars: 3
- importance_label: ***

## Original SQL
```sql
select min(ss_quantity)
       ,min(ss_ext_sales_price)
       ,min(ss_ext_wholesale_cost)
       ,min(ss_ext_wholesale_cost)
 from store_sales
     ,store
     ,customer_demographics
     ,household_demographics
     ,customer_address
     ,date_dim
 where s_store_sk = ss_store_sk
 and  ss_sold_date_sk = d_date_sk and d_year = 2001
 and((ss_hdemo_sk=hd_demo_sk
  and cd_demo_sk = ss_cdemo_sk
  and cd_marital_status = 'M'
  and cd_education_status = '2 yr Degree'
  and ss_sales_price between 100.00 and 150.00
  and hd_dep_count = 3
     )or
     (ss_hdemo_sk=hd_demo_sk
  and cd_demo_sk = ss_cdemo_sk
  and cd_marital_status = 'S'
  and cd_education_status = 'Primary'
  and ss_sales_price between 50.00 and 100.00
  and hd_dep_count = 1
     ) or
     (ss_hdemo_sk=hd_demo_sk
  and cd_demo_sk = ss_cdemo_sk
  and cd_marital_status = 'W'
  and cd_education_status = 'Primary'
  and ss_sales_price between 150.00 and 200.00
  and hd_dep_count = 1
     ))
 and((ss_addr_sk = ca_address_sk
  and ca_country = 'United States'
  and ca_state in ('GA', 'KY', 'SD')
  and ss_net_profit between 100 and 200
     ) or
     (ss_addr_sk = ca_address_sk
  and ca_country = 'United States'
  and ca_state in ('AR', 'IN', 'VA')
  and ss_net_profit between 150 and 300
     ) or
     (ss_addr_sk = ca_address_sk
  and ca_country = 'United States'
  and ca_state in ('KS', 'OH', 'SD')
  and ss_net_profit between 50 and 250
     ))
;
```

## Original Plan
```
Aggregate  (rows=1, time=54331.191)
  Gather  (rows=1, time=54331.185)
    Aggregate  (rows=1, time=54329.854)
      Nested Loop  (rows=65, time=54329.729)
        Nested Loop  (rows=2940, time=52002.663)
          Hash Join  (rows=18741, time=42722.278)
            Hash Join  (rows=18795, time=42657.121)
              Nested Loop  (rows=168134, time=42588.085)
                Index Only Scan on date_dim  (rows=365, time=39.683)
                Index Only Scan on store_sales  (rows=461, time=116.536)
              Hash  (rows=1440, time=29.095)
                Seq Scan on household_demographics  (rows=1440, time=28.856)
            Hash  (rows=102, time=55.247)
              Seq Scan on store  (rows=102, time=55.21)
          Index Scan on customer_address  (rows=0, time=0.494)
        Index Scan on customer_demographics  (rows=0, time=0.79)
```

## IR Structure + Anchor Hashes
```
S0 [SELECT]
  MAIN QUERY (via Q_S0)
    FROM: store_sales, store, customer_demographics, household_demographics, customer_address, date_dim
    WHERE [a6beaa832eeb7899]: s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ((ss_hdemo_sk = hd...

Patch operations (core+advanced): insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree, replace_body, replace_join_condition, replace_select, replace_block_with_cte_pair, wrap_query_with_cte
Target: by_node_id (statement, e.g. "S0") + by_anchor_hash (expression)
```

## Schema / Index / Stats Context
- source: postgres
- referenced_tables: 6

| Table | Rows(est) | PK | Indexes |
|-------|-----------|----|---------|
| customer_address | 250000 | ca_address_sk | customer_address_pkey |
| customer_demographics | 1920800 | cd_demo_sk | customer_demographics_pkey |
| date_dim | 73049 | d_date_sk | date_dim_pkey, _dta_index_date_dim_6_661577395__k7_k4_k9_k1, _dta_index_date_dim_6_661577395__k7_k9_k1, _dta_index_date_dim_6_661577395__k1_k7_k9, _dta_index_date_dim_6_661577395__k7_k11_k1, _dta_index_date_dim_6_661577395__k9_k7_k1 |
| household_demographics | 7200 | hd_demo_sk | household_demographics_pkey |
| store | 102 | s_store_sk | store_pkey, _dta_index_store_6_885578193__k1_2_6, _dta_index_store_6_885578193__k25_k1 |
| store_sales | 28806628 | ss_item_sk, ss_ticket_number | store_sales_pkey, _dta_index_store_sales_6_1333579789__k1_k23_k14_k6_k8_k5_k7_3_4, _dta_index_store_sales_6_1333579789__k1_k5_k8_k3_11_13_14_20, _dta_index_store_sales_6_1333579789__k1_k3_k10_k4_k8_9_16_23, _dta_index_store_sales_6_1333579789__k4_1_3_10_11_14, _dta_index_store_sales_6_1333579789__k1_k3_k10_k4_k8_23 |

## Engine-Specific Knowledge
## Dialect Profile (POSTGRES)

**Combined Intelligence Baseline**: Combined intelligence baseline from 53 validated DSB queries at SF5-SF10, plus regression registry outcomes. PostgreSQL has bitmap index scans, JIT compilation, and aggressive CTE materialization. Techniques that work on DuckDB often regress here.

### Optimizer Strengths (don't fight these)
- `BITMAP_OR_SCAN`: Avoid splitting OR conditions into UNION ALL by default. Only consider OR→UNION when EXPLAIN shows OR blocks index usage and UNION branches become index scans. 0.21x and 0.26x reg…
- `SEMI_JOIN_EXISTS`: NEVER convert EXISTS to IN/NOT IN or materialized CTEs. 0.50x, 0.75x observed. Note: NOT EXISTS anti-join decorrelation can still be valid when replacing large correlated anti patterns.
- `INNER_JOIN_REORDERING`: Don't restructure INNER JOIN orders. Focus on LEFT JOIN blocking or comma-join confusion.
- `INDEX_ONLY_SCAN`: Small dimension lookups (<10K rows) may not need CTEs.

### Known Gaps (exploit these)
- `COMMA_JOIN_WEAKNESS` [HIGH] detect: FROM t1, t2, t3 WHERE t1.key = t2.key (comma joins, no explicit JOIN). Poor row estimates in EXPLAIN. | action: Convert comma-joins to explicit JOIN...ON syntax. Best when combined with date_cte_isolate.
- `CORRELATED_SUBQUERY_PARALYSIS` [HIGH] detect: Nested loop in EXPLAIN, inner re-executes aggregate per outer row. SQL: WHERE col > (SELECT AGG FROM ... WHERE outer.key = inner.key). Hash… | action: Convert correlated WHERE to explicit CTE with GROUP BY + JOIN.
- `NON_EQUI_JOIN_INPUT_BLINDNESS` [HIGH] detect: Expensive non-equi join (BETWEEN, <, >) with large inputs on both sides. Neither side filtered. | action: Reduce fact table input size via filtered CTE before the non-equi join.
- `CTE_MATERIALIZATION_FENCE` [MEDIUM] detect: Large CTE + small post-filter. Multi-referenced CTE that blocks predicate pushdown. | action: Materialize STRATEGICALLY: only when CTE is expensive and reused. Avoid fencing single-use cases.
- `CROSS_CTE_PREDICATE_BLINDNESS` [MEDIUM] detect: Sequential scan on dimension table without index condition. Late filter after large scan/join. | action: Pre-filter into CTE definition. But be more cautious than on DuckDB.

## Dispatcher Hypothesis
Cost spine dominated by Nested Loop (42.5s) scanning store_sales via index. Late OR condition filters prevent predicate pushdown to store_sales. Transform families A (early filtering), B (decorrelation), and D (OR→UNION) should reduce store_sales scans by pushing dimension filters early.

## Dispatcher Reasoning Trace
- Nested Loop scans store_sales 168K rows (42.5s) due to late OR condition application
- Comma-join syntax prevents predicate pushdown to store_sales (COMMA_JOIN_WEAKNESS gap)
- OR conditions on hd_dep_count/cd_marital_status and ca_state/ss_net_profit block bitmap scans
- High row amplification (365 loops × 461 rows) from unfiltered store_sales access

## Equivalence Tier
- exact

## Additional Intelligence
### AST Feature Detection

- **sf_sk_pushdown_multi_fact**: 100% match (DATE_DIM, MULTI_TABLE_5+) (gap: PREDICATE_TRANSITIVITY_FAILURE) [SUPPORT: portability_candidate; engines=snowflake]
- **dimension_cte_isolate**: 67% match (DATE_DIM, MULTI_TABLE_5+) (gap: CROSS_CTE_PREDICATE_BLINDNESS) [CAUTION: CROSS_JOIN_3_DIMS, UNFILTERED_CTE] [SUPPORT: portability_candidate; engines=duckdb]
  Missing: GROUP_BY
- **multi_date_range_cte**: 50% match (BETWEEN, DATE_DIM, MULTI_TABLE_5+) (gap: CROSS_CTE_PREDICATE_BLINDNESS) [SUPPORT: portability_candidate; engines=duckdb]
  Missing: AGG_AVG, GROUP_BY, TABLE_REPEAT_3+
- **inline_decorrelate_materialized**: 50% match (BETWEEN, DATE_DIM) (gap: CORRELATED_SUBQUERY_PARALYSIS)  [SUPPORT: native_or_universal]
  Missing: AGG_AVG, AGG_SUM
- **or_to_union**: 50% match (DATE_DIM, OR_BRANCH) (gap: CROSS_COLUMN_OR_DECOMPOSITION) [CAUTION: MAX_3_BRANCHES, SAME_COL_OR] [SUPPORT: portability_candidate; engines=duckdb]
  Missing: AGG_SUM, GROUP_BY


## Probe Summary
12 probes fired, 0 passed validation, 0 showed speedup.

## BDA Table (all probes)

| Probe | Transform | Family | Status | Speedup | Top EXPLAIN Nodes | Model Description | SQL Patch | Error/Notes |
|-------|-----------|--------|--------|---------|-------------------|-------------------|-----------|-------------|
| p12 | early_filter | A | ERROR | - | - | Push cd_education_status and cd_marital_status filters to customer_demographics scan | p12 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p08 | dimension_cte_isolate | A | ERROR | - | - | Isolate household_demographics filter (hd_dep_count) into CTE before store_sales join | p08 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p05 | early_filter_decorrelate | B | ERROR | - | - | Prefilter cd/hd dimensions in CTE, decorrelate first OR condition into semi-join with store_sales | p05 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p11 | pg_self_join_decomposition | E | ERROR | - | - | Materialize store_sales with first OR condition filters in CTE, then apply second OR condition | p11 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p01 | date_cte_explicit_join | F | ERROR | - | - | Convert comma-join to explicit INNER JOIN syntax and isolate date_dim filter in CTE | p01 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p10 | inline_decorrelate_materialized | B | ERROR | - | - | Materialize correlated hd/cd filters in CTE with GROUP BY ss_item_sk,ss_ticket_number | p10 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p02 | dimension_prefetch_star | F | ERROR | - | - | Prefilter all dimensions (store/hd/cd/ca) in CTEs before joining to store_sales | p02 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p03 | or_to_union | D | ERROR | - | - | Split first OR condition (hd/cd filters) into three UNION ALL branches | p03 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p06 | decorrelate | B | ERROR | - | - | Precompute store_sales keys satisfying second OR condition (ca_state filters) via CTE | p06 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p04 | decorrelate | B | FAIL | - | - | Precompute store_sales keys satisfying first OR condition via CTE with GROUP BY ss_item_sk,ss_ticket_number | p04 | Tier-1: COLUMN REF MISMATCH: Original columns missing from rewrite — ['ss_store_sk']. The rewrite references different table columns. |
| p09 | or_to_union | D | FAIL | - | - | Split second OR condition (ca_state filters) into three UNION ALL branches with explicit JOINs | - | Failed to parse/apply PatchPlan |
| p07 | multi_dimension_prefetch | A | ERROR | - | - | Prefilter ALL dimensions (date/store/hd/cd/ca) in CTEs before joining to store_sales | p07 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |

## Worker SQL Patches

### p12: early_filter (ERROR, n/a)
```sql
SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales, store, customer_demographics, household_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));
```

### p08: dimension_cte_isolate (ERROR, n/a)
```sql
WITH filtered_households AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count IN (1, 3)) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales JOIN filtered_households AS fh ON ss_hdemo_sk = fh.hd_demo_sk, store, customer_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND cd_demo_sk = ss_cdemo_sk AND ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));
```

### p05: early_filter_decorrelate (ERROR, n/a)
```sql
WITH cd_hd_branch1 AS (SELECT cd_demo_sk, hd_demo_sk FROM customer_demographics, household_demographics WHERE cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND hd_dep_count = 3), cd_hd_branch2 AS (SELECT cd_demo_sk, hd_demo_sk FROM customer_demographics, household_demographics WHERE cd_marital_status = 'S' AND cd_education_status = 'Primary' AND hd_dep_count = 1), cd_hd_branch3 AS (SELECT cd_demo_sk, hd_demo_sk FROM customer_demographics, household_demographics WHERE cd_marital_status = 'W' AND cd_education_status = 'Primary' AND hd_dep_count = 1) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN date_dim ON ss_sold_date_sk = d_date_sk LEFT JOIN cd_hd_branch1 AS b1 ON ss_cdemo_sk = b1.cd_demo_sk AND ss_hdemo_sk = b1.hd_demo_sk LEFT JOIN cd_hd_branch2 AS b2 ON ss_cdemo_sk = b2.cd_demo_sk AND ss_hdemo_sk = b2.hd_demo_sk LEFT JOIN cd_hd_branch3 AS b3 ON ss_cdemo_sk = b3.cd_demo_sk AND ss_hdemo_sk = b3.hd_demo_sk WHERE d_year = 2001 AND ((NOT b1.cd_demo_sk IS NULL AND ss_sales_price BETWEEN 100.00 AND 150.00) OR (NOT b2.cd_demo_sk IS NULL AND ss_sales_price BETWEEN 50.00 AND 100.00) OR (NOT b3.cd_demo_sk IS NULL AND ss_sales_price BETWEEN 150.00 AND 200.00)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));
```

### p11: pg_self_join_decomposition (ERROR, n/a)
```sql
WITH filtered_store_sales AS (SELECT * FROM store_sales WHERE ss_sales_price BETWEEN 100.00 AND 150.00 AND ss_net_profit BETWEEN 100 AND 200) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM filtered_store_sales AS ss, store AS s, customer_demographics AS cd, household_demographics AS hd, customer_address AS ca, date_dim AS d WHERE s.s_store_sk = ss.ss_store_sk AND ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001 AND ((ss.ss_hdemo_sk = hd.hd_demo_sk AND cd.cd_demo_sk = ss.ss_cdemo_sk AND cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND hd.hd_dep_count = 3) OR (ss.ss_hdemo_sk = hd.hd_demo_sk AND cd.cd_demo_sk = ss.ss_cdemo_sk AND cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (ss.ss_hdemo_sk = hd.hd_demo_sk AND cd.cd_demo_sk = ss.ss_cdemo_sk AND cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1)) AND ((ss.ss_addr_sk = ca.ca_address_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD')) OR (ss.ss_addr_sk = ca.ca_address_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ss.ss_addr_sk = ca.ca_address_sk AND ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250));
```

### p01: date_cte_explicit_join (ERROR, n/a)
```sql
WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk WHERE ((hd_dep_count = 3 AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00) OR (hd_dep_count = 1 AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00) OR (hd_dep_count = 1 AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00)) AND ((ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));
```

### p10: inline_decorrelate_materialized (ERROR, n/a)
```sql
WITH filtered_sales_demographics AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales AS ss JOIN household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN customer_demographics AS cd ON ss.ss_cdemo_sk = cd.cd_demo_sk WHERE ((cd.cd_marital_status = 'M' AND cd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND hd.hd_dep_count = 3) OR (cd.cd_marital_status = 'S' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND hd.hd_dep_count = 1) OR (cd.cd_marital_status = 'W' AND cd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND hd.hd_dep_count = 1))) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales AS ss JOIN store AS s ON s.s_store_sk = ss.ss_store_sk JOIN date_dim AS d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_address AS ca ON ss.ss_addr_sk = ca.ca_address_sk JOIN filtered_sales_demographics AS fsd ON ss.ss_item_sk = fsd.ss_item_sk AND ss.ss_ticket_number = fsd.ss_ticket_number WHERE d.d_year = 2001 AND (((ca.ca_country = 'United States' AND ca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250)));
```

### p02: dimension_prefetch_star (ERROR, n/a)
```sql
WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_customer_demographics AS (SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00)), filtered_household_demographics AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = 3) OR (hd_dep_count = 1)), filtered_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250)) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales AS ss JOIN store AS s ON s.s_store_sk = ss.ss_store_sk JOIN filtered_date_dim AS dd ON ss.ss_sold_date_sk = dd.d_date_sk JOIN filtered_customer_demographics AS cd ON ss.ss_cdemo_sk = cd.cd_demo_sk JOIN filtered_household_demographics AS hd ON ss.ss_hdemo_sk = hd.hd_demo_sk JOIN filtered_customer_address AS ca ON ss.ss_addr_sk = ca.ca_address_sk;
```

### p03: or_to_union (ERROR, n/a)
```sql
WITH branch1 AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales, store, customer_demographics, household_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))), branch2 AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales, store, customer_demographics, household_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))), branch3 AS (SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales, store, customer_demographics, household_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250))) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM (SELECT * FROM branch1 UNION ALL SELECT * FROM branch2 UNION ALL SELECT * FROM branch3) AS u;
```

### p06: decorrelate (ERROR, n/a)
```sql
WITH filtered_store_sales AS (SELECT ss_addr_sk FROM store_sales WHERE ss_net_profit BETWEEN 50 AND 250) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales, store, customer_demographics, household_demographics, customer_address, date_dim WHERE s_store_sk = ss_store_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2001 AND ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250 AND EXISTS(SELECT 1 FROM filtered_store_sales AS fss WHERE fss.ss_addr_sk = store_sales.ss_addr_sk)));
```

### p04: decorrelate (FAIL, n/a)
```sql
WITH filtered_store_sales_keys AS (SELECT ss_item_sk, ss_ticket_number FROM store_sales JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) GROUP BY ss_item_sk, ss_ticket_number) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales AS ss, store AS s, customer_demographics AS cd, household_demographics AS hd, customer_address AS ca, date_dim AS d, filtered_store_sales_keys AS fss WHERE s.s_store_sk = ss.s_store_sk AND ss.ss_sold_date_sk = d.d_date_sk AND d.d_year = 2001 AND ss.ss_item_sk = fss.ss_item_sk AND ss.ss_ticket_number = fss.ss_ticket_number AND ((ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'S' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (ss_hdemo_sk = hd_demo_sk AND cd_demo_sk = ss_cdemo_sk AND cd_marital_status = 'W' AND cd_education_status = 'Primary' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD') AND ss_net_profit BETWEEN 100 AND 200) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('AR', 'IN', 'VA') AND ss_net_profit BETWEEN 150 AND 300) OR (ss_addr_sk = ca_address_sk AND ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'SD') AND ss_net_profit BETWEEN 50 AND 250));
```

### p07: multi_dimension_prefetch (ERROR, n/a)
```sql
WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_stores AS (SELECT s_store_sk FROM store), filtered_cd AS (SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'W' AND cd_education_status = 'Primary')), filtered_hd AS (SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (1, 3)), filtered_ca AS (SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('GA', 'KY', 'SD', 'AR', 'IN', 'VA', 'KS', 'OH')) SELECT MIN(ss_quantity), MIN(ss_ext_sales_price), MIN(ss_ext_wholesale_cost), MIN(ss_ext_wholesale_cost) FROM store_sales AS ss JOIN filtered_stores AS fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_cd AS fcd ON ss.ss_cdemo_sk = fcd.cd_demo_sk JOIN filtered_hd AS fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN filtered_ca AS fca ON ss.ss_addr_sk = fca.ca_address_sk WHERE ((ss.ss_hdemo_sk = fhd.hd_demo_sk AND fcd.cd_demo_sk = ss.ss_cdemo_sk AND fcd.cd_marital_status = 'M' AND fcd.cd_education_status = '2 yr Degree' AND ss.ss_sales_price BETWEEN 100.00 AND 150.00 AND fhd.hd_dep_count = 3) OR (ss.ss_hdemo_sk = fhd.hd_demo_sk AND fcd.cd_demo_sk = ss.ss_cdemo_sk AND fcd.cd_marital_status = 'S' AND fcd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 50.00 AND 100.00 AND fhd.hd_dep_count = 1) OR (ss.ss_hdemo_sk = fhd.hd_demo_sk AND fcd.cd_demo_sk = ss.ss_cdemo_sk AND fcd.cd_marital_status = 'W' AND fcd.cd_education_status = 'Primary' AND ss.ss_sales_price BETWEEN 150.00 AND 200.00 AND fhd.hd_dep_count = 1)) AND ((ss.ss_addr_sk = fca.ca_address_sk AND fca.ca_country = 'United States' AND fca.ca_state IN ('GA', 'KY', 'SD') AND ss.ss_net_profit BETWEEN 100 AND 200) OR (ss.ss_addr_sk = fca.ca_address_sk AND fca.ca_country = 'United States' AND fca.ca_state IN ('AR', 'IN', 'VA') AND ss.ss_net_profit BETWEEN 150 AND 300) OR (ss.ss_addr_sk = fca.ca_address_sk AND fca.ca_country = 'United States' AND fca.ca_state IN ('KS', 'OH', 'SD') AND ss.ss_net_profit BETWEEN 50 AND 250));
```
