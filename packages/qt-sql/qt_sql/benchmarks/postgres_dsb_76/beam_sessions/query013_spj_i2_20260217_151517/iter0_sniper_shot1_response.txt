[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p01",
    "strategy": "Explicit JOINs with date CTE to resolve comma-join weakness",
    "hypothesis": "Original comma-joins prevent predicate pushdown. Converting to explicit JOINs with filtered date CTE enables early store_sales reduction via date filter pushdown.",
    "target_ir": "CTE-filtered date_dim with explicit INNER JOIN chain",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date_dim",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "store_sales\nJOIN store ON s_store_sk = ss_store_sk\nJOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk\nJOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk\nJOIN household_demographics ON ss_hdemo_sk = hd_demo_sk\nJOIN customer_address ON ss_addr_sk = ca_address_sk"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p07",
    "strategy": "Store/date prefetch CTE to reduce nested loops",
    "hypothesis": "Nested loop on store_sales (168K rows) stems from late date/store filtering. Prejoining store_sales-store-date_dim in CTE applies filters early to reduce probe rows.",
    "target_ir": "Filtered store_sales CTE joined to dimensions",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost, ss_cdemo_sk, ss_hdemo_sk, ss_addr_sk, ss_sales_price, ss_net_profit\nFROM store_sales\nJOIN store ON s_store_sk = ss_store_sk\nJOIN date_dim ON ss_sold_date_sk = d_date_sk\nWHERE d_year = 2001"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "filtered_sales\nJOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk\nJOIN household_demographics ON ss_hdemo_sk = hd_demo_sk\nJOIN customer_address ON ss_addr_sk = ca_address_sk"
        }
      }
    ]
  }
]