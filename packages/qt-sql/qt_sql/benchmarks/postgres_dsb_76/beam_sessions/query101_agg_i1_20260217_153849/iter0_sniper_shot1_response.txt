[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p11,p01",
    "strategy": "Foundation plus explicit join conversion with dimension CTEs",
    "hypothesis": "Converting comma joins to explicit INNER JOIN with ON conditions unlocks optimizer reordering while pre-filtering dimensions via CTEs reduces row amplification",
    "target_ir": "Structured JOIN tree with filtered dimension CTEs and pushdown predicates",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM store_sales AS ss INNER JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales AS ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN date_dim AS d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim AS d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 DAY') INNER JOIN (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music')) AS i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX')) AS ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 7 AND 13 AND hd_buy_potential = '0-500') AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk"
        }
      },
      {
        "step_id": "s2",
        "op": "delete_expr_subtree",
        "target": {"by_anchor_hash": "267a8f8c05e058f0"},
        "payload": {}
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p02,p04",
    "strategy": "Date range isolation with explicit join structure",
    "hypothesis": "Materializing filtered d1 and pre-joined d2 date ranges reduces non-equi join cost while explicit join syntax enables better planning",
    "target_ir": "Date CTEs with range pre-computation and optimized join sequence",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d1_filtered",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d2_ranged",
          "cte_query_sql": "SELECT d2.d_date_sk, d2.d_date FROM date_dim d2 INNER JOIN d1_filtered d1 ON d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 DAY')"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "FROM store_sales AS ss INNER JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number INNER JOIN d1_filtered AS d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN web_sales AS ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk INNER JOIN d2_ranged AS d2 ON ws.ws_sold_date_sk = d2.d_date_sk INNER JOIN item AS i ON ss.ss_item_sk = i.i_item_sk INNER JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE i.i_category IN ('Children', 'Electronics', 'Music') AND ca.ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX') AND hd.hd_income_band_sk BETWEEN 7 AND 13 AND hd.hd_buy_potential = '0-500' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 0.35 AND 0.55"
        }
      }
    ]
  }
]