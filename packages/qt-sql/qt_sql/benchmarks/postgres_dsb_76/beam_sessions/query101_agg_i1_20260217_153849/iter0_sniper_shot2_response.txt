[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "family": "F",
    "transform": "explicit_join_with_dimension_ctes",
    "confidence": 0.85,
    "based_on": "p11,p01",
    "hypothesis": "Original plan shows comma-join weakness in PostgreSQL. Converting to explicit joins enables better join reordering. Pre-filtering selective dimensions (item, customer_address, household_demographics, d1) via CTEs reduces join cardinality early.",
    "target_ir": "CTEs for selective dimensions + explicit JOIN structure",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "item_cte",
          "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Electronics', 'Music')"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "ca_cte",
          "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX')"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "hd_cte",
          "cte_query_sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 7 AND 13 AND hd_buy_potential = '0-500'"
        }
      },
      {
        "step_id": "s4",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "d1_cte",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
        }
      },
      {
        "step_id": "s5",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "store_sales AS ss INNER JOIN store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales AS ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN d1_cte AS d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim AS d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN item_cte AS i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN ca_cte AS ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN hd_cte AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk"
        }
      },
      {
        "step_id": "s6",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "predicate": "ss.ss_sales_price / ss.ss_list_price BETWEEN 35 * 0.01 AND 55 * 0.01"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "family": "A",
    "transform": "fact_prefilter",
    "confidence": 0.75,
    "based_on": "p08,p09",
    "hypothesis": "Nested loops dominate runtime. Pre-filtering store_sales by ratio condition and store_returns by d1 year reduces fact table inputs before expensive joins. Explicit joins prevent comma-join weakness.",
    "target_ir": "CTEs for filtered facts + explicit joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "ss_filtered",
          "cte_query_sql": "SELECT * FROM store_sales WHERE ss_sales_price / ss_list_price BETWEEN 35 * 0.01 AND 55 * 0.01"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "sr_filtered",
          "cte_query_sql": "SELECT * FROM store_returns WHERE sr_returned_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1998)"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "from_sql": "ss_filtered AS ss INNER JOIN sr_filtered AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales AS ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN date_dim AS d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim AS d2 ON ws.ws_sold_date_sk = d2.d_date_sk AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') INNER JOIN item AS i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer AS c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics AS hd ON c.c_current_hdemo_sk = hd.hd_demo_sk"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {"by_node_id": "S0"},
        "payload": {
          "predicate": "TRUE AND i.i_category IN ('Children', 'Electronics', 'Music') AND ca.ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX') AND hd.hd_income_band_sk BETWEEN 7 AND 13 AND hd.hd_buy_potential = '0-500'"
        }
      }
    ]
  }
]