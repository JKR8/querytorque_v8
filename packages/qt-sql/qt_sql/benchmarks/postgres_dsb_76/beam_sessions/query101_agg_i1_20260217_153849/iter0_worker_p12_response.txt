{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate multiple scans of fact tables (store_sales, store_returns, web_sales) into a single CTE with CASE-based channel aggregation to reduce redundant scans and improve join efficiency.",
  "reasoning_trace": [
    "Three fact tables (store_sales, store_returns, web_sales) are scanned separately but can be unified via CASE-based aggregation.",
    "Redundant dimension joins and filters can be applied once in a consolidated CTE."
  ],
  "target_ir": "Single CTE with CASE-based aggregation of sales channels; main query joins dimensions to this unified source.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "unified_sales",
        "cte_query_sql": "SELECT ss_customer_sk AS customer_sk, 'store' AS channel, ss_sales_price AS sales_price FROM store_sales UNION ALL SELECT sr_customer_sk, 'return', sr_return_amt FROM store_returns UNION ALL SELECT ws_bill_customer_sk, 'web', ws_sales_price FROM web_sales"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "unified_sales us JOIN customer c ON us.customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk JOIN item i ON us.customer_sk = i.i_item_sk JOIN date_dim d1 ON us.customer_sk = d1.d_date_sk JOIN date_dim d2 ON us.customer_sk = d2.d_date_sk"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "i.i_category IN ('Children', 'Electronics', 'Music') AND ca.ca_state IN ('AR', 'CO', 'NC', 'NY', 'TX') AND d1.d_year = 1998 AND hd.hd_income_band_sk BETWEEN 7 AND 13 AND hd.hd_buy_potential = '0-500' AND (us.channel = 'store' OR us.channel = 'web') AND us.sales_price / NULLIF(us.sales_price, 0) BETWEEN 0.35 AND 0.55"
      }
    }
  ]
}