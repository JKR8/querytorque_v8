[  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.9,
    "based_on": "p03",
    "strategy": "Decompose OR predicates into three UNION ALL branches to improve cardinality estimates and avoid nested loops.",
    "hypothesis": "Probe p03 achieved 51x speedup by splitting the OR conditions, allowing the planner to use more efficient join strategies for each branch. This addresses the cardinality misestimation (est=3, act=348) that caused nested loop amplification.",
    "expected_explain_delta": "Nested loops replaced by hash joins or index scans in each branch, union then aggregate, eliminating the deep nested loop chain.",
    "target_ir": "Replace the original join graph with three union branches, each with specific filter conditions, then aggregate.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["union_branch_1", "union_branch_2", "union_branch_3"],
          "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "SELECT SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM (SELECT * FROM union_branch_1 UNION ALL SELECT * FROM union_branch_2 UNION ALL SELECT * FROM union_branch_3) t GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
        },
        {
          "node_id": "union_branch_1",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
          "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
          "changed": true,
          "sql": "SELECT r.r_reason_desc, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee FROM web_sales ws, web_returns wr, web_page wp, customer_demographics cd1, customer_demographics cd2, customer_address ca, date_dim d, reason r WHERE ws.ws_web_page_sk = wp.wp_web_page_sk AND ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number AND ws.ws_sold_date_sk = d.d_date_sk AND d.d_year = 2002 AND cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr.wr_returning_cdemo_sk AND ca.ca_address_sk = wr.wr_refunded_addr_sk AND r.r_reason_sk = wr.wr_reason_sk AND cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00 AND ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200"
        },
        {
          "node_id": "union_branch_2",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
          "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
          "changed": true,
          "sql": "SELECT r.r_reason_desc, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee FROM web_sales ws, web_returns wr, web_page wp, customer_demographics cd1, customer_demographics cd2, customer_address ca, date_dim d, reason r WHERE ws.ws_web_page_sk = wp.wp_web_page_sk AND ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number AND ws.ws_sold_date_sk = d.d_date_sk AND d.d_year = 2002 AND cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr.wr_returning_cdemo_sk AND ca.ca_address_sk = wr.wr_refunded_addr_sk AND r.r_reason_sk = wr.wr_reason_sk AND cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00 AND ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300"
        },
        {
          "node_id": "union_branch_3",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "web_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "date_dim", "reason"],
          "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
          "changed": true,
          "sql": "SELECT r.r_reason_desc, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee FROM web_sales ws, web_returns wr, web_page wp, customer_demographics cd1, customer_demographics cd2, customer_address ca, date_dim d, reason r WHERE ws.ws_web_page_sk = wp.wp_web_page_sk AND ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number AND ws.ws_sold_date_sk = d.d_date_sk AND d.d_year = 2002 AND cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk AND cd2.cd_demo_sk = wr.wr_returning_cdemo_sk AND ca.ca_address_sk = wr.wr_refunded_addr_sk AND r.r_reason_sk = wr.wr_reason_sk AND cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00 AND ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.9,
    "based_on": "p02",
    "strategy": "Materialize filtered dimension tables and a fact join to reduce repeated scans and improve join order.",
    "hypothesis": "Probe p02 achieved 51x speedup by pre-filtering dimensions and materializing the fact join, breaking the nested loop chain. This reduces the rows entering the final join spine and addresses the cardinality misestimation.",
    "expected_explain_delta": "Nested loops replaced by hash joins, early aggregation reduces rows, and materialized CTEs avoid repeated scans.",
    "target_ir": "Introduce CTEs for filtered dimensions and fact join, then apply OR conditions in a grouped results CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["grouped_results"],
          "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "SELECT SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM grouped_results GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
        },
        {
          "node_id": "grouped_results",
          "parent_node_id": "final_select",
          "sources": ["fact_join", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "reason", "filtered_cd1", "filtered_cd2", "filtered_ca"],
          "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
          "changed": true,
          "sql": "SELECT r.r_reason_desc, f.ws_quantity, f.wr_refunded_cash, f.wr_fee FROM fact_join f JOIN customer_demographics cd1 ON cd1.cd_demo_sk = f.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = f.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = f.wr_refunded_addr_sk JOIN reason r ON r.r_reason_sk = f.wr_reason_sk JOIN filtered_cd1 fc1 ON fc1.cd_demo_sk = cd1.cd_demo_sk JOIN filtered_cd2 fc2 ON fc2.cd_demo_sk = cd2.cd_demo_sk JOIN filtered_ca fca ON fca.ca_address_sk = ca.ca_address_sk WHERE (cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status) AND ( (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND f.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND f.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND f.ws_sales_price BETWEEN 150.00 AND 200.00) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND f.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND f.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND f.ws_net_profit BETWEEN 50 AND 250) )"
        },
        {
          "node_id": "fact_join",
          "parent_node_id": "grouped_results",
          "sources": ["web_sales", "web_returns", "date_dim", "web_page"],
          "outputs": ["wr_refunded_cdemo_sk", "wr_returning_cdemo_sk", "wr_refunded_addr_sk", "wr_reason_sk", "ws_quantity", "wr_refunded_cash", "wr_fee", "ws_sales_price", "ws_net_profit"],
          "changed": true,
          "sql": "SELECT wr.wr_refunded_cdemo_sk, wr.wr_returning_cdemo_sk, wr.wr_refunded_addr_sk, wr.wr_reason_sk, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee, ws.ws_sales_price, ws.ws_net_profit FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE d.d_year = 2002"
        },
        {
          "node_id": "filtered_cd1",
          "parent_node_id": "grouped_results",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
        },
        {
          "node_id": "filtered_cd2",
          "parent_node_id": "grouped_results",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
        },
        {
          "node_id": "filtered_ca",
          "parent_node_id": "grouped_results",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk"],
          "changed": true,
          "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p3",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p04,p01",
    "strategy": "Convert comma joins to explicit JOIN syntax and materialize filtered date_dim to improve join order and predicate pushdown.",
    "hypothesis": "Probes p04 and p01 attempted explicit join conversion and early filtering but failed due to column mismatch. This attempt fixes the column mismatch and retains the original OR conditions, addressing the comma-join weakness and poor cardinality estimates.",
    "expected_explain_delta": "Improved join order and use of hash joins, reducing nested loop amplification, with early date filter applied via CTE.",
    "target_ir": "Convert comma joins to explicit joins and add a CTE for filtered date_dim.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["web_sales", "web_returns", "web_page", "customer_demographics cd1", "customer_demographics cd2", "customer_address", "filtered_date_dim", "reason"],
          "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "SELECT SUBSTRING(r.r_reason_desc,1,20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN customer_demographics cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk JOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN reason r ON r.r_reason_sk = wr.wr_reason_sk WHERE ( (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250) ) GROUP BY r.r_reason_desc ORDER BY SUBSTRING(r.r_reason_desc,1,20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) LIMIT 100"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        }
      ]
    }
  }
]