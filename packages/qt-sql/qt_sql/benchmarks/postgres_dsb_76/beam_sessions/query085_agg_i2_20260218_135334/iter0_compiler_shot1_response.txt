[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02",
    "strategy": "Materialize fact join early and apply OR predicates after, avoiding repeated nested-loop scans.",
    "hypothesis": "Winning probe p02 achieved 51x speedup by materializing the filtered web_sales–web_returns–date_dim–web_page join into a CTE, then applying the complex OR predicates once. This addresses the original nested-loop hotspot (348 rows, 2441ms) and avoids repeated scans.",
    "expected_explain_delta": "Nested loops replaced by hash joins; early fact join CTE reduces rows before applying OR predicates; aggregate input shrinks.",
    "target_ir": "Replace comma joins with explicit join CTEs, add fact_join and grouped_results nodes.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["grouped_results"],
          "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "SELECT SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM grouped_results GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
        },
        {
          "node_id": "grouped_results",
          "parent_node_id": "final_select",
          "sources": ["fact_join", "filtered_cd1", "filtered_cd2", "filtered_ca", "reason", "customer_demographics", "customer_address"],
          "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
          "changed": true,
          "sql": "SELECT r.r_reason_desc, f.ws_quantity, f.wr_refunded_cash, f.wr_fee FROM fact_join f JOIN customer_demographics cd1 ON cd1.cd_demo_sk = f.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = f.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = f.wr_refunded_addr_sk JOIN reason r ON r.r_reason_sk = f.wr_reason_sk JOIN filtered_cd1 fc1 ON fc1.cd_demo_sk = cd1.cd_demo_sk JOIN filtered_cd2 fc2 ON fc2.cd_demo_sk = cd2.cd_demo_sk JOIN filtered_ca fca ON fca.ca_address_sk = ca.ca_address_sk WHERE (cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status) AND ( (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND f.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND f.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND f.ws_sales_price BETWEEN 150.00 AND 200.00) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND f.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND f.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND f.ws_net_profit BETWEEN 50 AND 250) )"
        },
        {
          "node_id": "fact_join",
          "parent_node_id": "grouped_results",
          "sources": ["web_sales", "web_returns", "date_dim", "web_page"],
          "outputs": ["wr_refunded_cdemo_sk", "wr_returning_cdemo_sk", "wr_refunded_addr_sk", "wr_reason_sk", "ws_quantity", "wr_refunded_cash", "wr_fee", "ws_sales_price", "ws_net_profit"],
          "changed": true,
          "sql": "SELECT wr.wr_refunded_cdemo_sk, wr.wr_returning_cdemo_sk, wr.wr_refunded_addr_sk, wr.wr_reason_sk, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee, ws.ws_sales_price, ws.ws_net_profit FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE d.d_year = 2002"
        },
        {
          "node_id": "filtered_cd1",
          "parent_node_id": "grouped_results",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
        },
        {
          "node_id": "filtered_cd2",
          "parent_node_id": "grouped_results",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk"],
          "changed": true,
          "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
        },
        {
          "node_id": "filtered_ca",
          "parent_node_id": "grouped_results",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk"],
          "changed": true,
          "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.60,
    "based_on": "p04,p01",
    "strategy": "Convert comma joins to explicit joins and pre-filter selective dimensions with CTEs.",
    "hypothesis": "Failed probes p04 and p01 aimed at comma‑join weakness and early dimension filtering. This corrected version materializes filtered dimension tables (date_dim, reason, web_page, customer_demographics, customer_address) and uses explicit JOIN syntax, providing cleaner cardinality estimates.",
    "expected_explain_delta": "Comma joins become explicit joins; dimension CTEs reduce nested‑loop fanout; BitmapOr may still handle OR predicates.",
    "target_ir": "Replace comma joins with explicit join CTEs and keep final_select aggregation.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["web_sales", "web_returns", "date_dim_filtered", "web_page_filtered", "cd1_filtered", "cd2_filtered", "customer_address_filtered", "reason_filtered"],
          "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
          "changed": true,
          "sql": "SELECT SUBSTRING(r.r_reason_desc,1,20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim_filtered d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_page_filtered wp ON ws.ws_web_page_sk = wp.wp_web_page_sk JOIN cd1_filtered cd1 ON cd1.cd_demo_sk = wr.wr_refunded_cdemo_sk JOIN cd2_filtered cd2 ON cd2.cd_demo_sk = wr.wr_returning_cdemo_sk JOIN customer_address_filtered ca ON ca.ca_address_sk = wr.wr_refunded_addr_sk JOIN reason_filtered r ON r.r_reason_sk = wr.wr_reason_sk WHERE ( (cd1.cd_marital_status = 'S' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Primary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = 'Secondary' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = '2 yr Degree' AND cd1.cd_education_status = cd2.cd_education_status AND ws.ws_sales_price BETWEEN 150.00 AND 200.00) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND ws.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND ws.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND ws.ws_net_profit BETWEEN 50 AND 250) ) GROUP BY r.r_reason_desc ORDER BY SUBSTRING(r.r_reason_desc,1,20), AVG(ws.ws_quantity), AVG(wr.wr_refunded_cash), AVG(wr.wr_fee) LIMIT 100"
        },
        {
          "node_id": "date_dim_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002"
        },
        {
          "node_id": "web_page_filtered",
          "parent_node_id": "final_select",
          "sources": ["web_page"],
          "outputs": ["wp_web_page_sk"],
          "changed": true,
          "sql": "SELECT wp_web_page_sk FROM web_page"
        },
        {
          "node_id": "cd1_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary') OR (cd_marital_status = 'U' AND cd_education_status = '2 yr Degree')"
        },
        {
          "node_id": "cd2_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'S' AND cd_education_status = 'Primary') OR (cd_marital_status = 'M' AND cd_education_status = 'Secondary') OR (cd_marital_status = 'U' AND cd_education_status = '2 yr Degree')"
        },
        {
          "node_id": "customer_address_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk", "ca_country", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE (ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD')) OR (ca_country = 'United States' AND ca_state IN ('AR', 'GA', 'IN')) OR (ca_country = 'United States' AND ca_state IN ('KS', 'OH', 'VA'))"
        },
        {
          "node_id": "reason_filtered",
          "parent_node_id": "final_select",
          "sources": ["reason"],
          "outputs": ["r_reason_sk", "r_reason_desc"],
          "changed": true,
          "sql": "SELECT r_reason_sk, r_reason_desc FROM reason"
        }
      ]
    }
  }
]