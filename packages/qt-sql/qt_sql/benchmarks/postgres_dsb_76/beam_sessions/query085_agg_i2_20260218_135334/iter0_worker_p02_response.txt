{
  "probe_id": "scout_pg_self_join_decomposition",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Materializing the core web_sales and web_returns join into a CTE allows PostgreSQL to better estimate selectivity for downstream OR predicates on customer demographics and address, reducing nested loop amplification.",
  "reasoning_trace": [
    "Assigned transform targets self-join pattern with repeated scans of web_sales and web_returns.",
    "Nested loop Q-error (est=3, act=348) indicates poor selectivity estimation on OR predicates.",
    "Materializing the fact join once avoids repeated scans and enables better costing.",
    "PostgreSQL's default CTE materialization supports this pattern without requiring RECURSIVE or MATERIALIZED keywords."
  ],
  "target_ir": "Introduce fact_join CTE for web_sales and web_returns; apply customer_demographics and customer_address filters in separate CTEs.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["grouped_results"],
        "outputs": ["SUBSTRING(r_reason_desc FROM 1 FOR 20)", "AVG(ws_quantity)", "AVG(wr_refunded_cash)", "AVG(wr_fee)"],
        "changed": true,
        "sql": "SELECT SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) FROM grouped_results GROUP BY r_reason_desc ORDER BY SUBSTRING(r_reason_desc,1,20), AVG(ws_quantity), AVG(wr_refunded_cash), AVG(wr_fee) LIMIT 100"
      },
      {
        "node_id": "grouped_results",
        "parent_node_id": "final_select",
        "sources": ["filtered_cd1", "filtered_cd2", "filtered_ca"],
        "outputs": ["r_reason_desc", "ws_quantity", "wr_refunded_cash", "wr_fee"],
        "changed": true,
        "sql": "SELECT r.r_reason_desc, f.ws_quantity, f.wr_refunded_cash, f.wr_fee FROM fact_join f JOIN customer_demographics cd1 ON cd1.cd_demo_sk = f.wr_refunded_cdemo_sk JOIN customer_demographics cd2 ON cd2.cd_demo_sk = f.wr_returning_cdemo_sk JOIN customer_address ca ON ca.ca_address_sk = f.wr_refunded_addr_sk JOIN reason r ON r.r_reason_sk = f.wr_reason_sk JOIN filtered_cd1 fc1 ON fc1.cd_demo_sk = cd1.cd_demo_sk JOIN filtered_cd2 fc2 ON fc2.cd_demo_sk = cd2.cd_demo_sk JOIN filtered_ca fca ON fca.ca_address_sk = ca.ca_address_sk WHERE (cd1.cd_marital_status = cd2.cd_marital_status AND cd1.cd_education_status = cd2.cd_education_status) AND ( (cd1.cd_marital_status = 'S' AND cd1.cd_education_status = 'Primary' AND f.ws_sales_price BETWEEN 100.00 AND 150.00) OR (cd1.cd_marital_status = 'M' AND cd1.cd_education_status = 'Secondary' AND f.ws_sales_price BETWEEN 50.00 AND 100.00) OR (cd1.cd_marital_status = 'U' AND cd1.cd_education_status = '2 yr Degree' AND f.ws_sales_price BETWEEN 150.00 AND 200.00) ) AND ( (ca.ca_country = 'United States' AND ca.ca_state IN ('KY', 'NC', 'SD') AND f.ws_net_profit BETWEEN 100 AND 200) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('AR', 'GA', 'IN') AND f.ws_net_profit BETWEEN 150 AND 300) OR (ca.ca_country = 'United States' AND ca.ca_state IN ('KS', 'OH', 'VA') AND f.ws_net_profit BETWEEN 50 AND 250) )"
      },
      {
        "node_id": "filtered_cd1",
        "parent_node_id": "grouped_results",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
      },
      {
        "node_id": "filtered_cd2",
        "parent_node_id": "grouped_results",
        "sources": ["customer_demographics"],
        "outputs": ["cd_demo_sk"],
        "changed": true,
        "sql": "SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status IN ('S', 'M', 'U') AND cd_education_status IN ('Primary', 'Secondary', '2 yr Degree')"
      },
      {
        "node_id": "filtered_ca",
        "parent_node_id": "grouped_results",
        "sources": ["customer_address"],
        "outputs": ["ca_address_sk"],
        "changed": true,
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('KY', 'NC', 'SD', 'AR', 'GA', 'IN', 'KS', 'OH', 'VA')"
      },
      {
        "node_id": "fact_join",
        "parent_node_id": "grouped_results",
        "sources": ["web_sales", "web_returns", "date_dim", "web_page"],
        "outputs": ["wr_refunded_cdemo_sk", "wr_returning_cdemo_sk", "wr_refunded_addr_sk", "wr_reason_sk", "ws_quantity", "wr_refunded_cash", "wr_fee", "ws_sales_price", "ws_net_profit"],
        "changed": true,
        "sql": "SELECT wr.wr_refunded_cdemo_sk, wr.wr_returning_cdemo_sk, wr.wr_refunded_addr_sk, wr.wr_reason_sk, ws.ws_quantity, wr.wr_refunded_cash, wr.wr_fee, ws.ws_sales_price, ws.ws_net_profit FROM web_sales ws JOIN web_returns wr ON ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN web_page wp ON ws.ws_web_page_sk = wp.wp_web_page_sk WHERE d.d_year = 2002 AND ws.ws_web_page_sk = wp.wp_web_page_sk"
      }
    ]
  }
}