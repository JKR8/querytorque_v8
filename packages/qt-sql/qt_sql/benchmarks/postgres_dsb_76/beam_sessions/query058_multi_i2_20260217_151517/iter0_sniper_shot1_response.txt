[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p04,p02,p10",
    "strategy": "Shared date CTE plus explicit joins",
    "hypothesis": "Original plan shows 9 repeated date_dim scans. Creating a shared date CTE avoids recomputation. Converting comma joins to explicit INNER JOIN enables better join ordering and reduces nested loops.",
    "target_ir": "Top-level CTE: date_range; ss/cs/ws_items rewritten with explicit joins and date_range reference",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "date_range",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '2001-06-06')"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_ss_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, c_birth_year birth_year, SUM(ss_ext_sales_price) ss_item_rev FROM store_sales INNER JOIN item ON ss_item_sk = i_item_sk INNER JOIN date_range ON ss_sold_date_sk = date_range.d_date_sk INNER JOIN customer ON ss_customer_sk = c_customer_sk WHERE ss_list_price BETWEEN 168 AND 197 AND i_manager_id BETWEEN 42 AND 71 AND c_birth_year BETWEEN 1985 AND 1991 GROUP BY i_item_id, c_birth_year"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_cs_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, c_birth_year birth_year, SUM(cs_ext_sales_price) cs_item_rev FROM catalog_sales INNER JOIN item ON cs_item_sk = i_item_sk INNER JOIN date_range ON cs_sold_date_sk = date_range.d_date_sk INNER JOIN customer ON cs_bill_customer_sk = c_customer_sk WHERE cs_list_price BETWEEN 168 AND 197 AND i_manager_id BETWEEN 42 AND 71 AND c_birth_year BETWEEN 1985 AND 1991 GROUP BY i_item_id, c_birth_year"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_body",
        "target": {"by_node_id": "CTE_Q_S0_ws_items"},
        "payload": {
          "sql_fragment": "SELECT i_item_id item_id, c_birth_year birth_year, SUM(ws_ext_sales_price) ws_item_rev FROM web_sales INNER JOIN item ON ws_item_sk = i_item_sk INNER JOIN date_range ON ws_sold_date_sk = date_range.d_date_sk INNER JOIN customer ON ws_bill_customer_sk = c_customer_sk WHERE ws_list_price BETWEEN 168 AND 197 AND i_manager_id BETWEEN 42 AND 71 AND c_birth_year BETWEEN 1985 AND 1991 GROUP BY i_item_id, c_birth_year"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p08",
    "strategy": "Decorrelated date subqueries with CTE",
    "hypothesis": "EXPLAIN shows correlated date subqueries causing nested loops. Decorrelation via CTE should enable hash joins. Prevents repeated execution of identical subqueries across CTEs.",
    "target_ir": "Top-level CTEs: target_month, date_range; ss/cs/ws_items with decorrelated date conditions",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "target_month",
          "cte_query_sql": "SELECT d_month_seq FROM date_dim WHERE d_date = '2001-06-06'"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "date_range",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM target_month)"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "554a3fe2201f4929"},
        "payload": {
          "sql_fragment": "ss_sold_date_sk IN (SELECT d_date_sk FROM date_range)"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "1486ed692fcdf986"},
        "payload": {
          "sql_fragment": "cs_sold_date_sk IN (SELECT d_date_sk FROM date_range)"
        }
      },
      {
        "step_id": "s5",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "69fb2a5666ca00a9"},
        "payload": {
          "sql_fragment": "ws_sold_date_sk IN (SELECT d_date_sk FROM date_range)"
        }
      }
    ]
  }
]