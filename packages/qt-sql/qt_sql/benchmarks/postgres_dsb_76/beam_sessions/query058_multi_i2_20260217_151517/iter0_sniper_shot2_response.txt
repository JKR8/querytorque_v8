[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p04,p09",
    "strategy": "Shared date CTE and explicit joins",
    "hypothesis": "Original plan shows repeated full scans of date_dim and nested loops. Materializing date range once and converting comma-joins to explicit joins reduces date_dim scans and helps optimizer join ordering",
    "target_ir": "Add selected_dates CTE; rewrite CTEs with explicit joins using date_sk instead of d_date IN subquery",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH selected_dates AS (\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '2001-06-06')\n),\nss_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(ss_ext_sales_price) ss_item_rev\n    FROM store_sales\n    INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n    INNER JOIN selected_dates ON store_sales.ss_sold_date_sk = selected_dates.d_date_sk\n    INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk\n    WHERE store_sales.ss_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n),\ncs_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(cs_ext_sales_price) cs_item_rev\n    FROM catalog_sales\n    INNER JOIN item ON catalog_sales.cs_item_sk = item.i_item_sk\n    INNER JOIN selected_dates ON catalog_sales.cs_sold_date_sk = selected_dates.d_date_sk\n    INNER JOIN customer ON catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n    WHERE catalog_sales.cs_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n),\nws_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(ws_ext_sales_price) ws_item_rev\n    FROM web_sales\n    INNER JOIN item ON web_sales.ws_item_sk = item.i_item_sk\n    INNER JOIN selected_dates ON web_sales.ws_sold_date_sk = selected_dates.d_date_sk\n    INNER JOIN customer ON web_sales.ws_bill_customer_sk = customer.c_customer_sk\n    WHERE web_sales.ws_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n)\nSELECT ss_items.item_id, ss_items.birth_year,\n       ss_item_rev,\n       ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ss_dev,\n       cs_item_rev,\n       cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 cs_dev,\n       ws_item_rev,\n       ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ws_dev,\n       (ss_item_rev+cs_item_rev+ws_item_rev)/3 average\nFROM ss_items, cs_items, ws_items\nWHERE ss_items.item_id=cs_items.item_id\n  AND ss_items.item_id=ws_items.item_id\n  AND ss_items.birth_year = cs_items.birth_year\n  AND ss_items.birth_year = ws_items.birth_year\n  AND ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev\n  AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev\n  AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev\n  AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev\n  AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev\n  AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev\nORDER BY item_id, birth_year, ss_item_rev\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p08",
    "strategy": "Scalar subquery decorrelation with explicit joins",
    "hypothesis": "Nested loops in original plan caused by correlated date subqueries. Replacing IN-subquery with scalar equality reduces correlation and enables better index usage on date_dim",
    "target_ir": "Add target_month CTE; rewrite date conditions to use d_month_seq scalar directly",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH target_month AS (SELECT d_month_seq FROM date_dim WHERE d_date = '2001-06-06'),\nss_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(ss_ext_sales_price) ss_item_rev\n    FROM store_sales\n    INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk\n    INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk\n    INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk\n    WHERE date_dim.d_month_seq = (SELECT d_month_seq FROM target_month)\n      AND store_sales.ss_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n),\ncs_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(cs_ext_sales_price) cs_item_rev\n    FROM catalog_sales\n    INNER JOIN item ON catalog_sales.cs_item_sk = item.i_item_sk\n    INNER JOIN date_dim ON catalog_sales.cs_sold_date_sk = date_dim.d_date_sk\n    INNER JOIN customer ON catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n    WHERE date_dim.d_month_seq = (SELECT d_month_seq FROM target_month)\n      AND catalog_sales.cs_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n),\nws_items AS (\n    SELECT i_item_id item_id, c_birth_year birth_year, SUM(ws_ext_sales_price) ws_item_rev\n    FROM web_sales\n    INNER JOIN item ON web_sales.ws_item_sk = item.i_item_sk\n    INNER JOIN date_dim ON web_sales.ws_sold_date_sk = date_dim.d_date_sk\n    INNER JOIN customer ON web_sales.ws_bill_customer_sk = customer.c_customer_sk\n    WHERE date_dim.d_month_seq = (SELECT d_month_seq FROM target_month)\n      AND web_sales.ws_list_price BETWEEN 168 AND 197\n      AND item.i_manager_id BETWEEN 42 AND 71\n      AND customer.c_birth_year BETWEEN 1985 AND 1991\n    GROUP BY item.i_item_id, customer.c_birth_year\n)\nSELECT ss_items.item_id, ss_items.birth_year,\n       ss_item_rev,\n       ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ss_dev,\n       cs_item_rev,\n       cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 cs_dev,\n       ws_item_rev,\n       ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ws_dev,\n       (ss_item_rev+cs_item_rev+ws_item_rev)/3 average\nFROM ss_items, cs_items, ws_items\nWHERE ss_items.item_id=cs_items.item_id\n  AND ss_items.item_id=ws_items.item_id\n  AND ss_items.birth_year = cs_items.birth_year\n  AND ss_items.birth_year = ws_items.birth_year\n  AND ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev\n  AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev\n  AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev\n  AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev\n  AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev\n  AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev\nORDER BY item_id, birth_year, ss_item_rev\nLIMIT 100;"
        }
      }
    ]
  }
]