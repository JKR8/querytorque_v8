{
  "probe_id": "scout_001",
  "transform_id": "aggregate_pushdown",
  "family": "C",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-aggregating fact tables by join keys (item_sk, promo_sk, date_sk) before joining with dimensions reduces row count entering joins while preserving output semantics.",
  "reasoning_trace": [
    "Each CTE (ssr, csr, wsr) performs aggregation after joining fact with multiple dimensions",
    "Fact tables (store_sales, catalog_sales, web_sales) are scanned with index scans but nested loops cause performance issues",
    "Pushing aggregation down to fact tables on join keys reduces rows flowing into dimension joins",
    "Grouping keys align with downstream join keys ensuring semantic preservation"
  ],
  "target_ir": "Each fact table is pre-aggregated on its join keys before dimension joins; final aggregation remains unchanged.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["wsr", "ssr", "csr"],
        "outputs": ["channel", "id", "sales", "returns", "profit"],
        "changed": false
      },
      {
        "node_id": "ssr",
        "parent_node_id": "final_select",
        "sources": ["store_sales_preagg", "store_returns", "date_dim", "store", "item", "promotion"],
        "outputs": ["store_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS returns, SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_item_sk, ss_promo_sk, ss_sold_date_sk, ss_store_sk, SUM(ss_ext_sales_price) AS ss_ext_sales_price, SUM(ss_net_profit) AS ss_net_profit FROM store_sales WHERE ss_wholesale_cost BETWEEN 21 AND 36 GROUP BY ss_item_sk, ss_promo_sk, ss_sold_date_sk, ss_store_sk) AS store_sales_preagg LEFT OUTER JOIN store_returns ON (store_sales_preagg.ss_item_sk = sr_item_sk AND store_sales_preagg.ss_ticket_number = sr_ticket_number), date_dim, store, item, promotion WHERE store_sales_preagg.ss_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1999-10-21' AS date) AND CAST('1999-10-21' AS date) + INTERVAL '30 day' AND store_sales_preagg.ss_store_sk = s_store_sk AND store_sales_preagg.ss_item_sk = i_item_sk AND i_current_price > 50 AND store_sales_preagg.ss_promo_sk = p_promo_sk AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY s_store_id"
      },
      {
        "node_id": "csr",
        "parent_node_id": "final_select",
        "sources": ["catalog_sales_preagg", "catalog_returns", "date_dim", "catalog_page", "item", "promotion"],
        "outputs": ["catalog_page_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS returns, SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_item_sk, cs_promo_sk, cs_sold_date_sk, cs_catalog_page_sk, SUM(cs_ext_sales_price) AS cs_ext_sales_price, SUM(cs_net_profit) AS cs_net_profit FROM catalog_sales WHERE cs_wholesale_cost BETWEEN 21 AND 36 GROUP BY cs_item_sk, cs_promo_sk, cs_sold_date_sk, cs_catalog_page_sk) AS catalog_sales_preagg LEFT OUTER JOIN catalog_returns ON (catalog_sales_preagg.cs_item_sk = cr_item_sk AND catalog_sales_preagg.cs_order_number = cr_order_number), date_dim, catalog_page, item, promotion WHERE catalog_sales_preagg.cs_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1999-10-21' AS date) AND CAST('1999-10-21' AS date) + INTERVAL '30 day' AND catalog_sales_preagg.cs_catalog_page_sk = cp_catalog_page_sk AND catalog_sales_preagg.cs_item_sk = i_item_sk AND i_current_price > 50 AND catalog_sales_preagg.cs_promo_sk = p_promo_sk AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY cp_catalog_page_id"
      },
      {
        "node_id": "wsr",
        "parent_node_id": "final_select",
        "sources": ["web_sales_preagg", "web_returns", "date_dim", "web_site", "item", "promotion"],
        "outputs": ["web_site_id", "sales", "returns", "profit"],
        "changed": true,
        "sql": "SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS returns, SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_item_sk, ws_promo_sk, ws_sold_date_sk, ws_web_site_sk, SUM(ws_ext_sales_price) AS ws_ext_sales_price, SUM(ws_net_profit) AS ws_net_profit FROM web_sales WHERE ws_wholesale_cost BETWEEN 21 AND 36 GROUP BY ws_item_sk, ws_promo_sk, ws_sold_date_sk, ws_web_site_sk) AS web_sales_preagg LEFT OUTER JOIN web_returns ON (web_sales_preagg.ws_item_sk = wr_item_sk AND web_sales_preagg.ws_order_number = wr_order_number), date_dim, web_site, item, promotion WHERE web_sales_preagg.ws_sold_date_sk = d_date_sk AND d_date BETWEEN CAST('1999-10-21' AS date) AND CAST('1999-10-21' AS date) + INTERVAL '30 day' AND web_sales_preagg.ws_web_site_sk = web_site_sk AND web_sales_preagg.ws_item_sk = i_item_sk AND i_current_price > 50 AND web_sales_preagg.ws_promo_sk = p_promo_sk AND p_channel_email = 'Y' AND p_channel_tv = 'N' AND p_channel_radio = 'N' AND p_channel_press = 'N' AND p_channel_event = 'N' AND i_category IN ('Men', 'Music') GROUP BY web_site_id"
      }
    ]
  }
}