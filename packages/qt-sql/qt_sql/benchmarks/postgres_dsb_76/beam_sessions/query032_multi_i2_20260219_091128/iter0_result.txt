{
  "iteration": 0,
  "n_api_calls": 5,
  "beam_cost_usd": 0.01307778,
  "beam_cost_priced_calls": 2,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 29517,
    "completion_tokens": 13485,
    "total_tokens": 43002,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 11294
  },
  "best_speedup": 676.09,
  "best_patch_id": "p06",
  "best_sql": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71)), filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day'), filtered_catalog_sales AS (SELECT cs_item_sk, cs_sold_date_sk, cs_ext_discount_amt FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM filtered_date)), threshold AS (SELECT 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 115 AND 144 AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM filtered_catalog_sales cs JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_date d ON d.d_date_sk = cs.cs_sold_date_sk WHERE cs.cs_ext_discount_amt > (SELECT threshold FROM threshold) ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
  "patches": [
    {
      "patch_id": "p07",
      "family": "E",
      "transform": "pg_self_join_decomposition",
      "relevance_score": 0.65,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "correctness_verified": false,
      "error": "Retry failed: Missing SQL for tree node `main_query`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize the shared scan of catalog_sales and date_dim for the subquery into a CTE, reuse for main query and threshold computation."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.6,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "canceling statement due to statement timeout\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_date BETWEEN '2001-02-23' AND cast('2001-02-23' as date) + interval '90 day'\n)\nselect  sum(cs_ext_discount_amt)  as \"excess discount amount\"\nfrom\n   catalog_sales\n   JOIN item ON i_item_sk = cs_item_sk\n   JOIN filtered_date_dim ON d_date_sk = cs_sold_date_sk\nwhere\n(i_manufact_id in (184, 307, 365, 560, 681)\nor i_manager_id BETWEEN 42 and 71)\nand cs_ext_discount_amt\n     > (\n         select\n            1.3 * avg(cs_ext_discount_amt)\n         from\n            catalog_sales\n           ,date_dim\n         where\n              cs_item_sk = i_item_sk\n          and d_date between '2001-02-23' and\n                             cast('2001-02-23' as date) + interval '90 day'\n          and d_date_sk = cs_sold_date_sk\n          and cs_list_price between 115 and 144\n          and cs_sales_price / cs_list_price BETWEEN 21 * 0.01 AND 41 * 0.01\n      )\norder by sum(cs_ext_discount_amt)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered date_dim into a CTE, convert comma joins to explicit JOIN syntax, and join with catalog_sales and item."
    },
    {
      "patch_id": "p02",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.85,
      "status": "WIN",
      "speedup": 102.01,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2940.8,
      "output_sql": "WITH item_prefilter AS (SELECT i_item_sk FROM item WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71)), date_prefilter AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day'), avg_discount_by_item AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN date_prefilter d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 115 AND 144 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 0.21 AND 0.41 GROUP BY cs_item_sk), main_query AS (SELECT cs.cs_ext_discount_amt FROM catalog_sales cs JOIN item_prefilter i ON cs.cs_item_sk = i.i_item_sk JOIN date_prefilter d ON cs.cs_sold_date_sk = d.d_date_sk JOIN avg_discount_by_item avg ON cs.cs_item_sk = avg.cs_item_sk WHERE cs.cs_ext_discount_amt > avg.threshold) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM main_query ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter date_dim and catalog_sales for the subquery into a CTE, compute per-item threshold, then join in main query. Also pre-filter item table for OR condition into a CTE."
    },
    {
      "patch_id": "p06",
      "family": "F",
      "transform": "materialized_dimension_fact_prefilter",
      "relevance_score": 0.75,
      "status": "WIN",
      "speedup": 676.09,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 443.7,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71)), filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day'), filtered_catalog_sales AS (SELECT cs_item_sk, cs_sold_date_sk, cs_ext_discount_amt FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM filtered_date)), threshold AS (SELECT 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 115 AND 144 AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM filtered_catalog_sales cs JOIN filtered_item i ON i.i_item_sk = cs.cs_item_sk JOIN filtered_date d ON d.d_date_sk = cs.cs_sold_date_sk WHERE cs.cs_ext_discount_amt > (SELECT threshold FROM threshold) ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Materialize filtered item and date_dim into CTEs, also pre-filter catalog_sales for the date range into a CTE, then perform the non-equi join (cs_ext_discount_amt > threshold) with precomputed threshold CTE."
    },
    {
      "patch_id": "p05",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.58,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "canceling statement due to statement timeout\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH item_prefetch AS (SELECT i_item_sk FROM item WHERE i_manufact_id IN (184,307,365,560,681) OR i_manager_id BETWEEN 42 AND 71), date_prefetch AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2001-02-23' AND cast('2001-02-23' as date) + interval '90 day') SELECT sum(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN item_prefetch ON catalog_sales.cs_item_sk = item_prefetch.i_item_sk JOIN date_prefetch ON catalog_sales.cs_sold_date_sk = date_prefetch.d_date_sk WHERE cs_ext_discount_amt > (SELECT 1.3 * avg(cs_ext_discount_amt) FROM catalog_sales cs2 JOIN date_prefetch dp2 ON cs2.cs_sold_date_sk = dp2.d_date_sk WHERE cs2.cs_item_sk = item_prefetch.i_item_sk AND cs2.cs_list_price BETWEEN 115 AND 144 AND cs2.cs_sales_price / cs2.cs_list_price BETWEEN 21 * 0.01 AND 41 * 0.01) ORDER BY sum(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Pre-filter both item and date_dim into separate CTEs, then join with catalog_sales using explicit JOIN syntax."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.92,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "correctness_verified": false,
      "error": "Retry failed: Missing SQL for tree node `catalog_sales`",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": null,
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Replace correlated scalar subquery with a MATERIALIZED CTE that precomputes 1.3 * avg(cs_ext_discount_amt) per i_item_sk for the date range and list price filters, then join as a regular column."
    },
    {
      "patch_id": "p03",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.55,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "canceling statement due to statement timeout\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select  sum(cs_ext_discount_amt)  as \"excess discount amount\"\nfrom\n   catalog_sales\n   ,item\n   ,date_dim\nwhere\n(i_manufact_id in (184, 307, 365, 560, 681)\nor i_manager_id BETWEEN 42 and 71)\nand i_item_sk = cs_item_sk\nand d_date between '2001-02-23' and\n        cast('2001-02-23' as date) + interval '90 day'\nand d_date_sk = cs_sold_date_sk\nand cs_ext_discount_amt\n     > (\n         select\n            1.3 * avg(cs_ext_discount_amt)\n         from\n            catalog_sales\n           ,date_dim\n         where\n              cs_item_sk = i_item_sk\n          and d_date between '2001-02-23' and\n                             cast('2001-02-23' as date) + interval '90 day'\n          and d_date_sk = cs_sold_date_sk\n          and cs_list_price between 115 and 144\n          and cs_sales_price / cs_list_price BETWEEN 21 * 0.01 AND 41 * 0.01\n      )\norder by sum(cs_ext_discount_amt)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Split OR condition on item into two UNION ALL branches: one for i_manufact_id IN, one for i_manager_id BETWEEN. Use UNION ALL with same join structure."
    },
    {
      "patch_id": "p08",
      "family": "B",
      "transform": "decorrelate",
      "relevance_score": 0.5,
      "status": "WIN",
      "speedup": 152.65,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1965.3,
      "output_sql": "WITH avg_discount_threshold AS (SELECT cs_item_sk AS i_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 115 AND 144 AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41 GROUP BY cs_item_sk) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk JOIN avg_discount_threshold ON avg_discount_threshold.i_item_sk = item.i_item_sk WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71) AND d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_ext_discount_amt > avg_discount_threshold.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Convert correlated subquery to a standalone CTE with GROUP BY i_item_sk, then join in main query. Simpler decorrelation without MATERIALIZED hint."
    },
    {
      "patch_id": "compile_p08",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 116.99,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2564.3,
      "output_sql": "WITH avg_discount_threshold AS (SELECT cs_item_sk AS i_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 115 AND 144 AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41 GROUP BY cs_item_sk) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk JOIN avg_discount_threshold ON avg_discount_threshold.i_item_sk = item.i_item_sk WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71) AND d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_ext_discount_amt > avg_discount_threshold.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p02",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 163.89,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1830.5,
      "output_sql": "WITH item_prefilter AS (SELECT i_item_sk FROM item WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71)), date_prefilter AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day'), avg_discount_by_item AS (SELECT cs_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales cs JOIN date_prefilter d ON cs.cs_sold_date_sk = d.d_date_sk WHERE cs.cs_list_price BETWEEN 115 AND 144 AND cs.cs_sales_price / cs.cs_list_price BETWEEN 0.21 AND 0.41 GROUP BY cs_item_sk), main_query AS (SELECT cs.cs_ext_discount_amt FROM catalog_sales cs JOIN item_prefilter i ON cs.cs_item_sk = i.i_item_sk JOIN date_prefilter d ON cs.cs_sold_date_sk = d.d_date_sk JOIN avg_discount_by_item avg ON cs.cs_item_sk = avg.cs_item_sk WHERE cs.cs_ext_discount_amt > avg.threshold) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM main_query ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p08",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 130.02,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2307.4,
      "output_sql": "WITH avg_discount_threshold AS (SELECT cs_item_sk AS i_item_sk, 1.3 * AVG(cs_ext_discount_amt) AS threshold FROM catalog_sales JOIN date_dim ON d_date_sk = cs_sold_date_sk WHERE d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_list_price BETWEEN 115 AND 144 AND cs_sales_price / cs_list_price BETWEEN 0.21 AND 0.41 GROUP BY cs_item_sk) SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM catalog_sales JOIN item ON i_item_sk = cs_item_sk JOIN date_dim ON d_date_sk = cs_sold_date_sk JOIN avg_discount_threshold ON avg_discount_threshold.i_item_sk = item.i_item_sk WHERE (i_manufact_id IN (184, 307, 365, 560, 681) OR i_manager_id BETWEEN 42 AND 71) AND d_date BETWEEN '2001-02-23' AND CAST('2001-02-23' AS DATE) + INTERVAL '90 day' AND cs_ext_discount_amt > avg_discount_threshold.threshold ORDER BY SUM(cs_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p02": "Limit  (cost=99186.95..99186.96 rows=1 width=32) (actual time=1982.110..1982.114 rows=1 loops=1)\n  CTE date_prefilter\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1698.26 rows=91 width=4) (actual time=0.404..0.979 rows=91 loops=1)\n          Index Cond: ((d_date >= '2001-02-23'::date) AND (d_date <= '2001-05-24 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=97488.70..97488.70 rows=1 width=32) (actual time=1982.109..1982.112 rows=1 loops=1)\n ",
    "p06": "Limit  (cost=143003.00..143003.00 rows=1 width=32) (actual time=344.884..344.945 rows=1 loops=1)\n  CTE filtered_date\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1698.26 rows=91 width=4) (actual time=0.380..0.892 rows=91 loops=1)\n          Index Cond: ((d_date >= '2001-02-23'::date) AND (d_date <= '2001-05-24 00:00:00'::timestamp without time zone))\n  InitPlan 2 (returns $3)\n    ->  Finalize Aggregate  (cost=55497.99..55498.01 rows=1 width=32) (actual ",
    "p08": "Limit  (cost=55829.08..55829.08 rows=1 width=32) (actual time=2031.942..2032.007 rows=1 loops=1)\n  ->  Sort  (cost=55829.08..55829.08 rows=1 width=32) (actual time=2031.941..2032.004 rows=1 loops=1)\n        Sort Key: (sum(catalog_sales.cs_ext_discount_amt))\n        Sort Method: quicksort  Memory: 25kB\n        ->  Aggregate  (cost=55829.06..55829.07 rows=1 width=32) (actual time=2031.936..2032.000 rows=1 loops=1)\n              ->  Nested Loop  (cost=55498.95..55829.05 rows=1 width=6) (actual time",
    "compile_p08": "Limit  (cost=55829.08..55829.08 rows=1 width=32) (actual time=2166.892..2166.960 rows=1 loops=1)\n  ->  Sort  (cost=55829.08..55829.08 rows=1 width=32) (actual time=2166.891..2166.958 rows=1 loops=1)\n        Sort Key: (sum(catalog_sales.cs_ext_discount_amt))\n        Sort Method: quicksort  Memory: 25kB\n        ->  Aggregate  (cost=55829.06..55829.07 rows=1 width=32) (actual time=2166.886..2166.953 rows=1 loops=1)\n              ->  Nested Loop  (cost=55498.95..55829.05 rows=1 width=6) (actual time",
    "compile_p02": "Limit  (cost=99186.95..99186.96 rows=1 width=32) (actual time=2182.425..2182.430 rows=1 loops=1)\n  CTE date_prefilter\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1698.26 rows=91 width=4) (actual time=0.477..1.095 rows=91 loops=1)\n          Index Cond: ((d_date >= '2001-02-23'::date) AND (d_date <= '2001-05-24 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=97488.70..97488.70 rows=1 width=32) (actual time=2182.424..2182.427 rows=1 loops=1)\n "
  }
}