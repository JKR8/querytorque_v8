{
  "probe_id": "p04",
  "transform_id": "dimension_prefetch_star",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Prefetching filtered date_dim and customer dimensions into CTEs reduces repeated scans and enables efficient hash joins.",
  "reasoning_trace": [
    "Three repeated scans of date_dim (183 rows each) are replaced by one scan in a CTE.",
    "Customer table is also filtered once and reused across all three fact-table branches.",
    "Explicit JOIN syntax improves readability and may help the optimizer make better decisions."
  ],
  "target_ir": "Two new CTEs (filtered_date, filtered_customer) are introduced; each fact-table branch now joins to these CTEs instead of scanning base tables repeatedly.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["*"],
        "changed": true,
        "sql": "WITH filtered_date AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1200 AND 1200 + 11\n),\nfiltered_customer AS (\n  SELECT c_customer_sk, c_first_name, c_last_name\n  FROM customer\n  WHERE c_birth_month IN (1, 2, 5, 12)\n)\nSELECT COUNT(*)\nFROM (\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM store_sales\n  JOIN filtered_date fd ON store_sales.ss_sold_date_sk = fd.d_date_sk\n  JOIN filtered_customer fc ON store_sales.ss_customer_sk = fc.c_customer_sk\n  WHERE ss_list_price BETWEEN 193 AND 252\n    AND ss_wholesale_cost BETWEEN 35 AND 55\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM catalog_sales\n  JOIN filtered_date fd ON catalog_sales.cs_sold_date_sk = fd.d_date_sk\n  JOIN filtered_customer fc ON catalog_sales.cs_bill_customer_sk = fc.c_customer_sk\n  WHERE cs_list_price BETWEEN 193 AND 252\n    AND cs_wholesale_cost BETWEEN 35 AND 55\n  INTERSECT\n  SELECT DISTINCT c_last_name, c_first_name, d_date\n  FROM web_sales\n  JOIN filtered_date fd ON web_sales.ws_sold_date_sk = fd.d_date_sk\n  JOIN filtered_customer fc ON web_sales.ws_bill_customer_sk = fc.c_customer_sk\n  WHERE ws_list_price BETWEEN 193 AND 252\n    AND ws_wholesale_cost BETWEEN 35 AND 55\n) hot_cust\nLIMIT 100"
      }
    ]
  }
}