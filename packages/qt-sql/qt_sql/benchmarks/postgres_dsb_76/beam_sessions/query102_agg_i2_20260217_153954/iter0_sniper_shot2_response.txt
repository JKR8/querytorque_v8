[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01,p11",
    "strategy": "Explicit JOINs + selective dimension CTEs",
    "hypothesis": "Original plan shows nested loops re-executing customer scans 27K times. Converting comma joins to explicit INNER JOINs helps optimizer reorder joins. Adding filtered CTEs for date_dim (d1), item, and customer_address reduces row amplification by pushing filters early.",
    "target_ir": "Explicit JOIN topology with pre-filtered dimension CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date_dim_d1",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_item",
          "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Men', 'Shoes', 'Sports') AND i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98)"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_customer_address",
          "cte_query_sql": "SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM store_sales INNER JOIN web_sales ON store_sales.ss_item_sk = web_sales.ws_item_sk INNER JOIN filtered_date_dim_d1 AS d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk INNER JOIN date_dim AS d2 ON web_sales.ws_sold_date_sk = d2.d_date_sk INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk AND web_sales.ws_bill_customer_sk = customer.c_customer_sk INNER JOIN inventory ON inventory.inv_item_sk = store_sales.ss_item_sk AND inventory.inv_date_sk = store_sales.ss_sold_date_sk INNER JOIN store ON store.s_state = warehouse.w_state INNER JOIN warehouse ON web_sales.ws_warehouse_sk = warehouse.w_warehouse_sk INNER JOIN filtered_item AS i ON store_sales.ss_item_sk = i.i_item_sk INNER JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk INNER JOIN household_demographics ON customer.c_current_hdemo_sk = household_demographics.hd_demo_sk INNER JOIN filtered_customer_address AS ca ON customer.c_current_addr_sk = ca.ca_address_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') AND inventory.inv_quantity_on_hand >= store_sales.ss_quantity AND web_sales.ws_wholesale_cost BETWEEN 76 AND 96 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "p03,p07",
    "strategy": "Customer dimension consolidation + date isolation",
    "hypothesis": "Nested loops on customer/customer_demographics (25K scans) indicate late filtering. Pre-joining customer with demographics/address into a CTE reduces re-execution. Isolating date_dim d1 filter avoids full scan and helps date range predicate.",
    "target_ir": "CTE-joined customer dimensions + filtered date_dim CTE",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_customer_dims",
          "cte_query_sql": "SELECT c_customer_sk, cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count FROM customer JOIN customer_demographics ON customer.c_current_cdemo_sk = customer_demographics.cd_demo_sk JOIN household_demographics ON customer.c_current_hdemo_sk = household_demographics.hd_demo_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk WHERE customer_address.ca_state IN ('AR', 'CA', 'KS', 'NY', 'VA')"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date_dim_d1",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1998"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count, COUNT(*) AS cnt FROM store_sales INNER JOIN web_sales ON store_sales.ss_item_sk = web_sales.ws_item_sk INNER JOIN filtered_date_dim_d1 AS d1 ON store_sales.ss_sold_date_sk = d1.d_date_sk INNER JOIN date_dim AS d2 ON web_sales.ws_sold_date_sk = d2.d_date_sk INNER JOIN filtered_customer_dims AS c ON store_sales.ss_customer_sk = c.c_customer_sk AND web_sales.ws_bill_customer_sk = c.c_customer_sk INNER JOIN inventory ON inventory.inv_item_sk = store_sales.ss_item_sk AND inventory.inv_date_sk = store_sales.ss_sold_date_sk INNER JOIN store ON store.s_state = warehouse.w_state INNER JOIN warehouse ON web_sales.ws_warehouse_sk = warehouse.w_warehouse_sk INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '30 DAY') AND inventory.inv_quantity_on_hand >= store_sales.ss_quantity AND item.i_category IN ('Men', 'Shoes', 'Sports') AND item.i_manager_id IN (6, 11, 16, 17, 19, 28, 47, 82, 88, 98) AND web_sales.ws_wholesale_cost BETWEEN 76 AND 96 GROUP BY cd_gender, cd_marital_status, cd_education_status, hd_vehicle_count ORDER BY cnt"
        }
      }
    ]
  }
]