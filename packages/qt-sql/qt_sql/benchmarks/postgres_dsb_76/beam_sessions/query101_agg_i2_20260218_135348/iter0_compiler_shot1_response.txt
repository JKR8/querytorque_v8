[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "original",
    "strategy": "Explicit JOIN syntax to enable better join reordering and predicate pushdown.",
    "hypothesis": "Original comma-join shape prevents optimal join ordering, causing large fact scans before selective dimension filters. Converting to explicit INNER JOINs gives the optimizer more freedom without introducing CTE fences.",
    "expected_explain_delta": "Nested loop chain replaced with hash joins; selective dimension filters applied earlier; reduced rows flowing into fact joins.",
    "target_ir": "Change final_select to use explicit INNER JOINs instead of comma joins.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store_returns", "web_sales", "date_dim d1", "date_dim d2", "item", "customer", "customer_address", "household_demographics"],
          "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM store_sales ss INNER JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN date_dim d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN date_dim d2 ON ws.ws_sold_date_sk = d2.d_date_sk INNER JOIN item i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE d1.d_year = 2000 AND d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') AND i.i_category IN ('Children', 'Home', 'Women') AND ca.ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA') AND hd.hd_income_band_sk BETWEEN 8 AND 14 AND hd.hd_buy_potential = '501-1000' AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.45,
    "based_on": "original",
    "strategy": "Pre-filter selective dimensions into subqueries to reduce rows before fact joins, while keeping explicit JOIN syntax.",
    "hypothesis": "Residual gap: dimension filters applied late in original plan. Pre-filtering dimensions in derived tables may improve cardinality estimates and reduce fact-table scan volume, but avoids CTE materialization fences.",
    "expected_explain_delta": "Dimension tables become small hash tables; fact joins start with filtered keys; reduced nested loop iterations.",
    "target_ir": "Rewrite final_select with inline derived tables for selective dimensions.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store_returns", "web_sales", "d1_filtered", "d2_filtered", "item_filtered", "customer", "ca_filtered", "hd_filtered"],
          "outputs": ["c_customer_sk", "c_first_name", "c_last_name", "cnt"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, COUNT(*) AS cnt FROM store_sales ss INNER JOIN store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk INNER JOIN web_sales ws ON ss.ss_customer_sk = ws.ws_bill_customer_sk AND sr.sr_item_sk = ws.ws_item_sk INNER JOIN (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000) d1 ON sr.sr_returned_date_sk = d1.d_date_sk INNER JOIN (SELECT d_date_sk, d_date FROM date_dim) d2 ON ws.ws_sold_date_sk = d2.d_date_sk INNER JOIN (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women')) i ON i.i_item_sk = ss.ss_item_sk INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk INNER JOIN (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('AR', 'GA', 'IN', 'KY', 'VA')) ca ON c.c_current_addr_sk = ca.ca_address_sk INNER JOIN (SELECT hd_demo_sk FROM household_demographics WHERE hd_income_band_sk BETWEEN 8 AND 14 AND hd_buy_potential = '501-1000') hd ON c.c_current_hdemo_sk = hd.hd_demo_sk WHERE d2.d_date BETWEEN d1.d_date AND (d1.d_date + INTERVAL '90 day') AND ss.ss_sales_price / ss.ss_list_price BETWEEN 76 * 0.01 AND 96 * 0.01 GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name ORDER BY cnt"
        }
      ]
    }
  }
]