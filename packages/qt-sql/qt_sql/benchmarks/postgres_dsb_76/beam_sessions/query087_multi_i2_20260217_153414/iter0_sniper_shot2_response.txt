[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "family": "A",
    "transform": "shared_dimension_explicit_join",
    "hypothesis": "Original plan shows repeated scans of date_dim and customer tables (3x each) with nested loops. Prefiltering these into CTEs and using explicit JOIN syntax should eliminate redundant scans and improve join efficiency. EXPLAIN should show reduced nested loops and faster dimension access.",
    "target_ir": "Main query wrapped with filtered_date and filtered_customer CTEs, with explicit JOINs replacing comma joins in all three subqueries",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1213+11"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_customer",
          "cte_query_sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT count(*) FROM ((SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk WHERE ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk WHERE cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86)) AS cool_cust"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "family": "D",
    "transform": "not_exists_rewrite",
    "hypothesis": "SetOp in original plan consumes 17s. Replacing EXCEPT with NOT EXISTS anti-joins could avoid materialization costs. Prefiltered CTEs prevent redundant scans. EXPLAIN should show hash anti-joins instead of SetOp with reduced execution time.",
    "target_ir": "Three CTEs for sales channels with shared dimensions, main query uses NOT EXISTS anti-joins",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_date",
          "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_month_seq BETWEEN 1213 AND 1213+11"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_customer",
          "cte_query_sql": "SELECT c_customer_sk, c_last_name, c_first_name FROM customer WHERE c_birth_year BETWEEN 1968 AND 1974"
        }
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "store_results",
          "cte_query_sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk WHERE ss_list_price BETWEEN 168 AND 197 AND ss_wholesale_cost BETWEEN 76 AND 86"
        }
      },
      {
        "step_id": "s4",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "catalog_results",
          "cte_query_sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk WHERE cs_list_price BETWEEN 168 AND 197 AND cs_wholesale_cost BETWEEN 76 AND 86"
        }
      },
      {
        "step_id": "s5",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "web_results",
          "cte_query_sql": "SELECT DISTINCT c_last_name, c_first_name, d_date FROM web_sales JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86"
        }
      },
      {
        "step_id": "s6",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT count(*) FROM store_results sr WHERE NOT EXISTS (SELECT 1 FROM catalog_results cr WHERE cr.c_last_name = sr.c_last_name AND cr.c_first_name = sr.c_first_name AND cr.d_date = sr.d_date) AND NOT EXISTS (SELECT 1 FROM web_results wr WHERE wr.c_last_name = sr.c_last_name AND wr.c_first_name = sr.c_first_name AND wr.d_date = sr.d_date)"
        }
      }
    ]
  }
]