{
  "probe_id": "p01",
  "transform_id": "early_filter",
  "family": "A",
  "dialect": "postgres",
  "hypothesis": "Pre-filter web_sales with list_price and wholesale_cost conditions in a CTE to reduce input rows and enable earlier index usage.",
  "reasoning_trace": [
    "web_sales is scanned repeatedly with identical filters in each branch of the set operation",
    "Creating a prefiltered CTE reduces redundant scans and allows index-based filtering early"
  ],
  "target_ir": "CTE ws_prefilter added to encapsulate filtered web_sales; main query FROM clause updated to use it",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ws_prefilter",
        "cte_query_sql": "SELECT * FROM web_sales WHERE ws_list_price BETWEEN 168 AND 197 AND ws_wholesale_cost BETWEEN 76 AND 86"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "(SELECT DISTINCT c_last_name, c_first_name, d_date FROM store_sales, date_dim, customer WHERE store_sales.ss_sold_date_sk = date_dim.d_date_sk AND store_sales.ss_customer_sk = customer.c_customer_sk AND d_month_seq BETWEEN 1213 AND 1213+11 AND ss_list_price BETWEEN 168 AND 197 AND c_birth_year BETWEEN 1968 AND 1974 AND ss_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM catalog_sales, date_dim, customer WHERE catalog_sales.cs_sold_date_sk = date_dim.d_date_sk AND catalog_sales.cs_bill_customer_sk = customer.c_customer_sk AND d_month_seq BETWEEN 1213 AND 1213+11 AND cs_list_price BETWEEN 168 AND 197 AND c_birth_year BETWEEN 1968 AND 1974 AND cs_wholesale_cost BETWEEN 76 AND 86) EXCEPT (SELECT DISTINCT c_last_name, c_first_name, d_date FROM ws_prefilter, date_dim, customer WHERE ws_prefilter.ws_sold_date_sk = date_dim.d_date_sk AND ws_prefilter.ws_bill_customer_sk = customer.c_customer_sk AND d_month_seq BETWEEN 1213 AND 1213+11 AND c_birth_year BETWEEN 1968 AND 1974)"
      }
    }
  ]
}