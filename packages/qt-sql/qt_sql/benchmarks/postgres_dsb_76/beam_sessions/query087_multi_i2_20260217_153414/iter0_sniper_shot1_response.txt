[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "original",
    "strategy": "Pre-filter dimensions via CTEs + explicit JOIN syntax",
    "hypothesis": "Repeated scans of date_dim/customer cause nested loop amplification. Pre-filtering dimensions and using explicit JOINs should reduce row estimates and enable better join orders. CTE materialization acceptable due to small filtered dimensions.",
    "target_ir": "CTEs for filtered date_dim/customer; explicit JOINs replacing comma joins in all three EXCEPT branches",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date_dim AS (\n  SELECT d_date_sk, d_date\n  FROM date_dim\n  WHERE d_month_seq BETWEEN 1213 AND 1213+11\n),\nfiltered_customer AS (\n  SELECT c_customer_sk, c_last_name, c_first_name\n  FROM customer\n  WHERE c_birth_year BETWEEN 1968 AND 1974\n)\nSELECT count(*)\nFROM (\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM store_sales\n    JOIN filtered_date_dim ON store_sales.ss_sold_date_sk = filtered_date_dim.d_date_sk\n    JOIN filtered_customer ON store_sales.ss_customer_sk = filtered_customer.c_customer_sk\n    WHERE ss_list_price BETWEEN 168 AND 197\n      AND ss_wholesale_cost BETWEEN 76 AND 86\n  )\n  EXCEPT\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM catalog_sales\n    JOIN filtered_date_dim ON catalog_sales.cs_sold_date_sk = filtered_date_dim.d_date_sk\n    JOIN filtered_customer ON catalog_sales.cs_bill_customer_sk = filtered_customer.c_customer_sk\n    WHERE cs_list_price BETWEEN 168 AND 197\n      AND cs_wholesale_cost BETWEEN 76 AND 86\n  )\n  EXCEPT\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM web_sales\n    JOIN filtered_date_dim ON web_sales.ws_sold_date_sk = filtered_date_dim.d_date_sk\n    JOIN filtered_customer ON web_sales.ws_bill_customer_sk = filtered_customer.c_customer_sk\n    WHERE ws_list_price BETWEEN 168 AND 197\n      AND ws_wholesale_cost BETWEEN 76 AND 86\n  )\n) cool_cust;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.78,
    "based_on": "original",
    "strategy": "Explicit JOIN syntax + fact filter pushdown",
    "hypothesis": "Comma joins cause poor row estimates. Converting to explicit JOINs with fact filters in ON clauses should improve join ordering and reduce nested loop amplification without CTE fences.",
    "target_ir": "Explicit INNER JOINs in all branches; fact filters moved to JOIN conditions",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "SELECT count(*)\nFROM (\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM store_sales\n    INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk \n      AND date_dim.d_month_seq BETWEEN 1213 AND 1213+11\n    INNER JOIN customer ON store_sales.ss_customer_sk = customer.c_customer_sk\n      AND customer.c_birth_year BETWEEN 1968 AND 1974\n    WHERE store_sales.ss_list_price BETWEEN 168 AND 197\n      AND store_sales.ss_wholesale_cost BETWEEN 76 AND 86\n  )\n  EXCEPT\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM catalog_sales\n    INNER JOIN date_dim ON catalog_sales.cs_sold_date_sk = date_dim.d_date_sk \n      AND date_dim.d_month_seq BETWEEN 1213 AND 1213+11\n    INNER JOIN customer ON catalog_sales.cs_bill_customer_sk = customer.c_customer_sk\n      AND customer.c_birth_year BETWEEN 1968 AND 1974\n    WHERE catalog_sales.cs_list_price BETWEEN 168 AND 197\n      AND catalog_sales.cs_wholesale_cost BETWEEN 76 AND 86\n  )\n  EXCEPT\n  (\n    SELECT DISTINCT c_last_name, c_first_name, d_date\n    FROM web_sales\n    INNER JOIN date_dim ON web_sales.ws_sold_date_sk = date_dim.d_date_sk \n      AND date_dim.d_month_seq BETWEEN 1213 AND 1213+11\n    INNER JOIN customer ON web_sales.ws_bill_customer_sk = customer.c_customer_sk\n      AND customer.c_birth_year BETWEEN 1968 AND 1974\n    WHERE web_sales.ws_list_price BETWEEN 168 AND 197\n      AND web_sales.ws_wholesale_cost BETWEEN 76 AND 86\n  )\n) cool_cust;"
        }
      }
    ]
  }
]