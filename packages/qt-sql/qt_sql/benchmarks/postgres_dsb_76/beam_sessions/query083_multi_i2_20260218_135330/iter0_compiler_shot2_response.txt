[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Pre-filter date_dim via CTE, convert comma joins to explicit INNER JOIN, maintain three independent channel CTEs.",
    "hypothesis": "WIN probe p01 (14.99x) addresses primary hotspot: sequential scan of date_dim (36k rows). By pre-filtering date_dim to 4 target dates via CTE, the planner can use a tiny hash table instead of full scan, and explicit join syntax helps cardinality estimation.",
    "expected_explain_delta": "Seq Scan on date_dim replaced by CTE scan; nested loops with index scans on fact tables become hash joins with small dimension set.",
    "target_ir": "Add date_filter CTE inside each channel CTE, change sr_items/cr_items/wr_items to explicit INNER JOIN, update final_select to explicit INNER JOIN.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["sr_items", "cr_items", "wr_items"],
          "outputs": ["item_id", "sr_item_qty", "sr_dev", "cr_item_qty", "cr_dev", "wr_item_qty", "wr_dev", "average"],
          "changed": true,
          "sql": "SELECT sr_items.item_id, sr_item_qty, sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS wr_dev, (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average FROM sr_items INNER JOIN cr_items ON sr_items.item_id = cr_items.item_id INNER JOIN wr_items ON sr_items.item_id = wr_items.item_id ORDER BY sr_items.item_id, sr_item_qty LIMIT 100"
        },
        {
          "node_id": "sr_items",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "item", "date_dim"],
          "outputs": ["item_id", "sr_item_qty"],
          "changed": true,
          "sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')) SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM store_returns INNER JOIN item ON sr_item_sk = i_item_sk INNER JOIN date_filter ON sr_returned_date_sk = date_filter.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND sr_return_amt / sr_return_quantity BETWEEN 253 AND 282 AND sr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id"
        },
        {
          "node_id": "cr_items",
          "parent_node_id": "final_select",
          "sources": ["catalog_returns", "item", "date_dim"],
          "outputs": ["item_id", "cr_item_qty"],
          "changed": true,
          "sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')) SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM catalog_returns INNER JOIN item ON cr_item_sk = i_item_sk INNER JOIN date_filter ON cr_returned_date_sk = date_filter.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND cr_return_amount / cr_return_quantity BETWEEN 253 AND 282 AND cr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id"
        },
        {
          "node_id": "wr_items",
          "parent_node_id": "final_select",
          "sources": ["web_returns", "item", "date_dim"],
          "outputs": ["item_id", "wr_item_qty"],
          "changed": true,
          "sql": "WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_date IN ('1999-01-10','1999-06-17','1999-08-04','1999-11-05')) SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM web_returns INNER JOIN item ON wr_item_sk = i_item_sk INNER JOIN date_filter ON wr_returned_date_sk = date_filter.d_date_sk WHERE i_category IN ('Children', 'Electronics') AND i_manager_id BETWEEN 15 AND 24 AND wr_return_amt / wr_return_quantity BETWEEN 253 AND 282 AND wr_reason_sk IN (7, 18, 19, 22, 36) GROUP BY i_item_id"
        }
      ]
    }
  }
]