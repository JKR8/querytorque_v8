{
  "plan_id": "wildcard_postgres_early_filter_then_aggregate_by_store_sk",
  "dialect": "postgres",
  "description": "Pre-filter date dimensions and aggregate sales/returns by store_sk in CTEs to reduce sort/merge overhead. Combines explicit JOINs, selective filtering, and pre-aggregation.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_return_dates",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 7"
      },
      "description": "Insert CTE 'filtered_return_dates' for return date filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_sales_dates",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN (SELECT MIN(d_date) - INTERVAL '120 day' FROM filtered_return_dates) AND (SELECT MAX(d_date) FROM filtered_return_dates)"
      },
      "description": "Insert CTE 'filtered_sales_dates' for sales date range"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preaggregated_store_returns",
        "cte_query_sql": "SELECT sr_store_sk, sr_ticket_number, sr_item_sk, sr_customer_sk, sr_returned_date_sk FROM store_returns WHERE sr_returned_date_sk IN (SELECT d_date_sk FROM filtered_return_dates)"
      },
      "description": "Insert CTE 'preaggregated_store_returns' with early return date filter"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "preaggregated_store_sales",
        "cte_query_sql": "SELECT ss_store_sk, ss_ticket_number, ss_item_sk, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM filtered_sales_dates)"
      },
      "description": "Insert CTE 'preaggregated_store_sales' with early sales date filter"
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "preaggregated_store_sales AS ss JOIN preaggregated_store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN store ON ss.ss_store_sk = s_store_sk JOIN filtered_return_dates AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk JOIN filtered_sales_dates AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk"
      },
      "description": "Replace FROM clause with explicit JOINs using pre-filtered CTEs"
    },
    {
      "step_id": "s6",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "444f6473896f7965"
      },
      "payload": {
        "expr_sql": "TRUE"
      },
      "description": "Clear original WHERE clause since conditions are now in JOINs and CTEs"
    },
    {
      "step_id": "s7",
      "op": "replace_body",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "sql_fragment": "SELECT s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip, sum(case when (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 30 ) then 1 else 0 end) as \"30 days\", sum(case when (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 30) and (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 60) then 1 else 0 end ) as \"31-60 days\", sum(case when (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 60) and (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\", sum(case when (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 90) and (sr.sr_returned_date_sk - ss.ss_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\", sum(case when (sr.sr_returned_date_sk - ss.ss_sold_date_sk > 120) then 1 else 0 end) as \">120 days\" FROM preaggregated_store_sales AS ss JOIN preaggregated_store_returns AS sr ON ss.ss_ticket_number = sr.sr_ticket_number AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_customer_sk = sr.sr_customer_sk JOIN store ON ss.ss_store_sk = s_store_sk JOIN filtered_return_dates AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk JOIN filtered_sales_dates AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk WHERE TRUE GROUP BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip ORDER BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip LIMIT 100"
      },
      "description": "Replace entire query body with optimized version using pre-aggregated CTEs"
    }
  ]
}