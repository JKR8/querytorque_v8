[
  {
    "target_id": "t1",
    "family": "C",
    "transform": "aggregation_pushdown",
    "relevance_score": 0.95,
    "hypothesis": "Aggregation occurs after large joins with dimension table (store), carrying unnecessary columns. Push aggregation to store key before joining store attributes.",
    "target_ir": "S0 [SELECT]\n  CTE: pre_agg (via Q1)\n    SELECT\n      ss_store_sk,\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30) then 1 else 0 end) as \"30 days\",\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30 and sr_returned_date_sk - ss_sold_date_sk <= 60) then 1 else 0 end) as \"31-60 days\",\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60 and sr_returned_date_sk - ss_sold_date_sk <= 90) then 1 else 0 end) as \"61-90 days\",\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90 and sr_returned_date_sk - ss_sold_date_sk <= 120) then 1 else 0 end) as \"91-120 days\",\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk > 120) then 1 else 0 end) as \">120 days\"\n    FROM store_sales\n    JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk\n    JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk\n    JOIN date_dim d2 ON sr_returned_date_sk = d2.d_date_sk\n    WHERE d2.d_year = 1999 AND d2.d_moy = 7\n      AND d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date\n    GROUP BY ss_store_sk\n  MAIN QUERY (via Q0)\n    SELECT \n      s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number,\n      s_city, s_county, s_state, s_zip,\n      \"30 days\", \"31-60 days\", \"61-90 days\", \"91-120 days\", \">120 days\"\n    FROM pre_agg\n    JOIN store ON ss_store_sk = s_store_sk\n    ORDER BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip\n    LIMIT 100",
    "recommended_examples": [
      "pg_materialized_dimension_fact_prefilter"
    ]
  },
  {
    "target_id": "t2",
    "family": "A",
    "transform": "early_filtering",
    "relevance_score": 0.85,
    "hypothesis": "Date_dim d2 filter (d_year/d_moy) applied late. Prefilter d2 and propagate date range to d1 before joining facts.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_dates (via Q1)\n    SELECT \n      d2.d_date_sk as ret_date_sk,\n      d1.d_date_sk as sold_date_sk\n    FROM date_dim d2\n    JOIN date_dim d1 ON d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date\n    WHERE d2.d_year = 1999 AND d2.d_moy = 7\n  MAIN QUERY (via Q0)\n    SELECT \n      s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number,\n      s_city, s_county, s_state, s_zip,\n      sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30) then 1 else 0 end) as \"30 days\",\n      ... [other aggregates] ...\n    FROM store_sales\n    JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk\n    JOIN filtered_dates fd ON ss_sold_date_sk = fd.sold_date_sk AND sr_returned_date_sk = fd.ret_date_sk\n    JOIN store ON ss_store_sk = s_store_sk\n    GROUP BY s_store_name, s_company_id, s_street_number, s_street_name, s_street_type, s_suite_number, s_city, s_county, s_state, s_zip\n    ORDER BY ... [original order] ...\n    LIMIT 100",
    "recommended_examples": [
      "pg_date_cte_explicit_join"
    ]
  },
  {
    "target_id": "t3",
    "family": "F",
    "transform": "join_transform",
    "relevance_score": 0.75,
    "hypothesis": "Comma-join obscures join dependencies. Convert to explicit JOINs with filtered dimension tables first.",
    "target_ir": "S0 [SELECT]\n  MAIN QUERY (via Q0)\n    SELECT \n      s_store_name, s_company_id, ... [all store attributes] ...\n    FROM date_dim d2\n    JOIN store_returns ON sr_returned_date_sk = d2.d_date_sk\n    JOIN store_sales ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk\n    JOIN date_dim d1 ON ss_sold_date_sk = d1.d_date_sk\n    JOIN store ON ss_store_sk = s_store_sk\n    WHERE d2.d_year = 1999 AND d2.d_moy = 7\n      AND d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date\n    GROUP BY s_store_name, s_company_id, ... [all store attributes] ...\n    ORDER BY ... [original order] ...\n    LIMIT 100",
    "recommended_examples": [
      "pg_explicit_join_materialized"
    ]
  }
]