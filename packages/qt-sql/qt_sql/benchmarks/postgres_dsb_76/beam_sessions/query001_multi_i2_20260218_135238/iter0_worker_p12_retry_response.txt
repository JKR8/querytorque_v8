{
  "probe_id": "p12",
  "transform_id": "sf_shared_scan_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Shared-scan decorrelation can eliminate the correlated scalar subquery by computing per-store averages in a single CTE pass, avoiding re-execution.",
  "reasoning_trace": [
    "Correlated scalar subquery over CTE forces nested loop execution with high cost (262,448 ms).",
    "Shared scan decorrelation aligns with PostgreSQL's strength in window functions and avoids materialization penalties.",
    "New CTE computes both per-(customer,store,reason) totals and per-store averages in one pass.",
    "Final filter replaces subquery with window-based comparison, preserving row semantics."
  ],
  "target_ir": "Single CTE computes per-group aggregates and per-store averages; final select filters on window avg.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["decorrelated_returns", "store", "customer", "customer_demographics"],
        "outputs": ["c_customer_id"],
        "changed": true,
        "sql": "SELECT c.c_customer_id\nFROM decorrelated_returns dr\nJOIN store s ON s.s_store_sk = dr.ctr_store_sk\nJOIN customer c ON c.c_customer_sk = dr.ctr_customer_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\nWHERE dr.ctr_total_return > dr.avg_store_return * 1.2\n  AND dr.ctr_reason_sk BETWEEN 17 AND 20\n  AND s.s_state IN ('IA', 'KY', 'NE')\n  AND cd.cd_marital_status IN ('S', 'S')\n  AND cd.cd_education_status IN ('4 yr Degree', '4 yr Degree')\n  AND cd.cd_gender = 'M'\n  AND c.c_birth_month = 4\n  AND c.c_birth_year BETWEEN 1987 AND 1993\nORDER BY c.c_customer_id\nLIMIT 100"
      },
      {
        "node_id": "decorrelated_returns",
        "parent_node_id": "final_select",
        "sources": ["store_returns", "date_dim"],
        "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return", "avg_store_return"],
        "changed": true,
        "sql": "SELECT sr.sr_customer_sk AS ctr_customer_sk,\n       sr.sr_store_sk AS ctr_store_sk,\n       sr.sr_reason_sk AS ctr_reason_sk,\n       SUM(sr.SR_RETURN_AMT_INC_TAX) AS ctr_total_return,\n       AVG(SUM(sr.SR_RETURN_AMT_INC_TAX)) OVER (PARTITION BY sr.sr_store_sk) AS avg_store_return\nFROM store_returns sr\nJOIN date_dim d ON sr.sr_returned_date_sk = d.d_date_sk\nWHERE d.d_year = 2000\n  AND sr.sr_return_amt / sr.sr_return_quantity BETWEEN 115 AND 174\nGROUP BY sr.sr_customer_sk, sr.sr_store_sk, sr.sr_reason_sk"
      }
    ]
  }
}