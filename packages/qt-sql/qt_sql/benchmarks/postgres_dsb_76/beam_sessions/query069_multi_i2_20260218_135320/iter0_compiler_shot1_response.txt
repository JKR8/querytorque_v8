[
  {
    "plan_id": "compile_p02",
    "dialect": "postgres",
    "confidence": 0.90,
    "based_on": "p02",
    "strategy": "Date CTE with explicit join conversion to arm optimizer and eliminate repeated date_dim scans.",
    "hypothesis": "Probe p02 won with 1.78x speedup by materializing date range once and converting comma joins to explicit JOIN syntax, addressing repeated date_dim scans and comma-join weakness.",
    "expected_explain_delta": "Three separate date_dim index scans become one CTE scan; comma joins become explicit inner joins; nested loops may remain but with reduced outer rows.",
    "target_ir": "Introduce date_range CTE and convert main FROM clause to explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "customer_address", "customer_demographics", "store_sales", "web_sales", "catalog_sales", "date_dim"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
          "changed": true,
          "sql": "WITH date_range AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) cnt1, cd_purchase_estimate, COUNT(*) cnt2, cd_credit_rating, COUNT(*) cnt3 FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd_demo_sk = c.c_current_cdemo_sk WHERE ca_state IN ('GA','KY','SD') AND cd_marital_status IN ('D', 'W', 'U') AND cd_education_status IN ('Primary', 'College') AND EXISTS (SELECT 1 FROM store_sales JOIN date_range d ON ss_sold_date_sk = d.d_date_sk WHERE c.c_customer_sk = ss_customer_sk AND ss_list_price BETWEEN 52 AND 141) AND (NOT EXISTS (SELECT 1 FROM web_sales JOIN date_range d ON ws_sold_date_sk = d.d_date_sk WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_list_price BETWEEN 52 AND 141) AND NOT EXISTS (SELECT 1 FROM catalog_sales JOIN date_range d ON cs_sold_date_sk = d.d_date_sk WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_list_price BETWEEN 52 AND 141)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p01_p02",
    "dialect": "postgres",
    "confidence": 0.80,
    "based_on": "p01,p02",
    "strategy": "Pre-filter customer dimension into CTE and reuse date_range CTE to reduce rows entering correlated subqueries.",
    "hypothesis": "Probe p01 won with 2.26x speedup by pre-filtering customer set; combined with p02's date CTE to reduce repeated scans. Guarded EXISTS/NOT EXISTS forms preserved to avoid semi‑join regression.",
    "expected_explain_delta": "Customer‑dimension filters applied once in CTE; date_dim scanned once; outer row count reduced before correlated subquery execution.",
    "target_ir": "Add filtered_customers CTE and date_range CTE; keep EXISTS/NOT EXISTS subqueries but reference CTEs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer", "customer_address", "customer_demographics", "store_sales", "web_sales", "catalog_sales", "date_dim"],
          "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
          "changed": true,
          "sql": "WITH filtered_customers AS (SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('GA','KY','SD') AND cd.cd_marital_status IN ('D', 'W', 'U') AND cd.cd_education_status IN ('Primary', 'College')), date_range AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) cnt1, cd_purchase_estimate, COUNT(*) cnt2, cd_credit_rating, COUNT(*) cnt3 FROM filtered_customers fc WHERE EXISTS (SELECT 1 FROM store_sales JOIN date_range d ON ss_sold_date_sk = d.d_date_sk WHERE fc.c_customer_sk = ss_customer_sk AND ss_list_price BETWEEN 52 AND 141) AND (NOT EXISTS (SELECT 1 FROM web_sales JOIN date_range d ON ws_sold_date_sk = d.d_date_sk WHERE fc.c_customer_sk = ws_bill_customer_sk AND ws_list_price BETWEEN 52 AND 141) AND NOT EXISTS (SELECT 1 FROM catalog_sales JOIN date_range d ON cs_sold_date_sk = d.d_date_sk WHERE fc.c_customer_sk = cs_ship_customer_sk AND cs_list_price BETWEEN 52 AND 141)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
        }
      ]
    }
  }
]