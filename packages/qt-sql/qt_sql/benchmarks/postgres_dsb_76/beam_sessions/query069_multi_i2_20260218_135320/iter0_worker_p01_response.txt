{
  "probe_id": "p12",
  "transform_id": "early_filter_decorrelate",
  "family": "B",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Pre-filtering customer demographics and address into a CTE reduces correlated subquery input size. Correlated EXISTS/NOT EXISTS are converted to semi/anti-joins with precomputed date ranges and customer keys.",
  "reasoning_trace": [
    "Assigned transform targets decorrelation of correlated subqueries with early customer filtering.",
    "Three correlated subqueries (store_sales, web_sales, catalog_sales) share common date and customer filters.",
    "Customer filters reduce outer row count from 1447 to smaller set before subquery execution.",
    "Date dimension scan is materialized once and reused across all three subqueries."
  ],
  "target_ir": "Introduce filtered_customers CTE with all customer filters applied; convert correlated subqueries to semi/anti-joins using precomputed customer keys and date ranges.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["filtered_customers"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3"],
        "changed": true,
        "sql": "SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3 FROM filtered_customers fc GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating LIMIT 100"
      },
      {
        "node_id": "filtered_customers",
        "parent_node_id": "final_select",
        "sources": ["customer", "customer_address", "customer_demographics", "store_sales_filtered", "web_sales_filtered", "catalog_sales_filtered"],
        "outputs": ["c_customer_sk", "cd_gender", "cd_marital_status", "cd_education_status", "cd_purchase_estimate", "cd_credit_rating"],
        "changed": true,
        "sql": "WITH date_range AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 3 AND 5), store_sales_filtered AS (SELECT ss_customer_sk FROM store_sales JOIN date_range dr ON ss_sold_date_sk = dr.d_date_sk WHERE ss_list_price BETWEEN 52 AND 141), web_sales_filtered AS (SELECT ws_bill_customer_sk FROM web_sales JOIN date_range dr ON ws_sold_date_sk = dr.d_date_sk WHERE ws_list_price BETWEEN 52 AND 141), catalog_sales_filtered AS (SELECT cs_ship_customer_sk FROM catalog_sales JOIN date_range dr ON cs_sold_date_sk = dr.d_date_sk WHERE cs_list_price BETWEEN 52 AND 141) SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_state IN ('GA','KY','SD') AND cd.cd_marital_status IN ('D', 'W', 'U') AND cd.cd_education_status IN ('Primary', 'College') AND EXISTS (SELECT 1 FROM store_sales_filtered ssf WHERE ssf.ss_customer_sk = c.c_customer_sk) AND NOT EXISTS (SELECT 1 FROM web_sales_filtered wsf WHERE wsf.ws_bill_customer_sk = c.c_customer_sk) AND NOT EXISTS (SELECT 1 FROM catalog_sales_filtered csf WHERE csf.cs_ship_customer_sk = c.c_customer_sk)"
      }
    ]
  }
}