{
  "probe_id": "p12",
  "transform_id": "multi_dimension_prefetch",
  "family": "A",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Pre-filtering all selective dimensions (date_dim, store, item, customer_demographics) into CTEs before joining with store_sales reduces nested loop iterations and enables better join planning.",
  "reasoning_trace": [
    "Nested loop hotspot identified on store_sales with repeated index scans (21.936ms Ã— 122).",
    "All dimension tables have selective filters that can be pre-applied.",
    "Materializing filtered dimensions once avoids repeated scans and improves cardinality estimates."
  ],
  "target_ir": "date_dim, store, item, customer_demographics filtered into CTEs; store_sales joined via comma syntax with all CTEs in FROM clause.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": [
          "i_item_id",
          "s_state",
          "g_state",
          "agg1",
          "agg2",
          "agg3",
          "agg4"
        ],
        "changed": true,
        "sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_year = 1999\n),\nfiltered_store AS (\n  SELECT s_store_sk\n  FROM store\n  WHERE s_state = 'OH'\n),\nfiltered_item AS (\n  SELECT i_item_sk\n  FROM item\n  WHERE i_category = 'Music'\n),\nfiltered_customer_demographics AS (\n  SELECT cd_demo_sk\n  FROM customer_demographics\n  WHERE cd_gender = 'M'\n    AND cd_marital_status = 'W'\n    AND cd_education_status = 'Secondary'\n)\nSELECT\n  i.i_item_id,\n  s.s_state,\n  GROUPING(s.s_state) AS g_state,\n  AVG(ss.ss_quantity) AS agg1,\n  AVG(ss.ss_list_price) AS agg2,\n  AVG(ss.ss_coupon_amt) AS agg3,\n  AVG(ss.ss_sales_price) AS agg4\nFROM store_sales ss,\n     filtered_date_dim d,\n     filtered_store s,\n     filtered_item i,\n     filtered_customer_demographics cd\nWHERE ss.ss_sold_date_sk = d.d_date_sk\n  AND ss.ss_item_sk = i.i_item_sk\n  AND ss.ss_store_sk = s.s_store_sk\n  AND ss.ss_cdemo_sk = cd.cd_demo_sk\nGROUP BY ROLLUP (i.i_item_id, s.s_state)\nORDER BY i.i_item_id, s.s_state\nLIMIT 100"
      }
    ]
  }
}