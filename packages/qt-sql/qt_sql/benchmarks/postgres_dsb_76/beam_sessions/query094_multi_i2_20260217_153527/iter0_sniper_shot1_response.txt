[  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.83,
    "based_on": "p02,p03,p11",
    "strategy": "Explicit JOINs + NOT EXISTS decorrelation",
    "hypothesis": "Convert comma joins to explicit JOIN syntax for better PG optimization and replace NOT EXISTS anti-join with precomputed CTE to break correlation",
    "target_ir": "Main query with explicit JOIN tree and anti-join via CTE LEFT JOIN",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "problem_orders",
          "cte_query_sql": "SELECT DISTINCT wr_order_number FROM web_returns WHERE wr_reason_sk IN (8,18,20,23,41)"
        }
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "web_sales ws1 INNER JOIN date_dim ON ws1.ws_ship_date_sk = date_dim.d_date_sk INNER JOIN customer_address ON ws1.ws_ship_addr_sk = customer_address.ca_address_sk INNER JOIN web_site ON ws1.ws_web_site_sk = web_site.web_site_sk LEFT JOIN problem_orders po ON ws1.ws_order_number = po.wr_order_number"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "7fc853016d94f2a4"},
        "payload": {
          "sql_fragment": "date_dim.d_date BETWEEN '1999-10-01' AND CAST('1999-10-01' AS DATE) + INTERVAL '60 DAY' AND customer_address.ca_state IN ('MO','MT','OK','SC','TX','WI') AND web_site.web_gmt_offset >= -5 AND ws1.ws_list_price BETWEEN 253 AND 282 AND EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND po.wr_order_number IS NULL"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.77,
    "based_on": "p01,p04,p10",
    "strategy": "Full decorrelation of both EXISTS conditions",
    "hypothesis": "Convert both EXISTS and NOT EXISTS to explicit CTE joins while retaining predicate pushdown to base scans",
    "target_ir": "Star join with two precomputed anti/semi-join CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "multi_warehouse_orders",
          "cte_query_sql": "SELECT ws_order_number FROM web_sales GROUP BY ws_order_number HAVING COUNT(DISTINCT ws_warehouse_sk) > 1"
        }
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_returns",
          "cte_query_sql": "SELECT DISTINCT wr_order_number FROM web_returns WHERE wr_reason_sk IN (8,18,20,23,41)"
        }
      },
      {
        "step_id": "s3",
        "op": "replace_from",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "web_sales ws1 INNER JOIN date_dim ON ws1.ws_ship_date_sk = date_dim.d_date_sk INNER JOIN customer_address ON ws1.ws_ship_addr_sk = customer_address.ca_address_sk INNER JOIN web_site ON ws1.ws_web_site_sk = web_site.web_site_sk INNER JOIN multi_warehouse_orders mwo ON ws1.ws_order_number = mwo.ws_order_number LEFT JOIN filtered_returns fr ON ws1.ws_order_number = fr.wr_order_number"
        }
      },
      {
        "step_id": "s4",
        "op": "replace_where_predicate",
        "target": {"by_anchor_hash": "7fc853016d94f2a4"},
        "payload": {
          "sql_fragment": "date_dim.d_date BETWEEN '1999-10-01' AND CAST('1999-10-01' AS DATE) + INTERVAL '60 DAY' AND customer_address.ca_state IN ('MO','MT','OK','SC','TX','WI') AND web_site.web_gmt_offset >= -5 AND ws1.ws_list_price BETWEEN 253 AND 282 AND fr.wr_order_number IS NULL"
        }
      }
    ]
  }
]