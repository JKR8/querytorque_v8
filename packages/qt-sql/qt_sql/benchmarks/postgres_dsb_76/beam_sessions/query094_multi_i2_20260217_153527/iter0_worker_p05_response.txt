{
  "probe_id": "p01",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Decompose repeated web_sales scans into a single filtered CTE to avoid multiple scans and enable reuse in self-join and subquery patterns.",
  "reasoning_trace": [
    "Original query scans web_sales twice: once as ws1 and once as ws2 in EXISTS subquery.",
    "NOT EXISTS subquery also references web_returns but does not require web_sales materialization.",
    "Creating a CTE for filtered web_sales (ws_list_price BETWEEN 253 AND 282) allows reuse in both main query and EXISTS subquery.",
    "This avoids double scan of web_sales and leverages PostgreSQL's default CTE materialization."
  ],
  "target_ir": "CTE ws_base contains filtered web_sales; main query and EXISTS subquery reference ws_base instead of raw web_sales.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ws_base",
        "cte_query_sql": "SELECT ws_order_number, ws_warehouse_sk, ws_ext_ship_cost, ws_net_profit FROM web_sales WHERE ws_list_price BETWEEN 253 AND 282"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "ws_base ws1, date_dim, customer_address, web_site"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_expr_subtree",
      "target": {"by_node_id": "S0", "by_anchor_hash": "7fc853016d94f2a4"},
      "payload": {
        "expr_sql": "d_date BETWEEN '1999-10-01' AND CAST('1999-10-01' AS DATE) + INTERVAL '60 DAY' AND ws1.ws_ship_date_sk = d_date_sk AND ws1.ws_ship_addr_sk = ca_address_sk AND ca_state IN ('MO','MT','OK','SC','TX','WI') AND ws1.ws_web_site_sk = web_site_sk AND web_gmt_offset >= -5 AND EXISTS (SELECT * FROM ws_base ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk) AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (8, 18, 20, 23, 41))"
      }
    }
  ]
}