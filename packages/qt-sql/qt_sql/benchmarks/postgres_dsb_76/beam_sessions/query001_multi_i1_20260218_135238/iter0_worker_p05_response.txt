{
  "probe_id": "p12",
  "transform_id": "dimension_prefetch_star",
  "family": "F",
  "status": "success",
  "dialect": "postgres",
  "hypothesis": "Prefetching selective dimensions into CTEs and using explicit JOIN syntax can reduce fact scan rows and improve join cardinality estimates. The correlated subquery remains unchanged as it is the primary performance bottleneck.",
  "reasoning_trace": [
    "Assigned transform targets dimension prefetching to reduce fact-table fanout.",
    "Comma-join pattern detected with selective dimension filters in WHERE clause.",
    "Explicit JOIN conversion is safe and aligns with PostgreSQL optimizer strengths."
  ],
  "target_ir": "Dimension tables (date_dim, store, customer, customer_demographics) are prefetched into CTEs. Main query uses explicit JOINs. Correlated subquery preserved.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [
          "customer_total_return",
          "filtered_store",
          "filtered_customer",
          "filtered_customer_demographics"
        ],
        "outputs": ["c_customer_id"],
        "changed": true,
        "sql": "SELECT c.c_customer_id FROM customer_total_return ctr1 JOIN filtered_store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN filtered_customer c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN filtered_customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 ORDER BY c.c_customer_id LIMIT 100"
      },
      {
        "node_id": "customer_total_return",
        "parent_node_id": "final_select",
        "sources": ["store_returns", "date_dim"],
        "outputs": [
          "ctr_customer_sk",
          "ctr_store_sk",
          "ctr_reason_sk",
          "ctr_total_return"
        ],
        "changed": false
      },
      {
        "node_id": "filtered_store",
        "parent_node_id": "final_select",
        "sources": ["store"],
        "outputs": ["s_store_sk", "s_state"],
        "changed": true,
        "sql": "SELECT s_store_sk, s_state FROM store WHERE s_state IN ('IL', 'KY', 'TX')"
      },
      {
        "node_id": "filtered_customer",
        "parent_node_id": "final_select",
        "sources": ["customer"],
        "outputs": [
          "c_customer_sk",
          "c_customer_id",
          "c_current_cdemo_sk",
          "c_birth_month",
          "c_birth_year"
        ],
        "changed": true,
        "sql": "SELECT c_customer_sk, c_customer_id, c_current_cdemo_sk, c_birth_month, c_birth_year FROM customer WHERE c_birth_month = 2 AND c_birth_year BETWEEN 1965 AND 1971"
      },
      {
        "node_id": "filtered_customer_demographics",
        "parent_node_id": "final_select",
        "sources": ["customer_demographics"],
        "outputs": [
          "cd_demo_sk",
          "cd_marital_status",
          "cd_education_status",
          "cd_gender"
        ],
        "changed": true,
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status, cd_gender FROM customer_demographics WHERE cd_marital_status IN ('M', 'M') AND cd_education_status IN ('Advanced Degree', 'College') AND cd_gender = 'F'"
      }
    ]
  }
}