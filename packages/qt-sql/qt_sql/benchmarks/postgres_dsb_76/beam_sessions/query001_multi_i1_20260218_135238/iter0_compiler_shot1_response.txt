[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.88,
    "based_on": "p01,p02",
    "strategy": "Decorrelation-first with explicit JOIN syntax and early filter pushdown.",
    "hypothesis": "Primary hotspot is correlated scalar subquery causing nested-loop re-evaluation of entire CTE. Winning probes p01 (12.64x) and p02 (11.85x) demonstrate decorrelation via precomputed per-store averages eliminates quadratic blow-up while preserving semantics.",
    "expected_explain_delta": "Nested-loop correlation operators disappear; CTE scan time drops from 56s to <1s; final join chain remains hash/merge joins.",
    "target_ir": "Replace correlated subquery with explicit JOIN to precomputed store averages CTE; convert comma joins to explicit JOIN syntax.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["customer_total_return_filtered", "avg_returns_by_store", "store", "customer", "customer_demographics"],
          "outputs": ["c_customer_id"],
          "changed": true,
          "sql": "SELECT c_customer_id FROM customer_total_return_filtered ctr1 JOIN avg_returns_by_store a ON ctr1.ctr_store_sk = a.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk WHERE ctr1.ctr_total_return > a.avg_return * 1.2 AND ctr1.ctr_reason_sk BETWEEN 43 AND 46 AND s.s_state IN ('IL', 'KY', 'TX') AND cd.cd_marital_status IN ('M', 'M') AND cd.cd_education_status IN ('Advanced Degree', 'College') AND cd.cd_gender = 'F' AND c.c_birth_month = 2 AND c.c_birth_year BETWEEN 1965 AND 1971 ORDER BY c_customer_id LIMIT 100"
        },
        {
          "node_id": "customer_total_return_filtered",
          "parent_node_id": "final_select",
          "sources": ["store_returns", "date_dim"],
          "outputs": ["ctr_customer_sk", "ctr_store_sk", "ctr_reason_sk", "ctr_total_return"],
          "changed": true,
          "sql": "SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, sr_reason_sk AS ctr_reason_sk, SUM(SR_RETURN_AMT_INC_TAX) AS ctr_total_return FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2002 AND sr_return_amt / sr_return_quantity BETWEEN 108 AND 167 GROUP BY sr_customer_sk, sr_store_sk, sr_reason_sk"
        },
        {
          "node_id": "avg_returns_by_store",
          "parent_node_id": "final_select",
          "sources": ["customer_total_return_filtered"],
          "outputs": ["ctr_store_sk", "avg_return"],
          "changed": true,
          "sql": "SELECT ctr_store_sk, AVG(ctr_total_return) AS avg_return FROM customer_total_return_filtered GROUP BY ctr_store_sk"
        }
      ]
    }
  }
]