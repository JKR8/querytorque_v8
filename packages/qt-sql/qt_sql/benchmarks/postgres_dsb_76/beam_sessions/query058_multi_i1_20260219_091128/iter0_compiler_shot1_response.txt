[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01",
    "strategy": "Extract date subquery into a CTE and convert comma joins to explicit JOIN syntax.",
    "hypothesis": "Original plan repeats date_dim subquery three times. Factoring it out reduces redundant work and explicit joins improve predicate pushdown. This matches COMMA_JOIN_WEAKNESS pattern.",
    "expected_explain_delta": "Eliminate repeated date_dim index-only scans and nested loops, replace with hash joins and single date filter CTE.",
    "target_ir": "Add date_sk_filter CTE, update ss_items, cs_items, ws_items to explicit JOINs.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss_items", "cs_items", "ws_items"],
          "outputs": ["item_id", "birth_year", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"],
          "changed": true,
          "sql": "WITH date_sk_filter AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')), ss_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ss.ss_ext_sales_price) AS ss_item_rev FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_sk_filter d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year), cs_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(cs.cs_ext_sales_price) AS cs_item_rev FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_sk_filter d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year), ws_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ws.ws_ext_sales_price) AS ws_item_rev FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN date_sk_filter d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year) SELECT ss_items.item_id, ss_items.birth_year, ss_item_rev, ss_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ss_dev, cs_item_rev, cs_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS cs_dev, ws_item_rev, ws_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ws_dev, (ss_item_rev + cs_item_rev + ws_item_rev) / 3 AS average FROM ss_items JOIN cs_items ON ss_items.item_id = cs_items.item_id AND ss_items.birth_year = cs_items.birth_year JOIN ws_items ON ss_items.item_id = ws_items.item_id AND ss_items.birth_year = ws_items.birth_year WHERE ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev ORDER BY item_id, birth_year, ss_item_rev LIMIT 100"
        },
        {
          "node_id": "date_sk_filter",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')"
        },
        {
          "node_id": "ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "item", "date_sk_filter", "customer"],
          "outputs": ["item_id", "birth_year", "ss_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ss.ss_ext_sales_price) AS ss_item_rev FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN date_sk_filter d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year"
        },
        {
          "node_id": "cs_items",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "item", "date_sk_filter", "customer"],
          "outputs": ["item_id", "birth_year", "cs_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(cs.cs_ext_sales_price) AS cs_item_rev FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN date_sk_filter d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year"
        },
        {
          "node_id": "ws_items",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "item", "date_sk_filter", "customer"],
          "outputs": ["item_id", "birth_year", "ws_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ws.ws_ext_sales_price) AS ws_item_rev FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN date_sk_filter d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND i.i_manager_id BETWEEN 71 AND 100 AND c.c_birth_year BETWEEN 1945 AND 1951 GROUP BY i.i_item_id, c.c_birth_year"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p02",
    "strategy": "Pre-filter item and customer into CTEs, then join with fact tables and date subquery.",
    "hypothesis": "Reduces dimension table scan volume by applying filters early. Keeps date subquery per channel but reduces rows joined. Addresses CROSS_CTE_PREDICATE_BLINDNESS.",
    "expected_explain_delta": "Reduce nested loops on item and customer, earlier filter application, smaller hash join inputs.",
    "target_ir": "Add item_filtered and customer_filtered CTEs, update ss_items, cs_items, ws_items to use filtered dimensions.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["ss_items", "cs_items", "ws_items"],
          "outputs": ["item_id", "birth_year", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"],
          "changed": true,
          "sql": "WITH item_filtered AS (SELECT i_item_sk, i_item_id FROM item WHERE i_manager_id BETWEEN 71 AND 100), customer_filtered AS (SELECT c_customer_sk, c_birth_year FROM customer WHERE c_birth_year BETWEEN 1945 AND 1951), ss_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ss.ss_ext_sales_price) AS ss_item_rev FROM store_sales ss JOIN item_filtered i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year), cs_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(cs.cs_ext_sales_price) AS cs_item_rev FROM catalog_sales cs JOIN item_filtered i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year), ws_items AS (SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ws.ws_ext_sales_price) AS ws_item_rev FROM web_sales ws JOIN item_filtered i ON ws.ws_item_sk = i.i_item_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year) SELECT ss_items.item_id, ss_items.birth_year, ss_item_rev, ss_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ss_dev, cs_item_rev, cs_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS cs_dev, ws_item_rev, ws_item_rev / ((ss_item_rev + cs_item_rev + ws_item_rev) / 3) * 100 AS ws_dev, (ss_item_rev + cs_item_rev + ws_item_rev) / 3 AS average FROM ss_items JOIN cs_items ON ss_items.item_id = cs_items.item_id AND ss_items.birth_year = cs_items.birth_year JOIN ws_items ON ss_items.item_id = ws_items.item_id AND ss_items.birth_year = ws_items.birth_year WHERE ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev ORDER BY item_id, birth_year, ss_item_rev LIMIT 100"
        },
        {
          "node_id": "item_filtered",
          "parent_node_id": "final_select",
          "sources": ["item"],
          "outputs": ["i_item_sk", "i_item_id"],
          "changed": true,
          "sql": "SELECT i_item_sk, i_item_id FROM item WHERE i_manager_id BETWEEN 71 AND 100"
        },
        {
          "node_id": "customer_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer"],
          "outputs": ["c_customer_sk", "c_birth_year"],
          "changed": true,
          "sql": "SELECT c_customer_sk, c_birth_year FROM customer WHERE c_birth_year BETWEEN 1945 AND 1951"
        },
        {
          "node_id": "ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "item_filtered", "date_dim", "customer_filtered"],
          "outputs": ["item_id", "birth_year", "ss_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ss.ss_ext_sales_price) AS ss_item_rev FROM store_sales ss JOIN item_filtered i ON ss.ss_item_sk = i.i_item_sk JOIN date_dim d ON ss.ss_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON ss.ss_customer_sk = c.c_customer_sk WHERE ss.ss_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year"
        },
        {
          "node_id": "cs_items",
          "parent_node_id": "final_select",
          "sources": ["catalog_sales", "item_filtered", "date_dim", "customer_filtered"],
          "outputs": ["item_id", "birth_year", "cs_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(cs.cs_ext_sales_price) AS cs_item_rev FROM catalog_sales cs JOIN item_filtered i ON cs.cs_item_sk = i.i_item_sk JOIN date_dim d ON cs.cs_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON cs.cs_bill_customer_sk = c.c_customer_sk WHERE cs.cs_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year"
        },
        {
          "node_id": "ws_items",
          "parent_node_id": "final_select",
          "sources": ["web_sales", "item_filtered", "date_dim", "customer_filtered"],
          "outputs": ["item_id", "birth_year", "ws_item_rev"],
          "changed": true,
          "sql": "SELECT i.i_item_id AS item_id, c.c_birth_year AS birth_year, SUM(ws.ws_ext_sales_price) AS ws_item_rev FROM web_sales ws JOIN item_filtered i ON ws.ws_item_sk = i.i_item_sk JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk JOIN customer_filtered c ON ws.ws_bill_customer_sk = c.c_customer_sk WHERE ws.ws_list_price BETWEEN 242 AND 271 AND d.d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM date_dim WHERE d_date = '1998-05-19')) GROUP BY i.i_item_id, c.c_birth_year"
        }
      ]
    }
  }
]