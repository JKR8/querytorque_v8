[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.8,
    "based_on": "p04,p08",
    "strategy": "Combine explicit join conversion with decorrelated sales CTEs",
    "hypothesis": "Original plan shows repeated dimension scans and nested loops. Converting to explicit joins improves cardinality estimates. Precomputing sales channels in CTEs avoids repeated scans and enables hash semi-joins.",
    "target_ir": "Explicit JOINs in main query; EXISTS replaced by IN with precomputed CTEs; UNION for web/catalog OR condition",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH store_sales_cte AS (\n  SELECT DISTINCT ss_customer_sk\n  FROM store_sales\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  JOIN item ON ss_item_sk = i_item_sk\n  WHERE d_year = 1999\n    AND d_moy BETWEEN 5 AND 8\n    AND i_category IN ('Children', 'Home', 'Women')\n    AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n    AND i_manager_id BETWEEN 91 AND 100\n),\nweb_catalog_union AS (\n  SELECT ws_bill_customer_sk AS customer_sk\n  FROM web_sales\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  JOIN item ON ws_item_sk = i_item_sk\n  WHERE d_year = 1999\n    AND d_moy BETWEEN 5 AND 8\n    AND i_category IN ('Children', 'Home', 'Women')\n    AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n    AND i_manager_id BETWEEN 91 AND 100\n  UNION\n  SELECT cs_ship_customer_sk\n  FROM catalog_sales\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  JOIN item ON cs_item_sk = i_item_sk\n  WHERE d_year = 1999\n    AND d_moy BETWEEN 5 AND 8\n    AND i_category IN ('Children', 'Home', 'Women')\n    AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n    AND i_manager_id BETWEEN 91 AND 100\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  COUNT(*) cnt1,\n  cd_purchase_estimate,\n  COUNT(*) cnt2,\n  cd_credit_rating,\n  COUNT(*) cnt3,\n  cd_dep_count,\n  COUNT(*) cnt4,\n  cd_dep_employed_count,\n  COUNT(*) cnt5,\n  cd_dep_college_count,\n  COUNT(*) cnt6\nFROM customer c\nJOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd ON cd_demo_sk = c.c_current_cdemo_sk\nWHERE ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County')\n  AND c.c_birth_month IN (4, 5)\n  AND cd_marital_status IN ('U', 'S', 'U')\n  AND cd_education_status IN ('College', 'Secondary', 'College')\n  AND cd_gender = 'M'\n  AND c.c_customer_sk IN (SELECT ss_customer_sk FROM store_sales_cte)\n  AND c.c_customer_sk IN (SELECT customer_sk FROM web_catalog_union)\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.7,
    "based_on": "p05,p06",
    "strategy": "Shared filtered dimension CTEs with explicit joins",
    "hypothesis": "Repeated date_dim/item scans dominate runtime. Isolating filtered dimensions into shared CTEs reduces rescans. Explicit joins improve predicate pushdown.",
    "target_ir": "CTEs for date/item; explicit JOINs; EXISTS subqueries reference CTEs directly",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_date AS (\n  SELECT d_date_sk \n  FROM date_dim \n  WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8\n),\nfiltered_item AS (\n  SELECT i_item_sk \n  FROM item \n  WHERE i_category IN ('Children', 'Home', 'Women') \n    AND i_manager_id BETWEEN 91 AND 100\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  COUNT(*) cnt1,\n  cd_purchase_estimate,\n  COUNT(*) cnt2,\n  cd_credit_rating,\n  COUNT(*) cnt3,\n  cd_dep_count,\n  COUNT(*) cnt4,\n  cd_dep_employed_count,\n  COUNT(*) cnt5,\n  cd_dep_college_count,\n  COUNT(*) cnt6\nFROM customer c\nJOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\nJOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\nWHERE ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County')\n  AND c.c_birth_month IN (4, 5)\n  AND cd_marital_status IN ('U', 'S', 'U')\n  AND cd_education_status IN ('College', 'Secondary', 'College')\n  AND cd_gender = 'M'\n  AND EXISTS (\n    SELECT * \n    FROM store_sales\n    JOIN filtered_date ON ss_sold_date_sk = d_date_sk\n    JOIN filtered_item ON ss_item_sk = i_item_sk\n    WHERE c.c_customer_sk = ss_customer_sk\n      AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n  )\n  AND (\n    EXISTS (\n      SELECT * \n      FROM web_sales\n      JOIN filtered_date ON ws_sold_date_sk = d_date_sk\n      JOIN filtered_item ON ws_item_sk = i_item_sk\n      WHERE c.c_customer_sk = ws_bill_customer_sk\n        AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n    )\n    OR EXISTS (\n      SELECT * \n      FROM catalog_sales\n      JOIN filtered_date ON cs_sold_date_sk = d_date_sk\n      JOIN filtered_item ON cs_item_sk = i_item_sk\n      WHERE c.c_customer_sk = cs_ship_customer_sk\n        AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n    )\n  )\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100;"
        }
      }
    ]
  }
]