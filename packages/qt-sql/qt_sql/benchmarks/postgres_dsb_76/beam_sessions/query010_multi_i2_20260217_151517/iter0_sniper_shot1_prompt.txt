## Role

You are the **Beam Sniper** for SQL optimization on the target runtime dialect.

You receive the full Battle Damage Assessment (BDA) from 4-16 single-transform probes.
You are an evidence-informed analyst: you now have both wide knowledge and query-specific empirical results.

Your task: produce **exactly TWO optimization attempts** as compound PatchPlan candidates.

You may:
- combine winning worker ideas into one SQL patch when compatible
- introduce a new transform not tried by workers when evidence shows workers missed the real bottleneck

You must:
- ground decisions in BDA plus explain deltas
- preserve semantics
- avoid known regressions

---

## Prompt Map (cache friendly)

### Phase A - Cached Context (static)
A1. Dialect reminders plus regression registry
A2. Combination hazards (duplication, multiplicity, CTE fences)
A3. Evidence-first decision procedure (mechanical)
A4. Sniper output contract (strict JSON array)

### Phase B - Query-Specific Input (dynamic; after cache boundary)
B1. Importance star rating (1-3)
B2. Original SQL plus original plan
B3. IR structure plus anchor hashes
B4. BDA table (ALL probes: status, speedup, explain delta, failure reasons)
B5. Worker SQL patch outcomes (full rewritten SQL per probe plus top EXPLAIN nodes plus model description)
B6. Engine-specific knowledge profile (strengths, gaps, contraindications)

---

## Dialect reminders

Use runtime-injected **Engine-Specific Knowledge** as authoritative.
If static defaults conflict with runtime profile, follow runtime profile.

---

## Regression Registry (hard bans)

Do not produce a sniper plan that:
- forces materialization of a simple EXISTS already planned as a semi-join
- duplicates base scans (orphaned original scans after replacement)
- introduces unfiltered massive CTEs
- builds over-deep fact chains that lock join order
- applies same-column OR to UNION ALL by default on PostgreSQL

OR to UNION exception for PostgreSQL:
- only consider it when EXPLAIN evidence shows OR blocks index usage and UNION branches become index scans

---

## Combination hazards (what to watch)

- **Duplicate sources**: merging two plans that each add a filtered fact CTE can scan the same fact twice.
- **Join multiplicity**: turning EXISTS into JOIN can multiply rows unless keys are unique or aggregated.
- **CTE fences**: materialized CTEs can block pushdown and join reorder.
- **Overlapping edits**: if two probes edit the same anchor or predicate, unify them in one rewrite.

---

## Evidence-first decision procedure (mechanical)

1) Read the BDA table:
   - identify best verified winners: PASS/WIN with real speedup and stable equivalence
   - identify what still dominates: use explain deltas and original plan to find remaining hotspot

2) Choose a foundation:
   - prefer the best verified winner as the base
   - if none pass, base on the original query and propose the most justified fix

3) Decide the next move:
   - **combine** one compatible improvement from another passing probe if it targets a different hotspot and avoids hazards
   - **invent** one new transform not attempted if workers missed the hotspot, justified by plan evidence
   - for portability-style moves, proceed only when beam evidence and EXPLAIN deltas support transferability and runtime engine knowledge does not contradict it

4) Produce exactly two PatchPlans:
   - prefer 1-3 steps per plan; if more than 3, justify in `risk_notes`
   - use operationally targeted edits (prefer insert_cte/replace_from/replace_where_predicate)
   - payload SQL must be complete and executable

5) Provide expected EXPLAIN deltas and risks:
   - what should change if it works (operators, loops, rows)
   - biggest semantic risks
   - optional fallback probe if compound plan fails

---

## Sniper Output Contract (MUST follow)

Tier-0 output contract:
- response must be valid JSON
- first character must be `[` (no leading whitespace or newlines)
- top-level value must be an array of exactly two objects
- no markdown fences, no prose, no commentary

Schema rules:
- each object must include: `plan_id`, `dialect`, `hypothesis`, `target_ir`, `steps`
- optional `based_on` must be a string, never an array
- do not emit key `sql`; use `sql_fragment` where SQL fragment payload is required
- steps must target `{"by_node_id":"S0"}` unless an anchor hash is explicitly required

Allowed ops:
- insert_cte
- replace_from
- replace_where_predicate
- replace_body
- replace_expr_subtree
- delete_expr_subtree
- replace_join_condition
- replace_select
- replace_block_with_cte_pair
- wrap_query_with_cte

SQL payload rules:
- `replace_body`, `replace_select`, and `replace_block_with_cte_pair` must place SQL in `payload.sql_fragment`
- payload SQL must be complete and executable

Output JSON shape:
[
  {
    "plan_id": "snipe_p1",
    "dialect": "<target_dialect>",
    "confidence": 0.81,
    "based_on": "p03,p11",
    "strategy": "Foundation plus one compatible add-on",
    "hypothesis": "Plan evidence and expected win mechanism",
    "target_ir": "Short structural description of final query shape",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {"sql_fragment": "SELECT c_customer_sk FROM customer"}
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "<target_dialect>",
    "confidence": 0.73,
    "based_on": "p07",
    "strategy": "Alternative independent pathway",
    "hypothesis": "Plan evidence for second pathway",
    "target_ir": "Alternative structural description",
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "filtered_sales",
          "cte_query_sql": "SELECT ss_customer_sk FROM store_sales WHERE ss_quantity > 0"
        }
      }
    ]
  }
]

---

## Cache Boundary
Everything below is query-specific input.

## Query ID
query010_multi_i2

## Runtime Dialect Contract
- target_dialect: postgres
- runtime_dialect_is_source_of_truth: true
- if static examples conflict, follow runtime dialect behavior

## Importance
- importance_stars: 3
- importance_label: ***

## Original SQL
```sql
select 
  cd_gender,
  cd_marital_status,
  cd_education_status,
  count(*) cnt1,
  cd_purchase_estimate,
  count(*) cnt2,
  cd_credit_rating,
  count(*) cnt3,
  cd_dep_count,
  count(*) cnt4,
  cd_dep_employed_count,
  count(*) cnt5,
  cd_dep_college_count,
  count(*) cnt6
 from
  customer c,customer_address ca,customer_demographics
 where
  c.c_current_addr_sk = ca.ca_address_sk and
  ca_county in ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County') and
  c.c_birth_month in (4, 5) and
  cd_demo_sk = c.c_current_cdemo_sk
  and cd_marital_status in ('U', 'S', 'U')
  and cd_education_status in ('College', 'Secondary', 'College')
  and cd_gender = 'M' and
  exists (select *
          from store_sales,date_dim, item
          where c.c_customer_sk = ss_customer_sk and
                ss_sold_date_sk = d_date_sk and
                d_year = 1999 and
                d_moy between 5 and 5+3 and
                ss_item_sk = i_item_sk and
                i_category in ('Children', 'Home', 'Women')
                and ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01
                and i_manager_id BETWEEN 91 and 100
                ) and
   (exists (select *
            from web_sales,date_dim, item
            where c.c_customer_sk = ws_bill_customer_sk and
                  ws_sold_date_sk = d_date_sk and
                  d_year = 1999 and
                  d_moy between 5 ANd 5+3 and
                  ws_item_sk = i_item_sk and
                  i_category in ('Children', 'Home', 'Women')
                  and i_manager_id BETWEEN 91 and 100
                  and ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01
                  ) or
    exists (select *
            from catalog_sales,date_dim, item
            where c.c_customer_sk = cs_ship_customer_sk and
                  cs_sold_date_sk = d_date_sk and
                  d_year = 1999 and
                  d_moy between 5 and 5+3 and
                  cs_item_sk = i_item_sk and
                  i_category in ('Children', 'Home', 'Women')
                  and i_manager_id BETWEEN 91 and 100
                  and cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01
                  ))
 group by cd_gender,
          cd_marital_status,
          cd_education_status,
          cd_purchase_estimate,
          cd_credit_rating,
          cd_dep_count,
          cd_dep_employed_count,
          cd_dep_college_count
 order by cd_gender,
          cd_marital_status,
          cd_education_status,
          cd_purchase_estimate,
          cd_credit_rating,
          cd_dep_count,
          cd_dep_employed_count,
          cd_dep_college_count
limit 100;
```

## Original Plan
```
Limit  (rows=0, time=46106.936)
  Aggregate  (rows=0, time=45480.943)
    Sort  (rows=0, time=45480.941)
      Nested Loop  (rows=0, time=45480.894)
        Nested Loop  (rows=0, time=45480.892)
          Nested Loop  (rows=4, time=45478.123)
            Aggregate  (rows=1690, time=32401.246)
              Gather  (rows=1737, time=32395.391)
                Nested Loop  (rows=1737, time=32394.086)
                  Nested Loop  (rows=135401, time=14876.426)
                    Index Only Scan on date_dim  (rows=123, time=57.767)
                    Index Only Scan on store_sales  (rows=1101, time=120.345)
                  Index Scan on item  (rows=0, time=0.129)
            Index Scan on customer (c)  (rows=0, time=7.737)
              Nested Loop  (rows=0, time=2.247)
                Nested Loop  (rows=1, time=2.154)
                  Index Only Scan on date_dim (date_dim_1)  (rows=123, time=0.023)
                  Index Scan on web_sales  (rows=0, time=0.017)
                Index Scan on item (item_1)  (rows=0, time=0.176)
              Gather  (rows=803, time=11313.057)
                Nested Loop  (rows=803, time=11312.456)
                  Nested Loop  (rows=59661, time=4232.57)
                    Index Only Scan on date_dim (date_dim_2)  (rows=123, time=107.801)
                    Index Scan on catalog_sales  (rows=485, time=33.406)
                  Index Scan on item (item_2)  (rows=0, time=0.118)
          Index Scan on customer_address (ca)  (rows=0, time=0.69)
        Index Scan on customer_demographics  (rows=0, time=0.0)
```

## IR Structure + Anchor Hashes
```
S0 [SELECT]
  MAIN QUERY (via Q_S0)
    FROM: customer c, customer_address ca, customer_demographics
    WHERE [ddfcc2d1d3d0da2d]: c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pen...
    GROUP BY: cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count
    ORDER BY: cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count

Patch operations (core+advanced): insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree, replace_body, replace_join_condition, replace_select, replace_block_with_cte_pair, wrap_query_with_cte
Target: by_node_id (statement, e.g. "S0") + by_anchor_hash (expression)
```

## Schema / Index / Stats Context
- source: postgres
- referenced_tables: 8

| Table | Rows(est) | PK | Indexes |
|-------|-----------|----|---------|
| catalog_sales | 14397255 | cs_item_sk, cs_order_number | catalog_sales_pkey, _dta_index_catalog_sales_6_1301579675__k1_k16_k5_k4_3_6_18_19_2, _dta_index_catalog_sales_6_1301579675__k17_k6_k3_k5_k1_k16_12_1, _dta_index_catalog_sales_6_1301579675__k1_4_16_18_19_21_24, _dta_index_catalog_sales_6_1301579675__k3_k12_k14_k15_16_18, _dta_index_catalog_sales_6_1301579675__k1_k16_k4_18_34 |
| customer | 500000 | c_customer_sk | customer_pkey, _dta_index_customer_6_949578421__k9_k10, _dta_index_customer_6_949578421__k1_k5, _dta_index_customer_5_949578421__k13_k5 |
| customer_address | 250000 | ca_address_sk | customer_address_pkey |
| customer_demographics | 1920800 | cd_demo_sk | customer_demographics_pkey |
| date_dim | 73049 | d_date_sk | date_dim_pkey, _dta_index_date_dim_6_661577395__k7_k4_k9_k1, _dta_index_date_dim_6_661577395__k7_k9_k1, _dta_index_date_dim_6_661577395__k1_k7_k9, _dta_index_date_dim_6_661577395__k7_k11_k1, _dta_index_date_dim_6_661577395__k9_k7_k1 |
| item | 102000 | i_item_sk | item_pkey, _dta_index_item_6_853578079__k1_2_5, _dta_index_item_6_853578079__k13_k11_k1, _dta_index_item_6_853578079__k18, _dta_index_item_6_853578079__k2_k1 |
| store_sales | 28806628 | ss_item_sk, ss_ticket_number | store_sales_pkey, _dta_index_store_sales_6_1333579789__k1_k23_k14_k6_k8_k5_k7_3_4, _dta_index_store_sales_6_1333579789__k1_k5_k8_k3_11_13_14_20, _dta_index_store_sales_6_1333579789__k1_k3_k10_k4_k8_9_16_23, _dta_index_store_sales_6_1333579789__k4_1_3_10_11_14, _dta_index_store_sales_6_1333579789__k1_k3_k10_k4_k8_23 |
| web_sales | 7197533 | ws_item_sk, ws_order_number | web_sales_pkey, _dta_index_web_sales_6_1269579561__k3_k18_k12_k14_16_29_34, _dta_index_web_sales_6_1269579561__k1_k4_k5_18, _dta_index_web_sales_6_1269579561__k1_8_24, _dta_index_web_sales_6_1269579561__k18_16, _dta_index_web_sales_6_1269579561__k1_k5 |

## Engine-Specific Knowledge
## Dialect Profile (POSTGRES)

**Combined Intelligence Baseline**: Combined intelligence baseline from 53 validated DSB queries at SF5-SF10, plus regression registry outcomes. PostgreSQL has bitmap index scans, JIT compilation, and aggressive CTE materialization. Techniques that work on DuckDB often regress here.

### Optimizer Strengths (don't fight these)
- `BITMAP_OR_SCAN`: Avoid splitting OR conditions into UNION ALL by default. Only consider OR→UNION when EXPLAIN shows OR blocks index usage and UNION branches become index scans. 0.21x and 0.26x reg…
- `SEMI_JOIN_EXISTS`: NEVER convert EXISTS to IN/NOT IN or materialized CTEs. 0.50x, 0.75x observed. Note: NOT EXISTS anti-join decorrelation can still be valid when replacing large correlated anti patterns.
- `INNER_JOIN_REORDERING`: Don't restructure INNER JOIN orders. Focus on LEFT JOIN blocking or comma-join confusion.
- `INDEX_ONLY_SCAN`: Small dimension lookups (<10K rows) may not need CTEs.

### Known Gaps (exploit these)
- `COMMA_JOIN_WEAKNESS` [HIGH] detect: FROM t1, t2, t3 WHERE t1.key = t2.key (comma joins, no explicit JOIN). Poor row estimates in EXPLAIN. | action: Convert comma-joins to explicit JOIN...ON syntax. Best when combined with date_cte_isolate.
- `CORRELATED_SUBQUERY_PARALYSIS` [HIGH] detect: Nested loop in EXPLAIN, inner re-executes aggregate per outer row. SQL: WHERE col > (SELECT AGG FROM ... WHERE outer.key = inner.key). Hash… | action: Convert correlated WHERE to explicit CTE with GROUP BY + JOIN.
- `NON_EQUI_JOIN_INPUT_BLINDNESS` [HIGH] detect: Expensive non-equi join (BETWEEN, <, >) with large inputs on both sides. Neither side filtered. | action: Reduce fact table input size via filtered CTE before the non-equi join.
- `CTE_MATERIALIZATION_FENCE` [MEDIUM] detect: Large CTE + small post-filter. Multi-referenced CTE that blocks predicate pushdown. | action: Materialize STRATEGICALLY: only when CTE is expensive and reused. Avoid fencing single-use cases.
- `CROSS_CTE_PREDICATE_BLINDNESS` [MEDIUM] detect: Sequential scan on dimension table without index condition. Late filter after large scan/join. | action: Pre-filter into CTE definition. But be more cautious than on DuckDB.

## Dispatcher Hypothesis
Plan shows nested loops dominating runtime with repeated dimension rescans and correlated EXISTS execution. Decorrelating subqueries (B) and prefiltering dimensions (A) should reduce nested loop amplification. Materialization (E) and explicit joins (F) may optimize dimension reuse.

## Dispatcher Reasoning Trace
- Cost spine: Gather (32.4s) → Nested Loop (14.9s) → Index Scans on multiple date_dim/item copies
- Amplification: 135k rows in store_sales loop, 59k rows in catalog_sales loop with repeated dimension rescans
- Late selectivity: Dimension filters applied after joins, missing early reduction opportunities

## Equivalence Tier
- exact

## Additional Intelligence
### AST Feature Detection

- **dimension_cte_isolate**: 100% match (DATE_DIM, GROUP_BY, MULTI_TABLE_5+) (gap: CROSS_CTE_PREDICATE_BLINDNESS) [CAUTION: CROSS_JOIN_3_DIMS, UNFILTERED_CTE] [SUPPORT: portability_candidate; engines=duckdb]
- **sf_sk_pushdown_multi_fact**: 100% match (DATE_DIM, MULTI_TABLE_5+) (gap: PREDICATE_TRANSITIVITY_FAILURE) [SUPPORT: portability_candidate; engines=snowflake]
- **composite_decorrelate_union**: 89% match (AGG_COUNT, DATE_DIM, EXISTS, GROUP_BY) (gap: CORRELATED_SUBQUERY_PARALYSIS) [SUPPORT: portability_candidate; engines=duckdb]
  Missing: AGG_SUM
- **multi_date_range_cte**: 83% match (BETWEEN, DATE_DIM, GROUP_BY, MULTI_TABLE_5+) (gap: CROSS_CTE_PREDICATE_BLINDNESS) [SUPPORT: portability_candidate; engines=duckdb]
  Missing: AGG_AVG
- **or_to_union**: 75% match (DATE_DIM, GROUP_BY, OR_BRANCH) (gap: CROSS_COLUMN_OR_DECOMPOSITION) [CAUTION: MAX_3_BRANCHES, SAME_COL_OR] [SUPPORT: portability_candidate; engines=duckdb]
  Missing: AGG_SUM


## Probe Summary
14 probes fired, 0 passed validation, 0 showed speedup.

## BDA Table (all probes)

| Probe | Transform | Family | Status | Speedup | Top EXPLAIN Nodes | Model Description | SQL Patch | Error/Notes |
|-------|-----------|--------|--------|---------|-------------------|-------------------|-----------|-------------|
| p05 | date_cte_isolate | A | ERROR | - | - | Create filtered_date_cte AS MATERIALIZED SELECT d_date_sk FROM date_dim WHERE d_year=1999 AND d_moy BETWEEN 5 AND 8. Replace all date_dim scans in sales CTEs with this CTE | p05 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p08 | date_cte_explicit_join | F | ERROR | - | - | Convert main FROM clause to explicit joins: customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk | p08 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p13 | inner_join_conversion | F | ERROR | - | - | Convert customer_address join to INNER JOIN since ca_county filter eliminates NULLs | p13 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p01 | early_filter_decorrelate | B | FAIL | - | - | Decorate store_sales EXISTS: Create CTE store_sales_cte SELECT DISTINCT ss_customer_sk FROM store_sales JOIN date_dim JOIN item WITH filters. Replace EXISTS with c.c_customer_sk IN (SELECT ss_customer_sk FROM store_sales_cte) | p01 | Tier-1: COLUMN REF MISMATCH: Original columns missing from rewrite — ['cs_item_sk', 'cs_list_price', 'cs_sales_price', 'cs_ship_customer_sk', 'cs_sold_date_sk']. The rewrite references different table columns. |
| p06 | dimension_cte_isolate | A | FAIL | - | - | Create filtered_item_cte AS MATERIALIZED SELECT i_item_sk FROM item WHERE i_category IN ('Children','Home','Women') AND i_manager_id BETWEEN 91 AND 100. Replace all item scans in sales CTEs with this CTE | p06 | Tier-1: LITERAL MISMATCH: Original literals missing from rewrite — numbers: ['0.01', '1999.0', '3.0', '65.0', '75.0']. The rewrite changed filter values instead of preserving them. |
| p02 | early_filter_decorrelate | B | ERROR | - | - | Decorate web_sales EXISTS: Create CTE web_sales_cte SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN date_dim JOIN item WITH filters. Replace EXISTS with c.c_customer_sk IN (SELECT ws_bill_customer_sk FROM web_sales_cte) | p02 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p03 | early_filter_decorrelate | B | ERROR | - | - | Decorate catalog_sales EXISTS: Create CTE catalog_sales_cte SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN date_dim JOIN item WITH filters. Replace EXISTS with c.c_customer_sk IN (SELECT cs_ship_customer_sk FROM catalog_sales_cte) | p03 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p12 | early_filter | A | ERROR | - | - | Add county filter to customer_address CTE: Create ca_filtered AS SELECT * FROM customer_address WHERE ca_county IN (...). Join with customer in main query | p12 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p10 | shared_dimension_multi_channel | A | ERROR | - | - | Consolidate dimension CTEs: Replace individual date/item CTEs in sales CTEs with shared filtered_date_cte and filtered_item_cte | p10 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p09 | dimension_prefetch_star | F | ERROR | - | - | Add filtered dimension CTEs to main query: Pre-join customer with filtered customer_demographics CTE (WHERE cd_gender='M' AND cd_marital_status IN (...) AND cd_education_status IN (...)) | p09 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p07 | pg_self_join_decomposition | E | ERROR | - | - | Materialize sales CTEs: Add MATERIALIZED keyword to store_sales_cte, web_sales_cte, catalog_sales_cte definitions to prevent inlining | p07 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p11 | materialize_cte | E | ERROR | - | - | Force materialization of filtered_date_cte and filtered_item_cte with MATERIALIZED keyword | p11 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p04 | composite_decorrelate_union | B | ERROR | - | - | Combine web/catalog EXISTS: Create CTE web_catalog_union AS (SELECT ws_bill_customer_sk FROM web_sales_cte UNION SELECT cs_ship_customer_sk FROM catalog_sales_cte). Replace OR condition with c.c_customer_sk IN (SELECT * FROM web_catalog_union) | p04 | Synthetic semantic check failed: SyntheticDataGenerator._generate_value() got an unexpected keyword argument 'row_context' |
| p14 | aggregate_pushdown | C | FAIL | - | - | Push COUNT() into sales CTEs: Modify store_sales_cte to include COUNT() per customer, then reference in main SELECT | p14 | Tier-1: COLUMN REF MISMATCH: Original columns missing from rewrite — ['cs_item_sk', 'cs_list_price', 'cs_sales_price', 'cs_ship_customer_sk', 'cs_sold_date_sk']. The rewrite references different table columns. |

## Worker SQL Patches

### p05: date_cte_isolate (ERROR, n/a)
```sql
WITH filtered_date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p08: date_cte_explicit_join (ERROR, n/a)
```sql
SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p13: inner_join_conversion (ERROR, n/a)
```sql
SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c INNER JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p01: early_filter_decorrelate (FAIL, n/a)
```sql
WITH store_sales_filtered AS (SELECT DISTINCT ss_customer_sk FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND c.c_customer_sk IN (SELECT ss_customer_sk FROM store_sales_filtered) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p06: dimension_cte_isolate (FAIL, n/a)
```sql
WITH filtered_item_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p02: early_filter_decorrelate (ERROR, n/a)
```sql
WITH web_sales_cte AS (SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN item ON ws_item_sk = i_item_sk WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim AS d1, item AS i1 WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d1.d_date_sk AND d1.d_year = 1999 AND d1.d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i1.i_item_sk AND i1.i_category IN ('Children', 'Home', 'Women') AND i1.i_manager_id BETWEEN 91 AND 100 AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) AND (c.c_customer_sk IN (SELECT ws_bill_customer_sk FROM web_sales_cte) OR EXISTS(SELECT * FROM catalog_sales, date_dim AS d2, item AS i2 WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d2.d_date_sk AND d2.d_year = 1999 AND d2.d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i2.i_item_sk AND i2.i_category IN ('Children', 'Home', 'Women') AND i2.i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p03: early_filter_decorrelate (ERROR, n/a)
```sql
WITH catalog_sales_cte AS (SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN item ON cs_item_sk = i_item_sk WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND i_category IN ('Children', 'Home', 'Women') AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR c.c_customer_sk IN (SELECT cs_ship_customer_sk FROM catalog_sales_cte)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p12: early_filter (ERROR, n/a)
```sql
WITH ca_filtered AS (SELECT * FROM customer_address WHERE ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County')) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c JOIN ca_filtered AS ca ON c.c_current_addr_sk = ca.ca_address_sk, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p10: shared_dimension_multi_channel (ERROR, n/a)
```sql
WITH filtered_date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8), filtered_item_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p09: dimension_prefetch_star (ERROR, n/a)
```sql
WITH filtered_customer_demographics AS (SELECT * FROM customer_demographics WHERE cd_gender = 'M' AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College')) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN filtered_customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p07: pg_self_join_decomposition (ERROR, n/a)
```sql
WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100), store_sales_filtered AS (SELECT ss_customer_sk, ss_item_sk, ss_sales_price, ss_list_price FROM store_sales WHERE EXISTS(SELECT 1 FROM date_filter AS df WHERE df.d_date_sk = ss_sold_date_sk) AND EXISTS(SELECT 1 FROM filtered_item AS fi WHERE fi.i_item_sk = ss_item_sk)), web_sales_filtered AS (SELECT ws_bill_customer_sk, ws_item_sk, ws_sales_price, ws_list_price FROM web_sales WHERE EXISTS(SELECT 1 FROM date_filter AS df WHERE df.d_date_sk = ws_sold_date_sk) AND EXISTS(SELECT 1 FROM filtered_item AS fi WHERE fi.i_item_sk = ws_item_sk)), catalog_sales_filtered AS (SELECT cs_ship_customer_sk, cs_item_sk, cs_sales_price, cs_list_price FROM catalog_sales WHERE EXISTS(SELECT 1 FROM date_filter AS df WHERE df.d_date_sk = cs_sold_date_sk) AND EXISTS(SELECT 1 FROM filtered_item AS fi WHERE fi.i_item_sk = cs_item_sk)) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd.cd_marital_status IN ('U', 'S', 'U') AND cd.cd_education_status IN ('College', 'Secondary', 'College') AND cd.cd_gender = 'M' AND EXISTS(SELECT 1 FROM store_sales_filtered AS ssf WHERE c.c_customer_sk = ssf.ss_customer_sk AND ssf.ss_sales_price / ssf.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) AND (EXISTS(SELECT 1 FROM web_sales_filtered AS wsf WHERE c.c_customer_sk = wsf.ws_bill_customer_sk AND wsf.ws_sales_price / wsf.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT 1 FROM catalog_sales_filtered AS csf WHERE c.c_customer_sk = csf.cs_ship_customer_sk AND csf.cs_sales_price / csf.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p11: materialize_cte (ERROR, n/a)
```sql
WITH filtered_item_cte AS (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100), filtered_date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT * FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND (EXISTS(SELECT * FROM web_sales, date_dim, item WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ws_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS(SELECT * FROM catalog_sales, date_dim, item WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND cs_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100 AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p04: composite_decorrelate_union (ERROR, n/a)
```sql
WITH web_catalog_union AS ((SELECT ws_bill_customer_sk AS customer_sk FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3) AND ws_item_sk IN (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100) AND ws_sales_price / ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) UNION (SELECT cs_ship_customer_sk AS customer_sk FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3) AND cs_item_sk IN (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100) AND cs_sales_price / cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01)) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c, customer_address AS ca, customer_demographics WHERE c.c_current_addr_sk = ca.ca_address_sk AND ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd_demo_sk = c.c_current_cdemo_sk AND cd_marital_status IN ('U', 'S', 'U') AND cd_education_status IN ('College', 'Secondary', 'College') AND cd_gender = 'M' AND EXISTS(SELECT 1 FROM store_sales, date_dim, item WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk AND d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3 AND ss_item_sk = i_item_sk AND i_category IN ('Children', 'Home', 'Women') AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 AND i_manager_id BETWEEN 91 AND 100) AND c.c_customer_sk IN (SELECT customer_sk FROM web_catalog_union) GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```

### p14: aggregate_pushdown (FAIL, n/a)
```sql
WITH store_sales_agg AS (SELECT ss_customer_sk, COUNT(*) AS ss_count FROM store_sales WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5 + 3) AND ss_item_sk IN (SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100) AND ss_sales_price / ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01 GROUP BY ss_customer_sk) SELECT cd_gender, cd_marital_status, cd_education_status, COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2, cd_credit_rating, COUNT(*) AS cnt3, cd_dep_count, COUNT(*) AS cnt4, cd_dep_employed_count, COUNT(*) AS cnt5, cd_dep_college_count, COUNT(*) AS cnt6 FROM customer AS c JOIN customer_address AS ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics AS cd ON cd.cd_demo_sk = c.c_current_cdemo_sk JOIN store_sales_agg AS ssa ON ssa.ss_customer_sk = c.c_customer_sk WHERE ca.ca_county IN ('Alameda County', 'Lexington city', 'Pender County', 'Petroleum County', 'Walworth County') AND c.c_birth_month IN (4, 5) AND cd.cd_marital_status IN ('U', 'S', 'U') AND cd.cd_education_status IN ('College', 'Secondary', 'College') AND cd.cd_gender = 'M' GROUP BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY cd_gender, cd_marital_status, cd_education_status, cd_purchase_estimate, cd_credit_rating, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100;
```
