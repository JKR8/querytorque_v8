{
  "probe_id": "p07",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Materializing shared sales CTEs will prevent repeated scans of large fact tables and reduce nested loop amplification.",
  "reasoning_trace": [
    "Query contains three correlated EXISTS subqueries scanning store_sales, web_sales, and catalog_sales with similar filters.",
    "Each subquery joins date_dim and item with identical category and price ratio conditions.",
    "Materializing filtered sales data into CTEs can eliminate repeated dimension rescans."
  ],
  "target_ir": "Five CTEs added: date filter, store_sales revenue, store average revenue, filtered store_sales, filtered item; main query FROM replaced to use CTEs.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "date_filter",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 5+3"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "filtered_item",
        "cte_query_sql": "SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100"
      }
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "store_sales_filtered",
        "cte_query_sql": "SELECT ss_customer_sk, ss_item_sk, ss_sales_price, ss_list_price FROM store_sales WHERE EXISTS (SELECT 1 FROM date_filter df WHERE df.d_date_sk = ss_sold_date_sk) AND EXISTS (SELECT 1 FROM filtered_item fi WHERE fi.i_item_sk = ss_item_sk)"
      }
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "web_sales_filtered",
        "cte_query_sql": "SELECT ws_bill_customer_sk, ws_item_sk, ws_sales_price, ws_list_price FROM web_sales WHERE EXISTS (SELECT 1 FROM date_filter df WHERE df.d_date_sk = ws_sold_date_sk) AND EXISTS (SELECT 1 FROM filtered_item fi WHERE fi.i_item_sk = ws_item_sk)"
      }
    },
    {
      "step_id": "s5",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "catalog_sales_filtered",
        "cte_query_sql": "SELECT cs_ship_customer_sk, cs_item_sk, cs_sales_price, cs_list_price FROM catalog_sales WHERE EXISTS (SELECT 1 FROM date_filter df WHERE df.d_date_sk = cs_sold_date_sk) AND EXISTS (SELECT 1 FROM filtered_item fi WHERE fi.i_item_sk = cs_item_sk)"
      }
    },
    {
      "step_id": "s6",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk"
      }
    },
    {
      "step_id": "s7",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "ca.ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County') AND c.c_birth_month IN (4, 5) AND cd.cd_marital_status IN ('U', 'S', 'U') AND cd.cd_education_status IN ('College', 'Secondary', 'College') AND cd.cd_gender = 'M' AND EXISTS (SELECT 1 FROM store_sales_filtered ssf WHERE c.c_customer_sk = ssf.ss_customer_sk AND ssf.ss_sales_price / ssf.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) AND (EXISTS (SELECT 1 FROM web_sales_filtered wsf WHERE c.c_customer_sk = wsf.ws_bill_customer_sk AND wsf.ws_sales_price / wsf.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01) OR EXISTS (SELECT 1 FROM catalog_sales_filtered csf WHERE c.c_customer_sk = csf.cs_ship_customer_sk AND csf.cs_sales_price / csf.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01))"
      }
    }
  ]
}