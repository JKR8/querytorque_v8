[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "family": "A+B",
    "transform": "dimension_cte_isolate_with_sales_cte",
    "confidence": 0.75,
    "based_on": "p10,p08",
    "hypothesis": "Original plan shows nested loops with repeated dimension rescans. Creating filtered CTEs for date_dim and item dimensions reduces redundant scans. Converting EXISTS to semi-join CTEs with prefiltered dimensions avoids correlated execution while maintaining semantics.",
    "target_ir": "Main query with explicit joins and CTEs for dimensions/sales channels",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "sql_fragment": "WITH filtered_date AS (\n  SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8\n),\nfiltered_item AS (\n  SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100\n),\nstore_sales_cte AS (\n  SELECT ss_customer_sk\n  FROM store_sales\n  JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk\n  WHERE store_sales.ss_sales_price / store_sales.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n),\nweb_sales_cte AS (\n  SELECT ws_bill_customer_sk\n  FROM web_sales\n  JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk\n  WHERE web_sales.ws_sales_price / web_sales.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n),\ncatalog_sales_cte AS (\n  SELECT cs_ship_customer_sk\n  FROM catalog_sales\n  JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON catalog_sales.cs_item_sk = filtered_item.i_item_sk\n  WHERE catalog_sales.cs_sales_price / catalog_sales.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3,\n  cd_dep_count,\n  count(*) cnt4,\n  cd_dep_employed_count,\n  count(*) cnt5,\n  cd_dep_college_count,\n  count(*) cnt6\nFROM\n  customer c\n  JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\n  JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk\nWHERE\n  ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County')\n  AND c.c_birth_month IN (4, 5)\n  AND cd_marital_status IN ('U', 'S', 'U')\n  AND cd_education_status IN ('College', 'Secondary', 'College')\n  AND cd_gender = 'M'\n  AND EXISTS (SELECT 1 FROM store_sales_cte WHERE store_sales_cte.ss_customer_sk = c.c_customer_sk)\n  AND (EXISTS (SELECT 1 FROM web_sales_cte WHERE web_sales_cte.ws_bill_customer_sk = c.c_customer_sk)\n       OR EXISTS (SELECT 1 FROM catalog_sales_cte WHERE catalog_sales_cte.cs_ship_customer_sk = c.c_customer_sk))\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "family": "B+OR",
    "transform": "or_to_union_all",
    "confidence": 0.65,
    "based_on": "p04,p10",
    "hypothesis": "OR condition between web/catalog sales blocks efficient plans. Converting to UNION ALL with shared dimension CTEs enables independent index scans. Maintains EXISTS as semi-join while eliminating OR bottleneck.",
    "target_ir": "Main query with UNION ALL for OR branch and dimension CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "sql_fragment": "WITH filtered_date AS (\n  SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy BETWEEN 5 AND 8\n),\nfiltered_item AS (\n  SELECT i_item_sk FROM item WHERE i_category IN ('Children', 'Home', 'Women') AND i_manager_id BETWEEN 91 AND 100\n),\nstore_sales_cte AS (\n  SELECT ss_customer_sk\n  FROM store_sales\n  JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk\n  WHERE store_sales.ss_sales_price / store_sales.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n),\nunion_web_catalog AS (\n  SELECT ws_bill_customer_sk AS customer_sk\n  FROM web_sales\n  JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk\n  WHERE web_sales.ws_sales_price / web_sales.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n  UNION ALL\n  SELECT cs_ship_customer_sk\n  FROM catalog_sales\n  JOIN filtered_date ON catalog_sales.cs_sold_date_sk = filtered_date.d_date_sk\n  JOIN filtered_item ON catalog_sales.cs_item_sk = filtered_item.i_item_sk\n  WHERE catalog_sales.cs_sales_price / catalog_sales.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01\n)\nSELECT \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3,\n  cd_dep_count,\n  count(*) cnt4,\n  cd_dep_employed_count,\n  count(*) cnt5,\n  cd_dep_college_count,\n  count(*) cnt6\nFROM\n  customer c\n  JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\n  JOIN customer_demographics ON cd_demo_sk = c.c_current_cdemo_sk\nWHERE\n  ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County')\n  AND c.c_birth_month IN (4, 5)\n  AND cd_marital_status IN ('U', 'S', 'U')\n  AND cd_education_status IN ('College', 'Secondary', 'College')\n  AND cd_gender = 'M'\n  AND EXISTS (SELECT 1 FROM store_sales_cte WHERE store_sales_cte.ss_customer_sk = c.c_customer_sk)\n  AND EXISTS (SELECT 1 FROM union_web_catalog WHERE union_web_catalog.customer_sk = c.c_customer_sk)\nGROUP BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nORDER BY \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  cd_purchase_estimate,\n  cd_credit_rating,\n  cd_dep_count,\n  cd_dep_employed_count,\n  cd_dep_college_count\nLIMIT 100;"
        }
      }
    ]
  }
]