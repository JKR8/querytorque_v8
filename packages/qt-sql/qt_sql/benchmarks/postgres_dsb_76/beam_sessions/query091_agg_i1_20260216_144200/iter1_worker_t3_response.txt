{
  "plan_id": "agg_pushdown_to_fact_catalog_returns",
  "dialect": "postgres",
  "description": "Push aggregation to catalog_returns after joining with date_dim and call_center. Reduces input rows early before costly customer joins.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_date",
        "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998 AND d_moy = 2"
      },
      "description": "Insert CTE 'filtered_date' for date filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_cd",
        "cte_query_sql": "SELECT cd_demo_sk FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = 'Unknown') OR (cd_marital_status = 'W' AND cd_education_status = 'Advanced Degree')"
      },
      "description": "Insert CTE 'filtered_cd' for customer demographics filtering"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_hd",
        "cte_query_sql": "SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential LIKE '1001-5000%'"
      },
      "description": "Insert CTE 'filtered_hd' for household demographics filtering"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "agg_catalog_returns",
        "cte_query_sql": "SELECT cr_call_center_sk, cr_returning_customer_sk, SUM(cr_net_loss) AS Returns_Loss FROM catalog_returns JOIN filtered_date ON cr_returned_date_sk = filtered_date.d_date_sk GROUP BY cr_call_center_sk, cr_returning_customer_sk"
      },
      "description": "Insert aggregated CTE 'agg_catalog_returns' with early GROUP BY"
    },
    {
      "step_id": "s5",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "call_center JOIN agg_catalog_returns ON call_center.cc_call_center_sk = agg_catalog_returns.cr_call_center_sk JOIN customer ON agg_catalog_returns.cr_returning_customer_sk = customer.c_customer_sk JOIN filtered_cd ON customer.c_current_cdemo_sk = filtered_cd.cd_demo_sk JOIN filtered_hd ON customer.c_current_hdemo_sk = filtered_hd.hd_demo_sk JOIN customer_address ON customer.c_current_addr_sk = customer_address.ca_address_sk"
      },
      "description": "Replace FROM clause with CTE-based JOINs"
    },
    {
      "step_id": "s6",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "expr_sql": "customer_address.ca_gmt_offset = -7"
      },
      "description": "Replace WHERE predicate with simplified version"
    },
    {
      "step_id": "s7",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "ac46b9a793b959c6"
      },
      "payload": {
        "expr_sql": "call_center.cc_call_center_id, call_center.cc_name, call_center.cc_manager, SUM(agg_catalog_returns.Returns_Loss) AS Returns_Loss"
      },
      "description": "Update SELECT list to use aggregated CTE"
    }
  ]
}