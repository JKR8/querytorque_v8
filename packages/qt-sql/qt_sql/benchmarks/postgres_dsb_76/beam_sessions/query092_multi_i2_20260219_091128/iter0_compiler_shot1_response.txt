{
  "plan_id": "compile_p1",
  "dialect": "postgres",
  "confidence": 0.82,
  "based_on": "p01",
  "strategy": "Decorrelation via precomputed per-item average threshold CTE with explicit joins to resolve ambiguity.",
  "hypothesis": "Primary hotspot is correlated subquery re-executing 136 times. Probe p01 failed due to ambiguous column reference in comma joins. Fixed by converting to explicit joins and qualifying column references.",
  "expected_explain_delta": "SubPlan 1 (nested loop) replaced by single hash join to precomputed CTE; correlated execution eliminated.",
  "target_ir": "Add item_avg_discount CTE node and update final_select join structure.",
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["item_avg_discount", "web_sales", "item", "date_dim"],
        "outputs": ["Excess Discount Amount"],
        "changed": true,
        "sql": "WITH item_avg_discount AS (SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT sum(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales ws JOIN item i ON i.i_item_sk = ws.ws_item_sk JOIN date_dim d ON d.d_date_sk = ws.ws_sold_date_sk JOIN item_avg_discount avgd ON avgd.ws_item_sk = ws.ws_item_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND d.d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ws.ws_ext_discount_amt > avgd.threshold ORDER BY sum(ws.ws_ext_discount_amt) LIMIT 100"
      },
      {
        "node_id": "item_avg_discount",
        "parent_node_id": "final_select",
        "sources": ["web_sales", "date_dim"],
        "outputs": ["ws_item_sk", "threshold"],
        "changed": true,
        "sql": "SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk"
      }
    ]
  }
}