{
  "iteration": 0,
  "n_api_calls": 0,
  "beam_cost_usd": 0.0,
  "beam_cost_priced_calls": 0,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 0,
    "completion_tokens": 0,
    "total_tokens": 0,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 0
  },
  "best_speedup": 190.16,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH item_avg_discount AS (\n    SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM web_sales ws2\n    JOIN date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk\n    WHERE d2.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n      AND ws2.ws_wholesale_cost BETWEEN 35 AND 55\n      AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n    GROUP BY ws_item_sk\n)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales ws\nJOIN item i ON ws.ws_item_sk = i.i_item_sk\nJOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nLEFT JOIN item_avg_discount avgd ON ws.ws_item_sk = avgd.ws_item_sk\nWHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports'))\n  AND d.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\n  AND ws.ws_ext_discount_amt > avgd.threshold\nORDER BY SUM(ws.ws_ext_discount_amt)\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.6,
      "status": "WIN",
      "speedup": 45.06,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 6657.6,
      "output_sql": "WITH filtered_date AS (WITH filtered_date AS MATERIALIZED (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day') SELECT * FROM filtered_date), filtered_item AS (WITH filtered_item AS MATERIALIZED (SELECT i_item_sk, i_manufact_id, i_category FROM item WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports'))) SELECT * FROM filtered_item) SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales ws INNER JOIN filtered_item i ON i.i_item_sk = ws.ws_item_sk INNER JOIN filtered_date d ON d.d_date_sk = ws.ws_sold_date_sk WHERE ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ws.ws_ext_discount_amt > (SELECT 1.3 * AVG(ws2.ws_ext_discount_amt) FROM web_sales ws2 INNER JOIN filtered_date d2 ON d2.d_date_sk = ws2.ws_sold_date_sk WHERE ws2.ws_item_sk = i.i_item_sk AND d2.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day' AND ws2.ws_wholesale_cost BETWEEN 35 AND 55 AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 0.76 AND 0.91) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre-filter both date_dim and item into separate MATERIALIZED CTEs, then join with web_sales using explicit INNER JOINs. This isolates selective dimension filters early."
    },
    {
      "patch_id": "p02",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.7,
      "status": "WIN",
      "speedup": 19.09,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 15713.9,
      "output_sql": "WITH filtered_date_dim AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-29' AND cast('1999-01-29' as date) + interval '90 day'), main_join AS (SELECT ws.ws_ext_discount_amt, ws.ws_item_sk FROM web_sales ws INNER JOIN item i ON ws.ws_item_sk = i.i_item_sk INNER JOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND ws.ws_wholesale_cost BETWEEN 35 AND 55) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM main_join WHERE ws_ext_discount_amt > (SELECT 1.3 * avg(ws_ext_discount_amt) FROM web_sales ws2 JOIN filtered_date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk WHERE ws2.ws_item_sk = main_join.ws_item_sk AND ws2.ws_wholesale_cost BETWEEN 35 AND 55 AND (ws2.ws_sales_price / ws2.ws_list_price) BETWEEN 0.76 AND 0.91) ORDER BY sum(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Extract filtered date_dim into a MATERIALIZED CTE, convert comma joins to explicit INNER JOINs, and place the CTE early in the join order to reduce row flow."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.9,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "column reference \"i_item_sk\" is ambiguous\nLINE 1: ... OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk ...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH item_avg_discount AS (WITH item_avg_discount AS MATERIALIZED (SELECT ws_item_sk AS i_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales, date_dim WHERE d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT * FROM item_avg_discount) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales, item, date_dim, item_avg_discount WHERE (i_manufact_id BETWEEN 797 AND 996 OR i_category IN ('Men', 'Shoes', 'Sports')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_ext_discount_amt > item_avg_discount.threshold ORDER BY sum(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Replace correlated scalar subquery (SubPlan 1) with a MATERIALIZED CTE that precomputes per-item average discount for the filtered date range and wholesale cost, then join it as a non-correlated filter. Keep all existing predicates."
    },
    {
      "patch_id": "p04",
      "family": "D",
      "transform": "or_to_union",
      "relevance_score": 0.4,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "canceling statement due to statement timeout\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "select \n   sum(ws_ext_discount_amt)  as \"Excess Discount Amount\"\nfrom\n    web_sales\n   ,item\n   ,date_dim\nwhere\n(i_manufact_id BETWEEN 797 and 996\nor i_category IN ('Men', 'Shoes', 'Sports'))\nand i_item_sk = ws_item_sk\nand d_date between '1999-01-29' and\n        cast('1999-01-29' as date) + interval '90 day'\nand d_date_sk = ws_sold_date_sk\nand ws_wholesale_cost BETWEEN 35 AND 55\nand ws_ext_discount_amt\n     > (\n         SELECT\n            1.3 * avg(ws_ext_discount_amt)\n         FROM\n            web_sales\n           ,date_dim\n         WHERE\n              ws_item_sk = i_item_sk\n          and d_date between '1999-01-29' and\n                             cast('1999-01-29' as date) + interval '90 day'\n          and d_date_sk = ws_sold_date_sk\n          and ws_wholesale_cost BETWEEN 35 AND 55\n          and ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n  )\norder by sum(ws_ext_discount_amt)\nlimit 100;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Split the OR condition on item into two UNION branches (manufacturer range and category IN list) to allow separate index scans, then deduplicate with UNION (not UNION ALL) to preserve semantics."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 149.23,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 2010.3,
      "output_sql": "WITH item_avg_discount AS (SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND ws_wholesale_cost BETWEEN 35 AND 55 AND ws_sales_price / ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01 GROUP BY ws_item_sk) SELECT sum(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales ws JOIN item i ON i.i_item_sk = ws.ws_item_sk JOIN date_dim d ON d.d_date_sk = ws.ws_sold_date_sk JOIN item_avg_discount avgd ON avgd.ws_item_sk = ws.ws_item_sk WHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports')) AND d.d_date BETWEEN '1999-01-29' AND cast('1999-01-29' AS date) + interval '90 day' AND ws.ws_wholesale_cost BETWEEN 35 AND 55 AND ws.ws_ext_discount_amt > avgd.threshold ORDER BY sum(ws.ws_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 190.16,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1577.7,
      "output_sql": "WITH item_avg_discount AS (\n    SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM web_sales ws2\n    JOIN date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk\n    WHERE d2.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n      AND ws2.ws_wholesale_cost BETWEEN 35 AND 55\n      AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n    GROUP BY ws_item_sk\n)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales ws\nJOIN item i ON ws.ws_item_sk = i.i_item_sk\nJOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nLEFT JOIN item_avg_discount avgd ON ws.ws_item_sk = avgd.ws_item_sk\nWHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports'))\n  AND d.d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\n  AND ws.ws_ext_discount_amt > avgd.threshold\nORDER BY SUM(ws.ws_ext_discount_amt)\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p2",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 50.69,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 5918.9,
      "output_sql": "WITH filtered_date_dim AS (\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_date BETWEEN '1999-01-29' AND CAST('1999-01-29' AS DATE) + INTERVAL '90 day'\n)\nSELECT SUM(ws.ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM web_sales ws\nJOIN item i ON ws.ws_item_sk = i.i_item_sk\nJOIN filtered_date_dim d ON ws.ws_sold_date_sk = d.d_date_sk\nWHERE (i.i_manufact_id BETWEEN 797 AND 996 OR i.i_category IN ('Men', 'Shoes', 'Sports'))\n  AND ws.ws_wholesale_cost BETWEEN 35 AND 55\n  AND ws.ws_ext_discount_amt > (\n      SELECT 1.3 * AVG(ws2.ws_ext_discount_amt)\n      FROM web_sales ws2\n      JOIN filtered_date_dim d2 ON ws2.ws_sold_date_sk = d2.d_date_sk\n      WHERE ws2.ws_item_sk = i.i_item_sk\n        AND ws2.ws_wholesale_cost BETWEEN 35 AND 55\n        AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 76 * 0.01 AND 91 * 0.01\n  )\nORDER BY SUM(ws.ws_ext_discount_amt)\nLIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p03": "Limit  (cost=733680.59..733680.60 rows=1 width=32) (actual time=5400.377..5400.381 rows=1 loops=1)\n  CTE filtered_date\n    ->  CTE Scan on filtered_date  (cost=1705.31..1707.23 rows=96 width=8) (actual time=0.363..0.897 rows=91 loops=1)\n          CTE filtered_date\n            ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1705.31 rows=96 width=8) (actual time=0.363..0.878 rows=91 loops=1)\n                  Index Cond: ((d_date >= '1999-01-29'::date) AND (d_d",
    "p02": "Limit  (cost=265852763.48..265852763.48 rows=1 width=32) (actual time=11848.206..11848.210 rows=1 loops=1)\n  CTE filtered_date_dim\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1705.31 rows=96 width=4) (actual time=0.205..0.719 rows=91 loops=1)\n          Index Cond: ((d_date >= '1999-01-29'::date) AND (d_date <= '1999-04-29 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=265851058.17..265851058.18 rows=1 width=32) (actual time=11848.205..1184",
    "compile_p1": "Limit  (cost=31681.92..31681.93 rows=1 width=32) (actual time=1512.100..1512.162 rows=1 loops=1)\n  ->  Sort  (cost=31681.92..31681.93 rows=1 width=32) (actual time=1512.099..1512.160 rows=1 loops=1)\n        Sort Key: (sum(ws.ws_ext_discount_amt))\n        Sort Method: quicksort  Memory: 25kB\n        ->  Aggregate  (cost=31681.90..31681.91 rows=1 width=32) (actual time=1512.095..1512.156 rows=1 loops=1)\n              ->  Nested Loop  (cost=31592.66..31681.90 rows=1 width=6) (actual time=23.483..15",
    "compile_p2": "Limit  (cost=57239.75..57239.76 rows=1 width=32) (actual time=6205.293..6205.297 rows=1 loops=1)\n  CTE filtered_date_dim\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1705.31 rows=96 width=4) (actual time=0.421..0.992 rows=91 loops=1)\n          Index Cond: ((d_date >= '1999-01-29'::date) AND (d_date <= '1999-04-29 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=55534.45..55534.45 rows=1 width=32) (actual time=6205.292..6205.295 rows=1 loops=1"
  }
}