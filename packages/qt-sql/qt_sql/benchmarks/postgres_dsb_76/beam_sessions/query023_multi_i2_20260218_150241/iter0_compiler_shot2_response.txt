[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p01",
    "strategy": "Explicit join conversion with early date filter and final-select join decorrelation.",
    "hypothesis": "Winning probe p01 addressed frequent_ss_items comma-join hotspot (1.26x). Residual gap: final-select hash join consumes 10754 ms due to IN subqueries. Convert IN to explicit joins and pre-filter date_dim for final select branches to reduce scan volume.",
    "expected_explain_delta": "Nested loop in frequent_ss_items removed, final-select hash join with CTE scans replaced by earlier dimension filters and explicit join topology.",
    "target_ir": "Add filtered_date_dim CTE, rewrite frequent_ss_items with explicit joins, convert final-select IN subqueries to explicit joins with pre-filtered date_dim.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "date_dim_final", "frequent_ss_items", "best_ss_customer", "web_sales"],
          "outputs": ["SUM(sales)"],
          "changed": true,
          "sql": "SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales INNER JOIN date_dim_final ON cs_sold_date_sk = d_date_sk INNER JOIN frequent_ss_items fsi ON cs_item_sk = fsi.item_sk INNER JOIN best_ss_customer bsc ON cs_bill_customer_sk = bsc.c_customer_sk WHERE cs_wholesale_cost BETWEEN 26 AND 36 UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales INNER JOIN date_dim_final d ON ws_sold_date_sk = d.d_date_sk INNER JOIN frequent_ss_items fsi2 ON ws_item_sk = fsi2.item_sk INNER JOIN best_ss_customer bsc2 ON ws_bill_customer_sk = bsc2.c_customer_sk WHERE ws_wholesale_cost BETWEEN 26 AND 36) tmp2 LIMIT 100"
        },
        {
          "node_id": "date_dim_final",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999 AND d_moy = 5"
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "filtered_date_dim", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, count(*) AS cnt FROM store_sales INNER JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "frequent_ss_items",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": false
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "best_ss_customer",
          "sources": ["store_sales", "customer", "date_dim"],
          "outputs": ["tpcds_cmax"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p01,p03",
    "strategy": "Build on winning explicit join shape and fix aggregate pushdown error for best_ss_customer CTE.",
    "hypothesis": "Probe p03 attempted aggregate pushdown but failed with syntax error. Corrected version pre‑aggregates store_sales by customer key before joining with customer, preserving HAVING filter on scalar max_store_sales, while keeping p01's explicit join improvements.",
    "expected_explain_delta": "best_ss_customer aggregate input reduced from repeated store_sales index scans to a single grouped scan; final‑select join benefits from smaller CTE cardinality.",
    "target_ir": "Rewrite best_ss_customer node to pre‑aggregate store_sales, keep filtered_date_dim and explicit join in frequent_ss_items.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "date_dim", "web_sales", "best_ss_customer", "frequent_ss_items"],
          "outputs": ["SUM(sales)"],
          "changed": false
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "filtered_date_dim", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, count(*) AS cnt FROM store_sales INNER JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "frequent_ss_items",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": true,
          "sql": "SELECT c.c_customer_sk, SUM(ss.ss_quantity * ss.ss_sales_price) AS ssales FROM store_sales ss INNER JOIN customer c ON ss.ss_customer_sk = c.c_customer_sk WHERE c.c_birth_year BETWEEN 1987 AND 1993 GROUP BY c.c_customer_sk HAVING SUM(ss.ss_quantity * ss.ss_sales_price) > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)"
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "best_ss_customer",
          "sources": ["store_sales", "customer", "date_dim"],
          "outputs": ["tpcds_cmax"],
          "changed": false
        }
      ]
    }
  }
]