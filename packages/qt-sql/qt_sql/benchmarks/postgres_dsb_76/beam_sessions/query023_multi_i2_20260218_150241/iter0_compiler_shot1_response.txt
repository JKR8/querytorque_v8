[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.82,
    "based_on": "p01",
    "strategy": "Explicit join conversion with early date filter, preserving original CTE structure.",
    "hypothesis": "Probe p01 (WIN) showed 1.26x speedup by converting comma joins in frequent_ss_items to explicit INNER JOINs and pre‑filtering date_dim, reducing nested‑loop amplification and improving cardinality estimates.",
    "expected_explain_delta": "Nested Loop in frequent_ss_items becomes Hash Join; Seq Scan on item may become Index Scan; overall scan volume reduced.",
    "target_ir": "Add filtered_date_dim node, update frequent_ss_items join syntax and sources.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "date_dim", "web_sales", "best_ss_customer", "frequent_ss_items"],
          "outputs": ["SUM(sales)"],
          "changed": false
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "filtered_date_dim", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, count(*) AS cnt FROM store_sales INNER JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "frequent_ss_items",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "best_ss_customer",
          "sources": ["store_sales", "customer", "date_dim"],
          "outputs": ["tpcds_cmax"],
          "changed": false
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": false
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p01,p03",
    "strategy": "Extend explicit‑join conversion with decorrelated best_ss_customer and pre‑filtered date for final select.",
    "hypothesis": "Residual hotspot in best_ss_customer (9465 ms) remains unaddressed. Probe p03 attempted decorrelation but failed with syntax error; corrected version cross‑joins max_store_sales and groups by its column to avoid correlated subquery. Also pre‑filter date_dim for final select to push d_moy=5 earlier.",
    "expected_explain_delta": "Correlated subquery in best_ss_customer becomes CROSS JOIN + HAVING; final select date scans reduced; best_ss_customer aggregate time should drop.",
    "target_ir": "Add date_dim_final node, update best_ss_customer and max_store_sales to use filtered_date_dim, keep explicit joins in frequent_ss_items.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["catalog_sales", "date_dim_final", "web_sales", "best_ss_customer", "frequent_ss_items"],
          "outputs": ["SUM(sales)"],
          "changed": true,
          "sql": "SELECT SUM(sales) FROM (SELECT cs_quantity * cs_list_price AS sales FROM catalog_sales INNER JOIN date_dim_final ON cs_sold_date_sk = d_date_sk WHERE cs_wholesale_cost BETWEEN 26 AND 36 AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) UNION ALL SELECT ws_quantity * ws_list_price AS sales FROM web_sales INNER JOIN date_dim_final ON ws_sold_date_sk = d_date_sk WHERE ws_wholesale_cost BETWEEN 26 AND 36 AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)) AS tmp2 LIMIT 100"
        },
        {
          "node_id": "date_dim_final",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 5"
        },
        {
          "node_id": "frequent_ss_items",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "filtered_date_dim", "item"],
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "changed": true,
          "sql": "SELECT substring(i_item_desc,1,30) AS itemdesc, i_item_sk AS item_sk, d_date AS solddate, count(*) AS cnt FROM store_sales INNER JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id BETWEEN 44 AND 63 AND i_category IN ('Men', 'Music', 'Sports') GROUP BY substring(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4"
        },
        {
          "node_id": "filtered_date_dim",
          "parent_node_id": "frequent_ss_items",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk", "d_date"],
          "changed": true,
          "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 1999"
        },
        {
          "node_id": "max_store_sales",
          "parent_node_id": "best_ss_customer",
          "sources": ["store_sales", "customer", "filtered_date_dim"],
          "outputs": ["tpcds_cmax"],
          "changed": true,
          "sql": "SELECT MAX(csales) AS tpcds_cmax FROM (SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales INNER JOIN customer ON ss_customer_sk = c_customer_sk INNER JOIN filtered_date_dim ON ss_sold_date_sk = d_date_sk WHERE ss_wholesale_cost BETWEEN 26 AND 36 GROUP BY c_customer_sk) AS tmp1"
        },
        {
          "node_id": "best_ss_customer",
          "parent_node_id": "final_select",
          "sources": ["store_sales", "customer", "max_store_sales"],
          "outputs": ["c_customer_sk", "ssales"],
          "changed": true,
          "sql": "SELECT c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales INNER JOIN customer ON ss_customer_sk = c_customer_sk CROSS JOIN max_store_sales WHERE c_birth_year BETWEEN 1987 AND 1993 GROUP BY c_customer_sk, max_store_sales.tpcds_cmax HAVING SUM(ss_quantity * ss_sales_price) > (95/100.0) * tpcds_cmax"
        }
      ]
    }
  }
]