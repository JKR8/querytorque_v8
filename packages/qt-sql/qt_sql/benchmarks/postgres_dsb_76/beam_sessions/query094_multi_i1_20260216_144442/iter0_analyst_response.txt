## Analysis of Optimization Families

**Family A (Early Filtering)**: MEDIUM  
The query applies dimension filters (date_dim, customer_address, web_site) during joins, but could benefit from pushing these filters into CTEs earlier. However, the plan already shows predicate pushdown to dimension scans.

**Family B (Decorrelation)**: HIGH  
The EXISTS subquery scans web_sales per outer row (753 iterations). This is the primary bottleneck, confirmed by the nested loop and Index Scan on ws2 in the plan.

**Family C (Aggregation Pushdown)**: LOW  
No aggregation exists before the final SELECT. The query computes aggregates after all joins and filtering, with no opportunity for early aggregation.

**Family D (Set Operations)**: LOW  
No INTERSECT/UNION operations exist. The NOT EXISTS is already implemented via anti-join in the plan.

**Family E (Materialization)**: MEDIUM  
The same web_sales table is scanned twice (main query + EXISTS). Precomputing filtered web_sales could benefit both consumers.

**Family F (Join Transform)**: HIGH  
Comma joins obscure join relationships. Converting to explicit joins with optimal order (filtered dimensions first) could improve planning.

**Chosen families**: [B, F, E]  
**Confidence**: High (B), Medium (F, E)

---

## Optimization Targets

```json
[
  {
    "family": "B",
    "transform": "exists_to_join",
    "target_id": "t1",
    "relevance_score": 0.98,
    "hypothesis": "Correlated EXISTS subquery scans web_sales per outer row (753x). Convert to semi-join via pre-aggregated CTE of multi-warehouse orders.",
    "target_ir": "S0 [SELECT]\n  CTE: multi_warehouse_orders (via Q1)\n    SELECT ws_order_number\n    FROM web_sales\n    GROUP BY ws_order_number\n    HAVING COUNT(DISTINCT ws_warehouse_sk) > 1\n  MAIN QUERY (via Q0)\n    FROM: web_sales ws1\n      INNER JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk\n      INNER JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk\n      INNER JOIN web_site ON ws1.ws_web_site_sk = web_site_sk\n      INNER JOIN multi_warehouse_orders mwo ON ws1.ws_order_number = mwo.ws_order_number\n    WHERE: d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 DAY'\n      AND ca_state IN ('CA','MI','OH','SD','TX','VA')\n      AND web_gmt_offset >= -5\n      AND ws1.ws_list_price BETWEEN 237 AND 266\n      AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7,25,26,52,69))\n    ORDER BY COUNT(DISTINCT ws1.ws_order_number)\n    LIMIT 100;",
    "recommended_examples": ["pg_shared_scan_decorrelate"]
  },
  {
    "family": "F",
    "transform": "explicit_join_restructure",
    "target_id": "t2",
    "relevance_score": 0.85,
    "hypothesis": "Comma joins obscure join dependencies. Restructure with explicit joins and optimal order: filtered dimensions → web_sales → anti-join.",
    "target_ir": "S0 [SELECT]\n  MAIN QUERY (via Q0)\n    FROM: date_dim\n      INNER JOIN web_sales ws1 ON d_date_sk = ws1.ws_ship_date_sk\n      INNER JOIN customer_address ON ca_address_sk = ws1.ws_ship_addr_sk\n      INNER JOIN web_site ON web_site_sk = ws1.ws_web_site_sk\n      LEFT JOIN web_returns wr1 ON ws1.ws_order_number = wr1.wr_order_number \n        AND wr1.wr_reason_sk IN (7,25,26,52,69)\n    WHERE: d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 DAY'\n      AND ca_state IN ('CA','MI','OH','SD','TX','VA')\n      AND web_gmt_offset >= -5\n      AND ws1.ws_list_price BETWEEN 237 AND 266\n      AND wr1.wr_order_number IS NULL  -- NOT EXISTS replacement\n      AND EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n    ORDER BY COUNT(DISTINCT ws_order_number)\n    LIMIT 100;",
    "recommended_examples": ["pg_explicit_join_materialized"]
  },
  {
    "family": "E",
    "transform": "prefiltered_sales_cte",
    "target_id": "t3",
    "relevance_score": 0.80,
    "hypothesis": "Repeated web_sales scans (main + EXISTS) waste effort. Precompute filtered sales in CTE for reuse.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_sales (via Q1)\n    SELECT ws_order_number, ws_ext_ship_cost, ws_net_profit, ws_warehouse_sk\n    FROM web_sales ws\n      INNER JOIN date_dim ON ws_ship_date_sk = d_date_sk\n      INNER JOIN customer_address ON ws_ship_addr_sk = ca_address_sk\n      INNER JOIN web_site ON ws_web_site_sk = web_site_sk\n    WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 DAY'\n      AND ca_state IN ('CA','MI','OH','SD','TX','VA')\n      AND web_gmt_offset >= -5\n      AND ws_list_price BETWEEN 237 AND 266\n  MAIN QUERY (via Q0)\n    SELECT \n      COUNT(DISTINCT fs1.ws_order_number) AS \"order count\",\n      SUM(fs1.ws_ext_ship_cost) AS \"total shipping cost\",\n      SUM(fs1.ws_net_profit) AS \"total net profit\"\n    FROM filtered_sales fs1\n    WHERE EXISTS (SELECT 1 FROM filtered_sales fs2 \n                  WHERE fs1.ws_order_number = fs2.ws_order_number \n                  AND fs1.ws_warehouse_sk <> fs2.ws_warehouse_sk)\n      AND NOT EXISTS (SELECT 1 FROM web_returns wr1 \n                      WHERE fs1.ws_order_number = wr1.wr_order_number \n                      AND wr1.wr_reason_sk IN (7,25,26,52,69))\n    ORDER BY COUNT(DISTINCT fs1.ws_order_number)\n    LIMIT 100;",
    "recommended_examples": ["multi_dimension_prefetch"]
  }
]
```