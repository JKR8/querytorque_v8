Worker Role: W3
Family: F+E
Transform: explicit_join_restructure+prefiltered_sales_cte
Status: OK

--- OUTPUT SQL ---
WITH filtered_sales AS (SELECT ws_order_number, ws_ext_ship_cost, ws_net_profit, ws_warehouse_sk FROM web_sales AS ws INNER JOIN date_dim ON ws_ship_date_sk = d_date_sk INNER JOIN customer_address ON ws_ship_addr_sk = ca_address_sk INNER JOIN web_site ON ws_web_site_sk = web_site_sk WHERE d_date BETWEEN '2002-9-01' AND CAST('2002-9-01' AS DATE) + INTERVAL '60 DAY' AND ca_state IN ('CA', 'MI', 'OH', 'SD', 'TX', 'VA') AND web_gmt_offset >= -5 AND ws_list_price BETWEEN 237 AND 266) SELECT COUNT(DISTINCT fs1.ws_order_number) AS "order count", SUM(fs1.ws_ext_ship_cost) AS "total shipping cost", SUM(fs1.ws_net_profit) AS "total net profit" FROM filtered_sales AS fs1 WHERE EXISTS(SELECT 1 FROM filtered_sales AS fs2 WHERE fs1.ws_order_number = fs2.ws_order_number AND fs1.ws_warehouse_sk <> fs2.ws_warehouse_sk) AND NOT EXISTS(SELECT 1 FROM web_returns AS wr1 WHERE fs1.ws_order_number = wr1.wr_order_number AND wr1.wr_reason_sk IN (7, 25, 26, 52, 69)) ORDER BY COUNT(DISTINCT fs1.ws_order_number) LIMIT 100;