[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.65,
    "based_on": "p01",
    "strategy": "Explicit JOIN syntax with selective date CTE to improve join order flexibility and early filtering.",
    "hypothesis": "Primary hotspot is nested loop between date_dim and store_sales. Converting comma joins to explicit JOIN syntax and isolating filtered date_dim rows enables better join reordering. This matches p01's neutral 1.02x result but addresses syntax issues.",
    "expected_explain_delta": "Nested Loop replaced by Hash Join; date filter applied earliest; better cardinality estimates for dimension joins.",
    "target_ir": "Replace comma joins with explicit JOINs and add date_cte node.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "date_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store", "customer_demographics", "household_demographics", "customer_address", "date_cte"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales INNER JOIN store ON s_store_sk = ss_store_sk INNER JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk INNER JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk INNER JOIN customer_address ON ss_addr_sk = ca_address_sk INNER JOIN date_cte ON ss_sold_date_sk = date_cte.d_date_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.55,
    "based_on": "p02",
    "strategy": "Pre-filter dimensions in separate CTEs to reduce rows before joining, correcting column reference error in customer_address CTE.",
    "hypothesis": "Secondary hotspots are hash joins with household_demographics and store. Pre-filtering all dimensions reduces rows entering the main join. This addresses p02's syntax error by selecting ca_address_sk and moving OR filters to WHERE.",
    "expected_explain_delta": "Hash Join inputs shrink; Nested Loop may be eliminated; index scans on dimension tables become more selective.",
    "target_ir": "Add filtered CTE nodes for date_dim, household_demographics, store, customer_demographics, customer_address; join with store_sales.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "date_dim_filtered",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "household_demographics_filtered",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk", "hd_dep_count"],
          "changed": true,
          "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3, 1)"
        },
        {
          "node_id": "store_filtered",
          "parent_node_id": "final_select",
          "sources": ["store"],
          "outputs": ["s_store_sk"],
          "changed": true,
          "sql": "SELECT s_store_sk FROM store"
        },
        {
          "node_id": "customer_demographics_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'M' AND cd_education_status = '2 yr Degree') OR (cd_marital_status = 'U' AND cd_education_status = 'College') OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown')"
        },
        {
          "node_id": "customer_address_filtered",
          "parent_node_id": "final_select",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk", "ca_country", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX', 'AR', 'NY', 'IA', 'IL')"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "date_dim_filtered", "household_demographics_filtered", "store_filtered", "customer_demographics_filtered", "customer_address_filtered"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales JOIN store_filtered ON ss_store_sk = s_store_sk JOIN date_dim_filtered ON ss_sold_date_sk = d_date_sk JOIN household_demographics_filtered ON ss_hdemo_sk = hd_demo_sk JOIN customer_demographics_filtered ON ss_cdemo_sk = cd_demo_sk JOIN customer_address_filtered ON ss_addr_sk = ca_address_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  }
]