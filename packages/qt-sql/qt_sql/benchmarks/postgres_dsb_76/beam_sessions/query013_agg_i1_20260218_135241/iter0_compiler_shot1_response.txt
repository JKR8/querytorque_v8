[
  {
    "plan_id": "compile_p1",
    "dialect": "postgres",
    "confidence": 0.70,
    "based_on": "p01",
    "strategy": "Explicit join conversion with date CTE to improve join ordering and predicate pushdown.",
    "hypothesis": "Probe p01 showed slight speedup by converting comma joins to explicit INNER JOIN and isolating date filter. This addresses primary hotspot by enabling better join reordering and early date filter application.",
    "expected_explain_delta": "Nested Loop between date_dim and store_sales should reduce rows; explicit joins may improve hash join order.",
    "target_ir": "Convert final_select to explicit JOIN syntax with date CTE.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store", "household_demographics", "customer_demographics", "customer_address", "date_cte"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "WITH date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001) SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales INNER JOIN store ON s_store_sk = ss_store_sk INNER JOIN household_demographics ON ss_hdemo_sk = hd_demo_sk INNER JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk INNER JOIN customer_address ON ss_addr_sk = ca_address_sk INNER JOIN date_cte ON ss_sold_date_sk = date_cte.d_date_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  },
  {
    "plan_id": "compile_p2",
    "dialect": "postgres",
    "confidence": 0.60,
    "based_on": "p02,p03",
    "strategy": "Multi-dimension pre‑filtering with CTEs to push selective OR predicates early.",
    "hypothesis": "Residual gap: late index scans on customer_demographics and customer_address filter to 0 rows after large joins. Pre‑filtering these dimensions with independent conditions reduces rows flowing into the fact join, addressing secondary hotspot.",
    "expected_explain_delta": "Hash Joins with household_demographics and store should shrink; index scans on customer_demographics and customer_address may disappear or move earlier.",
    "target_ir": "Add CTEs for date, household_demographics, customer_demographics, customer_address; final_select joins CTEs with store_sales and store.",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "date_cte",
          "parent_node_id": "final_select",
          "sources": ["date_dim"],
          "outputs": ["d_date_sk"],
          "changed": true,
          "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001"
        },
        {
          "node_id": "hd_cte",
          "parent_node_id": "final_select",
          "sources": ["household_demographics"],
          "outputs": ["hd_demo_sk", "hd_dep_count"],
          "changed": true,
          "sql": "SELECT hd_demo_sk, hd_dep_count FROM household_demographics WHERE hd_dep_count IN (3,1)"
        },
        {
          "node_id": "cd_cte",
          "parent_node_id": "final_select",
          "sources": ["customer_demographics"],
          "outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"],
          "changed": true,
          "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status, cd_education_status) IN (('M','2 yr Degree'), ('U','College'), ('S','Unknown'))"
        },
        {
          "node_id": "ca_cte",
          "parent_node_id": "final_select",
          "sources": ["customer_address"],
          "outputs": ["ca_address_sk", "ca_country", "ca_state"],
          "changed": true,
          "sql": "SELECT ca_address_sk, ca_country, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX', 'AR', 'NY', 'IA', 'IL')"
        },
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": ["store_sales", "store", "date_cte", "hd_cte", "cd_cte", "ca_cte"],
          "outputs": ["avg(ss_quantity)", "avg(ss_ext_sales_price)", "avg(ss_ext_wholesale_cost)", "sum(ss_ext_wholesale_cost)"],
          "changed": true,
          "sql": "SELECT avg(ss_quantity), avg(ss_ext_sales_price), avg(ss_ext_wholesale_cost), sum(ss_ext_wholesale_cost) FROM store_sales JOIN store ON s_store_sk = ss_store_sk JOIN date_cte ON ss_sold_date_sk = date_cte.d_date_sk JOIN hd_cte ON ss_hdemo_sk = hd_cte.hd_demo_sk JOIN cd_cte ON ss_cdemo_sk = cd_cte.cd_demo_sk JOIN ca_cte ON ss_addr_sk = ca_cte.ca_address_sk WHERE ((cd_marital_status = 'M' AND cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3) OR (cd_marital_status = 'U' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1) OR (cd_marital_status = 'S' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1)) AND ((ca_country = 'United States' AND ca_state IN ('CO', 'NC', 'TX') AND ss_net_profit BETWEEN 100 AND 200) OR (ca_country = 'United States' AND ca_state IN ('AR', 'NY', 'TX') AND ss_net_profit BETWEEN 150 AND 300) OR (ca_country = 'United States' AND ca_state IN ('IA', 'IL', 'NC') AND ss_net_profit BETWEEN 50 AND 250))"
        }
      ]
    }
  }
]