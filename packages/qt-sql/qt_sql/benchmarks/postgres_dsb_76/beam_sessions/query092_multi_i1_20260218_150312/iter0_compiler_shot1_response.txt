```json
{
  "plan_id": "compile_p1",
  "dialect": "postgres",
  "confidence": 0.85,
  "based_on": "p01",
  "strategy": "Decorrelate scalar aggregate subquery by precomputing per-item thresholds in CTE, then join.",
  "hypothesis": "Correlated subquery (SubPlan 1) executes per outer row after hash join, causing repeated nested loops. Precomputing thresholds for all items eliminates per-row execution while preserving semantics via LEFT JOIN.",
  "expected_explain_delta": "SubPlan 1 removed; replaced by single aggregate over web_sales+date_dim, then hash join with main query.",
  "target_ir": "Replace correlated subquery with precomputed threshold CTE and join.",
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["Excess Discount Amount"],
        "changed": true,
        "sql": "WITH threshold_by_item AS (\n    SELECT \n        ws_item_sk,\n        1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM \n        web_sales\n        JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    WHERE \n        d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n        AND ws_wholesale_cost BETWEEN 16 AND 36\n        AND ws_sales_price / ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01\n    GROUP BY \n        ws_item_sk\n)\nSELECT \n    SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM \n    web_sales\n    JOIN item ON i_item_sk = ws_item_sk\n    JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    LEFT JOIN threshold_by_item ON threshold_by_item.ws_item_sk = web_sales.ws_item_sk\nWHERE \n    (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))\n    AND d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n    AND ws_wholesale_cost BETWEEN 16 AND 36\n    AND ws_ext_discount_amt > threshold_by_item.threshold\nORDER BY \n    SUM(ws_ext_discount_amt)\nLIMIT 100"
      }
    ]
  }
}
```