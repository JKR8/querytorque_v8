{
  "plan_id": "w2_unnester_agg_store_sk_prefetch_partial_agg_store_key",
  "dialect": "postgres",
  "description": "Prefetch date pairs and pre-aggregate facts by ss_store_sk before joining to store. Pre-aggregate facts by ss_store_sk before store join to reduce 52K-row Aggregate input. Uses store key as proxy for store attributes to avoid early bloating.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_return_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000 AND d_moy = 8"
      },
      "description": "Insert CTE 'filtered_return_dates' for return date filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "prefetch_date_pairs",
        "cte_query_sql": "SELECT d2.d_date_sk as return_date_sk, d1.d_date_sk as sold_date_sk FROM filtered_return_dates d2, date_dim d1 WHERE d1.d_date BETWEEN (d2.d_date - interval '120 day') AND d2.d_date"
      },
      "description": "Insert CTE 'prefetch_date_pairs' to precompute valid date pairs"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "partial_agg_store_key",
        "cte_query_sql": "SELECT ss_store_sk, sr_returned_date_sk, ss_sold_date_sk, COUNT(*) as cnt FROM store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk AND ss_customer_sk = sr_customer_sk JOIN prefetch_date_pairs ON ss_sold_date_sk = sold_date_sk AND sr_returned_date_sk = return_date_sk GROUP BY ss_store_sk, sr_returned_date_sk, ss_sold_date_sk"
      },
      "description": "Insert CTE 'partial_agg_store_key' to pre-aggregate by store key"
    },
    {
      "step_id": "s4",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "partial_agg_store_key pag JOIN store s ON pag.ss_store_sk = s.s_store_sk"
      },
      "description": "Replace FROM clause with pre-aggregated CTE and store join"
    },
    {
      "step_id": "s5",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "b621d655cfd44fb4"
      },
      "payload": {
        "expr_sql": "TRUE"
      },
      "description": "Replace WHERE clause (conditions moved to CTEs)"
    },
    {
      "step_id": "s6",
      "op": "replace_expr_subtree",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "b621d655cfd44fb4"
      },
      "payload": {
        "expr_sql": "sum(case when (sr_returned_date_sk - ss_sold_date_sk <= 30 ) then cnt else 0 end) as \"30 days\", sum(case when (sr_returned_date_sk - ss_sold_date_sk > 30) and (sr_returned_date_sk - ss_sold_date_sk <= 60) then cnt else 0 end ) as \"31-60 days\", sum(case when (sr_returned_date_sk - ss_sold_date_sk > 60) and (sr_returned_date_sk - ss_sold_date_sk <= 90) then cnt else 0 end) as \"61-90 days\", sum(case when (sr_returned_date_sk - ss_sold_date_sk > 90) and (sr_returned_date_sk - ss_sold_date_sk <= 120) then cnt else 0 end) as \"91-120 days\", sum(case when (sr_returned_date_sk - ss_sold_date_sk > 120) then cnt else 0 end) as \">120 days\""
      },
      "description": "Replace aggregation expressions to use pre-counted values"
    }
  ]
}