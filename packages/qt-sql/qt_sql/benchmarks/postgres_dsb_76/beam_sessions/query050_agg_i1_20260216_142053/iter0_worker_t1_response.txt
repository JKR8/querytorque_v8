{
  "plan_id": "postgres_explicit_join_materialized_w4",
  "dialect": "postgres",
  "description": "Convert implicit cross joins to explicit INNER JOINs with prefiltered CTEs for date dimensions and fact tables. Materializes filtered date ranges and sales/returns data to reduce intermediate row counts and enable better join ordering.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d2_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000 AND d_moy = 8"
      },
      "description": "Insert CTE 'd2_dates' for return date filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d1_date_bounds",
        "cte_query_sql": "SELECT min(d_date) as min_d2_date, max(d_date) as max_d2_date FROM d2_dates"
      },
      "description": "Insert CTE 'd1_date_bounds' to compute sold date range limits"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d1_dates",
        "cte_query_sql": "SELECT d_date_sk, d_date FROM date_dim, d1_date_bounds WHERE d_date BETWEEN (min_d2_date - interval '120 day') AND max_d2_date"
      },
      "description": "Insert CTE 'd1_dates' for sold date filtering"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_sales",
        "cte_query_sql": "SELECT ss_ticket_number, ss_item_sk, ss_customer_sk, ss_store_sk, d1_dates.d_date as sold_date, ss_sold_date_sk FROM store_sales INNER JOIN d1_dates ON store_sales.ss_sold_date_sk = d1_dates.d_date_sk"
      },
      "description": "Insert CTE 'filtered_sales' with prejoined sold dates"
    },
    {
      "step_id": "s5",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_returns",
        "cte_query_sql": "SELECT sr_ticket_number, sr_item_sk, sr_customer_sk, d2_dates.d_date as return_date, sr_returned_date_sk FROM store_returns INNER JOIN d2_dates ON store_returns.sr_returned_date_sk = d2_dates.d_date_sk"
      },
      "description": "Insert CTE 'filtered_returns' with prejoined return dates"
    },
    {
      "step_id": "s6",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "filtered_sales INNER JOIN filtered_returns ON filtered_sales.ss_ticket_number = filtered_returns.sr_ticket_number AND filtered_sales.ss_item_sk = filtered_returns.sr_item_sk AND filtered_sales.ss_customer_sk = filtered_returns.sr_customer_sk INNER JOIN store ON filtered_sales.ss_store_sk = store.s_store_sk"
      },
      "description": "Replace FROM clause with explicit INNER JOINs using filtered CTEs"
    },
    {
      "step_id": "s7",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0",
        "by_anchor_hash": "b621d655cfd44fb4"
      },
      "payload": {
        "expr_sql": "filtered_sales.sold_date BETWEEN (filtered_returns.return_date - interval '120 day') AND filtered_returns.return_date"
      },
      "description": "Replace WHERE clause with date range condition between sold and return dates"
    }
  ]
}