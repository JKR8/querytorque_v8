{
  "plan_id": "postgres_unnester_decorrelate",
  "dialect": "postgres",
  "description": "Decompose correlated date filtering and sales/returns joins into CTEs to eliminate per-row re-execution and simplify aggregation.",
  "preconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "postconditions": [
    {
      "kind": "parse_ok"
    }
  ],
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d2_dates",
        "cte_query_sql": "SELECT * FROM date_dim WHERE d_year = 2000 AND d_moy = 8"
      },
      "description": "Insert CTE 'd2_dates' for August 2000 date filtering"
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d1_date_bounds",
        "cte_query_sql": "SELECT min(d_date) as min_d2_date, max(d_date) as max_d2_date FROM d2_dates"
      },
      "description": "Insert CTE 'd1_date_bounds' to compute min and max dates from d2_dates"
    },
    {
      "step_id": "s3",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "d1_dates",
        "cte_query_sql": "SELECT * FROM date_dim WHERE d_date BETWEEN (SELECT min_d2_date - interval '120 day' FROM d1_date_bounds) AND (SELECT max_d2_date FROM d1_date_bounds)"
      },
      "description": "Insert CTE 'd1_dates' for date range filtering based on d2 dates"
    },
    {
      "step_id": "s4",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_sales",
        "cte_query_sql": "SELECT ss_ticket_number, ss_item_sk, ss_customer_sk, ss_store_sk, d1_dates.d_date as sold_date FROM store_sales INNER JOIN d1_dates ON store_sales.ss_sold_date_sk = d1_dates.d_date_sk"
      },
      "description": "Insert CTE 'filtered_sales' to pre-filter store_sales by d1_dates"
    },
    {
      "step_id": "s5",
      "op": "insert_cte",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "cte_name": "filtered_returns",
        "cte_query_sql": "SELECT sr_ticket_number, sr_item_sk, sr_customer_sk, d2_dates.d_date as return_date FROM store_returns INNER JOIN d2_dates ON store_returns.sr_returned_date_sk = d2_dates.d_date_sk"
      },
      "description": "Insert CTE 'filtered_returns' to pre-filter store_returns by d2_dates"
    },
    {
      "step_id": "s6",
      "op": "replace_from",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "from_sql": "filtered_sales INNER JOIN filtered_returns ON filtered_sales.ss_ticket_number = filtered_returns.sr_ticket_number AND filtered_sales.ss_item_sk = filtered_returns.sr_item_sk AND filtered_sales.ss_customer_sk = filtered_returns.sr_customer_sk INNER JOIN store ON filtered_sales.ss_store_sk = store.s_store_sk"
      },
      "description": "Replace FROM clause with explicit JOINs using filtered CTEs"
    },
    {
      "step_id": "s7",
      "op": "replace_where_predicate",
      "target": {
        "by_node_id": "S0"
      },
      "payload": {
        "expr_sql": "filtered_sales.sold_date BETWEEN (filtered_returns.return_date - interval '120 day') AND filtered_returns.return_date"
      },
      "description": "Replace WHERE clause with simplified date range condition"
    }
  ]
}