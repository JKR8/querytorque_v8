{
  "probe_id": "p12",
  "transform_id": "multi_intersect_exists_cte",
  "family": "D",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Replacing INTERSECT with EXISTS semi-joins and shared CTEs reduces redundant scans and avoids full materialization. Pre-materializing filtered date_dim and customer once enables reuse across channels.",
  "reasoning_trace": [
    "Assigned transform targets INTERSECT bottleneck; plan shows 3Ã— date_dim and customer scans.",
    "Shared filters on date_dim (d_month_seq) and customer (c_birth_month) can be precomputed.",
    "Each sales channel branch becomes an EXISTS subquery referencing shared CTEs.",
    "Final DISTINCT and LIMIT preserved in top-level SELECT."
  ],
  "target_ir": "Three CTEs added: filtered_date, filtered_customer, and channel_exists. Main query uses EXISTS per channel.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["count(*)"],
        "changed": true,
        "sql": "WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1211), filtered_customer AS (SELECT c_customer_sk FROM customer WHERE c_birth_month IN (1,2,5,12)), channel_exists AS (SELECT 'store' AS channel, ss_customer_sk, ss_sold_date_sk FROM store_sales WHERE ss_list_price BETWEEN 193 AND 252 AND ss_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT 'catalog' AS channel, cs_bill_customer_sk, cs_sold_date_sk FROM catalog_sales WHERE cs_list_price BETWEEN 193 AND 252 AND cs_wholesale_cost BETWEEN 35 AND 55 UNION ALL SELECT 'web' AS channel, ws_bill_customer_sk, ws_sold_date_sk FROM web_sales WHERE ws_list_price BETWEEN 193 AND 252 AND ws_wholesale_cost BETWEEN 35 AND 55) SELECT COUNT(*) FROM (SELECT DISTINCT c.c_last_name, c.c_first_name, d.d_date FROM filtered_customer fc JOIN customer c ON fc.c_customer_sk = c.c_customer_sk CROSS JOIN filtered_date fd JOIN date_dim d ON fd.d_date_sk = d.d_date_sk WHERE EXISTS (SELECT 1 FROM channel_exists ce WHERE ce.ss_customer_sk = fc.c_customer_sk AND ce.ss_sold_date_sk = fd.d_date_sk AND ce.channel = 'store') AND EXISTS (SELECT 1 FROM channel_exists ce WHERE ce.ss_customer_sk = fc.c_customer_sk AND ce.ss_sold_date_sk = fd.d_date_sk AND ce.channel = 'catalog') AND EXISTS (SELECT 1 FROM channel_exists ce WHERE ce.ss_customer_sk = fc.c_customer_sk AND ce.ss_sold_date_sk = fd.d_date_sk AND ce.channel = 'web')) hot_cust LIMIT 100"
      }
    ]
  }
}