{
  "probe_id": "p12",
  "transform_id": "date_cte_explicit_join",
  "family": "F",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing filtered date_dim into a CTE and converting comma joins to explicit JOIN syntax improves join planning and enables better hash join selection.",
  "reasoning_trace": [
    "Assigned transform targets comma-join pattern with correlated scalar subquery.",
    "CTE materialization isolates selective date filter for reuse in main query and subquery.",
    "Explicit JOIN syntax allows PostgreSQL planner to better estimate and reorder joins.",
    "No semantic drift introduced; all original filters preserved."
  ],
  "target_ir": "date_dim filtered into CTE; FROM clause converted to explicit JOINs; correlated subquery updated to reference new CTE.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": [],
        "outputs": ["Excess Discount Amount"],
        "changed": true,
        "sql": "WITH filtered_date_dim AS (\n  SELECT d_date_sk\n  FROM date_dim\n  WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n)\nSELECT \n   sum(ws_ext_discount_amt)  as \"Excess Discount Amount\"\nFROM\n    web_sales\n    JOIN item ON i_item_sk = ws_item_sk\n    JOIN filtered_date_dim ON d_date_sk = ws_sold_date_sk\nWHERE\n(\n  i_manufact_id BETWEEN 566 and 765\n  OR i_category IN ('Children', 'Jewelry', 'Men')\n)\nAND ws_wholesale_cost BETWEEN 16 AND 36\nAND ws_ext_discount_amt\n     > (\n         SELECT\n            1.3 * avg(ws_ext_discount_amt)\n         FROM\n            web_sales ws2\n            JOIN filtered_date_dim fdd2 ON fdd2.d_date_sk = ws2.ws_sold_date_sk\n         WHERE\n              ws2.ws_item_sk = item.i_item_sk\n          AND ws2.ws_wholesale_cost BETWEEN 16 AND 36\n          AND ws2.ws_sales_price / ws2.ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01\n  )\nORDER BY sum(ws_ext_discount_amt)\nLIMIT 100;"
      }
    ]
  }
}