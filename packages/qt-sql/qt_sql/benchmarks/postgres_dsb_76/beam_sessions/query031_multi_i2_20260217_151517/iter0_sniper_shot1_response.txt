[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p02,p03,p07,p10",
    "strategy": "Pre-filter dimensions and use explicit joins to reduce fact table scans",
    "hypothesis": "Original comma-joins cause full fact scans before dimension filters. Pre-filtering item/customer_address into CTEs and using explicit joins should allow predicate pushdown and index usage on dimensions. Pushing d_year=1999 into CTEs reduces data volume.",
    "target_ir": "CTEs for filtered dimensions + explicit INNER JOINs in ss/ws CTEs",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_block_with_cte_pair",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34), filtered_ca AS (SELECT ca_address_sk FROM customer_address WHERE ca_state IN ('KS','OH')), ss AS (SELECT ca_county, d_qoy, d_year, SUM(ss_ext_sales_price) AS store_sales FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN filtered_ca ON ss_addr_sk = ca_address_sk INNER JOIN filtered_item ON ss_item_sk = i_item_sk WHERE ss_list_price BETWEEN 244 AND 258 AND d_year = 1999 GROUP BY ca_county, d_qoy, d_year), ws AS (SELECT ca_county, d_qoy, d_year, SUM(ws_ext_sales_price) AS web_sales FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN filtered_ca ON ws_bill_addr_sk = ca_address_sk INNER JOIN filtered_item ON ws_item_sk = i_item_sk WHERE ws_list_price BETWEEN 244 AND 258 AND d_year = 1999 GROUP BY ca_county, d_qoy, d_year) SELECT ss1.ca_county, ss1.d_year, ws2.web_sales/ws1.web_sales web_q1_q2_increase, ss2.store_sales/ss1.store_sales store_q1_q2_increase, ws3.web_sales/ws2.web_sales web_q2_q3_increase, ss3.store_sales/ss2.store_sales store_q2_q3_increase FROM ss ss1, ss ss2, ss ss3, ws ws1, ws ws2, ws ws3 WHERE ss1.d_qoy = 1 AND ss1.d_year = 1999 AND ss1.ca_county = ss2.ca_county AND ss2.d_qoy = 2 AND ss2.d_year = 1999 AND ss2.ca_county = ss3.ca_county AND ss3.d_qoy = 3 AND ss3.d_year = 1999 AND ss1.ca_county = ws1.ca_county AND ws1.d_qoy = 1 AND ws1.d_year = 1999 AND ws1.ca_county = ws2.ca_county AND ws2.d_qoy = 2 AND ws2.d_year = 1999 AND ws1.ca_county = ws3.ca_county AND ws3.d_qoy = 3 AND ws3.d_year =1999 AND CASE WHEN ws1.web_sales > 0 THEN ws2.web_sales/ws1.web_sales ELSE null END > CASE WHEN ss1.store_sales > 0 THEN ss2.store_sales/ss1.store_sales ELSE null END AND CASE WHEN ws2.web_sales > 0 THEN ws3.web_sales/ws2.web_sales ELSE null END > CASE WHEN ss2.store_sales > 0 THEN ss3.store_sales/ss2.store_sales ELSE null END ORDER BY ss1.d_year;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p05,p12",
    "strategy": "Single-pass quarterly aggregation to avoid self-joins",
    "hypothesis": "Self-joins on large CTEs cause rescans. Computing quarterly aggregates in single-pass CTEs reduces data movement. Pre-filtering dimensions and d_year=1999 minimizes input size.",
    "target_ir": "Restructured CTEs with CASE-based quarterly aggregates + simplified main query",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_block_with_cte_pair",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH ss AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy=1 THEN ss_ext_sales_price ELSE 0 END) AS q1, SUM(CASE WHEN d_qoy=2 THEN ss_ext_sales_price ELSE 0 END) AS q2, SUM(CASE WHEN d_qoy=3 THEN ss_ext_sales_price ELSE 0 END) AS q3 FROM store_sales INNER JOIN date_dim ON ss_sold_date_sk = d_date_sk INNER JOIN customer_address ON ss_addr_sk = ca_address_sk INNER JOIN item ON ss_item_sk = i_item_sk WHERE i_color IN ('dark','puff') AND i_manager_id BETWEEN 15 AND 34 AND ss_list_price BETWEEN 244 AND 258 AND ca_state IN ('KS','OH') AND d_year=1999 GROUP BY ca_county, d_year), ws AS (SELECT ca_county, d_year, SUM(CASE WHEN d_qoy=1 THEN ws_ext_sales_price ELSE 0 END) AS q1, SUM(CASE WHEN d_qoy=2 THEN ws_ext_sales_price ELSE 0 END) AS q2, SUM(CASE WHEN d_qoy=3 THEN ws_ext_sales_price ELSE 0 END) AS q3 FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN customer_address ON ws_bill_addr_sk = ca_address_sk INNER JOIN item ON ws_item_sk = i_item_sk WHERE i_color IN ('dark','puff') AND i_manager_id BETWEEN 15 AND 34 AND ws_list_price BETWEEN 244 AND 258 AND ca_state IN ('KS','OH') AND d_year=1999 GROUP BY ca_county, d_year) SELECT ss.ca_county, ss.d_year, ws.q2/ws.q1 AS web_q1_q2_increase, ss.q2/ss.q1 AS store_q1_q2_increase, ws.q3/ws.q2 AS web_q2_q3_increase, ss.q3/ss.q2 AS store_q2_q3_increase FROM ss INNER JOIN ws ON ss.ca_county = ws.ca_county AND ss.d_year = ws.d_year WHERE CASE WHEN ws.q1 > 0 THEN ws.q2/ws.q1 ELSE NULL END > CASE WHEN ss.q1 > 0 THEN ss.q2/ss.q1 ELSE NULL END AND CASE WHEN ws.q2 > 0 THEN ws.q3/ws.q2 ELSE NULL END > CASE WHEN ss.q2 > 0 THEN ss.q3/ss.q2 ELSE NULL END ORDER BY ss.d_year;"
        }
      }
    ]
  }
]