[
  {
    "plan_id": "snipe_p1",
    "dialect": "postgres",
    "confidence": 0.85,
    "based_on": "p10,p01",
    "strategy": "Explicit joins and early year filter",
    "hypothesis": "Convert comma joins to explicit INNER JOINs and push d_year=1999 filter into CTEs to reduce data volume and improve join efficiency. EXPLAIN shows full scans on store_sales/web_sales due to late filtering and comma-join weakness.",
    "target_ir": "CTEs with explicit joins and year filter, main query unchanged",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH ss as (SELECT ca_county, d_qoy, d_year, sum(ss_ext_sales_price) as store_sales FROM store_sales INNER JOIN date_dim ON store_sales.ss_sold_date_sk = date_dim.d_date_sk INNER JOIN customer_address ON store_sales.ss_addr_sk = customer_address.ca_address_sk INNER JOIN item ON store_sales.ss_item_sk = item.i_item_sk WHERE item.i_color IN ('dark', 'puff') AND item.i_manager_id BETWEEN 15 and 34 AND store_sales.ss_list_price between 244 and 258 AND customer_address.ca_state in ('KS','OH') AND date_dim.d_year = 1999 group by customer_address.ca_county, date_dim.d_qoy, date_dim.d_year), ws as (SELECT customer_address.ca_county, date_dim.d_qoy, date_dim.d_year, sum(ws_ext_sales_price) as web_sales FROM web_sales INNER JOIN date_dim ON web_sales.ws_sold_date_sk = date_dim.d_date_sk INNER JOIN customer_address ON web_sales.ws_bill_addr_sk = customer_address.ca_address_sk INNER JOIN item ON web_sales.ws_item_sk = item.i_item_sk WHERE item.i_color IN ('dark', 'puff') AND item.i_manager_id BETWEEN 15 and 34 AND web_sales.ws_list_price between 244 and 258 AND customer_address.ca_state in ('KS','OH') AND date_dim.d_year = 1999 group by customer_address.ca_county, date_dim.d_qoy, date_dim.d_year) select ss1.ca_county, ss1.d_year, ws2.web_sales/ws1.web_sales web_q1_q2_increase, ss2.store_sales/ss1.store_sales store_q1_q2_increase, ws3.web_sales/ws2.web_sales web_q2_q3_increase, ss3.store_sales/ss2.store_sales store_q2_q3_increase from ss ss1, ss ss2, ss ss3, ws ws1, ws ws2, ws ws3 where ss1.d_qoy = 1 and ss1.d_year = 1999 and ss1.ca_county = ss2.ca_county and ss2.d_qoy = 2 and ss2.d_year = 1999 and ss2.ca_county = ss3.ca_county and ss3.d_qoy = 3 and ss3.d_year = 1999 and ss1.ca_county = ws1.ca_county and ws1.d_qoy = 1 and ws1.d_year = 1999 and ws1.ca_county = ws2.ca_county and ws2.d_qoy = 2 and ws2.d_year = 1999 and ws1.ca_county = ws3.ca_county and ws3.d_qoy = 3 and ws3.d_year =1999 and case when ws1.web_sales > 0 then ws2.web_sales/ws1.web_sales else null end > case when ss1.store_sales > 0 then ss2.store_sales/ss1.store_sales else null end and case when ws2.web_sales > 0 then ws3.web_sales/ws2.web_sales else null end > case when ss2.store_sales > 0 then ss3.store_sales/ss2.store_sales else null end order by ss1.d_year;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "postgres",
    "confidence": 0.75,
    "based_on": "p02,p03",
    "strategy": "Pre-filtered dimensions in CTEs to reduce fact table scan",
    "hypothesis": "Precompute filtered dimension tables (item, customer_address, date_dim) to reduce join cardinality. EXPLAIN shows sequential scans on dimensions after large fact tables, indicating predicate blindness.",
    "target_ir": "Three new dimension CTEs, then ss/ws CTEs join these, main query unchanged",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH filtered_item AS (SELECT i_item_sk FROM item WHERE i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 and 34), filtered_ca AS (SELECT ca_address_sk, ca_county FROM customer_address WHERE ca_state in ('KS','OH')), filtered_date AS (SELECT d_date_sk, d_qoy, d_year FROM date_dim WHERE d_year = 1999), ss AS (SELECT filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year, SUM(ss_ext_sales_price) as store_sales FROM store_sales INNER JOIN filtered_date ON store_sales.ss_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_ca ON store_sales.ss_addr_sk = filtered_ca.ca_address_sk INNER JOIN filtered_item ON store_sales.ss_item_sk = filtered_item.i_item_sk WHERE store_sales.ss_list_price between 244 and 258 GROUP BY filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year), ws AS (SELECT filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year, SUM(ws_ext_sales_price) as web_sales FROM web_sales INNER JOIN filtered_date ON web_sales.ws_sold_date_sk = filtered_date.d_date_sk INNER JOIN filtered_ca ON web_sales.ws_bill_addr_sk = filtered_ca.ca_address_sk INNER JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk WHERE web_sales.ws_list_price between 244 and 258 GROUP BY filtered_ca.ca_county, filtered_date.d_qoy, filtered_date.d_year) select ss1.ca_county, ss1.d_year, ws2.web_sales/ws1.web_sales web_q1_q2_increase, ss2.store_sales/ss1.store_sales store_q1_q2_increase, ws3.web_sales/ws2.web_sales web_q2_q3_increase, ss3.store_sales/ss2.store_sales store_q2_q3_increase from ss ss1, ss ss2, ss ss3, ws ws1, ws ws2, ws ws3 where ss1.d_qoy = 1 and ss1.d_year = 1999 and ss1.ca_county = ss2.ca_county and ss2.d_qoy = 2 and ss2.d_year = 1999 and ss2.ca_county = ss3.ca_county and ss3.d_qoy = 3 and ss3.d_year = 1999 and ss1.ca_county = ws1.ca_county and ws1.d_qoy = 1 and ws1.d_year = 1999 and ws1.ca_county = ws2.ca_county and ws2.d_qoy = 2 and ws2.d_year = 1999 and ws1.ca_county = ws3.ca_county and ws3.d_qoy = 3 and ws3.d_year =1999 and case when ws1.web_sales > 0 then ws2.web_sales/ws1.web_sales else null end > case when ss1.store_sales > 0 then ss2.store_sales/ss1.store_sales else null end and case when ws2.web_sales > 0 then ws3.web_sales/ws2.web_sales else null end > case when ss2.store_sales > 0 then ss3.store_sales/ss2.store_sales else null end order by ss1.d_year;"
        }
      }
    ]
  }
]