{
  "probe_id": "p01",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "dialect": "postgres",
  "hypothesis": "Materialize shared store_sales scan once via CTE and derive quarterly aggregates using CASE expressions to eliminate self-joins and reduce redundant scans.",
  "reasoning_trace": [
    "Original query joins ss CTE three times with d_qoy filters, causing repeated scans of store_sales.",
    "PostgreSQL materializes CTEs by default; leveraging this to precompute all quarters in one pass avoids 5 CTE scans and nested loops."
  ],
  "target_ir": "Single materialized CTE with CASE-based aggregation per quarter, joined once; FROM rewritten to use derived columns.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ss_quarterly",
        "cte_query_sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS q1_sales, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS q2_sales, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS q3_sales FROM store_sales, date_dim, customer_address, item WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk AND ss_item_sk = i_item_sk AND i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34 AND ss_list_price BETWEEN 244 AND 258 AND ca_state IN ('KS','OH') GROUP BY ca_county, d_year"
      }
    },
    {
      "step_id": "s2",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "ss_quarterly ssq, ws ws1, ws ws2, ws ws3"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "ssq.d_year = 1999 AND ws1.d_qoy = 1 AND ws1.d_year = 1999 AND ws1.ca_county = ws2.ca_county AND ws2.d_qoy = 2 AND ws2.d_year = 1999 AND ws1.ca_county = ws3.ca_county AND ws3.d_qoy = 3 AND ws3.d_year = 1999 AND CASE WHEN ws1.web_sales > 0 THEN ws2.web_sales / ws1.web_sales ELSE NULL END > CASE WHEN ssq.q1_sales > 0 THEN ssq.q2_sales / ssq.q1_sales ELSE NULL END AND CASE WHEN ws2.web_sales > 0 THEN ws3.web_sales / ws2.web_sales ELSE NULL END > CASE WHEN ssq.q2_sales > 0 THEN ssq.q3_sales / ssq.q2_sales ELSE NULL END"
      }
    }
  ]
}