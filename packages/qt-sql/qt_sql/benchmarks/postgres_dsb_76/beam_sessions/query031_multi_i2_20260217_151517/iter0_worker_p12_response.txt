{
  "probe_id": "p01",
  "transform_id": "single_pass_aggregation",
  "family": "C",
  "dialect": "postgres",
  "hypothesis": "Consolidate repeated quarterly aggregations on store_sales and web_sales into single-pass CTEs using conditional aggregates to eliminate self-joins and reduce fact table scans.",
  "reasoning_trace": [
    "Original query scans store_sales and web_sales 3 times each due to ss1/ss2/ss3 and ws1/ws2/ws3 CTEs.",
    "Each scan filters by d_qoy = 1, 2, or 3 respectively but shares identical base predicates.",
    "Using CASE inside SUM allows pivoting quarters in one scan, avoiding costly self-joins."
  ],
  "target_ir": "Two CTEs (ss_all_quarters, ws_all_quarters) with conditional aggregates; main query joins them once per source.",
  "steps": [
    {
      "step_id": "s1",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ss_all_quarters",
        "cte_query_sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ss_ext_sales_price ELSE 0 END) AS q1_sales, SUM(CASE WHEN d_qoy = 2 THEN ss_ext_sales_price ELSE 0 END) AS q2_sales, SUM(CASE WHEN d_qoy = 3 THEN ss_ext_sales_price ELSE 0 END) AS q3_sales FROM store_sales, date_dim, customer_address, item WHERE ss_sold_date_sk = d_date_sk AND ss_addr_sk = ca_address_sk AND ss_item_sk = i_item_sk AND i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34 AND ss_list_price BETWEEN 244 AND 258 AND ca_state IN ('KS','OH') AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
      }
    },
    {
      "step_id": "s2",
      "op": "insert_cte",
      "target": {"by_node_id": "S0"},
      "payload": {
        "cte_name": "ws_all_quarters",
        "cte_query_sql": "SELECT ca_county, d_year, SUM(CASE WHEN d_qoy = 1 THEN ws_ext_sales_price ELSE 0 END) AS q1_sales, SUM(CASE WHEN d_qoy = 2 THEN ws_ext_sales_price ELSE 0 END) AS q2_sales, SUM(CASE WHEN d_qoy = 3 THEN ws_ext_sales_price ELSE 0 END) AS q3_sales FROM web_sales, date_dim, customer_address, item WHERE ws_sold_date_sk = d_date_sk AND ws_bill_addr_sk = ca_address_sk AND ws_item_sk = i_item_sk AND i_color IN ('dark', 'puff') AND i_manager_id BETWEEN 15 AND 34 AND ws_list_price BETWEEN 244 AND 258 AND ca_state IN ('KS','OH') AND d_qoy IN (1,2,3) GROUP BY ca_county, d_year"
      }
    },
    {
      "step_id": "s3",
      "op": "replace_from",
      "target": {"by_node_id": "S0"},
      "payload": {
        "from_sql": "ss_all_quarters ss, ws_all_quarters ws"
      }
    },
    {
      "step_id": "s4",
      "op": "replace_where_predicate",
      "target": {"by_node_id": "S0"},
      "payload": {
        "expr_sql": "ss.ca_county = ws.ca_county AND ss.d_year = 1999 AND ws.d_year = 1999 AND CASE WHEN ws.q1_sales > 0 THEN ws.q2_sales::FLOAT / ws.q1_sales ELSE NULL END > CASE WHEN ss.q1_sales > 0 THEN ss.q2_sales::FLOAT / ss.q1_sales ELSE NULL END AND CASE WHEN ws.q2_sales > 0 THEN ws.q3_sales::FLOAT / ws.q2_sales ELSE NULL END > CASE WHEN ss.q2_sales > 0 THEN ss.q3_sales::FLOAT / ss.q2_sales ELSE NULL END"
      }
    },
    {
      "step_id": "s5",
      "op": "replace_select",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "ss.ca_county, ss.d_year, CASE WHEN ws.q1_sales > 0 THEN ws.q2_sales::FLOAT / ws.q1_sales ELSE NULL END AS web_q1_q2_increase, CASE WHEN ss.q1_sales > 0 THEN ss.q2_sales::FLOAT / ss.q1_sales ELSE NULL END AS store_q1_q2_increase, CASE WHEN ws.q2_sales > 0 THEN ws.q3_sales::FLOAT / ws.q2_sales ELSE NULL END AS web_q2_q3_increase, CASE WHEN ss.q2_sales > 0 THEN ss.q3_sales::FLOAT / ss.q2_sales ELSE NULL END AS store_q2_q3_increase"
      }
    }
  ]
}