{
  "probe_id": "p04",
  "transform_id": "composite_decorrelate_union",
  "family": "B",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Extracting shared date_dim and item filters into a single CTE reduces repeated scans. Creating separate CTEs for each sales channel (store, web, catalog) that join with the shared dimension CTE and apply price ratio filters allows unioning customer keys before joining back to main dimensions, replacing nested loops with hash joins.",
  "reasoning_trace": [
    "Assigned transform targets decorrelation of multiple EXISTS by extracting shared dimension access.",
    "Shared CTE reduces date_dim and item scans from 3x to 1x.",
    "Channel-specific CTEs with union allow set-based processing instead of per-row loops.",
    "Final join structure preserves all original grouping and output columns."
  ],
  "target_ir": "shared_dimensions CTE scans date_dim and item once; store_sales_keys, web_sales_keys, catalog_sales_keys CTEs join shared_dimensions and filter by channel; unioned_keys CTE unions customer_sk from all channels; final_select joins unioned customer_sk with customer, customer_address, customer_demographics.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["unioned_keys", "customer", "customer_address", "customer_demographics"],
        "outputs": ["cd_gender", "cd_marital_status", "cd_education_status", "cnt1", "cd_purchase_estimate", "cnt2", "cd_credit_rating", "cnt3", "cd_dep_count", "cnt4", "cd_dep_employed_count", "cnt5", "cd_dep_college_count", "cnt6"],
        "changed": true,
        "sql": "SELECT cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, count(*) cnt1, cd.cd_purchase_estimate, count(*) cnt2, cd.cd_credit_rating, count(*) cnt3, cd.cd_dep_count, count(*) cnt4, cd.cd_dep_employed_count, count(*) cnt5, cd.cd_dep_college_count, count(*) cnt6 FROM unioned_keys uk JOIN customer c ON uk.customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk WHERE ca.ca_county IN ('Alameda County','Lexington city','Pender County','Petroleum County','Walworth County') AND c.c_birth_month IN (4, 5) AND cd.cd_marital_status IN ('U', 'S', 'U') AND cd.cd_education_status IN ('College', 'Secondary', 'College') AND cd.cd_gender = 'M' GROUP BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count ORDER BY cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count LIMIT 100"
      },
      {
        "node_id": "unioned_keys",
        "parent_node_id": "final_select",
        "sources": ["store_sales_keys", "web_sales_keys", "catalog_sales_keys"],
        "outputs": ["customer_sk"],
        "changed": true,
        "sql": "SELECT customer_sk FROM store_sales_keys UNION SELECT customer_sk FROM web_sales_keys UNION SELECT customer_sk FROM catalog_sales_keys"
      },
      {
        "node_id": "store_sales_keys",
        "parent_node_id": "unioned_keys",
        "sources": ["shared_dimensions", "store_sales"],
        "outputs": ["customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT ss.ss_customer_sk AS customer_sk FROM store_sales ss JOIN shared_dimensions sd ON ss.ss_sold_date_sk = sd.d_date_sk AND ss.ss_item_sk = sd.i_item_sk WHERE ss.ss_sales_price / ss.ss_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
      },
      {
        "node_id": "web_sales_keys",
        "parent_node_id": "unioned_keys",
        "sources": ["shared_dimensions", "web_sales"],
        "outputs": ["customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT ws.ws_bill_customer_sk AS customer_sk FROM web_sales ws JOIN shared_dimensions sd ON ws.ws_sold_date_sk = sd.d_date_sk AND ws.ws_item_sk = sd.i_item_sk WHERE ws.ws_sales_price / ws.ws_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
      },
      {
        "node_id": "catalog_sales_keys",
        "parent_node_id": "unioned_keys",
        "sources": ["shared_dimensions", "catalog_sales"],
        "outputs": ["customer_sk"],
        "changed": true,
        "sql": "SELECT DISTINCT cs.cs_ship_customer_sk AS customer_sk FROM catalog_sales cs JOIN shared_dimensions sd ON cs.cs_sold_date_sk = sd.d_date_sk AND cs.cs_item_sk = sd.i_item_sk WHERE cs.cs_sales_price / cs.cs_list_price BETWEEN 65 * 0.01 AND 75 * 0.01"
      },
      {
        "node_id": "shared_dimensions",
        "parent_node_id": "store_sales_keys",
        "sources": ["date_dim", "item"],
        "outputs": ["d_date_sk", "i_item_sk"],
        "changed": true,
        "sql": "SELECT d.d_date_sk, i.i_item_sk FROM date_dim d, item i WHERE d.d_year = 1999 AND d.d_moy BETWEEN 5 AND 8 AND i.i_category IN ('Children', 'Home', 'Women') AND i.i_manager_id BETWEEN 91 AND 100"
      }
    ]
  }
}