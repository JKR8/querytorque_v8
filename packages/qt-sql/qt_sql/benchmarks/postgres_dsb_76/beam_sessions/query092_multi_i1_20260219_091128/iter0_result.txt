{
  "iteration": 0,
  "n_api_calls": 1,
  "beam_cost_usd": 0.00533232,
  "beam_cost_priced_calls": 1,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 13678,
    "completion_tokens": 3903,
    "total_tokens": 17581,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 2961
  },
  "best_speedup": 216.67,
  "best_patch_id": "compile_p1",
  "best_sql": "WITH threshold_by_item AS (\n    SELECT \n        ws_item_sk,\n        1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM \n        web_sales\n        JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    WHERE \n        d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n        AND ws_wholesale_cost BETWEEN 16 AND 36\n        AND ws_sales_price / ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01\n    GROUP BY \n        ws_item_sk\n)\nSELECT \n    SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM \n    web_sales\n    JOIN item ON i_item_sk = ws_item_sk\n    JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    LEFT JOIN threshold_by_item ON threshold_by_item.ws_item_sk = web_sales.ws_item_sk\nWHERE \n    (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))\n    AND d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n    AND ws_wholesale_cost BETWEEN 16 AND 36\n    AND ws_ext_discount_amt > threshold_by_item.threshold\nORDER BY \n    SUM(ws_ext_discount_amt)\nLIMIT 100;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "date_cte_explicit_join",
      "relevance_score": 0.6,
      "status": "WIN",
      "speedup": 13.84,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 21668.8,
      "output_sql": "WITH date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day'), filtered_web_sales AS (SELECT ws_item_sk, ws_sold_date_sk, ws_ext_discount_amt, ws_wholesale_cost, ws_sales_price, ws_list_price FROM web_sales JOIN date_cte ON web_sales.ws_sold_date_sk = date_cte.d_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM filtered_web_sales JOIN item ON i_item_sk = ws_item_sk JOIN date_cte ON d_date_sk = ws_sold_date_sk WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men')) AND ws_wholesale_cost BETWEEN 16 AND 36 AND ws_ext_discount_amt > (SELECT 1.3 * avg(ws_ext_discount_amt) FROM web_sales ws2 JOIN date_cte d2 ON ws2.ws_sold_date_sk = d2.d_date_sk WHERE ws2.ws_item_sk = i_item_sk AND ws2.ws_wholesale_cost BETWEEN 16 AND 36 AND (ws2.ws_sales_price / ws2.ws_list_price) BETWEEN 0.35 AND 0.50);",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Isolate date_dim filter into a MATERIALIZED CTE, convert comma joins to explicit INNER JOIN syntax, and join with filtered date CTE first to reduce fact\u2011table rows early."
    },
    {
      "patch_id": "p01",
      "family": "B",
      "transform": "inline_decorrelate_materialized",
      "relevance_score": 0.92,
      "status": "ERROR",
      "speedup": 0.0,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": "column reference \"ws_item_sk\" is ambiguous\nLINE 1: ...N ('Children', 'Jewelry', 'Men')) AND i_item_sk = ws_item_sk...\n                                                             ^\n",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'), filtered_sales AS (SELECT ws_item_sk, ws_ext_discount_amt FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = filtered_dates.d_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36 AND ws_sales_price / ws_list_price BETWEEN 0.35 AND 0.50), threshold_by_item AS (SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM filtered_sales GROUP BY ws_item_sk) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales, item, date_dim, threshold_by_item WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 16 AND 36 AND ws_ext_discount_amt > threshold_by_item.threshold;",
      "has_explain": false,
      "description": "[scout:qwen/qwen3-coder] Decompose correlated scalar subquery into three MATERIALIZED CTEs: (1) pre\u2011filtered date_dim for date range, (2) pre\u2011filtered web_sales with same outer filters (ws_wholesale_cost BETWEEN 16 AND 36, ws_sales_price/ws_list_price BETWEEN 0.35 AND 0.50) joined with filtered date_dim, (3) per\u2011item aggregate threshold (1.3 * avg(ws_ext_discount_amt)). Then join threshold CTE in final query, removing SubPlan."
    },
    {
      "patch_id": "p02",
      "family": "B",
      "transform": "early_filter_decorrelate",
      "relevance_score": 0.75,
      "status": "WIN",
      "speedup": 153.65,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1952.5,
      "output_sql": "WITH threshold_cte AS (SELECT ws_item_sk AS t_item_sk, 1.3 * avg(ws_ext_discount_amt) AS t_avg_discount FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day' AND ws_wholesale_cost BETWEEN 16 AND 36 AND (ws_sales_price / ws_list_price) BETWEEN 0.35 AND 0.50 GROUP BY ws_item_sk) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales, item, date_dim, threshold_cte WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men')) AND i_item_sk = ws_item_sk AND d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day' AND d_date_sk = ws_sold_date_sk AND ws_wholesale_cost BETWEEN 16 AND 36 AND ws_item_sk = threshold_cte.t_item_sk AND ws_ext_discount_amt > threshold_cte.t_avg_discount;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Push dimension filters into CTE definitions before materialization, and decorrelate subquery by pre\u2011computing thresholds in separate CTE. Use explicit JOIN syntax to improve predicate pushdown."
    },
    {
      "patch_id": "p04",
      "family": "F",
      "transform": "dimension_prefetch_star",
      "relevance_score": 0.55,
      "status": "WIN",
      "speedup": 18.45,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 16261.2,
      "output_sql": "WITH filtered_item AS (SELECT i_item_sk, i_manufact_id, i_category FROM item WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))), filtered_dates AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND CAST('2002-03-06' AS DATE) + INTERVAL '90 day') SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN filtered_item ON i_item_sk = ws_item_sk JOIN filtered_dates ON d_date_sk = ws_sold_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36 AND ws_ext_discount_amt > (SELECT 1.3 * AVG(ws_ext_discount_amt) FROM web_sales ws2 JOIN filtered_dates fd2 ON ws2.ws_sold_date_sk = fd2.d_date_sk WHERE ws2.ws_item_sk = filtered_item.i_item_sk AND ws2.ws_wholesale_cost BETWEEN 16 AND 36 AND (ws2.ws_sales_price / ws2.ws_list_price) BETWEEN 0.35 AND 0.50) ORDER BY SUM(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": "[scout:qwen/qwen3-coder] Pre\u2011filter both date_dim and item into separate MATERIALIZED CTEs, then join them with web_sales using explicit INNER JOIN syntax, aiming to create tiny hash tables for both dimensions."
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 216.67,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1384.6,
      "output_sql": "WITH threshold_by_item AS (\n    SELECT \n        ws_item_sk,\n        1.3 * AVG(ws_ext_discount_amt) AS threshold\n    FROM \n        web_sales\n        JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    WHERE \n        d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n        AND ws_wholesale_cost BETWEEN 16 AND 36\n        AND ws_sales_price / ws_list_price BETWEEN 35 * 0.01 AND 50 * 0.01\n    GROUP BY \n        ws_item_sk\n)\nSELECT \n    SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM \n    web_sales\n    JOIN item ON i_item_sk = ws_item_sk\n    JOIN date_dim ON d_date_sk = ws_sold_date_sk\n    LEFT JOIN threshold_by_item ON threshold_by_item.ws_item_sk = web_sales.ws_item_sk\nWHERE \n    (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))\n    AND d_date BETWEEN '2002-03-06' AND cast('2002-03-06' as date) + interval '90 day'\n    AND ws_wholesale_cost BETWEEN 16 AND 36\n    AND ws_ext_discount_amt > threshold_by_item.threshold\nORDER BY \n    SUM(ws_ext_discount_amt)\nLIMIT 100;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "compile_p1",
      "family": "?",
      "transform": "tree_rewrite",
      "relevance_score": 1.0,
      "status": "WIN",
      "speedup": 203.95,
      "semantic_passed": true,
      "correctness_verified": false,
      "error": null,
      "original_ms": 300000.0,
      "patch_ms": 1471.0,
      "output_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-03-06' AND cast('2002-03-06' AS date) + interval '90 day'), filtered_item AS (SELECT i_item_sk FROM item WHERE (i_manufact_id BETWEEN 566 AND 765 OR i_category IN ('Children', 'Jewelry', 'Men'))), threshold_cte AS (SELECT ws_item_sk, 1.3 * avg(ws_ext_discount_amt) AS threshold FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = filtered_dates.d_date_sk WHERE ws_wholesale_cost BETWEEN 16 AND 36 AND (ws_sales_price / ws_list_price) BETWEEN 0.35 AND 0.50 GROUP BY ws_item_sk) SELECT sum(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM web_sales JOIN filtered_dates ON web_sales.ws_sold_date_sk = filtered_dates.d_date_sk JOIN filtered_item ON web_sales.ws_item_sk = filtered_item.i_item_sk JOIN threshold_cte ON web_sales.ws_item_sk = threshold_cte.ws_item_sk WHERE web_sales.ws_wholesale_cost BETWEEN 16 AND 36 AND web_sales.ws_ext_discount_amt > threshold_cte.threshold ORDER BY sum(ws_ext_discount_amt) LIMIT 100;",
      "has_explain": true,
      "description": null
    }
  ],
  "explains": {
    "p03": "Aggregate  (cost=59468.72..59468.73 rows=1 width=32) (actual time=15898.609..15898.616 rows=1 loops=1)\n  CTE date_cte\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1707.07 rows=97 width=4) (actual time=0.554..1.200 rows=91 loops=1)\n          Index Cond: ((d_date >= '2002-03-06'::date) AND (d_date <= '2002-06-04 00:00:00'::timestamp without time zone))\n  ->  Hash Join  (cost=9387.97..57760.78 rows=350 width=6) (actual time=53.807..15897.044 rows=992 loop",
    "p02": "Aggregate  (cost=32252.74..32252.75 rows=1 width=32) (actual time=1733.629..1733.725 rows=1 loops=1)\n  ->  Nested Loop  (cost=32096.54..32252.74 rows=1 width=6) (actual time=178.638..1733.494 rows=992 loops=1)\n        ->  Nested Loop  (cost=32096.25..32248.58 rows=13 width=10) (actual time=34.529..1696.345 rows=30257 loops=1)\n              Join Filter: (web_sales.ws_ext_discount_amt > ((1.3 * avg(web_sales_1.ws_ext_discount_amt))))\n              Rows Removed by Join Filter: 108543\n              ",
    "p04": "Limit  (cost=57982.36..57982.37 rows=1 width=32) (actual time=16427.906..16427.912 rows=1 loops=1)\n  CTE filtered_dates\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1707.07 rows=97 width=8) (actual time=0.466..1.086 rows=91 loops=1)\n          Index Cond: ((d_date >= '2002-03-06'::date) AND (d_date <= '2002-06-04 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=56275.30..56275.30 rows=1 width=32) (actual time=16427.905..16427.908 rows=1 loops=",
    "compile_p1": "Limit  (cost=56457.74..56457.75 rows=1 width=32) (actual time=1815.534..1815.541 rows=1 loops=1)\n  CTE filtered_dates\n    ->  Index Scan using _dta_index_date_dim_6_661577395__k4_k3 on date_dim  (cost=0.29..1707.07 rows=97 width=4) (actual time=0.509..1.138 rows=91 loops=1)\n          Index Cond: ((d_date >= '2002-03-06'::date) AND (d_date <= '2002-06-04 00:00:00'::timestamp without time zone))\n  ->  Sort  (cost=54750.68..54750.68 rows=1 width=32) (actual time=1815.533..1815.538 rows=1 loops=1)\n "
  }
}