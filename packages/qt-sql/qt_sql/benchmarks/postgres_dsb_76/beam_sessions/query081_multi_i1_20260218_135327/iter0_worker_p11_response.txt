{
  "probe_id": "scout_pg_self_join_decomposition",
  "transform_id": "pg_self_join_decomposition",
  "family": "E",
  "status": "success",
  "dialect": "postgresql",
  "hypothesis": "Materializing the customer_total_return CTE once and deriving both outer rows and state averages from it avoids repeated scans of base tables and decorrelates the nested loop.",
  "reasoning_trace": [
    "Assigned transform targets correlated scalar subquery re-execution over CTE scan.",
    "Shared materialization of CTE allows reuse for both outer filter and average calculation.",
    "PostgreSQL's default CTE materialization supports this pattern effectively.",
    "Preserves all required output columns, ordering, and WHERE constraints."
  ],
  "target_ir": "customer_total_return CTE reused for both outer selection and average calculation; final_select decorrelated.",
  "verification": {
    "executable": true,
    "no_missing_tables": true,
    "alias_consistent": true,
    "no_orphan_scans": true,
    "semantics_preserved": true,
    "null_semantics_safe": true,
    "ctes_selective_or_na": true
  },
  "tree": {
    "root_node_id": "final_select",
    "nodes": [
      {
        "node_id": "final_select",
        "parent_node_id": null,
        "sources": ["customer_total_return", "customer_address", "customer", "state_averages"],
        "outputs": ["c_customer_id", "c_salutation", "c_first_name", "c_last_name", "ca_street_number", "ca_street_name", "ca_street_type", "ca_suite_number", "ca_city", "ca_county", "ca_state", "ca_zip", "ca_country", "ca_gmt_offset", "ca_location_type", "ctr_total_return"],
        "changed": true,
        "sql": "SELECT c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, ca.ca_street_number, ca.ca_street_name, ca.ca_street_type, ca.ca_suite_number, ca.ca_city, ca.ca_county, ca.ca_state, ca.ca_zip, ca.ca_country, ca.ca_gmt_offset, ca.ca_location_type, ctr1.ctr_total_return FROM customer_total_return ctr1 JOIN state_averages sa ON ctr1.ctr_state = sa.ctr_state JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk WHERE ctr1.ctr_total_return > sa.avg_return * 1.2 AND ca.ca_state = 'IA' ORDER BY c.c_customer_id, c.c_salutation, c.c_first_name, c.c_last_name, ca.ca_street_number, ca.ca_street_name, ca.ca_street_type, ca.ca_suite_number, ca.ca_city, ca.ca_county, ca.ca_state, ca.ca_zip, ca.ca_country, ca.ca_gmt_offset, ca.ca_location_type, ctr1.ctr_total_return LIMIT 100"
      },
      {
        "node_id": "customer_total_return",
        "parent_node_id": "final_select",
        "sources": ["catalog_returns", "date_dim", "customer_address"],
        "outputs": ["ctr_customer_sk", "ctr_state", "ctr_total_return"],
        "changed": false
      },
      {
        "node_id": "state_averages",
        "parent_node_id": "final_select",
        "sources": ["customer_total_return"],
        "outputs": ["ctr_state", "avg_return"],
        "changed": true,
        "sql": "SELECT ctr_state, AVG(ctr_total_return) AS avg_return FROM customer_total_return GROUP BY ctr_state"
      }
    ]
  }
}