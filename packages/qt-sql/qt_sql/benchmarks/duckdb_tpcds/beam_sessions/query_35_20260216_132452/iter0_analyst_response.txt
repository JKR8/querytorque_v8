### Analysis of Optimization Families

**Family A (Early Filtering):** HIGH  
The date_dim table is scanned 3 times with identical filters (d_year=2001, d_qoy<4). Pushing this filter into a reusable CTE would eliminate redundant scans and reduce I/O.

**Family B (Decorrelation):** HIGH  
Correlated EXISTS subqueries cause repeated scans of large fact tables (store_sales, web_sales, catalog_sales) per customer row. Mark joins (LEFT_DELIM_JOIN) in the plan confirm correlation overhead.

**Family C (Aggregation Pushdown):** LOW  
No opportunity for aggregation before joins. GROUP BY keys (customer attributes) don't align with join keys (customer_sk), and aggregating sales data early isn't possible.

**Family D (Set Operation Optimization):** MEDIUM  
The OR condition between EXISTS subqueries forces materialization of intermediate results. Converting to a UNION-based distinct customer set could reduce mark-join overhead.

**Family E (Materialization/Prefetch):** HIGH  
Repeated scans of date_dim (3x) and sales tables with identical date filters. Precomputing date keys and customer sets would avoid redundant work.

**Family F (Join Transform):** MEDIUM  
Comma-joins in FROM clause obscure join relationships. Converting to explicit INNER JOINs could help the optimizer, but this is secondary to decorrelation.

**Chosen Families:** B, E, A, D  
**Confidence:** High (Plan shows 57% time on store_sales scan + correlation markers)

---

### Optimization Targets

```json
[
  {
    "family": "B",
    "transform": "decorrelate_union",
    "target_id": "t1",
    "relevance_score": 0.98,
    "hypothesis": "Correlated EXISTS subqueries re-scan 806M-row store_sales per customer. Precompute distinct customer set for all sales channels once.",
    "target_ir": "S0 [SELECT]\n  CTE: date_filter (via Q1)\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_year=2001 AND d_qoy<4\n  CTE: sales_customers (via Q2)\n    SELECT ss_customer_sk AS customer_sk FROM store_sales, date_filter WHERE ss_sold_date_sk = d_date_sk\n    UNION\n    SELECT ws_bill_customer_sk FROM web_sales, date_filter WHERE ws_sold_date_sk = d_date_sk\n    UNION\n    SELECT cs_ship_customer_sk FROM catalog_sales, date_filter WHERE cs_sold_date_sk = d_date_sk\n  MAIN QUERY (via Q0)\n    FROM: customer c\n    INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\n    INNER JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\n    WHERE c.c_customer_sk IN (SELECT customer_sk FROM sales_customers)\n    GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\n    ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\n    LIMIT 100",
    "recommended_examples": ["decorrelate", "or_to_union"]
  },
  {
    "family": "E",
    "transform": "multi_dimension_prefetch",
    "target_id": "t2",
    "relevance_score": 0.90,
    "hypothesis": "date_dim scanned 3 times with identical filters. Materialize filtered date keys first for reuse across sales channels.",
    "target_ir": "S0 [SELECT]\n  CTE: date_filter (via Q1)\n    SELECT d_date_sk\n    FROM date_dim\n    WHERE d_year=2001 AND d_qoy<4\n  MAIN QUERY (via Q0)\n    FROM: customer c, customer_address ca, customer_demographics cd\n    WHERE c.c_current_addr_sk = ca.ca_address_sk\n      AND cd.cd_demo_sk = c.c_current_cdemo_sk\n      AND (EXISTS (SELECT * FROM store_sales, date_filter WHERE c.c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk)\n           OR EXISTS (SELECT * FROM web_sales, date_filter WHERE c.c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk)\n           OR EXISTS (SELECT * FROM catalog_sales, date_filter WHERE c.c_customer_sk = cs_ship_customer_sk AND cs_sold_date_sk = d_date_sk))\n    GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\n    ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count\n    LIMIT 100",
    "recommended_examples": ["multi_dimension_prefetch"]
  },
  {
    "family": "A",
    "transform": "push_cd_filters",
    "target_id": "t3",
    "relevance_score": 0.75,
    "hypothesis": "cd_demo_sk range filter (cd_demo_sk>=4 AND cd_dep_count<=1920791) applied late. Push into customer_demographics scan.",
    "target_ir": "S0 [SELECT]\n  CTE: filtered_demographics (via Q1)\n    SELECT *\n    FROM customer_demographics\n    WHERE cd_demo_sk BETWEEN 4 AND 1920791  -- Extracted from plan filters\n  MAIN QUERY (via Q0)\n    FROM: customer c\n    INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\n    INNER JOIN filtered_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\n    WHERE ... [rest unchanged]",
    "recommended_examples": ["date_cte_isolate"]
  }
]
```