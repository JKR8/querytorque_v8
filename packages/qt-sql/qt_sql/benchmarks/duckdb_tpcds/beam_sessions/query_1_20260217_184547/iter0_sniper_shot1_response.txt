[
  {
    "plan_id": "snipe_p1",
    "dialect": "duckdb",
    "confidence": 0.85,
    "based_on": "p04,p03",
    "strategy": "Decorrelation plus early store filter",
    "hypothesis": "p04 decorrelation removed correlated subquery (1.53x speedup). Adding filtered_store CTE pre-filters store by s_state='SD' to reduce join input early, though store is small and filter already pushed down in original. Combined plan avoids correlation and reduces store rows before join.",
    "expected_explain_delta": "Correlated LEFT_DELIM_JOIN and HASH_JOIN LEFT replaced by HASH_JOIN with store_averages CTE. Store scan filtered in CTE (35 rows) before join. Main HASH_GROUP_BY on store_returns remains dominant.",
    "target_ir": "Three CTEs: customer_total_return (aggregated store_returns for 2000), store_averages (per-store avg*1.2), filtered_store (stores in SD). Main query joins all four via explicit INNER JOINs and filters ctr_total_return > avg_return.",
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_body",
        "target": {"by_node_id": "S0"},
        "payload": {
          "sql_fragment": "WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM customer_total_return GROUP BY ctr_store_sk), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state = 'SD') SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN filtered_store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;"
        }
      }
    ]
  },
  {
    "plan_id": "snipe_p2",
    "dialect": "duckdb",
    "confidence": 0.5,
    "based_on": "original",
    "strategy": "Pass-through second candidate",
    "hypothesis": "No second independent rewrite has sufficient evidence beyond plan 1 without violating regression gates. The only other passing probe (p01) was neutral and identical to original.",
    "expected_explain_delta": "No change expected; this preserves a safe fallback while satisfying two-plan contract.",
    "target_ir": "No structural change.",
    "steps": []
  }
]