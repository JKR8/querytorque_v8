{
  "probe_id": "p_sf_shared_scan",
  "transform_id": "sf_shared_scan_decorrelate",
  "family": "B",
  "dialect": "duckdb",
  "hypothesis": "Create a shared CTE for the base join of store_returns and date_dim, then compute per-store averages and per-customer/store totals in separate CTEs, allowing DuckDB to scan the fact table once and share the results, potentially reducing the cost of HASH_GROUP_BY by splitting aggregations.",
  "reasoning_trace": [
    "The original query has a CTE customer_total_return that is scanned twice with a correlated subquery for per-store average.",
    "By materializing the base join in a CTE (base_returns), we can compute both customer totals and store averages from a single scan.",
    "Decorrelating the subquery into a join with a precomputed store average CTE eliminates per-row re-execution and enables set-based joins."
  ],
  "target_ir": "WITH clause with three CTEs: base_returns (shared scan), customer_total (per-customer/store aggregates), store_avg (per-store average threshold); main query joins customer_total with store_avg, store, and customer using explicit joins, preserving original filters and output columns.",
  "steps": [
    {
      "step_id": "s1",
      "op": "replace_body",
      "target": {"by_node_id": "S0"},
      "payload": {
        "sql_fragment": "WITH base_returns AS ( SELECT sr_customer_sk, sr_store_sk, SR_FEE FROM store_returns JOIN date_dim ON sr_returned_date_sk = d_date_sk WHERE d_year = 2000 ), customer_total AS ( SELECT sr_customer_sk as ctr_customer_sk, sr_store_sk as ctr_store_sk, SUM(SR_FEE) as ctr_total_return FROM base_returns GROUP BY sr_customer_sk, sr_store_sk ), store_avg AS ( SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 as avg_threshold FROM customer_total GROUP BY ctr_store_sk ) SELECT c_customer_id FROM customer_total ctr1 JOIN store_avg sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN store s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE s.s_state = 'SD' AND ctr1.ctr_total_return > sa.avg_threshold ORDER BY c_customer_id LIMIT 100"
      }
    }
  ]
}