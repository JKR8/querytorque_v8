{
  "iteration": 0,
  "n_api_calls": 9,
  "beam_cost_usd": 0.03516058,
  "beam_cost_priced_calls": 9,
  "beam_cost_unpriced_calls": 0,
  "beam_token_totals": {
    "prompt_tokens": 57180,
    "completion_tokens": 50298,
    "total_tokens": 107478,
    "prompt_cache_hit_tokens": 0,
    "prompt_cache_miss_tokens": 0,
    "cached_tokens": 0,
    "reasoning_tokens": 41677
  },
  "best_speedup": 1.53,
  "best_patch_id": "p04",
  "best_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk, store AS s, customer AS c WHERE s.s_store_sk = ctr1.ctr_store_sk AND c.c_customer_sk = ctr1.ctr_customer_sk AND s.s_state = 'SD' AND ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
  "patches": [
    {
      "patch_id": "p03",
      "family": "A",
      "transform": "prefetch_fact_join",
      "relevance_score": 0.75,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic mismatch: Optimized query failed: Binder Error: Referenced column \"s_state\" not found in FROM clause!\nCandidate bindings: \"s_store_sk\", \"ctr_store_sk\", \"c_first_name\", \"ctr_customer_sk\", \"c_first_sales_date_sk\"\n\nLINE 1: ... = ctr2.ctr_store_sk) AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk...\n                                                                        ^",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state = 'SD') SELECT c_customer_id FROM customer_total_return AS ctr1, filtered_store AS s, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": "Create a CTE that pre-filters date_dim (d_year=2000) and store (s_state='SD'), then join with store_returns and customer in a staged pipeline to reduce rows before aggregation."
    },
    {
      "patch_id": "p01",
      "family": "C",
      "transform": "aggregate_pushdown",
      "relevance_score": 0.85,
      "status": "NEUTRAL",
      "speedup": 1.05,
      "semantic_passed": true,
      "error": null,
      "original_ms": 32.6,
      "patch_ms": 31.2,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": true,
      "description": "Push aggregation below the date_dim join: pre-aggregate store_returns by sr_customer_sk, sr_store_sk, sr_returned_date_sk before joining with date_dim, then sum the pre-aggregated fees per customer/store."
    },
    {
      "patch_id": "p04",
      "family": "B",
      "transform": "decorrelate",
      "relevance_score": 0.8,
      "status": "WIN",
      "speedup": 1.53,
      "semantic_passed": true,
      "error": null,
      "original_ms": 32.6,
      "patch_ms": 21.3,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk), store_averages AS (SELECT ctr_store_sk, AVG(ctr_total_return) * 1.2 AS avg_return FROM customer_total_return GROUP BY ctr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk, store AS s, customer AS c WHERE s.s_store_sk = ctr1.ctr_store_sk AND c.c_customer_sk = ctr1.ctr_customer_sk AND s.s_state = 'SD' AND ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": true,
      "description": "Rewrite the correlated scalar subquery (SELECT AVG(ctr_total_return)*1.2 FROM customer_total_return ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) as a standalone CTE computing per-store averages, then JOIN in main WHERE clause."
    },
    {
      "patch_id": "p02",
      "family": "C",
      "transform": "channel_bitmap_aggregation",
      "relevance_score": 0.6,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Synthetic semantic mismatch: Optimized query failed: Binder Error: Values list \"ctr1\" does not have a column named \"ctr_store_avg\"\n\nLINE 1: ... AS ctr1, store, customer WHERE ctr1.ctr_total_return > ctr1.ctr_store_avg * 1.2 AND s_store_sk = ctr1.ctr_store_sk...\n                                                                   ^",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer WHERE ctr1.ctr_total_return > ctr1.ctr_store_avg * 1.2 AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": "Consolidate the two references to customer_total_return CTE (ctr1, ctr2) into a single CTE that computes both the per-store average and the per-customer/store total in one pass, eliminating the second CTE_SCAN."
    },
    {
      "patch_id": "p05",
      "family": "B",
      "transform": "sf_shared_scan_decorrelate",
      "relevance_score": 0.55,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Retry failed: Failed to parse/apply PatchPlan",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total AS ctr1 JOIN store_avg AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE s.s_state = 'SD' AND ctr1.ctr_total_return > sa.avg_threshold ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": "Use Snowflake-style shared-scan decorrelation: create a CTE with store_returns+date_dim join, then compute per-store averages and per-customer/store totals in separate CTEs from that shared scan, then join in main query."
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 strings: ['SD'], numbers: ['1.2']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN filtered_store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "IMPROVED",
      "speedup": 1.06,
      "semantic_passed": true,
      "error": null,
      "original_ms": 26.1,
      "patch_ms": 24.5,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1, store, customer WHERE ctr1.ctr_total_return > (SELECT AVG(ctr_total_return) * 1.2 FROM customer_total_return AS ctr2 WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk) AND s_store_sk = ctr1.ctr_store_sk AND s_state = 'SD' AND ctr1.ctr_customer_sk = c_customer_sk ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": true,
      "description": null
    },
    {
      "patch_id": "snipe_p1",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 strings: ['SD'], numbers: ['1.2']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN filtered_store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": null
    },
    {
      "patch_id": "snipe_p2",
      "family": "?",
      "transform": "unknown",
      "relevance_score": 1.0,
      "status": "FAIL",
      "speedup": null,
      "semantic_passed": false,
      "error": "Tier-1: LITERAL MISMATCH: Original literals missing from rewrite \u2014 numbers: ['1.2']. The rewrite changed filter values instead of preserving them.",
      "original_ms": null,
      "patch_ms": null,
      "output_sql": "/* start query 1 in stream 0 using template query1.tpl */ WITH customer_total_return AS (SELECT sr_customer_sk AS ctr_customer_sk, sr_store_sk AS ctr_store_sk, SUM(SR_FEE) AS ctr_total_return FROM store_returns, date_dim WHERE sr_returned_date_sk = d_date_sk AND d_year = 2000 GROUP BY sr_customer_sk, sr_store_sk) SELECT c_customer_id FROM customer_total_return AS ctr1 JOIN store_averages AS sa ON ctr1.ctr_store_sk = sa.ctr_store_sk JOIN store AS s ON s.s_store_sk = ctr1.ctr_store_sk JOIN customer AS c ON ctr1.ctr_customer_sk = c.c_customer_sk WHERE s.s_state = 'SD' AND ctr1.ctr_total_return > sa.avg_return ORDER BY c_customer_id LIMIT 100;\n\n/* end query 1 in stream 0 using template query1.tpl */;",
      "has_explain": false,
      "description": null
    }
  ],
  "explains": {
    "p01": "Total execution time: 1476ms\n\nCTE [0 rows, 3.5ms]\n  HASH_GROUP_BY [539K rows, 97.2ms, 7%]\n    HASH_JOIN INNER on sr_returned_date_sk = d_date_sk [558K rows, 3.8ms]\n      SEQ_SCAN  store_returns [558K of 69.1M rows, 1258.1ms, 85%]\n      FILTER [366 rows]\n        SEQ_SCAN  date_dim [366 of 73K rows, 1.2ms]  Filters: d_year=2000\n  TOP_N [100 rows, 4.5ms]\n    FILTER [62K rows, 4.2ms]\n      LEFT_DELIM_JOIN LEFT on ctr_store_sk IS NOT DISTINCT FROM ctr_store_sk [0 rows, 5.4ms]\n        HASH_JOIN INNER ",
    "p04": "Total execution time: 1565ms\n\nCTE [0 rows, 2.2ms]\n  HASH_GROUP_BY [539K rows, 96.4ms, 6%]\n    HASH_JOIN INNER on sr_returned_date_sk = d_date_sk [558K rows, 4.3ms]\n      SEQ_SCAN  store_returns [558K of 69.1M rows, 1359.1ms, 87%]\n      FILTER [366 rows]\n        SEQ_SCAN  date_dim [366 of 73K rows, 1.9ms]  Filters: d_year=2000\n  TOP_N [100 rows, 1.1ms]\n    HASH_JOIN INNER on c_customer_sk = ctr_customer_sk [62K rows, 11.6ms]\n      SEQ_SCAN  customer [500K of 2.5M rows, 40.0ms, 3%]  Filters: optio",
    "snipe_p2": "Total execution time: 1305ms\n\nCTE [0 rows, 2.6ms]\n  HASH_GROUP_BY [539K rows, 83.4ms, 6%]\n    HASH_JOIN INNER on sr_returned_date_sk = d_date_sk [558K rows, 2.9ms]\n      SEQ_SCAN  store_returns [558K of 69.1M rows, 1098.0ms, 84%]\n      FILTER [366 rows]\n        SEQ_SCAN  date_dim [366 of 73K rows, 2.1ms]  Filters: d_year=2000\n  TOP_N [100 rows, 4.3ms]\n    FILTER [62K rows, 4.0ms]\n      LEFT_DELIM_JOIN LEFT on ctr_store_sk IS NOT DISTINCT FROM ctr_store_sk [0 rows, 4.9ms]\n        HASH_JOIN INNER "
  }
}