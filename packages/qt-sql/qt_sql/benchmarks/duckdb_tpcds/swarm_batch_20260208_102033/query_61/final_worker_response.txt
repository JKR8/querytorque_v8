WITH filtered_promotion AS (
    SELECT p_promo_sk
    FROM promotion
    WHERE p_channel_dmail = 'Y' 
       OR p_channel_email = 'Y' 
       OR p_channel_tv = 'Y'
),
dimensions AS (
    SELECT 
        d.d_date_sk,
        s.s_store_sk,
        c.c_customer_sk,
        ca.ca_address_sk,
        i.i_item_sk,
        i.i_category
    FROM date_dim d
    CROSS JOIN store s
    CROSS JOIN customer c
    INNER JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    CROSS JOIN item i
    WHERE d.d_year = 1999
      AND d.d_moy = 11
      AND s.s_gmt_offset = -7
      AND ca.ca_gmt_offset = -7
      AND i.i_category = 'Jewelry'
),
sales_aggregates AS (
    SELECT
        SUM(CASE 
            WHEN ss.ss_promo_sk IN (SELECT p_promo_sk FROM filtered_promotion) 
            THEN ss.ss_ext_sales_price 
        END) AS promotions,
        SUM(ss.ss_ext_sales_price) AS total
    FROM store_sales ss
    INNER JOIN dimensions d 
        ON ss.ss_sold_date_sk = d.d_date_sk
        AND ss.ss_store_sk = d.s_store_sk
        AND ss.ss_customer_sk = d.c_customer_sk
        AND ss.ss_item_sk = d.i_item_sk
)
SELECT
    promotions,
    total,
    CAST(promotions AS DECIMAL(15, 4)) / CAST(total AS DECIMAL(15, 4)) * 100 AS "CAST(promotions AS DECIMAL(15,"
FROM sales_aggregates
ORDER BY promotions, total
LIMIT 100;

-- Changes: Consolidated the two separate scans of store_sales into a single pass by pre-joining all dimension tables into a dimensions CTE and using conditional aggregation with a filtered promotion subquery.
-- Expected speedup: 3-4x by eliminating duplicate fact table scan and enabling optimal join ordering.