```sql
WITH filtered_dates AS MATERIALIZED (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_year = 1999
),
filtered_demographics AS MATERIALIZED (
    SELECT cd_demo_sk
    FROM customer_demographics
    WHERE cd_gender = 'F'
      AND cd_marital_status = 'D'
      AND cd_education_status = 'Secondary'
),
filtered_stores AS MATERIALIZED (
    SELECT s_store_sk, s_state
    FROM store
    WHERE s_state IN ('MO', 'AL', 'MI', 'TN', 'LA', 'SC')
),
pre_aggregated_sales AS MATERIALIZED (
    SELECT
        ss_item_sk,
        ss_store_sk,
        AVG(ss_quantity) AS agg1,
        AVG(ss_list_price) AS agg2,
        AVG(ss_coupon_amt) AS agg3,
        AVG(ss_sales_price) AS agg4
    FROM store_sales
    WHERE ss_cdemo_sk IN (SELECT cd_demo_sk FROM filtered_demographics)
      AND ss_sold_date_sk IN (SELECT d_date_sk FROM filtered_dates)
      AND ss_store_sk IN (SELECT s_store_sk FROM filtered_stores)
    GROUP BY ss_item_sk, ss_store_sk
)
SELECT
    i_item_id,
    s_state,
    GROUPING(s_state) AS g_state,
    agg1,
    agg2,
    agg3,
    agg4
FROM pre_aggregated_sales
JOIN item ON ss_item_sk = i_item_sk
JOIN filtered_stores ON ss_store_sk = s_store_sk
GROUP BY ROLLUP(i_item_id, s_state)
ORDER BY i_item_id, s_state
LIMIT 100;
```

```
Changes: Created materialized CTEs for filtered dimensions (date, demographics, store), then pre-aggregated store_sales at the (ss_item_sk, ss_store_sk) level before joining with dimension tables for the final ROLLUP computation.
Expected speedup: 2-3x through reduced join volume, early aggregation, and materialized dimension filtering.
```