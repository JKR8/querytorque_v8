```sql
WITH filtered_dates AS (
    SELECT d_date_sk
    FROM date_dim
    WHERE d_year = 2002
),
filtered_stores AS (
    SELECT s_store_sk
    FROM store
    WHERE s_state IN ('SD', 'TN', 'GA', 'SC', 'MO', 'AL', 'MI', 'OH')
),
item_sums AS (
    SELECT
        ss_item_sk,
        SUM(ss_net_profit) AS net_profit,
        SUM(ss_ext_sales_price) AS sales_price
    FROM store_sales
    JOIN filtered_dates ON ss_sold_date_sk = filtered_dates.d_date_sk
    JOIN filtered_stores ON ss_store_sk = filtered_stores.s_store_sk
    GROUP BY ss_item_sk
),
item_aggregates AS (
    SELECT
        i.i_category,
        i.i_class,
        SUM(item_sums.net_profit) AS net_profit,
        SUM(item_sums.sales_price) AS sales_price
    FROM item_sums
    JOIN item i ON item_sums.ss_item_sk = i.i_item_sk
    GROUP BY i.i_category, i.i_class
),
detailed AS (
    SELECT
        net_profit / sales_price AS gross_margin,
        i_category,
        i_class,
        0 AS lochierarchy
    FROM item_aggregates
    WHERE sales_price <> 0
),
category_summary AS (
    SELECT
        SUM(net_profit) / SUM(sales_price) AS gross_margin,
        i_category,
        NULL AS i_class,
        1 AS lochierarchy
    FROM item_aggregates
    WHERE sales_price <> 0
    GROUP BY i_category
),
grand_total AS (
    SELECT
        SUM(net_profit) / SUM(sales_price) AS gross_margin,
        NULL AS i_category,
        NULL AS i_class,
        2 AS lochierarchy
    FROM item_aggregates
    WHERE sales_price <> 0
),
all_levels AS (
    SELECT * FROM detailed
    UNION ALL
    SELECT * FROM category_summary
    UNION ALL
    SELECT * FROM grand_total
),
ranked AS (
    SELECT
        gross_margin,
        i_category,
        i_class,
        lochierarchy,
        CASE
            WHEN lochierarchy < 2 THEN
                RANK() OVER (
                    PARTITION BY lochierarchy,
                                 CASE WHEN lochierarchy = 0 THEN i_category END
                    ORDER BY gross_margin ASC
                )
            ELSE 1
        END AS rank_within_parent
    FROM all_levels
)
SELECT
    gross_margin,
    i_category,
    i_class,
    lochierarchy,
    rank_within_parent
FROM ranked
ORDER BY
    lochierarchy DESC,
    CASE WHEN lochierarchy = 0 THEN i_category END,
    rank_within_parent
LIMIT 100
```

**Changes**: 
1. Pre-filtered date_dim and store into small CTEs using only surrogate keys.
2. Aggregated store_sales at item level first (reducing fact rows before joining with item).
3. Replaced ROLLUP with explicit UNION ALL for three grouping levels.
4. Computed window ranking only on the first two levels (detail and category summary), avoiding window function overhead on grand total.

**Expected speedup**: 1.5-2x from reduced fact table scans and elimination of redundant window computations.