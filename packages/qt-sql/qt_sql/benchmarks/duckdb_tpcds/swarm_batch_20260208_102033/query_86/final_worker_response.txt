```sql
WITH base_aggregation AS (
  SELECT
    i.i_category,
    i.i_class,
    SUM(ws.ws_net_paid) AS total_sum
  FROM web_sales ws
  JOIN date_dim d1 ON d1.d_date_sk = ws.ws_sold_date_sk
  JOIN item i ON i.i_item_sk = ws.ws_item_sk
  WHERE d1.d_month_seq BETWEEN 1224 AND 1224 + 11
  GROUP BY i.i_category, i.i_class
),
level_category_class AS (
  SELECT
    total_sum,
    i_category,
    i_class,
    0 AS lochierarchy,
    RANK() OVER (
      PARTITION BY i_category
      ORDER BY total_sum DESC
    ) AS rank_within_parent
  FROM base_aggregation
),
level_category_only AS (
  SELECT
    SUM(total_sum) AS total_sum,
    i_category,
    CAST(NULL AS VARCHAR) AS i_class,
    1 AS lochierarchy,
    RANK() OVER (
      ORDER BY SUM(total_sum) DESC
    ) AS rank_within_parent
  FROM base_aggregation
  GROUP BY i_category
),
level_total AS (
  SELECT
    SUM(total_sum) AS total_sum,
    CAST(NULL AS VARCHAR) AS i_category,
    CAST(NULL AS VARCHAR) AS i_class,
    2 AS lochierarchy,
    RANK() OVER (
      ORDER BY SUM(total_sum) DESC
    ) AS rank_within_parent
  FROM base_aggregation
),
combined AS (
  SELECT * FROM level_category_class
  UNION ALL
  SELECT * FROM level_category_only
  UNION ALL
  SELECT * FROM level_total
)
SELECT
  total_sum,
  i_category,
  i_class,
  lochierarchy,
  rank_within_parent
FROM combined
ORDER BY
  lochierarchy DESC,
  CASE WHEN lochierarchy = 0 THEN i_category END,
  rank_within_parent
LIMIT 100
```

Changes: Decomposed the ROLLUP into three explicit aggregation levels (category+class, category-only, total) using a pre-aggregated base CTE. Computed ranks separately for each level on smaller datasets, then combined with UNION ALL. This eliminates ROLLUP overhead and reduces window function computation cost.

Expected speedup: 1.8â€“2.5x from eliminating ROLLUP complexity and computing ranks on smaller partitions.