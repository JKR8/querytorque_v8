{
  "id": "TOP_N_PER_GROUP_TO_LATERAL",
  "name": "Top N Per Group To Lateral",
  "description": "Convert correlated subqueries for \"top N per group\" to LATERAL joins\n      with LIMIT, enabling index-only scans per group instead of window\n      functions over entire dataset.",
  "category": "subquery_transformations",
  "priority": "medium",
  "verified_speedup": "unknown",
  "example": {
    "before_sql": "SELECT c.id, c.name,\n             (SELECT o.order_id FROM orders o \n              WHERE o.customer_id = c.id \n              ORDER BY o.order_date DESC LIMIT 1) AS latest_order\n      FROM customers c;",
    "after_sql": "SELECT c.id, c.name, latest.order_id AS latest_order\n      FROM customers c\n      LEFT JOIN LATERAL (\n          SELECT order_id\n          FROM orders\n          WHERE customer_id = c.id\n          ORDER BY order_date DESC\n          LIMIT 1\n      ) latest ON TRUE;",
    "alternative_sql": "",
    "key_insight": "Finding top N rows per group where an appropriate index exists on\n      (group_key, sort_column). Especially effective when N is small.",
    "transforms": [
      "top_n_per_group_to_lateral"
    ]
  },
  "metadata": {
    "pg_version": "9.3+",
    "auto_applied_by_pg": "false",
    "research_source": "",
    "notes": "With index on (customer_id, order_date DESC), PostgreSQL performs\n      efficient index scan per customer rather than sorting all orders."
  }
}