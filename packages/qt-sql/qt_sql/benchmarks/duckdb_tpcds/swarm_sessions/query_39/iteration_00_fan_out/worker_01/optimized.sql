WITH filtered_dates AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 1998 AND d_moy IN (1, 2)), inventory_join AS (SELECT w.w_warehouse_sk, i.i_item_sk, fd.d_moy, inv.inv_quantity_on_hand FROM inventory inv INNER JOIN filtered_dates fd ON inv.inv_date_sk = fd.d_date_sk INNER JOIN item i ON inv.inv_item_sk = i.i_item_sk INNER JOIN warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk), monthly_stats AS (SELECT w_warehouse_sk, i_item_sk, stddev_samp(CASE WHEN d_moy = 1 THEN inv_quantity_on_hand END) as stdev1, avg(CASE WHEN d_moy = 1 THEN inv_quantity_on_hand END) as mean1, stddev_samp(CASE WHEN d_moy = 2 THEN inv_quantity_on_hand END) as stdev2, avg(CASE WHEN d_moy = 2 THEN inv_quantity_on_hand END) as mean2 FROM inventory_join GROUP BY w_warehouse_sk, i_item_sk) SELECT w_warehouse_sk, i_item_sk, 1 as d_moy, mean1 as mean, CASE WHEN mean1 = 0 THEN NULL ELSE stdev1/mean1 END as cov, w_warehouse_sk, i_item_sk, 2 as d_moy, mean2 as mean, CASE WHEN mean2 = 0 THEN NULL ELSE stdev2/mean2 END as cov FROM monthly_stats WHERE CASE WHEN mean1 = 0 THEN 0 ELSE stdev1/mean1 END > 1 AND CASE WHEN mean2 = 0 THEN 0 ELSE stdev2/mean2 END > 1 ORDER BY w_warehouse_sk, i_item_sk, 1, mean1, CASE WHEN mean1 = 0 THEN NULL ELSE stdev1/mean1 END, 2, mean2, CASE WHEN mean2 = 0 THEN NULL ELSE stdev2/mean2 END