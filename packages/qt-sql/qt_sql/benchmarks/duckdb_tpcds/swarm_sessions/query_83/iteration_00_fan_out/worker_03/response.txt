### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_dates  [+]
│   ├── SCAN (date_dim)
│   ├── FILTER (d_week_seq IN (subquery))
│   └── OUTPUT (d_date_sk)
├── [CTE] sr_prejoin  [+]
│   ├── SCAN (store_returns)
│   ├── JOIN filtered_dates (sr_returned_date_sk = d_date_sk)
│   └── OUTPUT (sr_item_sk, sr_return_quantity)
├── [CTE] cr_prejoin  [+]
│   ├── SCAN (catalog_returns)
│   ├── JOIN filtered_dates (cr_returned_date_sk = d_date_sk)
│   └── OUTPUT (cr_item_sk, cr_return_quantity)
├── [CTE] wr_prejoin  [+]
│   ├── SCAN (web_returns)
│   ├── JOIN filtered_dates (wr_returned_date_sk = d_date_sk)
│   └── OUTPUT (wr_item_sk, wr_return_quantity)
├── [CTE] sr_items  [~]
│   ├── SCAN (sr_prejoin, item (join))
│   ├── JOIN (sr_item_sk = i_item_sk)
│   ├── AGG (GROUP BY i_item_id)
│   └── OUTPUT (item_id, sr_item_qty)
├── [CTE] cr_items  [~]
│   ├── SCAN (cr_prejoin, item (join))
│   ├── JOIN (cr_item_sk = i_item_sk)
│   ├── AGG (GROUP BY i_item_id)
│   └── OUTPUT (item_id, cr_item_qty)
├── [CTE] wr_items  [~]
│   ├── SCAN (wr_prejoin, item (join))
│   ├── JOIN (wr_item_sk = i_item_sk)
│   ├── AGG (GROUP BY i_item_id)
│   └── OUTPUT (item_id, wr_item_qty)
└── [MAIN] main_query  [=]
    ├── SCAN (sr_items, cr_items (join), wr_items (join))
    ├── JOIN (sr_items.item_id = cr_items.item_id)
    ├── JOIN (sr_items.item_id = wr_items.item_id)
    ├── AGG (GROUP BY)
    ├── SORT (sr_items.item_id ASC, sr_item_qty ASC)
    └── OUTPUT (item_id, sr_item_qty, sr_dev, cr_item_qty, cr_dev, wr_item_qty, wr_dev, average)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "date_cte_isolate", "description": "Extract date filter into reusable CTE to reduce redundant date_dim scans", "applied_to": ["filtered_dates"]},
    {"id": "R2", "type": "prefetch_fact_join", "description": "Stage joins: filter dates first, then join with each returns table before item dimension", "applied_to": ["sr_prejoin", "cr_prejoin", "wr_prejoin", "sr_items", "cr_items", "wr_items"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_date IN ('2001-06-06', '2001-09-02', '2001-11-11'))",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "sr_prejoin": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT sr_item_sk, sr_return_quantity FROM store_returns JOIN filtered_dates ON sr_returned_date_sk = d_date_sk",
        "interfaces": {"outputs": ["sr_item_sk", "sr_return_quantity"], "consumes": ["filtered_dates"]}
      },
      "cr_prejoin": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cr_item_sk, cr_return_quantity FROM catalog_returns JOIN filtered_dates ON cr_returned_date_sk = d_date_sk",
        "interfaces": {"outputs": ["cr_item_sk", "cr_return_quantity"], "consumes": ["filtered_dates"]}
      },
      "wr_prejoin": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT wr_item_sk, wr_return_quantity FROM web_returns JOIN filtered_dates ON wr_returned_date_sk = d_date_sk",
        "interfaces": {"outputs": ["wr_item_sk", "wr_return_quantity"], "consumes": ["filtered_dates"]}
      },
      "sr_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty FROM sr_prejoin JOIN item ON sr_item_sk = i_item_sk GROUP BY i_item_id",
        "interfaces": {"outputs": ["item_id", "sr_item_qty"], "consumes": ["sr_prejoin"]}
      },
      "cr_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty FROM cr_prejoin JOIN item ON cr_item_sk = i_item_sk GROUP BY i_item_id",
        "interfaces": {"outputs": ["item_id", "cr_item_qty"], "consumes": ["cr_prejoin"]}
      },
      "wr_items": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty FROM wr_prejoin JOIN item ON wr_item_sk = i_item_sk GROUP BY i_item_id",
        "interfaces": {"outputs": ["item_id", "wr_item_qty"], "consumes": ["wr_prejoin"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["item_id", "sr_item_qty", "sr_dev", "cr_item_qty", "cr_dev", "wr_item_qty", "wr_dev", "average"], "consumes": ["sr_items", "cr_items", "wr_items"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "sr_prejoin", "cr_prejoin", "wr_prejoin", "sr_items", "cr_items", "wr_items", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), sr_prejoin AS ({sr_prejoin}), cr_prejoin AS ({cr_prejoin}), wr_prejoin AS ({wr_prejoin}), sr_items AS ({sr_items}), cr_items AS ({cr_items}), wr_items AS ({wr_items}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Introduced a reusable `filtered_dates` CTE to reduce 9 date_dim scans to 2, and staged joins by first filtering returns with dates, then joining with item dimension to reduce intermediate data volume.

Expected speedup: 1.5-2x (date_dim scan reduced from 9 to 2, returns tables filtered earlier, but added CTE materialization overhead).