WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_week_seq IN (SELECT d_week_seq FROM date_dim WHERE d_date IN ('2001-06-06', '2001-09-02', '2001-11-11'))), all_returns_union AS (SELECT returns.item_sk, returns.return_qty, returns.channel FROM (SELECT sr_item_sk AS item_sk, sr_returned_date_sk AS returned_date_sk, sr_return_quantity AS return_qty, 'store' AS channel FROM store_returns UNION ALL SELECT cr_item_sk, cr_returned_date_sk, cr_return_quantity, 'catalog' FROM catalog_returns UNION ALL SELECT wr_item_sk, wr_returned_date_sk, wr_return_quantity, 'web' FROM web_returns) AS returns JOIN filtered_dates ON returns.returned_date_sk = filtered_dates.d_date_sk), item_join AS (SELECT i.i_item_id AS item_id, a.return_qty, a.channel FROM all_returns_union a JOIN item i ON a.item_sk = i.i_item_sk), channel_aggregation AS (SELECT item_id, channel, SUM(return_qty) AS channel_qty FROM item_join GROUP BY item_id, channel) SELECT item_id, sr_item_qty, sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS sr_dev, cr_item_qty, cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS cr_dev, wr_item_qty, wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS wr_dev, (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average FROM (SELECT item_id, MAX(CASE WHEN channel = 'store' THEN channel_qty END) AS sr_item_qty, MAX(CASE WHEN channel = 'catalog' THEN channel_qty END) AS cr_item_qty, MAX(CASE WHEN channel = 'web' THEN channel_qty END) AS wr_item_qty FROM channel_aggregation GROUP BY item_id HAVING COUNT(DISTINCT channel) = 3) AS pivot ORDER BY item_id, sr_item_qty LIMIT 100