## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] dim_dates_4yr [+] Cost: 5% Rows: ~1460 — Filter date_dim for 2000-2003 for store sales analysis
├── [CTE] dim_may2000 [+] Cost: 5% Rows: ~31 — Filter date_dim for May 2000 for catalog/web sales
├── [CTE] dim_items_frequent [~] Cost: 25% Rows: ~1K — Join store_sales with dim_dates_4yr and item, group by item+date
│   ├── SCAN (store_sales, dim_dates_4yr, item)
│   ├── JOIN (ss_sold_date_sk = d_date_sk)
│   ├── JOIN (ss_item_sk = i_item_sk)
│   ├── AGG (GROUP BY substr(i_item_desc,1,30), i_item_sk, d_date)
│   └── HAVING (count(*) > 4)
├── [CTE] dim_customers_top [~] Cost: 25% Rows: ~1K — Join store_sales with customer and dim_dates_4yr, filter by 95th percentile
│   ├── SCAN (store_sales, customer, dim_dates_4yr)
│   ├── JOIN (ss_customer_sk = c_customer_sk)
│   ├── JOIN (ss_sold_date_sk = d_date_sk)
│   ├── AGG (GROUP BY c_customer_sk)
│   └── HAVING (sum(ss_quantity*ss_sales_price) > 95% of max)
├── [CTE] fact_catalog [+] Cost: 10% Rows: ~? — Join catalog_sales with dim_may2000, dim_items_frequent, dim_customers_top, customer
│   ├── SCAN (catalog_sales, dim_may2000, dim_items_frequent, dim_customers_top, customer)
│   └── JOIN (cs_sold_date_sk, cs_item_sk, cs_bill_customer_sk)
├── [CTE] fact_web [+] Cost: 10% Rows: ~? — Join web_sales with dim_may2000, dim_items_frequent, dim_customers_top, customer
│   ├── SCAN (web_sales, dim_may2000, dim_items_frequent, dim_customers_top, customer)
│   └── JOIN (ws_sold_date_sk, ws_item_sk, ws_bill_customer_sk)
├── [CTE] union_all [+] Cost: 5% Rows: ~? — UNION ALL of fact_catalog and fact_web
├── [CTE] group_by [+] Cost: 5% Rows: ~? — Group union_all by c_last_name, c_first_name
└── [MAIN] order_by_limit [+] Cost: 10% Rows: 100 — Order and limit final result
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Extract date filters into separate CTEs before joining", "applied_to": ["dim_dates_4yr", "dim_may2000"]},
    {"id": "R2", "type": "prefetch_fact_join", "description": "Build staged join pipeline: date CTEs → store_sales CTEs → catalog/web facts", "applied_to": ["dim_items_frequent", "dim_customers_top", "fact_catalog", "fact_web"]},
    {"id": "R3", "type": "union_cte_split", "description": "Split original UNION into separate CTEs for catalog and web sales", "applied_to": ["fact_catalog", "fact_web", "union_all"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "dim_dates_4yr": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_date, d_year FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)",
        "interfaces": {"outputs": ["d_date_sk", "d_date", "d_year"], "consumes": []}
      },
      "dim_may2000": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000 AND d_moy = 5",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "dim_items_frequent": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk AS item_sk, substr(i_item_desc,1,30) AS itemdesc, d_date AS solddate, count(*) AS cnt FROM store_sales JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk GROUP BY substr(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4",
        "interfaces": {"outputs": ["item_sk", "itemdesc", "solddate", "cnt"], "consumes": ["dim_dates_4yr"]}
      },
      "dim_customers_top": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_customer_sk, sum(ss_quantity*ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk HAVING sum(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT max(csales) FROM (SELECT c_customer_sk, sum(ss_quantity*ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk))",
        "interfaces": {"outputs": ["c_customer_sk", "ssales"], "consumes": ["dim_dates_4yr"]}
      },
      "fact_catalog": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT customer.c_last_name, customer.c_first_name, cs_quantity*cs_list_price AS sales FROM catalog_sales JOIN dim_may2000 ON cs_sold_date_sk = dim_may2000.d_date_sk JOIN dim_items_frequent ON cs_item_sk = dim_items_frequent.item_sk JOIN dim_customers_top ON cs_bill_customer_sk = dim_customers_top.c_customer_sk JOIN customer ON cs_bill_customer_sk = customer.c_customer_sk",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["dim_may2000", "dim_items_frequent", "dim_customers_top"]}
      },
      "fact_web": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT customer.c_last_name, customer.c_first_name, ws_quantity*ws_list_price AS sales FROM web_sales JOIN dim_may2000 ON ws_sold_date_sk = dim_may2000.d_date_sk JOIN dim_items_frequent ON ws_item_sk = dim_items_frequent.item_sk JOIN dim_customers_top ON ws_bill_customer_sk = dim_customers_top.c_customer_sk JOIN customer ON ws_bill_customer_sk = customer.c_customer_sk",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["dim_may2000", "dim_items_frequent", "dim_customers_top"]}
      },
      "union_all": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c_last_name, c_first_name, sales FROM fact_catalog UNION ALL SELECT c_last_name, c_first_name, sales FROM fact_web",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["fact_catalog", "fact_web"]}
      },
      "group_by": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c_last_name, c_first_name, sum(sales) AS sales FROM union_all GROUP BY c_last_name, c_first_name",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["union_all"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT c_last_name, c_first_name, sales FROM group_by ORDER BY c_last_name, c_first_name, sales LIMIT 100",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["group_by"]}
      }
    },
    "reconstruction_order": ["dim_dates_4yr", "dim_may2000", "dim_items_frequent", "dim_customers_top", "fact_catalog", "fact_web", "union_all", "group_by", "main_query"],
    "assembly_template": "WITH dim_dates_4yr AS ({dim_dates_4yr}), dim_may2000 AS ({dim_may2000}), dim_items_frequent AS ({dim_items_frequent}), dim_customers_top AS ({dim_customers_top}), fact_catalog AS ({fact_catalog}), fact_web AS ({fact_web}), union_all AS ({union_all}), group_by AS ({group_by}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Isolated date filters into separate CTEs (dim_dates_4yr, dim_may2000), restructured store_sales CTEs to consume date CTEs, split UNION into separate fact CTEs, and built staged join pipeline.

**Expected speedup**: 1.8-2.2x due to dimension isolation and staged join pipeline reducing repeated store_sales scans and creating small hash tables for date and customer filters.