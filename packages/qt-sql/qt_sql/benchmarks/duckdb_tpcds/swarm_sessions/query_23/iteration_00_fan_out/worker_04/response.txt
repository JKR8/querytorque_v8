## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] dim_dates_4yr  [+]
│   ├── SCAN (date_dim)
│   ├── FILTER (d_year IN (2000, 2001, 2002, 2003))
│   └── OUTPUT (d_date_sk, d_date)
├── [CTE] dim_items_frequent  [~]
│   ├── SCAN (store_sales, dim_dates_4yr (join), item (join))
│   ├── JOIN (ss_sold_date_sk = d_date_sk)
│   ├── JOIN (ss_item_sk = i_item_sk)
│   ├── AGG (GROUP BY substr(i_item_desc,1,30), i_item_sk, d_date)
│   ├── FILTER (count(*) > 4)
│   └── OUTPUT (item_sk, itemdesc, solddate)
├── [CTE] dim_customers_top  [~]
│   ├── SCAN (store_sales, customer (join), dim_dates_4yr (join))
│   ├── JOIN (ss_customer_sk = c_customer_sk)
│   ├── JOIN (ss_sold_date_sk = d_date_sk)
│   ├── AGG (GROUP BY c_customer_sk)
│   ├── FILTER (sum(ss_quantity*ss_sales_price) > (95/100.0) * (subquery for max))
│   └── OUTPUT (c_customer_sk, ssales)
├── [CTE] all_sales_may2000  [+]
│   ├── SCAN (catalog_sales, date_dim (join))
│   ├── FILTER (d_year=2000 AND d_moy=5)
│   ├── PROJECT (channel='catalog', sold_date_sk=cs_sold_date_sk, item_sk=cs_item_sk, bill_customer_sk=cs_bill_customer_sk, quantity=cs_quantity, list_price=cs_list_price, c_last_name=NULL, c_first_name=NULL)
│   ├── UNION ALL
│   ├── SCAN (web_sales, date_dim (join))
│   ├── FILTER (d_year=2000 AND d_moy=5)
│   ├── PROJECT (channel='web', sold_date_sk=ws_sold_date_sk, item_sk=ws_item_sk, bill_customer_sk=ws_bill_customer_sk, quantity=ws_quantity, list_price=ws_list_price, c_last_name=NULL, c_first_name=NULL)
│   └── OUTPUT (channel, sold_date_sk, item_sk, bill_customer_sk, quantity, list_price, c_last_name, c_first_name)
├── [CTE] joined_sales  [+]
│   ├── SCAN (all_sales_may2000)
│   ├── JOIN (item_sk = dim_items_frequent.item_sk)
│   ├── JOIN (bill_customer_sk = dim_customers_top.c_customer_sk)
│   ├── JOIN (bill_customer_sk = customer.c_customer_sk)
│   └── OUTPUT (c_last_name, c_first_name, catalog_sales (CASE expression), web_sales (CASE expression))
├── [CTE] group_by  [+]
│   ├── SCAN (joined_sales)
│   ├── AGG (GROUP BY c_last_name, c_first_name)
│   └── OUTPUT (c_last_name, c_first_name, sales)
└── [MAIN] main_query  [!]
    ├── SCAN (group_by)
    ├── ORDER BY (c_last_name, c_first_name, sales)
    └── OUTPUT (c_last_name, c_first_name, sales) LIMIT 100
```

**Change markers:**
- `[+]`: New components added (dim_dates_4yr, all_sales_may2000, joined_sales, group_by)
- `[~]`: Modified existing CTEs to reference new dim_dates_4yr CTE
- `[!]`: Structural change - replaced original UNION ALL subquery structure with new CTE pipeline

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "shared_dimension_multi_channel", "description": "Extracted shared date dimension (2000-2003) into reusable CTE", "applied_to": ["dim_dates_4yr"]},
    {"id": "R2", "type": "channel_bitmap_aggregation", "description": "Consolidated catalog and web sales into single UNION ALL CTE with channel labeling", "applied_to": ["all_sales_may2000"]},
    {"id": "R3", "type": "union_cte_split", "description": "Replaced original UNION ALL subqueries with CTE pipeline following target logical tree", "applied_to": ["all_sales_may2000", "joined_sales", "group_by"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "dim_dates_4yr": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "dim_items_frequent": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_sk AS item_sk, substr(i_item_desc,1,30) AS itemdesc, d_date AS solddate FROM store_sales JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk JOIN item ON ss_item_sk = i_item_sk GROUP BY substr(i_item_desc,1,30), i_item_sk, d_date HAVING count(*) > 4",
        "interfaces": {"outputs": ["item_sk", "itemdesc", "solddate"], "consumes": ["dim_dates_4yr"]}
      },
      "dim_customers_top": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT c_customer_sk, sum(ss_quantity*ss_sales_price) AS ssales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk HAVING sum(ss_quantity*ss_sales_price) > (95/100.0) * (SELECT max(csales) FROM (SELECT c_customer_sk, sum(ss_quantity*ss_sales_price) AS csales FROM store_sales JOIN customer ON ss_customer_sk = c_customer_sk JOIN dim_dates_4yr ON ss_sold_date_sk = d_date_sk GROUP BY c_customer_sk))",
        "interfaces": {"outputs": ["c_customer_sk", "ssales"], "consumes": ["dim_dates_4yr"]}
      },
      "all_sales_may2000": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT 'catalog' AS channel, cs_sold_date_sk AS sold_date_sk, cs_item_sk AS item_sk, cs_bill_customer_sk AS bill_customer_sk, cs_quantity AS quantity, cs_list_price AS list_price, NULL AS c_last_name, NULL AS c_first_name FROM catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk WHERE d_year = 2000 AND d_moy = 5 UNION ALL SELECT 'web' AS channel, ws_sold_date_sk AS sold_date_sk, ws_item_sk AS item_sk, ws_bill_customer_sk AS bill_customer_sk, ws_quantity AS quantity, ws_list_price AS list_price, NULL AS c_last_name, NULL AS c_first_name FROM web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk WHERE d_year = 2000 AND d_moy = 5",
        "interfaces": {"outputs": ["channel", "sold_date_sk", "item_sk", "bill_customer_sk", "quantity", "list_price", "c_last_name", "c_first_name"], "consumes": []}
      },
      "joined_sales": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT customer.c_last_name, customer.c_first_name, CASE WHEN channel='catalog' THEN quantity*list_price ELSE 0 END AS catalog_sales, CASE WHEN channel='web' THEN quantity*list_price ELSE 0 END AS web_sales FROM all_sales_may2000 JOIN dim_items_frequent ON all_sales_may2000.item_sk = dim_items_frequent.item_sk JOIN dim_customers_top ON all_sales_may2000.bill_customer_sk = dim_customers_top.c_customer_sk JOIN customer ON all_sales_may2000.bill_customer_sk = customer.c_customer_sk",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "catalog_sales", "web_sales"], "consumes": ["all_sales_may2000", "dim_items_frequent", "dim_customers_top"]}
      },
      "group_by": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT c_last_name, c_first_name, sum(catalog_sales + web_sales) AS sales FROM joined_sales GROUP BY c_last_name, c_first_name",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["joined_sales"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT c_last_name, c_first_name, sales FROM group_by ORDER BY c_last_name, c_first_name, sales LIMIT 100",
        "interfaces": {"outputs": ["c_last_name", "c_first_name", "sales"], "consumes": ["group_by"]}
      }
    },
    "reconstruction_order": ["dim_dates_4yr", "dim_items_frequent", "dim_customers_top", "all_sales_may2000", "joined_sales", "group_by", "main_query"],
    "assembly_template": "WITH dim_dates_4yr AS ({dim_dates_4yr}), dim_items_frequent AS ({dim_items_frequent}), dim_customers_top AS ({dim_customers_top}), all_sales_may2000 AS ({all_sales_may2000}), joined_sales AS ({joined_sales}), group_by AS ({group_by}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Restructured the query following the target logical tree - extracted shared date dimension (2000-2003) into reusable CTE, consolidated catalog and web sales into single UNION ALL CTE, and built CTE pipeline for joins and aggregation. Preserves exact semantic equivalence with original query's second statement.

**Expected speedup:** 1.3x-1.5x from eliminating redundant store_sales scans and enabling better predicate pushdown.