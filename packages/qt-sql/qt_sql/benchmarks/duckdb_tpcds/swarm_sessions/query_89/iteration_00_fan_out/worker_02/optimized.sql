WITH filtered_tables_join AS (SELECT i.i_category, i.i_class, i.i_brand, s.s_store_name, s.s_company_name, d.d_moy, ss.ss_sales_price FROM (SELECT i_item_sk, i_category, i_class, i_brand FROM item WHERE ((i_category IN ('Jewelry','Shoes','Electronics') AND i_class IN ('semi-precious','athletic','portable')) OR (i_category IN ('Men','Music','Women') AND i_class IN ('accessories','rock','maternity')))) AS i INNER JOIN store_sales ss ON ss.ss_item_sk = i.i_item_sk INNER JOIN (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 1999) AS d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN (SELECT s_store_sk, s_store_name, s_company_name FROM store WHERE s_store_sk <= 100) AS s ON ss.ss_store_sk = s.s_store_sk), aggregated AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, SUM(ss_sales_price) AS sum_sales FROM filtered_tables_join GROUP BY i_category, i_class, i_brand, s_store_name, s_company_name, d_moy), windowed AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_category, i_brand, s_store_name, s_company_name) AS avg_monthly_sales FROM aggregated), filtered AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, avg_monthly_sales FROM windowed WHERE CASE WHEN avg_monthly_sales <> 0 THEN ABS(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1), ordered AS (SELECT i_category, i_class, i_brand, s_store_name, s_company_name, d_moy, sum_sales, avg_monthly_sales FROM filtered ORDER BY (sum_sales - avg_monthly_sales) ASC, s_store_name ASC LIMIT 100) SELECT * FROM ordered