WITH date_filter AS (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)), item_filter AS (SELECT i_item_sk FROM item WHERE i_current_price > 50), promo_filter AS (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'), ssr_sales_agg AS (SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(ss_net_profit) AS net_profit FROM store_sales INNER JOIN date_filter ON ss_sold_date_sk = d_date_sk INNER JOIN item_filter ON ss_item_sk = i_item_sk INNER JOIN promo_filter ON ss_promo_sk = p_promo_sk INNER JOIN store ON ss_store_sk = s_store_sk GROUP BY s_store_id), ssr_returns_agg AS (SELECT s_store_id AS store_id, SUM(sr_return_amt) AS returns_amt, SUM(sr_net_loss) AS net_loss FROM store_sales INNER JOIN date_filter ON ss_sold_date_sk = d_date_sk INNER JOIN item_filter ON ss_item_sk = i_item_sk INNER JOIN promo_filter ON ss_promo_sk = p_promo_sk INNER JOIN store ON ss_store_sk = s_store_sk INNER JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number) GROUP BY s_store_id), ssr_join AS (SELECT store_id, sales, COALESCE(returns_amt, 0) AS "returns", net_profit - COALESCE(net_loss, 0) AS profit FROM ssr_sales_agg LEFT JOIN ssr_returns_agg USING (store_id)), csr_sales_agg AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(cs_net_profit) AS net_profit FROM catalog_sales INNER JOIN date_filter ON cs_sold_date_sk = d_date_sk INNER JOIN item_filter ON cs_item_sk = i_item_sk INNER JOIN promo_filter ON cs_promo_sk = p_promo_sk INNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk GROUP BY cp_catalog_page_id), csr_returns_agg AS (SELECT cp_catalog_page_id AS catalog_page_id, SUM(cr_return_amount) AS returns_amt, SUM(cr_net_loss) AS net_loss FROM catalog_sales INNER JOIN date_filter ON cs_sold_date_sk = d_date_sk INNER JOIN item_filter ON cs_item_sk = i_item_sk INNER JOIN promo_filter ON cs_promo_sk = p_promo_sk INNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk INNER JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number) GROUP BY cp_catalog_page_id), csr_join AS (SELECT catalog_page_id, sales, COALESCE(returns_amt, 0) AS "returns", net_profit - COALESCE(net_loss, 0) AS profit FROM csr_sales_agg LEFT JOIN csr_returns_agg USING (catalog_page_id)), wsr_sales_agg AS (SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(ws_net_profit) AS net_profit FROM web_sales INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk INNER JOIN item_filter ON ws_item_sk = i_item_sk INNER JOIN promo_filter ON ws_promo_sk = p_promo_sk INNER JOIN web_site ON ws_web_site_sk = web_site_sk GROUP BY web_site_id), wsr_returns_agg AS (SELECT web_site_id, SUM(wr_return_amt) AS returns_amt, SUM(wr_net_loss) AS net_loss FROM web_sales INNER JOIN date_filter ON ws_sold_date_sk = d_date_sk INNER JOIN item_filter ON ws_item_sk = i_item_sk INNER JOIN promo_filter ON ws_promo_sk = p_promo_sk INNER JOIN web_site ON ws_web_site_sk = web_site_sk INNER JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number) GROUP BY web_site_id), wsr_join AS (SELECT web_site_id, sales, COALESCE(returns_amt, 0) AS "returns", net_profit - COALESCE(net_loss, 0) AS profit FROM wsr_sales_agg LEFT JOIN wsr_returns_agg USING (web_site_id)) SELECT channel, id, SUM(sales) AS sales, SUM("returns") AS "returns", SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, 'store' || store_id AS id, sales, "returns", profit FROM ssr_join UNION ALL SELECT 'catalog channel' AS channel, 'catalog_page' || catalog_page_id AS id, sales, "returns", profit FROM csr_join UNION ALL SELECT 'web channel' AS channel, 'web_site' || web_site_id AS id, sales, "returns", profit FROM wsr_join) x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100