## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] ssr_early [~] — Changed FROM to explicit JOIN syntax with conditions in ON clauses; ensured LEFT JOIN after all INNER JOINs.
│   ├── SCAN (store_sales, date_dim, item, promotion, store, store_returns)
│   ├── JOIN (INNER: store_sales -> date_dim ON ss_sold_date_sk=d_date_sk AND d_date BETWEEN ...)
│   ├── JOIN (INNER: store_sales -> item ON ss_item_sk=i_item_sk AND i_current_price>50)
│   ├── JOIN (INNER: store_sales -> promotion ON ss_promo_sk=p_promo_sk AND p_channel_tv='N')
│   ├── JOIN (INNER: store_sales -> store ON ss_store_sk=s_store_sk)
│   ├── JOIN (LEFT: store_sales -> store_returns ON ss_item_sk=sr_item_sk AND ss_ticket_number=sr_ticket_number)
│   ├── AGG (GROUP BY s_store_id)
│   └── OUTPUT (store_id, sales, returns, profit)
├── [CTE] csr_early [~] — Same transformation: explicit JOIN with conditions in ON clauses.
│   ├── SCAN (catalog_sales, date_dim, item, promotion, catalog_page, catalog_returns)
│   ├── JOIN (INNER: catalog_sales -> date_dim ON cs_sold_date_sk=d_date_sk AND d_date BETWEEN ...)
│   ├── JOIN (INNER: catalog_sales -> item ON cs_item_sk=i_item_sk AND i_current_price>50)
│   ├── JOIN (INNER: catalog_sales -> promotion ON cs_promo_sk=p_promo_sk AND p_channel_tv='N')
│   ├── JOIN (INNER: catalog_sales -> catalog_page ON cs_catalog_page_sk=cp_catalog_page_sk)
│   ├── JOIN (LEFT: catalog_sales -> catalog_returns ON cs_item_sk=cr_item_sk AND cs_order_number=cr_order_number)
│   ├── AGG (GROUP BY cp_catalog_page_id)
│   └── OUTPUT (catalog_page_id, sales, returns, profit)
├── [CTE] wsr_early [~] — Same transformation: explicit JOIN with conditions in ON clauses.
│   ├── SCAN (web_sales, date_dim, item, promotion, web_site, web_returns)
│   ├── JOIN (INNER: web_sales -> date_dim ON ws_sold_date_sk=d_date_sk AND d_date BETWEEN ...)
│   ├── JOIN (INNER: web_sales -> item ON ws_item_sk=i_item_sk AND i_current_price>50)
│   ├── JOIN (INNER: web_sales -> promotion ON ws_promo_sk=p_promo_sk AND p_channel_tv='N')
│   ├── JOIN (INNER: web_sales -> web_site ON ws_web_site_sk=web_site_sk)
│   ├── JOIN (LEFT: web_sales -> web_returns ON ws_item_sk=wr_item_sk AND ws_order_number=wr_order_number)
│   ├── AGG (GROUP BY web_site_id)
│   └── OUTPUT (web_site_id, sales, returns, profit)
└── [MAIN] main_query [=] — Unchanged: union of CTEs with rollup.
    ├── SCAN (ssr_early, csr_early, wsr_early)
    ├── AGG (GROUP BY ROLLUP(channel, id))
    ├── SORT (channel ASC, id ASC)
    └── OUTPUT (channel, id, sales, returns, profit)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "explicit_join_reordering",
      "description": "Convert comma-joins to explicit JOIN syntax with filters in ON clauses to force early filtering before LEFT JOIN",
      "applied_to": ["ssr_early", "csr_early", "wsr_early"]
    }
  ],
  "statements": [
    {
      "target_table": null,
      "change": "modified",
      "components": {
        "ssr_early": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT s_store_id AS store_id,\n       SUM(ss_ext_sales_price) AS sales,\n       SUM(COALESCE(sr_return_amt, 0)) AS \"returns\",\n       SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit\nFROM store_sales\nINNER JOIN date_dim ON ss_sold_date_sk = d_date_sk\n   AND d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)\nINNER JOIN item ON ss_item_sk = i_item_sk\n   AND i_current_price > 50\nINNER JOIN promotion ON ss_promo_sk = p_promo_sk\n   AND p_channel_tv = 'N'\nINNER JOIN store ON ss_store_sk = s_store_sk\nLEFT JOIN store_returns ON (ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)\nGROUP BY s_store_id",
          "interfaces": {
            "outputs": ["store_id", "sales", "returns", "profit"],
            "consumes": []
          }
        },
        "csr_early": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT cp_catalog_page_id AS catalog_page_id,\n       SUM(cs_ext_sales_price) AS sales,\n       SUM(COALESCE(cr_return_amount, 0)) AS \"returns\",\n       SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit\nFROM catalog_sales\nINNER JOIN date_dim ON cs_sold_date_sk = d_date_sk\n   AND d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)\nINNER JOIN item ON cs_item_sk = i_item_sk\n   AND i_current_price > 50\nINNER JOIN promotion ON cs_promo_sk = p_promo_sk\n   AND p_channel_tv = 'N'\nINNER JOIN catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk\nLEFT JOIN catalog_returns ON (cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)\nGROUP BY cp_catalog_page_id",
          "interfaces": {
            "outputs": ["catalog_page_id", "sales", "returns", "profit"],
            "consumes": []
          }
        },
        "wsr_early": {
          "type": "cte",
          "change": "modified",
          "sql": "SELECT web_site_id,\n       SUM(ws_ext_sales_price) AS sales,\n       SUM(COALESCE(wr_return_amt, 0)) AS \"returns\",\n       SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit\nFROM web_sales\nINNER JOIN date_dim ON ws_sold_date_sk = d_date_sk\n   AND d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)\nINNER JOIN item ON ws_item_sk = i_item_sk\n   AND i_current_price > 50\nINNER JOIN promotion ON ws_promo_sk = p_promo_sk\n   AND p_channel_tv = 'N'\nINNER JOIN web_site ON ws_web_site_sk = web_site_sk\nLEFT JOIN web_returns ON (ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)\nGROUP BY web_site_id",
          "interfaces": {
            "outputs": ["web_site_id", "sales", "returns", "profit"],
            "consumes": []
          }
        },
        "main_query": {
          "type": "main_query",
          "change": "unchanged",
          "sql": "",
          "interfaces": {
            "outputs": ["channel", "id", "sales", "returns", "profit"],
            "consumes": ["ssr_early", "csr_early", "wsr_early"]
          }
        }
      },
      "reconstruction_order": ["ssr_early", "csr_early", "wsr_early", "main_query"],
      "assembly_template": "WITH ssr_early AS ({ssr_early}),\n     csr_early AS ({csr_early}),\n     wsr_early AS ({wsr_early})\nSELECT channel,\n       id,\n       SUM(sales) AS sales,\n       SUM(\"returns\") AS \"returns\",\n       SUM(profit) AS profit\nFROM (SELECT 'store channel' AS channel,\n             'store' || store_id AS id,\n             sales,\n             \"returns\",\n             profit\n      FROM ssr_early\n      UNION ALL\n      SELECT 'catalog channel' AS channel,\n             'catalog_page' || catalog_page_id AS id,\n             sales,\n             \"returns\",\n             profit\n      FROM csr_early\n      UNION ALL\n      SELECT 'web channel' AS channel,\n             'web_site' || web_site_id AS id,\n             sales,\n             \"returns\",\n             profit\n      FROM wsr_early) x\nGROUP BY ROLLUP(channel, id)\nORDER BY channel, id\nLIMIT 100"
    }
  ],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Converted comma-style joins to explicit INNER/LEFT JOIN syntax with all dimension filters in ON clauses, ensuring sales are filtered by date, price, and promotion before matching returns. This enforces early filtering while preserving LEFT JOIN semantics.

**Expected speedup**: 2-4x due to reduced intermediate row count before LEFT JOIN and better predicate pushdown opportunities.