## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] ssr  [~]  Cost: 25%  Rows: 51  — Modified to use pre-filtered store_sales subquery with dimension key lookups before left join to returns
│   ├── SCAN (store_sales)
│   ├── FILTER (ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN ...))
│   ├── FILTER (ss_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50))
│   ├── FILTER (ss_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'))
│   ├── LEFT JOIN (store_returns ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number)
│   ├── INNER JOIN (store ON ss_store_sk = s_store_sk)
│   ├── AGG (GROUP BY s_store_id)
│   └── OUTPUT (store_id, sales, returns, profit)
├── [CTE] csr  [~]  Cost: 25%  Rows: 444  — Modified to use pre-filtered catalog_sales subquery with dimension key lookups before left join to returns
│   ├── SCAN (catalog_sales)
│   ├── FILTER (cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN ...))
│   ├── FILTER (cs_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50))
│   ├── FILTER (cs_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'))
│   ├── LEFT JOIN (catalog_returns ON cs_item_sk = cr_item_sk AND cs_order_number = cr_order_number)
│   ├── INNER JOIN (catalog_page ON cs_catalog_page_sk = cp_catalog_page_sk)
│   ├── AGG (GROUP BY cp_catalog_page_id)
│   └── OUTPUT (catalog_page_id, sales, returns, profit)
├── [CTE] wsr  [~]  Cost: 25%  Rows: 21  — Modified to use pre-filtered web_sales subquery with dimension key lookups before left join to returns
│   ├── SCAN (web_sales)
│   ├── FILTER (ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN ...))
│   ├── FILTER (ws_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50))
│   ├── FILTER (ws_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N'))
│   ├── LEFT JOIN (web_returns ON ws_item_sk = wr_item_sk AND ws_order_number = wr_order_number)
│   ├── INNER JOIN (web_site ON ws_web_site_sk = web_site_sk)
│   ├── AGG (GROUP BY web_site_id)
│   └── OUTPUT (web_site_id, sales, returns, profit)
└── [MAIN] main_query  [=]  Cost: 25%  Rows: 100  — Unchanged union and rollup of the three channel CTEs
    ├── SCAN (ssr, csr, wsr)
    ├── AGG (GROUP BY ROLLUP(channel, id))
    ├── SORT (channel ASC, id ASC)
    └── OUTPUT (channel, id, sales, returns, profit)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_prefilter", "description": "Replaced comma joins with pre-filtered fact subqueries using IN subqueries for dimension keys", "applied_to": ["ssr", "csr", "wsr"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "ssr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT s_store_id AS store_id, SUM(ss_ext_sales_price) AS sales, SUM(COALESCE(sr_return_amt, 0)) AS \"returns\", SUM(ss_net_profit - COALESCE(sr_net_loss, 0)) AS profit FROM (SELECT ss_item_sk, ss_ticket_number, ss_store_sk, ss_ext_sales_price, ss_net_profit FROM store_sales WHERE ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)) AND ss_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50) AND ss_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N')) ss LEFT JOIN store_returns sr ON (ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number) INNER JOIN store ON ss.ss_store_sk = s_store_sk GROUP BY s_store_id",
        "interfaces": {"outputs": ["store_id", "sales", "returns", "profit"], "consumes": []}
      },
      "csr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cp_catalog_page_id AS catalog_page_id, SUM(cs_ext_sales_price) AS sales, SUM(COALESCE(cr_return_amount, 0)) AS \"returns\", SUM(cs_net_profit - COALESCE(cr_net_loss, 0)) AS profit FROM (SELECT cs_item_sk, cs_order_number, cs_catalog_page_sk, cs_ext_sales_price, cs_net_profit FROM catalog_sales WHERE cs_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)) AND cs_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50) AND cs_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N')) cs LEFT JOIN catalog_returns cr ON (cs.cs_item_sk = cr.cr_item_sk AND cs.cs_order_number = cr.cr_order_number) INNER JOIN catalog_page ON cs.cs_catalog_page_sk = cp_catalog_page_sk GROUP BY cp_catalog_page_id",
        "interfaces": {"outputs": ["catalog_page_id", "sales", "returns", "profit"], "consumes": []}
      },
      "wsr": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT web_site_id, SUM(ws_ext_sales_price) AS sales, SUM(COALESCE(wr_return_amt, 0)) AS \"returns\", SUM(ws_net_profit - COALESCE(wr_net_loss, 0)) AS profit FROM (SELECT ws_item_sk, ws_order_number, ws_web_site_sk, ws_ext_sales_price, ws_net_profit FROM web_sales WHERE ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-08-28' AS DATE) AND (CAST('1998-08-28' AS DATE) + INTERVAL 30 DAY)) AND ws_item_sk IN (SELECT i_item_sk FROM item WHERE i_current_price > 50) AND ws_promo_sk IN (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'N')) ws LEFT JOIN web_returns wr ON (ws.ws_item_sk = wr.wr_item_sk AND ws.ws_order_number = wr.wr_order_number) INNER JOIN web_site ON ws.ws_web_site_sk = web_site_sk GROUP BY web_site_id",
        "interfaces": {"outputs": ["web_site_id", "sales", "returns", "profit"], "consumes": []}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["ssr", "csr", "wsr"]}
      }
    },
    "reconstruction_order": ["ssr", "csr", "wsr", "main_query"],
    "assembly_template": "WITH ssr AS ({ssr}), csr AS ({csr}), wsr AS ({wsr}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Restructured each channel CTE to pre-filter the fact table using IN subqueries for dimension keys (date_dim, item, promotion) before performing the left join to returns and inner join to the channel-specific dimension (store, catalog_page, web_site). This isolates dimension filtering to early, selective subqueries while preserving the left join semantics.

**Expected speedup:** 1.8-2.2x due to reduced intermediate rows before the left join and better predicate pushdown into the fact table scan. Each dimension subquery creates a small list of surrogate keys that can be efficiently probed against the fact table's foreign key columns.