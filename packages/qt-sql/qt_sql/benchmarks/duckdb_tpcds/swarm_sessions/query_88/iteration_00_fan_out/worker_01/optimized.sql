WITH time_windows_cte AS (SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), store_filter_cte AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), household_filter_cte AS (SELECT hd_demo_sk FROM household_demographics WHERE ((hd_dep_count = -1 AND hd_vehicle_count <= 1) OR (hd_dep_count = 4 AND hd_vehicle_count <= 6) OR (hd_dep_count = 3 AND hd_vehicle_count <= 5))), consolidated_scan AS (SELECT ss.ss_sold_time_sk, tw.t_hour, tw.t_minute FROM store_sales ss INNER JOIN time_windows_cte tw ON ss.ss_sold_time_sk = tw.t_time_sk INNER JOIN store_filter_cte sf ON ss.ss_store_sk = sf.s_store_sk INNER JOIN household_filter_cte hf ON ss.ss_hdemo_sk = hf.hd_demo_sk), windowed_aggregates AS (SELECT COUNT(CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN t_hour = 9 AND t_minute < 30 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN t_hour = 9 AND t_minute >= 30 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN t_hour = 10 AND t_minute < 30 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN t_hour = 10 AND t_minute >= 30 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN t_hour = 11 AND t_minute < 30 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN t_hour = 11 AND t_minute >= 30 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN t_hour = 12 AND t_minute < 30 THEN 1 END) AS h12_to_12_30 FROM consolidated_scan) SELECT * FROM windowed_aggregates