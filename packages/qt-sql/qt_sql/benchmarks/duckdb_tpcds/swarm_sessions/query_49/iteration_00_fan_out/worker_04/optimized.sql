WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12), all_sales_returns AS (SELECT channel, item_sk, order_number, ticket_number, quantity, net_paid, return_quantity, return_amt FROM (SELECT 'web' AS channel, ws_item_sk AS item_sk, ws_order_number AS order_number, ws_quantity AS quantity, ws_net_paid AS net_paid, ws_sold_date_sk AS sold_date_sk, NULL AS ticket_number, wr_return_quantity AS return_quantity, wr_return_amt AS return_amt FROM web_sales LEFT JOIN web_returns ON ws_order_number = wr_order_number AND ws_item_sk = wr_item_sk WHERE (wr_return_amt > 10000 OR wr_return_amt IS NULL) AND ws_net_profit > 1 AND ws_net_paid > 0 AND ws_quantity > 0 UNION ALL SELECT 'catalog' AS channel, cs_item_sk AS item_sk, cs_order_number AS order_number, cs_quantity AS quantity, cs_net_paid AS net_paid, cs_sold_date_sk AS sold_date_sk, NULL AS ticket_number, cr_return_quantity AS return_quantity, cr_return_amount AS return_amt FROM catalog_sales LEFT JOIN catalog_returns ON cs_order_number = cr_order_number AND cs_item_sk = cr_item_sk WHERE (cr_return_amount > 10000 OR cr_return_amount IS NULL) AND cs_net_profit > 1 AND cs_net_paid > 0 AND cs_quantity > 0 UNION ALL SELECT 'store' AS channel, ss_item_sk AS item_sk, NULL AS order_number, ss_quantity AS quantity, ss_net_paid AS net_paid, ss_sold_date_sk AS sold_date_sk, ss_ticket_number AS ticket_number, sr_return_quantity AS return_quantity, sr_return_amt AS return_amt FROM store_sales LEFT JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk WHERE (sr_return_amt > 10000 OR sr_return_amt IS NULL) AND ss_net_profit > 1 AND ss_net_paid > 0 AND ss_quantity > 0) all_data INNER JOIN filtered_dates fd ON all_data.sold_date_sk = fd.d_date_sk), channel_aggregates AS (SELECT channel, item_sk, SUM(COALESCE(return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(quantity, 0)) AS sum_qty, SUM(COALESCE(return_amt, 0)) AS sum_return_amt, SUM(COALESCE(net_paid, 0)) AS sum_net_paid FROM all_sales_returns GROUP BY channel, item_sk), channel_ranks AS (SELECT channel, item_sk AS item, CAST(sum_return_qty AS DECIMAL(15,4)) / CAST(sum_qty AS DECIMAL(15,4)) AS return_ratio, RANK() OVER (PARTITION BY channel ORDER BY CAST(sum_return_qty AS DECIMAL(15,4)) / CAST(sum_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (PARTITION BY channel ORDER BY CAST(sum_return_amt AS DECIMAL(15,4)) / CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM channel_aggregates), filter_ranks AS (SELECT channel, item, return_ratio, return_rank, currency_rank FROM channel_ranks WHERE return_rank <= 10 OR currency_rank <= 10) SELECT channel, item, return_ratio, return_rank, currency_rank FROM filter_ranks ORDER BY 1, 4, 5, 2 LIMIT 100