## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — For each channel, left-join sales to returns, compute item-level quantity and value return ratios under profitability/volume constraints, rank items by both ratios, keep top-10 by either metric, and union channel outputs.
    ├── [+] filtered_dates CTE: date_dim filtered by d_year=1999, d_moy=12
    ├── [~] web_channel CTE: join web_sales to filtered_dates CTE, left join web_returns, with WHERE clause conditions
    ├── [~] web_ranked CTE: compute ratios and ranks from web_channel
    ├── [~] catalog_channel CTE: join catalog_sales to filtered_dates CTE, left join catalog_returns
    ├── [~] catalog_ranked CTE: compute ratios and ranks from catalog_channel
    ├── [~] store_channel CTE: join store_sales to filtered_dates CTE, left join store_returns
    ├── [~] store_ranked CTE: compute ratios and ranks from store_channel
    ├── [~] union_all CTE: combine web_ranked, catalog_ranked, store_ranked with channel labels
    ├── [~] filter_ranks CTE: filter WHERE return_rank <= 10 OR currency_rank <= 10
    ├── [=] SORT (1 ASC, 4 ASC, 5 ASC, 2 ASC)
    └── [=] OUTPUT (channel, item, return_ratio, return_rank, currency_rank)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Extract date_dim filter into reusable CTE to avoid repeated scans", "applied_to": ["filtered_dates", "web_channel", "catalog_channel", "store_channel"]},
    {"id": "R2", "type": "cte_reference", "description": "Replace direct date_dim joins with filtered_dates CTE references", "applied_to": ["web_channel", "catalog_channel", "store_channel"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "web_channel": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ws.ws_item_sk AS item, SUM(COALESCE(wr.wr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(ws.ws_quantity, 0)) AS sum_ws_qty, SUM(COALESCE(wr.wr_return_amt, 0)) AS sum_return_amt, SUM(COALESCE(ws.ws_net_paid, 0)) AS sum_net_paid FROM web_sales ws LEFT OUTER JOIN web_returns wr ON (ws.ws_order_number = wr.wr_order_number AND ws.ws_item_sk = wr.wr_item_sk), filtered_dates fd WHERE wr.wr_return_amt > 10000 AND ws.ws_net_profit > 1 AND ws.ws_net_paid > 0 AND ws.ws_quantity > 0 AND ws.ws_sold_date_sk = fd.d_date_sk GROUP BY ws.ws_item_sk",
        "interfaces": {"outputs": ["item", "sum_return_qty", "sum_ws_qty", "sum_return_amt", "sum_net_paid"], "consumes": ["filtered_dates"]}
      },
      "web_ranked": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ws_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ws_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM web_channel",
        "interfaces": {"outputs": ["item", "return_ratio", "currency_ratio", "return_rank", "currency_rank"], "consumes": ["web_channel"]}
      },
      "catalog_channel": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cs.cs_item_sk AS item, SUM(COALESCE(cr.cr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(cs.cs_quantity, 0)) AS sum_cs_qty, SUM(COALESCE(cr.cr_return_amount, 0)) AS sum_return_amt, SUM(COALESCE(cs.cs_net_paid, 0)) AS sum_net_paid FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON (cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk), filtered_dates fd WHERE cr.cr_return_amount > 10000 AND cs.cs_net_profit > 1 AND cs.cs_net_paid > 0 AND cs.cs_quantity > 0 AND cs.cs_sold_date_sk = fd.d_date_sk GROUP BY cs.cs_item_sk",
        "interfaces": {"outputs": ["item", "sum_return_qty", "sum_cs_qty", "sum_return_amt", "sum_net_paid"], "consumes": ["filtered_dates"]}
      },
      "catalog_ranked": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_cs_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_cs_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM catalog_channel",
        "interfaces": {"outputs": ["item", "return_ratio", "currency_ratio", "return_rank", "currency_rank"], "consumes": ["catalog_channel"]}
      },
      "store_channel": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT sts.ss_item_sk AS item, SUM(COALESCE(sr.sr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(sts.ss_quantity, 0)) AS sum_ss_qty, SUM(COALESCE(sr.sr_return_amt, 0)) AS sum_return_amt, SUM(COALESCE(sts.ss_net_paid, 0)) AS sum_net_paid FROM store_sales sts LEFT OUTER JOIN store_returns sr ON (sts.ss_ticket_number = sr.sr_ticket_number AND sts.ss_item_sk = sr.sr_item_sk), filtered_dates fd WHERE sr.sr_return_amt > 10000 AND sts.ss_net_profit > 1 AND sts.ss_net_paid > 0 AND sts.ss_quantity > 0 AND sts.ss_sold_date_sk = fd.d_date_sk GROUP BY sts.ss_item_sk",
        "interfaces": {"outputs": ["item", "sum_return_qty", "sum_ss_qty", "sum_return_amt", "sum_net_paid"], "consumes": ["filtered_dates"]}
      },
      "store_ranked": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ss_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ss_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM store_channel",
        "interfaces": {"outputs": ["item", "return_ratio", "currency_ratio", "return_rank", "currency_rank"], "consumes": ["store_channel"]}
      },
      "union_all": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT 'web' AS channel, item, return_ratio, return_rank, currency_rank FROM web_ranked UNION ALL SELECT 'catalog' AS channel, item, return_ratio, return_rank, currency_rank FROM catalog_ranked UNION ALL SELECT 'store' AS channel, item, return_ratio, return_rank, currency_rank FROM store_ranked",
        "interfaces": {"outputs": ["channel", "item", "return_ratio", "return_rank", "currency_rank"], "consumes": ["web_ranked", "catalog_ranked", "store_ranked"]}
      },
      "filter_ranks": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT channel, item, return_ratio, return_rank, currency_rank FROM union_all WHERE return_rank <= 10 OR currency_rank <= 10",
        "interfaces": {"outputs": ["channel", "item", "return_ratio", "return_rank", "currency_rank"], "consumes": ["union_all"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT channel, item, return_ratio, return_rank, currency_rank FROM filter_ranks ORDER BY channel ASC, return_rank ASC, currency_rank ASC, item ASC LIMIT 100",
        "interfaces": {"outputs": ["channel", "item", "return_ratio", "return_rank", "currency_rank"], "consumes": ["filter_ranks"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "web_channel", "web_ranked", "catalog_channel", "catalog_ranked", "store_channel", "store_ranked", "union_all", "filter_ranks", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), web_channel AS ({web_channel}), web_ranked AS ({web_ranked}), catalog_channel AS ({catalog_channel}), catalog_ranked AS ({catalog_ranked}), store_channel AS ({store_channel}), store_ranked AS ({store_ranked}), union_all AS ({union_all}), filter_ranks AS ({filter_ranks}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Isolated the date_dim filter into a reusable CTE that materializes once, reducing three full dimension table scans to one small hash table probe per channel branch. All semantics, guards, and output columns preserved exactly.

**Expected speedup:** ~1.8-2.0x (eliminates 2 redundant date_dim scans while adding minimal CTE overhead on a 2.7s baseline)