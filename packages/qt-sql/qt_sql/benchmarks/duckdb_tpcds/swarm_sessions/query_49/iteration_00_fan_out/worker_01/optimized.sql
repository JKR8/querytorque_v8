WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 12), web_channel AS (SELECT ws.ws_item_sk AS item, SUM(COALESCE(wr.wr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(ws.ws_quantity, 0)) AS sum_ws_qty, SUM(COALESCE(wr.wr_return_amt, 0)) AS sum_return_amt, SUM(COALESCE(ws.ws_net_paid, 0)) AS sum_net_paid FROM web_sales ws LEFT OUTER JOIN web_returns wr ON (ws.ws_order_number = wr.wr_order_number AND ws.ws_item_sk = wr.wr_item_sk), filtered_dates fd WHERE wr.wr_return_amt > 10000 AND ws.ws_net_profit > 1 AND ws.ws_net_paid > 0 AND ws.ws_quantity > 0 AND ws.ws_sold_date_sk = fd.d_date_sk GROUP BY ws.ws_item_sk), web_ranked AS (SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ws_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ws_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM web_channel), catalog_channel AS (SELECT cs.cs_item_sk AS item, SUM(COALESCE(cr.cr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(cs.cs_quantity, 0)) AS sum_cs_qty, SUM(COALESCE(cr.cr_return_amount, 0)) AS sum_return_amt, SUM(COALESCE(cs.cs_net_paid, 0)) AS sum_net_paid FROM catalog_sales cs LEFT OUTER JOIN catalog_returns cr ON (cs.cs_order_number = cr.cr_order_number AND cs.cs_item_sk = cr.cr_item_sk), filtered_dates fd WHERE cr.cr_return_amount > 10000 AND cs.cs_net_profit > 1 AND cs.cs_net_paid > 0 AND cs.cs_quantity > 0 AND cs.cs_sold_date_sk = fd.d_date_sk GROUP BY cs.cs_item_sk), catalog_ranked AS (SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_cs_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_cs_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM catalog_channel), store_channel AS (SELECT sts.ss_item_sk AS item, SUM(COALESCE(sr.sr_return_quantity, 0)) AS sum_return_qty, SUM(COALESCE(sts.ss_quantity, 0)) AS sum_ss_qty, SUM(COALESCE(sr.sr_return_amt, 0)) AS sum_return_amt, SUM(COALESCE(sts.ss_net_paid, 0)) AS sum_net_paid FROM store_sales sts LEFT OUTER JOIN store_returns sr ON (sts.ss_ticket_number = sr.sr_ticket_number AND sts.ss_item_sk = sr.sr_item_sk), filtered_dates fd WHERE sr.sr_return_amt > 10000 AND sts.ss_net_profit > 1 AND sts.ss_net_paid > 0 AND sts.ss_quantity > 0 AND sts.ss_sold_date_sk = fd.d_date_sk GROUP BY sts.ss_item_sk), store_ranked AS (SELECT item, CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ss_qty AS DECIMAL(15,4)) AS return_ratio, CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4)) AS currency_ratio, RANK() OVER (ORDER BY CAST(sum_return_qty AS DECIMAL(15,4))/CAST(sum_ss_qty AS DECIMAL(15,4))) AS return_rank, RANK() OVER (ORDER BY CAST(sum_return_amt AS DECIMAL(15,4))/CAST(sum_net_paid AS DECIMAL(15,4))) AS currency_rank FROM store_channel), union_all AS (SELECT 'web' AS channel, item, return_ratio, return_rank, currency_rank FROM web_ranked UNION ALL SELECT 'catalog' AS channel, item, return_ratio, return_rank, currency_rank FROM catalog_ranked UNION ALL SELECT 'store' AS channel, item, return_ratio, return_rank, currency_rank FROM store_ranked), filter_ranks AS (SELECT channel, item, return_ratio, return_rank, currency_rank FROM union_all WHERE return_rank <= 10 OR currency_rank <= 10) SELECT channel, item, return_ratio, return_rank, currency_rank FROM filter_ranks ORDER BY channel ASC, return_rank ASC, currency_rank ASC, item ASC LIMIT 100