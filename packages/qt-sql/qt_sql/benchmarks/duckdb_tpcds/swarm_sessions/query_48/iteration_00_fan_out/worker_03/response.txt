## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: 1
    ├── [CTE] date_cte  [+]  OUTPUT: d_date_sk
    ├── [CTE] store_cte  [+]  OUTPUT: s_store_sk
    ├── [CTE] demographics_cte  [+]  OUTPUT: cd_demo_sk, cd_marital_status, cd_education_status
    ├── [CTE] address_cte  [+]  OUTPUT: ca_address_sk, ca_state
    ├── [CTE] fact_join  [+]  OUTPUT: ss_quantity
    └── [AGG] aggregation  [+]  OUTPUT: total_quantity
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Pre-filter dimension tables into CTEs before joining to fact", "applied_to": ["date_cte", "store_cte", "demographics_cte", "address_cte"]},
    {"id": "R2", "type": "multi_dimension_prefetch", "description": "Filter all four dimensions into CTEs, then join to fact with complex WHERE preserved", "applied_to": ["fact_join"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1999",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "store_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT s_store_sk FROM store",
        "interfaces": {"outputs": ["s_store_sk"], "consumes": []}
      },
      "demographics_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cd_demo_sk, cd_marital_status, cd_education_status FROM customer_demographics WHERE (cd_marital_status = 'U' AND cd_education_status = 'Primary') OR (cd_marital_status = 'W' AND cd_education_status = 'College') OR (cd_marital_status = 'D' AND cd_education_status = '2 yr Degree')",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_marital_status", "cd_education_status"], "consumes": []}
      },
      "address_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ca_address_sk, ca_state FROM customer_address WHERE ca_country = 'United States' AND ca_state IN ('MD','MN','IA','VA','IL','TX','MI','WI','IN')",
        "interfaces": {"outputs": ["ca_address_sk", "ca_state"], "consumes": []}
      },
      "fact_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_quantity FROM store_sales JOIN date_cte ON ss_sold_date_sk = date_cte.d_date_sk JOIN store_cte ON ss_store_sk = store_cte.s_store_sk JOIN demographics_cte ON ss_cdemo_sk = demographics_cte.cd_demo_sk JOIN address_cte ON ss_addr_sk = address_cte.ca_address_sk WHERE ((demographics_cte.cd_marital_status = 'U' AND demographics_cte.cd_education_status = 'Primary' AND ss_sales_price BETWEEN 100.00 AND 150.00) OR (demographics_cte.cd_marital_status = 'W' AND demographics_cte.cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00) OR (demographics_cte.cd_marital_status = 'D' AND demographics_cte.cd_education_status = '2 yr Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00)) AND ((address_cte.ca_state IN ('MD','MN','IA') AND ss_net_profit BETWEEN 0 AND 2000) OR (address_cte.ca_state IN ('VA','IL','TX') AND ss_net_profit BETWEEN 150 AND 3000) OR (address_cte.ca_state IN ('MI','WI','IN') AND ss_net_profit BETWEEN 50 AND 25000))",
        "interfaces": {"outputs": ["ss_quantity"], "consumes": ["date_cte", "store_cte", "demographics_cte", "address_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "added",
        "sql": "SELECT SUM(ss_quantity) AS total_quantity FROM fact_join",
        "interfaces": {"outputs": ["total_quantity"], "consumes": ["fact_join"]}
      }
    },
    "reconstruction_order": ["date_cte", "store_cte", "demographics_cte", "address_cte", "fact_join", "main_query"],
    "assembly_template": "WITH date_cte AS ({date_cte}), store_cte AS ({store_cte}), demographics_cte AS ({demographics_cte}), address_cte AS ({address_cte}), fact_join AS ({fact_join}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Restructured to pre-filter all four dimension tables into CTEs, then join them to the fact table with the exact same OR logic preserved. The complex WHERE conditions remain at the fact-join level to maintain semantic equivalence.

Expected speedup: ~2-4x via reduced dimension table I/O and smaller hash tables for joins, while avoiding cross-joining dimensions.