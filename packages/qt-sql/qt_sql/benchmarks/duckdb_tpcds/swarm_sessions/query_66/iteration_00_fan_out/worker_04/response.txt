## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_agg  [~]  Cost: 100%  Rows: ~1K  — Aggregate monthly channel metrics from web_final and catalog_final union, then roll up to warehouse/year/carrier totals including per-sq-ft calculations.
    ├── [CTE] filtered_dims  [+]  Cost: 0.5%  Rows: ~21M  — Shared dimension filters for date_dim, time_dim, ship_mode
    ├── [CTE] web_fact_agg  [+]  Cost: 30%  Rows: ~10  — Aggregated web sales by warehouse/year
    ├── [CTE] catalog_fact_agg  [+]  Cost: 30%  Rows: ~10  — Aggregated catalog sales by warehouse/year
    ├── [CTE] web_final  [+]  Cost: 0.1%  Rows: ~10  — Web aggregates joined with warehouse attributes
    ├── [CTE] catalog_final  [+]  Cost: 0.1%  Rows: ~10  — Catalog aggregates joined with warehouse attributes
    ├── [CTE] union_all  [+]  Cost: 0.1%  Rows: ~20  — UNION ALL of web_final and catalog_final
    ├── AGG (GROUP BY warehouse/year/carrier)
    ├── SORT (w_warehouse_name ASC)
    └── OUTPUT (w_warehouse_name, w_warehouse_sq_ft, ..., dec_net)
        ├── [=] SCAN (warehouse)
        ├── [-] SCAN (date_dim, time_dim, ship_mode) — Moved to filtered_dims CTE
        ├── [-] SCAN (web_sales, catalog_sales) — Moved to fact_agg CTEs
        └── [-] FILTER (d_year, t_time, sm_carrier) — Moved to filtered_dims CTE
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "shared_dimension_multi_channel",
      "description": "Extract shared dimension filters (date_dim, time_dim, ship_mode) into single CTE referenced by both channel branches",
      "applied_to": ["filtered_dims"]
    },
    {
      "id": "R2",
      "type": "prefetch_fact_join",
      "description": "Pre-join fact tables with filtered dimensions before aggregation, reducing intermediate data",
      "applied_to": ["web_fact_agg", "catalog_fact_agg"]
    },
    {
      "id": "R3",
      "type": "single_pass_aggregation",
      "description": "Consolidate 24 monthly aggregates into single SUM(CASE...) pass per fact table",
      "applied_to": ["web_fact_agg", "catalog_fact_agg"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dims": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_year, d_moy, t_time_sk, sm_ship_mode_sk FROM date_dim, time_dim, ship_mode WHERE d_year = 1998 AND t_time BETWEEN 48821 AND 48821+28800 AND sm_carrier IN ('GREAT EASTERN', 'LATVIAN')",
        "interfaces": {
          "outputs": ["d_date_sk", "d_year", "d_moy", "t_time_sk", "sm_ship_mode_sk"],
          "consumes": []
        }
      },
      "web_fact_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws_warehouse_sk, d_year, SUM(CASE WHEN d_moy = 1 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS dec_net FROM web_sales JOIN filtered_dims ON ws_sold_date_sk = d_date_sk AND ws_sold_time_sk = t_time_sk AND ws_ship_mode_sk = sm_ship_mode_sk GROUP BY ws_warehouse_sk, d_year",
        "interfaces": {
          "outputs": ["ws_warehouse_sk", "d_year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["filtered_dims"]
        }
      },
      "catalog_fact_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cs_warehouse_sk, d_year, SUM(CASE WHEN d_moy = 1 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS dec_net FROM catalog_sales JOIN filtered_dims ON cs_sold_date_sk = d_date_sk AND cs_sold_time_sk = t_time_sk AND cs_ship_mode_sk = sm_ship_mode_sk GROUP BY cs_warehouse_sk, d_year",
        "interfaces": {
          "outputs": ["cs_warehouse_sk", "d_year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["filtered_dims"]
        }
      },
      "web_final": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, 'GREAT EASTERN' || ',' || 'LATVIAN' AS ship_carriers, d_year AS year, jan_sales, feb_sales, mar_sales, apr_sales, may_sales, jun_sales, jul_sales, aug_sales, sep_sales, oct_sales, nov_sales, dec_sales, jan_net, feb_net, mar_net, apr_net, may_net, jun_net, jul_net, aug_net, sep_net, oct_net, nov_net, dec_net FROM web_fact_agg JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["web_fact_agg"]
        }
      },
      "catalog_final": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, 'GREAT EASTERN' || ',' || 'LATVIAN' AS ship_carriers, d_year AS year, jan_sales, feb_sales, mar_sales, apr_sales, may_sales, jun_sales, jul_sales, aug_sales, sep_sales, oct_sales, nov_sales, dec_sales, jan_net, feb_net, mar_net, apr_net, may_net, jun_net, jul_net, aug_net, sep_net, oct_net, nov_net, dec_net FROM catalog_fact_agg JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["catalog_fact_agg"]
        }
      },
      "union_all": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT * FROM web_final UNION ALL SELECT * FROM catalog_final",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["web_final", "catalog_final"]
        }
      },
      "main_agg": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year, SUM(jan_sales) AS jan_sales, SUM(feb_sales) AS feb_sales, SUM(mar_sales) AS mar_sales, SUM(apr_sales) AS apr_sales, SUM(may_sales) AS may_sales, SUM(jun_sales) AS jun_sales, SUM(jul_sales) AS jul_sales, SUM(aug_sales) AS aug_sales, SUM(sep_sales) AS sep_sales, SUM(oct_sales) AS oct_sales, SUM(nov_sales) AS nov_sales, SUM(dec_sales) AS dec_sales, SUM(jan_sales / w_warehouse_sq_ft) AS jan_sales_per_sq_foot, SUM(feb_sales / w_warehouse_sq_ft) AS feb_sales_per_sq_foot, SUM(mar_sales / w_warehouse_sq_ft) AS mar_sales_per_sq_foot, SUM(apr_sales / w_warehouse_sq_ft) AS apr_sales_per_sq_foot, SUM(may_sales / w_warehouse_sq_ft) AS may_sales_per_sq_foot, SUM(jun_sales / w_warehouse_sq_ft) AS jun_sales_per_sq_foot, SUM(jul_sales / w_warehouse_sq_ft) AS jul_sales_per_sq_foot, SUM(aug_sales / w_warehouse_sq_ft) AS aug_sales_per_sq_foot, SUM(sep_sales / w_warehouse_sq_ft) AS sep_sales_per_sq_foot, SUM(oct_sales / w_warehouse_sq_ft) AS oct_sales_per_sq_foot, SUM(nov_sales / w_warehouse_sq_ft) AS nov_sales_per_sq_foot, SUM(dec_sales / w_warehouse_sq_ft) AS dec_sales_per_sq_foot, SUM(jan_net) AS jan_net, SUM(feb_net) AS feb_net, SUM(mar_net) AS mar_net, SUM(apr_net) AS apr_net, SUM(may_net) AS may_net, SUM(jun_net) AS jun_net, SUM(jul_net) AS jul_net, SUM(aug_net) AS aug_net, SUM(sep_net) AS sep_net, SUM(oct_net) AS oct_net, SUM(nov_net) AS nov_net, SUM(dec_net) AS dec_net FROM union_all GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year ORDER BY w_warehouse_name LIMIT 100",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_sales_per_sq_foot", "feb_sales_per_sq_foot", "mar_sales_per_sq_foot", "apr_sales_per_sq_foot", "may_sales_per_sq_foot", "jun_sales_per_sq_foot", "jul_sales_per_sq_foot", "aug_sales_per_sq_foot", "sep_sales_per_sq_foot", "oct_sales_per_sq_foot", "nov_sales_per_sq_foot", "dec_sales_per_sq_foot", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["union_all"]
        }
      }
    },
    "reconstruction_order": ["filtered_dims", "web_fact_agg", "catalog_fact_agg", "web_final", "catalog_final", "union_all", "main_agg"],
    "assembly_template": "WITH filtered_dims AS ({filtered_dims}), web_fact_agg AS ({web_fact_agg}), catalog_fact_agg AS ({catalog_fact_agg}), web_final AS ({web_final}), catalog_final AS ({catalog_final}), union_all AS ({union_all}) {main_agg}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Extracted shared dimension filters into a single CTE (filtered_dims) referenced by both web and catalog branches, pre-joined fact tables with filtered dimensions before aggregation, and maintained single-pass aggregation for each channel.

**Expected speedup**: ~1.3x from eliminating redundant dimension scans (shared_dimension_multi_channel pattern), plus additional gains from staged join pipeline and single-pass aggregation.