## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K — Aggregate monthly channel metrics from web_sales and catalog_sales under shared warehouse/time/ship-mode filters, union channels, then roll up to warehouse/year/carrier totals including per-sq-ft calculations.
    ├── [CTE] filtered_dims  [+] — Pre-filter date_dim, time_dim, ship_mode into single CTE with surrogate keys
    │   ├── [CROSS JOIN] date_dim × time_dim × ship_mode
    │   ├── FILTER (d_year = 1998)
    │   ├── FILTER (t_time BETWEEN 48821 AND 48821+28800)
    │   ├── FILTER (sm_carrier IN ('GREAT EASTERN','LATVIAN'))
    │   └── OUTPUT (d_date_sk, d_year, d_moy, t_time_sk, sm_ship_mode_sk)
    ├── [CTE] web_branch  [~] — Join web_sales with filtered_dims and warehouse, aggregate monthly metrics
    │   ├── JOIN web_sales ⇔ filtered_dims (ws_sold_date_sk = d_date_sk, ws_sold_time_sk = t_time_sk, ws_ship_mode_sk = sm_ship_mode_sk)
    │   ├── JOIN web_sales ⇔ warehouse (ws_warehouse_sk = w_warehouse_sk)
    │   ├── GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_year
    │   └── OUTPUT (warehouse attributes, d_year, jan_sales…dec_net, plus constant ship_carriers)
    ├── [CTE] catalog_branch  [~] — Join catalog_sales with filtered_dims and warehouse, aggregate monthly metrics
    │   ├── JOIN catalog_sales ⇔ filtered_dims (cs_sold_date_sk = d_date_sk, cs_sold_time_sk = t_time_sk, cs_ship_mode_sk = sm_ship_mode_sk)
    │   ├── JOIN catalog_sales ⇔ warehouse (cs_warehouse_sk = w_warehouse_sk)
    │   ├── GROUP BY (same as web_branch)
    │   └── OUTPUT (same as web_branch)
    ├── [CTE] union_all  [+] — Combine web_branch and catalog_branch
    │   └── OUTPUT (all columns from branch CTEs)
    └── [AGGREGATE] main_agg  [~] — Roll up union results, compute per‑sq‑ft metrics
        ├── GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year
        ├── AGGREGATE SUM(jan_sales)…SUM(dec_net)
        ├── AGGREGATE SUM(jan_sales/w_warehouse_sq_ft)…SUM(dec_sales/w_warehouse_sq_ft)
        ├── SORT w_warehouse_name ASC
        └── OUTPUT (33 columns in original order)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "shared_dimension_multi_channel", "description": "Extract date/time/ship_mode filters into single CTE reused by both web and catalog branches", "applied_to": ["filtered_dims", "web_branch", "catalog_branch"]},
    {"id": "R2", "type": "cte_materialization", "description": "Use CTE for filtered_dims to avoid redundant dimension scans", "applied_to": ["filtered_dims"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dims": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_year, d_moy, t_time_sk, sm_ship_mode_sk FROM date_dim, time_dim, ship_mode WHERE d_year = 1998 AND t_time BETWEEN 48821 AND 48821+28800 AND sm_carrier IN ('GREAT EASTERN', 'LATVIAN')",
        "interfaces": {"outputs": ["d_date_sk", "d_year", "d_moy", "t_time_sk", "sm_ship_mode_sk"], "consumes": []}
      },
      "web_branch": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_year AS year, 'GREAT EASTERN,LATVIAN' AS ship_carriers, SUM(CASE WHEN d_moy = 1 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS dec_net FROM web_sales, filtered_dims, warehouse WHERE ws_sold_date_sk = d_date_sk AND ws_sold_time_sk = t_time_sk AND ws_ship_mode_sk = sm_ship_mode_sk AND ws_warehouse_sk = w_warehouse_sk GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_year",
        "interfaces": {"outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "year", "ship_carriers", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"], "consumes": ["filtered_dims"]}
      },
      "catalog_branch": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_year AS year, 'GREAT EASTERN,LATVIAN' AS ship_carriers, SUM(CASE WHEN d_moy = 1 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS dec_net FROM catalog_sales, filtered_dims, warehouse WHERE cs_sold_date_sk = d_date_sk AND cs_sold_time_sk = t_time_sk AND cs_ship_mode_sk = sm_ship_mode_sk AND cs_warehouse_sk = w_warehouse_sk GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_year",
        "interfaces": {"outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "year", "ship_carriers", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"], "consumes": ["filtered_dims"]}
      },
      "union_all": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT * FROM web_branch UNION ALL SELECT * FROM catalog_branch",
        "interfaces": {"outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "year", "ship_carriers", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"], "consumes": ["web_branch", "catalog_branch"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year, SUM(jan_sales) AS jan_sales, SUM(feb_sales) AS feb_sales, SUM(mar_sales) AS mar_sales, SUM(apr_sales) AS apr_sales, SUM(may_sales) AS may_sales, SUM(jun_sales) AS jun_sales, SUM(jul_sales) AS jul_sales, SUM(aug_sales) AS aug_sales, SUM(sep_sales) AS sep_sales, SUM(oct_sales) AS oct_sales, SUM(nov_sales) AS nov_sales, SUM(dec_sales) AS dec_sales, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(jan_sales) / w_warehouse_sq_ft END AS jan_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(feb_sales) / w_warehouse_sq_ft END AS feb_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(mar_sales) / w_warehouse_sq_ft END AS mar_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(apr_sales) / w_warehouse_sq_ft END AS apr_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(may_sales) / w_warehouse_sq_ft END AS may_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(jun_sales) / w_warehouse_sq_ft END AS jun_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(jul_sales) / w_warehouse_sq_ft END AS jul_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(aug_sales) / w_warehouse_sq_ft END AS aug_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(sep_sales) / w_warehouse_sq_ft END AS sep_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(oct_sales) / w_warehouse_sq_ft END AS oct_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(nov_sales) / w_warehouse_sq_ft END AS nov_sales_per_sq_foot, CASE WHEN w_warehouse_sq_ft > 0 THEN SUM(dec_sales) / w_warehouse_sq_ft END AS dec_sales_per_sq_foot, SUM(jan_net) AS jan_net, SUM(feb_net) AS feb_net, SUM(mar_net) AS mar_net, SUM(apr_net) AS apr_net, SUM(may_net) AS may_net, SUM(jun_net) AS jun_net, SUM(jul_net) AS jul_net, SUM(aug_net) AS aug_net, SUM(sep_net) AS sep_net, SUM(oct_net) AS oct_net, SUM(nov_net) AS nov_net, SUM(dec_net) AS dec_net FROM union_all GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year ORDER BY w_warehouse_name LIMIT 100",
        "interfaces": {"outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_sales_per_sq_foot", "feb_sales_per_sq_foot", "mar_sales_per_sq_foot", "apr_sales_per_sq_foot", "may_sales_per_sq_foot", "jun_sales_per_sq_foot", "jul_sales_per_sq_foot", "aug_sales_per_sq_foot", "sep_sales_per_sq_foot", "oct_sales_per_sq_foot", "nov_sales_per_sq_foot", "dec_sales_per_sq_foot", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"], "consumes": ["union_all"]}
      }
    },
    "reconstruction_order": ["filtered_dims", "web_branch", "catalog_branch", "union_all", "main_query"],
    "assembly_template": "WITH filtered_dims AS ({filtered_dims}), web_branch AS ({web_branch}), catalog_branch AS ({catalog_branch}), union_all AS ({union_all}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Extracted shared dimension filters (date_dim, time_dim, ship_mode) into a single CTE (`filtered_dims`) that is reused by both web and catalog branches, eliminating redundant dimension table scans while preserving original join semantics.

**Expected speedup:** ~1.3–1.5× due to eliminating duplicate dimension scans while maintaining same result rows and grouping structure.