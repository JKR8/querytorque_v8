## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — Aggregate monthly channel metrics from web_sales and catalog_sales under shared warehouse/time/ship-mode filters, union channels, then roll up to warehouse/year/carrier totals including per-sq-ft calculations.
    ├── [CTE] filtered_dims  [+]  Cost: ~21M rows — Pre-filtered dimension keys from date_dim, time_dim, ship_mode
    ├── [CTE] web_fact       [+]  Cost: ~64K rows — Web sales joined with filtered dimensions
    ├── [CTE] catalog_fact   [+]  Cost: ~128K rows — Catalog sales joined with filtered dimensions  
    ├── [CTE] web_agg        [+]  Cost: ~10 rows — Aggregated web sales with warehouse attributes
    ├── [CTE] catalog_agg    [+]  Cost: ~10 rows — Aggregated catalog sales with warehouse attributes
    ├── [CTE] union_cte      [+]  Cost: ~20 rows — UNION ALL of both channel aggregations
    └── [~] SORT (w_warehouse_name ASC)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "multi_dimension_prefetch",
      "description": "Pre-filter all three dimension tables (date_dim, time_dim, ship_mode) into single CTE before fact table joins",
      "applied_to": ["filtered_dims", "web_fact", "catalog_fact"]
    },
    {
      "id": "R2", 
      "type": "prefetch_fact_join",
      "description": "Stage dimension key filtering first, then join to fact tables, then warehouse",
      "applied_to": ["web_agg", "catalog_agg"]
    },
    {
      "id": "R3",
      "type": "early_filter",
      "description": "Apply selective filters to small dimension tables first, reducing fact table scan cardinality",
      "applied_to": ["filtered_dims"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dims": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, t_time_sk, sm_ship_mode_sk, d_moy FROM date_dim CROSS JOIN time_dim CROSS JOIN ship_mode WHERE d_year = 1998 AND t_time BETWEEN 48821 AND 48821+28800 AND sm_carrier IN ('GREAT EASTERN', 'LATVIAN')",
        "interfaces": {
          "outputs": ["d_date_sk", "t_time_sk", "sm_ship_mode_sk", "d_moy"],
          "consumes": []
        }
      },
      "web_fact": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ws_warehouse_sk, ws_ext_sales_price, ws_quantity, ws_net_paid_inc_ship_tax, d_moy FROM web_sales INNER JOIN filtered_dims ON ws_sold_date_sk = d_date_sk AND ws_sold_time_sk = t_time_sk AND ws_ship_mode_sk = sm_ship_mode_sk",
        "interfaces": {
          "outputs": ["ws_warehouse_sk", "ws_ext_sales_price", "ws_quantity", "ws_net_paid_inc_ship_tax", "d_moy"],
          "consumes": ["filtered_dims"]
        }
      },
      "catalog_fact": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs_warehouse_sk, cs_ext_list_price, cs_quantity, cs_net_paid_inc_ship_tax, d_moy FROM catalog_sales INNER JOIN filtered_dims ON cs_sold_date_sk = d_date_sk AND cs_sold_time_sk = t_time_sk AND cs_ship_mode_sk = sm_ship_mode_sk",
        "interfaces": {
          "outputs": ["cs_warehouse_sk", "cs_ext_list_price", "cs_quantity", "cs_net_paid_inc_ship_tax", "d_moy"],
          "consumes": ["filtered_dims"]
        }
      },
      "web_agg": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, 'GREAT EASTERN' || ',' || 'LATVIAN' AS ship_carriers, 1998 AS year, SUM(CASE WHEN d_moy = 1 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN ws_ext_sales_price * ws_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN ws_net_paid_inc_ship_tax * ws_quantity ELSE 0 END) AS dec_net FROM web_fact INNER JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["web_fact"]
        }
      },
      "catalog_agg": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, 'GREAT EASTERN' || ',' || 'LATVIAN' AS ship_carriers, 1998 AS year, SUM(CASE WHEN d_moy = 1 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN cs_ext_list_price * cs_quantity ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN cs_net_paid_inc_ship_tax * cs_quantity ELSE 0 END) AS dec_net FROM catalog_fact INNER JOIN warehouse ON cs_warehouse_sk = w_warehouse_sk GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["catalog_fact"]
        }
      },
      "union_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT * FROM web_agg UNION ALL SELECT * FROM catalog_agg",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["web_agg", "catalog_agg"]
        }
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year, SUM(jan_sales) AS jan_sales, SUM(feb_sales) AS feb_sales, SUM(mar_sales) AS mar_sales, SUM(apr_sales) AS apr_sales, SUM(may_sales) AS may_sales, SUM(jun_sales) AS jun_sales, SUM(jul_sales) AS jul_sales, SUM(aug_sales) AS aug_sales, SUM(sep_sales) AS sep_sales, SUM(oct_sales) AS oct_sales, SUM(nov_sales) AS nov_sales, SUM(dec_sales) AS dec_sales, SUM(jan_sales/w_warehouse_sq_ft) AS jan_sales_per_sq_foot, SUM(feb_sales/w_warehouse_sq_ft) AS feb_sales_per_sq_foot, SUM(mar_sales/w_warehouse_sq_ft) AS mar_sales_per_sq_foot, SUM(apr_sales/w_warehouse_sq_ft) AS apr_sales_per_sq_foot, SUM(may_sales/w_warehouse_sq_ft) AS may_sales_per_sq_foot, SUM(jun_sales/w_warehouse_sq_ft) AS jun_sales_per_sq_foot, SUM(jul_sales/w_warehouse_sq_ft) AS jul_sales_per_sq_foot, SUM(aug_sales/w_warehouse_sq_ft) AS aug_sales_per_sq_foot, SUM(sep_sales/w_warehouse_sq_ft) AS sep_sales_per_sq_foot, SUM(oct_sales/w_warehouse_sq_ft) AS oct_sales_per_sq_foot, SUM(nov_sales/w_warehouse_sq_ft) AS nov_sales_per_sq_foot, SUM(dec_sales/w_warehouse_sq_ft) AS dec_sales_per_sq_foot, SUM(jan_net) AS jan_net, SUM(feb_net) AS feb_net, SUM(mar_net) AS mar_net, SUM(apr_net) AS apr_net, SUM(may_net) AS may_net, SUM(jun_net) AS jun_net, SUM(jul_net) AS jul_net, SUM(aug_net) AS aug_net, SUM(sep_net) AS sep_net, SUM(oct_net) AS oct_net, SUM(nov_net) AS nov_net, SUM(dec_net) AS dec_net FROM union_cte GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, ship_carriers, year ORDER BY w_warehouse_name LIMIT 100",
        "interfaces": {
          "outputs": ["w_warehouse_name", "w_warehouse_sq_ft", "w_city", "w_county", "w_state", "w_country", "ship_carriers", "year", "jan_sales", "feb_sales", "mar_sales", "apr_sales", "may_sales", "jun_sales", "jul_sales", "aug_sales", "sep_sales", "oct_sales", "nov_sales", "dec_sales", "jan_sales_per_sq_foot", "feb_sales_per_sq_foot", "mar_sales_per_sq_foot", "apr_sales_per_sq_foot", "may_sales_per_sq_foot", "jun_sales_per_sq_foot", "jul_sales_per_sq_foot", "aug_sales_per_sq_foot", "sep_sales_per_sq_foot", "oct_sales_per_sq_foot", "nov_sales_per_sq_foot", "dec_sales_per_sq_foot", "jan_net", "feb_net", "mar_net", "apr_net", "may_net", "jun_net", "jul_net", "aug_net", "sep_net", "oct_net", "nov_net", "dec_net"],
          "consumes": ["union_cte"]
        }
      }
    },
    "reconstruction_order": ["filtered_dims", "web_fact", "catalog_fact", "web_agg", "catalog_agg", "union_cte", "main_query"],
    "assembly_template": "WITH filtered_dims AS ({filtered_dims}), web_fact AS ({web_fact}), catalog_fact AS ({catalog_fact}), web_agg AS ({web_agg}), catalog_agg AS ({catalog_agg}), union_cte AS ({union_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Restructured into a staged CTE pipeline that first pre-filters all three dimension tables into a single CTE, then joins each fact table separately with these filtered keys, aggregates each channel, unions them, and finally computes the per-square-foot metrics. This reduces duplicate dimension scans and pushes filters earlier.

Expected speedup: 2-3x from eliminating duplicate dimension table scans and enabling predicate pushdown into each channel branch.