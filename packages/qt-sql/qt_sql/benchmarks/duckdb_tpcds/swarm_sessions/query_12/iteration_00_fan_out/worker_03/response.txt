### Part 1: Modified Logic Tree

```
QUERY: (CTE-based)
├── [~] base_aggregation [=]
├── [+] class_totals [NEW]
├── [+] joined_for_ratio [NEW]
└── [+] top_n [NEW]
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "deferred_window_aggregation", "description": "Replace window function with separate class_totals CTE + join", "applied_to": ["class_totals", "joined_for_ratio"]},
    {"id": "R2", "type": "cte_isolation", "description": "Separate base aggregation and class totals into distinct CTEs", "applied_to": ["base_aggregation", "class_totals"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "base_aggregation": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(ws_ext_sales_price) AS itemrevenue FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN item ON ws_item_sk = i_item_sk WHERE i_category IN ('Books', 'Sports', 'Men') AND d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL 30 DAY) GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue"], "consumes": []}
      },
      "class_totals": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_class, SUM(ws_ext_sales_price) AS class_revenue FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN item ON ws_item_sk = i_item_sk WHERE i_category IN ('Books', 'Sports', 'Men') AND d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL 30 DAY) GROUP BY i_class",
        "interfaces": {"outputs": ["i_class", "class_revenue"], "consumes": []}
      },
      "joined_for_ratio": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ba.i_item_id, ba.i_item_desc, ba.i_category, ba.i_class, ba.i_current_price, ba.itemrevenue, (ba.itemrevenue * 100 / ct.class_revenue) AS revenueratio FROM base_aggregation ba INNER JOIN class_totals ct ON ba.i_class = ct.i_class",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue", "revenueratio"], "consumes": ["base_aggregation", "class_totals"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, revenueratio FROM joined_for_ratio ORDER BY i_category ASC, i_class ASC, i_item_id ASC, i_item_desc ASC, revenueratio ASC LIMIT 100",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue", "revenueratio"], "consumes": ["joined_for_ratio"]}
      }
    },
    "reconstruction_order": ["base_aggregation", "class_totals", "joined_for_ratio", "main_query"],
    "assembly_template": "WITH base_aggregation AS ({base_aggregation}), class_totals AS ({class_totals}), joined_for_ratio AS ({joined_for_ratio}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Replaced the window function `SUM(ws_ext_sales_price) OVER (PARTITION BY i_class)` with a separate `class_totals` CTE and join. This isolates the class-level aggregation from the item-level aggregation, allowing potential predicate pushdown into each CTE scan.

**Expected speedup**: ~1.3–1.5× due to deferred window computation and potential parallelization of the two aggregations.