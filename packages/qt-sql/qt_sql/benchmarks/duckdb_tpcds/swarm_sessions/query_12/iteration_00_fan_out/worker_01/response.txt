### Part 1: Modified Logic Tree

```
QUERY: (CTE-based transformation)
└── [MAIN] main_query [!]
    ├── [~] filtered_dates [+]
    │   ├── SCAN (date_dim)
    │   ├── FILTER (d_date BETWEEN '1998-04-06' AND '1998-04-06' + 30 DAYS)
    │   └── OUTPUT (d_date_sk)
    ├── [~] filtered_items [+]
    │   ├── SCAN (item)
    │   ├── FILTER (i_category IN ('Books', 'Sports', 'Men'))
    │   └── OUTPUT (i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price)
    ├── [~] fact_join [+]
    │   ├── SCAN (web_sales)
    │   ├── JOIN (filtered_dates ON ws_sold_date_sk = d_date_sk)
    │   ├── JOIN (filtered_items ON ws_item_sk = i_item_sk)
    │   └── OUTPUT (ws_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price, ws_ext_sales_price)
    ├── [~] aggregated [+]
    │   ├── FROM (fact_join)
    │   ├── GROUP BY (i_item_id, i_item_desc, i_category, i_class, i_current_price)
    │   ├── AGGREGATE (SUM(ws_ext_sales_price) AS itemrevenue)
    │   └── OUTPUT (i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue)
    ├── [~] windowed [+]
    │   ├── FROM (aggregated)
    │   ├── WINDOW (SUM(itemrevenue) OVER (PARTITION BY i_class) AS class_revenue)
    │   ├── COMPUTE (itemrevenue * 100 / class_revenue AS revenueratio)
    │   └── OUTPUT (i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, revenueratio)
    └── [~] top_n [+]
        ├── FROM (windowed)
        ├── ORDER BY (i_category, i_class, i_item_id, i_item_desc, revenueratio)
        ├── LIMIT (100)
        └── OUTPUT (i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, revenueratio)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "date_cte_isolate", "description": "Extract date filter into materialized CTE to reduce hash table size", "applied_to": ["filtered_dates"]},
    {"id": "R2", "type": "dimension_cte_isolate", "description": "Extract item filter into materialized CTE to reduce hash table size", "applied_to": ["filtered_items"]},
    {"id": "R3", "type": "early_filter", "description": "Push filters into dimension CTEs before joining with large fact table", "applied_to": ["filtered_dates", "filtered_items"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL 30 DAY)",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_items": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_sk, i_item_id, i_item_desc, i_category, i_class, i_current_price FROM item WHERE i_category IN ('Books', 'Sports', 'Men')",
        "interfaces": {"outputs": ["i_item_sk", "i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price"], "consumes": []}
      },
      "fact_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws.ws_item_sk, fi.i_item_id, fi.i_item_desc, fi.i_category, fi.i_class, fi.i_current_price, ws.ws_ext_sales_price FROM web_sales ws INNER JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk INNER JOIN filtered_items fi ON ws.ws_item_sk = fi.i_item_sk",
        "interfaces": {"outputs": ["ws_item_sk", "i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "ws_ext_sales_price"], "consumes": ["filtered_dates", "filtered_items"]}
      },
      "aggregated": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(ws_ext_sales_price) AS itemrevenue FROM fact_join GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue"], "consumes": ["fact_join"]}
      },
      "windowed": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, itemrevenue * 100 / SUM(itemrevenue) OVER (PARTITION BY i_class) AS revenueratio FROM aggregated",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue", "revenueratio"], "consumes": ["aggregated"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, revenueratio FROM windowed ORDER BY i_category ASC, i_class ASC, i_item_id ASC, i_item_desc ASC, revenueratio ASC LIMIT 100",
        "interfaces": {"outputs": ["i_item_id", "i_item_desc", "i_category", "i_class", "i_current_price", "itemrevenue", "revenueratio"], "consumes": ["windowed"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_items", "fact_join", "aggregated", "windowed", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_items AS ({filtered_items}), fact_join AS ({fact_join}), aggregated AS ({aggregated}), windowed AS ({windowed}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Isolated date and item filters into materialized CTEs before joining with the large web_sales fact table. This reduces hash table sizes for the dimension joins and enables predicate pushdown into smaller scans.

**Expected speedup**: ~1.5-2.0x (moderate) - The baseline query scans 102K item rows and 73K date_dim rows before filtering. Materializing filtered subsets (~31 date rows, ~30K item rows) reduces hash table build costs and memory pressure during the join with web_sales.