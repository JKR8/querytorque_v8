WITH base_aggregation AS (SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, SUM(ws_ext_sales_price) AS itemrevenue FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN item ON ws_item_sk = i_item_sk WHERE i_category IN ('Books', 'Sports', 'Men') AND d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL 30 DAY) GROUP BY i_item_id, i_item_desc, i_category, i_class, i_current_price), class_totals AS (SELECT i_class, SUM(ws_ext_sales_price) AS class_revenue FROM web_sales INNER JOIN date_dim ON ws_sold_date_sk = d_date_sk INNER JOIN item ON ws_item_sk = i_item_sk WHERE i_category IN ('Books', 'Sports', 'Men') AND d_date BETWEEN CAST('1998-04-06' AS DATE) AND (CAST('1998-04-06' AS DATE) + INTERVAL 30 DAY) GROUP BY i_class), joined_for_ratio AS (SELECT ba.i_item_id, ba.i_item_desc, ba.i_category, ba.i_class, ba.i_current_price, ba.itemrevenue, (ba.itemrevenue * 100 / ct.class_revenue) AS revenueratio FROM base_aggregation ba INNER JOIN class_totals ct ON ba.i_class = ct.i_class) SELECT i_item_id, i_item_desc, i_category, i_class, i_current_price, itemrevenue, revenueratio FROM joined_for_ratio ORDER BY i_category ASC, i_class ASC, i_item_id ASC, i_item_desc ASC, revenueratio ASC LIMIT 100