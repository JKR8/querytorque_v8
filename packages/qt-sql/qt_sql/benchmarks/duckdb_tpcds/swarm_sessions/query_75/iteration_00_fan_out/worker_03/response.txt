## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] filtered_item  [+]  Cost: ~1%  Rows: 10K  — Filter Home category items, output product dimension keys
│   └── OUTPUT (i_item_sk, i_brand_id, i_class_id, i_category_id, i_manufact_id)
├── [CTE] filtered_dates  [+]  Cost: ~1%  Rows: 730  — Filter 1998-1999 date keys
│   └── OUTPUT (d_date_sk, d_year)
├── [CTE] catalog_fact_prejoin  [+]  Cost: ~10%  Rows: 563K  — Join catalog_sales with filtered dimensions
│   └── OUTPUT (cs_order_number, cs_item_sk, d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, cs_quantity, cs_ext_sales_price)
├── [CTE] catalog_returns_join  [+]  Cost: ~15%  Rows: 563K  — Left join catalog_returns, compute net quantities
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] catalog_aggregate  [+]  Cost: ~5%  Rows: ~5K  — Aggregate catalog channel
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] store_fact_prejoin  [+]  Cost: ~10%  Rows: 563K  — Join store_sales with filtered dimensions
│   └── OUTPUT (ss_ticket_number, ss_item_sk, d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ss_quantity, ss_ext_sales_price)
├── [CTE] store_returns_join  [+]  Cost: ~15%  Rows: 563K  — Left join store_returns, compute net quantities
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] store_aggregate  [+]  Cost: ~5%  Rows: ~5K  — Aggregate store channel
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] web_fact_prejoin  [+]  Cost: ~10%  Rows: 563K  — Join web_sales with filtered dimensions
│   └── OUTPUT (ws_order_number, ws_item_sk, d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, ws_quantity, ws_ext_sales_price)
├── [CTE] web_returns_join  [+]  Cost: ~15%  Rows: 563K  — Left join web_returns, compute net quantities
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] web_aggregate  [+]  Cost: ~5%  Rows: ~5K  — Aggregate web channel
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
├── [CTE] all_sales  [~]  Cost: ~2%  Rows: ~15K  — Union three channel aggregates (replaces original multi-union subquery)
│   └── OUTPUT (d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt)
└── [MAIN] main_query  [=]  Cost: ~5%  Rows: ~1K  — Self-join 1999 vs 1998, apply ratio filter, compute diffs
    ├── SCAN (all_sales AS curr_yr (join), all_sales AS prev_yr (join))
    ├── JOIN (curr_yr.i_brand_id = prev_yr.i_brand_id)
    ├── JOIN (+3 more product key equalities)
    ├── FILTER (curr_yr.d_year = 1999)
    ├── FILTER (prev_yr.d_year = 1998)
    ├── FILTER (CAST(curr_yr.sales_cnt AS DECIMAL(17,2))/CAST(prev_yr.sales_cnt AS DECIMAL(17,2)) < 0.9)
    ├── SORT (sales_cnt_diff ASC, sales_amt_diff ASC)
    └── OUTPUT (prev_year, year, i_brand_id, i_class_id, i_category_id, i_manufact_id, prev_yr_cnt, curr_yr_cnt, sales_cnt_diff, sales_amt_diff)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "prefetch_fact_join", "description": "Pre-filter item and date_dim into CTEs before fact table joins", "applied_to": ["filtered_item", "filtered_dates"]},
    {"id": "R2", "type": "staged_join_pipeline", "description": "Split original UNION subquery into three explicit channel branches (catalog/store/web), each with identical staged joins: fact_prejoin → returns_join → aggregate", "applied_to": ["catalog_fact_prejoin", "catalog_returns_join", "catalog_aggregate", "store_fact_prejoin", "store_returns_join", "store_aggregate", "web_fact_prejoin", "web_returns_join", "web_aggregate"]},
    {"id": "R3", "type": "union_cte_split", "description": "Replace original all_sales CTE with union of three pre‑aggregated channel CTEs (eliminates redundant materialization of per‑channel subqueries)", "applied_to": ["all_sales"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_item": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_sk, i_brand_id, i_class_id, i_category_id, i_manufact_id FROM item WHERE i_category = 'Home'",
        "interfaces": {"outputs": ["i_item_sk", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id"], "consumes": []}
      },
      "filtered_dates": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (1998, 1999)",
        "interfaces": {"outputs": ["d_date_sk", "d_year"], "consumes": []}
      },
      "catalog_fact_prejoin": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cs.cs_order_number, cs.cs_item_sk, dd.d_year, fi.i_brand_id, fi.i_class_id, fi.i_category_id, fi.i_manufact_id, cs.cs_quantity, cs.cs_ext_sales_price FROM catalog_sales cs JOIN filtered_item fi ON cs.cs_item_sk = fi.i_item_sk JOIN filtered_dates dd ON cs.cs_sold_date_sk = dd.d_date_sk",
        "interfaces": {"outputs": ["cs_order_number", "cs_item_sk", "d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "cs_quantity", "cs_ext_sales_price"], "consumes": ["filtered_item", "filtered_dates"]}
      },
      "catalog_returns_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cfp.d_year, cfp.i_brand_id, cfp.i_class_id, cfp.i_category_id, cfp.i_manufact_id, cfp.cs_quantity - COALESCE(cr.cr_return_quantity, 0) AS sales_cnt, cfp.cs_ext_sales_price - COALESCE(cr.cr_return_amount, 0.0) AS sales_amt FROM catalog_fact_prejoin cfp LEFT JOIN catalog_returns cr ON cfp.cs_order_number = cr.cr_order_number AND cfp.cs_item_sk = cr.cr_item_sk",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["catalog_fact_prejoin"]}
      },
      "catalog_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM catalog_returns_join GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["catalog_returns_join"]}
      },
      "store_fact_prejoin": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss.ss_ticket_number, ss.ss_item_sk, dd.d_year, fi.i_brand_id, fi.i_class_id, fi.i_category_id, fi.i_manufact_id, ss.ss_quantity, ss.ss_ext_sales_price FROM store_sales ss JOIN filtered_item fi ON ss.ss_item_sk = fi.i_item_sk JOIN filtered_dates dd ON ss.ss_sold_date_sk = dd.d_date_sk",
        "interfaces": {"outputs": ["ss_ticket_number", "ss_item_sk", "d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "ss_quantity", "ss_ext_sales_price"], "consumes": ["filtered_item", "filtered_dates"]}
      },
      "store_returns_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT sfp.d_year, sfp.i_brand_id, sfp.i_class_id, sfp.i_category_id, sfp.i_manufact_id, sfp.ss_quantity - COALESCE(sr.sr_return_quantity, 0) AS sales_cnt, sfp.ss_ext_sales_price - COALESCE(sr.sr_return_amt, 0.0) AS sales_amt FROM store_fact_prejoin sfp LEFT JOIN store_returns sr ON sfp.ss_ticket_number = sr.sr_ticket_number AND sfp.ss_item_sk = sr.sr_item_sk",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["store_fact_prejoin"]}
      },
      "store_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM store_returns_join GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["store_returns_join"]}
      },
      "web_fact_prejoin": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws.ws_order_number, ws.ws_item_sk, dd.d_year, fi.i_brand_id, fi.i_class_id, fi.i_category_id, fi.i_manufact_id, ws.ws_quantity, ws.ws_ext_sales_price FROM web_sales ws JOIN filtered_item fi ON ws.ws_item_sk = fi.i_item_sk JOIN filtered_dates dd ON ws.ws_sold_date_sk = dd.d_date_sk",
        "interfaces": {"outputs": ["ws_order_number", "ws_item_sk", "d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "ws_quantity", "ws_ext_sales_price"], "consumes": ["filtered_item", "filtered_dates"]}
      },
      "web_returns_join": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT wfp.d_year, wfp.i_brand_id, wfp.i_class_id, wfp.i_category_id, wfp.i_manufact_id, wfp.ws_quantity - COALESCE(wr.wr_return_quantity, 0) AS sales_cnt, wfp.ws_ext_sales_price - COALESCE(wr.wr_return_amt, 0.0) AS sales_amt FROM web_fact_prejoin wfp LEFT JOIN web_returns wr ON wfp.ws_order_number = wr.wr_order_number AND wfp.ws_item_sk = wr.wr_item_sk",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["web_fact_prejoin"]}
      },
      "web_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, SUM(sales_cnt) AS sales_cnt, SUM(sales_amt) AS sales_amt FROM web_returns_join GROUP BY d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["web_returns_join"]}
      },
      "all_sales": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM catalog_aggregate UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM store_aggregate UNION ALL SELECT d_year, i_brand_id, i_class_id, i_category_id, i_manufact_id, sales_cnt, sales_amt FROM web_aggregate",
        "interfaces": {"outputs": ["d_year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "sales_cnt", "sales_amt"], "consumes": ["catalog_aggregate", "store_aggregate", "web_aggregate"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["prev_year", "year", "i_brand_id", "i_class_id", "i_category_id", "i_manufact_id", "prev_yr_cnt", "curr_yr_cnt", "sales_cnt_diff", "sales_amt_diff"], "consumes": ["all_sales"]}
      }
    },
    "reconstruction_order": ["filtered_item", "filtered_dates", "catalog_fact_prejoin", "catalog_returns_join", "catalog_aggregate", "store_fact_prejoin", "store_returns_join", "store_aggregate", "web_fact_prejoin", "web_returns_join", "web_aggregate", "all_sales", "main_query"],
    "assembly_template": "WITH filtered_item AS ({filtered_item}), filtered_dates AS ({filtered_dates}), catalog_fact_prejoin AS ({catalog_fact_prejoin}), catalog_returns_join AS ({catalog_returns_join}), catalog_aggregate AS ({catalog_aggregate}), store_fact_prejoin AS ({store_fact_prejoin}), store_returns_join AS ({store_returns_join}), store_aggregate AS ({store_aggregate}), web_fact_prejoin AS ({web_fact_prejoin}), web_returns_join AS ({web_returns_join}), web_aggregate AS ({web_aggregate}), all_sales AS ({all_sales}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

## Main Query SQL (for assembly template)

```sql
SELECT prev_yr.d_year AS prev_year,
       curr_yr.d_year AS year,
       curr_yr.i_brand_id,
       curr_yr.i_class_id,
       curr_yr.i_category_id,
       curr_yr.i_manufact_id,
       prev_yr.sales_cnt AS prev_yr_cnt,
       curr_yr.sales_cnt AS curr_yr_cnt,
       curr_yr.sales_cnt - prev_yr.sales_cnt AS sales_cnt_diff,
       curr_yr.sales_amt - prev_yr.sales_amt AS sales_amt_diff
FROM all_sales curr_yr,
     all_sales prev_yr
WHERE curr_yr.i_brand_id = prev_yr.i_brand_id
  AND curr_yr.i_class_id = prev_yr.i_class_id
  AND curr_yr.i_category_id = prev_yr.i_category_id
  AND curr_yr.i_manufact_id = prev_yr.i_manufact_id
  AND curr_yr.d_year = 1999
  AND prev_yr.d_year = 1998
  AND CAST(curr_yr.sales_cnt AS DECIMAL(17,2)) / CAST(prev_yr.sales_cnt AS DECIMAL(17,2)) < 0.9
ORDER BY sales_cnt_diff,
         sales_amt_diff
LIMIT 100
```

**Changes**: Restructured original monolithic UNION subquery into three separate channel branches (catalog/store/web), each following a staged join pipeline: pre‑filter dimensions (item, date) → fact join → returns left join → aggregation. This allows DuckDB to push filters into each branch independently and eliminates redundant scans of the same dimension tables across channels.

**Expected speedup**: 2–3× from predicate pushdown into each channel branch and elimination of redundant dimension scans.