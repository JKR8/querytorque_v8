WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1224 AND 1224+11), fact_prejoin AS (SELECT ws_item_sk, ws_net_paid FROM web_sales INNER JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), joined_with_item AS (SELECT i_category, i_class, ws_net_paid FROM fact_prejoin INNER JOIN item ON ws_item_sk = i_item_sk), rollup_agg AS (SELECT i_category, i_class, SUM(ws_net_paid) AS total_sum, GROUPING(i_category) AS gcat, GROUPING(i_class) AS gcls FROM joined_with_item GROUP BY ROLLUP(i_category, i_class)), final_window AS (SELECT total_sum, i_category, i_class, gcat + gcls AS lochierarchy, RANK() OVER (PARTITION BY gcat + gcls, CASE WHEN gcls = 0 THEN i_category END ORDER BY total_sum DESC) AS rank_within_parent FROM rollup_agg) SELECT total_sum, i_category, i_class, lochierarchy, rank_within_parent FROM final_window ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100