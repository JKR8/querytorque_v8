WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1224 AND 1224 + 11), fact_with_dates AS (SELECT ws_item_sk, ws_net_paid FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), joined_all AS (SELECT i_category, i_class, ws_net_paid FROM fact_with_dates JOIN item ON ws_item_sk = i_item_sk), level2_agg AS (SELECT i_category, i_class, SUM(ws_net_paid) AS total_sum, 0 AS grouping_category, 0 AS grouping_class FROM joined_all GROUP BY i_category, i_class), level1_agg AS (SELECT i_category, CAST(NULL AS TEXT) AS i_class, SUM(ws_net_paid) AS total_sum, 0 AS grouping_category, 1 AS grouping_class FROM joined_all GROUP BY i_category), level0_agg AS (SELECT CAST(NULL AS TEXT) AS i_category, CAST(NULL AS TEXT) AS i_class, SUM(ws_net_paid) AS total_sum, 1 AS grouping_category, 1 AS grouping_class FROM joined_all), union_all_levels AS (SELECT i_category, i_class, total_sum, grouping_category, grouping_class FROM level2_agg UNION ALL SELECT i_category, i_class, total_sum, grouping_category, grouping_class FROM level1_agg UNION ALL SELECT i_category, i_class, total_sum, grouping_category, grouping_class FROM level0_agg), final_window AS (SELECT total_sum, i_category, i_class, grouping_category + grouping_class AS lochierarchy, RANK() OVER (PARTITION BY grouping_category + grouping_class, CASE WHEN grouping_class = 0 THEN i_category END ORDER BY total_sum DESC) AS rank_within_parent FROM union_all_levels) SELECT total_sum, i_category, i_class, lochierarchy, rank_within_parent FROM final_window ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100