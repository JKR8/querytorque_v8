WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1224 AND 1224 + 11), fact_with_dates AS (SELECT ws_item_sk, ws_net_paid FROM web_sales INNER JOIN filtered_dates ON ws_sold_date_sk = d_date_sk), leaf_agg AS (SELECT i.i_category, i.i_class, SUM(fwd.ws_net_paid) AS leaf_total FROM fact_with_dates fwd INNER JOIN item i ON fwd.ws_item_sk = i.i_item_sk GROUP BY i.i_category, i.i_class), rollup_from_leaves AS (SELECT i_category, i_class, SUM(leaf_total) AS total_sum, GROUPING(i_category) AS gcat, GROUPING(i_class) AS gcls FROM leaf_agg GROUP BY ROLLUP(i_category, i_class)), final_window AS (SELECT total_sum, i_category, i_class, (gcat + gcls) AS lochierarchy, RANK() OVER (PARTITION BY (gcat + gcls), CASE WHEN gcls = 0 THEN i_category END ORDER BY total_sum DESC) AS rank_within_parent FROM rollup_from_leaves) SELECT total_sum, i_category, i_class, lochierarchy, rank_within_parent FROM final_window ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100