WITH date_cte AS (SELECT d_date_sk, d_year, d_qoy, d_moy FROM date_dim WHERE d_month_seq BETWEEN 1206 AND 1206+11), store_cte AS (SELECT s_store_sk, s_store_id FROM store WHERE s_store_sk <= 100), item_cte AS (SELECT i_item_sk, i_category, i_class, i_brand, i_product_name FROM item), base_agg AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, SUM(COALESCE(ss_sales_price * ss_quantity, 0)) AS sumsales FROM store_sales JOIN date_cte ON ss_sold_date_sk = d_date_sk JOIN store_cte ON ss_store_sk = s_store_sk JOIN item_cte ON ss_item_sk = i_item_sk GROUP BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id), rollup_grouping_sets AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, SUM(sumsales) AS sumsales FROM base_agg GROUP BY GROUPING SETS ((i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id), (i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy), (i_category, i_class, i_brand, i_product_name, d_year, d_qoy), (i_category, i_class, i_brand, i_product_name, d_year), (i_category, i_class, i_brand, i_product_name), (i_category, i_class, i_brand), (i_category, i_class), (i_category), ())), window_rank AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales, RANK() OVER (PARTITION BY i_category ORDER BY sumsales DESC) AS rk FROM rollup_grouping_sets), filter_rank AS (SELECT * FROM window_rank WHERE rk <= 100) SELECT * FROM filter_rank ORDER BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales, rk LIMIT 100