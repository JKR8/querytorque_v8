WITH base_agg AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, SUM(COALESCE(ss_sales_price * ss_quantity, 0)) AS sumsales FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN store ON ss_store_sk = s_store_sk JOIN item ON ss_item_sk = i_item_sk WHERE d_month_seq BETWEEN 1206 AND 1206+11 AND s_store_sk <= 100 GROUP BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id), rollup_union AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales FROM base_agg UNION ALL SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy UNION ALL SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy UNION ALL SELECT i_category, i_class, i_brand, i_product_name, d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class, i_brand, i_product_name, d_year UNION ALL SELECT i_category, i_class, i_brand, i_product_name, NULL AS d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class, i_brand, i_product_name UNION ALL SELECT i_category, i_class, i_brand, NULL AS i_product_name, NULL AS d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class, i_brand UNION ALL SELECT i_category, i_class, NULL AS i_brand, NULL AS i_product_name, NULL AS d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category, i_class UNION ALL SELECT i_category, NULL AS i_class, NULL AS i_brand, NULL AS i_product_name, NULL AS d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg GROUP BY i_category UNION ALL SELECT NULL AS i_category, NULL AS i_class, NULL AS i_brand, NULL AS i_product_name, NULL AS d_year, NULL AS d_qoy, NULL AS d_moy, NULL AS s_store_id, SUM(sumsales) FROM base_agg), window_rank AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales, RANK() OVER (PARTITION BY i_category ORDER BY sumsales DESC) AS rk FROM rollup_union), filter_rank AS (SELECT i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales, rk FROM window_rank WHERE rk <= 100) SELECT * FROM filter_rank ORDER BY i_category, i_class, i_brand, i_product_name, d_year, d_qoy, d_moy, s_store_id, sumsales, rk LIMIT 100