WITH d1_cte AS (SELECT d_date_sk FROM date_dim WHERE d_quarter_name = '2001Q1'), d2_cte AS (SELECT d_date_sk FROM date_dim WHERE d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')), d3_cte AS (SELECT d_date_sk FROM date_dim WHERE d_quarter_name IN ('2001Q1', '2001Q2', '2001Q3')), channel_labeled AS (SELECT ss_item_sk AS item_sk, ss_store_sk AS store_sk, ss_customer_sk AS customer_sk, ss_ticket_number AS ticket_number, ss_quantity AS quantity, 'store_sales' AS channel FROM store_sales JOIN d1_cte ON ss_sold_date_sk = d_date_sk UNION ALL SELECT sr_item_sk, NULL AS store_sk, sr_customer_sk, sr_ticket_number, sr_return_quantity, 'store_returns' FROM store_returns JOIN d2_cte ON sr_returned_date_sk = d_date_sk UNION ALL SELECT cs_item_sk, NULL AS store_sk, cs_bill_customer_sk, NULL AS ticket_number, cs_quantity, 'catalog_sales' FROM catalog_sales JOIN d3_cte ON cs_sold_date_sk = d_date_sk), pivot_agg AS (SELECT i_item_id, i_item_desc, s_state, COUNT(ss.quantity) AS store_sales_quantitycount, AVG(ss.quantity) AS store_sales_quantityave, STDDEV_SAMP(ss.quantity) AS store_sales_quantitystdev, CASE WHEN AVG(ss.quantity) > 0 THEN STDDEV_SAMP(ss.quantity)/AVG(ss.quantity) END AS store_sales_quantitycov, COUNT(sr.quantity) AS store_returns_quantitycount, AVG(sr.quantity) AS store_returns_quantityave, STDDEV_SAMP(sr.quantity) AS store_returns_quantitystdev, CASE WHEN AVG(sr.quantity) > 0 THEN STDDEV_SAMP(sr.quantity)/AVG(sr.quantity) END AS store_returns_quantitycov, COUNT(cs.quantity) AS catalog_sales_quantitycount, AVG(cs.quantity) AS catalog_sales_quantityave, STDDEV_SAMP(cs.quantity) AS catalog_sales_quantitystdev, CASE WHEN AVG(cs.quantity) > 0 THEN STDDEV_SAMP(cs.quantity)/AVG(cs.quantity) END AS catalog_sales_quantitycov FROM channel_labeled AS cl JOIN store ON cl.store_sk = s_store_sk JOIN item ON cl.item_sk = i_item_sk LEFT JOIN channel_labeled AS ss ON cl.item_sk = ss.item_sk AND cl.customer_sk = ss.customer_sk AND cl.ticket_number = ss.ticket_number AND ss.channel = 'store_sales' LEFT JOIN channel_labeled AS sr ON cl.item_sk = sr.item_sk AND cl.customer_sk = sr.customer_sk AND cl.ticket_number = sr.ticket_number AND sr.channel = 'store_returns' LEFT JOIN channel_labeled AS cs ON cl.item_sk = cs.item_sk AND cl.customer_sk = cs.customer_sk AND cs.channel = 'catalog_sales' WHERE ss.item_sk IS NOT NULL AND sr.item_sk IS NOT NULL AND cs.item_sk IS NOT NULL GROUP BY i_item_id, i_item_desc, s_state) SELECT i_item_id, i_item_desc, s_state, store_sales_quantitycount, store_sales_quantityave, store_sales_quantitystdev, store_sales_quantitycov, store_returns_quantitycount, store_returns_quantityave, store_returns_quantitystdev, store_returns_quantitycov, catalog_sales_quantitycount, catalog_sales_quantityave, catalog_sales_quantitystdev, catalog_sales_quantitycov FROM pivot_agg ORDER BY i_item_id, i_item_desc, s_state LIMIT 100