WITH filtered_store AS (SELECT s_store_sk, s_store_name, s_state, s_zip FROM store WHERE s_market_id = 8), filtered_item AS (SELECT i_item_sk, i_color, i_current_price, i_manager_id, i_units, i_size FROM item WHERE i_color IN ('beige', 'blue')), base_join_agg AS (SELECT c_last_name, c_first_name, s_store_name, i_color, SUM(ss_net_profit) AS color_netpaid FROM store_sales JOIN store_returns ON ss_ticket_number = sr_ticket_number AND ss_item_sk = sr_item_sk JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE c_birth_country <> UPPER(ca_country) AND s_zip = ca_zip GROUP BY c_last_name, c_first_name, s_store_name, i_color), threshold_cte AS (SELECT 0.05 * AVG(color_netpaid) AS threshold FROM base_join_agg) SELECT c_last_name, c_first_name, s_store_name, SUM(color_netpaid) AS paid FROM base_join_agg CROSS JOIN threshold_cte WHERE i_color = 'beige' GROUP BY c_last_name, c_first_name, s_store_name, threshold HAVING SUM(color_netpaid) > threshold ORDER BY c_last_name, c_first_name, s_store_name