WITH filtered_dates AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (2001, 2002)), store_sales_prejoin AS (SELECT ss.ss_customer_sk, fd.d_year, (ss.ss_ext_list_price - ss.ss_ext_discount_amt) AS amount FROM store_sales ss INNER JOIN filtered_dates fd ON ss.ss_sold_date_sk = fd.d_date_sk), web_sales_prejoin AS (SELECT ws.ws_bill_customer_sk, fd.d_year, (ws.ws_ext_list_price - ws.ws_ext_discount_amt) AS amount FROM web_sales ws INNER JOIN filtered_dates fd ON ws.ws_sold_date_sk = fd.d_date_sk), store_aggregates AS (SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_birth_country AS customer_birth_country, ssp.d_year AS dyear, SUM(ssp.amount) AS year_total, 's' AS sale_type FROM customer c INNER JOIN store_sales_prejoin ssp ON c.c_customer_sk = ssp.ss_customer_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country, ssp.d_year), web_aggregates AS (SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_birth_country AS customer_birth_country, wsp.d_year AS dyear, SUM(wsp.amount) AS year_total, 'w' AS sale_type FROM customer c INNER JOIN web_sales_prejoin wsp ON c.c_customer_sk = wsp.ws_bill_customer_sk GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country, wsp.d_year) SELECT s2002.customer_id, s2002.customer_first_name, s2002.customer_last_name, s2002.customer_birth_country FROM store_aggregates s2001, store_aggregates s2002, web_aggregates w2001, web_aggregates w2002 WHERE s2001.customer_id = s2002.customer_id AND s2001.customer_id = w2001.customer_id AND s2001.customer_id = w2002.customer_id AND s2001.dyear = 2001 AND s2002.dyear = 2002 AND w2001.dyear = 2001 AND w2002.dyear = 2002 AND s2001.year_total > 0 AND w2001.year_total > 0 AND (CASE WHEN w2001.year_total > 0 THEN w2002.year_total / w2001.year_total ELSE 0.0 END) > (CASE WHEN s2001.year_total > 0 THEN s2002.year_total / s2001.year_total ELSE 0.0 END) ORDER BY s2002.customer_id, s2002.customer_first_name, s2002.customer_last_name, s2002.customer_birth_country LIMIT 100