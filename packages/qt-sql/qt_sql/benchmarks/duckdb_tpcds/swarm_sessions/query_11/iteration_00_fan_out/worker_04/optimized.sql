WITH filtered_dates AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (2001, 2002)), consolidated_sales AS (SELECT customer_sk, d_year, sale_type, SUM(amount) AS year_total FROM (SELECT ss_customer_sk AS customer_sk, d_year, (ss_ext_list_price - ss_ext_discount_amt) AS amount, 's' AS sale_type FROM store_sales INNER JOIN filtered_dates fd ON ss_sold_date_sk = fd.d_date_sk UNION ALL SELECT ws_bill_customer_sk AS customer_sk, d_year, (ws_ext_list_price - ws_ext_discount_amt) AS amount, 'w' AS sale_type FROM web_sales INNER JOIN filtered_dates fd ON ws_sold_date_sk = fd.d_date_sk) t GROUP BY customer_sk, d_year, sale_type), customer_late_binding AS (SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_birth_country AS customer_birth_country, cs.d_year AS dyear, cs.year_total, cs.sale_type FROM consolidated_sales cs INNER JOIN customer c ON cs.customer_sk = c.c_customer_sk) SELECT s2002.customer_id, s2002.customer_first_name, s2002.customer_last_name, s2002.customer_birth_country FROM customer_late_binding s2001, customer_late_binding s2002, customer_late_binding w2001, customer_late_binding w2002 WHERE s2001.customer_id = s2002.customer_id AND s2001.customer_id = w2001.customer_id AND s2001.customer_id = w2002.customer_id AND s2001.dyear = 2001 AND s2002.dyear = 2002 AND s2001.sale_type = 's' AND s2002.sale_type = 's' AND w2001.dyear = 2001 AND w2002.dyear = 2002 AND w2001.sale_type = 'w' AND w2002.sale_type = 'w' AND s2001.year_total > 0 AND w2001.year_total > 0 AND (w2002.year_total / w2001.year_total) > (s2002.year_total / s2001.year_total) ORDER BY s2002.customer_id, s2002.customer_first_name, s2002.customer_last_name, s2002.customer_birth_country LIMIT 100