WITH store_baseline_cte AS (SELECT AVG(ss_net_profit) AS store_avg FROM store_sales WHERE ss_store_sk = 146 AND ss_addr_sk IS NULL GROUP BY ss_store_sk), item_aggregates_cte AS (SELECT ss_item_sk AS item_sk, AVG(ss_net_profit) AS item_avg FROM store_sales WHERE ss_store_sk = 146 GROUP BY ss_item_sk), ranked_items_cte AS (SELECT item_sk, RANK() OVER (ORDER BY item_avg ASC) AS asc_rnk, RANK() OVER (ORDER BY item_avg DESC) AS desc_rnk FROM item_aggregates_cte CROSS JOIN store_baseline_cte WHERE item_avg > 0.9 * store_avg) SELECT asc.asc_rnk AS rnk, i1.i_product_name AS best_performing, i2.i_product_name AS worst_performing FROM ranked_items_cte asc JOIN ranked_items_cte desc ON asc.asc_rnk = desc.desc_rnk JOIN item i1 ON asc.item_sk = i1.i_item_sk JOIN item i2 ON desc.item_sk = i2.i_item_sk WHERE asc.asc_rnk < 11 AND desc.desc_rnk < 11 ORDER BY asc.asc_rnk LIMIT 100