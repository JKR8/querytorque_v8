### Modified Logic Tree

```
QUERY:
└── [MAIN] main_query (group_by) [~] (FROM clause changed to use CTE chain)
    ├── CTE: date_range [+] 
    ├── CTE: customer_base [+] 
    ├── CTE: store_filtered [+] 
    └── CTE: web_or_catalog_filtered [+] 
```

### Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "prefetch_fact_join", "description": "Staged CTE pipeline with progressive filtering", "applied_to": ["date_range", "customer_base", "store_filtered", "web_or_catalog_filtered"]},
    {"id": "R2", "type": "dimension_cte_isolate", "description": "Pre-joined customer dimensions into base CTE", "applied_to": ["customer_base"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_range": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001 AND d_qoy < 4",
        "interfaces": {
          "outputs": ["d_date_sk"],
          "consumes": []
        }
      },
      "customer_base": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT c.c_customer_sk, ca.ca_state, cd.cd_gender, cd.cd_marital_status, cd.cd_dep_count, cd.cd_dep_employed_count, cd.cd_dep_college_count FROM customer c JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk",
        "interfaces": {
          "outputs": ["c_customer_sk", "ca_state", "cd_gender", "cd_marital_status", "cd_dep_count", "cd_dep_employed_count", "cd_dep_college_count"],
          "consumes": []
        }
      },
      "store_filtered": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT * FROM customer_base cb WHERE EXISTS (SELECT 1 FROM store_sales ss JOIN date_range dr ON ss.ss_sold_date_sk = dr.d_date_sk WHERE ss.ss_customer_sk = cb.c_customer_sk)",
        "interfaces": {
          "outputs": ["c_customer_sk", "ca_state", "cd_gender", "cd_marital_status", "cd_dep_count", "cd_dep_employed_count", "cd_dep_college_count"],
          "consumes": ["customer_base", "date_range"]
        }
      },
      "web_or_catalog_filtered": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT * FROM store_filtered sf WHERE EXISTS (SELECT 1 FROM web_sales ws JOIN date_range dr ON ws.ws_sold_date_sk = dr.d_date_sk WHERE ws.ws_bill_customer_sk = sf.c_customer_sk) OR EXISTS (SELECT 1 FROM catalog_sales cs JOIN date_range dr ON cs.cs_sold_date_sk = dr.d_date_sk WHERE cs.cs_ship_customer_sk = sf.c_customer_sk)",
        "interfaces": {
          "outputs": ["c_customer_sk", "ca_state", "cd_gender", "cd_marital_status", "cd_dep_count", "cd_dep_employed_count", "cd_dep_college_count"],
          "consumes": ["store_filtered", "date_range"]
        }
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT ca_state, cd_gender, cd_marital_status, cd_dep_count, COUNT(*) AS cnt1, MAX(cd_dep_count), SUM(cd_dep_count), MAX(cd_dep_count), cd_dep_employed_count, COUNT(*) AS cnt2, MAX(cd_dep_employed_count), SUM(cd_dep_employed_count), MAX(cd_dep_employed_count), cd_dep_college_count, COUNT(*) AS cnt3, MAX(cd_dep_college_count), SUM(cd_dep_college_count), MAX(cd_dep_college_count) FROM web_or_catalog_filtered GROUP BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count ORDER BY ca_state, cd_gender, cd_marital_status, cd_dep_count, cd_dep_employed_count, cd_dep_college_count LIMIT 100",
        "interfaces": {
          "outputs": ["ca_state", "cd_gender", "cd_marital_status", "cd_dep_count", "cnt1", "MAX(cd_dep_count)", "SUM(cd_dep_count)", "MAX(cd_dep_count)", "cd_dep_employed_count", "cnt2", "MAX(cd_dep_employed_count)", "SUM(cd_dep_employed_count)", "MAX(cd_dep_employed_count)", "cd_dep_college_count", "cnt3", "MAX(cd_dep_college_count)", "SUM(cd_dep_college_count)", "MAX(cd_dep_college_count)"],
          "consumes": ["web_or_catalog_filtered"]
        }
      }
    },
    "reconstruction_order": ["date_range", "customer_base", "store_filtered", "web_or_catalog_filtered", "main_query"],
    "assembly_template": "WITH date_range AS ({date_range}), customer_base AS ({customer_base}), store_filtered AS ({store_filtered}), web_or_catalog_filtered AS ({web_or_catalog_filtered}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Restructured query into staged CTE pipeline with date_range → customer_base → store_filtered → web_or_catalog_filtered → group_by. Preserved EXISTS semi-joins with OR condition, maintained duplicate MAX() expressions, and kept all original filters/literals.  

Expected speedup: 1.8-2.5x from progressive data reduction and reuse of filtered date dimension.