WITH filtered_reason AS (SELECT r_reason_sk, r_reason_desc FROM reason WHERE r_reason_desc = 'duplicate purchase'), filtered_returns_keys AS (SELECT sr_item_sk, sr_ticket_number, sr_return_quantity FROM store_returns INNER JOIN filtered_reason ON sr_reason_sk = r_reason_sk), sales_with_matching_returns AS (SELECT ss_customer_sk, ss_quantity, ss_sales_price, sr_return_quantity FROM store_sales INNER JOIN filtered_returns_keys ON ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number), adjusted_sales AS (SELECT ss_customer_sk, (ss_quantity - sr_return_quantity) * ss_sales_price AS act_sales FROM sales_with_matching_returns), aggregated AS (SELECT ss_customer_sk, SUM(act_sales) AS sumsales FROM adjusted_sales GROUP BY ss_customer_sk), top_n AS (SELECT ss_customer_sk, sumsales FROM aggregated ORDER BY sumsales ASC, ss_customer_sk ASC LIMIT 100) SELECT ss_customer_sk, sumsales FROM top_n