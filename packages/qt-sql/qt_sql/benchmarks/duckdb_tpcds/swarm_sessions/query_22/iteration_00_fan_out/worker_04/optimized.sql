WITH date_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1188 AND 1188 + 11), inventory_agg AS (SELECT inv_item_sk, SUM(inv_quantity_on_hand) AS sum_qty, COUNT(inv_quantity_on_hand) AS cnt FROM inventory JOIN date_filtered ON inv_date_sk = d_date_sk GROUP BY inv_item_sk), join_item AS (SELECT i_product_name, i_brand, i_class, i_category, sum_qty, cnt FROM inventory_agg JOIN item ON inv_item_sk = i_item_sk), union_levels_with_sums AS (SELECT i_product_name, i_brand, i_class, i_category, SUM(sum_qty) AS total_sum, SUM(cnt) AS total_cnt FROM join_item GROUP BY i_product_name, i_brand, i_class, i_category UNION ALL SELECT i_product_name, i_brand, i_class, NULL, SUM(sum_qty) AS total_sum, SUM(cnt) AS total_cnt FROM join_item GROUP BY i_product_name, i_brand, i_class UNION ALL SELECT i_product_name, i_brand, NULL, NULL, SUM(sum_qty) AS total_sum, SUM(cnt) AS total_cnt FROM join_item GROUP BY i_product_name, i_brand UNION ALL SELECT i_product_name, NULL, NULL, NULL, SUM(sum_qty) AS total_sum, SUM(cnt) AS total_cnt FROM join_item GROUP BY i_product_name UNION ALL SELECT NULL, NULL, NULL, NULL, SUM(sum_qty) AS total_sum, SUM(cnt) AS total_cnt FROM join_item), final_avg AS (SELECT i_product_name, i_brand, i_class, i_category, total_sum / total_cnt AS qoh FROM union_levels_with_sums WHERE total_cnt > 0) SELECT i_product_name, i_brand, i_class, i_category, qoh FROM final_avg ORDER BY qoh ASC, i_product_name ASC, i_brand ASC, i_class ASC, i_category ASC LIMIT 100