{
  "worker_id": 3,
  "strategy": "yearly_avg_group_by",
  "examples_used": [
    "deferred_window_aggregation"
  ],
  "optimized_sql": "WITH monthly_sales AS (SELECT i_category, i_brand, cc_name, d_year, d_moy, SUM(cs_sales_price) AS sum_sales FROM item, catalog_sales, date_dim, call_center WHERE cs_item_sk = i_item_sk AND cs_sold_date_sk = d_date_sk AND cc_call_center_sk = cs_call_center_sk AND (d_year = 1999 OR (d_year = 1998 AND d_moy = 12) OR (d_year = 2000 AND d_moy = 1)) GROUP BY i_category, i_brand, cc_name, d_year, d_moy), yearly_avg AS (SELECT i_category, i_brand, cc_name, d_year, AVG(sum_sales) AS avg_monthly_sales FROM monthly_sales GROUP BY i_category, i_brand, cc_name, d_year), v1_combined AS (SELECT ms.i_category, ms.i_brand, ms.cc_name, ms.d_year, ms.d_moy, ms.sum_sales, ya.avg_monthly_sales, RANK() OVER (PARTITION BY ms.i_category, ms.i_brand, ms.cc_name ORDER BY ms.d_year, ms.d_moy) AS rn FROM monthly_sales ms INNER JOIN yearly_avg ya ON ms.i_category = ya.i_category AND ms.i_brand = ya.i_brand AND ms.cc_name = ya.cc_name AND ms.d_year = ya.d_year), v2 AS (SELECT v1.i_brand, v1.d_year, v1.avg_monthly_sales, v1.sum_sales, v1_lag.sum_sales AS psum, v1_lead.sum_sales AS nsum FROM v1_combined v1, v1_combined v1_lag, v1_combined v1_lead WHERE v1.i_category = v1_lag.i_category AND v1.i_category = v1_lead.i_category AND v1.i_brand = v1_lag.i_brand AND v1.i_brand = v1_lead.i_brand AND v1.cc_name = v1_lag.cc_name AND v1.cc_name = v1_lead.cc_name AND v1.rn = v1_lag.rn + 1 AND v1.rn = v1_lead.rn - 1) SELECT * FROM v2 WHERE d_year = 1999 AND avg_monthly_sales > 0 AND CASE WHEN avg_monthly_sales > 0 THEN abs(sum_sales - avg_monthly_sales) / avg_monthly_sales END > 0.1 ORDER BY sum_sales - avg_monthly_sales, nsum LIMIT 100",
  "speedup": 1.0,
  "status": "NEUTRAL",
  "transforms": [
    "prefetch_fact_join"
  ],
  "hint": "Apply the deferred aggregation pattern: split the AVG window into a separate gro",
  "error_message": null,
  "error_messages": [],
  "error_category": null
}