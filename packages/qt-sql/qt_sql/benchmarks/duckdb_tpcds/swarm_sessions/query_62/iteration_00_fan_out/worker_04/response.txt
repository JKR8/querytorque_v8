## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — Re-structured to match target logical tree with CTEs
    ├── [=] SCAN (web_sales, warehouse, ship_mode, web_site, date_dim)
    ├── [+] CTE date_filter_cte
    │   └── SCAN (date_dim) with filter d_month_seq BETWEEN 1194 AND 1194 + 11
    ├── [+] CTE filtered_sales_cte
    │   └── JOIN (web_sales INNER JOIN date_filter_cte ON ws_ship_date_sk = d_date_sk)
    ├── [+] CTE aggregated_sales_cte
    │   ├── FROM filtered_sales_cte
    │   └── AGG (GROUP BY ws_warehouse_sk, ws_ship_mode_sk, ws_web_site_sk)
    ├── [+] CTE join_warehouse_cte
    │   └── JOIN (aggregated_sales_cte INNER JOIN warehouse ON ws_warehouse_sk = w_warehouse_sk)
    ├── [~] JOIN sequence modified:
    │   ├── FROM join_warehouse_cte
    │   ├── JOIN (INNER JOIN ship_mode ON ws_ship_mode_sk = sm_ship_mode_sk)
    │   └── JOIN (INNER JOIN web_site ON ws_web_site_sk = web_site_sk)
    ├── [=] FILTER (d_month_seq BETWEEN 1194 AND 1194 + 11) - now in date_filter_cte
    ├── [=] AGG (GROUP BY) - now in aggregated_sales_cte
    ├── [=] SORT (SUBSTRING(w_warehouse_name, 1, 20) ASC, sm_type ASC, web_name ASC)
    └── [=] OUTPUT (SUBSTRING(w_warehouse_name, 1, 20), sm_type, web_name, 30 days, 31-60 days, 61-90 days, 91-120 days, >120 days)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Extract date dimension filter into early CTE to reduce hash table size", "applied_to": ["date_filter_cte"]},
    {"id": "R2", "type": "late_attribute_binding", "description": "Defer ship_mode and web_site joins until after aggregation and warehouse join", "applied_to": ["final_join_and_select"]},
    {"id": "R3", "type": "predicate_pushdown", "description": "Push date filter directly against date_dim before joining with fact table", "applied_to": ["date_filter_cte", "filtered_sales_cte"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_filter_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM tpcds_sf10.main.date_dim WHERE d_month_seq BETWEEN 1194 AND 1194 + 11",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_sales_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws.ws_warehouse_sk, ws.ws_ship_mode_sk, ws.ws_web_site_sk, ws.ws_ship_date_sk, ws.ws_sold_date_sk FROM tpcds_sf10.main.web_sales ws INNER JOIN date_filter_cte df ON ws.ws_ship_date_sk = df.d_date_sk",
        "interfaces": {"outputs": ["ws_warehouse_sk", "ws_ship_mode_sk", "ws_web_site_sk", "ws_ship_date_sk", "ws_sold_date_sk"], "consumes": ["date_filter_cte"]}
      },
      "aggregated_sales_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws_warehouse_sk, ws_ship_mode_sk, ws_web_site_sk, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS days_30, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 30 AND ws_ship_date_sk - ws_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS days_31_60, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 60 AND ws_ship_date_sk - ws_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS days_61_90, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 90 AND ws_ship_date_sk - ws_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS days_91_120, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 120) THEN 1 ELSE 0 END) AS days_over_120 FROM filtered_sales_cte GROUP BY ws_warehouse_sk, ws_ship_mode_sk, ws_web_site_sk",
        "interfaces": {"outputs": ["ws_warehouse_sk", "ws_ship_mode_sk", "ws_web_site_sk", "days_30", "days_31_60", "days_61_90", "days_91_120", "days_over_120"], "consumes": ["filtered_sales_cte"]}
      },
      "join_warehouse_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ag.ws_ship_mode_sk, ag.ws_web_site_sk, ag.days_30, ag.days_31_60, ag.days_61_90, ag.days_91_120, ag.days_over_120, w.w_warehouse_name FROM aggregated_sales_cte ag INNER JOIN tpcds_sf10.main.warehouse w ON ag.ws_warehouse_sk = w.w_warehouse_sk",
        "interfaces": {"outputs": ["ws_ship_mode_sk", "ws_web_site_sk", "days_30", "days_31_60", "days_61_90", "days_91_120", "days_over_120", "w_warehouse_name"], "consumes": ["aggregated_sales_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT SUBSTR(jw.w_warehouse_name,1,20) AS w_warehouse_name_20, sm.sm_type, web.web_name, jw.days_30 AS \"30 days\", jw.days_31_60 AS \"31-60 days\", jw.days_61_90 AS \"61-90 days\", jw.days_91_120 AS \"91-120 days\", jw.days_over_120 AS \">120 days\" FROM join_warehouse_cte jw INNER JOIN tpcds_sf10.main.ship_mode sm ON jw.ws_ship_mode_sk = sm.sm_ship_mode_sk INNER JOIN tpcds_sf10.main.web_site web ON jw.ws_web_site_sk = web.web_site_sk ORDER BY SUBSTR(jw.w_warehouse_name,1,20), sm.sm_type, web.web_name LIMIT 100",
        "interfaces": {"outputs": ["w_warehouse_name_20", "sm_type", "web_name", "30 days", "31-60 days", "61-90 days", "91-120 days", ">120 days"], "consumes": ["join_warehouse_cte"]}
      }
    },
    "reconstruction_order": ["date_filter_cte", "filtered_sales_cte", "aggregated_sales_cte", "join_warehouse_cte", "main_query"],
    "assembly_template": "WITH date_filter_cte AS ({date_filter_cte}), filtered_sales_cte AS ({filtered_sales_cte}), aggregated_sales_cte AS ({aggregated_sales_cte}), join_warehouse_cte AS ({join_warehouse_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Restructured the original 5-table join into a CTE pipeline that isolates the date dimension filter early, aggregates before joining dimension tables with many columns, and defers ship_mode and web_site joins until final selection. This reduces the hash table size for the initial web_sales join and minimizes the data volume before aggregation.

**Expected speedup**: 1.5-2.0x due to smaller hash tables from early date filtering and reduced data movement before aggregation.