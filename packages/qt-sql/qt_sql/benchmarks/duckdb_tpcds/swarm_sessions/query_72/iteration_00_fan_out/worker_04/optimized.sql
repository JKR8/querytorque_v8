WITH CTE_core_filters AS (SELECT cs.cs_item_sk, cs.cs_order_number, cs.cs_promo_sk, inv.inv_warehouse_sk, d1.d_week_seq FROM catalog_sales cs INNER JOIN inventory inv ON cs.cs_item_sk = inv.inv_item_sk INNER JOIN date_dim d1 ON cs.cs_sold_date_sk = d1.d_date_sk INNER JOIN date_dim d2 ON inv.inv_date_sk = d2.d_date_sk INNER JOIN date_dim d3 ON cs.cs_ship_date_sk = d3.d_date_sk INNER JOIN customer_demographics cd ON cs.cs_bill_cdemo_sk = cd.cd_demo_sk INNER JOIN household_demographics hd ON cs.cs_bill_hdemo_sk = hd.hd_demo_sk WHERE d1.d_week_seq = d2.d_week_seq AND inv.inv_quantity_on_hand < cs.cs_quantity AND d3.d_date > d1.d_date + INTERVAL '5' DAY AND hd.hd_buy_potential = '501-1000' AND d1.d_year = 2002 AND cd.cd_marital_status = 'W'), CTE_agg_core AS (SELECT cs_item_sk, inv_warehouse_sk, d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN p_promo_sk IS NOT NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM CTE_core_filters cf LEFT JOIN promotion p ON p.p_promo_sk = cf.cs_promo_sk LEFT JOIN catalog_returns cr ON cr.cr_item_sk = cf.cs_item_sk AND cr.cr_order_number = cf.cs_order_number GROUP BY cs_item_sk, inv_warehouse_sk, d_week_seq), CTE_late_dim_joins AS (SELECT i.i_item_desc, w.w_warehouse_name, ac.d_week_seq, ac.no_promo, ac.promo, ac.total_cnt FROM CTE_agg_core ac INNER JOIN item i ON i.i_item_sk = ac.cs_item_sk INNER JOIN warehouse w ON w.w_warehouse_sk = ac.inv_warehouse_sk) SELECT i_item_desc, w_warehouse_name, d_week_seq, no_promo, promo, total_cnt FROM CTE_late_dim_joins ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, d_week_seq LIMIT 100