WITH date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999), store_cte AS (SELECT s_store_sk, s_state FROM store WHERE s_state IN ('MO','AL','MI','TN','LA','SC')), customer_demographics_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'D' AND cd_education_status = 'Secondary'), fact_filtered AS (SELECT ss.ss_item_sk, st.s_state, ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price FROM store_sales ss INNER JOIN date_cte d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN store_cte st ON ss.ss_store_sk = st.s_store_sk INNER JOIN customer_demographics_cte cd ON ss.ss_cdemo_sk = cd.cd_demo_sk), pre_aggregate AS (SELECT ss_item_sk, s_state, SUM(ss_quantity) AS sum_qty, COUNT(ss_quantity) AS cnt_qty, SUM(ss_list_price) AS sum_price, COUNT(ss_list_price) AS cnt_price, SUM(ss_coupon_amt) AS sum_coupon, COUNT(ss_coupon_amt) AS cnt_coupon, SUM(ss_sales_price) AS sum_sales, COUNT(ss_sales_price) AS cnt_sales FROM fact_filtered GROUP BY ss_item_sk, s_state), item_join AS (SELECT i.i_item_id, pa.s_state, pa.sum_qty, pa.cnt_qty, pa.sum_price, pa.cnt_price, pa.sum_coupon, pa.cnt_coupon, pa.sum_sales, pa.cnt_sales FROM pre_aggregate pa INNER JOIN item i ON pa.ss_item_sk = i.i_item_sk), final_aggregate_rollup AS (SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, CASE WHEN SUM(cnt_qty) > 0 THEN SUM(sum_qty) / SUM(cnt_qty) ELSE NULL END AS agg1, CASE WHEN SUM(cnt_price) > 0 THEN SUM(sum_price) / SUM(cnt_price) ELSE NULL END AS agg2, CASE WHEN SUM(cnt_coupon) > 0 THEN SUM(sum_coupon) / SUM(cnt_coupon) ELSE NULL END AS agg3, CASE WHEN SUM(cnt_sales) > 0 THEN SUM(sum_sales) / SUM(cnt_sales) ELSE NULL END AS agg4 FROM item_join GROUP BY ROLLUP (i_item_id, s_state)) SELECT i_item_id, s_state, g_state, agg1, agg2, agg3, agg4 FROM final_aggregate_rollup ORDER BY i_item_id, s_state LIMIT 100