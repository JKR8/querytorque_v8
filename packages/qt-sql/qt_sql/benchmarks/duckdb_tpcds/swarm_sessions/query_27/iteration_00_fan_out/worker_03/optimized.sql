WITH date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999), customer_demographics_cte AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_gender = 'F' AND cd_marital_status = 'D' AND cd_education_status = 'Secondary'), store_cte AS (SELECT s_store_sk, s_state FROM store WHERE s_state IN ('MO','AL','MI','TN','LA','SC')), fact_prejoined AS (SELECT ss.ss_item_sk, ss.ss_quantity, ss.ss_list_price, ss.ss_coupon_amt, ss.ss_sales_price, st.s_state FROM store_sales ss INNER JOIN date_cte dt ON ss.ss_sold_date_sk = dt.d_date_sk INNER JOIN customer_demographics_cte cd ON ss.ss_cdemo_sk = cd.cd_demo_sk INNER JOIN store_cte st ON ss.ss_store_sk = st.s_store_sk), item_join AS (SELECT i.i_item_id, fp.s_state, fp.ss_quantity, fp.ss_list_price, fp.ss_coupon_amt, fp.ss_sales_price FROM fact_prejoined fp INNER JOIN item i ON fp.ss_item_sk = i.i_item_sk), aggregate_rollup AS (SELECT i_item_id, s_state, GROUPING(s_state) AS g_state, AVG(ss_quantity) AS agg1, AVG(ss_list_price) AS agg2, AVG(ss_coupon_amt) AS agg3, AVG(ss_sales_price) AS agg4 FROM item_join GROUP BY ROLLUP (i_item_id, s_state)) SELECT i_item_id, s_state, g_state, agg1, agg2, agg3, agg4 FROM aggregate_rollup ORDER BY i_item_id, s_state LIMIT 100