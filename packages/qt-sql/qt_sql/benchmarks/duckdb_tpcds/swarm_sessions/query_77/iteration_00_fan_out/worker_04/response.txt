## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] date_range  [+]  — Date filter for 30-day period, consumed by all fact scans
│   ├── SCAN date_dim
│   ├── FILTER (d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL 30 DAY))
│   └── OUTPUT (d_date_sk, d_date)
├── [CTE] all_facts_union  [+]  — Union all fact rows with channel labeling and zero padding
│   ├── SCAN store_sales, date_range
│   ├── SCAN store_returns, date_range
│   ├── SCAN catalog_sales, date_range
│   ├── SCAN catalog_returns, date_range
│   ├── SCAN web_sales, date_range
│   ├── SCAN web_returns, date_range
│   └── OUTPUT (channel, entity_key, sales_amt, profit_amt, return_amt, loss_amt, type)
├── [CTE] channel_aggregates  [+]  — Group by channel, entity_key, type
│   ├── SCAN all_facts_union
│   ├── AGG (GROUP BY channel, entity_key, type)
│   └── OUTPUT (channel, entity_key, type, sales, profit, returns, loss)
├── [CTE] catalog_cross  [+]  — CROSS JOIN of catalog sales and returns aggregates
│   ├── SCAN channel_aggregates (filtered for catalog sales)
│   ├── SCAN channel_aggregates (filtered for catalog returns)
│   ├── JOIN (CROSS)
│   └── OUTPUT (cs_key, cr_key, sales, profit, returns, loss)
├── [~] main_query (now main_union)  [~]  — Combine channels: store and web via GROUP BY, catalog via cross join
│   ├── SCAN channel_aggregates (store)
│   ├── SCAN catalog_cross
│   ├── SCAN channel_aggregates (web)
│   ├── UNION ALL
│   └── OUTPUT (channel, id, sales, returns, profit)
├── [~] rollup  [~]  — Group by ROLLUP and order
│   ├── SCAN main_union
│   ├── AGG (GROUP BY ROLLUP(channel, id))
│   ├── SORT (channel, id)
│   └── OUTPUT (channel, id, sales, returns, profit)
└── [-] Remove original CTEs ss, sr, cs, cr, ws, wr
```

**Change markers:**
- `[+]` date_range: isolates date filter, consumed by all fact scans
- `[+]` all_facts_union: single union of all fact rows with channel labeling and zero padding
- `[+]` channel_aggregates: groups by channel, entity_key, type
- `[+]` catalog_cross: CROSS JOIN of catalog sales and returns aggregates
- `[~]` main_union: replaces original main query, combines channels
- `[~]` rollup: replaces final aggregation and ordering
- `[-]` Original CTEs ss, sr, cs, cr, ws, wr removed

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "date_cte_isolate", "description": "Extract date filter to single CTE reused across all fact scans", "applied_to": ["date_range"]},
    {"id": "R2", "type": "single_pass_aggregation", "description": "Consolidate all fact table scans into one union with channel labeling", "applied_to": ["all_facts_union", "channel_aggregates"]},
    {"id": "R3", "type": "catalog_cross_preservation", "description": "Explicitly model catalog channel CROSS JOIN as separate CTE", "applied_to": ["catalog_cross"]},
    {"id": "R4", "type": "channel_combination", "description": "Combine store and web via GROUP BY, catalog via cross join in main_union", "applied_to": ["main_union", "rollup"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_range": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL 30 DAY)",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "all_facts_union": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT 'store' AS channel, ss_store_sk AS entity_key, ss_ext_sales_price AS sales_amt, ss_net_profit AS profit_amt, CAST(0 AS DECIMAL(7,2)) AS return_amt, CAST(0 AS DECIMAL(7,2)) AS loss_amt, 'sales' AS type FROM store_sales, date_range WHERE ss_sold_date_sk = date_range.d_date_sk UNION ALL SELECT 'store' AS channel, sr_store_sk AS entity_key, CAST(0 AS DECIMAL(7,2)) AS sales_amt, CAST(0 AS DECIMAL(7,2)) AS profit_amt, sr_return_amt AS return_amt, sr_net_loss AS loss_amt, 'returns' AS type FROM store_returns, date_range WHERE sr_returned_date_sk = date_range.d_date_sk UNION ALL SELECT 'catalog' AS channel, cs_call_center_sk AS entity_key, cs_ext_sales_price AS sales_amt, cs_net_profit AS profit_amt, CAST(0 AS DECIMAL(7,2)) AS return_amt, CAST(0 AS DECIMAL(7,2)) AS loss_amt, 'sales' AS type FROM catalog_sales, date_range WHERE cs_sold_date_sk = date_range.d_date_sk UNION ALL SELECT 'catalog' AS channel, cr_call_center_sk AS entity_key, CAST(0 AS DECIMAL(7,2)) AS sales_amt, CAST(0 AS DECIMAL(7,2)) AS profit_amt, cr_return_amount AS return_amt, cr_net_loss AS loss_amt, 'returns' AS type FROM catalog_returns, date_range WHERE cr_returned_date_sk = date_range.d_date_sk UNION ALL SELECT 'web' AS channel, ws_web_page_sk AS entity_key, ws_ext_sales_price AS sales_amt, ws_net_profit AS profit_amt, CAST(0 AS DECIMAL(7,2)) AS return_amt, CAST(0 AS DECIMAL(7,2)) AS loss_amt, 'sales' AS type FROM web_sales, date_range WHERE ws_sold_date_sk = date_range.d_date_sk UNION ALL SELECT 'web' AS channel, wr_web_page_sk AS entity_key, CAST(0 AS DECIMAL(7,2)) AS sales_amt, CAST(0 AS DECIMAL(7,2)) AS profit_amt, wr_return_amt AS return_amt, wr_net_loss AS loss_amt, 'returns' AS type FROM web_returns, date_range WHERE wr_returned_date_sk = date_range.d_date_sk",
        "interfaces": {"outputs": ["channel", "entity_key", "sales_amt", "profit_amt", "return_amt", "loss_amt", "type"], "consumes": ["date_range"]}
      },
      "channel_aggregates": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT channel, entity_key, type, SUM(sales_amt) AS sales, SUM(profit_amt) AS profit, SUM(return_amt) AS returns, SUM(loss_amt) AS loss FROM all_facts_union GROUP BY channel, entity_key, type",
        "interfaces": {"outputs": ["channel", "entity_key", "type", "sales", "profit", "returns", "loss"], "consumes": ["all_facts_union"]}
      },
      "catalog_cross": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT cs.entity_key AS cs_key, cr.entity_key AS cr_key, cs.sales, cs.profit, cr.returns, cr.loss FROM (SELECT entity_key, sales, profit FROM channel_aggregates WHERE channel = 'catalog' AND type = 'sales') cs CROSS JOIN (SELECT entity_key, returns, loss FROM channel_aggregates WHERE channel = 'catalog' AND type = 'returns') cr",
        "interfaces": {"outputs": ["cs_key", "cr_key", "sales", "profit", "returns", "loss"], "consumes": ["channel_aggregates"]}
      },
      "main_union": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT 'store channel' AS channel, entity_key AS id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) - SUM(loss) AS profit FROM channel_aggregates WHERE channel = 'store' GROUP BY entity_key UNION ALL SELECT 'catalog channel' AS channel, cs_key AS id, sales, returns, profit - loss AS profit FROM catalog_cross UNION ALL SELECT 'web channel' AS channel, entity_key AS id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) - SUM(loss) AS profit FROM channel_aggregates WHERE channel = 'web' GROUP BY entity_key",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["channel_aggregates", "catalog_cross"]}
      },
      "rollup": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM main_union GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100",
        "interfaces": {"outputs": ["channel", "id", "sales", "returns", "profit"], "consumes": ["main_union"]}
      }
    },
    "reconstruction_order": ["date_range", "all_facts_union", "channel_aggregates", "catalog_cross", "main_union", "rollup"],
    "assembly_template": "WITH date_range AS ({date_range}), all_facts_union AS ({all_facts_union}), channel_aggregates AS ({channel_aggregates}), catalog_cross AS ({catalog_cross}), main_union AS ({main_union}) {rollup}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": [
    {"name": "output_schema", "check": "final output columns match channel, id, sales, returns, profit"},
    {"name": "catalog_cross", "check": "CROSS JOIN preserved between catalog sales and returns aggregates"},
    {"name": "date_filter", "check": "date range exactly 30 days from 1998-08-05"}
  ]
}
```

**Changes:** Consolidated six separate fact scans into a single union with channel labeling, isolating date filter into reusable CTE. Catalog channel CROSS JOIN explicitly modeled. Store and web channels aggregated separately then combined. Final rollup and ordering preserved.

**Expected speedup:** ~2-3x by eliminating redundant date_dim scans (from 6 to 1) and enabling columnar scan optimization across unified fact union.