WITH date_range AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_date BETWEEN CAST('1998-08-05' AS DATE) AND (CAST('1998-08-05' AS DATE) + INTERVAL 30 DAY)), store_filtered AS (SELECT s_store_sk FROM store WHERE s_store_sk <= 100), web_page_filtered AS (SELECT wp_web_page_sk FROM web_page), ss AS (SELECT s.s_store_sk, SUM(ss_ext_sales_price) AS sales, SUM(ss_net_profit) AS profit FROM store_sales ss JOIN date_range dr ON ss.ss_sold_date_sk = dr.d_date_sk JOIN store_filtered s ON ss.ss_store_sk = s.s_store_sk GROUP BY s.s_store_sk), sr AS (SELECT s.s_store_sk, SUM(sr_return_amt) AS returns, SUM(sr_net_loss) AS profit_loss FROM store_returns sr JOIN date_range dr ON sr.sr_returned_date_sk = dr.d_date_sk JOIN store_filtered s ON sr.sr_store_sk = s.s_store_sk GROUP BY s.s_store_sk), cs AS (SELECT cs_call_center_sk, SUM(cs_ext_sales_price) AS sales, SUM(cs_net_profit) AS profit FROM catalog_sales cs JOIN date_range dr ON cs.cs_sold_date_sk = dr.d_date_sk GROUP BY cs_call_center_sk), cr AS (SELECT cr_call_center_sk, SUM(cr_return_amount) AS returns, SUM(cr_net_loss) AS profit_loss FROM catalog_returns cr JOIN date_range dr ON cr.cr_returned_date_sk = dr.d_date_sk GROUP BY cr_call_center_sk), ws AS (SELECT wp.wp_web_page_sk, SUM(ws_ext_sales_price) AS sales, SUM(ws_net_profit) AS profit FROM web_sales ws JOIN date_range dr ON ws.ws_sold_date_sk = dr.d_date_sk JOIN web_page_filtered wp ON ws.ws_web_page_sk = wp.wp_web_page_sk GROUP BY wp.wp_web_page_sk), wr AS (SELECT wp.wp_web_page_sk, SUM(wr_return_amt) AS returns, SUM(wr_net_loss) AS profit_loss FROM web_returns wr JOIN date_range dr ON wr.wr_returned_date_sk = dr.d_date_sk JOIN web_page_filtered wp ON wr.wr_web_page_sk = wp.wp_web_page_sk GROUP BY wp.wp_web_page_sk) SELECT channel, id, SUM(sales) AS sales, SUM(returns) AS returns, SUM(profit) AS profit FROM (SELECT 'store channel' AS channel, ss.s_store_sk AS id, sales, COALESCE(returns, 0) AS returns, (profit - COALESCE(profit_loss, 0)) AS profit FROM ss LEFT JOIN sr ON ss.s_store_sk = sr.s_store_sk UNION ALL SELECT 'catalog channel' AS channel, cs_call_center_sk AS id, sales, returns, (profit - profit_loss) AS profit FROM cs, cr UNION ALL SELECT 'web channel' AS channel, ws.wp_web_page_sk AS id, sales, COALESCE(returns, 0) AS returns, (profit - COALESCE(profit_loss, 0)) AS profit FROM ws LEFT JOIN wr ON ws.wp_web_page_sk = wr.wp_web_page_sk) x GROUP BY ROLLUP (channel, id) ORDER BY channel, id LIMIT 100