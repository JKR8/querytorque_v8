## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — Restructured with CTE pipeline for early dimension filtering
    ├── CTE filtered_date  [+]
    │   └── SCAN date_dim (d_date_sk)
    ├── CTE filtered_cd1  [+]
    │   └── SCAN customer_demographics (cd_demo_sk, cd_dep_count)
    ├── CTE filtered_customer_chain  [+]
    │   ├── SCAN customer (c_customer_sk, c_birth_year)
    │   ├── JOIN customer_demographics cd2 (c_current_cdemo_sk = cd_demo_sk)
    │   └── JOIN customer_address (c_current_addr_sk = ca_address_sk)
    ├── CTE fact_agg  [+]
    │   ├── SCAN catalog_sales (cs_item_sk, cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, cs_net_profit)
    │   ├── JOIN filtered_date (cs_sold_date_sk = d_date_sk)
    │   ├── JOIN filtered_cd1 (cs_bill_cdemo_sk = cd_demo_sk)
    │   └── JOIN filtered_customer_chain (cs_bill_customer_sk = c_customer_sk)
    ├── CTE join_item  [+]
    │   ├── SCAN fact_agg (all columns)
    │   └── JOIN item (cs_item_sk = i_item_sk)
    ├── CTE rollup_agg  [+]
    │   └── GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county)
    ├── CTE order_limit  [+]
    │   ├── SORT (ca_country, ca_state, ca_county, i_item_id)
    │   └── LIMIT 100
    └── OUTPUT (i_item_id, ca_country, ca_state, ca_county, agg1..agg7)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Pre-filter dimension tables into CTEs before fact table join", "applied_to": ["filtered_date", "filtered_cd1", "filtered_customer_chain"]},
    {"id": "R2", "type": "prefetch_fact_join", "description": "Join filtered dimensions sequentially to fact table in separate CTE", "applied_to": ["fact_agg"]},
    {"id": "R3", "type": "deferred_aggregation", "description": "Defer ROLLUP aggregation until after all joins are complete", "applied_to": ["rollup_agg"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 1998",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_cd1": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cd_demo_sk, cd_dep_count FROM customer_demographics WHERE cd_gender = 'F' AND cd_education_status = 'Advanced Degree'",
        "interfaces": {"outputs": ["cd_demo_sk", "cd_dep_count"], "consumes": []}
      },
      "filtered_customer_chain": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT c_customer_sk, c_birth_year, ca_country, ca_state, ca_county FROM customer INNER JOIN customer_demographics cd2 ON c_current_cdemo_sk = cd2.cd_demo_sk INNER JOIN customer_address ON c_current_addr_sk = ca_address_sk WHERE c_birth_month IN (10,7,8,4,1,2) AND ca_state IN ('WA','GA','NC','ME','WY','OK','IN')",
        "interfaces": {"outputs": ["c_customer_sk", "c_birth_year", "ca_country", "ca_state", "ca_county"], "consumes": []}
      },
      "fact_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cs_item_sk, ca_country, ca_state, ca_county, cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, cs_net_profit, c_birth_year, cd_dep_count FROM catalog_sales INNER JOIN filtered_date ON cs_sold_date_sk = d_date_sk INNER JOIN filtered_cd1 ON cs_bill_cdemo_sk = cd_demo_sk INNER JOIN filtered_customer_chain ON cs_bill_customer_sk = c_customer_sk",
        "interfaces": {"outputs": ["cs_item_sk", "ca_country", "ca_state", "ca_county", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit", "c_birth_year", "cd_dep_count"], "consumes": ["filtered_date", "filtered_cd1", "filtered_customer_chain"]}
      },
      "join_item": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_id, ca_country, ca_state, ca_county, cs_quantity, cs_list_price, cs_coupon_amt, cs_sales_price, cs_net_profit, c_birth_year, cd_dep_count FROM fact_agg INNER JOIN item ON cs_item_sk = i_item_sk",
        "interfaces": {"outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "cs_quantity", "cs_list_price", "cs_coupon_amt", "cs_sales_price", "cs_net_profit", "c_birth_year", "cd_dep_count"], "consumes": ["fact_agg"]}
      },
      "rollup_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_id, ca_country, ca_state, ca_county, AVG(CAST(cs_quantity AS DECIMAL(12,2))) AS agg1, AVG(CAST(cs_list_price AS DECIMAL(12,2))) AS agg2, AVG(CAST(cs_coupon_amt AS DECIMAL(12,2))) AS agg3, AVG(CAST(cs_sales_price AS DECIMAL(12,2))) AS agg4, AVG(CAST(cs_net_profit AS DECIMAL(12,2))) AS agg5, AVG(CAST(c_birth_year AS DECIMAL(12,2))) AS agg6, AVG(CAST(cd_dep_count AS DECIMAL(12,2))) AS agg7 FROM join_item GROUP BY ROLLUP (i_item_id, ca_country, ca_state, ca_county)",
        "interfaces": {"outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6", "agg7"], "consumes": ["join_item"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_item_id, ca_country, ca_state, ca_county, agg1, agg2, agg3, agg4, agg5, agg6, agg7 FROM rollup_agg ORDER BY ca_country, ca_state, ca_county, i_item_id LIMIT 100",
        "interfaces": {"outputs": ["i_item_id", "ca_country", "ca_state", "ca_county", "agg1", "agg2", "agg3", "agg4", "agg5", "agg6", "agg7"], "consumes": ["rollup_agg"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_cd1", "filtered_customer_chain", "fact_agg", "join_item", "rollup_agg", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_cd1 AS ({filtered_cd1}), filtered_customer_chain AS ({filtered_customer_chain}), fact_agg AS ({fact_agg}), join_item AS ({join_item}), rollup_agg AS ({rollup_agg}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Restructured the original star join into a CTE pipeline that isolates dimension filtering first, then joins to the fact table, and finally performs the ROLLUP aggregation after all joins are complete. This preserves exact row multiplicity for correct averages while enabling predicate pushdown into dimension scans.

**Expected speedup:** ~2-3x due to reduced hash table sizes from pre-filtered dimensions and better join ordering. The CTE chain prevents Cartesian explosion while maintaining semantic equivalence.