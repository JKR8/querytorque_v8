WITH filtered_sales_cte AS (SELECT ss_quantity, ss_ext_sales_price, ss_net_profit, CASE WHEN ss_quantity BETWEEN 1 AND 20 THEN 1 WHEN ss_quantity BETWEEN 21 AND 40 THEN 2 WHEN ss_quantity BETWEEN 41 AND 60 THEN 3 WHEN ss_quantity BETWEEN 61 AND 80 THEN 4 WHEN ss_quantity BETWEEN 81 AND 100 THEN 5 END AS bucket_id FROM store_sales WHERE ss_quantity BETWEEN 1 AND 100), bucket_aggregates_cte AS (SELECT bucket_id, COUNT(*) AS cnt, AVG(ss_ext_sales_price) AS avg_ext, AVG(ss_net_profit) AS avg_net FROM filtered_sales_cte GROUP BY bucket_id) SELECT bucket1, bucket2, bucket3, bucket4, bucket5 FROM reason CROSS JOIN (SELECT MAX(CASE WHEN bucket_id = 1 AND cnt > 2972190 THEN avg_ext WHEN bucket_id = 1 THEN avg_net END) AS bucket1, MAX(CASE WHEN bucket_id = 2 AND cnt > 4505785 THEN avg_ext WHEN bucket_id = 2 THEN avg_net END) AS bucket2, MAX(CASE WHEN bucket_id = 3 AND cnt > 1575726 THEN avg_ext WHEN bucket_id = 3 THEN avg_net END) AS bucket3, MAX(CASE WHEN bucket_id = 4 AND cnt > 3188917 THEN avg_ext WHEN bucket_id = 4 THEN avg_net END) AS bucket4, MAX(CASE WHEN bucket_id = 5 AND cnt > 3525216 THEN avg_ext WHEN bucket_id = 5 THEN avg_net END) AS bucket5 FROM bucket_aggregates_cte) AS buckets WHERE r_reason_sk = 1