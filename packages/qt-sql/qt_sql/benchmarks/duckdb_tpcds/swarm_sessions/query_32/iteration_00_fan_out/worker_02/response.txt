### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — CTE pipeline following target logical tree.
    ├── CTE filtered_dates  [+]  — Pre‑filter date_dim for 90‑day window.
    │   ├── SCAN date_dim
    │   └── FILTER d_date BETWEEN '1999-01-07' AND (CAST('1999-01-07' AS DATE) + INTERVAL 90 DAY)
    ├── CTE filtered_items  [+]  — Pre‑filter item for manufacturer 29.
    │   ├── SCAN item
    │   └── FILTER i_manufact_id = 29
    ├── CTE prefetched_sales  [+]  — Join catalog_sales with filtered dimensions.
    │   ├── SCAN catalog_sales
    │   ├── JOIN filtered_dates ON cs_sold_date_sk = d_date_sk
    │   └── JOIN filtered_items ON cs_item_sk = i_item_sk
    ├── CTE item_averages  [+]  — Compute per‑item average discount.
    │   ├── SCAN prefetched_sales
    │   └── HASH_GROUP_BY cs_item_sk → AVG(cs_ext_discount_amt)
    └── final_join_and_filter  [~]  — Join prefetched_sales with item_averages, filter, and aggregate.
        ├── SCAN prefetched_sales
        ├── JOIN item_averages ON cs_item_sk = cs_item_sk
        ├── FILTER cs_ext_discount_amt > 1.3 * item_avg_discount
        ├── AGGREGATE SUM(cs_ext_discount_amt)
        └── OUTPUT "excess discount amount"
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Pre‑filter date_dim and item into separate CTEs to build small hash tables before joining with fact table.", "applied_to": ["filtered_dates", "filtered_items"]},
    {"id": "R2", "type": "prefetch_fact_join", "description": "Chain dimension CTEs into prefetched_sales CTE that joins catalog_sales with both dimensions, reducing fact rows early.", "applied_to": ["prefetched_sales"]},
    {"id": "R3", "type": "correlated_subquery_to_cte", "description": "Materialize per‑item average discounts in a separate CTE (item_averages) to avoid recomputing for each outer row.", "applied_to": ["item_averages"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-07' AND (CAST('1999-01-07' AS DATE) + INTERVAL 90 DAY)",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_items": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk FROM item WHERE i_manufact_id = 29",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "prefetched_sales": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs.cs_item_sk, cs.cs_ext_discount_amt FROM catalog_sales cs INNER JOIN filtered_dates d ON cs.cs_sold_date_sk = d.d_date_sk INNER JOIN filtered_items i ON cs.cs_item_sk = i.i_item_sk",
        "interfaces": {"outputs": ["cs_item_sk", "cs_ext_discount_amt"], "consumes": ["filtered_dates", "filtered_items"]}
      },
      "item_averages": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs_item_sk, AVG(cs_ext_discount_amt) AS item_avg_discount FROM prefetched_sales GROUP BY cs_item_sk",
        "interfaces": {"outputs": ["cs_item_sk", "item_avg_discount"], "consumes": ["prefetched_sales"]}
      },
      "final_join_and_filter": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT SUM(ps.cs_ext_discount_amt) AS \"excess discount amount\" FROM prefetched_sales ps INNER JOIN item_averages ia ON ps.cs_item_sk = ia.cs_item_sk WHERE ps.cs_ext_discount_amt > 1.3 * ia.item_avg_discount LIMIT 100",
        "interfaces": {"outputs": ["excess discount amount"], "consumes": ["prefetched_sales", "item_averages"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_items", "prefetched_sales", "item_averages", "final_join_and_filter"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_items AS ({filtered_items}), prefetched_sales AS ({prefetched_sales}), item_averages AS ({item_averages}) {final_join_and_filter}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Isolated dimension filters into CTEs (`filtered_dates`, `filtered_items`), built a `prefetched_sales` CTE that joins the fact table with both dimension CTEs, then computed per‑item average discounts in `item_averages` CTE, and finally joined and filtered to produce the required sum. This pipeline ensures early reduction of fact rows and avoids scanning the large fact table multiple times.

**Expected speedup:** ~2.5x (due to early dimension filtering, reduced hash‑join sizes, and elimination of correlated subquery overhead).