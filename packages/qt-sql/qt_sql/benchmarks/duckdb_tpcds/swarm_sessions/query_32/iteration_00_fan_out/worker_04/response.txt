## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1K  — Replaced correlated subquery with window function; added CTEs for early filtering
    ├── [+] WITH filtered_dates (CTE)
    │   └── SCAN date_dim
    │       └── FILTER (d_date BETWEEN '1999-01-07' AND (CAST('1999-01-07' AS DATE) + INTERVAL 90 DAY))
    ├── [+] WITH filtered_items (CTE)
    │   └── SCAN item
    │       └── FILTER (i_manufact_id = 29)
    ├── [+] WITH sales_window_agg (CTE)
    │   └── JOIN (catalog_sales ⋈ filtered_dates ⋈ filtered_items)
    │       ├── JOIN (cs_sold_date_sk = d_date_sk)
    │       ├── JOIN (cs_item_sk = i_item_sk)
    │       └── WINDOW (AVG(cs_ext_discount_amt) PARTITION BY cs_item_sk) AS item_avg_discount
    ├── [+] WITH final_filter (CTE)
    │   └── SCAN sales_window_agg
    │       ├── FILTER (cs_ext_discount_amt > 1.3 * item_avg_discount)
    │       └── AGGREGATE (SUM(cs_ext_discount_amt) AS "excess discount amount")
    ├── [-] REMOVED correlated subquery
    └── OUTPUT ("excess discount amount")
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "deferred_window_aggregation", "description": "Replaced correlated subquery with window function computed after dimension filtering joins", "applied_to": ["sales_window_agg"]},
    {"id": "R2", "type": "single_pass_aggregation", "description": "Compute item average in same pass as fact table scan using window function", "applied_to": ["sales_window_agg"]},
    {"id": "R3", "type": "early_filter_pushdown", "description": "Extracted date and manufacturer filters into separate CTEs for predicate pushdown", "applied_to": ["filtered_dates", "filtered_items"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_dates": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '1999-01-07' AND (CAST('1999-01-07' AS DATE) + INTERVAL 90 DAY)",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_items": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_sk FROM item WHERE i_manufact_id = 29",
        "interfaces": {"outputs": ["i_item_sk"], "consumes": []}
      },
      "sales_window_agg": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cs.cs_ext_discount_amt, AVG(cs.cs_ext_discount_amt) OVER (PARTITION BY cs.cs_item_sk) AS item_avg_discount FROM catalog_sales cs INNER JOIN filtered_dates d ON cs.cs_sold_date_sk = d.d_date_sk INNER JOIN filtered_items i ON cs.cs_item_sk = i.i_item_sk",
        "interfaces": {"outputs": ["cs_ext_discount_amt", "item_avg_discount"], "consumes": ["filtered_dates", "filtered_items"]}
      },
      "final_filter": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT SUM(cs_ext_discount_amt) AS \"excess discount amount\" FROM sales_window_agg WHERE cs_ext_discount_amt > 1.3 * item_avg_discount",
        "interfaces": {"outputs": ["excess discount amount"], "consumes": ["sales_window_agg"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT \"excess discount amount\" FROM final_filter LIMIT 100",
        "interfaces": {"outputs": ["excess discount amount"], "consumes": ["final_filter"]}
      }
    },
    "reconstruction_order": ["filtered_dates", "filtered_items", "sales_window_agg", "final_filter", "main_query"],
    "assembly_template": "WITH filtered_dates AS ({filtered_dates}), filtered_items AS ({filtered_items}), sales_window_agg AS ({sales_window_agg}), final_filter AS ({final_filter}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Replaced correlated subquery with window function computed after joining filtered dimensions, enabling single scan of catalog_sales while maintaining exact correlation semantics. Early dimension filters reduce base table scans.

**Expected speedup**: ~2-3x from eliminating duplicate fact table scan and enabling better predicate pushdown.