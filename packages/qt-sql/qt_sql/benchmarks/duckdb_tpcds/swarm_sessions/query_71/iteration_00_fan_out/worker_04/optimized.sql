WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998), filtered_item AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1), web_channel_agg AS (SELECT i_brand_id, i_brand, ws_sold_time_sk AS time_sk, SUM(ws_ext_sales_price) AS ext_price FROM web_sales JOIN filtered_date ON ws_sold_date_sk = d_date_sk JOIN filtered_item ON ws_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, ws_sold_time_sk), catalog_channel_agg AS (SELECT i_brand_id, i_brand, cs_sold_time_sk AS time_sk, SUM(cs_ext_sales_price) AS ext_price FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = d_date_sk JOIN filtered_item ON cs_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, cs_sold_time_sk), store_channel_agg AS (SELECT i_brand_id, i_brand, ss_sold_time_sk AS time_sk, SUM(ss_ext_sales_price) AS ext_price FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN filtered_item ON ss_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, ss_sold_time_sk), union_all AS (SELECT i_brand_id, i_brand, time_sk, ext_price FROM web_channel_agg UNION ALL SELECT i_brand_id, i_brand, time_sk, ext_price FROM catalog_channel_agg UNION ALL SELECT i_brand_id, i_brand, time_sk, ext_price FROM store_channel_agg), join_time AS (SELECT i_brand_id, i_brand, t_hour, t_minute, ext_price FROM union_all JOIN time_dim ON time_sk = t_time_sk WHERE t_meal_time = 'breakfast' OR t_meal_time = 'dinner'), final_union AS (SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM join_time GROUP BY i_brand_id, i_brand, t_hour, t_minute) SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM final_union ORDER BY ext_price DESC, i_brand_id