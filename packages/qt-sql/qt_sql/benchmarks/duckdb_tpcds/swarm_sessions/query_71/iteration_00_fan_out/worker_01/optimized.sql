WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998), web_sales_with_date AS (SELECT ws_ext_sales_price AS ext_price, ws_item_sk AS sold_item_sk, ws_sold_time_sk AS time_sk FROM web_sales JOIN filtered_date ON ws_sold_date_sk = filtered_date.d_date_sk), catalog_sales_with_date AS (SELECT cs_ext_sales_price AS ext_price, cs_item_sk AS sold_item_sk, cs_sold_time_sk AS time_sk FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = filtered_date.d_date_sk), store_sales_with_date AS (SELECT ss_ext_sales_price AS ext_price, ss_item_sk AS sold_item_sk, ss_sold_time_sk AS time_sk FROM store_sales JOIN filtered_date ON ss_sold_date_sk = filtered_date.d_date_sk), union_all_channels AS (SELECT ext_price, sold_item_sk, time_sk FROM web_sales_with_date UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM catalog_sales_with_date UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM store_sales_with_date), join_item AS (SELECT union_all_channels.ext_price, item.i_brand_id, item.i_brand, union_all_channels.time_sk FROM union_all_channels JOIN item ON union_all_channels.sold_item_sk = item.i_item_sk WHERE item.i_manager_id = 1), join_time AS (SELECT join_item.ext_price, join_item.i_brand_id, join_item.i_brand, time_dim.t_hour, time_dim.t_minute FROM join_item JOIN time_dim ON join_item.time_sk = time_dim.t_time_sk WHERE time_dim.t_meal_time = 'breakfast' OR time_dim.t_meal_time = 'dinner'), aggregate AS (SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM join_time GROUP BY i_brand_id, i_brand, t_hour, t_minute), sort AS (SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM aggregate ORDER BY ext_price DESC, i_brand_id) SELECT brand_id, brand, t_hour, t_minute, ext_price FROM sort