WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998), web_fact_prejoin AS (SELECT ws_ext_sales_price AS ext_price, ws_item_sk AS sold_item_sk, ws_sold_time_sk AS time_sk FROM web_sales JOIN filtered_date ON ws_sold_date_sk = d_date_sk), catalog_fact_prejoin AS (SELECT cs_ext_sales_price AS ext_price, cs_item_sk AS sold_item_sk, cs_sold_time_sk AS time_sk FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = d_date_sk), store_fact_prejoin AS (SELECT ss_ext_sales_price AS ext_price, ss_item_sk AS sold_item_sk, ss_sold_time_sk AS time_sk FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk), union_all AS (SELECT ext_price, sold_item_sk, time_sk FROM web_fact_prejoin UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM catalog_fact_prejoin UNION ALL SELECT ext_price, sold_item_sk, time_sk FROM store_fact_prejoin), join_item_time AS (SELECT u.ext_price, i.i_brand_id, i.i_brand, t.t_hour, t.t_minute FROM union_all u JOIN item i ON u.sold_item_sk = i.i_item_sk AND i.i_manager_id = 1 JOIN time_dim t ON u.time_sk = t.t_time_sk AND (t.t_meal_time = 'breakfast' OR t.t_meal_time = 'dinner')), aggregate AS (SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM join_item_time GROUP BY i_brand_id, i_brand, t_hour, t_minute), sort AS (SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM aggregate ORDER BY ext_price DESC, i_brand_id) SELECT brand_id, brand, t_hour, t_minute, ext_price FROM sort