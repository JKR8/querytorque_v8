## Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [!]  Structural change — converted to CTE-based star join
    ├── [CTE] filtered_date  [+]
    │   └── SCAN (date_dim) WHERE d_moy=12 AND d_year=1998
    ├── [CTE] filtered_item  [+]
    │   └── SCAN (item) WHERE i_manager_id=1
    ├── [CTE] filtered_time  [+]
    │   └── SCAN (time_dim) WHERE t_meal_time = 'breakfast' OR t_meal_time = 'dinner'
    ├── [CTE] web_sales_joined  [+]
    │   ├── SCAN (web_sales)
    │   ├── JOIN filtered_date ON ws_sold_date_sk = d_date_sk
    │   ├── JOIN filtered_item ON ws_item_sk = i_item_sk
    │   └── JOIN filtered_time ON ws_sold_time_sk = t_time_sk
    ├── [CTE] catalog_sales_joined  [+]
    │   ├── SCAN (catalog_sales)
    │   ├── JOIN filtered_date ON cs_sold_date_sk = d_date_sk
    │   ├── JOIN filtered_item ON cs_item_sk = i_item_sk
    │   └── JOIN filtered_time ON cs_sold_time_sk = t_time_sk
    ├── [CTE] store_sales_joined  [+]
    │   ├── SCAN (store_sales)
    │   ├── JOIN filtered_date ON ss_sold_date_sk = d_date_sk
    │   ├── JOIN filtered_item ON ss_item_sk = i_item_sk
    │   └── JOIN filtered_time ON ss_sold_time_sk = t_time_sk
    ├── [CTE] union_all  [+]
    │   └── UNION ALL (web_sales_joined, catalog_sales_joined, store_sales_joined)
    ├── AGG (GROUP BY i_brand_id, i_brand, t_hour, t_minute) SUM(ext_price)  [~] moved to CTE
    ├── SORT (ext_price DESC, i_brand_id ASC)  [~] moved to main_query
    └── OUTPUT (brand_id, brand, t_hour, t_minute, ext_price)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Pre-filter dimension tables into CTEs before fact table joins", "applied_to": ["filtered_date", "filtered_item", "filtered_time"]},
    {"id": "R2", "type": "multi_dimension_prefetch", "description": "Join all three filtered dimension CTEs with each fact table independently", "applied_to": ["web_sales_joined", "catalog_sales_joined", "store_sales_joined"]},
    {"id": "R3", "type": "cte_modularization", "description": "Separate union and aggregation into distinct CTEs following target logical tree", "applied_to": ["union_all", "aggregate"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1",
        "interfaces": {"outputs": ["i_item_sk", "i_brand_id", "i_brand"], "consumes": []}
      },
      "filtered_time": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT t_time_sk, t_hour, t_minute FROM time_dim WHERE t_meal_time = 'breakfast' OR t_meal_time = 'dinner'",
        "interfaces": {"outputs": ["t_time_sk", "t_hour", "t_minute"], "consumes": []}
      },
      "web_sales_joined": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ws.ws_ext_sales_price AS ext_price, i.i_brand_id, i.i_brand, t.t_hour, t.t_minute FROM web_sales ws JOIN filtered_date d ON ws.ws_sold_date_sk = d.d_date_sk JOIN filtered_item i ON ws.ws_item_sk = i.i_item_sk JOIN filtered_time t ON ws.ws_sold_time_sk = t.t_time_sk",
        "interfaces": {"outputs": ["ext_price", "i_brand_id", "i_brand", "t_hour", "t_minute"], "consumes": ["filtered_date", "filtered_item", "filtered_time"]}
      },
      "catalog_sales_joined": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT cs.cs_ext_sales_price AS ext_price, i.i_brand_id, i.i_brand, t.t_hour, t.t_minute FROM catalog_sales cs JOIN filtered_date d ON cs.cs_sold_date_sk = d.d_date_sk JOIN filtered_item i ON cs.cs_item_sk = i.i_item_sk JOIN filtered_time t ON cs.cs_sold_time_sk = t.t_time_sk",
        "interfaces": {"outputs": ["ext_price", "i_brand_id", "i_brand", "t_hour", "t_minute"], "consumes": ["filtered_date", "filtered_item", "filtered_time"]}
      },
      "store_sales_joined": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss.ss_ext_sales_price AS ext_price, i.i_brand_id, i.i_brand, t.t_hour, t.t_minute FROM store_sales ss JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk JOIN filtered_item i ON ss.ss_item_sk = i.i_item_sk JOIN filtered_time t ON ss.ss_sold_time_sk = t.t_time_sk",
        "interfaces": {"outputs": ["ext_price", "i_brand_id", "i_brand", "t_hour", "t_minute"], "consumes": ["filtered_date", "filtered_item", "filtered_time"]}
      },
      "union_all": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ext_price, i_brand_id, i_brand, t_hour, t_minute FROM web_sales_joined UNION ALL SELECT ext_price, i_brand_id, i_brand, t_hour, t_minute FROM catalog_sales_joined UNION ALL SELECT ext_price, i_brand_id, i_brand, t_hour, t_minute FROM store_sales_joined",
        "interfaces": {"outputs": ["ext_price", "i_brand_id", "i_brand", "t_hour", "t_minute"], "consumes": ["web_sales_joined", "catalog_sales_joined", "store_sales_joined"]}
      },
      "aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM union_all GROUP BY i_brand_id, i_brand, t_hour, t_minute",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "t_hour", "t_minute", "ext_price"], "consumes": ["union_all"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM aggregate ORDER BY ext_price DESC, i_brand_id",
        "interfaces": {"outputs": ["brand_id", "brand", "t_hour", "t_minute", "ext_price"], "consumes": ["aggregate"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "filtered_time", "web_sales_joined", "catalog_sales_joined", "store_sales_joined", "union_all", "aggregate", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), filtered_time AS ({filtered_time}), web_sales_joined AS ({web_sales_joined}), catalog_sales_joined AS ({catalog_sales_joined}), store_sales_joined AS ({store_sales_joined}), union_all AS ({union_all}), aggregate AS ({aggregate}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Restructured to isolate dimension filtering into CTEs (date, item, time) before joining with fact tables, following star-join best practices. Each fact table joins independently with all three dimension CTEs, then results are unioned, aggregated, and sorted.

**Expected speedup**: ~1.9-2.7x based on similar TPC-DS patterns, due to reduced dimension table scans (31 rows vs full table for date, 1,847 vs full for item) and better join order control.