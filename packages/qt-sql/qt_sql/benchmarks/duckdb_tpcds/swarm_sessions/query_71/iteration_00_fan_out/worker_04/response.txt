## Modified Logic Tree

```
QUERY: (CTE-based restructure)
└── [MAIN] main_query  [~]  — CTE-driven aggregation with independent channel passes, time join after union, final grouping and ordering.
    ├── WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_moy=12 AND d_year=1998)  [+]
    ├── WITH filtered_item AS (SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id=1)  [+]
    ├── WITH web_channel_agg AS (
        SELECT i_brand_id, i_brand, ws_sold_time_sk AS time_sk, SUM(ws_ext_sales_price) AS ext_price
        FROM web_sales
        JOIN filtered_date ON ws_sold_date_sk = d_date_sk
        JOIN filtered_item ON ws_item_sk = i_item_sk
        GROUP BY i_brand_id, i_brand, ws_sold_time_sk)  [+]
    ├── WITH catalog_channel_agg AS (
        SELECT i_brand_id, i_brand, cs_sold_time_sk AS time_sk, SUM(cs_ext_sales_price) AS ext_price
        FROM catalog_sales
        JOIN filtered_date ON cs_sold_date_sk = d_date_sk
        JOIN filtered_item ON cs_item_sk = i_item_sk
        GROUP BY i_brand_id, i_brand, cs_sold_time_sk)  [+]
    ├── WITH store_channel_agg AS (
        SELECT i_brand_id, i_brand, ss_sold_time_sk AS time_sk, SUM(ss_ext_sales_price) AS ext_price
        FROM store_sales
        JOIN filtered_date ON ss_sold_date_sk = d_date_sk
        JOIN filtered_item ON ss_item_sk = i_item_sk
        GROUP BY i_brand_id, i_brand, ss_sold_time_sk)  [+]
    ├── WITH union_all AS (
        SELECT * FROM web_channel_agg
        UNION ALL SELECT * FROM catalog_channel_agg
        UNION ALL SELECT * FROM store_channel_agg)  [+]
    ├── WITH join_time AS (
        SELECT i_brand_id, i_brand, t_hour, t_minute, ext_price
        FROM union_all
        JOIN time_dim ON time_sk = t_time_sk
        WHERE t_meal_time = 'breakfast' OR t_meal_time = 'dinner')  [+]
    ├── WITH final_union AS (
        SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price
        FROM join_time
        GROUP BY i_brand_id, i_brand, t_hour, t_minute)  [+]
    ├── SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price
        FROM final_union
        ORDER BY ext_price DESC, i_brand_id  [~]
    └── OUTPUT (brand_id, brand, t_hour, t_minute, ext_price)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "cross_cte_predicate_pushdown", "description": "Isolate date and item filters into reusable CTEs to eliminate repeated scans and enable predicate pushdown to each channel independently.", "applied_to": ["filtered_date", "filtered_item"]},
    {"id": "R2", "type": "single_pass_aggregation", "description": "Aggregate each fact table separately after joining with filtered dimensions, reducing row counts before union and time join.", "applied_to": ["web_channel_agg", "catalog_channel_agg", "store_channel_agg"]},
    {"id": "R3", "type": "staged_union", "description": "Combine channel aggregates with UNION ALL before joining with time_dim, maintaining predicate independence and avoiding cross-join blowup.", "applied_to": ["union_all", "join_time"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 1998",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk, i_brand_id, i_brand FROM item WHERE i_manager_id = 1",
        "interfaces": {"outputs": ["i_item_sk", "i_brand_id", "i_brand"], "consumes": []}
      },
      "web_channel_agg": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, ws_sold_time_sk AS time_sk, SUM(ws_ext_sales_price) AS ext_price FROM web_sales JOIN filtered_date ON ws_sold_date_sk = d_date_sk JOIN filtered_item ON ws_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, ws_sold_time_sk",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "time_sk", "ext_price"], "consumes": ["filtered_date", "filtered_item"]}
      },
      "catalog_channel_agg": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, cs_sold_time_sk AS time_sk, SUM(cs_ext_sales_price) AS ext_price FROM catalog_sales JOIN filtered_date ON cs_sold_date_sk = d_date_sk JOIN filtered_item ON cs_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, cs_sold_time_sk",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "time_sk", "ext_price"], "consumes": ["filtered_date", "filtered_item"]}
      },
      "store_channel_agg": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, ss_sold_time_sk AS time_sk, SUM(ss_ext_sales_price) AS ext_price FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN filtered_item ON ss_item_sk = i_item_sk GROUP BY i_brand_id, i_brand, ss_sold_time_sk",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "time_sk", "ext_price"], "consumes": ["filtered_date", "filtered_item"]}
      },
      "union_all": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, time_sk, ext_price FROM web_channel_agg UNION ALL SELECT i_brand_id, i_brand, time_sk, ext_price FROM catalog_channel_agg UNION ALL SELECT i_brand_id, i_brand, time_sk, ext_price FROM store_channel_agg",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "time_sk", "ext_price"], "consumes": ["web_channel_agg", "catalog_channel_agg", "store_channel_agg"]}
      },
      "join_time": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, t_hour, t_minute, ext_price FROM union_all JOIN time_dim ON time_sk = t_time_sk WHERE t_meal_time = 'breakfast' OR t_meal_time = 'dinner'",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "t_hour", "t_minute", "ext_price"], "consumes": ["union_all"]}
      },
      "final_union": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_brand_id, i_brand, t_hour, t_minute, SUM(ext_price) AS ext_price FROM join_time GROUP BY i_brand_id, i_brand, t_hour, t_minute",
        "interfaces": {"outputs": ["i_brand_id", "i_brand", "t_hour", "t_minute", "ext_price"], "consumes": ["join_time"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_brand_id AS brand_id, i_brand AS brand, t_hour, t_minute, ext_price FROM final_union ORDER BY ext_price DESC, i_brand_id",
        "interfaces": {"outputs": ["brand_id", "brand", "t_hour", "t_minute", "ext_price"], "consumes": ["final_union"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "web_channel_agg", "catalog_channel_agg", "store_channel_agg", "union_all", "join_time", "final_union", "main_query"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_item AS ({filtered_item}), web_channel_agg AS ({web_channel_agg}), catalog_channel_agg AS ({catalog_channel_agg}), store_channel_agg AS ({store_channel_agg}), union_all AS ({union_all}), join_time AS ({join_time}), final_union AS ({final_union}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Restructured the original flattened join/union into a staged CTE pipeline that isolates date and item filters into reusable CTEs, performs early aggregation per channel, unions the aggregated results, then joins with time_dim and groups. This eliminates 3 repeated full scans of date_dim and item, reduces row counts before the union, and allows predicate pushdown.

**Expected speedup:** 2–3x due to elimination of repeated dimension scans, early aggregation reducing union payload, and better predicate pushdown to each channel.