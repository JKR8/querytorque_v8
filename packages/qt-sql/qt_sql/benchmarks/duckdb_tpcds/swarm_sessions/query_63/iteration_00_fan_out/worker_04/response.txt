### Part 1: Modified Logic Tree

```
QUERY:
└── [MAIN] main_query [~]
    ├── [=] filtered_date
    ├── [=] filtered_item
    ├── [=] filtered_store
    ├── [-] dimension_keys (removed – Cartesian product risk)
    ├── [+] filtered_fact (joins fact with three dimension CTEs)
    ├── [=] aggregated_sales
    ├── [=] windowed
    ├── [=] filtered
    ├── [=] ordered
    └── [=] limited
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "prefetch_fact_join", "description": "Replace Cartesian product of dimension CTEs with direct join of fact table to filtered dimension CTEs", "applied_to": ["filtered_fact"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["d_date_sk", "d_moy"], "consumes": []}
      },
      "filtered_item": {
        "type": "cte",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["i_item_sk", "i_manager_id"], "consumes": []}
      },
      "filtered_store": {
        "type": "cte",
        "change": "unchanged",
        "sql": "",
        "interfaces": {"outputs": ["s_store_sk"], "consumes": []}
      },
      "filtered_fact": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i.i_manager_id, d.d_moy, ss.ss_sales_price FROM store_sales ss INNER JOIN filtered_date d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN filtered_item i ON ss.ss_item_sk = i.i_item_sk INNER JOIN filtered_store s ON ss.ss_store_sk = s.s_store_sk",
        "interfaces": {"outputs": ["i_manager_id", "d_moy", "ss_sales_price"], "consumes": ["filtered_date", "filtered_item", "filtered_store"]}
      },
      "aggregated_sales": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_manager_id, d_moy, SUM(ss_sales_price) AS sum_sales FROM filtered_fact GROUP BY i_manager_id, d_moy",
        "interfaces": {"outputs": ["i_manager_id", "d_moy", "sum_sales"], "consumes": ["filtered_fact"]}
      },
      "windowed": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_manager_id, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_manager_id) AS avg_monthly_sales, d_moy FROM aggregated_sales",
        "interfaces": {"outputs": ["i_manager_id", "sum_sales", "avg_monthly_sales", "d_moy"], "consumes": ["aggregated_sales"]}
      },
      "filtered": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_manager_id, sum_sales, avg_monthly_sales FROM windowed WHERE CASE WHEN avg_monthly_sales > 0 THEN abs(sum_sales - avg_monthly_sales) / avg_monthly_sales ELSE NULL END > 0.1",
        "interfaces": {"outputs": ["i_manager_id", "sum_sales", "avg_monthly_sales"], "consumes": ["windowed"]}
      },
      "ordered": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_manager_id, sum_sales, avg_monthly_sales FROM filtered ORDER BY i_manager_id ASC, avg_monthly_sales ASC, sum_sales ASC",
        "interfaces": {"outputs": ["i_manager_id", "sum_sales", "avg_monthly_sales"], "consumes": ["filtered"]}
      },
      "limited": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_manager_id, sum_sales, avg_monthly_sales FROM ordered LIMIT 100",
        "interfaces": {"outputs": ["i_manager_id", "sum_sales", "avg_monthly_sales"], "consumes": ["ordered"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT i_manager_id, sum_sales, avg_monthly_sales FROM limited",
        "interfaces": {"outputs": ["i_manager_id", "sum_sales", "avg_monthly_sales"], "consumes": ["limited"]}
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_item", "filtered_store", "filtered_fact", "aggregated_sales", "windowed", "filtered", "ordered", "limited", "main_query"],
    "assembly_template": "WITH filtered_date AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_month_seq IN (1181,1182,1183,1184,1185,1186,1187,1188,1189,1190,1191,1192)), filtered_item AS (SELECT i_item_sk, i_manager_id FROM item WHERE ((i_category IN ('Books','Children','Electronics') AND i_class IN ('personal','portable','reference','self-help') AND i_brand IN ('scholaramalgamalg #14','scholaramalgamalg #7','exportiunivamalg #9','scholaramalgamalg #9')) OR (i_category IN ('Women','Music','Men') AND i_class IN ('accessories','classical','fragrances','pants') AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1','importoamalg #1')))), filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_sk <= 100), filtered_fact AS ({filtered_fact}), aggregated_sales AS ({aggregated_sales}), windowed AS ({windowed}), filtered AS ({filtered}), ordered AS ({ordered}), limited AS ({limited}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Replaced the Cartesian product dimension_keys node with a direct join between store_sales and the three filtered dimension CTEs, preserving semantic equivalence while eliminating a 193M-row intermediate explosion.

Expected speedup: ~2-4x by avoiding massive intermediate Cartesian product and pushing dimension filters directly into the fact table join.