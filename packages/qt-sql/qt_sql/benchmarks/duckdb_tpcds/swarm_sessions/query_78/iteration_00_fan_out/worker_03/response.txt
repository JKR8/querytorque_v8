## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] ws_2000  [+]  — Year-filtered web sales aggregations (2000 only)
│   ├── SCAN (web_sales, web_returns (left join), date_dim (join))
│   ├── FILTER (wr_order_number IS NULL AND d_year = 2000)
│   ├── AGG (GROUP BY d_year, ws_item_sk, ws_bill_customer_sk)
│   └── OUTPUT (ws_sold_year, ws_item_sk, ws_customer_sk, ws_qty, ws_wc, ws_sp)
├── [CTE] cs_2000  [+]  — Year-filtered catalog sales aggregations (2000 only)
│   ├── SCAN (catalog_sales, catalog_returns (left join), date_dim (join))
│   ├── FILTER (cr_order_number IS NULL AND d_year = 2000)
│   ├── AGG (GROUP BY d_year, cs_item_sk, cs_bill_customer_sk)
│   └── OUTPUT (cs_sold_year, cs_item_sk, cs_customer_sk, cs_qty, cs_wc, cs_sp)
├── [CTE] ss_2000  [+]  — Year-filtered store sales aggregations (2000 only)
│   ├── SCAN (store_sales, store_returns (left join), date_dim (join))
│   ├── FILTER (sr_ticket_number IS NULL AND d_year = 2000)
│   ├── AGG (GROUP BY d_year, ss_item_sk, ss_customer_sk)
│   └── OUTPUT (ss_sold_year, ss_item_sk, ss_customer_sk, ss_qty, ss_wc, ss_sp)
├── [-] cs  — Removed generic catalog sales CTE
├── [-] ss  — Removed generic store sales CTE
├── [-] ws  — Removed generic web sales CTE
└── [~] main_query  — Modified to use year-specific CTEs; removed year filter
    ├── SCAN (ss_2000, ws_2000 (left join), cs_2000 (left join))
    ├── FILTER ((COALESCE(ws_qty,0) > 0 OR COALESCE(cs_qty,0) > 0))
    ├── AGG (GROUP BY)
    ├── SORT (ss_item_sk ASC, ss_qty DESC, ss_wc DESC, ss_sp DESC, other_chan_qty ASC, other_chan_wholesale_cost ASC, other_chan_sales_price ASC, ratio ASC)
    └── OUTPUT (ss_item_sk, ratio, store_qty, store_wholesale_cost, store_sales_price, other_chan_qty, other_chan_wholesale_cost, other_chan_sales_price)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb_v1.4.3",
  "rewrite_rules": [
    {"id": "R1", "type": "union_cte_split", "description": "Split generic year-agnostic CTEs into year-specific CTEs with embedded filter", "applied_to": ["ws_2000", "cs_2000", "ss_2000"]},
    {"id": "R2", "type": "early_filter", "description": "Push year=2000 filter into CTE definitions to reduce fact table scans", "applied_to": ["ws_2000", "cs_2000", "ss_2000"]},
    {"id": "R3", "type": "pushdown", "description": "Consolidate year filter from main query into specialized CTEs", "applied_to": ["main_query"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "ws_2000": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "cs_2000": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "ss_2000": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT\n  ss_item_sk,\n  ROUND(ss_qty/(COALESCE(ws_qty,0)+COALESCE(cs_qty,0)),2) AS ratio,\n  ss_qty AS store_qty,\n  ss_wc AS store_wholesale_cost,\n  ss_sp AS store_sales_price,\n  COALESCE(ws_qty,0)+COALESCE(cs_qty,0) AS other_chan_qty,\n  COALESCE(ws_wc,0)+COALESCE(cs_wc,0) AS other_chan_wholesale_cost,\n  COALESCE(ws_sp,0)+COALESCE(cs_sp,0) AS other_chan_sales_price\nFROM ss_2000\nLEFT JOIN ws_2000 ON (ws_sold_year = ss_sold_year AND ws_item_sk = ss_item_sk AND ws_customer_sk = ss_customer_sk)\nLEFT JOIN cs_2000 ON (cs_sold_year = ss_sold_year AND cs_item_sk = ss_item_sk AND cs_customer_sk = ss_customer_sk)\nWHERE (COALESCE(ws_qty,0) > 0 OR COALESCE(cs_qty,0) > 0)\nORDER BY\n  ss_item_sk ASC,\n  ss_qty DESC,\n  ss_wc DESC,\n  ss_sp DESC,\n  (COALESCE(ws_qty,0)+COALESCE(cs_qty,0)) ASC,\n  (COALESCE(ws_wc,0)+COALESCE(cs_wc,0)) ASC,\n  (COALESCE(ws_sp,0)+COALESCE(cs_sp,0)) ASC,\n  ROUND(ss_qty/(COALESCE(ws_qty,0)+COALESCE(cs_qty,0)),2) ASC\nLIMIT 100",
        "interfaces": {
          "outputs": ["ss_item_sk", "ratio", "store_qty", "store_wholesale_cost", "store_sales_price", "other_chan_qty", "other_chan_wholesale_cost", "other_chan_sales_price"],
          "consumes": ["ss_2000", "ws_2000", "cs_2000"]
        }
      }
    },
    "reconstruction_order": ["ws_2000", "cs_2000", "ss_2000", "main_query"],
    "assembly_template": "WITH\n  ws_2000 AS (SELECT d_year AS ws_sold_year, ws_item_sk, ws_bill_customer_sk AS ws_customer_sk, SUM(ws_quantity) AS ws_qty, SUM(ws_wholesale_cost) AS ws_wc, SUM(ws_sales_price) AS ws_sp FROM web_sales LEFT JOIN web_returns ON wr_order_number = ws_order_number AND ws_item_sk = wr_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_year = 2000) AS date_2000 ON ws_sold_date_sk = date_2000.d_date_sk WHERE wr_order_number IS NULL GROUP BY d_year, ws_item_sk, ws_bill_customer_sk),\n  cs_2000 AS (SELECT d_year AS cs_sold_year, cs_item_sk, cs_bill_customer_sk AS cs_customer_sk, SUM(cs_quantity) AS cs_qty, SUM(cs_wholesale_cost) AS cs_wc, SUM(cs_sales_price) AS cs_sp FROM catalog_sales LEFT JOIN catalog_returns ON cr_order_number = cs_order_number AND cs_item_sk = cr_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_year = 2000) AS date_2000 ON cs_sold_date_sk = date_2000.d_date_sk WHERE cr_order_number IS NULL GROUP BY d_year, cs_item_sk, cs_bill_customer_sk),\n  ss_2000 AS (SELECT d_year AS ss_sold_year, ss_item_sk, ss_customer_sk, SUM(ss_quantity) AS ss_qty, SUM(ss_wholesale_cost) AS ss_wc, SUM(ss_sales_price) AS ss_sp FROM store_sales LEFT JOIN store_returns ON sr_ticket_number = ss_ticket_number AND ss_item_sk = sr_item_sk JOIN (SELECT d_date_sk FROM date_dim WHERE d_year = 2000) AS date_2000 ON ss_sold_date_sk = date_2000.d_date_sk WHERE sr_ticket_number IS NULL GROUP BY d_year, ss_item_sk, ss_customer_sk)\n{main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Specialized generic year-agnostic CTEs into year-specific CTEs with embedded `d_year = 2000` filter, eliminating redundant scans of unfiltered date_dim and large fact tables. The expected speedup comes from reducing fact table scans from full-table to year-filtered partitions only.

Expected speedup: 2.5-3x (eliminates 3 full fact table scans, reduces date_dim scans from 3 to 1 shared filtered instance per channel).