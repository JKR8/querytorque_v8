{
  "worker_id": 2,
  "strategy": "scan_consolidation_pivot",
  "examples_used": [
    "single_pass_aggregation",
    "channel_bitmap_aggregation"
  ],
  "optimized_sql": "WITH date_2000 AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year = 2000), sales_combined AS (SELECT 'store' AS channel, d_year AS sold_year, ss_item_sk AS item_sk, ss_customer_sk AS customer_sk, SUM(ss_quantity) AS qty, SUM(ss_wholesale_cost) AS wc, SUM(ss_sales_price) AS sp FROM store_sales LEFT JOIN store_returns ON sr_ticket_number = ss_ticket_number AND ss_item_sk = sr_item_sk JOIN date_2000 ON ss_sold_date_sk = d_date_sk WHERE sr_ticket_number IS NULL GROUP BY d_year, ss_item_sk, ss_customer_sk UNION ALL SELECT 'web' AS channel, d_year AS sold_year, ws_item_sk AS item_sk, ws_bill_customer_sk AS customer_sk, SUM(ws_quantity) AS qty, SUM(ws_wholesale_cost) AS wc, SUM(ws_sales_price) AS sp FROM web_sales LEFT JOIN web_returns ON wr_order_number = ws_order_number AND ws_item_sk = wr_item_sk JOIN date_2000 ON ws_sold_date_sk = d_date_sk WHERE wr_order_number IS NULL GROUP BY d_year, ws_item_sk, ws_bill_customer_sk UNION ALL SELECT 'catalog' AS channel, d_year AS sold_year, cs_item_sk AS item_sk, cs_bill_customer_sk AS customer_sk, SUM(cs_quantity) AS qty, SUM(cs_wholesale_cost) AS wc, SUM(cs_sales_price) AS sp FROM catalog_sales LEFT JOIN catalog_returns ON cr_order_number = cs_order_number AND cs_item_sk = cr_item_sk JOIN date_2000 ON cs_sold_date_sk = d_date_sk WHERE cr_order_number IS NULL GROUP BY d_year, cs_item_sk, cs_bill_customer_sk) SELECT s.item_sk AS ss_item_sk, ROUND(s.qty / (COALESCE(w.qty, 0) + COALESCE(c.qty, 0)), 2) AS ratio, s.qty AS store_qty, s.wc AS store_wholesale_cost, s.sp AS store_sales_price, COALESCE(w.qty, 0) + COALESCE(c.qty, 0) AS other_chan_qty, COALESCE(w.wc, 0) + COALESCE(c.wc, 0) AS other_chan_wholesale_cost, COALESCE(w.sp, 0) + COALESCE(c.sp, 0) AS other_chan_sales_price FROM (SELECT * FROM sales_combined WHERE channel = 'store') s LEFT JOIN (SELECT * FROM sales_combined WHERE channel = 'web') w ON w.sold_year = s.sold_year AND w.item_sk = s.item_sk AND w.customer_sk = s.customer_sk LEFT JOIN (SELECT * FROM sales_combined WHERE channel = 'catalog') c ON c.sold_year = s.sold_year AND c.item_sk = s.item_sk AND c.customer_sk = s.customer_sk WHERE (COALESCE(w.qty, 0) > 0 OR COALESCE(c.qty, 0) > 0) ORDER BY s.item_sk ASC, s.qty DESC, s.wc DESC, s.sp DESC, (COALESCE(w.qty, 0) + COALESCE(c.qty, 0)) ASC, (COALESCE(w.wc, 0) + COALESCE(c.wc, 0)) ASC, (COALESCE(w.sp, 0) + COALESCE(c.sp, 0)) ASC, ROUND(s.qty / (COALESCE(w.qty, 0) + COALESCE(c.qty, 0)), 2) ASC LIMIT 100",
  "speedup": 1.0922749185952079,
  "status": "IMPROVED",
  "transforms": [
    "date_cte_isolate"
  ],
  "hint": "- single_pass_aggregation: consolidate multiple fact scans into UNION ALL with s",
  "error_message": null,
  "error_messages": [],
  "error_category": null
}