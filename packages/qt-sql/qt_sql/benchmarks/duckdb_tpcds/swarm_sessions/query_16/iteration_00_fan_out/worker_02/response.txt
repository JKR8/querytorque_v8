## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [=]  Cost: 100%  Rows: 1
    ├── [CTE] no_returns_filter  [+]  — Filter out orders with returns
    │   ├── [CTE] combined_scan  [+]  — Scan catalog_sales with dimension joins and multi-warehouse filter
    │   │   ├── [CTE] date_cte  [+]  — Date dimension filter for April-June 2002
    │   │   │   └── SCAN date_dim [=]
    │   │   ├── [CTE] addr_cte  [+]  — Customer address filter for WV state
    │   │   │   └── SCAN customer_address [=]
    │   │   ├── [CTE] call_cte  [+]  — Call center filter for specific counties
    │   │   │   └── SCAN call_center [=]
    │   │   └── JOIN catalog_sales WITH 3 dimension CTEs [~] (changed from original implicit joins to explicit INNER JOIN chain)
    │   └── FILTER (NOT EXISTS catalog_returns) [=]
    └── AGGREGATE [=]
```

**Changes:**
- Added explicit CTE structure per Target Logical Tree
- Changed original implicit joins to explicit INNER JOIN chain with CTEs
- Preserved original EXISTS and NOT EXISTS subqueries as-is
- Maintained same logical filtering sequence

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "cte_structure", "description": "Decomposed into dimension CTEs followed by fact scan with filters", "applied_to": ["date_cte", "addr_cte", "call_cte", "combined_scan", "no_returns_filter"]},
    {"id": "R2", "type": "explicit_joins", "description": "Converted implicit joins to explicit INNER JOIN syntax with CTEs", "applied_to": ["combined_scan"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_date BETWEEN '2002-4-01' AND (CAST('2002-4-01' AS DATE) + INTERVAL 60 DAY)",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "addr_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ca_address_sk FROM customer_address WHERE ca_state = 'WV'",
        "interfaces": {"outputs": ["ca_address_sk"], "consumes": []}
      },
      "call_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cc_call_center_sk FROM call_center WHERE cc_county IN ('Ziebach County','Luce County','Richland County','Daviess County','Barrow County')",
        "interfaces": {"outputs": ["cc_call_center_sk"], "consumes": []}
      },
      "combined_scan": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs1.cs_order_number, cs1.cs_ext_ship_cost, cs1.cs_net_profit FROM catalog_sales cs1 INNER JOIN date_cte ON cs1.cs_ship_date_sk = date_cte.d_date_sk INNER JOIN addr_cte ON cs1.cs_ship_addr_sk = addr_cte.ca_address_sk INNER JOIN call_cte ON cs1.cs_call_center_sk = call_cte.cc_call_center_sk WHERE EXISTS (SELECT 1 FROM catalog_sales cs2 WHERE cs1.cs_order_number = cs2.cs_order_number AND cs1.cs_warehouse_sk <> cs2.cs_warehouse_sk)",
        "interfaces": {"outputs": ["cs_order_number", "cs_ext_ship_cost", "cs_net_profit"], "consumes": ["date_cte", "addr_cte", "call_cte"]}
      },
      "no_returns_filter": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT cs_order_number, cs_ext_ship_cost, cs_net_profit FROM combined_scan cs1 WHERE NOT EXISTS (SELECT 1 FROM catalog_returns cr1 WHERE cs1.cs_order_number = cr1.cr_order_number)",
        "interfaces": {"outputs": ["cs_order_number", "cs_ext_ship_cost", "cs_net_profit"], "consumes": ["combined_scan"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT COUNT(DISTINCT cs_order_number) AS \"order count\", SUM(cs_ext_ship_cost) AS \"total shipping cost\", SUM(cs_net_profit) AS \"total net profit\" FROM no_returns_filter ORDER BY COUNT(DISTINCT cs_order_number) LIMIT 100",
        "interfaces": {"outputs": ["order count", "total shipping cost", "total net profit"], "consumes": ["no_returns_filter"]}
      }
    },
    "reconstruction_order": ["date_cte", "addr_cte", "call_cte", "combined_scan", "no_returns_filter", "main_query"],
    "assembly_template": "WITH date_cte AS ({date_cte}), addr_cte AS ({addr_cte}), call_cte AS ({call_cte}), combined_scan AS ({combined_scan}), no_returns_filter AS ({no_returns_filter}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes:** Applied the exact CTE structure from the Target Logical Tree, converting implicit joins to explicit INNER JOINs while preserving all original filters, EXISTS conditions, and aggregation logic.

**Expected speedup:** ~2x (dimension filters pushed into single scan with CTE isolation prevents Cartesian explosion while allowing predicate pushdown)