### Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  Cost: 100%  Rows: ~1  — Use CTE to filter once, then compute six bucket aggregates in parallel
    ├── [+] WITH filtered_sales AS (SELECT ss_quantity, ss_list_price, ss_coupon_amt, ss_wholesale_cost FROM store_sales WHERE ss_quantity BETWEEN 0 AND 30)
    ├── [~] B1_subquery FROM filtered_sales (was: store_sales)
    ├── [~] B2_subquery FROM filtered_sales (was: store_sales)
    ├── [~] B3_subquery FROM filtered_sales (was: store_sales)
    ├── [~] B4_subquery FROM filtered_sales (was: store_sales)
    ├── [~] B5_subquery FROM filtered_sales (was: store_sales)
    ├── [~] B6_subquery FROM filtered_sales (was: store_sales)
    └── OUTPUT (*)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb_1.4.3",
  "rewrite_rules": [
    {"id": "R1", "type": "materialize_cte", "description": "Extract common WHERE ss_quantity BETWEEN 0 AND 30 into CTE scanned six times", "applied_to": ["filtered_sales", "B1_subquery", "B2_subquery", "B3_subquery", "B4_subquery", "B5_subquery", "B6_subquery"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_sales": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_quantity, ss_list_price, ss_coupon_amt, ss_wholesale_cost FROM store_sales WHERE ss_quantity BETWEEN 0 AND 30",
        "interfaces": {"outputs": ["ss_quantity", "ss_list_price", "ss_coupon_amt", "ss_wholesale_cost"], "consumes": []}
      },
      "B1_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B1_LP, COUNT(ss_list_price) AS B1_CNT, COUNT(DISTINCT ss_list_price) AS B1_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 0 AND 5 AND (ss_list_price BETWEEN 131 AND 141 OR ss_coupon_amt BETWEEN 16798 AND 17798 OR ss_wholesale_cost BETWEEN 25 AND 45)",
        "interfaces": {"outputs": ["B1_LP", "B1_CNT", "B1_CNTD"], "consumes": ["filtered_sales"]}
      },
      "B2_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B2_LP, COUNT(ss_list_price) AS B2_CNT, COUNT(DISTINCT ss_list_price) AS B2_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 6 AND 10 AND (ss_list_price BETWEEN 145 AND 155 OR ss_coupon_amt BETWEEN 14792 AND 15792 OR ss_wholesale_cost BETWEEN 46 AND 66)",
        "interfaces": {"outputs": ["B2_LP", "B2_CNT", "B2_CNTD"], "consumes": ["filtered_sales"]}
      },
      "B3_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B3_LP, COUNT(ss_list_price) AS B3_CNT, COUNT(DISTINCT ss_list_price) AS B3_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 11 AND 15 AND (ss_list_price BETWEEN 150 AND 160 OR ss_coupon_amt BETWEEN 6600 AND 7600 OR ss_wholesale_cost BETWEEN 9 AND 29)",
        "interfaces": {"outputs": ["B3_LP", "B3_CNT", "B3_CNTD"], "consumes": ["filtered_sales"]}
      },
      "B4_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B4_LP, COUNT(ss_list_price) AS B4_CNT, COUNT(DISTINCT ss_list_price) AS B4_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 16 AND 20 AND (ss_list_price BETWEEN 91 AND 101 OR ss_coupon_amt BETWEEN 13493 AND 14493 OR ss_wholesale_cost BETWEEN 36 AND 56)",
        "interfaces": {"outputs": ["B4_LP", "B4_CNT", "B4_CNTD"], "consumes": ["filtered_sales"]}
      },
      "B5_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B5_LP, COUNT(ss_list_price) AS B5_CNT, COUNT(DISTINCT ss_list_price) AS B5_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 21 AND 25 AND (ss_list_price BETWEEN 0 AND 10 OR ss_coupon_amt BETWEEN 7629 AND 8629 OR ss_wholesale_cost BETWEEN 6 AND 26)",
        "interfaces": {"outputs": ["B5_LP", "B5_CNT", "B5_CNTD"], "consumes": ["filtered_sales"]}
      },
      "B6_subquery": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT AVG(ss_list_price) AS B6_LP, COUNT(ss_list_price) AS B6_CNT, COUNT(DISTINCT ss_list_price) AS B6_CNTD FROM filtered_sales WHERE ss_quantity BETWEEN 26 AND 30 AND (ss_list_price BETWEEN 89 AND 99 OR ss_coupon_amt BETWEEN 15257 AND 16257 OR ss_wholesale_cost BETWEEN 31 AND 51)",
        "interfaces": {"outputs": ["B6_LP", "B6_CNT", "B6_CNTD"], "consumes": ["filtered_sales"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT * FROM B1_subquery, B2_subquery, B3_subquery, B4_subquery, B5_subquery, B6_subquery LIMIT 100",
        "interfaces": {"outputs": ["*"], "consumes": ["B1_subquery", "B2_subquery", "B3_subquery", "B4_subquery", "B5_subquery", "B6_subquery"]}
      }
    },
    "reconstruction_order": ["filtered_sales", "B1_subquery", "B2_subquery", "B3_subquery", "B4_subquery", "B5_subquery", "B6_subquery", "main_query"],
    "assembly_template": "WITH filtered_sales AS ({filtered_sales}), B1_subquery AS ({B1_subquery}), B2_subquery AS ({B2_subquery}), B3_subquery AS ({B3_subquery}), B4_subquery AS ({B4_subquery}), B5_subquery AS ({B5_subquery}), B6_subquery AS ({B6_subquery}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

Changes: Materialize filtered store_sales rows (quantity 0–30) into a CTE, then compute each bucket's aggregates from that CTE instead of six full scans. DuckDB may materialize the CTE when referenced six times, reducing I/O at memory cost.

Expected speedup: ~1.5-2x (eliminates 5 redundant scans of store_sales table).