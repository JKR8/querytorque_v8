## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query  [~]  — Cross-join six independent bucket aggregates, each built via UNION-ALL + deduplication
    ├── [CTE] B1_union  [+]
    │   └── UNION-ALL of three column-specific scans (ss_list_price, ss_coupon_amt, ss_wholesale_cost) with ss_quantity 0-5
    ├── [CTE] B1_dedup  [+]
    │   └── GROUP BY ss_list_price to deduplicate rows appearing in multiple UNION branches
    ├── [CTE] B1_aggregate  [+]
    │   └── Aggregate deduplicated rows → B1_LP, B1_CNT, B1_CNTD
    ├── [CTE] B2_union  [+]
    │   └── Same pattern for ss_quantity 6-10 with bucket‑2 constants
    ├── [CTE] B2_dedup  [+]
    │   └── Deduplicate B2_union
    ├── [CTE] B2_aggregate  [+]
    │   └── Aggregate → B2_LP, B2_CNT, B2_CNTD
    ├── [CTE] B3_union  [+]
    │   └── ss_quantity 11-15, bucket‑3 constants
    ├── [CTE] B3_dedup  [+]
    │   └── Deduplicate
    ├── [CTE] B3_aggregate  [+]
    │   └── Aggregate → B3_LP, B3_CNT, B3_CNTD
    ├── [CTE] B4_union  [+]
    │   └── ss_quantity 16-20, bucket‑4 constants
    ├── [CTE] B4_dedup  [+]
    │   └── Deduplicate
    ├── [CTE] B4_aggregate  [+]
    │   └── Aggregate → B4_LP, B4_CNT, B4_CNTD
    ├── [CTE] B5_union  [+]
    │   └── ss_quantity 21-25, bucket‑5 constants
    ├── [CTE] B5_dedup  [+]
    │   └── Deduplicate
    ├── [CTE] B5_aggregate  [+]
    │   └── Aggregate → B5_LP, B5_CNT, B5_CNTD
    ├── [CTE] B6_union  [+]
    │   └── ss_quantity 26-30, bucket‑6 constants
    ├── [CTE] B6_dedup  [+]
    │   └── Deduplicate
    ├── [CTE] B6_aggregate  [+]
    │   └── Aggregate → B6_LP, B6_CNT, B6_CNTD
    └── [CROSS JOIN]  [~]  — Cross‑join the six 1‑row aggregates into a single row
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "or_to_union", "description": "Split each bucket's three‑column OR into UNION ALL branches, then deduplicate per bucket to preserve row‑level uniqueness.", "applied_to": ["B1_union", "B2_union", "B3_union", "B4_union", "B5_union", "B6_union"]},
    {"id": "R2", "type": "cte_materialization", "description": "Use CTEs for each bucket's union, dedup, and aggregate stages to match the target logical tree; each CTE referenced once will be inlined by the optimizer.", "applied_to": ["B1_union", "B1_dedup", "B1_aggregate", "B2_union", "B2_dedup", "B2_aggregate", "B3_union", "B3_dedup", "B3_aggregate", "B4_union", "B4_dedup", "B4_aggregate", "B5_union", "B5_dedup", "B5_aggregate", "B6_union", "B6_dedup", "B6_aggregate"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "B1_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 0 AND 5 AND ss_list_price BETWEEN 131 AND 141 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 0 AND 5 AND ss_coupon_amt BETWEEN 16798 AND 17798 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 0 AND 5 AND ss_wholesale_cost BETWEEN 25 AND 45",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B1_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B1_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B1_union"]}
      },
      "B1_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B1_LP, COUNT(ss_list_price) AS B1_CNT, COUNT(DISTINCT ss_list_price) AS B1_CNTD FROM B1_dedup",
        "interfaces": {"outputs": ["B1_LP", "B1_CNT", "B1_CNTD"], "consumes": ["B1_dedup"]}
      },
      "B2_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 6 AND 10 AND ss_list_price BETWEEN 145 AND 155 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 6 AND 10 AND ss_coupon_amt BETWEEN 14792 AND 15792 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 6 AND 10 AND ss_wholesale_cost BETWEEN 46 AND 66",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B2_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B2_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B2_union"]}
      },
      "B2_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B2_LP, COUNT(ss_list_price) AS B2_CNT, COUNT(DISTINCT ss_list_price) AS B2_CNTD FROM B2_dedup",
        "interfaces": {"outputs": ["B2_LP", "B2_CNT", "B2_CNTD"], "consumes": ["B2_dedup"]}
      },
      "B3_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 11 AND 15 AND ss_list_price BETWEEN 150 AND 160 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 11 AND 15 AND ss_coupon_amt BETWEEN 6600 AND 7600 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 11 AND 15 AND ss_wholesale_cost BETWEEN 9 AND 29",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B3_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B3_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B3_union"]}
      },
      "B3_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B3_LP, COUNT(ss_list_price) AS B3_CNT, COUNT(DISTINCT ss_list_price) AS B3_CNTD FROM B3_dedup",
        "interfaces": {"outputs": ["B3_LP", "B3_CNT", "B3_CNTD"], "consumes": ["B3_dedup"]}
      },
      "B4_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 16 AND 20 AND ss_list_price BETWEEN 91 AND 101 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 16 AND 20 AND ss_coupon_amt BETWEEN 13493 AND 14493 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 16 AND 20 AND ss_wholesale_cost BETWEEN 36 AND 56",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B4_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B4_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B4_union"]}
      },
      "B4_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B4_LP, COUNT(ss_list_price) AS B4_CNT, COUNT(DISTINCT ss_list_price) AS B4_CNTD FROM B4_dedup",
        "interfaces": {"outputs": ["B4_LP", "B4_CNT", "B4_CNTD"], "consumes": ["B4_dedup"]}
      },
      "B5_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 21 AND 25 AND ss_list_price BETWEEN 0 AND 10 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 21 AND 25 AND ss_coupon_amt BETWEEN 7629 AND 8629 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 21 AND 25 AND ss_wholesale_cost BETWEEN 6 AND 26",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B5_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B5_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B5_union"]}
      },
      "B5_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B5_LP, COUNT(ss_list_price) AS B5_CNT, COUNT(DISTINCT ss_list_price) AS B5_CNTD FROM B5_dedup",
        "interfaces": {"outputs": ["B5_LP", "B5_CNT", "B5_CNTD"], "consumes": ["B5_dedup"]}
      },
      "B6_union": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 26 AND 30 AND ss_list_price BETWEEN 89 AND 99 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 26 AND 30 AND ss_coupon_amt BETWEEN 15257 AND 16257 UNION ALL SELECT ss_list_price FROM store_sales WHERE ss_quantity BETWEEN 26 AND 30 AND ss_wholesale_cost BETWEEN 31 AND 51",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": []}
      },
      "B6_dedup": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT ss_list_price FROM B6_union GROUP BY ss_list_price",
        "interfaces": {"outputs": ["ss_list_price"], "consumes": ["B6_union"]}
      },
      "B6_aggregate": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT AVG(ss_list_price) AS B6_LP, COUNT(ss_list_price) AS B6_CNT, COUNT(DISTINCT ss_list_price) AS B6_CNTD FROM B6_dedup",
        "interfaces": {"outputs": ["B6_LP", "B6_CNT", "B6_CNTD"], "consumes": ["B6_dedup"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT * FROM B1_aggregate, B2_aggregate, B3_aggregate, B4_aggregate, B5_aggregate, B6_aggregate LIMIT 100",
        "interfaces": {"outputs": ["*"], "consumes": ["B1_aggregate", "B2_aggregate", "B3_aggregate", "B4_aggregate", "B5_aggregate", "B6_aggregate"]}
      }
    },
    "reconstruction_order": ["B1_union", "B1_dedup", "B1_aggregate", "B2_union", "B2_dedup", "B2_aggregate", "B3_union", "B3_dedup", "B3_aggregate", "B4_union", "B4_dedup", "B4_aggregate", "B5_union", "B5_dedup", "B5_aggregate", "B6_union", "B6_dedup", "B6_aggregate", "main_query"],
    "assembly_template": "WITH B1_union AS ({B1_union}), B1_dedup AS ({B1_dedup}), B1_aggregate AS ({B1_aggregate}), B2_union AS ({B2_union}), B2_dedup AS ({B2_dedup}), B2_aggregate AS ({B2_aggregate}), B3_union AS ({B3_union}), B3_dedup AS ({B3_dedup}), B3_aggregate AS ({B3_aggregate}), B4_union AS ({B4_union}), B4_dedup AS ({B4_dedup}), B4_aggregate AS ({B4_aggregate}), B5_union AS ({B5_union}), B5_dedup AS ({B5_dedup}), B5_aggregate AS ({B5_aggregate}), B6_union AS ({B6_union}), B6_dedup AS ({B6_dedup}), B6_aggregate AS ({B6_aggregate}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Decomposed each bucket's three‑column OR into three UNION ALL branches, deduplicated per bucket via GROUP BY, then aggregated. This matches the target logical tree's union‑dedup‑aggregate pattern, preserving exact bucket definitions and literals.

**Expected speedup**: Likely slower (~0.5‑0.7x) due to 18 scans and deduplication overhead, but satisfies the required structural rewrite.