WITH date_cte AS (SELECT d_date_sk, d_qoy FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1211), store_cte AS (SELECT s_store_sk FROM store WHERE s_store_sk <= 100), item_filtered1 AS (SELECT i_item_sk, i_manufact_id FROM item WHERE i_category IN ('Books','Children','Electronics') AND i_class IN ('personal','portable','reference','self-help') AND i_brand IN ('scholaramalgamalg #14','scholaramalgamalg #7','exportiunivamalg #9','scholaramalgamalg #9')), item_filtered2 AS (SELECT i_item_sk, i_manufact_id FROM item WHERE i_category IN ('Women','Music','Men') AND i_class IN ('accessories','classical','fragrances','pants') AND i_brand IN ('amalgimporto #1','edu packscholar #1','exportiimporto #1','importoamalg #1')), branch1_cte AS (SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM store_sales ss INNER JOIN date_cte d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN store_cte s ON ss.ss_store_sk = s.s_store_sk INNER JOIN item_filtered1 i ON ss.ss_item_sk = i.i_item_sk), branch2_cte AS (SELECT i.i_manufact_id, d.d_qoy, ss.ss_sales_price FROM store_sales ss INNER JOIN date_cte d ON ss.ss_sold_date_sk = d.d_date_sk INNER JOIN store_cte s ON ss.ss_store_sk = s.s_store_sk INNER JOIN item_filtered2 i ON ss.ss_item_sk = i.i_item_sk), union_cte AS (SELECT * FROM branch1_cte UNION ALL SELECT * FROM branch2_cte), agg_cte AS (SELECT i_manufact_id, d_qoy, SUM(ss_sales_price) AS sum_sales FROM union_cte GROUP BY i_manufact_id, d_qoy), window_cte AS (SELECT i_manufact_id, d_qoy, sum_sales, AVG(sum_sales) OVER (PARTITION BY i_manufact_id) AS avg_quarterly_sales FROM agg_cte), filter_cte AS (SELECT i_manufact_id, sum_sales, avg_quarterly_sales FROM window_cte WHERE CASE WHEN avg_quarterly_sales > 0 THEN ABS(sum_sales - avg_quarterly_sales) / avg_quarterly_sales ELSE NULL END > 0.1), top_n AS (SELECT i_manufact_id, sum_sales, avg_quarterly_sales FROM filter_cte ORDER BY avg_quarterly_sales ASC, sum_sales ASC, i_manufact_id ASC LIMIT 100) SELECT * FROM top_n