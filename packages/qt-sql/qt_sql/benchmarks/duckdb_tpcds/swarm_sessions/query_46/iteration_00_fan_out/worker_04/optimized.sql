WITH date_cte AS (SELECT d_date_sk FROM date_dim WHERE d_dow IN (6,0) AND d_year BETWEEN 1999 AND 2001), store_cte AS (SELECT s_store_sk FROM store WHERE s_city IN ('Five Points','Centerville','Oak Grove','Fairview','Liberty')), hd_branch1 AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_dep_count = 6), hd_branch2 AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_vehicle_count = 0), hd_union AS (SELECT hd_demo_sk FROM hd_branch1 UNION DISTINCT SELECT hd_demo_sk FROM hd_branch2), addr_cte AS (SELECT ca_address_sk, ca_city FROM customer_address), filtered_fact AS (SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, ca_city AS bought_city, ss_coupon_amt, ss_net_profit FROM store_sales INNER JOIN date_cte ON ss_sold_date_sk = d_date_sk INNER JOIN store_cte ON ss_store_sk = s_store_sk INNER JOIN hd_union ON ss_hdemo_sk = hd_demo_sk INNER JOIN addr_cte ON ss_addr_sk = ca_address_sk), agg AS (SELECT ss_ticket_number, ss_customer_sk, ss_addr_sk, bought_city, SUM(ss_coupon_amt) AS amt, SUM(ss_net_profit) AS profit FROM filtered_fact GROUP BY ss_ticket_number, ss_customer_sk, ss_addr_sk, bought_city), late_customer_join AS (SELECT c_last_name, c_first_name, current_addr.ca_city, agg.bought_city, agg.ss_ticket_number, agg.amt, agg.profit FROM agg INNER JOIN customer ON agg.ss_customer_sk = customer.c_customer_sk INNER JOIN customer_address current_addr ON customer.c_current_addr_sk = current_addr.ca_address_sk WHERE current_addr.ca_city <> agg.bought_city) SELECT c_last_name, c_first_name, ca_city, bought_city, ss_ticket_number, amt, profit FROM late_customer_join ORDER BY c_last_name, c_first_name, ca_city, bought_city, ss_ticket_number LIMIT 100