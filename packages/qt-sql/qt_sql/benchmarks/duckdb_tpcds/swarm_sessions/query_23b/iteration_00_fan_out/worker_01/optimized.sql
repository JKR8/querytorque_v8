WITH date_filter_4year AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year IN (2000, 2001, 2002, 2003)), date_filter_may2000 AS (SELECT d_date_sk, d_date FROM date_dim WHERE d_year = 2000 AND d_moy = 5), customer_all AS (SELECT c_customer_sk, c_last_name, c_first_name FROM customer), item_all AS (SELECT i_item_sk, i_item_desc FROM item), store_sales_base AS (SELECT ss.ss_item_sk, ia.i_item_desc, ss.ss_customer_sk, ss.ss_quantity, ss.ss_sales_price, df.d_date FROM store_sales ss INNER JOIN date_filter_4year df ON ss.ss_sold_date_sk = df.d_date_sk INNER JOIN customer_all ca ON ss.ss_customer_sk = ca.c_customer_sk INNER JOIN item_all ia ON ss.ss_item_sk = ia.i_item_sk), frequent_ss_items AS (SELECT SUBSTR(i_item_desc, 1, 30) AS itemdesc, ss_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt FROM store_sales_base GROUP BY SUBSTR(i_item_desc, 1, 30), ss_item_sk, d_date HAVING COUNT(*) > 4), max_store_sales AS (SELECT MAX(csales) AS tpcds_cmax FROM (SELECT ss_customer_sk, SUM(ss_quantity * ss_sales_price) AS csales FROM store_sales_base GROUP BY ss_customer_sk)), best_ss_customer AS (SELECT ss_customer_sk AS c_customer_sk, SUM(ss_quantity * ss_sales_price) AS ssales FROM store_sales_base GROUP BY ss_customer_sk HAVING SUM(ss_quantity * ss_sales_price) > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)), catalog_sales_filtered AS (SELECT cs.cs_bill_customer_sk, cs.cs_quantity, cs.cs_list_price FROM catalog_sales cs INNER JOIN date_filter_may2000 df ON cs.cs_sold_date_sk = df.d_date_sk WHERE cs.cs_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND cs.cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)), web_sales_filtered AS (SELECT ws.ws_bill_customer_sk, ws.ws_quantity, ws.ws_list_price FROM web_sales ws INNER JOIN date_filter_may2000 df ON ws.ws_sold_date_sk = df.d_date_sk WHERE ws.ws_item_sk IN (SELECT item_sk FROM frequent_ss_items) AND ws.ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer)) SELECT c_last_name, c_first_name, sales FROM (SELECT ca.c_last_name, ca.c_first_name, SUM(cs.cs_quantity * cs.cs_list_price) AS sales FROM catalog_sales_filtered cs JOIN customer_all ca ON cs.cs_bill_customer_sk = ca.c_customer_sk GROUP BY ca.c_last_name, ca.c_first_name UNION ALL SELECT ca.c_last_name, ca.c_first_name, SUM(ws.ws_quantity * ws.ws_list_price) AS sales FROM web_sales_filtered ws JOIN customer_all ca ON ws.ws_bill_customer_sk = ca.c_customer_sk GROUP BY ca.c_last_name, ca.c_first_name) ORDER BY c_last_name, c_first_name, sales LIMIT 100