## Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] store_sales_single_scan [+] — Single scan consolidating store_sales joins for 2000-2003
│   ├── SCAN (store_sales, date_dim, item, customer)
│   ├── JOIN (ss_sold_date_sk = d_date_sk)
│   ├── FILTER (d_year IN (2000, 2001, 2002, 2003))
│   ├── JOIN (ss_item_sk = i_item_sk)
│   ├── JOIN (ss_customer_sk = c_customer_sk)
│   └── OUTPUT (ss_item_sk, i_item_desc, ss_customer_sk, ss_quantity, ss_sales_price, d_date)
├── [CTE] frequent_ss_items_and_customer_aggs [+] — Compute item-customer-date aggregates
│   ├── FROM: store_sales_single_scan
│   ├── GROUP BY (itemdesc, item_sk, solddate, customer_sk)
│   ├── AGGREGATE (cnt, customer_daily_sales)
│   └── OUTPUT (itemdesc, item_sk, solddate, cnt, ss_customer_sk, customer_daily_sales)
├── [CTE] frequent_ss_items_filtered [~] — Filter items with cnt>4 (now derived from new CTE)
│   ├── FROM: frequent_ss_items_and_customer_aggs
│   ├── FILTER (cnt > 4)
│   ├── GROUP BY (itemdesc, item_sk, solddate)
│   └── OUTPUT (itemdesc, item_sk, solddate, cnt)
├── [CTE] customer_aggs [+] — Aggregate customer total sales
│   ├── FROM: frequent_ss_items_and_customer_aggs
│   ├── GROUP BY (ss_customer_sk)
│   ├── AGGREGATE (total_sales)
│   └── OUTPUT (ss_customer_sk, total_sales)
├── [CTE] max_store_sales [~] — Compute max customer sales (now derived from customer_aggs)
│   ├── FROM: customer_aggs
│   └── OUTPUT (tpcds_cmax)
├── [CTE] best_ss_customer [~] — Get top 5% customers (now derived from customer_aggs)
│   ├── FROM: customer_aggs
│   ├── FILTER (total_sales > 0.95 * tpcds_cmax)
│   └── OUTPUT (c_customer_sk, ssales)
└── [MAIN] main_query [=] — Union catalog and web sales for May 2000
    ├── SCAN (catalog_sales, customer, date_dim, web_sales)
    ├── FILTER (d_year=2000, d_moy=5)
    ├── SEMI JOIN (cs_item_sk IN frequent_ss_items_filtered)
    ├── SEMI JOIN (cs_bill_customer_sk IN best_ss_customer)
    ├── AGGREGATE (GROUP BY c_last_name, c_first_name)
    ├── SORT (c_last_name, c_first_name, sales)
    └── OUTPUT (c_last_name, c_first_name, sales)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "single_pass_aggregation",
      "description": "Consolidate store_sales scans into single CTE that computes both item-date-customer aggregates and customer total sales",
      "applied_to": ["store_sales_single_scan", "frequent_ss_items_and_customer_aggs", "customer_aggs"]
    },
    {
      "id": "R2",
      "type": "pushdown",
      "description": "Replace original CTEs with new consolidated structure; eliminate redundant scans of store_sales",
      "applied_to": ["frequent_ss_items_filtered", "max_store_sales", "best_ss_customer"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "store_sales_single_scan": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ss_item_sk, i_item_desc, ss_customer_sk, ss_quantity, ss_sales_price, d_date FROM store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk AND d_year IN (2000, 2001, 2002, 2003) JOIN item ON ss_item_sk = i_item_sk JOIN customer ON ss_customer_sk = c_customer_sk",
        "interfaces": {
          "outputs": ["ss_item_sk", "i_item_desc", "ss_customer_sk", "ss_quantity", "ss_sales_price", "d_date"],
          "consumes": []
        }
      },
      "frequent_ss_items_and_customer_aggs": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT SUBSTR(i_item_desc,1,30) AS itemdesc, ss_item_sk AS item_sk, d_date AS solddate, COUNT(*) AS cnt, ss_customer_sk, SUM(ss_quantity * ss_sales_price) AS customer_daily_sales FROM store_sales_single_scan GROUP BY SUBSTR(i_item_desc,1,30), ss_item_sk, d_date, ss_customer_sk",
        "interfaces": {
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt", "ss_customer_sk", "customer_daily_sales"],
          "consumes": ["store_sales_single_scan"]
        }
      },
      "frequent_ss_items_filtered": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT itemdesc, item_sk, solddate, cnt FROM frequent_ss_items_and_customer_aggs WHERE cnt > 4 GROUP BY itemdesc, item_sk, solddate, cnt",
        "interfaces": {
          "outputs": ["itemdesc", "item_sk", "solddate", "cnt"],
          "consumes": ["frequent_ss_items_and_customer_aggs"]
        }
      },
      "customer_aggs": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT ss_customer_sk, SUM(customer_daily_sales) AS total_sales FROM frequent_ss_items_and_customer_aggs GROUP BY ss_customer_sk",
        "interfaces": {
          "outputs": ["ss_customer_sk", "total_sales"],
          "consumes": ["frequent_ss_items_and_customer_aggs"]
        }
      },
      "max_store_sales": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT MAX(total_sales) AS tpcds_cmax FROM customer_aggs",
        "interfaces": {
          "outputs": ["tpcds_cmax"],
          "consumes": ["customer_aggs"]
        }
      },
      "best_ss_customer": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT ss_customer_sk AS c_customer_sk, total_sales AS ssales FROM customer_aggs WHERE total_sales > (95/100.0) * (SELECT tpcds_cmax FROM max_store_sales)",
        "interfaces": {
          "outputs": ["c_customer_sk", "ssales"],
          "consumes": ["customer_aggs", "max_store_sales"]
        }
      },
      "main_query": {
        "type": "main_query",
        "change": "unchanged",
        "sql": "SELECT c_last_name, c_first_name, SUM(sales) AS sales FROM (SELECT c_last_name, c_first_name, SUM(cs_quantity * cs_list_price) AS sales FROM catalog_sales, customer, date_dim WHERE d_year = 2000 AND d_moy = 5 AND cs_sold_date_sk = d_date_sk AND cs_item_sk IN (SELECT item_sk FROM frequent_ss_items_filtered) AND cs_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND cs_bill_customer_sk = c_customer_sk GROUP BY c_last_name, c_first_name UNION ALL SELECT c_last_name, c_first_name, SUM(ws_quantity * ws_list_price) AS sales FROM web_sales, customer, date_dim WHERE d_year = 2000 AND d_moy = 5 AND ws_sold_date_sk = d_date_sk AND ws_item_sk IN (SELECT item_sk FROM frequent_ss_items_filtered) AND ws_bill_customer_sk IN (SELECT c_customer_sk FROM best_ss_customer) AND ws_bill_customer_sk = c_customer_sk GROUP BY c_last_name, c_first_name) AS combined GROUP BY c_last_name, c_first_name ORDER BY c_last_name, c_first_name, sales LIMIT 100",
        "interfaces": {
          "outputs": ["c_last_name", "c_first_name", "sales"],
          "consumes": ["frequent_ss_items_filtered", "best_ss_customer"]
        }
      }
    },
    "reconstruction_order": ["store_sales_single_scan", "frequent_ss_items_and_customer_aggs", "frequent_ss_items_filtered", "customer_aggs", "max_store_sales", "best_ss_customer", "main_query"],
    "assembly_template": "WITH store_sales_single_scan AS ({store_sales_single_scan}), frequent_ss_items_and_customer_aggs AS ({frequent_ss_items_and_customer_aggs}), frequent_ss_items_filtered AS ({frequent_ss_items_filtered}), customer_aggs AS ({customer_aggs}), max_store_sales AS ({max_store_sales}), best_ss_customer AS ({best_ss_customer}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Consolidated four separate store_sales scans into a single pass that computes both item-date-customer aggregates (for frequent items) and customer total sales (for top customers) in one CTE chain. This eliminates redundant scans while preserving all original filters and semantics.

**Expected speedup**: 3-4x (reducing store_sales scans from 4 to 1, while maintaining same join and aggregation logic).