WITH date_cte AS (SELECT d_date_sk, d_year FROM date_dim WHERE d_year IN (1999, 2000)), sales_union_agg AS (SELECT c.c_customer_sk, c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country, ((ss_ext_list_price - ss_ext_wholesale_cost - ss_ext_discount_amt) + ss_ext_sales_price) / 2 AS amount, d.d_year, 's' AS sale_type FROM customer c, store_sales ss, date_cte d WHERE c.c_customer_sk = ss.ss_customer_sk AND ss.ss_sold_date_sk = d.d_date_sk UNION ALL SELECT c.c_customer_sk, c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country, ((cs_ext_list_price - cs_ext_wholesale_cost - cs_ext_discount_amt) + cs_ext_sales_price) / 2, d.d_year, 'c' FROM customer c, catalog_sales cs, date_cte d WHERE c.c_customer_sk = cs.cs_bill_customer_sk AND cs.cs_sold_date_sk = d.d_date_sk UNION ALL SELECT c.c_customer_sk, c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country, ((ws_ext_list_price - ws_ext_wholesale_cost - ws_ext_discount_amt) + ws_ext_sales_price) / 2, d.d_year, 'w' FROM customer c, web_sales ws, date_cte d WHERE c.c_customer_sk = ws.ws_bill_customer_sk AND ws.ws_sold_date_sk = d.d_date_sk), pivot_cte AS (SELECT c_customer_id, c_first_name, c_last_name, c_birth_country, sale_type, SUM(CASE WHEN d_year = 1999 THEN amount END) AS year_total_1999, SUM(CASE WHEN d_year = 2000 THEN amount END) AS year_total_2000 FROM sales_union_agg GROUP BY c_customer_id, c_first_name, c_last_name, c_birth_country, sale_type) SELECT s.c_customer_id AS customer_id, s.c_first_name AS customer_first_name, s.c_last_name AS customer_last_name, s.c_birth_country AS customer_birth_country FROM pivot_cte s, pivot_cte c, pivot_cte w WHERE s.c_customer_id = c.c_customer_id AND s.c_customer_id = w.c_customer_id AND s.sale_type = 's' AND c.sale_type = 'c' AND w.sale_type = 'w' AND s.year_total_1999 > 0 AND c.year_total_1999 > 0 AND w.year_total_1999 > 0 AND CASE WHEN c.year_total_1999 > 0 THEN c.year_total_2000 / c.year_total_1999 END > CASE WHEN s.year_total_1999 > 0 THEN s.year_total_2000 / s.year_total_1999 END AND CASE WHEN c.year_total_1999 > 0 THEN c.year_total_2000 / c.year_total_1999 END > CASE WHEN w.year_total_1999 > 0 THEN w.year_total_2000 / w.year_total_1999 END ORDER BY s.c_customer_id, s.c_first_name, s.c_last_name, s.c_birth_country LIMIT 100