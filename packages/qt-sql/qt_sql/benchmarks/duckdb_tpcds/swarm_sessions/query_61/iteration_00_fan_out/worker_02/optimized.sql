WITH promotion_dmail AS (SELECT p_promo_sk FROM promotion WHERE p_channel_dmail = 'Y'), promotion_email AS (SELECT p_promo_sk FROM promotion WHERE p_channel_email = 'Y'), promotion_tv AS (SELECT p_promo_sk FROM promotion WHERE p_channel_tv = 'Y'), promotion_union AS (SELECT p_promo_sk FROM promotion_dmail UNION ALL SELECT p_promo_sk FROM promotion_email UNION ALL SELECT p_promo_sk FROM promotion_tv), filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 1999 AND d_moy = 11), filtered_item AS (SELECT i_item_sk FROM item WHERE i_category = 'Jewelry'), filtered_store AS (SELECT s_store_sk FROM store WHERE s_gmt_offset = -7), filtered_customer_address AS (SELECT ca_address_sk FROM customer_address WHERE ca_gmt_offset = -7), filtered_customer AS (SELECT c_customer_sk FROM customer JOIN filtered_customer_address ON c_current_addr_sk = ca_address_sk), all_sales_scan AS (SELECT ss_ext_sales_price FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_customer ON ss_customer_sk = c_customer_sk JOIN filtered_item ON ss_item_sk = i_item_sk), promotional_scan AS (SELECT ss_ext_sales_price FROM store_sales JOIN filtered_date ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON ss_store_sk = s_store_sk JOIN filtered_customer ON ss_customer_sk = c_customer_sk JOIN filtered_item ON ss_item_sk = i_item_sk JOIN promotion_union ON ss_promo_sk = p_promo_sk), all_sales_agg AS (SELECT SUM(ss_ext_sales_price) AS total FROM all_sales_scan), promotional_agg AS (SELECT SUM(ss_ext_sales_price) AS promotions FROM promotional_scan) SELECT promotions, total, CAST(promotions AS DECIMAL(15,4))/CAST(total AS DECIMAL(15,4))*100 FROM promotional_agg CROSS JOIN all_sales_agg ORDER BY promotions, total LIMIT 100