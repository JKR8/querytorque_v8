WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD','TN','GA','SC','MO','AL','MI','OH')), fact_prejoin AS (SELECT ss_item_sk, ss_net_profit, ss_ext_sales_price FROM store_sales INNER JOIN filtered_date ON ss_sold_date_sk = d_date_sk INNER JOIN filtered_store ON ss_store_sk = s_store_sk), item_join AS (SELECT i.i_category, i.i_class, fp.ss_net_profit, fp.ss_ext_sales_price FROM fact_prejoin fp INNER JOIN item i ON i.i_item_sk = fp.ss_item_sk), rollup_agg AS (SELECT i_category, i_class, GROUPING(i_category) as g_cat, GROUPING(i_class) as g_cls, SUM(ss_net_profit) as sum_net_profit, SUM(ss_ext_sales_price) as sum_sales_price FROM item_join GROUP BY ROLLUP(i_category, i_class)), window_rank AS (SELECT (sum_net_profit / sum_sales_price) as gross_margin, i_category, i_class, (g_cat + g_cls) as lochierarchy, RANK() OVER (PARTITION BY (g_cat + g_cls), CASE WHEN g_cls = 0 THEN i_category END ORDER BY (sum_net_profit / sum_sales_price) ASC) as rank_within_parent FROM rollup_agg) SELECT gross_margin, i_category, i_class, lochierarchy, rank_within_parent FROM window_rank ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100