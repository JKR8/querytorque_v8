WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD','TN','GA','SC','MO','AL','MI','OH')), filtered_item AS (SELECT i_item_sk, i_category, i_class FROM item), fact_join AS (SELECT fi.i_category, fi.i_class, ss.ss_net_profit, ss.ss_ext_sales_price FROM store_sales ss INNER JOIN filtered_date fd ON ss.ss_sold_date_sk = fd.d_date_sk INNER JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk INNER JOIN filtered_item fi ON ss.ss_item_sk = fi.i_item_sk), rollup_agg AS (SELECT i_category, i_class, GROUPING(i_category) AS g_cat, GROUPING(i_class) AS g_cls, SUM(ss_net_profit) AS sum_net_profit, SUM(ss_ext_sales_price) AS sum_sales_price FROM fact_join GROUP BY ROLLUP(i_category, i_class)), window_rank AS (SELECT sum_net_profit / sum_sales_price AS gross_margin, i_category, i_class, (g_cat + g_cls) AS lochierarchy, RANK() OVER (PARTITION BY (g_cat + g_cls), CASE WHEN g_cls = 0 THEN i_category END ORDER BY sum_net_profit / sum_sales_price ASC) AS rank_within_parent FROM rollup_agg) SELECT gross_margin, i_category, i_class, lochierarchy, rank_within_parent FROM window_rank ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100