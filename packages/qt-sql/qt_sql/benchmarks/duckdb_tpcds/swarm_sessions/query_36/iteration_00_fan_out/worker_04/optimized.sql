WITH filtered_date AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), filtered_store AS (SELECT s_store_sk FROM store WHERE s_state IN ('SD','TN','GA','SC','MO','AL','MI','OH')), fact_preagg AS (SELECT ss_item_sk, SUM(ss_net_profit) AS profit_sum, SUM(ss_ext_sales_price) AS sales_sum FROM store_sales INNER JOIN filtered_date ON ss_sold_date_sk = d_date_sk INNER JOIN filtered_store ON ss_store_sk = s_store_sk GROUP BY ss_item_sk), item_join AS (SELECT i.i_category, i.i_class, fp.profit_sum, fp.sales_sum FROM fact_preagg fp INNER JOIN item i ON i.i_item_sk = fp.ss_item_sk), level1_agg AS (SELECT i_category, i_class, 0 AS lochierarchy, SUM(profit_sum) AS sum_net_profit, SUM(sales_sum) AS sum_sales_price FROM item_join GROUP BY i_category, i_class), level2_agg AS (SELECT i_category, NULL AS i_class, 1 AS lochierarchy, SUM(profit_sum) AS sum_net_profit, SUM(sales_sum) AS sum_sales_price FROM item_join GROUP BY i_category), level3_agg AS (SELECT NULL AS i_category, NULL AS i_class, 2 AS lochierarchy, SUM(profit_sum) AS sum_net_profit, SUM(sales_sum) AS sum_sales_price FROM item_join), union_all AS (SELECT * FROM level1_agg UNION ALL SELECT * FROM level2_agg UNION ALL SELECT * FROM level3_agg), window_rank AS (SELECT sum_net_profit / sum_sales_price AS gross_margin, i_category, i_class, lochierarchy, CASE WHEN lochierarchy < 2 THEN RANK() OVER (PARTITION BY lochierarchy, CASE WHEN lochierarchy = 0 THEN i_category END ORDER BY sum_net_profit / sum_sales_price ASC) ELSE 1 END AS rank_within_parent FROM union_all) SELECT gross_margin, i_category, i_class, lochierarchy, rank_within_parent FROM window_rank ORDER BY lochierarchy DESC, CASE WHEN lochierarchy = 0 THEN i_category END, rank_within_parent LIMIT 100