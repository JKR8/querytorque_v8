### Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] date_period1_cte [+]  — Filter date_dim for first 12-month period
│   ├── SCAN (date_dim)
│   ├── FILTER (d_month_seq BETWEEN 1196 AND 1196 + 11)
│   └── OUTPUT (d_date_sk, d_week_seq)
├── [CTE] date_period2_cte [+]  — Filter date_dim for second 12-month period
│   ├── SCAN (date_dim)
│   ├── FILTER (d_month_seq BETWEEN 1196 + 12 AND 1196 + 23)
│   └── OUTPUT (d_date_sk, d_week_seq)
├── [CTE] wss_period1_cte [+]   — Aggregate store sales for period 1
│   ├── SCAN (store_sales)
│   ├── JOIN (date_period1_cte ON ss_sold_date_sk = d_date_sk)
│   ├── AGG (GROUP BY d_week_seq, ss_store_sk)
│   └── OUTPUT (d_week_seq, ss_store_sk, sun_sales..sat_sales)
├── [CTE] wss_period2_cte [+]   — Aggregate store sales for period 2
│   ├── SCAN (store_sales)
│   ├── JOIN (date_period2_cte ON ss_sold_date_sk = d_date_sk)
│   ├── AGG (GROUP BY d_week_seq, ss_store_sk)
│   └── OUTPUT (d_week_seq, ss_store_sk, sun_sales..sat_sales)
├── [CTE] joined_periods [+]     — Join periods with store and week offset
│   ├── JOIN (wss_period1_cte p1)
│   ├── JOIN (wss_period2_cte p2 ON p1.ss_store_sk = p2.ss_store_sk AND p1.d_week_seq = p2.d_week_seq - 52)
│   ├── JOIN (store ON p1.ss_store_sk = s_store_sk)
│   └── OUTPUT (s_store_name, s_store_id, d_week_seq1, sun_sales1..sat_sales1, sun_sales2..sat_sales2)
└── [MAIN] final_select [~]     — Compute ratios, order, limit (changed from original structure)
    ├── SCAN (joined_periods)
    ├── COMPUTE (7 ratio expressions)
    ├── SORT (s_store_name ASC, s_store_id ASC, d_week_seq1 ASC)
    └── OUTPUT (10 columns per Column Completeness Contract)
```

### Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "date_cte_isolate", "description": "Extract date filtering for each period into separate CTEs to push filters early and isolate dimension lookups", "applied_to": ["date_period1_cte", "date_period2_cte"]},
    {"id": "R2", "type": "early_filter", "description": "Filter date_dim by month_seq before joining with large fact table store_sales", "applied_to": ["wss_period1_cte", "wss_period2_cte"]},
    {"id": "R3", "type": "structural_change", "description": "Replace original wss CTE + double self-join with sequential CTEs that compute periods separately, then join once with exact week offset", "applied_to": ["wss_period1_cte", "wss_period2_cte", "joined_periods", "final_select"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_period1_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1196 AND 1196 + 11",
        "interfaces": {"outputs": ["d_date_sk", "d_week_seq"], "consumes": []}
      },
      "date_period2_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_date_sk, d_week_seq FROM date_dim WHERE d_month_seq BETWEEN 1196 + 12 AND 1196 + 23",
        "interfaces": {"outputs": ["d_date_sk", "d_week_seq"], "consumes": []}
      },
      "wss_period1_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_week_seq, ss_store_sk, SUM(CASE WHEN d_day_name = 'Sunday' THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN d_day_name = 'Monday' THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN d_day_name = 'Tuesday' THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN d_day_name = 'Wednesday' THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN d_day_name = 'Thursday' THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN d_day_name = 'Friday' THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN d_day_name = 'Saturday' THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales JOIN date_period1_cte ON ss_sold_date_sk = d_date_sk GROUP BY d_week_seq, ss_store_sk",
        "interfaces": {"outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"], "consumes": ["date_period1_cte"]}
      },
      "wss_period2_cte": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT d_week_seq, ss_store_sk, SUM(CASE WHEN d_day_name = 'Sunday' THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN d_day_name = 'Monday' THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN d_day_name = 'Tuesday' THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN d_day_name = 'Wednesday' THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN d_day_name = 'Thursday' THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN d_day_name = 'Friday' THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN d_day_name = 'Saturday' THEN ss_sales_price ELSE NULL END) AS sat_sales FROM store_sales JOIN date_period2_cte ON ss_sold_date_sk = d_date_sk GROUP BY d_week_seq, ss_store_sk",
        "interfaces": {"outputs": ["d_week_seq", "ss_store_sk", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"], "consumes": ["date_period2_cte"]}
      },
      "joined_periods": {
        "type": "cte",
        "change": "added",
        "sql": "SELECT s.s_store_name, s.s_store_id, p1.d_week_seq AS d_week_seq1, p1.sun_sales AS sun_sales1, p1.mon_sales AS mon_sales1, p1.tue_sales AS tue_sales1, p1.wed_sales AS wed_sales1, p1.thu_sales AS thu_sales1, p1.fri_sales AS fri_sales1, p1.sat_sales AS sat_sales1, p2.sun_sales AS sun_sales2, p2.mon_sales AS mon_sales2, p2.tue_sales AS tue_sales2, p2.wed_sales AS wed_sales2, p2.thu_sales AS thu_sales2, p2.fri_sales AS fri_sales2, p2.sat_sales AS sat_sales2 FROM wss_period1_cte p1 JOIN wss_period2_cte p2 ON p1.ss_store_sk = p2.ss_store_sk AND p1.d_week_seq = p2.d_week_seq - 52 JOIN store s ON p1.ss_store_sk = s.s_store_sk",
        "interfaces": {"outputs": ["s_store_name", "s_store_id", "d_week_seq1", "sun_sales1", "mon_sales1", "tue_sales1", "wed_sales1", "thu_sales1", "fri_sales1", "sat_sales1", "sun_sales2", "mon_sales2", "tue_sales2", "wed_sales2", "thu_sales2", "fri_sales2", "sat_sales2"], "consumes": ["wss_period1_cte", "wss_period2_cte"]}
      },
      "final_select": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT s_store_name AS s_store_name1, s_store_id AS s_store_id1, d_week_seq1, sun_sales1 / sun_sales2, mon_sales1 / mon_sales2, tue_sales1 / tue_sales2, wed_sales1 / wed_sales2, thu_sales1 / thu_sales2, fri_sales1 / fri_sales2, sat_sales1 / sat_sales2 FROM joined_periods ORDER BY s_store_name1, s_store_id1, d_week_seq1 LIMIT 100",
        "interfaces": {"outputs": ["s_store_name1", "s_store_id1", "d_week_seq1", "sun_sales1 / sun_sales2", "mon_sales1 / mon_sales2", "tue_sales1 / tue_sales2", "wed_sales1 / wed_sales2", "thu_sales1 / thu_sales2", "fri_sales1 / fri_sales2", "sat_sales1 / sat_sales2"], "consumes": ["joined_periods"]}
      }
    },
    "reconstruction_order": ["date_period1_cte", "date_period2_cte", "wss_period1_cte", "wss_period2_cte", "joined_periods", "final_select"],
    "assembly_template": "WITH date_period1_cte AS ({date_period1_cte}), date_period2_cte AS ({date_period2_cte}), wss_period1_cte AS ({wss_period1_cte}), wss_period2_cte AS ({wss_period2_cte}), joined_periods AS ({joined_periods}) {final_select}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Replaced original monolithic wss CTE + self-join with sequential CTEs that filter dates early, compute aggregates per period, then join once with exact week offset. This pushes month predicates down to date_dim scans and reduces intermediate data before the final join.

**Expected speedup**: 2-3x from early filtering and reduced intermediate aggregation size (original scans entire store_sales once; new scans store_sales twice but with date filters applied early, reducing rows processed in aggregation). Baseline 2898ms → target ~1000-1500ms.