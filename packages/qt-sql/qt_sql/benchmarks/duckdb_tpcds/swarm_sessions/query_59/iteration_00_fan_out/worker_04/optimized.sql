WITH store_cte AS (SELECT s_store_sk, s_store_id, s_store_name FROM store), date_periods_cte AS (SELECT d_date_sk, d_week_seq, d_month_seq, CASE WHEN d_month_seq BETWEEN 1196 AND 1196+11 THEN 1 ELSE 2 END AS period FROM date_dim WHERE d_month_seq BETWEEN 1196 AND 1196+23), sales_aggregates_cte AS (SELECT ss_store_sk, d_week_seq, period, SUM(CASE WHEN d_day_name = 'Sunday' THEN ss_sales_price END) AS sun_sales, SUM(CASE WHEN d_day_name = 'Monday' THEN ss_sales_price END) AS mon_sales, SUM(CASE WHEN d_day_name = 'Tuesday' THEN ss_sales_price END) AS tue_sales, SUM(CASE WHEN d_day_name = 'Wednesday' THEN ss_sales_price END) AS wed_sales, SUM(CASE WHEN d_day_name = 'Thursday' THEN ss_sales_price END) AS thu_sales, SUM(CASE WHEN d_day_name = 'Friday' THEN ss_sales_price END) AS fri_sales, SUM(CASE WHEN d_day_name = 'Saturday' THEN ss_sales_price END) AS sat_sales FROM store_sales JOIN date_periods_cte ON ss_sold_date_sk = d_date_sk GROUP BY ss_store_sk, d_week_seq, period), period_alignment_cte AS (SELECT store_cte.s_store_name, store_cte.s_store_id, p1.d_week_seq AS d_week_seq1, p1.sun_sales AS sun_sales1, p1.mon_sales AS mon_sales1, p1.tue_sales AS tue_sales1, p1.wed_sales AS wed_sales1, p1.thu_sales AS thu_sales1, p1.fri_sales AS fri_sales1, p1.sat_sales AS sat_sales1, p2.sun_sales AS sun_sales2, p2.mon_sales AS mon_sales2, p2.tue_sales AS tue_sales2, p2.wed_sales AS wed_sales2, p2.thu_sales AS thu_sales2, p2.fri_sales AS fri_sales2, p2.sat_sales AS sat_sales2 FROM sales_aggregates_cte p1 LEFT JOIN sales_aggregates_cte p2 ON p1.ss_store_sk = p2.ss_store_sk AND p1.d_week_seq = p2.d_week_seq - 52 AND p1.period = 1 AND p2.period = 2 JOIN store_cte ON p1.ss_store_sk = store_cte.s_store_sk WHERE p2.ss_store_sk IS NOT NULL) SELECT s_store_name AS s_store_name1, s_store_id AS s_store_id1, d_week_seq1, sun_sales1 / sun_sales2, mon_sales1 / mon_sales2, tue_sales1 / tue_sales2, wed_sales1 / wed_sales2, thu_sales1 / thu_sales2, fri_sales1 / fri_sales2, sat_sales1 / sat_sales2 FROM period_alignment_cte ORDER BY s_store_name ASC, s_store_id ASC, d_week_seq1 ASC LIMIT 100