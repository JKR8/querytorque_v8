## Part 1: Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] date_week_cte  [+]  — Filters to date_sk values for the week containing 2001-03-24.
│   ├── SCAN (date_dim)
│   ├── FILTER (d_week_seq = (SELECT d__week_seq...))
│   └── OUTPUT (d_date_sk)
├── [CTE] item_prefetch_cte  [+]  — Prefetches item keys to eliminate redundant scans.
│   ├── SCAN (item)
│   └── OUTPUT (i_item_sk, i_item_id)
├── [CTE] all_sales_single_pass  [+]  — Consolidated single pass over all three sales tables with discriminator columns.
│   ├── UNION ALL (store_sales, catalog_sales, web_sales)
│   ├── JOIN (sales.date_sk = date_week_cte.d_date_sk)
│   ├── JOIN (sales.item_sk = item_prefetch_cte.i_item_sk)
│   └── OUTPUT (i_item_id, sales_price, is_store, is_catalog, is_web)
├── [CTE] channel_pivot_cte  [+]  — Single-pass aggregation with conditional multiplication.
│   ├── SCAN (all_sales_single_pass)
│   ├── AGG (GROUP BY i_item_id)
│   └── OUTPUT (item_id, ss_item_rev, cs_item_rev, ws_item_rev)
├── [CTE] filtered_join_cte  [+]  — Filters items where all channel revenues are within ±10%.
│   ├── SCAN (channel_pivot_cte)
│   ├── FILTER (GREATEST(... ratios ...) <= 1.1)
│   └── OUTPUT (item_id, ss_item_rev, cs_item_rev, ws_item_rev)
└── [MAIN] main_query  [~]  — Computes deviations and average (same columns, but source changed).
    ├── SCAN (filtered_join_cte)
    ├── COMPUTE (deviations, average)
    ├── SORT (item_id ASC, ss_item_rev ASC)
    ├── LIMIT 100
    └── OUTPUT (item_id, ss_item_rev, ss_dev, cs_item_rev, cs_dev, ws_item_rev, ws_dev, average)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "dimension_cte_isolate", "description": "Isolate date_dim week filter into reusable CTE", "applied_to": ["date_week_cte"]},
    {"id": "R2", "type": "dimension_cte_isolate", "description": "Prefetch item dimension to avoid 3 redundant scans", "applied_to": ["item_prefetch_cte"]},
    {"id": "R3", "type": "scan_consolidation_pivot", "description": "Consolidate three channel scans into single UNION ALL pass with discriminator flags", "applied_to": ["all_sales_single_pass"]},
    {"id": "R4", "type": "single_pass_aggregation", "description": "Compute all three channel aggregates in one GROUP BY using multiplication discriminators", "applied_to": ["channel_pivot_cte"]},
    {"id": "R5", "type": "predicate_consolidation", "description": "Replace 12 pairwise BETWEEN conditions with single GREATEST ratio check", "applied_to": ["filtered_join_cte"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_week_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk FROM date_dim WHERE d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2001-03-24')",
        "interfaces": {"outputs": ["d_date_sk"], "consumes": []}
      },
      "item_prefetch_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_sk, i_item_id FROM item",
        "interfaces": {"outputs": ["i_item_sk", "i_item_id"], "consumes": []}
      },
      "all_sales_single_pass": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT pref.i_item_id, sales.sales_price, sales.is_store, sales.is_catalog, sales.is_web FROM (SELECT ss_item_sk AS item_sk, ss_sold_date_sk AS date_sk, ss_ext_sales_price AS sales_price, 1 AS is_store, 0 AS is_catalog, 0 AS is_web FROM store_sales UNION ALL SELECT cs_item_sk, cs_sold_date_sk, cs_ext_sales_price, 0, 1, 0 FROM catalog_sales UNION ALL SELECT ws_item_sk, ws_sold_date_sk, ws_ext_sales_price, 0, 0, 1 FROM web_sales) sales JOIN date_week_cte date ON sales.date_sk = date.d_date_sk JOIN item_prefetch_cte pref ON sales.item_sk = pref.i_item_sk",
        "interfaces": {"outputs": ["i_item_id", "sales_price", "is_store", "is_catalog", "is_web"], "consumes": ["date_week_cte", "item_prefetch_cte"]}
      },
      "channel_pivot_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT i_item_id AS item_id, SUM(sales_price * is_store) AS ss_item_rev, SUM(sales_price * is_catalog) AS cs_item_rev, SUM(sales_price * is_web) AS ws_item_rev FROM all_sales_single_pass GROUP BY i_item_id",
        "interfaces": {"outputs": ["item_id", "ss_item_rev", "cs_item_rev", "ws_item_rev"], "consumes": ["all_sales_single_pass"]}
      },
      "filtered_join_cte": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT item_id, ss_item_rev, cs_item_rev, ws_item_rev FROM channel_pivot_cte WHERE GREATEST(ss_item_rev/NULLIF(cs_item_rev,0), cs_item_rev/NULLIF(ss_item_rev,0), ss_item_rev/NULLIF(ws_item_rev,0), ws_item_rev/NULLIF(ss_item_rev,0), cs_item_rev/NULLIF(ws_item_rev,0), ws_item_rev/NULLIF(cs_item_rev,0)) <= 1.1",
        "interfaces": {"outputs": ["item_id", "ss_item_rev", "cs_item_rev", "ws_item_rev"], "consumes": ["channel_pivot_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT item_id, ss_item_rev, ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS ss_dev, cs_item_rev, cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS cs_dev, ws_item_rev, ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS ws_dev, (ss_item_rev+cs_item_rev+ws_item_rev)/3 AS average FROM filtered_join_cte ORDER BY item_id ASC, ss_item_rev ASC LIMIT 100",
        "interfaces": {"outputs": ["item_id", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"], "consumes": ["filtered_join_cte"]}
      }
    },
    "reconstruction_order": ["date_week_cte", "item_prefetch_cte", "all_sales_single_pass", "channel_pivot_cte", "filtered_join_cte", "main_query"],
    "assembly_template": "WITH date_week_cte AS ({date_week_cte}), item_prefetch_cte AS ({item_prefetch_cte}), all_sales_single_pass AS ({all_sales_single_pass}), channel_pivot_cte AS ({channel_pivot_cte}), filtered_join_cte AS ({filtered_join_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Restructured from three separate channel CTEs into a single pipeline that prefetches dimensions, consolidates fact table scans via UNION ALL, aggregates all channels in one pass, and filters with a consolidated ratio check.

**Expected speedup**: 3.2x-4.5x due to eliminating 2 redundant item table scans (102K rows each), 6 redundant date_dim subquery executions, and merging three separate sales table scans into one pass with early filtering.