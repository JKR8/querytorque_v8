## Modified Logic Tree

```
QUERY: (single statement)
├── [CTE] date_week_cte  [+]  New component — isolates week dates for the target week
│   ├── SCAN date_dim
│   └── FILTER d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2001-03-24')
├── [CTE] all_sales_union_cte  [+]  New component — consolidates all sales channels into single UNION ALL
│   ├── UNION ALL
│   │   ├── SCAN store_sales → JOIN date_week_cte, item
│   │   ├── SCAN catalog_sales → JOIN date_week_cte, item  
│   │   └── SCAN web_sales → JOIN date_week_cte, item
│   └── OUTPUT i_item_id, channel, sales_price
├── [CTE] channel_pivot_cte  [+]  New component — pivots channel revenues via CASE aggregation
│   ├── SCAN all_sales_union_cte
│   ├── AGG (GROUP BY i_item_id)
│   └── OUTPUT item_id, ss_item_rev, cs_item_rev, ws_item_rev
└── [MAIN] main_query  [~]  Modified — consumes channel_pivot_cte instead of three separate CTEs
    ├── SCAN channel_pivot_cte
    ├── FILTER (6 pairwise ±10% conditions)
    ├── COMPUTE deviations and average
    ├── SORT item_id ASC, ss_item_rev ASC
    └── OUTPUT (item_id, ss_item_rev, ss_dev, cs_item_rev, cs_dev, ws_item_rev, ws_dev, average)
```

## Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {"id": "R1", "type": "single_pass_aggregation", "description": "Consolidate three channel CTEs into single UNION ALL with CASE pivoting", "applied_to": ["all_sales_union_cte", "channel_pivot_cte"]},
    {"id": "R2", "type": "union_consolidation", "description": "Share date_week_cte and item joins across all UNION ALL branches", "applied_to": ["all_sales_union_cte"]}
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "date_week_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT d_date_sk, d_date FROM date_dim WHERE d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2001-03-24')",
        "interfaces": {"outputs": ["d_date_sk", "d_date"], "consumes": []}
      },
      "all_sales_union_cte": {
        "type": "cte",
        "change": "modified", 
        "sql": "SELECT i.i_item_id, sales.channel, sales.sales_price FROM (SELECT ss_item_sk AS item_sk, ss_sold_date_sk AS date_sk, ss_ext_sales_price AS sales_price, 'store' AS channel FROM store_sales UNION ALL SELECT cs_item_sk, cs_sold_date_sk, cs_ext_sales_price, 'catalog' FROM catalog_sales UNION ALL SELECT ws_item_sk, ws_sold_date_sk, ws_ext_sales_price, 'web' FROM web_sales) sales JOIN date_week_cte d ON sales.date_sk = d.d_date_sk JOIN item i ON sales.item_sk = i.i_item_sk",
        "interfaces": {"outputs": ["i_item_id", "channel", "sales_price"], "consumes": ["date_week_cte"]}
      },
      "channel_pivot_cte": {
        "type": "cte",
        "change": "modified",
        "sql": "SELECT i_item_id AS item_id, SUM(CASE WHEN channel = 'store' THEN sales_price END) AS ss_item_rev, SUM(CASE WHEN channel = 'catalog' THEN sales_price END) AS cs_item_rev, SUM(CASE WHEN channel = 'web' THEN sales_price END) AS ws_item_rev FROM all_sales_union_cte GROUP BY i_item_id",
        "interfaces": {"outputs": ["item_id", "ss_item_rev", "cs_item_rev", "ws_item_rev"], "consumes": ["all_sales_union_cte"]}
      },
      "main_query": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT item_id, ss_item_rev, CASE WHEN ((ss_item_rev+cs_item_rev+ws_item_rev)/3) <> 0 THEN ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 END AS ss_dev, cs_item_rev, CASE WHEN ((ss_item_rev+cs_item_rev+ws_item_rev)/3) <> 0 THEN cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 END AS cs_dev, ws_item_rev, CASE WHEN ((ss_item_rev+cs_item_rev+ws_item_rev)/3) <> 0 THEN ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 END AS ws_dev, (ss_item_rev+cs_item_rev+ws_item_rev)/3 AS average FROM channel_pivot_cte WHERE ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev ORDER BY item_id, ss_item_rev LIMIT 100",
        "interfaces": {"outputs": ["item_id", "ss_item_rev", "ss_dev", "cs_item_rev", "cs_dev", "ws_item_rev", "ws_dev", "average"], "consumes": ["channel_pivot_cte"]}
      }
    },
    "reconstruction_order": ["date_week_cte", "all_sales_union_cte", "channel_pivot_cte", "main_query"],
    "assembly_template": "WITH date_week_cte AS ({date_week_cte}), all_sales_union_cte AS ({all_sales_union_cte}), channel_pivot_cte AS ({channel_pivot_cte}) {main_query}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Consolidated three separate channel CTEs into a single UNION ALL that shares date and item joins, then pivoted via CASE aggregation. Preserved all six pairwise ±10% filters and added defensive division guards.

**Expected speedup**: ~4-6x by eliminating redundant date_dim and item scans (from 9 date_dim + 3 item scans → 1 date_dim + 1 item scan) and enabling single-pass aggregation.