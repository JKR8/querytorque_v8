WITH date_week_cte AS (SELECT d_date_sk FROM date_dim WHERE d_week_seq = (SELECT d_week_seq FROM date_dim WHERE d_date = '2001-03-24')), item_prefetch_cte AS (SELECT i_item_sk, i_item_id FROM item), all_sales_single_pass AS (SELECT pref.i_item_id, sales.sales_price, sales.is_store, sales.is_catalog, sales.is_web FROM (SELECT ss_item_sk AS item_sk, ss_sold_date_sk AS date_sk, ss_ext_sales_price AS sales_price, 1 AS is_store, 0 AS is_catalog, 0 AS is_web FROM store_sales UNION ALL SELECT cs_item_sk, cs_sold_date_sk, cs_ext_sales_price, 0, 1, 0 FROM catalog_sales UNION ALL SELECT ws_item_sk, ws_sold_date_sk, ws_ext_sales_price, 0, 0, 1 FROM web_sales) sales JOIN date_week_cte date ON sales.date_sk = date.d_date_sk JOIN item_prefetch_cte pref ON sales.item_sk = pref.i_item_sk), channel_pivot_cte AS (SELECT i_item_id AS item_id, SUM(sales_price * is_store) AS ss_item_rev, SUM(sales_price * is_catalog) AS cs_item_rev, SUM(sales_price * is_web) AS ws_item_rev FROM all_sales_single_pass GROUP BY i_item_id), filtered_join_cte AS (SELECT item_id, ss_item_rev, cs_item_rev, ws_item_rev FROM channel_pivot_cte WHERE GREATEST(ss_item_rev/NULLIF(cs_item_rev,0), cs_item_rev/NULLIF(ss_item_rev,0), ss_item_rev/NULLIF(ws_item_rev,0), ws_item_rev/NULLIF(ss_item_rev,0), cs_item_rev/NULLIF(ws_item_rev,0), ws_item_rev/NULLIF(cs_item_rev,0)) <= 1.1) SELECT item_id, ss_item_rev, ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS ss_dev, cs_item_rev, cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS cs_dev, ws_item_rev, ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3)*100 AS ws_dev, (ss_item_rev+cs_item_rev+ws_item_rev)/3 AS average FROM filtered_join_cte ORDER BY item_id ASC, ss_item_rev ASC LIMIT 100