## Part 1: Modified Logic Tree

```
QUERY: (single statement)
└── [MAIN] main_query [!]  Cost: 100%  Rows: ~1K — Multi-dimension prefetch CTEs + fact join pivot
    ├── [+] filtered_date (CTE) — Pre-filter date_dim to year 2000
    │   ├── SCAN (date_dim)
    │   ├── FILTER (d_year = 2000)
    │   └── OUTPUT (d_date_sk, d_day_name)
    ├── [+] filtered_store (CTE) — Pre-filter store to GMT offset -5  
    │   ├── SCAN (store)
    │   ├── FILTER (s_gmt_offset = -5)
    │   └── OUTPUT (s_store_sk, s_store_name, s_store_id)
    ├── [+] prefetched_sales (CTE) — Join fact table with pre-filtered dimensions
    │   ├── SCAN (store_sales)
    │   ├── HASH JOIN INNER (ss_sold_date_sk = d_date_sk) → filtered_date
    │   ├── HASH JOIN INNER (ss_store_sk = s_store_sk) → filtered_store
    │   └── OUTPUT (s_store_name, s_store_id, d_day_name, ss_sales_price)
    ├── [~] main_aggregation — Group by store with CASE pivoting
    │   ├── SCAN (prefetched_sales)
    │   ├── AGG (GROUP BY s_store_name, s_store_id)
    │   ├── AGGREGATES (7 SUM(CASE...))
    │   ├── SORT (s_store_name, s_store_id, sun_sales...)
    │   └── OUTPUT (s_store_name, s_store_id, sun_sales...sat_sales)
    └── OUTPUT (same 9 columns)
```

## Part 2: Component Payload JSON

```json
{
  "spec_version": "1.0",
  "dialect": "duckdb",
  "rewrite_rules": [
    {
      "id": "R1",
      "type": "multi_dimension_prefetch",
      "description": "Pre-filter dimension tables into CTEs before fact join to reduce hash table size and fact probe cost",
      "applied_to": ["filtered_date", "filtered_store", "prefetched_sales"]
    },
    {
      "id": "R2", 
      "type": "cte_materialization",
      "description": "Materialize dimension CTEs (multiple consumers) to avoid re-scanning dimension tables",
      "applied_to": ["filtered_date", "filtered_store"]
    }
  ],
  "statements": [{
    "target_table": null,
    "change": "modified",
    "components": {
      "filtered_date": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT d_date_sk, d_day_name FROM date_dim WHERE d_year = 2000",
        "interfaces": {
          "outputs": ["d_date_sk", "d_day_name"],
          "consumes": []
        }
      },
      "filtered_store": {
        "type": "cte", 
        "change": "new",
        "sql": "SELECT s_store_sk, s_store_name, s_store_id FROM store WHERE s_gmt_offset = -5",
        "interfaces": {
          "outputs": ["s_store_sk", "s_store_name", "s_store_id"],
          "consumes": []
        }
      },
      "prefetched_sales": {
        "type": "cte",
        "change": "new",
        "sql": "SELECT st.s_store_name, st.s_store_id, dt.d_day_name, ss.ss_sales_price FROM store_sales ss INNER JOIN filtered_date dt ON ss.ss_sold_date_sk = dt.d_date_sk INNER JOIN filtered_store st ON ss.ss_store_sk = st.s_store_sk",
        "interfaces": {
          "outputs": ["s_store_name", "s_store_id", "d_day_name", "ss_sales_price"],
          "consumes": ["filtered_date", "filtered_store"]
        }
      },
      "main_aggregation": {
        "type": "main_query",
        "change": "modified",
        "sql": "SELECT s_store_name, s_store_id, SUM(CASE WHEN d_day_name='Sunday' THEN ss_sales_price ELSE NULL END) AS sun_sales, SUM(CASE WHEN d_day_name='Monday' THEN ss_sales_price ELSE NULL END) AS mon_sales, SUM(CASE WHEN d_day_name='Tuesday' THEN ss_sales_price ELSE NULL END) AS tue_sales, SUM(CASE WHEN d_day_name='Wednesday' THEN ss_sales_price ELSE NULL END) AS wed_sales, SUM(CASE WHEN d_day_name='Thursday' THEN ss_sales_price ELSE NULL END) AS thu_sales, SUM(CASE WHEN d_day_name='Friday' THEN ss_sales_price ELSE NULL END) AS fri_sales, SUM(CASE WHEN d_day_name='Saturday' THEN ss_sales_price ELSE NULL END) AS sat_sales FROM prefetched_sales GROUP BY s_store_name, s_store_id ORDER BY s_store_name, s_store_id, sun_sales, mon_sales, tue_sales, wed_sales, thu_sales, fri_sales, sat_sales LIMIT 100",
        "interfaces": {
          "outputs": ["s_store_name", "s_store_id", "sun_sales", "mon_sales", "tue_sales", "wed_sales", "thu_sales", "fri_sales", "sat_sales"],
          "consumes": ["prefetched_sales"]
        }
      }
    },
    "reconstruction_order": ["filtered_date", "filtered_store", "prefetched_sales", "main_aggregation"],
    "assembly_template": "WITH filtered_date AS ({filtered_date}), filtered_store AS ({filtered_store}), prefetched_sales AS ({prefetched_sales}) {main_aggregation}"
  }],
  "macros": {},
  "frozen_blocks": [],
  "validation_checks": []
}
```

**Changes**: Restructured into three materialized CTEs (filtered_date, filtered_store, prefetched_sales) before the main aggregation, isolating dimension filters into small hash tables that reduce the fact table probe cost.

**Expected speedup**: ~2.5-3x from reduced fact table scan and more efficient hash joins with pre-filtered dimension CTEs.