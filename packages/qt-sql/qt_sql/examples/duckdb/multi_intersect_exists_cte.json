{
  "id": "multi_intersect_exists_cte",
  "name": "Multi-INTERSECT to EXISTS with CTEs",
  "description": "Convert cascading INTERSECT operations into correlated EXISTS subqueries with pre-materialized date and channel CTEs",
  "verified_speedup": "2.39x",
  "example": {
    "opportunity": "INTERSECT_TO_EXISTS + DATE_CTE_ISOLATE + MATERIALIZE_CTE",
    "input_slice": "with cross_items as\n (select i_item_sk ss_item_sk from item,\n  (select iss.i_brand_id brand_id, iss.i_class_id class_id, iss.i_category_id category_id\n   from store_sales, item iss, date_dim d1\n   where ss_item_sk = iss.i_item_sk and ss_sold_date_sk = d1.d_date_sk\n     and d1.d_year between 2000 AND 2002\n   intersect\n   select ics.i_brand_id, ics.i_class_id, ics.i_category_id\n   from catalog_sales, item ics, date_dim d2\n   where cs_item_sk = ics.i_item_sk and cs_sold_date_sk = d2.d_date_sk\n     and d2.d_year between 2000 AND 2002\n   intersect\n   select iws.i_brand_id, iws.i_class_id, iws.i_category_id\n   from web_sales, item iws, date_dim d3\n   where ws_item_sk = iws.i_item_sk and ws_sold_date_sk = d3.d_date_sk\n     and d3.d_year between 2000 AND 2002)\n  where i_brand_id = brand_id and i_class_id = class_id and i_category_id = category_id)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "intersect_to_exists",
          "nodes": {
            "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 2000 AND 2002",
            "cross_items": "SELECT i_item_sk AS ss_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE EXISTS (SELECT 1 FROM store_sales JOIN item iss ON ss_item_sk = iss.i_item_sk JOIN filtered_dates d1 ON ss_sold_date_sk = d1.d_date_sk WHERE iss.i_brand_id = item.i_brand_id AND iss.i_class_id = item.i_class_id AND iss.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM catalog_sales JOIN item ics ON cs_item_sk = ics.i_item_sk JOIN filtered_dates d2 ON cs_sold_date_sk = d2.d_date_sk WHERE ics.i_brand_id = item.i_brand_id AND ics.i_class_id = item.i_class_id AND ics.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM web_sales JOIN item iws ON ws_item_sk = iws.i_item_sk JOIN filtered_dates d3 ON ws_sold_date_sk = d3.d_date_sk WHERE iws.i_brand_id = item.i_brand_id AND iws.i_class_id = item.i_class_id AND iws.i_category_id = item.i_category_id)"
          },
          "invariants_kept": [
            "same cross-channel items identified",
            "output columns unchanged"
          ],
          "expected_speedup": "2.39x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "INTERSECT materializes full intermediate result sets (brand_id, class_id, category_id triples) from each channel before intersecting. EXISTS with correlated predicates short-circuits early \u2014 once a matching row is found for each channel, processing stops. Pre-filtering date_dim into a CTE avoids repeated scans of the 73K-row date table.",
    "when_not_to_use": "Do not use when the INTERSECT operates on small result sets (< 1000 rows) where materialization cost is negligible. Also not applicable when the EXISTS correlation would be on non-indexed columns, as the correlated probe could be slower than the hash-based INTERSECT."
  },
  "original_sql": "with cross_items as\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id, iss.i_class_id class_id, iss.i_category_id category_id\n from store_sales, item iss, date_dim d1\n where ss_item_sk = iss.i_item_sk and ss_sold_date_sk = d1.d_date_sk\n   and d1.d_year between 2000 AND 2000 + 2\n intersect\n select ics.i_brand_id, ics.i_class_id, ics.i_category_id\n from catalog_sales, item ics, date_dim d2\n where cs_item_sk = ics.i_item_sk and cs_sold_date_sk = d2.d_date_sk\n   and d2.d_year between 2000 AND 2000 + 2\n intersect\n select iws.i_brand_id, iws.i_class_id, iws.i_category_id\n from web_sales, item iws, date_dim d3\n where ws_item_sk = iws.i_item_sk and ws_sold_date_sk = d3.d_date_sk\n   and d3.d_year between 2000 AND 2000 + 2)\n where i_brand_id = brand_id and i_class_id = class_id and i_category_id = category_id),\n avg_sales as\n (select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity, ss_list_price list_price from store_sales, date_dim where ss_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2\n   union all select cs_quantity, cs_list_price from catalog_sales, date_dim where cs_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2\n   union all select ws_quantity, ws_list_price from web_sales, date_dim where ws_sold_date_sk = d_date_sk and d_year between 2000 and 2000 + 2) x)\n select channel, i_brand_id, i_class_id, i_category_id, sum(sales), sum(number_sales)\n from (\n  select 'store' channel, i_brand_id, i_class_id, i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n  from store_sales, item, date_dim\n  where ss_item_sk in (select ss_item_sk from cross_items) and ss_item_sk = i_item_sk and ss_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)\n  union all\n  select 'catalog' channel, i_brand_id, i_class_id, i_category_id, sum(cs_quantity*cs_list_price) sales, count(*) number_sales\n  from catalog_sales, item, date_dim\n  where cs_item_sk in (select ss_item_sk from cross_items) and cs_item_sk = i_item_sk and cs_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(cs_quantity*cs_list_price) > (select average_sales from avg_sales)\n  union all\n  select 'web' channel, i_brand_id, i_class_id, i_category_id, sum(ws_quantity*ws_list_price) sales, count(*) number_sales\n  from web_sales, item, date_dim\n  where ws_item_sk in (select ss_item_sk from cross_items) and ws_item_sk = i_item_sk and ws_sold_date_sk = d_date_sk and d_year = 2000+2 and d_moy = 11\n  group by i_brand_id, i_class_id, i_category_id\n  having sum(ws_quantity*ws_list_price) > (select average_sales from avg_sales)\n ) y\n group by rollup (channel, i_brand_id, i_class_id, i_category_id)\n order by channel, i_brand_id, i_class_id, i_category_id\n LIMIT 100;",
  "optimized_sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 2000 AND 2002), cross_items AS (SELECT i_item_sk AS ss_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE EXISTS (SELECT 1 FROM store_sales JOIN item iss ON ss_item_sk = iss.i_item_sk JOIN filtered_dates d1 ON ss_sold_date_sk = d1.d_date_sk WHERE iss.i_brand_id = item.i_brand_id AND iss.i_class_id = item.i_class_id AND iss.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM catalog_sales JOIN item ics ON cs_item_sk = ics.i_item_sk JOIN filtered_dates d2 ON cs_sold_date_sk = d2.d_date_sk WHERE ics.i_brand_id = item.i_brand_id AND ics.i_class_id = item.i_class_id AND ics.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM web_sales JOIN item iws ON ws_item_sk = iws.i_item_sk JOIN filtered_dates d3 ON ws_sold_date_sk = d3.d_date_sk WHERE iws.i_brand_id = item.i_brand_id AND iws.i_class_id = item.i_class_id AND iws.i_category_id = item.i_category_id)), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity, cs_list_price FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity, ws_list_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk) x), nov2002_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 11), store_sales_data AS (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ss.ss_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ss.ss_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)), catalog_sales_data AS (SELECT 'catalog' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN nov2002_dates nd ON cs.cs_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = cs.cs_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales)), web_sales_data AS (SELECT 'web' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ws.ws_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ws.ws_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales))\nSELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales) AS \"SUM(sales)\", SUM(number_sales) AS \"SUM(number_sales)\" FROM (SELECT * FROM store_sales_data UNION ALL SELECT * FROM catalog_sales_data UNION ALL SELECT * FROM web_sales_data) y GROUP BY ROLLUP(channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel, i_brand_id, i_class_id, i_category_id LIMIT 100;",
  "optimized_source": "swarm_final_worker",
  "sf10_rows_match": true,
  "family": "D",
  "ir_node_map_before": "S0 [SELECT]\n  CTE: cross_items  (via CTE_Q_S0_cross_items)\n    FROM: item, (subquery) \n    WHERE [3f561bc366ff68bb]: i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id\n  CTE: avg_sales  (via CTE_Q_S0_avg_sales)\n    FROM: (subquery) x\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) y\n    ORDER BY: channel, i_brand_id, i_class_id, i_category_id\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: filtered_dates  (via CTE_Q_S0_filtered_dates)\n    FROM: date_dim\n    WHERE [cb445fc057c7c479]: d_year BETWEEN 2000 AND 2002\n  CTE: cross_items  (via CTE_Q_S0_cross_items)\n    FROM: item\n    WHERE [e24a3609eb5cc197]: EXISTS(SELECT 1 FROM store_sales JOIN item AS iss ON ss_item_sk = iss.i_item_sk JOIN filtered_dat...\n  CTE: avg_sales  (via CTE_Q_S0_avg_sales)\n    FROM: (subquery) x\n  CTE: nov2002_dates  (via CTE_Q_S0_nov2002_dates)\n    FROM: date_dim\n    WHERE [b7c24f0f8c3d8fdd]: d_year = 2002 AND d_moy = 11\n  CTE: store_sales_data  (via CTE_Q_S0_store_sales_data)\n    FROM: store_sales ss, item i, nov2002_dates nd\n    WHERE [624098a99e864725]: EXISTS(SELECT 1 FROM cross_items AS ci WHERE ci.ss_item_sk = ss.ss_item_sk)\n    GROUP BY: i.i_brand_id, i.i_class_id, i.i_category_id\n  CTE: catalog_sales_data  (via CTE_Q_S0_catalog_sales_data)\n    FROM: catalog_sales cs, item i, nov2002_dates nd\n    WHERE [be40a5e8d278b3bf]: EXISTS(SELECT 1 FROM cross_items AS ci WHERE ci.ss_item_sk = cs.cs_item_sk)\n    GROUP BY: i.i_brand_id, i.i_class_id, i.i_category_id\n  CTE: web_sales_data  (via CTE_Q_S0_web_sales_data)\n    FROM: web_sales ws, item i, nov2002_dates nd\n    WHERE [be1f08b0c604c3d7]: EXISTS(SELECT 1 FROM cross_items AS ci WHERE ci.ss_item_sk = ws.ws_item_sk)\n    GROUP BY: i.i_brand_id, i.i_class_id, i.i_category_id\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) y\n    ORDER BY: channel, i_brand_id, i_class_id, i_category_id\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "dialect": "duckdb",
  "transforms": [
    "intersect_to_exists"
  ],
  "families": [
    "D"
  ],
  "dag_example": {
    "plan_id": "gold_duckdb_multi_intersect_exists_cte",
    "dialect": "duckdb",
    "target_ir": "rewrite final_select to optimized query shape",
    "dag": {
      "order": [
        "final_select"
      ],
      "final_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "deps": [],
          "outputs": [
            "channel",
            "i_brand_id",
            "i_class_id",
            "i_category_id",
            "SUM(sales)",
            "SUM(number_sales)"
          ],
          "changed": true,
          "sql": "WITH filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 2000 AND 2002), cross_items AS (SELECT i_item_sk AS ss_item_sk, i_brand_id, i_class_id, i_category_id FROM item WHERE EXISTS (SELECT 1 FROM store_sales JOIN item iss ON ss_item_sk = iss.i_item_sk JOIN filtered_dates d1 ON ss_sold_date_sk = d1.d_date_sk WHERE iss.i_brand_id = item.i_brand_id AND iss.i_class_id = item.i_class_id AND iss.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM catalog_sales JOIN item ics ON cs_item_sk = ics.i_item_sk JOIN filtered_dates d2 ON cs_sold_date_sk = d2.d_date_sk WHERE ics.i_brand_id = item.i_brand_id AND ics.i_class_id = item.i_class_id AND ics.i_category_id = item.i_category_id) AND EXISTS (SELECT 1 FROM web_sales JOIN item iws ON ws_item_sk = iws.i_item_sk JOIN filtered_dates d3 ON ws_sold_date_sk = d3.d_date_sk WHERE iws.i_brand_id = item.i_brand_id AND iws.i_class_id = item.i_class_id AND iws.i_category_id = item.i_category_id)), avg_sales AS (SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity, cs_list_price FROM catalog_sales JOIN filtered_dates ON cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity, ws_list_price FROM web_sales JOIN filtered_dates ON ws_sold_date_sk = d_date_sk) x), nov2002_dates AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy = 11), store_sales_data AS (SELECT 'store' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales ss JOIN item i ON ss.ss_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ss.ss_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ss.ss_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales)), catalog_sales_data AS (SELECT 'catalog' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales cs JOIN item i ON cs.cs_item_sk = i.i_item_sk JOIN nov2002_dates nd ON cs.cs_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = cs.cs_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales)), web_sales_data AS (SELECT 'web' AS channel, i.i_brand_id, i.i_class_id, i.i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales ws JOIN item i ON ws.ws_item_sk = i.i_item_sk JOIN nov2002_dates nd ON ws.ws_sold_date_sk = nd.d_date_sk WHERE EXISTS (SELECT 1 FROM cross_items ci WHERE ci.ss_item_sk = ws.ws_item_sk) GROUP BY i.i_brand_id, i.i_class_id, i.i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales))\nSELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales) AS \"SUM(sales)\", SUM(number_sales) AS \"SUM(number_sales)\" FROM (SELECT * FROM store_sales_data UNION ALL SELECT * FROM catalog_sales_data UNION ALL SELECT * FROM web_sales_data) y GROUP BY ROLLUP(channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel, i_brand_id, i_class_id, i_category_id LIMIT 100"
        }
      ]
    }
  }
}
