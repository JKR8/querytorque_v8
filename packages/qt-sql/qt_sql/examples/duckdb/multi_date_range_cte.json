{
  "id": "multi_date_range_cte",
  "name": "Multi Date Range CTE",
  "description": "When query uses multiple date_dim aliases with different filters (d1, d2, d3), create separate CTEs for each date range and pre-join with fact tables",
  "verified_speedup": "2.35x",
  "principle": "Early Selection per Alias: when a query joins the same dimension table multiple times with different filters (d1, d2, d3), create separate CTEs for each filter and pre-join with fact tables to reduce rows entering the main join.",
  "example": {
    "opportunity": "MULTI DATE RANGE CTE",
    "input_slice": "SELECT i_item_id, i_item_desc, s_store_id, s_store_name,\n  sum(ss_quantity) AS store_sales_quantity,\n  sum(sr_return_quantity) AS store_returns_quantity,\n  sum(cs_quantity) AS catalog_sales_quantity\nFROM store_sales, store_returns, catalog_sales,\n  date_dim d1, date_dim d2, date_dim d3, store, item\nWHERE d1.d_moy = 9 AND d1.d_year = 1999 AND d1.d_date_sk = ss_sold_date_sk\n  AND d2.d_moy BETWEEN 9 AND 12 AND d2.d_year = 1999 AND sr_returned_date_sk = d2.d_date_sk\n  AND d3.d_year IN (1999, 2000, 2001) AND cs_sold_date_sk = d3.d_date_sk\n  AND ss_customer_sk = sr_customer_sk AND ss_item_sk = sr_item_sk AND ss_ticket_number = sr_ticket_number\n  AND sr_customer_sk = cs_bill_customer_sk AND sr_item_sk = cs_item_sk\nGROUP BY i_item_id, i_item_desc, s_store_id, s_store_name LIMIT 100",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "multi_date_range_cte",
          "nodes": {
            "d1_dates": "SELECT d_date_sk FROM date_dim WHERE d_moy = 9 AND d_year = 1999",
            "d2_dates": "SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 9 AND 12 AND d_year = 1999",
            "d3_dates": "SELECT d_date_sk FROM date_dim WHERE d_year IN (1999, 2000, 2001)",
            "filtered_store_sales": "SELECT ss_item_sk, ss_customer_sk, ss_ticket_number, ss_store_sk, ss_quantity FROM store_sales JOIN d1_dates ON store_sales.ss_sold_date_sk = d1_dates.d_date_sk",
            "filtered_store_returns": "SELECT sr_item_sk, sr_customer_sk, sr_ticket_number, sr_return_quantity FROM store_returns JOIN d2_dates ON store_returns.sr_returned_date_sk = d2_dates.d_date_sk",
            "filtered_catalog_sales": "SELECT cs_item_sk, cs_bill_customer_sk, cs_quantity FROM catalog_sales JOIN d3_dates ON catalog_sales.cs_sold_date_sk = d3_dates.d_date_sk",
            "main_query": "SELECT i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name, SUM(fss.ss_quantity) AS store_sales_quantity, SUM(fsr.sr_return_quantity) AS store_returns_quantity, SUM(fcs.cs_quantity) AS catalog_sales_quantity FROM filtered_store_sales AS fss JOIN filtered_store_returns AS fsr ON fss.ss_customer_sk = fsr.sr_customer_sk AND fss.ss_item_sk = fsr.sr_item_sk AND fss.ss_ticket_number = fsr.sr_ticket_number JOIN filtered_catalog_sales AS fcs ON fsr.sr_customer_sk = fcs.cs_bill_customer_sk AND fsr.sr_item_sk = fcs.cs_item_sk JOIN store AS s ON fss.ss_store_sk = s.s_store_sk JOIN item AS i ON fss.ss_item_sk = i.i_item_sk GROUP BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name ORDER BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name LIMIT 100"
          },
          "invariants_kept": [
            "same result rows",
            "same ordering",
            "same column output"
          ],
          "expected_speedup": "2.35x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Early Selection per Alias \u2014 when a query joins the same dimension table multiple times with different filters (d1, d2, d3 pattern), create separate filtered CTEs for each alias. Pre-join each date CTE with its corresponding fact table reference. This filters fact rows early before the expensive multi-way join, avoiding repeated full dimension scans."
  },
  "original_sql": "select  \n     i_item_id\n    ,i_item_desc\n    ,s_store_id\n    ,s_store_name\n    ,avg(ss_quantity)        as store_sales_quantity\n    ,avg(sr_return_quantity) as store_returns_quantity\n    ,avg(cs_quantity)        as catalog_sales_quantity\n from\n    store_sales\n   ,store_returns\n   ,catalog_sales\n   ,date_dim             d1\n   ,date_dim             d2\n   ,date_dim             d3\n   ,store\n   ,item\n where\n     d1.d_moy               = 4 \n and d1.d_year              = 1999\n and d1.d_date_sk           = ss_sold_date_sk\n and i_item_sk              = ss_item_sk\n and s_store_sk             = ss_store_sk\n and ss_customer_sk         = sr_customer_sk\n and ss_item_sk             = sr_item_sk\n and ss_ticket_number       = sr_ticket_number\n and sr_returned_date_sk    = d2.d_date_sk\n and d2.d_moy               between 4 and  4 + 3 \n and d2.d_year              = 1999\n and sr_customer_sk         = cs_bill_customer_sk\n and sr_item_sk             = cs_item_sk\n and cs_sold_date_sk        = d3.d_date_sk     \n and d3.d_year              in (1999,1999+1,1999+2)\n group by\n    i_item_id\n   ,i_item_desc\n   ,s_store_id\n   ,s_store_name\n order by\n    i_item_id \n   ,i_item_desc\n   ,s_store_id\n   ,s_store_name\n LIMIT 100;",
  "optimized_sql": "WITH d1_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy = 4 AND d_year = 1999), d2_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 4 AND 7 AND d_year = 1999), d3_filtered AS (SELECT d_date_sk FROM date_dim WHERE d_year IN (1999, 2000, 2001)), filtered_store_sales AS (SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_customer_sk, ss.ss_ticket_number, ss.ss_quantity FROM store_sales AS ss JOIN d1_filtered AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk), filtered_store_returns AS (SELECT sr.sr_customer_sk, sr.sr_item_sk, sr.sr_ticket_number, sr.sr_return_quantity FROM store_returns AS sr JOIN d2_filtered AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk), filtered_catalog_sales AS (SELECT cs.cs_bill_customer_sk, cs.cs_item_sk, cs.cs_quantity FROM catalog_sales AS cs JOIN d3_filtered AS d3 ON cs.cs_sold_date_sk = d3.d_date_sk)\nSELECT i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name, AVG(ss.ss_quantity) AS store_sales_quantity, AVG(sr.sr_return_quantity) AS store_returns_quantity, AVG(cs.cs_quantity) AS catalog_sales_quantity FROM filtered_store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_store_returns AS sr ON ss.ss_customer_sk = sr.sr_customer_sk AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN filtered_catalog_sales AS cs ON sr.sr_customer_sk = cs.cs_bill_customer_sk AND sr.sr_item_sk = cs.cs_item_sk GROUP BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name ORDER BY i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name LIMIT 100;",
  "optimized_source": "kimi",
  "family": "A",
  "patch_plan": {
    "plan_id": "gold_duckdb_multi_date_range_cte",
    "dialect": "duckdb",
    "description": "When query uses multiple date_dim aliases with different filters (d1, d2, d3), create separate CTEs for each date range and pre-join with fact tables",
    "preconditions": [
      {
        "kind": "parse_ok"
      }
    ],
    "postconditions": [
      {
        "kind": "parse_ok"
      }
    ],
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "d1_filtered",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_moy = 4 AND d_year = 1999"
        },
        "description": "Insert CTE 'd1_filtered' for date dimension filtering"
      },
      {
        "step_id": "s2",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "d2_filtered",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_moy BETWEEN 4 AND 7 AND d_year = 1999"
        },
        "description": "Insert CTE 'd2_filtered' for date dimension filtering"
      },
      {
        "step_id": "s3",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "d3_filtered",
          "cte_query_sql": "SELECT d_date_sk FROM date_dim WHERE d_year IN (1999, 2000, 2001)"
        },
        "description": "Insert CTE 'd3_filtered' for date dimension filtering"
      },
      {
        "step_id": "s4",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "filtered_store_sales",
          "cte_query_sql": "SELECT ss.ss_item_sk, ss.ss_store_sk, ss.ss_customer_sk, ss.ss_ticket_number, ss.ss_quantity FROM store_sales AS ss JOIN d1_filtered AS d1 ON ss.ss_sold_date_sk = d1.d_date_sk"
        },
        "description": "Insert CTE 'filtered_store_sales' for date dimension filtering"
      },
      {
        "step_id": "s5",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "filtered_store_returns",
          "cte_query_sql": "SELECT sr.sr_customer_sk, sr.sr_item_sk, sr.sr_ticket_number, sr.sr_return_quantity FROM store_returns AS sr JOIN d2_filtered AS d2 ON sr.sr_returned_date_sk = d2.d_date_sk"
        },
        "description": "Insert CTE 'filtered_store_returns' for date dimension filtering"
      },
      {
        "step_id": "s6",
        "op": "insert_cte",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "cte_name": "filtered_catalog_sales",
          "cte_query_sql": "SELECT cs.cs_bill_customer_sk, cs.cs_item_sk, cs.cs_quantity FROM catalog_sales AS cs JOIN d3_filtered AS d3 ON cs.cs_sold_date_sk = d3.d_date_sk"
        },
        "description": "Insert CTE 'filtered_catalog_sales' for date dimension filtering"
      },
      {
        "step_id": "s7",
        "op": "replace_from",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "from_sql": "filtered_store_sales AS ss JOIN item AS i ON ss.ss_item_sk = i.i_item_sk JOIN store AS s ON ss.ss_store_sk = s.s_store_sk JOIN filtered_store_returns AS sr ON ss.ss_customer_sk = sr.sr_customer_sk AND ss.ss_item_sk = sr.sr_item_sk AND ss.ss_ticket_number = sr.sr_ticket_number JOIN filtered_catalog_sales AS cs ON sr.sr_customer_sk = cs.cs_bill_customer_sk AND sr.sr_item_sk = cs.cs_item_sk"
        },
        "description": "Replace comma-join FROM with explicit JOINs"
      },
      {
        "step_id": "s8",
        "op": "delete_expr_subtree",
        "target": {
          "by_node_id": "S0",
          "by_anchor_hash": "71927f19345ff8e4"
        },
        "description": "Remove WHERE clause (conditions moved to CTEs)"
      }
    ]
  },
  "ir_node_map_before": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: store_sales, store_returns, catalog_sales, date_dim d1, date_dim d2, date_dim d3, store, item\n    WHERE [71927f19345ff8e4]: d1.d_moy = 4 AND d1.d_year = 1999 AND d1.d_date_sk = ss_sold_date_sk AND i_item_sk = ss_item_sk A...\n    GROUP BY: i_item_id, i_item_desc, s_store_id, s_store_name\n    ORDER BY: i_item_id, i_item_desc, s_store_id, s_store_name\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: d1_filtered  (via CTE_Q_S0_d1_filtered)\n    FROM: date_dim\n    WHERE [29155e96e4783f98]: d_moy = 4 AND d_year = 1999\n  CTE: d2_filtered  (via CTE_Q_S0_d2_filtered)\n    FROM: date_dim\n    WHERE [33674997f893a3df]: d_moy BETWEEN 4 AND 7 AND d_year = 1999\n  CTE: d3_filtered  (via CTE_Q_S0_d3_filtered)\n    FROM: date_dim\n    WHERE [b653aab07ba6640d]: d_year IN (1999, 2000, 2001)\n  CTE: filtered_store_sales  (via CTE_Q_S0_filtered_store_sales)\n    FROM: store_sales ss, d1_filtered d1\n  CTE: filtered_store_returns  (via CTE_Q_S0_filtered_store_returns)\n    FROM: store_returns sr, d2_filtered d2\n  CTE: filtered_catalog_sales  (via CTE_Q_S0_filtered_catalog_sales)\n    FROM: catalog_sales cs, d3_filtered d3\n  MAIN QUERY (via Q_S0)\n    FROM: filtered_store_sales ss, item i, store s, filtered_store_returns sr, filtered_catalog_sales cs\n    GROUP BY: i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name\n    ORDER BY: i.i_item_id, i.i_item_desc, s.s_store_id, s.s_store_name\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)"
}
