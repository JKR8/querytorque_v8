{
  "id": "materialize_cte",
  "name": "Materialize Repeated Subquery",
  "description": "Extract repeated subquery patterns into a CTE to avoid recomputation",
  "verified_speedup": "1.37x",
  "principle": "Shared Materialization: extract repeated subquery patterns into CTEs to avoid recomputation. When the same logical check appears multiple times, compute it once and reference the result.",
  "example": {
    "opportunity": "MATERIALIZE_CTE",
    "input_slice": "[main_query]:\nSELECT COUNT(DISTINCT ws_order_number) AS order_count,\n       SUM(ws_ext_ship_cost) AS total_shipping\nFROM web_sales ws1, date_dim, customer_address, web_site\nWHERE d_date BETWEEN '2000-03-01' AND '2000-05-01'\n  AND ws1.ws_ship_date_sk = d_date_sk\n  AND ws1.ws_ship_addr_sk = ca_address_sk\n  AND ca_state = 'IL'\n  AND ws1.ws_web_site_sk = web_site_sk\n  AND web_company_name = 'pri'\n  AND EXISTS (SELECT * FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n  AND NOT EXISTS (SELECT * FROM web_returns wr1 WHERE ws1.ws_order_number = wr1.wr_order_number)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "materialize_cte",
          "nodes": {
            "multi_warehouse_orders": "SELECT DISTINCT ws_order_number FROM web_sales ws1 WHERE EXISTS (SELECT 1 FROM web_sales ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)",
            "returned_orders": "SELECT DISTINCT wr_order_number FROM web_returns",
            "main_query": "SELECT COUNT(DISTINCT ws_order_number) AS order_count, SUM(ws_ext_ship_cost) AS total_shipping FROM web_sales ws1 JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk JOIN multi_warehouse_orders mwo ON ws1.ws_order_number = mwo.ws_order_number LEFT JOIN returned_orders ro ON ws1.ws_order_number = ro.wr_order_number WHERE d_date BETWEEN '2000-03-01' AND '2000-05-01' AND ca_state = 'IL' AND web_company_name = 'pri' AND ro.wr_order_number IS NULL"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation"
          ],
          "expected_speedup": "1.8x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Shared Materialization \u2014 extract repeated subquery patterns into CTEs to avoid recomputation. When the same logical check appears in multiple places (EXISTS, WHERE, JOIN), computing it once as a CTE and referencing it is cheaper. Here: extract multi-warehouse order detection into one CTE, returned orders into another, then JOIN instead of nested EXISTS checks.",
    "when_not_to_use": "NEVER convert EXISTS or NOT EXISTS subqueries into materialized CTEs when the EXISTS is used as a filter (not a data source). EXISTS uses semi-join short-circuiting \u2014 the database stops scanning as soon as one match is found. Materializing into a CTE forces a full scan of the subquery table, destroying this optimization. Caused 0.14x when EXISTS on catalog_sales was materialized into a full CTE scan and 0.54x when EXISTS on web_sales was forced into full materialization."
  },
  "original_sql": "with ws_wh as\n(select ws1.ws_order_number,ws1.ws_warehouse_sk wh1,ws2.ws_warehouse_sk wh2\n from web_sales ws1,web_sales ws2\n where ws1.ws_order_number = ws2.ws_order_number\n   and ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\n select \n   count(distinct ws_order_number) as \"order count\"\n  ,sum(ws_ext_ship_cost) as \"total shipping cost\"\n  ,sum(ws_net_profit) as \"total net profit\"\nfrom\n   web_sales ws1\n  ,date_dim\n  ,customer_address\n  ,web_site\nwhere\n    d_date between '1999-2-01' and \n           (cast('1999-2-01' as date) + INTERVAL 60 DAY)\nand ws1.ws_ship_date_sk = d_date_sk\nand ws1.ws_ship_addr_sk = ca_address_sk\nand ca_state = 'NC'\nand ws1.ws_web_site_sk = web_site_sk\nand web_company_name = 'pri'\nand ws1.ws_order_number in (select ws_order_number\n                            from ws_wh)\nand ws1.ws_order_number in (select wr_order_number\n                            from web_returns,ws_wh\n                            where wr_order_number = ws_wh.ws_order_number)\norder by count(distinct ws_order_number)\n LIMIT 100;",
  "optimized_sql": "WITH ws_wh AS (SELECT ws1.ws_order_number, ws1.ws_warehouse_sk AS wh1, ws2.ws_warehouse_sk AS wh2 FROM web_sales AS ws1, web_sales AS ws2 WHERE ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)\nSELECT COUNT(DISTINCT ws_order_number) AS \"order count\", SUM(ws_ext_ship_cost) AS \"total shipping cost\", SUM(ws_net_profit) AS \"total net profit\" FROM web_sales AS ws1 JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk WHERE d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY) AND ca_state = 'NC' AND web_company_name = 'pri' AND EXISTS(SELECT 1 FROM ws_wh WHERE ws_wh.ws_order_number = ws1.ws_order_number) AND EXISTS(SELECT 1 FROM web_returns JOIN ws_wh ON wr_order_number = ws_wh.ws_order_number WHERE wr_order_number = ws1.ws_order_number) ORDER BY COUNT(DISTINCT ws_order_number) LIMIT 100;",
  "optimized_source": "kimi",
  "sf10_rows_match": true,
  "family": "E",
  "patch_plan": {
    "plan_id": "gold_duckdb_materialize_cte",
    "dialect": "duckdb",
    "description": "Extract repeated subquery patterns into a CTE to avoid recomputation",
    "preconditions": [
      {
        "kind": "parse_ok"
      }
    ],
    "postconditions": [
      {
        "kind": "parse_ok"
      }
    ],
    "steps": [
      {
        "step_id": "s1",
        "op": "replace_from",
        "target": {
          "by_node_id": "S0"
        },
        "payload": {
          "from_sql": "web_sales AS ws1 JOIN date_dim ON ws1.ws_ship_date_sk = d_date_sk JOIN customer_address ON ws1.ws_ship_addr_sk = ca_address_sk JOIN web_site ON ws1.ws_web_site_sk = web_site_sk"
        },
        "description": "Replace comma-join FROM with explicit JOINs"
      },
      {
        "step_id": "s2",
        "op": "replace_where_predicate",
        "target": {
          "by_node_id": "S0",
          "by_anchor_hash": "80ee6b9f8f62284b"
        },
        "payload": {
          "expr_sql": "d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY) AND ca_state = 'NC' AND web_company_name = 'pri' AND EXISTS(SELECT 1 FROM ws_wh WHERE ws_wh.ws_order_number = ws1.ws_order_number) AND EXISTS(SELECT 1 FROM web_returns JOIN ws_wh ON wr_order_number = ws_wh.ws_order_number WHERE wr_order_number = ws1.ws_order_number)"
        },
        "description": "Replace WHERE predicate with optimized version"
      }
    ]
  },
  "ir_node_map_before": "S0 [SELECT]\n  CTE: ws_wh  (via CTE_Q_S0_ws_wh)\n    FROM: web_sales ws1, web_sales ws2\n    WHERE [268f6e93aa72c351]: ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk\n  MAIN QUERY (via Q_S0)\n    FROM: web_sales ws1, date_dim, customer_address, web_site\n    WHERE [80ee6b9f8f62284b]: d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY) AND ws1.ws_ship_da...\n    ORDER BY: COUNT(DISTINCT ws_order_number)\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: ws_wh  (via CTE_Q_S0_ws_wh)\n    FROM: web_sales ws1, web_sales ws2\n    WHERE [268f6e93aa72c351]: ws1.ws_order_number = ws2.ws_order_number AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk\n  MAIN QUERY (via Q_S0)\n    FROM: web_sales ws1, date_dim, customer_address, web_site\n    WHERE [346390125c1ff549]: d_date BETWEEN '1999-2-01' AND (CAST('1999-2-01' AS DATE) + INTERVAL '60' DAY) AND ca_state = 'NC...\n    ORDER BY: COUNT(DISTINCT ws_order_number)\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)"
}
