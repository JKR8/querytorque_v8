{
  "id": "channel_bitmap_aggregation",
  "name": "Channel Bitmap Aggregation",
  "description": "Consolidate repeated scans of the same fact table (one per time/channel bucket) into a single scan with CASE WHEN labels and conditional aggregation",
  "verified_speedup": "6.24x",
  "example": {
    "opportunity": "SINGLE_PASS_AGGREGATION + DIMENSION_CTE_ISOLATE",
    "input_slice": "select * from\n (select count(*) h8_30_to_9\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 8 and time_dim.t_minute >= 30\n   and ((hd_dep_count = -1 and hd_vehicle_count <= 1) or ...)\n   and store.s_store_name = 'ese') s1,\n (select count(*) h9_to_9_30 ...same pattern for 8 time buckets...)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "single_pass_aggregation",
          "nodes": {
            "filtered_store": "SELECT s_store_sk FROM store WHERE s_store_name = 'ese'",
            "filtered_hd": "SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = -1 AND hd_vehicle_count <= 1) OR (hd_dep_count = 4 AND hd_vehicle_count <= 6) OR (hd_dep_count = 3 AND hd_vehicle_count <= 5)",
            "time_ranges": "SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_window FROM time_dim WHERE (t_hour BETWEEN 8 AND 12)",
            "sales_with_time": "SELECT tr.time_window FROM store_sales ss JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_hd fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN time_ranges tr ON ss.ss_sold_time_sk = tr.t_time_sk",
            "main_query": "SELECT COUNT(CASE WHEN time_window = 1 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN time_window = 2 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN time_window = 3 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN time_window = 4 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN time_window = 5 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN time_window = 6 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN time_window = 7 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN time_window = 8 THEN 1 END) AS h12_to_12_30 FROM sales_with_time"
          },
          "invariants_kept": [
            "output columns unchanged",
            "same row counts per bucket"
          ],
          "expected_speedup": "6.24x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "The original query scans store_sales 8 times (once per time bucket), each with identical dimension joins. Consolidating into a single scan with CASE WHEN labels inside COUNT() reduces I/O from 8x to 1x. Dimension pre-filtering CTEs further reduce the join probe size.",
    "when_not_to_use": "Do not use when the number of distinct buckets exceeds 8 (diminishing returns from CASE evaluation overhead). Also not applicable when each subquery has structurally different joins or table references."
  },
  "original_sql": "select * from\n (select count(*) h8_30_to_9\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 8 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s1,\n (select count(*) h9_to_9_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 9 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s2,\n (select count(*) h9_30_to_10\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 9 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s3,\n (select count(*) h10_to_10_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 10 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s4,\n (select count(*) h10_30_to_11\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 10 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s5,\n (select count(*) h11_to_11_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 11 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s6,\n (select count(*) h11_30_to_12\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 11 and time_dim.t_minute >= 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s7,\n (select count(*) h12_to_12_30\n from store_sales, household_demographics, time_dim, store\n where ss_sold_time_sk = time_dim.t_time_sk\n   and ss_hdemo_sk = household_demographics.hd_demo_sk\n   and ss_store_sk = s_store_sk\n   and time_dim.t_hour = 12 and time_dim.t_minute < 30\n   and ((household_demographics.hd_dep_count = -1 and household_demographics.hd_vehicle_count<=-1+2) or\n        (household_demographics.hd_dep_count = 4 and household_demographics.hd_vehicle_count<=4+2) or\n        (household_demographics.hd_dep_count = 3 and household_demographics.hd_vehicle_count<=3+2))\n   and store.s_store_name = 'ese') s8;",
  "optimized_sql": "WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = -1 AND hd_vehicle_count <= -1 + 2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4 + 2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3 + 2)), time_ranges AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_window FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), sales_with_time AS (SELECT tr.time_window FROM store_sales ss JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_hd fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN time_ranges tr ON ss.ss_sold_time_sk = tr.t_time_sk)\nSELECT COUNT(CASE WHEN time_window = 1 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN time_window = 2 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN time_window = 3 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN time_window = 4 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN time_window = 5 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN time_window = 6 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN time_window = 7 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN time_window = 8 THEN 1 END) AS h12_to_12_30 FROM sales_with_time;",
  "optimized_source": "swarm_w2",
  "sf10_rows_match": true,
  "family": "C",
  "ir_node_map_before": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) s1, (subquery) s2, (subquery) s3, (subquery) s4, (subquery) s5, (subquery) s6, (subquery) s7, (subquery) s8\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: filtered_store  (via CTE_Q_S0_filtered_store)\n    FROM: store\n    WHERE [a3f99d93f88bca07]: s_store_name = 'ese'\n  CTE: filtered_hd  (via CTE_Q_S0_filtered_hd)\n    FROM: household_demographics\n    WHERE [287dba843691dcdf]: (hd_dep_count = -1 AND hd_vehicle_count <= -1 + 2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4...\n  CTE: time_ranges  (via CTE_Q_S0_time_ranges)\n    FROM: time_dim\n    WHERE [ee87b852d602c284]: (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= ...\n  CTE: sales_with_time  (via CTE_Q_S0_sales_with_time)\n    FROM: store_sales ss, filtered_store fs, filtered_hd fhd, time_ranges tr\n  MAIN QUERY (via Q_S0)\n    FROM: sales_with_time\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "dialect": "duckdb",
  "transforms": [
    "single_pass_aggregation"
  ],
  "families": [
    "C"
  ],
  "gap_ids": [
    "REDUNDANT_SCAN_ELIMINATION"
  ],
  "tree_example": {
    "plan_id": "gold_duckdb_channel_bitmap_aggregation",
    "dialect": "duckdb",
    "target_ir": "rewrite final_select to optimized query shape",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "h8_30_to_9",
            "h9_to_9_30",
            "h9_30_to_10",
            "h10_to_10_30",
            "h10_30_to_11",
            "h11_to_11_30",
            "h11_30_to_12",
            "h12_to_12_30"
          ],
          "changed": true,
          "sql": "WITH filtered_store AS (SELECT s_store_sk FROM store WHERE s_store_name = 'ese'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE (hd_dep_count = -1 AND hd_vehicle_count <= -1 + 2) OR (hd_dep_count = 4 AND hd_vehicle_count <= 4 + 2) OR (hd_dep_count = 3 AND hd_vehicle_count <= 3 + 2)), time_ranges AS (SELECT t_time_sk, CASE WHEN t_hour = 8 AND t_minute >= 30 THEN 1 WHEN t_hour = 9 AND t_minute < 30 THEN 2 WHEN t_hour = 9 AND t_minute >= 30 THEN 3 WHEN t_hour = 10 AND t_minute < 30 THEN 4 WHEN t_hour = 10 AND t_minute >= 30 THEN 5 WHEN t_hour = 11 AND t_minute < 30 THEN 6 WHEN t_hour = 11 AND t_minute >= 30 THEN 7 WHEN t_hour = 12 AND t_minute < 30 THEN 8 END AS time_window FROM time_dim WHERE (t_hour = 8 AND t_minute >= 30) OR (t_hour = 9 AND t_minute < 30) OR (t_hour = 9 AND t_minute >= 30) OR (t_hour = 10 AND t_minute < 30) OR (t_hour = 10 AND t_minute >= 30) OR (t_hour = 11 AND t_minute < 30) OR (t_hour = 11 AND t_minute >= 30) OR (t_hour = 12 AND t_minute < 30)), sales_with_time AS (SELECT tr.time_window FROM store_sales ss JOIN filtered_store fs ON ss.ss_store_sk = fs.s_store_sk JOIN filtered_hd fhd ON ss.ss_hdemo_sk = fhd.hd_demo_sk JOIN time_ranges tr ON ss.ss_sold_time_sk = tr.t_time_sk)\nSELECT COUNT(CASE WHEN time_window = 1 THEN 1 END) AS h8_30_to_9, COUNT(CASE WHEN time_window = 2 THEN 1 END) AS h9_to_9_30, COUNT(CASE WHEN time_window = 3 THEN 1 END) AS h9_30_to_10, COUNT(CASE WHEN time_window = 4 THEN 1 END) AS h10_to_10_30, COUNT(CASE WHEN time_window = 5 THEN 1 END) AS h10_30_to_11, COUNT(CASE WHEN time_window = 6 THEN 1 END) AS h11_to_11_30, COUNT(CASE WHEN time_window = 7 THEN 1 END) AS h11_30_to_12, COUNT(CASE WHEN time_window = 8 THEN 1 END) AS h12_to_12_30 FROM sales_with_time"
        }
      ]
    }
  }
}
