{
  "id": "pg_single_pass_aggregation",
  "name": "Single-Pass Channel Aggregation (PostgreSQL)",
  "description": "Consolidate multiple fact table scans (store_sales, catalog_sales, web_sales) into a single UNION ALL CTE, then use shared item/dimension filters to reduce redundant I/O. The consolidated CTE scans each fact table once instead of N times across N INTERSECT branches.",
  "engine": "postgresql",
  "benchmark": "DSB SF10",
  "verified_speedup": "1.98x",
  "principle": "Single-Pass Channel Aggregation: when a query scans store_sales, catalog_sales, and web_sales with identical item/date filters for INTERSECT or cross-channel comparison, consolidate all 3 scans into a single UNION ALL CTE with a channel discriminator column. Downstream queries filter by channel tag instead of re-scanning.",
  "transforms": [
    "single_pass_aggregation"
  ],
  "original_sql": "with  cross_items as\n (select i_item_sk ss_item_sk\n from item,\n (select iss.i_brand_id brand_id\n     ,iss.i_class_id class_id\n     ,iss.i_category_id category_id\n from store_sales\n     ,item iss\n     ,date_dim d1\n where ss_item_sk = iss.i_item_sk\n   and ss_sold_date_sk = d1.d_date_sk\n   and d1.d_year between 1999 AND 1999 + 2\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and i_manager_id BETWEEN 91 and 100\n   and ss_wholesale_cost BETWEEN 35 AND 55\nintersect\n select ics.i_brand_id\n     ,ics.i_class_id\n     ,ics.i_category_id\n from catalog_sales\n     ,item ics\n     ,date_dim d2\n where cs_item_sk = ics.i_item_sk\n   and cs_sold_date_sk = d2.d_date_sk\n   and d2.d_year between 1999 AND 1999 + 2\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and i_manager_id BETWEEN 91 and 100\n   and cs_wholesale_cost BETWEEN 35 AND 55\nintersect\n select iws.i_brand_id\n     ,iws.i_class_id\n     ,iws.i_category_id\n from web_sales\n     ,item iws\n     ,date_dim d3\n where ws_item_sk = iws.i_item_sk\n   and ws_sold_date_sk = d3.d_date_sk\n   and ws_wholesale_cost BETWEEN 35 AND 55\n   and d3.d_year between 1999 AND 1999 + 2) x\n where i_brand_id = brand_id\n      and i_class_id = class_id\n      and i_category_id = category_id\n      and i_category IN ('Electronics', 'Jewelry', 'Men')\n      and i_manager_id BETWEEN 91 and 100\n),\n avg_sales as\n(select avg(quantity*list_price) average_sales\n  from (select ss_quantity quantity\n             ,ss_list_price list_price\n       from store_sales\n           ,date_dim\n       where ss_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and ss_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select cs_quantity quantity\n             ,cs_list_price list_price\n       from catalog_sales\n           ,date_dim\n       where cs_sold_date_sk = d_date_sk\n         and d_year between 1999 and 1999 + 2\n         and cs_wholesale_cost BETWEEN 35 AND 55\n       union all\n       select ws_quantity quantity\n             ,ws_list_price list_price\n       from web_sales\n           ,date_dim\n       where ws_sold_date_sk = d_date_sk\n        and ws_wholesale_cost BETWEEN 35 AND 55\n         and d_year between 1999 and 1999 + 2) x)\n  select  this_year.channel ty_channel\n                           ,this_year.i_brand_id ty_brand\n                           ,this_year.i_class_id ty_class\n                           ,this_year.i_category_id ty_category\n                           ,this_year.sales ty_sales\n                           ,this_year.number_sales ty_number_sales\n                           ,last_year.channel ly_channel\n                           ,last_year.i_brand_id ly_brand\n                           ,last_year.i_class_id ly_class\n                           ,last_year.i_category_id ly_category\n                           ,last_year.sales ly_sales\n                           ,last_year.number_sales ly_number_sales\n from\n (select 'store' channel, i_brand_id,i_class_id,i_category_id\n        ,sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n     ,item\n     ,date_dim\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and ss_item_sk = i_item_sk\n   and ss_sold_date_sk = d_date_sk\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999 + 1\n                       and d_moy = 12\n                       and d_dom = 20)\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and i_manager_id BETWEEN 91 and 100\n   and ss_wholesale_cost BETWEEN 35 AND 55\n group by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) this_year,\n (select 'store' channel, i_brand_id,i_class_id\n        ,i_category_id, sum(ss_quantity*ss_list_price) sales, count(*) number_sales\n from store_sales\n     ,item\n     ,date_dim\n where ss_item_sk in (select ss_item_sk from cross_items)\n   and ss_item_sk = i_item_sk\n   and ss_sold_date_sk = d_date_sk\n   and d_week_seq = (select d_week_seq\n                     from date_dim\n                     where d_year = 1999\n                       and d_moy = 12\n                       and d_dom = 20)\n   and i_category IN ('Electronics', 'Jewelry', 'Men')\n   and ss_wholesale_cost BETWEEN 35 AND 55\n   and i_manager_id BETWEEN 91 and 100\ngroup by i_brand_id,i_class_id,i_category_id\n having sum(ss_quantity*ss_list_price) > (select average_sales from avg_sales)) last_year\n where this_year.i_brand_id= last_year.i_brand_id\n   and this_year.i_class_id = last_year.i_class_id\n   and this_year.i_category_id = last_year.i_category_id\n order by this_year.channel, this_year.i_brand_id, this_year.i_class_id, this_year.i_category_id\n limit 100;",
  "optimized_sql": "WITH consolidated_sales AS (\n  SELECT 'store' AS channel, ss_item_sk AS item_sk, i_brand_id, i_class_id,\n         i_category_id, ss_quantity AS quantity, ss_list_price AS list_price,\n         d_date_sk, d_week_seq\n  FROM store_sales\n  JOIN item ON ss_item_sk = i_item_sk\n  JOIN date_dim ON ss_sold_date_sk = d_date_sk\n  WHERE d_year BETWEEN 1999 AND 2001\n    AND i_category IN ('Electronics', 'Jewelry', 'Men')\n    AND i_manager_id BETWEEN 91 AND 100\n    AND ss_wholesale_cost BETWEEN 35 AND 55\n  UNION ALL\n  SELECT 'catalog', cs_item_sk, i_brand_id, i_class_id, i_category_id,\n         cs_quantity, cs_list_price, d_date_sk, d_week_seq\n  FROM catalog_sales\n  JOIN item ON cs_item_sk = i_item_sk\n  JOIN date_dim ON cs_sold_date_sk = d_date_sk\n  WHERE d_year BETWEEN 1999 AND 2001\n    AND i_category IN ('Electronics', 'Jewelry', 'Men')\n    AND i_manager_id BETWEEN 91 AND 100\n    AND cs_wholesale_cost BETWEEN 35 AND 55\n  UNION ALL\n  SELECT 'web', ws_item_sk, i_brand_id, i_class_id, i_category_id,\n         ws_quantity, ws_list_price, d_date_sk, d_week_seq\n  FROM web_sales\n  JOIN item ON ws_item_sk = i_item_sk\n  JOIN date_dim ON ws_sold_date_sk = d_date_sk\n  WHERE d_year BETWEEN 1999 AND 2001\n    AND i_category IN ('Electronics', 'Jewelry', 'Men')\n    AND i_manager_id BETWEEN 91 AND 100\n    AND ws_wholesale_cost BETWEEN 35 AND 55\n),\ncross_items AS (\n  SELECT i_item_sk AS ss_item_sk\n  FROM item\n  WHERE i_category IN ('Electronics', 'Jewelry', 'Men')\n    AND i_manager_id BETWEEN 91 AND 100\n    AND (i_brand_id, i_class_id, i_category_id) IN (\n      SELECT i_brand_id, i_class_id, i_category_id\n      FROM consolidated_sales WHERE channel = 'store'\n      INTERSECT\n      SELECT i_brand_id, i_class_id, i_category_id\n      FROM consolidated_sales WHERE channel = 'catalog'\n      INTERSECT\n      SELECT i_brand_id, i_class_id, i_category_id\n      FROM consolidated_sales WHERE channel = 'web'\n    )\n),\navg_sales AS (\n  SELECT AVG(quantity * list_price) AS average_sales\n  FROM consolidated_sales\n)\nSELECT 'store' AS channel,\n       ty.i_brand_id, ty.i_class_id, ty.i_category_id,\n       ty.sales AS this_year_sales, ty.number_sales AS this_year_count,\n       ly.sales AS last_year_sales, ly.number_sales AS last_year_count\nFROM (\n  SELECT i_brand_id, i_class_id, i_category_id,\n         SUM(quantity * list_price) AS sales, COUNT(*) AS number_sales\n  FROM consolidated_sales cs\n  JOIN cross_items ci ON cs.item_sk = ci.ss_item_sk\n  WHERE cs.d_week_seq = (SELECT d_week_seq FROM date_dim\n                         WHERE d_year = 2000 AND d_moy = 12 AND d_dom = 20)\n  GROUP BY i_brand_id, i_class_id, i_category_id\n  HAVING SUM(quantity * list_price) > (SELECT average_sales FROM avg_sales)\n) ty\nJOIN (\n  SELECT i_brand_id, i_class_id, i_category_id,\n         SUM(quantity * list_price) AS sales, COUNT(*) AS number_sales\n  FROM consolidated_sales cs\n  JOIN cross_items ci ON cs.item_sk = ci.ss_item_sk\n  WHERE cs.d_week_seq = (SELECT d_week_seq FROM date_dim\n                         WHERE d_year = 1999 AND d_moy = 12 AND d_dom = 20)\n  GROUP BY i_brand_id, i_class_id, i_category_id\n  HAVING SUM(quantity * list_price) > (SELECT average_sales FROM avg_sales)\n) ly ON ty.i_brand_id = ly.i_brand_id\n   AND ty.i_class_id = ly.i_class_id\n   AND ty.i_category_id = ly.i_category_id\nORDER BY channel, ty.i_brand_id, ty.i_class_id, ty.i_category_id\nLIMIT 100;",
  "example": {
    "opportunity": "SINGLE_PASS_AGGREGATION",
    "input_slice": "3 separate INTERSECT branches scanning store_sales + item + date_dim, catalog_sales + item + date_dim, web_sales + item + date_dim with identical item/date/cost filters",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "single_pass_aggregation",
          "nodes": {
            "consolidated_sales": "UNION ALL of all 3 channels with channel discriminator column, shared item/date/cost filters",
            "cross_items": "INTERSECT on consolidated_sales filtered by channel tag",
            "avg_sales": "AVG computed from consolidated_sales (single pass)"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation"
          ],
          "expected_speedup": "2.0x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Single-Pass Channel Aggregation \u2014 when store_sales, catalog_sales, and web_sales are scanned with identical item/date filters for INTERSECT or cross-channel comparison, consolidate into one UNION ALL CTE with a 'channel' discriminator. Downstream INTERSECT operates on the same CTE filtered by channel tag, avoiding 3x redundant dimension joins.",
    "pattern_detection": "Look for: (1) 3 INTERSECT branches or 3 UNION ALL subqueries, (2) each scanning a different fact table (store/catalog/web), (3) identical item + date + cost filters across all 3. The consolidation reduces 9 dimension joins to 3."
  },
  "family": "F"
}