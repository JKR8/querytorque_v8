{
  "id": "pg_shared_scan_decorrelate",
  "name": "Shared Scan Decorrelation (PostgreSQL)",
  "description": "When a correlated subquery re-scans the same fact table as the outer query, extract the common scan into a shared CTE, then derive both the threshold computation and the outer rows from a single materialized result. Eliminates O(N*M) re-execution of the fact+date join.",
  "benchmark": "DSB SF10",
  "verified_speedup": "8043.91x (timeout rescue)",
  "principle": "Shared Scan Decorrelation: when inner and outer queries scan the same fact table with the same date/cost filters, extract the common scan into a single CTE. Then compute per-item thresholds via GROUP BY in a second CTE, and JOIN back to filter. Converts O(N*M) correlated execution to O(N+M) hash join.",
  "transforms": [
    "decorrelate"
  ],
  "original_sql": "select \n   sum(ws_ext_discount_amt)  as \"Excess Discount Amount\"\nfrom\n    web_sales\n   ,item\n   ,date_dim\nwhere\n(i_manufact_id BETWEEN 341 and 540\nor i_category IN ('Home', 'Men', 'Music'))\nand i_item_sk = ws_item_sk\nand d_date between '1998-03-13' and\n        cast('1998-03-13' as date) + interval '90 day'\nand d_date_sk = ws_sold_date_sk\nand ws_wholesale_cost BETWEEN 26 AND 46\nand ws_ext_discount_amt\n     > (\n         SELECT\n            1.3 * avg(ws_ext_discount_amt)\n         FROM\n            web_sales\n           ,date_dim\n         WHERE\n              ws_item_sk = i_item_sk\n          and d_date between '1998-03-13' and\n                             cast('1998-03-13' as date) + interval '90 day'\n          and d_date_sk = ws_sold_date_sk\n          and ws_wholesale_cost BETWEEN 26 AND 46\n          and ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 49 * 0.01\n      )\norder by sum(ws_ext_discount_amt)\nlimit 100;",
  "optimized_sql": "WITH common_scan AS (\n  SELECT ws_item_sk, ws_ext_discount_amt, ws_sales_price, ws_list_price\n  FROM web_sales\n  INNER JOIN date_dim ON d_date_sk = ws_sold_date_sk\n  WHERE d_date BETWEEN '1998-03-13' AND CAST('1998-03-13' AS DATE) + INTERVAL '90 DAY'\n    AND ws_wholesale_cost BETWEEN 26 AND 46\n),\nthreshold_computation AS (\n  SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold\n  FROM common_scan\n  WHERE ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 49 * 0.01\n  GROUP BY ws_item_sk\n),\nouter_rows AS (\n  SELECT cs.ws_item_sk, cs.ws_ext_discount_amt\n  FROM common_scan cs\n  INNER JOIN item ON i_item_sk = cs.ws_item_sk\n  WHERE i_manufact_id BETWEEN 341 AND 540\n     OR i_category IN ('Home', 'Men', 'Music')\n),\njoin_filter AS (\n  SELECT o.ws_ext_discount_amt\n  FROM outer_rows o\n  INNER JOIN threshold_computation t ON o.ws_item_sk = t.ws_item_sk\n  WHERE o.ws_ext_discount_amt > t.threshold\n)\nSELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM join_filter\nORDER BY SUM(ws_ext_discount_amt)\nLIMIT 100",
  "example": {
    "opportunity": "SHARED_SCAN_DECORRELATE",
    "input_slice": "select sum(ws_ext_discount_amt) as \"Excess Discount Amount\"\nfrom web_sales, item, date_dim\nwhere (i_manufact_id BETWEEN 341 and 540 or i_category IN (...))\n  and i_item_sk = ws_item_sk\n  and d_date between '...' and '...' + interval '90 day'\n  and d_date_sk = ws_sold_date_sk\n  and ws_wholesale_cost BETWEEN 26 AND 46\n  and ws_ext_discount_amt > (\n    SELECT 1.3 * avg(ws_ext_discount_amt)\n    FROM web_sales, date_dim\n    WHERE ws_item_sk = i_item_sk  -- correlated!\n      and d_date between ... and d_date_sk = ws_sold_date_sk\n      and ws_wholesale_cost BETWEEN 26 AND 46\n      and ws_sales_price / ws_list_price BETWEEN ...)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "decorrelate",
          "nodes": {
            "common_scan": "SELECT ws_item_sk, ws_ext_discount_amt, ws_sales_price, ws_list_price FROM web_sales JOIN date_dim ON d_date_sk = ws_sold_date_sk WHERE d_date BETWEEN ... AND ws_wholesale_cost BETWEEN ...",
            "threshold_computation": "SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold FROM common_scan WHERE ws_sales_price / ws_list_price BETWEEN ... GROUP BY ws_item_sk",
            "outer_rows": "SELECT cs.ws_item_sk, cs.ws_ext_discount_amt FROM common_scan cs JOIN item ON i_item_sk = cs.ws_item_sk WHERE i_manufact_id BETWEEN ... OR i_category IN (...)",
            "join_filter": "SELECT o.ws_ext_discount_amt FROM outer_rows o JOIN threshold_computation t ON o.ws_item_sk = t.ws_item_sk WHERE o.ws_ext_discount_amt > t.threshold",
            "main_query": "SELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\" FROM join_filter ORDER BY 1 LIMIT 100"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation"
          ],
          "expected_speedup": "8000x+ (timeout rescue)",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Shared Scan Decorrelation \u2014 when the correlated subquery re-scans the same fact table with the same date/cost filters as the outer query, extract the common scan once into a CTE, then derive (1) per-item thresholds via GROUP BY and (2) outer rows via item join from the same materialized result. The correlated execution that caused timeout becomes a single hash join.",
    "pattern_detection": "Look for: (1) correlated scalar subquery with aggregate (AVG/SUM), (2) inner query scans the SAME fact table as outer query, (3) identical date range and cost filters in both inner and outer. The shared-scan pattern applies when inner = outer table with overlapping filters."
  },
  "family": "B",
  "ir_node_map_before": "S0 [SELECT]\n  MAIN QUERY (via Q_S0)\n    FROM: web_sales, item, date_dim\n    WHERE [0ef6ffe2461512ae]: (i_manufact_id BETWEEN 341 AND 540 OR i_category IN ('Home', 'Men', 'Music')) AND i_item_sk = ws_...\n    ORDER BY: SUM(ws_ext_discount_amt)\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: common_scan  (via CTE_Q_S0_common_scan)\n    FROM: web_sales, date_dim\n    WHERE [528282f372d6460c]: d_date BETWEEN '1998-03-13' AND CAST('1998-03-13' AS DATE) + INTERVAL '90 DAY' AND ws_wholesale_c...\n  CTE: threshold_computation  (via CTE_Q_S0_threshold_computation)\n    FROM: common_scan\n    WHERE [72f98b50cc17ebb7]: ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 49 * 0.01\n    GROUP BY: ws_item_sk\n  CTE: outer_rows  (via CTE_Q_S0_outer_rows)\n    FROM: common_scan cs, item\n    WHERE [c12aae6a913f2cad]: i_manufact_id BETWEEN 341 AND 540 OR i_category IN ('Home', 'Men', 'Music')\n  CTE: join_filter  (via CTE_Q_S0_join_filter)\n    FROM: outer_rows o, threshold_computation t\n    WHERE [d0a3b37ae99bcef6]: o.ws_ext_discount_amt > t.threshold\n  MAIN QUERY (via Q_S0)\n    FROM: join_filter\n    ORDER BY: SUM(ws_ext_discount_amt)\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "dialect": "postgresql",
  "families": [
    "B"
  ],
  "gap_ids": [
    "CORRELATED_SUBQUERY_PARALYSIS"
  ],
  "tree_example": {
    "plan_id": "gold_postgresql_pg_shared_scan_decorrelate",
    "dialect": "postgresql",
    "target_ir": "rewrite final_select to optimized query shape",
    "tree": {
      "root_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "parent_node_id": null,
          "sources": [],
          "outputs": [
            "Excess Discount Amount"
          ],
          "changed": true,
          "sql": "WITH common_scan AS (\n  SELECT ws_item_sk, ws_ext_discount_amt, ws_sales_price, ws_list_price\n  FROM web_sales\n  INNER JOIN date_dim ON d_date_sk = ws_sold_date_sk\n  WHERE d_date BETWEEN '1998-03-13' AND CAST('1998-03-13' AS DATE) + INTERVAL '90 DAY'\n    AND ws_wholesale_cost BETWEEN 26 AND 46\n),\nthreshold_computation AS (\n  SELECT ws_item_sk, 1.3 * AVG(ws_ext_discount_amt) AS threshold\n  FROM common_scan\n  WHERE ws_sales_price / ws_list_price BETWEEN 34 * 0.01 AND 49 * 0.01\n  GROUP BY ws_item_sk\n),\nouter_rows AS (\n  SELECT cs.ws_item_sk, cs.ws_ext_discount_amt\n  FROM common_scan cs\n  INNER JOIN item ON i_item_sk = cs.ws_item_sk\n  WHERE i_manufact_id BETWEEN 341 AND 540\n     OR i_category IN ('Home', 'Men', 'Music')\n),\njoin_filter AS (\n  SELECT o.ws_ext_discount_amt\n  FROM outer_rows o\n  INNER JOIN threshold_computation t ON o.ws_item_sk = t.ws_item_sk\n  WHERE o.ws_ext_discount_amt > t.threshold\n)\nSELECT SUM(ws_ext_discount_amt) AS \"Excess Discount Amount\"\nFROM join_filter\nORDER BY SUM(ws_ext_discount_amt)\nLIMIT 100"
        }
      ]
    }
  }
}
