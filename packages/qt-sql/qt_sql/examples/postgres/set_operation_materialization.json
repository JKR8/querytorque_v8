{
  "id": "pg_set_operation_materialization",
  "name": "Multi-Channel Set Operation Materialization (PostgreSQL)",
  "description": "When a query uses EXISTS + NOT EXISTS across 3 channels (store, web, catalog) with correlated subqueries, pre-materialize each channel's distinct customer set into a MATERIALIZED CTE, then use INNER JOIN + LEFT JOIN + IS NULL for set operations. Eliminates per-row correlated subquery execution across 3 fact tables.",
  "engine": "postgresql",
  "benchmark": "DSB SF10",
  "verified_speedup": "17.48x",
  "principle": "Channel Set Materialization: when EXISTS/NOT EXISTS checks 3 channels (store_sales, web_sales, catalog_sales) with identical date+price filters, pre-compute DISTINCT customer sets per channel as MATERIALIZED CTEs. Replace EXISTS with INNER JOIN, NOT EXISTS with LEFT JOIN + IS NULL. The MATERIALIZED keyword forces early computation.",
  "transforms": [
    "materialize_cte"
  ],
  "original_sql": "select \n  cd_gender,\n  cd_marital_status,\n  cd_education_status,\n  count(*) cnt1,\n  cd_purchase_estimate,\n  count(*) cnt2,\n  cd_credit_rating,\n  count(*) cnt3\n from\n  customer c,customer_address ca,customer_demographics\n where\n  c.c_current_addr_sk = ca.ca_address_sk and\n  ca_state in ('IA','MO','TX') and\n  cd_demo_sk = c.c_current_cdemo_sk\n  and cd_marital_status in ('S', 'S', 'S')\n  and cd_education_status in ('Primary', 'Secondary') and\n  exists (select *\n          from store_sales,date_dim\n          where c.c_customer_sk = ss_customer_sk and\n                ss_sold_date_sk = d_date_sk and\n                d_year = 2002 and\n                d_moy between 3 and 3+2\n                and ss_list_price between 100 and 189\n          ) and\n   (not exists (select *\n            from web_sales,date_dim\n            where c.c_customer_sk = ws_bill_customer_sk and\n                  ws_sold_date_sk = d_date_sk and\n                  d_year = 2002 and\n                  d_moy between 3 and 3+2\n                  and ws_list_price between 100 and 189\n            ) and\n    not exists (select *\n            from catalog_sales,date_dim\n            where c.c_customer_sk = cs_ship_customer_sk and\n                  cs_sold_date_sk = d_date_sk and\n                  d_year = 2002 and\n                  d_moy between 3 and 3+2\n                  and cs_list_price between 100 and 189)\n            )\n group by cd_gender, cd_marital_status, cd_education_status,\n          cd_purchase_estimate, cd_credit_rating\n order by cd_gender, cd_marital_status, cd_education_status,\n          cd_purchase_estimate, cd_credit_rating\n limit 100;",
  "optimized_sql": "WITH filtered_date AS (\n  SELECT d_date_sk FROM date_dim\n  WHERE d_year = 2002 AND d_moy BETWEEN 3 AND 5\n),\nstore_customers AS MATERIALIZED (\n  SELECT DISTINCT ss_customer_sk\n  FROM store_sales\n  JOIN filtered_date ON ss_sold_date_sk = d_date_sk\n  WHERE ss_list_price BETWEEN 100 AND 189\n),\nweb_customers AS MATERIALIZED (\n  SELECT DISTINCT ws_bill_customer_sk\n  FROM web_sales\n  JOIN filtered_date ON ws_sold_date_sk = d_date_sk\n  WHERE ws_list_price BETWEEN 100 AND 189\n),\ncatalog_customers AS MATERIALIZED (\n  SELECT DISTINCT cs_ship_customer_sk\n  FROM catalog_sales\n  JOIN filtered_date ON cs_sold_date_sk = d_date_sk\n  WHERE cs_list_price BETWEEN 100 AND 189\n),\ncustomer_base AS (\n  SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status,\n         cd.cd_education_status, cd.cd_purchase_estimate, cd.cd_credit_rating\n  FROM customer c\n  JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk\n  JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk\n  WHERE ca.ca_state IN ('IA','MO','TX')\n    AND cd.cd_marital_status IN ('S')\n    AND cd.cd_education_status IN ('Primary','Secondary')\n),\nset_joins AS (\n  SELECT cb.cd_gender, cb.cd_marital_status, cb.cd_education_status,\n         cb.cd_purchase_estimate, cb.cd_credit_rating\n  FROM customer_base cb\n  INNER JOIN store_customers sc ON cb.c_customer_sk = sc.ss_customer_sk\n  LEFT JOIN web_customers wc ON cb.c_customer_sk = wc.ws_bill_customer_sk\n  LEFT JOIN catalog_customers cc ON cb.c_customer_sk = cc.cs_ship_customer_sk\n  WHERE wc.ws_bill_customer_sk IS NULL\n    AND cc.cs_ship_customer_sk IS NULL\n)\nSELECT cd_gender, cd_marital_status, cd_education_status,\n       COUNT(*) AS cnt1, cd_purchase_estimate, COUNT(*) AS cnt2,\n       cd_credit_rating, COUNT(*) AS cnt3\nFROM set_joins\nGROUP BY cd_gender, cd_marital_status, cd_education_status,\n         cd_purchase_estimate, cd_credit_rating\nORDER BY cd_gender, cd_marital_status, cd_education_status,\n         cd_purchase_estimate, cd_credit_rating\nLIMIT 100",
  "example": {
    "opportunity": "SET_OPERATION_MATERIALIZATION",
    "input_slice": "select cd_gender, cd_marital_status, cd_education_status, count(*) ...\nfrom customer c, customer_address ca, customer_demographics\nwhere ...\n  and exists (select * from store_sales, date_dim where c.c_customer_sk = ss_customer_sk ...)\n  and not exists (select * from web_sales, date_dim where c.c_customer_sk = ws_bill_customer_sk ...)\n  and not exists (select * from catalog_sales, date_dim where c.c_customer_sk = cs_ship_customer_sk ...)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "materialize_cte",
          "nodes": {
            "filtered_date": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002 AND d_moy BETWEEN 3 AND 5",
            "store_customers": "AS MATERIALIZED: SELECT DISTINCT ss_customer_sk FROM store_sales JOIN filtered_date ...",
            "web_customers": "AS MATERIALIZED: SELECT DISTINCT ws_bill_customer_sk FROM web_sales JOIN filtered_date ...",
            "catalog_customers": "AS MATERIALIZED: SELECT DISTINCT cs_ship_customer_sk FROM catalog_sales JOIN filtered_date ...",
            "customer_base": "SELECT c.c_customer_sk, cd.* FROM customer c JOIN customer_address ca ... JOIN customer_demographics cd ...",
            "set_joins": "SELECT ... FROM customer_base cb INNER JOIN store_customers sc ON ... LEFT JOIN web_customers wc ON ... LEFT JOIN catalog_customers cc ON ... WHERE wc.ws_bill_customer_sk IS NULL AND cc.cs_ship_customer_sk IS NULL"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation",
            "same ordering"
          ],
          "expected_speedup": "17x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Channel Set Materialization \u2014 when 3 correlated EXISTS/NOT EXISTS check store, web, and catalog channels with identical date+price filters, pre-compute DISTINCT customer_sk per channel once as MATERIALIZED CTEs. EXISTS becomes INNER JOIN, NOT EXISTS becomes LEFT JOIN + IS NULL. Critical: shared date CTE avoids 3 redundant date_dim scans. CAUTION: do NOT apply to simple single-channel EXISTS \u2014 semi-join early termination is already optimal there.",
    "pattern_detection": "Look for: (1) EXISTS + NOT EXISTS pattern with 3 fact tables (store_sales, web_sales, catalog_sales), (2) identical date range and price range filters in each subquery, (3) correlation on customer_sk. All 3 must be present for this pattern."
  },
  "family": "E"
}