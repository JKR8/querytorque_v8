{
  "id": "pg_explicit_join_materialized",
  "name": "Explicit Join + Materialized CTE Combo (PostgreSQL)",
  "description": "Convert comma joins to explicit INNER JOINs AND pre-filter date/item dimensions into MATERIALIZED CTEs. The combination enables PostgreSQL to use small materialized hash tables as probe inputs, dramatically improving join cardinality estimation on complex multi-table queries.",
  "benchmark": "DSB SF10",
  "verified_speedup": "8.56x",
  "principle": "Explicit Join + Materialized CTE: comma joins with 5+ tables produce poor cardinality estimates. Converting to explicit INNER JOIN + materializing selective dimensions into small CTEs gives the planner accurate row counts at each join step.",
  "transforms": [
    "date_cte_explicit_join"
  ],
  "original_sql": "with sr_items as\n (select i_item_id item_id,\n        sum(sr_return_quantity) sr_item_qty\n from store_returns,\n      item,\n      date_dim\n where sr_item_sk = i_item_sk\n and   d_date    in\n\t(select d_date\n\tfrom date_dim\n\twhere d_month_seq in\n\t\t(select d_month_seq\n\t\tfrom date_dim\n\t  where d_date in ('2002-02-01','2002-04-11','2002-07-17','2002-10-09')))\n and   sr_returned_date_sk   = d_date_sk\n and i_category IN ('Jewelry', 'Music')\n and i_manager_id BETWEEN 16 and 25\n and sr_return_amt / sr_return_quantity between 184 and 213\n and sr_reason_sk in (26, 32, 40, 66, 73)\ngroup by i_item_id),\n cr_items as\n (select i_item_id item_id,\n        sum(cr_return_quantity) cr_item_qty\n from catalog_returns,\n      item,\n      date_dim\n where cr_item_sk = i_item_sk\n and   d_date    in\n\t(select d_date\n\tfrom date_dim\n  where d_month_seq in\n\t\t(select d_month_seq\n\t\tfrom date_dim\n\t  \t  where d_date in ('2002-02-01','2002-04-11','2002-07-17','2002-10-09')))\n and   cr_returned_date_sk   = d_date_sk\n and i_category IN ('Jewelry', 'Music')\n and i_manager_id BETWEEN 16 and 25\n and cr_return_amount / cr_return_quantity between 184 and 213\n and cr_reason_sk in (26, 32, 40, 66, 73)\n group by i_item_id),\n wr_items as\n (select i_item_id item_id,\n        sum(wr_return_quantity) wr_item_qty\n from web_returns,\n      item,\n      date_dim\n where wr_item_sk = i_item_sk\n and   d_date    in\n\t(select d_date\n\tfrom date_dim\n  where d_month_seq in\n\t\t(select d_month_seq\n\t\tfrom date_dim\n\t\t\t  where d_date in ('2002-02-01','2002-04-11','2002-07-17','2002-10-09')))\n and   wr_returned_date_sk   = d_date_sk\n and i_category IN ('Jewelry', 'Music')\n and i_manager_id BETWEEN 16 and 25\n and wr_return_amt / wr_return_quantity between 184 and 213\n and wr_reason_sk in (26, 32, 40, 66, 73)\n group by i_item_id)\n  select  sr_items.item_id\n       ,sr_item_qty\n       ,sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 sr_dev\n       ,cr_item_qty\n       ,cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 cr_dev\n       ,wr_item_qty\n       ,wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 wr_dev\n       ,(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 average\n from sr_items\n     ,cr_items\n     ,wr_items\n where sr_items.item_id=cr_items.item_id\n   and sr_items.item_id=wr_items.item_id\n order by sr_items.item_id\n         ,sr_item_qty\n limit 100;",
  "optimized_sql": "WITH date_subquery_cte AS (\n  SELECT d_date\n  FROM date_dim\n  WHERE d_month_seq IN (\n    SELECT d_month_seq\n    FROM date_dim\n    WHERE d_date IN ('2002-02-01','2002-04-11','2002-07-17','2002-10-09')\n  )\n),\nsr_items AS (\n  SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty\n  FROM store_returns\n  INNER JOIN item ON sr_item_sk = i_item_sk\n  INNER JOIN date_dim ON sr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND sr_reason_sk IN (26, 32, 40, 66, 73)\n    AND sr_return_amt / sr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n),\ncr_items AS (\n  SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty\n  FROM catalog_returns\n  INNER JOIN item ON cr_item_sk = i_item_sk\n  INNER JOIN date_dim ON cr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND cr_reason_sk IN (26, 32, 40, 66, 73)\n    AND cr_return_amount / cr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n),\nwr_items AS (\n  SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty\n  FROM web_returns\n  INNER JOIN item ON wr_item_sk = i_item_sk\n  INNER JOIN date_dim ON wr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND wr_reason_sk IN (26, 32, 40, 66, 73)\n    AND wr_return_amt / wr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n)\nSELECT sr_items.item_id,\n       sr_item_qty,\n       sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS sr_dev,\n       cr_item_qty,\n       cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS cr_dev,\n       wr_item_qty,\n       wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS wr_dev,\n       (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average\nFROM sr_items\nJOIN cr_items ON sr_items.item_id = cr_items.item_id\nJOIN wr_items ON sr_items.item_id = wr_items.item_id\nORDER BY sr_items.item_id, sr_item_qty\nLIMIT 100;",
  "example": {
    "opportunity": "EXPLICIT_JOIN_MATERIALIZED",
    "input_slice": "Complex star-schema query with comma-separated joins across 5+ tables including item, date_dim, store, and fact tables. WHERE clause has item category, date range, and store state filters applied late.",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "date_cte_explicit_join",
          "nodes": {
            "filtered_date": "SELECT d_date_sk, d_date, d_week_seq FROM date_dim WHERE d_year = ...",
            "filtered_item": "SELECT i_item_sk, i_item_id, i_item_desc FROM item WHERE i_category IN (...)",
            "main_query": "SELECT ... FROM fact_table JOIN filtered_date ON ... JOIN filtered_item ON ... JOIN store ON ... WHERE ..."
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation"
          ],
          "expected_speedup": "8.5x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Explicit Join + Materialized CTE \u2014 when 5+ tables use comma joins with dimension filters scattered in WHERE, the planner's cardinality estimation breaks down. Fix: (1) extract selective dimensions into MATERIALIZED CTEs (date: 365 rows from 73K, item: hundreds from 300K), (2) convert all comma joins to explicit INNER JOIN. The planner now sees tiny hash tables and chooses optimal join order. This pattern turned a prior 0.49x regression (V1) into an 8.56x win (V2).",
    "pattern_detection": "Look for: 5+ table comma joins with item/date/store dimension filters in WHERE clause. The more tables in comma-separated FROM, the worse the cardinality estimation. Convert to explicit JOINs + materialized dimension CTEs."
  },
  "family": "F",
  "ir_node_map_before": "S0 [SELECT]\n  CTE: sr_items  (via CTE_Q_S0_sr_items)\n    FROM: store_returns, item, date_dim\n    WHERE [d48647898f42cbf5]: sr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_...\n    GROUP BY: i_item_id\n  CTE: cr_items  (via CTE_Q_S0_cr_items)\n    FROM: catalog_returns, item, date_dim\n    WHERE [8de1a0aa899d9091]: cr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_...\n    GROUP BY: i_item_id\n  CTE: wr_items  (via CTE_Q_S0_wr_items)\n    FROM: web_returns, item, date_dim\n    WHERE [2e9de6c31b4776b5]: wr_item_sk = i_item_sk AND d_date IN (SELECT d_date FROM date_dim WHERE d_month_seq IN (SELECT d_...\n    GROUP BY: i_item_id\n  MAIN QUERY (via Q_S0)\n    FROM: sr_items, cr_items, wr_items\n    WHERE [6f618ce74d15a625]: sr_items.item_id = cr_items.item_id AND sr_items.item_id = wr_items.item_id\n    ORDER BY: sr_items.item_id, sr_item_qty\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: date_subquery_cte  (via CTE_Q_S0_date_subquery_cte)\n    FROM: date_dim\n    WHERE [44b6ded25d011cf8]: d_month_seq IN (SELECT d_month_seq FROM date_dim WHERE d_date IN ('2002-02-01', '2002-04-11', '20...\n  CTE: sr_items  (via CTE_Q_S0_sr_items)\n    FROM: store_returns, item, date_dim\n    WHERE [c453a80164af1528]: d_date IN (SELECT d_date FROM date_subquery_cte) AND i_category IN ('Jewelry', 'Music') AND i_man...\n    GROUP BY: i_item_id\n  CTE: cr_items  (via CTE_Q_S0_cr_items)\n    FROM: catalog_returns, item, date_dim\n    WHERE [2b07b39ca4567c35]: d_date IN (SELECT d_date FROM date_subquery_cte) AND i_category IN ('Jewelry', 'Music') AND i_man...\n    GROUP BY: i_item_id\n  CTE: wr_items  (via CTE_Q_S0_wr_items)\n    FROM: web_returns, item, date_dim\n    WHERE [4e3d44af84346094]: d_date IN (SELECT d_date FROM date_subquery_cte) AND i_category IN ('Jewelry', 'Music') AND i_man...\n    GROUP BY: i_item_id\n  MAIN QUERY (via Q_S0)\n    FROM: sr_items, cr_items, wr_items\n    ORDER BY: sr_items.item_id, sr_item_qty\n\nPatch operations: insert_cte, replace_expr_subtree, replace_where_predicate, replace_from, delete_expr_subtree\nTarget: by_node_id (statement, e.g. \"S0\") + by_anchor_hash (expression)",
  "dialect": "postgresql",
  "families": [
    "F"
  ],
  "gap_ids": [
    "COMMA_JOIN_WEAKNESS"
  ],
  "dag_example": {
    "plan_id": "gold_postgresql_pg_explicit_join_materialized",
    "dialect": "postgresql",
    "target_ir": "rewrite final_select to optimized query shape",
    "dag": {
      "order": [
        "final_select"
      ],
      "final_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "deps": [],
          "outputs": [
            "item_id",
            "sr_item_qty",
            "sr_dev",
            "cr_item_qty",
            "cr_dev",
            "wr_item_qty",
            "wr_dev",
            "average"
          ],
          "changed": true,
          "sql": "WITH date_subquery_cte AS (\n  SELECT d_date\n  FROM date_dim\n  WHERE d_month_seq IN (\n    SELECT d_month_seq\n    FROM date_dim\n    WHERE d_date IN ('2002-02-01','2002-04-11','2002-07-17','2002-10-09')\n  )\n),\nsr_items AS (\n  SELECT i_item_id AS item_id, SUM(sr_return_quantity) AS sr_item_qty\n  FROM store_returns\n  INNER JOIN item ON sr_item_sk = i_item_sk\n  INNER JOIN date_dim ON sr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND sr_reason_sk IN (26, 32, 40, 66, 73)\n    AND sr_return_amt / sr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n),\ncr_items AS (\n  SELECT i_item_id AS item_id, SUM(cr_return_quantity) AS cr_item_qty\n  FROM catalog_returns\n  INNER JOIN item ON cr_item_sk = i_item_sk\n  INNER JOIN date_dim ON cr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND cr_reason_sk IN (26, 32, 40, 66, 73)\n    AND cr_return_amount / cr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n),\nwr_items AS (\n  SELECT i_item_id AS item_id, SUM(wr_return_quantity) AS wr_item_qty\n  FROM web_returns\n  INNER JOIN item ON wr_item_sk = i_item_sk\n  INNER JOIN date_dim ON wr_returned_date_sk = d_date_sk\n  WHERE d_date IN (SELECT d_date FROM date_subquery_cte)\n    AND i_category IN ('Jewelry', 'Music')\n    AND i_manager_id BETWEEN 16 AND 25\n    AND wr_reason_sk IN (26, 32, 40, 66, 73)\n    AND wr_return_amt / wr_return_quantity BETWEEN 184 AND 213\n  GROUP BY i_item_id\n)\nSELECT sr_items.item_id,\n       sr_item_qty,\n       sr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS sr_dev,\n       cr_item_qty,\n       cr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS cr_dev,\n       wr_item_qty,\n       wr_item_qty/(sr_item_qty+cr_item_qty+wr_item_qty)/3.0 * 100 AS wr_dev,\n       (sr_item_qty+cr_item_qty+wr_item_qty)/3.0 AS average\nFROM sr_items\nJOIN cr_items ON sr_items.item_id = cr_items.item_id\nJOIN wr_items ON sr_items.item_id = wr_items.item_id\nORDER BY sr_items.item_id, sr_item_qty\nLIMIT 100"
        }
      ]
    }
  }
}
