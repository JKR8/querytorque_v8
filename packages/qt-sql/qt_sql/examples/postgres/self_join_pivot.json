{
  "id": "pg_self_join_pivot",
  "name": "Self-Join Elimination via Pivot (PostgreSQL)",
  "description": "When a query self-joins the same fact aggregation 6 times (e.g., ss1, ss2, ss3, ws1, ws2, ws3 for 3 quarters \u00d7 2 channels), materialize the fact+dimension scan once and use CASE/FILTER aggregation to pivot quarters in a single pass. Eliminates 5 redundant fact table scans.",
  "engine": "postgresql",
  "benchmark": "DSB SF10",
  "verified_speedup": "1.79x",
  "principle": "Self-Join Elimination via Pivot: when a query computes the same aggregation across N time periods by self-joining N copies of the same CTE, materialize the base scan once and pivot time periods using CASE WHEN or FILTER (WHERE quarter = X) aggregation.",
  "transforms": [
    "single_pass_aggregation"
  ],
  "original_sql": "with ss as\n (select ca_county,d_qoy, d_year,sum(ss_ext_sales_price) as store_sales\n from store_sales,date_dim,customer_address, item\n where ss_sold_date_sk = d_date_sk\n  and ss_addr_sk=ca_address_sk\n  and ss_item_sk = i_item_sk\n  and i_color IN ('blanched', 'rosy')\n  and i_manager_id BETWEEN 16 and 35\n  and ss_list_price between 286 and 300\n  and ca_state in ('TX','VA')\n group by ca_county,d_qoy, d_year),\n ws as\n (select ca_county,d_qoy, d_year,sum(ws_ext_sales_price) as web_sales\n from web_sales,date_dim,customer_address, item\n where ws_sold_date_sk = d_date_sk\n  and ws_bill_addr_sk=ca_address_sk\n  and ws_item_sk = i_item_sk\n  and i_color IN ('blanched', 'rosy')\n  and i_manager_id BETWEEN 16 and 35\n  and ws_list_price between 286 and 300\n  and ca_state in ('TX','VA')\ngroup by ca_county,d_qoy, d_year)\n select\n        ss1.ca_county\n       ,ss1.d_year\n       ,ws2.web_sales/ws1.web_sales web_q1_q2_increase\n       ,ss2.store_sales/ss1.store_sales store_q1_q2_increase\n       ,ws3.web_sales/ws2.web_sales web_q2_q3_increase\n       ,ss3.store_sales/ss2.store_sales store_q2_q3_increase\n from\n        ss ss1\n       ,ss ss2\n       ,ss ss3\n       ,ws ws1\n       ,ws ws2\n       ,ws ws3\n where\n    ss1.d_qoy = 1\n    and ss1.d_year = 1998\n    and ss1.ca_county = ss2.ca_county\n    and ss2.d_qoy = 2\n    and ss2.d_year = 1998\n and ss2.ca_county = ss3.ca_county\n    and ss3.d_qoy = 3\n    and ss3.d_year = 1998\n    and ss1.ca_county = ws1.ca_county\n    and ws1.d_qoy = 1\n    and ws1.d_year = 1998\n    and ws1.ca_county = ws2.ca_county\n    and ws2.d_qoy = 2\n    and ws2.d_year = 1998\n    and ws1.ca_county = ws3.ca_county\n    and ws3.d_qoy = 3\n    and ws3.d_year =1998\n    and case when ws1.web_sales > 0 then ws2.web_sales/ws1.web_sales else null end\n       > case when ss1.store_sales > 0 then ss2.store_sales/ss1.store_sales else null end\n    and case when ws2.web_sales > 0 then ws3.web_sales/ws2.web_sales else null end\n       > case when ss2.store_sales > 0 then ss3.store_sales/ss2.store_sales else null end\n order by web_q1_q2_increase;",
  "optimized_sql": "WITH ss_all_quarters AS (\n  SELECT ca_county, d_qoy, d_year,\n         SUM(ss_ext_sales_price) AS store_sales\n  FROM store_sales, date_dim, customer_address, item\n  WHERE ss_sold_date_sk = d_date_sk\n    AND ss_addr_sk = ca_address_sk\n    AND ss_item_sk = i_item_sk\n    AND i_color IN ('blanched', 'rosy')\n    AND i_manager_id BETWEEN 16 AND 35\n    AND ss_list_price BETWEEN 286 AND 300\n    AND ca_state IN ('TX', 'VA')\n    AND d_year = 1998 AND d_qoy IN (1, 2, 3)\n  GROUP BY ca_county, d_qoy, d_year\n),\nss_pivot AS (\n  SELECT ca_county, d_year,\n         MAX(CASE WHEN d_qoy = 1 THEN store_sales END) AS store_sales_q1,\n         MAX(CASE WHEN d_qoy = 2 THEN store_sales END) AS store_sales_q2,\n         MAX(CASE WHEN d_qoy = 3 THEN store_sales END) AS store_sales_q3\n  FROM ss_all_quarters\n  GROUP BY ca_county, d_year\n),\nws_all_quarters AS (\n  SELECT ca_county, d_qoy, d_year,\n         SUM(ws_ext_sales_price) AS web_sales\n  FROM web_sales, date_dim, customer_address, item\n  WHERE ws_sold_date_sk = d_date_sk\n    AND ws_bill_addr_sk = ca_address_sk\n    AND ws_item_sk = i_item_sk\n    AND i_color IN ('blanched', 'rosy')\n    AND i_manager_id BETWEEN 16 AND 35\n    AND ws_list_price BETWEEN 286 AND 300\n    AND ca_state IN ('TX', 'VA')\n    AND d_year = 1998 AND d_qoy IN (1, 2, 3)\n  GROUP BY ca_county, d_qoy, d_year\n),\nws_pivot AS (\n  SELECT ca_county, d_year,\n         MAX(CASE WHEN d_qoy = 1 THEN web_sales END) AS web_sales_q1,\n         MAX(CASE WHEN d_qoy = 2 THEN web_sales END) AS web_sales_q2,\n         MAX(CASE WHEN d_qoy = 3 THEN web_sales END) AS web_sales_q3\n  FROM ws_all_quarters\n  GROUP BY ca_county, d_year\n)\nSELECT ss_pivot.ca_county, ss_pivot.d_year,\n       CASE WHEN web_sales_q1 > 0 THEN web_sales_q2/web_sales_q1 ELSE NULL END AS web_q1_q2_increase,\n       CASE WHEN store_sales_q1 > 0 THEN store_sales_q2/store_sales_q1 ELSE NULL END AS store_q1_q2_increase,\n       CASE WHEN web_sales_q2 > 0 THEN web_sales_q3/web_sales_q2 ELSE NULL END AS web_q2_q3_increase,\n       CASE WHEN store_sales_q2 > 0 THEN store_sales_q3/store_sales_q2 ELSE NULL END AS store_q2_q3_increase\nFROM ss_pivot\nJOIN ws_pivot ON ss_pivot.ca_county = ws_pivot.ca_county\nWHERE CASE WHEN web_sales_q1 > 0 THEN web_sales_q2/web_sales_q1 ELSE NULL END\n      > CASE WHEN store_sales_q1 > 0 THEN store_sales_q2/store_sales_q1 ELSE NULL END\n  AND CASE WHEN web_sales_q2 > 0 THEN web_sales_q3/web_sales_q2 ELSE NULL END\n      > CASE WHEN store_sales_q2 > 0 THEN store_sales_q3/store_sales_q2 ELSE NULL END\nORDER BY web_q1_q2_increase;",
  "example": {
    "opportunity": "SELF_JOIN_PIVOT",
    "input_slice": "select ss1.column_name, ss1.value, ss2.value, ss3.value, ws1.value, ws2.value, ws3.value\nfrom (\n  select ..., sum(sales) as value from store_sales, date_dim, store\n  where d_qoy = 1 and d_year = 2000 ... group by ...\n) ss1,\n(\n  select ..., sum(sales) as value from store_sales, date_dim, store\n  where d_qoy = 2 and d_year = 2000 ... group by ...\n) ss2,\n... -- 6 self-join aliases total",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "single_pass_aggregation",
          "nodes": {
            "base_scan": "SELECT store_sk, d_qoy, SUM(sales) AS value FROM store_sales JOIN date_dim ON ... JOIN store ON ... WHERE d_year = 2000 AND d_qoy IN (1,2,3) GROUP BY store_sk, d_qoy",
            "pivoted": "SELECT store_sk, SUM(CASE WHEN d_qoy = 1 THEN value END) AS q1, SUM(CASE WHEN d_qoy = 2 THEN value END) AS q2, SUM(CASE WHEN d_qoy = 3 THEN value END) AS q3 FROM base_scan GROUP BY store_sk"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation"
          ],
          "expected_speedup": "1.8x",
          "risk": "low"
        }
      ]
    },
    "key_insight": "Principle: Self-Join Elimination via Pivot \u2014 when N self-join aliases scan the same fact table with different discriminator values (quarter, year, channel), scan once with all discriminators and pivot via CASE WHEN aggregation. CAUTION: do NOT apply dimension prefetch to self-join patterns (0.25x Q031_i1 regression). The bottleneck is the N-way self-join, not the dimension filtering.",
    "pattern_detection": "Look for: 4+ self-join aliases of the same fact aggregation subquery, distinguished by a single discriminator column (d_qoy, d_year, channel). Each alias computes the same SUM/AVG/COUNT but for a different time period or channel."
  }
}
