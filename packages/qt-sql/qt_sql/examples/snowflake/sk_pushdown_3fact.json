{
  "id": "sf_sk_pushdown_3fact",
  "name": "SK Range Pushdown on 3 Fact Tables (Snowflake)",
  "description": "When 3 fact tables (store_sales, catalog_sales, web_sales) each join date_dim via comma join with the same date filter (d_year=2000, d_moy=2), Snowflake may not push the date_sk range to the fact table scans for micro-partition pruning. Fix: look up the date_sk range and add explicit sold_date_sk BETWEEN predicates on each fact table. Also convert comma joins to explicit JOINs.",
  "verified_speedup": "1.17x",
  "principle": "Predicate Transitivity on multi-fact queries: when multiple fact tables are comma-joined to date_dim with the same date filter, Snowflake may not infer the date_sk range for fact table pruning. Adding explicit sold_date_sk BETWEEN on each fact table forces micro-partition pruning. Combined with comma-to-explicit JOIN conversion.",
  "benchmark": {
    "dataset": "tpcds_sf10tcl",
    "warehouse": "X-Small",
    "orig_ms": 10233.6,
    "opt_ms": 8729.9,
    "speedup": 1.17,
    "validation": "5x trimmed mean (discard min/max, average middle 3)",
    "row_match": true,
    "hash_match": true
  },
  "example": {
    "opportunity": "SF_SK_PUSHDOWN_3FACT",
    "input_slice": "with ss as (\n select i_item_id, sum(ss_ext_sales_price) total_sales\n from store_sales, date_dim, customer_address, item\n where ... and ss_sold_date_sk = d_date_sk\n   and d_year = 2000 and d_moy = 2 ...),\n cs as (\n select i_item_id, sum(cs_ext_sales_price) total_sales\n from catalog_sales, date_dim, customer_address, item\n where ... and cs_sold_date_sk = d_date_sk\n   and d_year = 2000 and d_moy = 2 ...),\n ws as (...same pattern with web_sales...)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "sf_sk_pushdown_union_all",
          "nodes": {
            "sk_range_lookup": "SELECT MIN(d_date_sk), MAX(d_date_sk) FROM date_dim WHERE d_year = 2000 AND d_moy = 2",
            "ss_pushdown": "store_sales: AND ss_sold_date_sk BETWEEN <sk_min> AND <sk_max>",
            "cs_pushdown": "catalog_sales: AND cs_sold_date_sk BETWEEN <sk_min> AND <sk_max>",
            "ws_pushdown": "web_sales: AND ws_sold_date_sk BETWEEN <sk_min> AND <sk_max>",
            "comma_to_explicit": "FROM fact, date_dim, ... WHERE fact_sk = d_date_sk \u2192 FROM fact JOIN date_dim ON fact_sk = d_date_sk JOIN ..."
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation",
            "same ORDER BY"
          ],
          "expected_speedup": "1.2x",
          "risk": "low"
        }
      ]
    },
    "transforms": [
      "sf_sk_pushdown_union_all"
    ],
    "key_insight": "When multiple CTE branches each comma-join a fact table to date_dim with the same date filter, Snowflake may not push the implied date_sk range to the fact table scans. Adding explicit BETWEEN on the sold_date_sk column of each fact table enables micro-partition pruning. Works best with narrow date ranges (29 values = 1 month)."
  },
  "original_sql": "with ss as (\n select i_item_id,sum(ss_ext_sales_price) total_sales\n from store_sales, date_dim, customer_address, item\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and ss_item_sk = i_item_sk\n and ss_sold_date_sk = d_date_sk\n and d_year = 2000 and d_moy = 2\n and ss_addr_sk = ca_address_sk\n and ca_gmt_offset = -6\n group by i_item_id),\n cs as (\n select i_item_id,sum(cs_ext_sales_price) total_sales\n from catalog_sales, date_dim, customer_address, item\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and cs_item_sk = i_item_sk\n and cs_sold_date_sk = d_date_sk\n and d_year = 2000 and d_moy = 2\n and cs_bill_addr_sk = ca_address_sk\n and ca_gmt_offset = -6\n group by i_item_id),\n ws as (\n select i_item_id,sum(ws_ext_sales_price) total_sales\n from web_sales, date_dim, customer_address, item\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and ws_item_sk = i_item_sk\n and ws_sold_date_sk = d_date_sk\n and d_year = 2000 and d_moy = 2\n and ws_bill_addr_sk = ca_address_sk\n and ca_gmt_offset = -6\n group by i_item_id)\nselect i_item_id, sum(total_sales) total_sales\nfrom (select * from ss union all select * from cs union all select * from ws) tmp1\ngroup by i_item_id\norder by total_sales, i_item_id\nLIMIT 100",
  "optimized_sql": "with ss as (\n select i_item_id,sum(ss_ext_sales_price) total_sales\n from store_sales\n JOIN date_dim ON ss_sold_date_sk = d_date_sk\n JOIN customer_address ON ss_addr_sk = ca_address_sk\n JOIN item ON ss_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and ss_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id),\n cs as (\n select i_item_id,sum(cs_ext_sales_price) total_sales\n from catalog_sales\n JOIN date_dim ON cs_sold_date_sk = d_date_sk\n JOIN customer_address ON cs_bill_addr_sk = ca_address_sk\n JOIN item ON cs_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and cs_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id),\n ws as (\n select i_item_id,sum(ws_ext_sales_price) total_sales\n from web_sales\n JOIN date_dim ON ws_sold_date_sk = d_date_sk\n JOIN customer_address ON ws_bill_addr_sk = ca_address_sk\n JOIN item ON ws_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and ws_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id)\nselect i_item_id, sum(total_sales) total_sales\nfrom (select * from ss union all select * from cs union all select * from ws) tmp1\ngroup by i_item_id\norder by total_sales, i_item_id\nLIMIT 100",
  "type": "gold",
  "family": "A",
  "ir_node_map_before": "S0 [SELECT]\n  CTE: ss  (via CTE_Q_S0_ss)\n    FROM: store_sales, date_dim, customer_address, item\n    WHERE [fa12b7a175b8a163]: i_item_id IN (...) AND ss_item_sk = i_item_sk AND ss_sold_date_sk = d_date_sk AND d_year = 2000 AND d_moy = 2 ...\n    GROUP BY: i_item_id\n  CTE: cs  (via CTE_Q_S0_cs)\n    FROM: catalog_sales, date_dim, customer_address, item\n    WHERE [48639c7117d4306c]: i_item_id IN (...) AND cs_item_sk = i_item_sk AND cs_sold_date_sk = d_date_sk ...\n    GROUP BY: i_item_id\n  CTE: ws  (via CTE_Q_S0_ws)\n    FROM: web_sales, date_dim, customer_address, item\n    WHERE [58f58d0b7668a7f3]: i_item_id IN (...) AND ws_item_sk = i_item_sk AND ws_sold_date_sk = d_date_sk ...\n    GROUP BY: i_item_id\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) tmp1\n    GROUP BY: i_item_id\n    ORDER BY: total_sales, i_item_id",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: ss  (via CTE_Q_S0_ss)\n    FROM: store_sales JOIN date_dim ON ss_sold_date_sk = d_date_sk JOIN customer_address ON ss_addr_sk = ca_address_sk JOIN item ON ss_item_sk = i_item_sk\n    WHERE: i_item_id IN (...) AND d_year = 2000 AND d_moy = 2 AND ca_gmt_offset = -6 AND ss_sold_date_sk BETWEEN 2451576 AND 2451604\n    GROUP BY: i_item_id\n  CTE: cs  (via CTE_Q_S0_cs)\n    FROM: catalog_sales JOIN date_dim ON cs_sold_date_sk = d_date_sk JOIN customer_address ON cs_bill_addr_sk = ca_address_sk JOIN item ON cs_item_sk = i_item_sk\n    WHERE: ... AND cs_sold_date_sk BETWEEN 2451576 AND 2451604\n    GROUP BY: i_item_id\n  CTE: ws  (via CTE_Q_S0_ws)\n    FROM: web_sales JOIN date_dim ON ws_sold_date_sk = d_date_sk JOIN customer_address ON ws_bill_addr_sk = ca_address_sk JOIN item ON ws_item_sk = i_item_sk\n    WHERE: ... AND ws_sold_date_sk BETWEEN 2451576 AND 2451604\n    GROUP BY: i_item_id\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) tmp1\n    GROUP BY: i_item_id\n    ORDER BY: total_sales, i_item_id",
  "dialect": "snowflake",
  "transforms": [
    "sf_sk_pushdown_union_all"
  ],
  "families": [
    "A"
  ],
  "gap_ids": [
    "PREDICATE_TRANSITIVITY_FAILURE"
  ],
  "dag_example": {
    "plan_id": "gold_snowflake_sf_sk_pushdown_3fact",
    "dialect": "snowflake",
    "target_ir": "rewrite final_select to optimized query shape",
    "dag": {
      "order": [
        "final_select"
      ],
      "final_node_id": "final_select",
      "nodes": [
        {
          "node_id": "final_select",
          "deps": [],
          "outputs": [
            "i_item_id",
            "total_sales"
          ],
          "changed": true,
          "sql": "with ss as (\n select i_item_id,sum(ss_ext_sales_price) total_sales\n from store_sales\n JOIN date_dim ON ss_sold_date_sk = d_date_sk\n JOIN customer_address ON ss_addr_sk = ca_address_sk\n JOIN item ON ss_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and ss_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id),\n cs as (\n select i_item_id,sum(cs_ext_sales_price) total_sales\n from catalog_sales\n JOIN date_dim ON cs_sold_date_sk = d_date_sk\n JOIN customer_address ON cs_bill_addr_sk = ca_address_sk\n JOIN item ON cs_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and cs_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id),\n ws as (\n select i_item_id,sum(ws_ext_sales_price) total_sales\n from web_sales\n JOIN date_dim ON ws_sold_date_sk = d_date_sk\n JOIN customer_address ON ws_bill_addr_sk = ca_address_sk\n JOIN item ON ws_item_sk = i_item_sk\n where i_item_id in (select i_item_id from item where i_color in ('powder','green','cyan'))\n and d_year = 2000 and d_moy = 2\n and ca_gmt_offset = -6\n and ws_sold_date_sk BETWEEN 2451576 AND 2451604\n group by i_item_id)\nselect i_item_id, sum(total_sales) total_sales\nfrom (select * from ss union all select * from cs union all select * from ws) tmp1\ngroup by i_item_id\norder by total_sales, i_item_id\nLIMIT 100"
        }
      ]
    }
  }
}
