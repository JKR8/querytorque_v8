{
  "id": "sf_sk_pushdown_union_all",
  "name": "SK Range Pushdown into UNION ALL Branches (Snowflake)",
  "description": "When a UNION ALL CTE combines multiple fact tables (web_sales + catalog_sales) and is later joined to date_dim via comma join, Snowflake does not push the date_sk range into the UNION ALL branches. Fix: look up the date_sk range from date_dim and add explicit BETWEEN predicates inside each UNION ALL branch. Also convert comma joins to explicit JOINs.",
  "verified_speedup": "2.13x",
  "principle": "Predicate Transitivity through UNION ALL: Snowflake's optimizer fails to push date_sk ranges through UNION ALL CTEs. Manually adding sold_date_sk BETWEEN <min> AND <max> inside each branch enables micro-partition pruning on both fact tables, reducing full scans to narrow range scans.",
  "benchmark": {
    "dataset": "tpcds_sf10tcl",
    "warehouse": "X-Small",
    "orig_ms": 229847.3,
    "opt_ms": 107982.0,
    "speedup": 2.13,
    "validation": "5x trimmed mean (discard min/max, average middle 3)",
    "row_match": true
  },
  "example": {
    "opportunity": "SF_SK_PUSHDOWN_UNION_ALL",
    "input_slice": "with wscs as\n (select sold_date_sk, sales_price\n  from (select ws_sold_date_sk sold_date_sk, ws_ext_sales_price sales_price\n        from web_sales\n        union all\n        select cs_sold_date_sk sold_date_sk, cs_ext_sales_price sales_price\n        from catalog_sales)),\n wswscs as\n (select d_week_seq, sum(case when ...) ...\n from wscs, date_dim\n where d_date_sk = sold_date_sk\n group by d_week_seq)",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "predicate_transitivity",
          "nodes": {
            "sk_range_lookup": "SELECT MIN(d_date_sk), MAX(d_date_sk) FROM date_dim WHERE d_year IN (1998, 1999)",
            "wscs_with_pushdown": "UNION ALL branches each get: WHERE ws/cs_sold_date_sk BETWEEN <sk_min> AND <sk_max>",
            "comma_to_explicit": "FROM wscs, date_dim WHERE d_date_sk = sold_date_sk â†’ FROM wscs JOIN date_dim ON d_date_sk = sold_date_sk"
          },
          "invariants_kept": [
            "same result rows",
            "same aggregation",
            "same ORDER BY"
          ],
          "expected_speedup": "2x",
          "risk": "low"
        }
      ]
    },
    "transforms": [
      "predicate_transitivity",
      "sk_range_pushdown"
    ],
    "key_insight": "Snowflake cannot push date_sk ranges through UNION ALL CTEs. The wscs CTE scans ALL web_sales + catalog_sales partitions even though only 2 years of data are needed. Adding explicit sold_date_sk BETWEEN filters inside each UNION ALL branch enables micro-partition pruning, cutting scan volume dramatically. The multi-ref CTE (wswscs used twice for year 1998 and 1999) amplifies the benefit."
  },
  "original_sql": "with wscs as\n (select sold_date_sk, sales_price\n  from (select ws_sold_date_sk sold_date_sk, ws_ext_sales_price sales_price\n        from web_sales\n        union all\n        select cs_sold_date_sk sold_date_sk, cs_ext_sales_price sales_price\n        from catalog_sales)),\n wswscs as\n (select d_week_seq,\n        sum(case when (d_day_name='Sunday') then sales_price else null end) sun_sales,\n        sum(case when (d_day_name='Monday') then sales_price else null end) mon_sales,\n        sum(case when (d_day_name='Tuesday') then sales_price else null end) tue_sales,\n        sum(case when (d_day_name='Wednesday') then sales_price else null end) wed_sales,\n        sum(case when (d_day_name='Thursday') then sales_price else null end) thu_sales,\n        sum(case when (d_day_name='Friday') then sales_price else null end) fri_sales,\n        sum(case when (d_day_name='Saturday') then sales_price else null end) sat_sales\n from wscs, date_dim\n where d_date_sk = sold_date_sk\n group by d_week_seq)\n select d_week_seq1,\n       round(sun_sales1/sun_sales2,2),\n       round(mon_sales1/mon_sales2,2),\n       round(tue_sales1/tue_sales2,2),\n       round(wed_sales1/wed_sales2,2),\n       round(thu_sales1/thu_sales2,2),\n       round(fri_sales1/fri_sales2,2),\n       round(sat_sales1/sat_sales2,2)\n from\n (select wswscs.d_week_seq d_week_seq1,\n        sun_sales sun_sales1, mon_sales mon_sales1, tue_sales tue_sales1,\n        wed_sales wed_sales1, thu_sales thu_sales1, fri_sales fri_sales1,\n        sat_sales sat_sales1\n  from wswscs, date_dim\n  where date_dim.d_week_seq = wswscs.d_week_seq and d_year = 1998) y,\n (select wswscs.d_week_seq d_week_seq2,\n        sun_sales sun_sales2, mon_sales mon_sales2, tue_sales tue_sales2,\n        wed_sales wed_sales2, thu_sales thu_sales2, fri_sales fri_sales2,\n        sat_sales sat_sales2\n  from wswscs, date_dim\n  where date_dim.d_week_seq = wswscs.d_week_seq and d_year = 1998+1) z\n where d_week_seq1=d_week_seq2-53\n order by d_week_seq1",
  "optimized_sql": "with wscs as\n (select sold_date_sk, sales_price\n  from (select ws_sold_date_sk sold_date_sk, ws_ext_sales_price sales_price\n        from web_sales\n        where ws_sold_date_sk BETWEEN 2450815 AND 2451544\n        union all\n        select cs_sold_date_sk sold_date_sk, cs_ext_sales_price sales_price\n        from catalog_sales\n        where cs_sold_date_sk BETWEEN 2450815 AND 2451544)),\n wswscs as\n (select d_week_seq,\n        sum(case when (d_day_name='Sunday') then sales_price else null end) sun_sales,\n        sum(case when (d_day_name='Monday') then sales_price else null end) mon_sales,\n        sum(case when (d_day_name='Tuesday') then sales_price else null end) tue_sales,\n        sum(case when (d_day_name='Wednesday') then sales_price else null end) wed_sales,\n        sum(case when (d_day_name='Thursday') then sales_price else null end) thu_sales,\n        sum(case when (d_day_name='Friday') then sales_price else null end) fri_sales,\n        sum(case when (d_day_name='Saturday') then sales_price else null end) sat_sales\n from wscs\n JOIN date_dim ON d_date_sk = sold_date_sk\n group by d_week_seq)\n select d_week_seq1,\n       round(sun_sales1/sun_sales2,2),\n       round(mon_sales1/mon_sales2,2),\n       round(tue_sales1/tue_sales2,2),\n       round(wed_sales1/wed_sales2,2),\n       round(thu_sales1/thu_sales2,2),\n       round(fri_sales1/fri_sales2,2),\n       round(sat_sales1/sat_sales2,2)\n from\n (select wswscs.d_week_seq d_week_seq1,\n        sun_sales sun_sales1, mon_sales mon_sales1, tue_sales tue_sales1,\n        wed_sales wed_sales1, thu_sales thu_sales1, fri_sales fri_sales1,\n        sat_sales sat_sales1\n  from wswscs\n  JOIN date_dim ON date_dim.d_week_seq = wswscs.d_week_seq\n  where d_year = 1998) y,\n (select wswscs.d_week_seq d_week_seq2,\n        sun_sales sun_sales2, mon_sales mon_sales2, tue_sales tue_sales2,\n        wed_sales wed_sales2, thu_sales thu_sales2, fri_sales fri_sales2,\n        sat_sales sat_sales2\n  from wswscs\n  JOIN date_dim ON date_dim.d_week_seq = wswscs.d_week_seq\n  where d_year = 1998+1) z\n where d_week_seq1=d_week_seq2-53\n order by d_week_seq1",
  "type": "gold",
  "family": "A",
  "patch_plan": {
    "plan_id": "gold_sf_sk_pushdown_union_all",
    "dialect": "snowflake",
    "description": "Push date_sk BETWEEN into UNION ALL branches for micro-partition pruning + convert comma joins to explicit JOINs. Note: UNION ALL branch modification requires replace_body since patch engine cannot target individual UNION branches.",
    "preconditions": [{"kind": "parse_ok"}],
    "postconditions": [{"kind": "parse_ok"}],
    "steps": [
      {
        "step_id": "s1",
        "op": "insert_cte",
        "target": {"by_node_id": "S0"},
        "payload": {
          "cte_name": "sk_range",
          "cte_query_sql": "SELECT MIN(d_date_sk) AS sk_min, MAX(d_date_sk) AS sk_max FROM date_dim WHERE d_year IN (1998, 1999)"
        },
        "description": "Compute date_sk range for micro-partition pruning"
      },
      {
        "step_id": "s2",
        "op": "replace_from",
        "target": {"by_node_id": "S0", "by_anchor_hash": "a502d7ffeceaa78e"},
        "payload": {
          "from_sql": "wscs JOIN date_dim ON d_date_sk = sold_date_sk"
        },
        "description": "Convert wswscs CTE comma join to explicit JOIN"
      }
    ]
  },
  "ir_node_map_before": "S0 [SELECT]\n  CTE: wscs  (via CTE_Q_S0_wscs)\n    FROM: (subquery) \n  CTE: wswscs  (via CTE_Q_S0_wswscs)\n    FROM: wscs, date_dim\n    WHERE [a502d7ffeceaa78e]: d_date_sk = sold_date_sk\n    GROUP BY: d_week_seq\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) y, (subquery) z\n    WHERE [114524ba4f840dfa]: d_week_seq1 = d_week_seq2 - 53\n    ORDER BY: d_week_seq1",
  "ir_node_map_target": "S0 [SELECT]\n  CTE: sk_range  (via CTE_Q_S0_sk_range)\n    FROM: date_dim\n    WHERE: d_year IN (1998, 1999)\n  CTE: wscs  (via CTE_Q_S0_wscs)\n    FROM: (subquery with WHERE ws/cs_sold_date_sk BETWEEN sk_min AND sk_max)\n  CTE: wswscs  (via CTE_Q_S0_wswscs)\n    FROM: wscs JOIN date_dim ON d_date_sk = sold_date_sk\n    GROUP BY: d_week_seq\n  MAIN QUERY (via Q_S0)\n    FROM: (subquery) y, (subquery) z\n    WHERE: d_week_seq1 = d_week_seq2 - 53\n    ORDER BY: d_week_seq1"
}
