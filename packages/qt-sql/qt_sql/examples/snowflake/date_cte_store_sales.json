{
  "id": "sf_date_cte_store_sales",
  "name": "Date CTE Isolation \u2014 Store Sales (Snowflake)",
  "description": "Isolate date_dim filter into CTE for store_sales comma-join queries. Simplest P1 pattern \u2014 3-table join with date filter in WHERE.",
  "verified_speedup": "TIMEOUT->3.5s",
  "principle": "Date CTE Isolation + Explicit Joins: isolate date_dim filter into a CTE, then explicitly JOIN the fact table. Comma joins between store_sales and date_dim prevent Snowflake runtime micro-partition pruning. The optimizer assigns all 73K micro-partitions before resolving the date filter.",
  "benchmark_queries": [
    "Q55",
    "Q36",
    "Q53",
    "Q48",
    "Q65"
  ],
  "example": {
    "opportunity": "SF_DATE_CTE_EXPLICIT_JOIN",
    "input_slice": "select i_brand_id brand_id, i_brand brand,\n \tsum(ss_ext_sales_price) ext_price\n from date_dim, store_sales, item\n where d_date_sk = ss_sold_date_sk\n \tand ss_item_sk = i_item_sk\n \tand i_manager_id=100\n \tand d_moy=12\n \tand d_year=2000\n group by i_brand, i_brand_id\n order by ext_price desc, i_brand_id\n LIMIT 100",
    "output": {
      "rewrite_sets": [
        {
          "id": "rs_01",
          "transform": "sf_date_cte_explicit_join",
          "nodes": {
            "date_filter": "SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 2000",
            "main_query": "SELECT i_brand_id brand_id, i_brand brand, SUM(ss_ext_sales_price) ext_price FROM store_sales JOIN date_filter ON d_date_sk = ss_sold_date_sk JOIN item ON ss_item_sk = i_item_sk WHERE i_manager_id = 100 GROUP BY i_brand, i_brand_id ORDER BY ext_price DESC, i_brand_id LIMIT 100"
          },
          "invariants_kept": [
            "output columns unchanged",
            "grain preserved",
            "same result rows"
          ],
          "expected_speedup": "TIMEOUT->3.5s",
          "risk": "low"
        }
      ]
    },
    "transforms": [
      "sf_date_cte_explicit_join"
    ],
    "key_insight": "Simplest P1 pattern: 3-table comma join (date_dim, store_sales, item) with date filter in WHERE. Extract date_dim filter into CTE, convert comma joins to explicit JOINs. Snowflake can then prune store_sales micro-partitions at runtime. Works for any store_sales/catalog_sales/web_sales query with date_dim comma join."
  },
  "original_sql": "select i_brand_id brand_id, i_brand brand,\n \tsum(ss_ext_sales_price) ext_price\n from date_dim, store_sales, item\n where d_date_sk = ss_sold_date_sk\n \tand ss_item_sk = i_item_sk\n \tand i_manager_id=100\n \tand d_moy=12\n \tand d_year=2000\n group by i_brand, i_brand_id\n order by ext_price desc, i_brand_id\n LIMIT 100;",
  "optimized_sql": "WITH date_filter AS (\n    SELECT d_date_sk FROM date_dim WHERE d_moy = 12 AND d_year = 2000\n)\nSELECT i_brand_id brand_id, i_brand brand,\n    SUM(ss_ext_sales_price) ext_price\nFROM store_sales\n    JOIN date_filter ON d_date_sk = ss_sold_date_sk\n    JOIN item ON ss_item_sk = i_item_sk\nWHERE i_manager_id = 100\nGROUP BY i_brand, i_brand_id\nORDER BY ext_price DESC, i_brand_id\nLIMIT 100;",
  "optimized_source": "manual",
  "type": "gold",
  "family": "F"
}