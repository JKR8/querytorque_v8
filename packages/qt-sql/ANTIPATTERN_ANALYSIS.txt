================================================================================
ANTI-PATTERN SYSTEM: HONEST ASSESSMENT
================================================================================
Updated: 2026-02-02

TL;DR: The anti-pattern detector is broken. It finds noise, not signal.
       The audit command shows users meaningless scores.
       Kill it or rebuild it from scratch.

================================================================================
THE PROBLEM
================================================================================

We have 44 anti-pattern rules. On TPC-DS benchmark (99 queries):
  - 841 total issues detected (avg 8.5 per query)
  - 99/99 queries flagged (100% - everything is "bad")
  - No correlation between issue count and optimization success

This is useless. If everything is flagged, nothing is flagged.

================================================================================
PROOF: ANTI-PATTERNS DON'T PREDICT OPTIMIZATION SUCCESS
================================================================================

Pattern                  Detected  Improved  Neutral  Regressed  Failed
-------------------------------------------------------------------------
SQL-JOIN-001 Cartesian      86        30        25        14        17
SQL-JOIN-002 Implicit       95        30        31        16        18
QT-AGG-002   Agg After Join 79        20        29        16        14

These patterns fire on almost every query. They don't predict anything.

Patterns that MIGHT be useful (but still have <50% hit rate):
  SQL-SUB-001  Correlated Subquery    60% hit rate (3/5)
  SQL-CTE-001  CTE Multi-Reference    61% hit rate (11/18)

================================================================================
THE KNOWLEDGE BASE DISCONNECT
================================================================================

We have 9 "proven" patterns in KNOWLEDGE_BASE_PATTERNS (payload_builder.py):
  - SQL-DUCK-014: Grouped TOPN via LATERAL
  - SQL-DUCK-011: CROSS JOIN UNNEST filter pushdown
  - SQL-DUCK-012: Window blocks predicate pushdown
  - SQL-WHERE-010: OR to UNION ALL
  - SQL-SUB-007: Correlated subquery to window
  - SQL-JOIN-008: Self-join to window function
  - SQL-ORD-005: OFFSET to keyset pagination
  - SQL-JOIN-011: Triangular join to window
  - SQL-AGG-009: COUNT DISTINCT to approximate

PROBLEM: The detector doesn't emit these rule IDs!

The detector finds: SQL-JOIN-001, SQL-JOIN-002, QT-AGG-002...
The knowledge base expects: SQL-DUCK-014, SQL-SUB-007, SQL-JOIN-008...

These are DIFFERENT rule IDs. The knowledge base patterns NEVER GET TRIGGERED
by the detector. They just sit there unused.

================================================================================
WHAT ACTUALLY WORKS FOR OPTIMIZATION
================================================================================

The successful optimizations come from:
  1. Execution plan analysis (actual timing, row counts, operator costs)
  2. Block map structural analysis (CTE refs, filter gaps, join order)
  3. The LLM figuring it out from the SQL itself

Anti-patterns contribute NOTHING to successful optimizations.

================================================================================
IS THE AUDIT COMMAND VALUABLE?
================================================================================

Current state:
  $ qt-sql audit query.sql
  > Found 12 issues, Score: 65/100

What does "Score: 65/100" mean?
  - It's based on penalty points from detected anti-patterns
  - But those anti-patterns are mostly false positives
  - A query with score 65 might run faster than one with score 95
  - The score is MEANINGLESS

Customer value: NONE. It's theater.

The only potentially useful audit output would be:
  - Execution plan analysis (requires database connection)
  - Specific, actionable issues with HIGH precision

================================================================================
OPTIONS
================================================================================

OPTION A: Kill the anti-pattern detector entirely
  - Remove `qt-sql audit` command
  - Remove all 44 rule files
  - Just do optimization with plan analysis
  - Pros: Clean, honest, no misleading scores
  - Cons: Lose "free" static analysis (even if noisy)

OPTION B: Gut it down to ~5 high-precision rules
  - Keep ONLY rules with >50% optimization hit rate
  - Remove the score system (it's meaningless)
  - Show specific issues with concrete fixes
  - Pros: Some static analysis value
  - Cons: Still need to validate each rule works

OPTION C: Replace with execution plan audit
  - `qt-sql audit query.sql -d database.duckdb`
  - Run EXPLAIN ANALYZE, report actual bottlenecks
  - No AST rules, just real performance data
  - Pros: Actually useful, not guessing
  - Cons: Requires database connection + data

OPTION D: Rebuild detector around KNOWLEDGE_BASE patterns
  - Write new AST detection for the 9 proven patterns
  - `detect_knowledge_patterns()` in dspy_optimizer.py does this
  - Fires on 19/99 queries (vs 99/99 with current detector)
  - Pros: High precision, actionable
  - Cons: Small coverage (19% of queries)

================================================================================
RECOMMENDATION
================================================================================

Go with OPTION C + D combined:

1. `qt-sql audit query.sql` (no database)
   - Use detect_knowledge_patterns() for static analysis
   - Only show issues we have concrete rewrites for
   - No score, just "0-3 actionable patterns found"

2. `qt-sql audit query.sql -d db.duckdb` (with database)
   - Run EXPLAIN ANALYZE
   - Show actual bottlenecks with timing data
   - This is the real value

3. Delete the 44 noisy anti-pattern rules
   - They don't help optimization
   - They don't help users
   - They're technical debt

================================================================================
CURRENT STATE (as of 2026-02-02)
================================================================================

DSPy optimization: Does NOT use anti-patterns (correct)
MCTS optimization: Does NOT use anti-patterns (correct)
payload_builder:   Filters to critical/high only (mostly useless)
CLI audit:         Shows all 44 rules with meaningless score (broken)

The detect_knowledge_patterns() function exists but isn't used in audit.
It should replace the anti-pattern detector.

================================================================================
ACTION ITEMS
================================================================================

[ ] 1. Decide: Keep audit command or remove it?
[ ] 2. If keep: Replace detector with detect_knowledge_patterns()
[ ] 3. If keep: Add execution plan audit with -d flag
[ ] 4. Delete the 44 noisy rule files (or archive them)
[ ] 5. Remove the score system from audit output
