```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates_2001": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001",
        "filtered_dates_2002": "SELECT d_date_sk FROM date_dim WHERE d_year = 2002",
        "store_sales_2001": "SELECT ss_customer_sk, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total FROM store_sales JOIN filtered_dates_2001 ON ss_sold_date_sk = d_date_sk GROUP BY ss_customer_sk HAVING SUM(ss_ext_list_price - ss_ext_discount_amt) > 0",
        "store_sales_2002": "SELECT ss_customer_sk, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total FROM store_sales JOIN filtered_dates_2002 ON ss_sold_date_sk = d_date_sk GROUP BY ss_customer_sk",
        "web_sales_2001": "SELECT ws_bill_customer_sk, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total FROM web_sales JOIN filtered_dates_2001 ON ws_sold_date_sk = d_date_sk GROUP BY ws_bill_customer_sk HAVING SUM(ws_ext_list_price - ws_ext_discount_amt) > 0",
        "web_sales_2002": "SELECT ws_bill_customer_sk, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total FROM web_sales JOIN filtered_dates_2002 ON ws_sold_date_sk = d_date_sk GROUP BY ws_bill_customer_sk",
        "main_query": "SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_birth_country AS customer_birth_country FROM store_sales_2001 s1 JOIN store_sales_2002 s2 ON s1.ss_customer_sk = s2.ss_customer_sk JOIN web_sales_2001 w1 ON s1.ss_customer_sk = w1.ws_bill_customer_sk JOIN web_sales_2002 w2 ON s1.ss_customer_sk = w2.ws_bill_customer_sk JOIN customer c ON s1.ss_customer_sk = c.c_customer_sk WHERE w2.year_total / w1.year_total > s2.year_total / s1.year_total ORDER BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same ordering",
        "same column output",
        "same join conditions via customer_sk"
      ],
      "expected_speedup": "3.5x",
      "risk": "low"
    }
  ],
  "explanation": "Original query computed union of all store+web sales for all years, then self-joined 4 times with filters. This pushes year filters into date_dim CTEs early, reduces full table scans of store_sales/web_sales from 4 to 2 each (by year), applies HAVING clause for >0 early, and avoids materializing large union results. Expected speedup from eliminating massive misestimated projections and early filtering."
}
```