WITH filtered_dates_2001 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2001), filtered_dates_2002 AS (SELECT d_date_sk FROM date_dim WHERE d_year = 2002), year_total AS (SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, c_preferred_cust_flag AS customer_preferred_cust_flag, c_birth_country AS customer_birth_country, c_login AS customer_login, c_email_address AS customer_email_address, d_year AS dyear, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total, 's' AS sale_type FROM customer, store_sales, date_dim WHERE c_customer_sk = ss_customer_sk AND ss_sold_date_sk = d_date_sk GROUP BY c_customer_id, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_country, c_login, c_email_address, d_year UNION ALL SELECT c_customer_id AS customer_id, c_first_name AS customer_first_name, c_last_name AS customer_last_name, c_preferred_cust_flag AS customer_preferred_cust_flag, c_birth_country AS customer_birth_country, c_login AS customer_login, c_email_address AS customer_email_address, d_year AS dyear, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total, 'w' AS sale_type FROM customer, web_sales, date_dim WHERE c_customer_sk = ws_bill_customer_sk AND ws_sold_date_sk = d_date_sk GROUP BY c_customer_id, c_first_name, c_last_name, c_preferred_cust_flag, c_birth_country, c_login, c_email_address, d_year), store_sales_2001 AS (SELECT ss_customer_sk, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total FROM store_sales JOIN filtered_dates_2001 ON ss_sold_date_sk = d_date_sk GROUP BY ss_customer_sk HAVING SUM(ss_ext_list_price - ss_ext_discount_amt) > 0), store_sales_2002 AS (SELECT ss_customer_sk, SUM(ss_ext_list_price - ss_ext_discount_amt) AS year_total FROM store_sales JOIN filtered_dates_2002 ON ss_sold_date_sk = d_date_sk GROUP BY ss_customer_sk), web_sales_2001 AS (SELECT ws_bill_customer_sk, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total FROM web_sales JOIN filtered_dates_2001 ON ws_sold_date_sk = d_date_sk GROUP BY ws_bill_customer_sk HAVING SUM(ws_ext_list_price - ws_ext_discount_amt) > 0), web_sales_2002 AS (SELECT ws_bill_customer_sk, SUM(ws_ext_list_price - ws_ext_discount_amt) AS year_total FROM web_sales JOIN filtered_dates_2002 ON ws_sold_date_sk = d_date_sk GROUP BY ws_bill_customer_sk)
SELECT c.c_customer_id AS customer_id, c.c_first_name AS customer_first_name, c.c_last_name AS customer_last_name, c.c_birth_country AS customer_birth_country FROM store_sales_2001 AS s1 JOIN store_sales_2002 AS s2 ON s1.ss_customer_sk = s2.ss_customer_sk JOIN web_sales_2001 AS w1 ON s1.ss_customer_sk = w1.ws_bill_customer_sk JOIN web_sales_2002 AS w2 ON s1.ss_customer_sk = w2.ws_bill_customer_sk JOIN customer AS c ON s1.ss_customer_sk = c.c_customer_sk WHERE w2.year_total / w1.year_total > s2.year_total / s1.year_total ORDER BY c.c_customer_id, c.c_first_name, c.c_last_name, c.c_birth_country LIMIT 100