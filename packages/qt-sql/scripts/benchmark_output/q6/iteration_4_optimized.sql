WITH target_month_seq AS (SELECT DISTINCT d_month_seq FROM date_dim WHERE d_year = 2002 AND d_moy = 3), filtered_dates AS (SELECT d_date_sk FROM date_dim WHERE d_month_seq = (SELECT d_month_seq FROM target_month_seq)), category_avg_price AS (SELECT i_category, AVG(i_current_price) * 1.2 AS avg_threshold FROM item GROUP BY i_category), filtered_items_by_price AS (SELECT i_item_sk, i_category FROM item AS i JOIN category_avg_price AS cap ON i.i_category = cap.i_category WHERE i.i_current_price > cap.avg_threshold), early_filtered_sales AS (SELECT ss_customer_sk, ss_item_sk FROM store_sales AS ss JOIN filtered_dates AS fd ON ss.ss_sold_date_sk = fd.d_date_sk JOIN filtered_items_by_price AS fip ON ss.ss_item_sk = fip.i_item_sk), filtered_sales_items AS (SELECT ss_customer_sk, ss_item_sk FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk)
SELECT a.ca_state AS state, COUNT(*) AS cnt FROM customer_address AS a JOIN customer AS c ON a.ca_address_sk = c.c_current_addr_sk JOIN early_filtered_sales AS s ON c.c_customer_sk = s.ss_customer_sk GROUP BY a.ca_state HAVING COUNT(*) >= 10 ORDER BY cnt, a.ca_state LIMIT 100