```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "dates_3years": "SELECT d_date_sk FROM date_dim WHERE d_year BETWEEN 2000 AND 2000 + 2",
        "date_nov2002": "SELECT d_date_sk FROM date_dim WHERE d_year = 2000 + 2 AND d_moy = 11",
        "cross_items": "SELECT i_item_sk AS ss_item_sk FROM item, (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id FROM store_sales, item AS iss, dates_3years AS d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, item AS ics, dates_3years AS d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, item AS iws, dates_3years AS d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk) WHERE i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id",
        "avg_sales": "SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, dates_3years WHERE ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, dates_3years WHERE cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, dates_3years WHERE ws_sold_date_sk = d_date_sk) AS x",
        "main_query": "SELECT channel, i_brand_id, i_class_id, i_category_id, SUM(sales), SUM(number_sales) FROM (SELECT 'store' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ss_quantity * ss_list_price) AS sales, COUNT(*) AS number_sales FROM store_sales, item, date_nov2002 WHERE ss_item_sk IN (SELECT ss_item_sk FROM cross_items) AND ss_item_sk = i_item_sk AND ss_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ss_quantity * ss_list_price) > (SELECT average_sales FROM avg_sales) UNION ALL SELECT 'catalog' AS channel, i_brand_id, i_class_id, i_category_id, SUM(cs_quantity * cs_list_price) AS sales, COUNT(*) AS number_sales FROM catalog_sales, item, date_nov2002 WHERE cs_item_sk IN (SELECT ss_item_sk FROM cross_items) AND cs_item_sk = i_item_sk AND cs_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(cs_quantity * cs_list_price) > (SELECT average_sales FROM avg_sales) UNION ALL SELECT 'web' AS channel, i_brand_id, i_class_id, i_category_id, SUM(ws_quantity * ws_list_price) AS sales, COUNT(*) AS number_sales FROM web_sales, item, date_nov2002 WHERE ws_item_sk IN (SELECT ss_item_sk FROM cross_items) AND ws_item_sk = i_item_sk AND ws_sold_date_sk = d_date_sk GROUP BY i_brand_id, i_class_id, i_category_id HAVING SUM(ws_quantity * ws_list_price) > (SELECT average_sales FROM avg_sales)) AS y GROUP BY ROLLUP (channel, i_brand_id, i_class_id, i_category_id) ORDER BY channel, i_brand_id, i_class_id, i_category_id LIMIT 100"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same result rows",
        "same grouping and ordering"
      ],
      "expected_speedup": "2.5x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "materialize_cte",
      "nodes": {
        "cross_items": "SELECT i_item_sk AS ss_item_sk FROM item, (SELECT iss.i_brand_id AS brand_id, iss.i_class_id AS class_id, iss.i_category_id AS category_id FROM store_sales, item AS iss, dates_3years AS d1 WHERE ss_item_sk = iss.i_item_sk AND ss_sold_date_sk = d1.d_date_sk INTERSECT SELECT ics.i_brand_id, ics.i_class_id, ics.i_category_id FROM catalog_sales, item AS ics, dates_3years AS d2 WHERE cs_item_sk = ics.i_item_sk AND cs_sold_date_sk = d2.d_date_sk INTERSECT SELECT iws.i_brand_id, iws.i_class_id, iws.i_category_id FROM web_sales, item AS iws, dates_3years AS d3 WHERE ws_item_sk = iws.i_item_sk AND ws_sold_date_sk = d3.d_date_sk) WHERE i_brand_id = brand_id AND i_class_id = class_id AND i_category_id = category_id",
        "avg_sales": "SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price FROM store_sales, dates_3years WHERE ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price FROM catalog_sales, dates_3years WHERE cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price FROM web_sales, dates_3years WHERE ws_sold_date_sk = d_date_sk) AS x"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same computation results"
      ],
      "expected_speedup": "1.8x",
      "risk": "low"
    },
    {
      "id": "rs_03",
      "transform": "semantic_rewrite",
      "nodes": {
        "avg_sales": "SELECT AVG(quantity * list_price) AS average_sales FROM (SELECT ss_quantity AS quantity, ss_list_price AS list_price, 0 AS src FROM store_sales, dates_3years WHERE ss_sold_date_sk = d_date_sk UNION ALL SELECT cs_quantity AS quantity, cs_list_price AS list_price, 1 AS src FROM catalog_sales, dates_3years WHERE cs_sold_date_sk = d_date_sk UNION ALL SELECT ws_quantity AS quantity, ws_list_price AS list_price, 2 AS src FROM web_sales, dates_3years WHERE ws_sold_date_sk = d_date_sk) AS x"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same average value"
      ],
      "expected_speedup": "1.1x",
      "risk": "low"
    }
  ],
  "explanation": "Created isolated date CTEs to avoid repeated date_dim scans across all subqueries. Materialized cross_items and avg_sales CTEs since they're referenced multiple times. Added src column to union for potential parallelization benefits while maintaining same average calculation."
}
```