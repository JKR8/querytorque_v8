WITH sold_dates AS (SELECT d_date_sk, d_week_seq, d_date FROM date_dim WHERE d_year = 2002), ship_dates AS (SELECT d_date_sk, d_date FROM date_dim), filtered_cd AS (SELECT cd_demo_sk FROM customer_demographics WHERE cd_marital_status = 'W'), filtered_hd AS (SELECT hd_demo_sk FROM household_demographics WHERE hd_buy_potential = '501-1000'), inventory_with_week AS (SELECT inv_item_sk, inv_warehouse_sk, inv_date_sk, inv_quantity_on_hand, d_week_seq FROM inventory JOIN date_dim ON inv_date_sk = d_date_sk), filtered_sales AS (SELECT cs_item_sk, cs_order_number, cs_promo_sk, cs_bill_cdemo_sk, cs_bill_hdemo_sk, cs_sold_date_sk, cs_ship_date_sk, cs_quantity FROM catalog_sales JOIN sold_dates ON cs_sold_date_sk = sold_dates.d_date_sk JOIN ship_dates ON cs_ship_date_sk = ship_dates.d_date_sk WHERE ship_dates.d_date > sold_dates.d_date + 5)
SELECT i_item_desc, w_warehouse_name, sold_dates.d_week_seq, SUM(CASE WHEN p_promo_sk IS NULL THEN 1 ELSE 0 END) AS no_promo, SUM(CASE WHEN NOT p_promo_sk IS NULL THEN 1 ELSE 0 END) AS promo, COUNT(*) AS total_cnt FROM filtered_sales JOIN inventory_with_week ON (cs_item_sk = inv_item_sk AND sold_dates.d_week_seq = inventory_with_week.d_week_seq) JOIN warehouse ON (w_warehouse_sk = inv_warehouse_sk) JOIN item ON (i_item_sk = cs_item_sk) JOIN filtered_cd ON (cs_bill_cdemo_sk = filtered_cd.cd_demo_sk) JOIN filtered_hd ON (cs_bill_hdemo_sk = filtered_hd.hd_demo_sk) LEFT OUTER JOIN promotion ON (cs_promo_sk = p_promo_sk) LEFT OUTER JOIN catalog_returns ON (cr_item_sk = cs_item_sk AND cr_order_number = cs_order_number) WHERE inv_quantity_on_hand < cs_quantity GROUP BY i_item_desc, w_warehouse_name, sold_dates.d_week_seq ORDER BY total_cnt DESC, i_item_desc, w_warehouse_name, sold_dates.d_week_seq LIMIT 100