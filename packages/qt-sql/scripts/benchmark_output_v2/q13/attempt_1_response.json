```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "or_to_union",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_year = 2001",
        "filtered_store": "SELECT s_store_sk FROM store",
        "branch_1": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'D' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND ca_country = 'United States' AND ca_state IN ('SD', 'KS', 'MI') AND ss_net_profit BETWEEN 100 AND 200",
        "branch_2": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'D' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND ca_country = 'United States' AND ca_state IN ('MO', 'ND', 'CO') AND ss_net_profit BETWEEN 150 AND 300",
        "branch_3": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'D' AND cd_education_status = 'Unknown' AND ss_sales_price BETWEEN 100.00 AND 150.00 AND hd_dep_count = 3 AND ca_country = 'United States' AND ca_state IN ('NH', 'OH', 'TX') AND ss_net_profit BETWEEN 50 AND 250",
        "branch_4": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'S' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('SD', 'KS', 'MI') AND ss_net_profit BETWEEN 100 AND 200",
        "branch_5": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'S' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('MO', 'ND', 'CO') AND ss_net_profit BETWEEN 150 AND 300",
        "branch_6": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'S' AND cd_education_status = 'College' AND ss_sales_price BETWEEN 50.00 AND 100.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('NH', 'OH', 'TX') AND ss_net_profit BETWEEN 50 AND 250",
        "branch_7": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('SD', 'KS', 'MI') AND ss_net_profit BETWEEN 100 AND 200",
        "branch_8": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('MO', 'ND', 'CO') AND ss_net_profit BETWEEN 150 AND 300",
        "branch_9": "SELECT ss_quantity, ss_ext_sales_price, ss_ext_wholesale_cost FROM store_sales JOIN filtered_dates ON ss_sold_date_sk = d_date_sk JOIN filtered_store ON s_store_sk = ss_store_sk JOIN customer_demographics ON cd_demo_sk = ss_cdemo_sk JOIN household_demographics ON hd_demo_sk = ss_hdemo_sk JOIN customer_address ON ca_address_sk = ss_addr_sk WHERE cd_marital_status = 'M' AND cd_education_status = '4 yr Degree' AND ss_sales_price BETWEEN 150.00 AND 200.00 AND hd_dep_count = 1 AND ca_country = 'United States' AND ca_state IN ('NH', 'OH', 'TX') AND ss_net_profit BETWEEN 50 AND 250",
        "main_query": "SELECT AVG(ss_quantity) AS \"AVG(ss_quantity)\", AVG(ss_ext_sales_price) AS \"AVG(ss_ext_sales_price)\", AVG(ss_ext_wholesale_cost) AS \"AVG(ss_ext_wholesale_cost)\", SUM(ss_ext_wholesale_cost) AS \"SUM(ss_ext_wholesale_cost)\" FROM (SELECT * FROM branch_1 UNION ALL SELECT * FROM branch_2 UNION ALL SELECT * FROM branch_3 UNION ALL SELECT * FROM branch_4 UNION ALL SELECT * FROM branch_5 UNION ALL SELECT * FROM branch_6 UNION ALL SELECT * FROM branch_7 UNION ALL SELECT * FROM branch_8 UNION ALL SELECT * FROM branch_9) AS all_branches"
      },
      "invariants_kept": [
        "output columns unchanged",
        "same aggregation results",
        "same rows after aggregation"
      ],
      "expected_speedup": "2.98x",
      "risk": "low"
    }
  ],
  "explanation": "The original query has complex OR conditions spanning 9 disjoint scenarios (3Ã—3 combinations). By converting to UNION ALL with 9 branches, each branch can use focused indexes on specific columns. Date filter is extracted as CTE to enable early filtering. This reduces the join fanout and allows the optimizer to choose better access paths for each scenario."
}
```