┌─────────────────────────────────────────────────────────────────────────────────┐
│                          qt-calcite Architecture                                │
│                   Java Calcite + LLM Query Optimizer Service                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────────┐
                              │  qtcalcite CLI   │
                              └────────┬─────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │   manual    │            │    auto     │            │tpcds-bench  │
    │  (ManualCmd)│            │  (AutoCmd)  │            │ (Benchmark) │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           ▼                          ▼                          ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │ Apply rules │            │  LLM-guided │            │ TPC-DS bulk │
    │ manually    │            │ optimization│            │ benchmarking│
    │             │            │             │            │             │
    │ --rule X    │            │ Uses Volcano│            │ 99 queries  │
    │ --all-rules │            │ + LLM loop  │            │ comparisons │
    └──────┬──────┘            └──────┬──────┘            └─────────────┘
           │                          │
           │                          │
           └──────────┬───────────────┘
                      │
                      ▼
┌──────────────────────────────────────────────────────────────────────────────────┐
│                        OPTIMIZATION PIPELINE                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                    OptimizationPipeline.java                               │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│    ┌─────────────────────────────────────────────────────────────────────────┐   │
│    │ 1. PARSE SQL                                                            │   │
│    │    DuckDB dialect → Calcite SqlNode                                     │   │
│    └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                      ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────────┐   │
│    │ 2. BUILD RELATIONAL ALGEBRA                                             │   │
│    │    SqlNode → RelNode (logical plan)                                     │   │
│    └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                      ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────────┐   │
│    │ 3. VOLCANO OPTIMIZER                                                    │   │
│    │    Apply transformation rules via cost-based search                     │   │
│    └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                      ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────────┐   │
│    │ 4. GENERATE SQL                                                         │   │
│    │    RelNode → DuckDB-compatible SQL                                      │   │
│    └─────────────────────────────────────────────────────────────────────────┘   │
└──────────────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│                           RULE REGISTRY                                          │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                        RuleRegistry.java                                   │  │
│  │  Loads rules from: resources/rules/calcite-rules.json                      │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│    │FilterInto   │  │ JoinAssoc   │  │ Aggregate   │  │   Project   │           │
│    │JoinRule     │  │   Rule      │  │ Pushdown    │  │   Merge     │           │
│    └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                                   │
│    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│    │ Sort Remove │  │ Join Reorder│  │ Subquery    │  │  FK Join    │           │
│    │             │  │             │  │ Decorrelate │  │ Elimination │           │
│    └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                                   │
│    ┌─────────────┐  ┌─────────────────────────────────────────────────────────┐  │
│    │ GroupedTopN │  │  + 40+ additional Calcite optimization rules            │  │
│    │ ToLateral   │  │    (loaded from JSON config at runtime)                 │  │
│    └─────────────┘  └─────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│                         LLM INTEGRATION (Auto Mode)                              │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                    LLM-Guided Optimization Loop                            │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 1. GapDetector analyzes query → finds optimization gaps           │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 2. VolcanoPromptBuilder constructs prompt with:                   │         │
│    │    - Original SQL, Current plan, Available rules                  │         │
│    │    - DuckDB statistics, Gap analysis                              │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 3. DeepSeekClient calls DeepSeek API                              │         │
│    │    (uses reasoning model for complex optimization)                │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 4. ResponseParser extracts rule sequence from LLM response        │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 5. VolcanoOptimizer applies suggested rules                       │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 6. ResultValidator checks against DuckDB                          │         │
│    │    (compare row counts, execution time)                           │         │
│    └───────────────────────────────┬───────────────────────────────────┘         │
│                                    ▼                                             │
│    ┌───────────────────────────────────────────────────────────────────┐         │
│    │ 7. Loop if not optimal (max iterations)                           │         │
│    └───────────────────────────────────────────────────────────────────┘         │
└──────────────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│                          DUCKDB INTEGRATION                                      │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │  DuckDBAdapter.java - Native DuckDB connection via JDBC                    │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐            │
│    │ DuckDBAdapter   │    │ DuckDBSchema    │    │ DuckDBStatistics│            │
│    │                 │    │   Factory       │    │                 │            │
│    │ - execute(sql)  │    │                 │    │ - table sizes   │            │
│    │ - explain(sql)  │    │ - load tables   │    │ - cardinality   │            │
│    │ - benchmark()   │    │ - read schema   │    │ - distribution  │            │
│    └─────────────────┘    └─────────────────┘    └─────────────────┘            │
│                                                                                   │
│    ┌─────────────────┐    ┌─────────────────┐                                    │
│    │ ExplainParser   │    │ ResultValidator │                                    │
│    │                 │    │                 │                                    │
│    │ - parse plan    │    │ - compare rows  │                                    │
│    │ - extract ops   │    │ - verify equiv. │                                    │
│    └─────────────────┘    └─────────────────┘                                    │
└──────────────────────────────────────────────────────────────────────────────────┘


┌──────────────────────────────────────────────────────────────────────────────────┐
│                          FASTAPI WRAPPER                                         │
│  ┌────────────────────────────────────────────────────────────────────────────┐  │
│  │                    api/main.py (Python)                                    │  │
│  │    HTTP wrapper around Java JAR for qt-sql integration                     │  │
│  └────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                   │
│    POST /optimize                                                                 │
│    ├── sql: string         (input SQL query)                                     │
│    ├── database: string    (path to DuckDB file)                                 │
│    └── mode: string        (manual|auto)                                         │
│                                                                                   │
│    Response:                                                                      │
│    ├── optimized_sql: string                                                     │
│    ├── rules_applied: list[string]                                               │
│    ├── original_plan: string                                                     │
│    ├── optimized_plan: string                                                    │
│    └── speedup: float                                                            │
└──────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATA FLOW                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

   query.sql + tpcds.duckdb
         │
         ▼
  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐
  │ Parse SQL    │ ──► │ Build RelNode│ ──► │ Volcano Opt  │
  │ (DuckDB      │     │ (Logical     │     │ (Cost-based  │
  │  dialect)    │     │  algebra)    │     │  search)     │
  └──────────────┘     └──────────────┘     └──────┬───────┘
                                                   │
                                                   ▼
  ┌──────────────────────────────────────────────────────────────────┐
  │                      (If auto mode)                              │
  │   GapDetector ──► LLM Prompt ──► DeepSeek ──► Parse Response    │
  │        │                                           │            │
  │        └──────────────────────────────────────────►│            │
  │                                                    ▼            │
  │                                            Apply LLM-suggested  │
  │                                            rules to Volcano     │
  └──────────────────────────────────────────────────────────────────┘
                                                   │
                                                   ▼
                                          ┌──────────────┐
                                          │ Generate SQL │
                                          │ (DuckDB      │
                                          │  compatible) │
                                          └──────┬───────┘
                                                 │
                                                 ▼
                                          ┌──────────────┐
                                          │  Validate    │
                                          │ (row counts) │
                                          └──────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           COMMAND EXAMPLES                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Manual mode - apply specific rules
  java -jar qtcalcite.jar manual -d db.duckdb -q query.sql --rule FilterJoinRule

  # Manual mode - apply all registered rules
  java -jar qtcalcite.jar manual -d db.duckdb -q query.sql --all-rules

  # Auto mode - LLM-guided optimization
  java -jar qtcalcite.jar auto -d db.duckdb -q query.sql

  # Benchmark all TPC-DS queries
  java -jar qtcalcite.jar tpcds-benchmark -d tpcds.duckdb --queries-dir /path/to/queries

  # Build fat JAR
  cd packages/qt-calcite && ./gradlew fatJar

  # Run API server (port 8001)
  cd packages/qt-calcite && python api/main.py


┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ENVIRONMENT VARIABLES                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

  DEEPSEEK_API_KEY=xxx        # Required for auto mode LLM optimization
  QTCALCITE_URL=localhost:8001  # Used by qt-sql to connect to this service
