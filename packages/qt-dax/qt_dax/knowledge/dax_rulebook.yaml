rulebook:
  id: qt-dax-optimization-rulebook-v1
  goal: "Capture confirmed DAX performance wins and detection patterns for DSPy/MCTS guidance."
  scope: "DAX measures and query patterns in Power BI models (Import/Composite)."
  status: "seed"
  sources:
    - "packages/qt-dax/pbi/dax_performance_case_study.md"
    - "packages/qt-dax/dax_optimizations_extracted.jsonl"

  rules:
    - id: DAX-PERF-001
      name: "Grain-first materialize + join once (portfolio/benchmark carbon intensity)"
      confirmed: true
      observed_speedup: "~60s -> low seconds (confirmed by user)"
      applicability:
        - "Measures computing per-asset ownership * carbon/revenue with slicer-driven scope switches"
        - "Patterns with repeated SUMX('GS Asset', ...) and repeated CALCULATE(SUM(...)) inside branches"
      intent: "Move repeated row-level work into compact per-asset tables and aggregate once."

      detect_signals:
        dax_regex_any:
          - "SUMX\s*\(\s*'GS Asset'\s*,"
          - "SWITCH\s*\(\s*TRUE\s*\(\)" 
          - "SELECTEDVALUE\s*\(\s*'Scope Emission Types'\[Scope_Type_Code\]"
          - "CALCULATE\s*\(\s*SUM\(" 
        dax_structural:
          - "Repeated CALCULATE(SUM(...)) for carbon scope components within SUMX"
          - "Ownership logic inline inside SUMX (benchmark/portfolio branches)"
          - "Multiple measures chained for same calculation path"

      fix_pattern:
        steps:
          - "Precompute scope selection and market-cap mode into VARs"
          - "Build CarbonByAsset = ADDCOLUMNS(VALUES('GS Asset'[ISIN]), '@Carbon', scope-aware carbon calc)"
          - "Build OwnershipByAsset with CALCULATETABLE + KEEPFILTERS(Position_Type=...) and ADDCOLUMNS('GS Asset'[ISIN], '@Ownership', ownership logic)"
          - "Join once: NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)"
          - "Aggregate once: SUMX(Joined, [@Ownership] * [@Carbon])"
          - "For intensity metrics, compute ratio of sums: SUMX(Joined, own*carbon) / SUMX(Joined, own*revenue)"

      correctness_notes:
        - "Ensure benchmark/portfolio filters are applied consistently in both numerator and denominator"
        - "If totals exclude asset types (Cash/Futures), apply same filters inside per-asset calc"
        - "When skipping rows (e.g., revenue=0), confirm semantic alignment with original"

      example_snippets:
        before_shape: |
          SUMX(
            'GS Asset',
            VAR _Carbon = SWITCH(... CALCULATE(SUM(...)) ...)
            VAR _Ownership = IF(_IsBenchmark, ... , ...)
            RETURN _Carbon * _Ownership
          )
        after_shape: |
          VAR CarbonByAsset = ADDCOLUMNS(VALUES('GS Asset'[ISIN]), "@Carbon", ...)
          VAR OwnershipByAsset = CALCULATETABLE(ADDCOLUMNS(VALUES('GS Asset'[ISIN]), "@Ownership", ...), KEEPFILTERS(...))
          VAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)
          RETURN SUMX(Joined, [@Ownership] * [@Carbon])

      related_measures:
        - "Portfolio_Asset_Matrix MV CR Intensity Switch_BM"
        - "Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM"
