{
  "id": "grain_first_apportioned_carbon",
  "type": "win",
  "verified_speedup": "unvalidated",
  "benchmark": "ESG Carbon Intensity Model",
  "benchmark_queries": ["Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM"],
  "engine": "dax",

  "example": {
    "input_slice": "Measure chain computing MV Apportioned Carbon across 4 scope variants. Same SUMX('GS Asset', [MV Ownership_BM] * SUMX('ESG Trucost Climate', scope-specific sums)) repeated per scope. Portfolio filter via top-level CALCULATE.",
    "output": {
      "nodes": {
        "slicer_cache": "VAR _ScopeSelect, VAR _MarketCapMode",
        "carbon_grain": "ADDCOLUMNS(VALUES('GS Asset'[ISIN]), '@Carbon', scope-aware calc once)",
        "ownership_grain": "CALCULATETABLE(ADDCOLUMNS(..., '@Ownership', ...), KEEPFILTERS(Position_Type))",
        "join_aggregate": "SUMX(NATURALINNERJOIN(Ownership, Carbon), [@Ownership] * [@Carbon])"
      }
    },
    "key_insight": "Same pattern family as CR Intensity but without the ratio step — pure weighted sum. The ownership and carbon calculations are identical to the intensity case, so the grain-first approach eliminates the same repeated scans. Original: SUMX over GS Asset calling [MV Ownership_BM] (context transition per row) and nested SUMX over ESG Trucost Climate.",
    "when_not_to_use": "If the measure is only used standalone (not in a chain with CR Intensity), the simpler CALCULATE(SUM(...)) approach may be sufficient."
  },

  "transforms_applied": [
    "measure_forest_collapse",
    "cache_slicer_state",
    "grain_first_materialize"
  ],

  "timing": {
    "original_ms": 14000,
    "optimized_ms": null,
    "speedup": null,
    "validation_method": "pending"
  },

  "pathologies_addressed": ["P1", "P2"],

  "correctness_notes": [
    "Same ownership calculation as grain_first_intensity",
    "Carbon scope selection follows identical SWITCH pattern",
    "No ratio step — result is a weighted sum, not weighted intensity"
  ]
}
