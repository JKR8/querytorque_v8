{
  "id": "grain_first_intensity",
  "type": "win",
  "verified_speedup": "150x",
  "benchmark": "ESG Carbon Intensity Model",
  "benchmark_queries": ["Portfolio_Asset_Matrix MV CR Intensity Switch_BM"],
  "engine": "dax",

  "example": {
    "input_slice": "38-measure chain computing MV CR Intensity across 4 scope variants with Benchmark/Portfolio branching. SUMX over GS Asset with inline ownership, carbon, and revenue calculations. GROUPBY+SUMX for Sub_Sector rollup in Benchmark path.",
    "output": {
      "nodes": {
        "slicer_cache": "VAR _ScopeSelect = SELECTEDVALUE(...), VAR _MarketCapMode = SELECTEDVALUE(...)",
        "ownership_grain": "CALCULATETABLE(ADDCOLUMNS(SUMMARIZE('Daily Position', 'GS Asset'[ISIN]), '@Ownership', ...), KEEPFILTERS(Position_Type = 'Portfolio'))",
        "carbon_rev_grain": "ADDCOLUMNS(VALUES('GS Asset'[ISIN]), '@Revenue', ..., '@Carbon', SWITCH(_ScopeSelect, 1, _Base, 2, _Base + _Down, ...))",
        "join_once": "NATURALINNERJOIN(OwnershipByAsset, CarbonRevByAsset)",
        "ratio_of_sums": "DIVIDE(SUMX(Joined, own * carbon), SUMX(Joined, own * revenue))"
      }
    },
    "key_insight": "The 38-measure chain caused the Storage Engine to scan GS Asset, Daily Position, and ESG Trucost Climate tables independently for each measure — N measures = N scans. Collapsing into a single orchestrator with ADDCOLUMNS at ISIN grain computes ownership and carbon/revenue once each, then a single NATURALINNERJOIN + SUMX aggregates everything. Total SE queries dropped from ~38 to 3.",
    "when_not_to_use": "Do not collapse if the intermediate measures are reused across 5+ different visuals with different filter contexts — the single orchestrator may not handle all contexts correctly. Also verify that helper calculated columns (Ownership_Factor_MC, Ownership_Factor_EVIC) exist in the model before using the optimized form."
  },

  "transforms_applied": [
    "measure_forest_collapse",
    "cache_slicer_state",
    "grain_first_materialize",
    "ratio_of_sums",
    "groupby_to_addcolumns"
  ],

  "original_dax": "CALCULATE( [Matrix MV CR Intensity Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n-- delegates to 38-measure chain including:\n-- SWITCH(TRUE(), SELECTEDVALUE(Scope_Type_Code) = 1, [Matrix MV CR Intensity (Scope 1 & 2)_BM], ...)\n-- each scope variant: IF(Position_Type = \"Benchmark\", GROUPBY+SUMX Sub_Sector rollup, [Aggregate MV CR Intensity])\n-- Aggregate: DIVIDE([Aggregate MV Apportioned Carbon], SUMX('GS Asset', [Apportioned MV Revenue]))\n-- Carbon: SUMX('GS Asset', [MV Apportioned Carbon (Scope X)_BM])\n-- Each Apportioned Carbon: CALCULATE([MV Ownership_BM] * SUMX('ESG Trucost Climate', scope-specific sums))\n-- Ownership: complex per-asset calc with DISTINCTCOUNT, market cap modes, GS fallback",

  "optimized_dax": "Portfolio_Asset_Matrix MV CR Intensity Switch_BM New = \nVAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\nVAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1)\n\nVAR OwnershipByAsset =\n    CALCULATETABLE(\n        ADDCOLUMNS(\n            SUMMARIZE('Daily Position', 'GS Asset'[ISIN]),\n            \"@Ownership\",\n                IF(_MarketCapMode = 2,\n                    SUM('Daily Position'[Ownership_Factor_EVIC]),\n                    SUM('Daily Position'[Ownership_Factor_MC]))\n        ),\n        KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n    )\n\nVAR CarbonRevByAsset =\n    ADDCOLUMNS(\n        VALUES('GS Asset'[ISIN]),\n        \"@Revenue\", CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn])),\n        \"@Carbon\",\n            VAR _Base = CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n            VAR _Down = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))\n            VAR _Up   = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))\n            RETURN SWITCH(_ScopeSelect, 1, _Base, 2, _Base + _Down, 3, _Base + _Up, 4, _Base + _Down + _Up, _Base)\n    )\n\nVAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonRevByAsset)\n\nVAR Numerator   = SUMX(Joined, VAR own = COALESCE([@Ownership], 0) RETURN IF(own > 0, own * COALESCE([@Carbon], 0)))\nVAR Denominator = SUMX(Joined, VAR own = COALESCE([@Ownership], 0) RETURN IF(own > 0, own * COALESCE([@Revenue], 0)))\n\nRETURN DIVIDE(Numerator, Denominator)",

  "timing": {
    "original_ms": 60000,
    "optimized_ms": 400,
    "speedup": 150.0,
    "validation_method": "manual_3_run"
  },

  "pathologies_addressed": ["P1", "P2", "P5", "P6"],

  "correctness_notes": [
    "Benchmark/Portfolio filter applied via KEEPFILTERS in OwnershipByAsset",
    "Scope selection cached once, applied inside CarbonRevByAsset SWITCH",
    "COALESCE + IF(own > 0) excludes zero-ownership rows from aggregation",
    "Requires Daily Position[Ownership_Factor_MC] and [Ownership_Factor_EVIC] calculated columns"
  ]
}
