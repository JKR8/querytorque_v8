{
  "id": "grain_first_waci",
  "type": "win",
  "verified_speedup": "unvalidated",
  "benchmark": "ESG Carbon Intensity Model",
  "benchmark_queries": ["Matrix MV WACI Switch_BM"],
  "engine": "dax",

  "example": {
    "input_slice": "Weighted Average Carbon Intensity (WACI) measure with same SWITCH(TRUE(), Scope) branching, Benchmark/Portfolio paths, and per-asset ownership * carbon computation. WACI is weight * (carbon / revenue) per asset, summed. Different from CR Intensity in weighting formula.",
    "output": {
      "nodes": {
        "global_constants": "VAR _TotalMarketValue = IF(_IsBenchmark, CALCULATE(SUM([MARKET VALUE BASE]), filters...), ...)",
        "carbon_grain": "Pre-compute carbon + revenue per ISIN",
        "weight_grain": "Pre-compute portfolio weight per ISIN",
        "waci_formula": "SUMX(JoinedTable, [Weight] * DIVIDE([Carbon], [Revenue]))"
      }
    },
    "key_insight": "WACI uses a different weighting formula (portfolio weight * carbon intensity per asset) vs CR Intensity (ownership * carbon / ownership * revenue). The grain-first approach still applies — pre-compute weight, carbon, revenue per ISIN — but the final aggregation formula differs. Original had repeated CALCULATE(SUM([MARKET VALUE BASE])) for total MV denominator computed inside nested measures.",
    "when_not_to_use": "WACI's per-asset ratio (carbon/revenue) IS intentionally a per-row computation, unlike CR Intensity where ratio-of-sums is mathematically correct. Do not blindly apply ratio-of-sums to WACI — the WACI formula requires per-asset intensity weighted by portfolio weight."
  },

  "transforms_applied": [
    "measure_forest_collapse",
    "cache_slicer_state",
    "grain_first_materialize",
    "hoist_global_constant"
  ],

  "timing": {
    "original_ms": 25000,
    "optimized_ms": null,
    "speedup": null,
    "validation_method": "pending"
  },

  "pathologies_addressed": ["P1", "P2"],

  "correctness_notes": [
    "WACI = Sum(weight_i * carbon_i / revenue_i) — per-asset ratio IS correct here",
    "Do NOT convert to ratio-of-sums — WACI semantics differ from CR Intensity",
    "Global market value denominator must be computed ONCE outside the iterator",
    "Benchmark path uses ALLEXCEPT for market value — preserve expanded table semantics"
  ]
}
