{
  "id": "grain_first_cr_intensity_parent",
  "type": "win",
  "verified_speedup": "unvalidated",
  "benchmark": "ESG Carbon Intensity Model",
  "benchmark_queries": ["Matrix MV CR Intensity Switch_BM"],
  "engine": "dax",

  "example": {
    "input_slice": "Parent measure of the 150x CR Intensity case — same chain but without the top-level Portfolio CALCULATE wrapper. This is the Benchmark+Portfolio shared measure, 94s original. Same SWITCH(TRUE(), Scope) branching, same GROUPBY+SUMX Sub_Sector rollup pattern.",
    "output": {
      "nodes": {
        "position_type_var": "VAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = 'Benchmark'",
        "global_benchmark_mv": "VAR _GlobalBenchmarkMV = IF(_IsBenchmark, CALCULATE(SUM([MARKET VALUE BASE]), ALLEXCEPT(...), type filters...))",
        "carbon_grain": "ADDCOLUMNS with scope-aware carbon per ISIN",
        "ownership_grain": "Per-ISIN ownership with MC/EVIC mode",
        "dual_path": "IF(_IsBenchmark, benchmark-weighted result, portfolio-weighted result)"
      }
    },
    "key_insight": "This is the same measure as the 150x child, but it handles BOTH Benchmark and Portfolio paths — the child only wraps it with a Portfolio filter. The Benchmark path adds GROUPBY('Benchmark Portfolio Mapping'[Sub_Sector]) rollup which the child doesn't hit. Optimized version must handle both paths. The 94s timing (vs child's 60s) suggests the Benchmark path (with GROUPBY+SUMX) is even more expensive.",
    "when_not_to_use": "If only the Portfolio path is used (child measure exists), optimize the child directly for simpler logic."
  },

  "transforms_applied": [
    "measure_forest_collapse",
    "cache_slicer_state",
    "grain_first_materialize",
    "groupby_to_addcolumns",
    "hoist_global_constant"
  ],

  "timing": {
    "original_ms": 94000,
    "optimized_ms": null,
    "speedup": null,
    "validation_method": "pending"
  },

  "pathologies_addressed": ["P1", "P2", "P3", "P4"],

  "correctness_notes": [
    "Must handle both Benchmark and Portfolio filter contexts",
    "Benchmark path originally used GROUPBY+SUMX Sub_Sector rollup",
    "ALLEXCEPT on Daily Position for benchmark market value — preserve expanded table",
    "94s > 60s suggests Benchmark GROUPBY path is costlier than Portfolio path"
  ]
}
