{
  "id": "position_relative_difference",
  "type": "win",
  "verified_speedup": "unvalidated",
  "benchmark": "ESG Carbon Intensity Model",
  "benchmark_queries": ["Position_Relative_Difference_Apportioned_Carbon"],
  "engine": "dax",

  "example": {
    "input_slice": "Computes difference between Benchmark and Portfolio apportioned carbon. Calls [Matrix MV Apportioned Carbon Switch_BM] twice — once with Benchmark filter, once with Portfolio filter. Each call triggers the full measure chain independently, doubling all table scans.",
    "output": {
      "nodes": {
        "shared_carbon_grain": "Compute carbon per ISIN once (shared by both paths)",
        "benchmark_ownership": "CALCULATETABLE(... KEEPFILTERS(Position_Type = 'Benchmark'))",
        "portfolio_ownership": "CALCULATETABLE(... KEEPFILTERS(Position_Type = 'Portfolio'))",
        "difference": "SUMX(JoinedBenchmark, ...) - SUMX(JoinedPortfolio, ...)"
      }
    },
    "key_insight": "The carbon-per-ISIN computation is identical for Benchmark and Portfolio — only the ownership weights differ. Computing carbon once and joining to two separate ownership tables (one per position type) halves the SE queries. Original fires the full 38-measure chain TWICE.",
    "when_not_to_use": "If Benchmark and Portfolio carbon values differ (different scope filters per position type), the shared carbon table optimization is incorrect."
  },

  "transforms_applied": [
    "measure_forest_collapse",
    "shared_intermediate_reuse",
    "grain_first_materialize"
  ],

  "timing": {
    "original_ms": 25000,
    "optimized_ms": null,
    "speedup": null,
    "validation_method": "pending"
  },

  "pathologies_addressed": ["P1"],

  "correctness_notes": [
    "Carbon values must be position-type-independent for sharing to be correct",
    "Ownership weights ARE position-type-dependent — separate tables required",
    "Verify that scope-specific carbon (Scope 1, 2, 3) does not vary by Position_Type"
  ]
}
