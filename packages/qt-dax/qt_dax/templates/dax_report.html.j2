<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ model_name }} | Query Torque DAX Audit</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            /* Core colors - aligned with SQL report */
            --bg: #fafafa;
            --bg-card: #ffffff;
            --bg-alt: #f8fafc;
            --bg-code: #1e1e2e;
            --fg: #18181b;
            --fg-muted: #71717a;
            --fg-code: #cdd6f4;
            --border: #e4e4e7;
            --border-strong: #d4d4d8;
            --border-light: #f1f5f9;

            /* Severity colors */
            --critical: #dc2626;
            --critical-bg: #fef2f2;
            --critical-border: #fecaca;
            --high: #ea580c;
            --high-bg: #fff7ed;
            --high-border: #fed7aa;
            --medium: #ca8a04;
            --medium-bg: #fefce8;
            --medium-border: #fef08a;
            --low: #16a34a;
            --low-bg: #f0fdf4;
            --low-border: #bbf7d0;
            --info: #2563eb;
            --info-bg: #eff6ff;

            /* Brand - aligned with SQL report */
            --brand: #6d28d9;
            --brand-light: #ede9fe;
            --tier-1: #6d28d9;
            --tier-1-bg: #f5f3ff;

            /* Engine colors */
            --se-color: #16a34a;
            --fe-color: #dc2626;

            /* Quality bands */
            --peak: #16a34a;
            --power: #ca8a04;
            --stall: #ea580c;
            --redline: #dc2626;

            --radius: 8px;
            --radius-sm: 6px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.6;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }

        code, .mono { font-family: 'JetBrains Mono', monospace; font-size: 0.875em; }

        .page { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-mark {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6d28d9 0%, #a855f7 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .brand-tag {
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.125rem 0.5rem;
            background: var(--tier-1-bg);
            color: var(--tier-1);
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .brand-mark svg { width: 20px; height: 20px; color: white; }

        .brand-text { font-weight: 700; font-size: 1.125rem; letter-spacing: -0.02em; }
        .brand-sub { font-size: 0.75rem; color: var(--fg-muted); font-weight: 400; }

        .header-meta {
            font-size: 0.75rem;
            color: var(--fg-muted);
            text-align: right;
            line-height: 1.5;
        }

        .report-title {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            margin-top: 1rem;
        }

        .report-subtitle {
            color: var(--fg-muted);
            font-size: 0.875rem;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== EXECUTIVE SUMMARY ===== */
        .executive-summary {
            margin-bottom: 2rem;
        }

        .health-cards {
            display: grid;
            grid-template-columns: minmax(140px, 1fr) repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .health-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .health-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .health-card.score-card {
            border-width: 2px;
            position: relative;
        }

        .health-card.score-card.peak { border-color: var(--peak); background: var(--low-bg); }
        .health-card.score-card.power { border-color: var(--power); background: var(--medium-bg); }
        .health-card.score-card.stall { border-color: var(--stall); background: var(--high-bg); }
        .health-card.score-card.redline { border-color: var(--redline); background: var(--critical-bg); }

        .score {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
            letter-spacing: -0.05em;
            font-family: 'JetBrains Mono', monospace;
        }

        .score.peak { color: var(--peak); }
        .score.power { color: var(--power); }
        .score.stall { color: var(--stall); }
        .score.redline { color: var(--redline); }

        .score-label {
            font-size: 0.6875rem;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 0.25rem;
        }

        .quality-band {
            display: inline-block;
            font-size: 0.625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            margin-top: 0.75rem;
        }

        .quality-band.peak { background: var(--peak); color: white; }
        .quality-band.power { background: var(--power); color: white; }
        .quality-band.stall { background: var(--stall); color: white; }
        .quality-band.redline { background: var(--redline); color: white; }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
            letter-spacing: -0.03em;
        }

        .stat-card .stat-value.warning { color: var(--high); }
        .stat-card .stat-value.critical { color: var(--critical); }

        .stat-card .stat-label {
            font-size: 0.6875rem;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.375rem;
        }

        .stat-card .stat-detail {
            font-size: 0.75rem;
            color: var(--fg-muted);
            margin-top: 0.25rem;
        }

        .stat-card .stat-detail.warning { color: var(--high); }
        .stat-card .stat-detail.critical { color: var(--critical); }

        /* Summary headline box */
        .summary-box {
            background: var(--bg-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .summary-headline {
            font-size: 1rem;
            font-weight: 600;
            flex: 1;
        }

        .severity-pills { display: flex; gap: 0.5rem; flex-wrap: wrap; }

        .pill {
            font-size: 0.6875rem;
            font-weight: 600;
            padding: 0.25rem 0.625rem;
            border-radius: 999px;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .pill.critical { background: var(--critical); color: white; }
        .pill.high { background: var(--high); color: white; }
        .pill.medium { background: var(--medium); color: #422006; }
        .pill.low { background: var(--low); color: white; }
        .pill.info { background: var(--info); color: white; }

        .pill .count { font-weight: 700; }

        /* ===== MODEL SIZE CHART ===== */
        .size-section {
            margin-bottom: 2rem;
        }

        .size-chart-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .size-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .size-title {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .size-total {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--fg-muted);
        }

        .size-bar {
            display: flex;
            height: 32px;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-alt);
            border: 1px solid var(--border);
        }

        .size-segment {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6875rem;
            font-weight: 600;
            color: white;
            transition: width 0.5s ease;
            min-width: 0;
            overflow: hidden;
            white-space: nowrap;
        }

        .size-segment.data { background: #3b82f6; }
        .size-segment.dictionary { background: #8b5cf6; }
        .size-segment.relationships { background: #06b6d4; }
        .size-segment.wasted { background: var(--critical); }

        .size-legend {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--fg-muted);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .legend-dot.data { background: #3b82f6; }
        .legend-dot.dictionary { background: #8b5cf6; }
        .legend-dot.relationships { background: #06b6d4; }
        .legend-dot.wasted { background: var(--critical); }

        .size-alert {
            margin-top: 1rem;
            padding: 0.875rem 1rem;
            border-radius: var(--radius-sm);
            font-size: 0.8125rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .size-alert.warning {
            background: var(--high-bg);
            border: 1px solid var(--high-border);
            color: var(--high);
        }

        .size-alert .alert-icon { font-size: 1rem; }
        .size-alert .alert-text { flex: 1; }
        .size-alert strong { font-weight: 600; }

        /* ===== SECTION STYLING ===== */
        .section { margin-bottom: 2rem; }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-size: 0.8125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: var(--fg-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-badge {
            font-size: 0.625rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            background: var(--fg-muted);
            color: white;
        }

        /* ===== ISSUE TABS ===== */
        .issue-tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .tab {
            padding: 0.75rem 1.25rem;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--fg-muted);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.15s;
        }

        .tab:hover { color: var(--fg); }

        .tab.active {
            color: var(--brand);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--brand);
        }

        .tab .badge {
            font-size: 0.625rem;
            font-weight: 700;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            background: var(--bg-alt);
            color: var(--fg-muted);
            margin-left: 0.5rem;
        }

        .tab.active .badge {
            background: var(--brand-light);
            color: var(--brand);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== ISSUE CARDS ===== */
        .issue-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.15s;
        }

        .issue-card:hover { box-shadow: var(--shadow); }

        .issue-card[data-severity="critical"] { border-left: 4px solid var(--critical); }
        .issue-card[data-severity="high"] { border-left: 4px solid var(--high); }
        .issue-card[data-severity="medium"] { border-left: 4px solid var(--medium); }
        .issue-card[data-severity="low"] { border-left: 4px solid var(--low); }

        .issue-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .issue-header:hover { background: var(--bg-alt); }

        .issue-badges { display: flex; gap: 0.375rem; flex-shrink: 0; }

        .severity-badge {
            font-size: 0.5625rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .severity-badge.critical { background: var(--critical); color: white; }
        .severity-badge.high { background: var(--high); color: white; }
        .severity-badge.medium { background: var(--medium); color: #422006; }
        .severity-badge.low { background: var(--low); color: white; }

        .rule-badge {
            font-size: 0.625rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--bg-alt);
            color: var(--fg-muted);
        }

        .penalty-badge {
            font-size: 0.625rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            background: var(--critical-bg);
            color: var(--critical);
        }

        .issue-main { flex: 1; min-width: 0; }

        .issue-title {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.125rem;
            word-break: break-word;
        }

        .issue-subtitle {
            font-size: 0.75rem;
            color: var(--fg-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .issue-toggle {
            color: var(--fg-muted);
            font-size: 0.75rem;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .issue-card.expanded .issue-toggle { transform: rotate(180deg); }

        .issue-body {
            display: none;
            padding: 0 1.25rem 1.25rem;
            border-top: 1px solid var(--border);
        }

        .issue-card.expanded .issue-body { display: block; padding-top: 1rem; }

        .issue-section { margin-bottom: 1rem; }
        .issue-section:last-child { margin-bottom: 0; }

        .issue-label {
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--fg-muted);
            margin-bottom: 0.5rem;
        }

        .issue-text {
            font-size: 0.8125rem;
            line-height: 1.6;
        }

        /* Code blocks */
        .dax-block {
            background: #0f172a;
            border-radius: var(--radius-sm);
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #e2e8f0;
            overflow-x: auto;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .dax-block .kw { color: #c084fc; }
        .dax-block .fn { color: #67e8f9; }
        .dax-block .str { color: #86efac; }
        .dax-block .num { color: #fcd34d; }
        .dax-block .op { color: #f472b6; }
        .dax-block .cmt { color: #64748b; font-style: italic; }

        /* Fix suggestion box */
        .fix-box {
            background: var(--low-bg);
            border: 1px solid var(--low-border);
            border-radius: var(--radius-sm);
            padding: 1rem;
        }

        .fix-box .fix-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--low);
        }

        .fix-box .dax-block {
            margin-bottom: 0.75rem;
        }

        .fix-box .fix-explanation {
            font-size: 0.75rem;
            color: var(--fg-muted);
            font-style: italic;
        }

        /* LLM suggestion */
        .llm-box {
            background: var(--brand-light);
            border: 1px solid #ddd6fe;
            border-radius: var(--radius-sm);
            padding: 1rem;
        }

        .llm-box .llm-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-weight: 600;
            font-size: 0.8125rem;
            color: var(--brand);
        }

        .confidence-badge {
            font-size: 0.5625rem;
            font-weight: 600;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .confidence-badge.high { background: var(--low); color: white; }
        .confidence-badge.medium { background: var(--medium); color: #422006; }
        .confidence-badge.low { background: var(--high); color: white; }

        .issue-footer {
            display: flex;
            gap: 1.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--fg-muted);
            flex-wrap: wrap;
            align-items: center;
        }

        .reference-link {
            color: var(--brand);
            text-decoration: none;
            font-weight: 500;
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .reference-link:hover { text-decoration: underline; }

        /* ===== RELATIONSHIP DIAGRAM ===== */
        .relationship-section {
            margin-bottom: 2rem;
        }

        .relationship-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .relationship-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .relationship-stats {
            display: flex;
            gap: 1.5rem;
        }

        .rel-stat {
            text-align: center;
        }

        .rel-stat .rel-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .rel-stat .rel-stat-value.warning { color: var(--high); }
        .rel-stat .rel-stat-value.error { color: var(--critical); }

        .rel-stat .rel-stat-label {
            font-size: 0.625rem;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .mermaid-container {
            background: var(--bg-alt);
            border-radius: var(--radius-sm);
            padding: 1rem;
            overflow-x: auto;
        }

        /* ===== TABLE GRID ===== */
        .table-grid-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .table-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8125rem;
        }

        .table-grid thead {
            background: var(--bg-alt);
        }

        .table-grid th {
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--fg-muted);
            border-bottom: 1px solid var(--border);
        }

        .table-grid th.right { text-align: right; }

        .table-grid td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
        }

        .table-grid tr:last-child td { border-bottom: none; }

        .table-grid tr:hover { background: var(--bg-alt); }

        .table-grid .table-name {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .table-grid .table-name.warning { color: var(--high); }
        .table-grid .table-name.hidden { color: var(--fg-muted); }

        .table-grid .numeric {
            text-align: right;
            font-family: 'JetBrains Mono', monospace;
        }

        /* ===== OPTIMIZATION CONTEXT ===== */
        .context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1rem;
        }

        .context-panel {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .context-title {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-light);
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--fg-muted);
            background: var(--bg-alt);
        }

        .context-list {
            padding: 0.75rem 1rem;
            font-size: 0.8125rem;
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .context-item:last-child { border-bottom: none; }

        .context-item .label { color: var(--fg-muted); }

        .health-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.6875rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 999px;
        }

        .health-indicator.good { background: var(--low-bg); color: var(--low); }
        .health-indicator.warning { background: var(--high-bg); color: var(--high); }
        .health-indicator.critical { background: var(--critical-bg); color: var(--critical); }

        /* ===== HIGH CARDINALITY ===== */
        .cardinality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.75rem;
        }

        .cardinality-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cardinality-card.critical { border-left: 3px solid var(--critical); }

        .cardinality-info .cardinality-table {
            font-size: 0.75rem;
            color: var(--fg-muted);
        }

        .cardinality-info .cardinality-column {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .cardinality-value {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .cardinality-value.critical { color: var(--critical); }

        /* ===== REMEDIATION TASKS ===== */
        .task-list { counter-reset: task; }

        .task-item {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: 0.5rem;
            overflow: hidden;
            background: var(--bg);
        }

        .task-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1rem;
            cursor: pointer;
            transition: background 0.15s;
        }

        .task-header:hover { background: var(--bg-alt); }

        .task-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--bg-alt);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6875rem;
            font-weight: 600;
            color: var(--fg-muted);
            flex-shrink: 0;
        }

        .task-main { flex: 1; }

        .task-title {
            font-weight: 500;
            font-size: 0.875rem;
        }

        .task-meta {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.25rem;
        }

        .task-tag {
            font-size: 0.5625rem;
            font-weight: 600;
            text-transform: uppercase;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            background: var(--bg-alt);
            color: var(--fg-muted);
        }

        .task-tag.critical { background: var(--critical); color: white; }
        .task-tag.high { background: var(--high); color: white; }
        .task-tag.medium { background: var(--medium); color: #422006; }
        .task-tag.low { background: var(--low); color: white; }
        .task-tag.rule { font-family: 'JetBrains Mono', monospace; }

        .task-toggle {
            font-size: 0.75rem;
            color: var(--fg-muted);
            transition: transform 0.2s;
        }

        .task-item.expanded .task-toggle { transform: rotate(180deg); }

        .task-body {
            display: none;
            padding: 0 1rem 1rem 3.5rem;
            border-top: 1px solid var(--border);
        }

        .task-item.expanded .task-body { display: block; padding-top: 0.75rem; }

        .task-detail {
            font-size: 0.8125rem;
            color: var(--fg-muted);
            margin-bottom: 0.75rem;
        }

        .affected-list {
            font-size: 0.75rem;
        }

        .affected-list strong {
            display: block;
            margin-bottom: 0.25rem;
            color: var(--fg);
        }

        .affected-list ul {
            margin: 0;
            padding-left: 1.25rem;
            color: var(--fg-muted);
        }

        .affected-list code {
            background: var(--bg-alt);
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.6875rem;
        }

        /* ===== LLM RESPONSE SECTION ===== */
        .response-section {
            background: var(--bg-card);
            border: 2px dashed var(--tier-1);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .response-title {
            font-weight: 700;
            font-size: 1rem;
            color: var(--tier-1);
        }

        .response-hint {
            font-size: 0.8125rem;
            color: var(--fg-muted);
            margin-bottom: 1rem;
        }

        .response-textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            resize: vertical;
            background: var(--bg);
        }

        .response-textarea:focus {
            outline: none;
            border-color: var(--tier-1);
            box-shadow: 0 0 0 3px var(--tier-1-bg);
        }

        .response-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.8125rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            border: none;
            cursor: pointer;
            transition: all 0.15s;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--tier-1);
            color: white;
        }

        .btn-primary:hover {
            background: #5b21b6;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--border-strong);
        }

        .btn-success {
            background: var(--low);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-code);
            color: var(--fg-code);
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* ===== FOOTER ===== */
        .footer {
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            font-size: 0.75rem;
            color: var(--fg-muted);
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .footer-brand svg { width: 16px; height: 16px; color: var(--brand); }
        .footer-brand span { font-weight: 600; color: var(--fg); }

        .footer-note { line-height: 1.6; max-width: 80ch; }

        /* ===== PRINT STYLES ===== */
        @media print {
            .page { max-width: none; padding: 1rem; }
            .issue-body, .task-body { display: block !important; }
            .issue-toggle, .task-toggle { display: none; }
            .health-card:hover { transform: none; }
            .issue-card:hover { box-shadow: none; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .health-cards {
                grid-template-columns: 1fr 1fr;
            }

            .health-cards .health-card:first-child {
                grid-column: 1 / -1;
            }

            .summary-box {
                flex-direction: column;
                align-items: flex-start;
            }

            .issue-tabs {
                overflow-x: auto;
            }

            .context-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- HEADER -->
        <header class="header">
            <div>
                <div class="brand">
                    <div class="brand-mark">
                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <span class="brand-text">Query Torque</span>
                    <span class="brand-tag">Audit</span>
                </div>
                <h1 class="report-title">{{ model_name }}</h1>
                <p class="report-subtitle">Power BI Model Analysis</p>
            </div>
            <div class="header-meta">
                {{ generated_date }}<br>
                {% if client_name %}{{ client_name }}<br>{% endif %}
                v{{ version | default('2.0') }}
            </div>
        </header>

        <!-- EXECUTIVE SUMMARY -->
        <section class="executive-summary">
            <div class="health-cards">
                <!-- Torque Score Card -->
                <div class="health-card score-card {{ quality_band_class }}">
                    <div class="score {{ quality_band_class }}">{{ summary.torque_score }}</div>
                    <div class="score-label">Torque Score</div>
                    <div class="quality-band {{ quality_band_class }}">{{ quality_gate_label }}</div>
                </div>

                <!-- Model Size -->
                <div class="health-card stat-card">
                    <div class="stat-value">{{ model_stats.size_mb }}</div>
                    <div class="stat-label">Model Size (MB)</div>
                    {% if model_stats.wasted_pct and model_stats.wasted_pct > 5 %}
                    <div class="stat-detail warning">{{ model_stats.wasted_pct }}% wasted</div>
                    {% endif %}
                </div>

                <!-- Measures -->
                <div class="health-card stat-card">
                    <div class="stat-value{% if measure_issues | length > 10 %} warning{% endif %}">{{ model_stats.measure_count }}</div>
                    <div class="stat-label">Measures</div>
                    <div class="stat-detail{% if measure_issues | length > 5 %} warning{% endif %}">{{ measure_issues | length }} need review</div>
                </div>

                <!-- Tables -->
                <div class="health-card stat-card">
                    <div class="stat-value">{{ model_stats.table_count }}</div>
                    <div class="stat-label">Tables</div>
                    <div class="stat-detail">{{ model_stats.total_rows | number_format }} rows</div>
                </div>

                <!-- Relationships -->
                <div class="health-card stat-card">
                    <div class="stat-value{% if model_stats.bidir_count > 5 %} warning{% endif %}">{{ model_stats.relationship_count }}</div>
                    <div class="stat-label">Relationships</div>
                    <div class="stat-detail{% if model_stats.bidir_count > 3 %} warning{% endif %}">{{ model_stats.bidir_count }} bidirectional</div>
                </div>
            </div>

            <!-- Summary Box -->
            <div class="summary-box">
                <div class="summary-headline">{{ summary.headline }}</div>
                <div class="severity-pills">
                    {% if summary.severity_counts.critical > 0 %}
                    <span class="pill critical"><span class="count">{{ summary.severity_counts.critical }}</span> Critical</span>
                    {% endif %}
                    {% if summary.severity_counts.high > 0 %}
                    <span class="pill high"><span class="count">{{ summary.severity_counts.high }}</span> High</span>
                    {% endif %}
                    {% if summary.severity_counts.medium > 0 %}
                    <span class="pill medium"><span class="count">{{ summary.severity_counts.medium }}</span> Medium</span>
                    {% endif %}
                    {% if summary.severity_counts.low > 0 %}
                    <span class="pill low"><span class="count">{{ summary.severity_counts.low }}</span> Low</span>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- MODEL SIZE BREAKDOWN -->
        {% if model_size_breakdown %}
        <section class="size-section">
            <div class="section-header">
                <span class="section-title">üì¶ Model Size Analysis{% if model_size_breakdown.is_estimated %} <span style="font-size:0.75em; color:var(--text-muted); font-weight:normal">(estimated)</span>{% endif %}</span>
            </div>
            <div class="size-chart-container">
                <div class="size-header">
                    <span class="size-title">Storage Distribution</span>
                    <span class="size-total">Total: {{ model_stats.size_mb }} MB</span>
                </div>
                <div class="size-bar">
                    {% if model_size_breakdown.data_pct > 0 %}
                    <div class="size-segment data" style="width: {{ model_size_breakdown.data_pct }}%" title="Data: {{ model_size_breakdown.data_size }}">
                        {% if model_size_breakdown.data_pct > 10 %}{{ model_size_breakdown.data_pct }}%{% endif %}
                    </div>
                    {% endif %}
                    {% if model_size_breakdown.dict_pct > 0 %}
                    <div class="size-segment dictionary" style="width: {{ model_size_breakdown.dict_pct }}%" title="Dictionaries: {{ model_size_breakdown.dict_size }}">
                        {% if model_size_breakdown.dict_pct > 10 %}{{ model_size_breakdown.dict_pct }}%{% endif %}
                    </div>
                    {% endif %}
                    {% if model_size_breakdown.rel_pct > 0 %}
                    <div class="size-segment relationships" style="width: {{ model_size_breakdown.rel_pct }}%" title="Relationships: {{ model_size_breakdown.rel_size }}">
                        {% if model_size_breakdown.rel_pct > 10 %}{{ model_size_breakdown.rel_pct }}%{% endif %}
                    </div>
                    {% endif %}
                    {% if model_size_breakdown.wasted_pct > 0 %}
                    <div class="size-segment wasted" style="width: {{ model_size_breakdown.wasted_pct }}%" title="Wasted (Auto Date/Time): {{ model_size_breakdown.wasted_size }}">
                        {% if model_size_breakdown.wasted_pct > 5 %}‚ö†Ô∏è{% endif %}
                    </div>
                    {% endif %}
                </div>
                <div class="size-legend">
                    <span class="legend-item"><span class="legend-dot data"></span> Data: {{ model_size_breakdown.data_size }}</span>
                    <span class="legend-item"><span class="legend-dot dictionary"></span> Dictionaries: {{ model_size_breakdown.dict_size }}</span>
                    {% if model_size_breakdown.rel_size %}
                    <span class="legend-item"><span class="legend-dot relationships"></span> Relationships: {{ model_size_breakdown.rel_size }}</span>
                    {% endif %}
                    {% if model_size_breakdown.wasted_pct > 0 %}
                    <span class="legend-item"><span class="legend-dot wasted"></span> ‚ö†Ô∏è Wasted: {{ model_size_breakdown.wasted_size }}</span>
                    {% endif %}
                </div>
                {% if model_size_breakdown.auto_datetime_count > 0 %}
                <div class="size-alert warning">
                    <span class="alert-icon">‚ö†Ô∏è</span>
                    <div class="alert-text">
                        <strong>Auto Date/Time Enabled:</strong> {{ model_size_breakdown.auto_datetime_count }} hidden date tables consuming {{ model_size_breakdown.wasted_size }}.
                        Disable in Power BI: <em>File ‚Üí Options ‚Üí Data Load ‚Üí Uncheck "Auto date/time for new files"</em>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>
        {% endif %}

        <!-- OPTIMIZATION CONTEXT -->
        {% if optimization_context and optimization_context.has_context %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">üß† Optimization Context</span>
                <span class="section-badge">VPAX highlights</span>
            </div>
            <div class="context-grid">
                <div class="context-panel">
                    <div class="context-title">Top Tables by Rows</div>
                    {% if optimization_context.top_tables_by_rows %}
                    <table class="table-grid">
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th class="right">Rows</th>
                                <th class="right">Size (MB)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in optimization_context.top_tables_by_rows %}
                            <tr>
                                <td><span class="table-name{% if table.hidden %} hidden{% endif %}">{{ table.name }}</span></td>
                                <td class="numeric">{{ table.rows | number_format }}</td>
                                <td class="numeric">{{ table.size_mb }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="context-list">
                        <div class="context-item"><span class="label">No table stats available</span><span>‚Äî</span></div>
                    </div>
                    {% endif %}
                </div>

                <div class="context-panel">
                    <div class="context-title">Top Tables by Size</div>
                    {% if optimization_context.top_tables_by_size %}
                    <table class="table-grid">
                        <thead>
                            <tr>
                                <th>Table</th>
                                <th class="right">Size (MB)</th>
                                <th class="right">% Model</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for table in optimization_context.top_tables_by_size %}
                            <tr>
                                <td><span class="table-name{% if table.hidden %} hidden{% endif %}">{{ table.name }}</span></td>
                                <td class="numeric">{{ table.size_mb }}</td>
                                <td class="numeric">{{ table.pct_of_model }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="context-list">
                        <div class="context-item"><span class="label">No table stats available</span><span>‚Äî</span></div>
                    </div>
                    {% endif %}
                </div>

                <div class="context-panel">
                    <div class="context-title">Top Columns by Cardinality</div>
                    {% if optimization_context.top_columns_by_cardinality %}
                    <table class="table-grid">
                        <thead>
                            <tr>
                                <th>Column</th>
                                <th class="right">Cardinality</th>
                                <th class="right">Size (MB)</th>
                                <th class="right">Encoding</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for col in optimization_context.top_columns_by_cardinality %}
                            <tr>
                                <td><span class="table-name">{{ col.table }}[{{ col.name }}]</span></td>
                                <td class="numeric">{{ col.cardinality | number_format }}</td>
                                <td class="numeric">{{ col.size_mb }}</td>
                                <td class="numeric">{{ col.encoding or '‚Äî' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="context-list">
                        <div class="context-item"><span class="label">No column stats available</span><span>‚Äî</span></div>
                    </div>
                    {% endif %}
                </div>

                <div class="context-panel">
                    <div class="context-title">Relationship & Model Flags</div>
                    <div class="context-list">
                        <div class="context-item">
                            <span class="label">Bidirectional relationships</span>
                            <span>{{ optimization_context.relationship_flags.bidirectional }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Inactive relationships</span>
                            <span>{{ optimization_context.relationship_flags.inactive }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Relationships w/ missing keys</span>
                            <span>{{ optimization_context.relationship_flags.missing_keys }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Total rows</span>
                            <span>{{ optimization_context.model_totals.total_rows | number_format }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Total size (MB)</span>
                            <span>{{ optimization_context.model_totals.total_size_mb }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Max table rows</span>
                            <span>{{ optimization_context.model_totals.max_table_rows | number_format }}</span>
                        </div>
                        <div class="context-item">
                            <span class="label">Max column cardinality</span>
                            <span>{{ optimization_context.model_totals.max_column_cardinality | number_format }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- ENGINE DISTRIBUTION -->
        {% if engine_distribution %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">‚ö° Engine Distribution</span>
            </div>
            <div class="size-chart-container">
                <div class="size-header">
                    <span class="size-title">Average Query Execution</span>
                    <span class="size-total">Target: SE &gt;70%, FE &lt;30%</span>
                </div>
                <div class="size-bar">
                    <div class="size-segment data" style="width: {{ engine_distribution.se_percent }}%; background: var(--se-color);">{{ engine_distribution.se_percent }}% SE</div>
                    <div class="size-segment wasted" style="width: {{ engine_distribution.fe_percent }}%; background: var(--fe-color);">{{ engine_distribution.fe_percent }}% FE</div>
                </div>
                <div class="size-legend">
                    <span class="legend-item"><span class="legend-dot" style="background: var(--se-color);"></span> Storage Engine (fast, columnar)</span>
                    <span class="legend-item"><span class="legend-dot" style="background: var(--fe-color);"></span> Formula Engine (slow, row-by-row)</span>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- RELATIONSHIP DIAGRAM -->
        {% if relationships_mermaid %}
        <section class="relationship-section">
            <div class="section-header">
                <span class="section-title">üîó Data Model Relationships</span>
            </div>
            <div class="relationship-container">
                <div class="relationship-header">
                    <span class="size-title">Entity Relationship Diagram</span>
                    <div class="relationship-stats">
                        <div class="rel-stat">
                            <div class="rel-stat-value">{{ model_stats.relationship_count }}</div>
                            <div class="rel-stat-label">Relationships</div>
                        </div>
                        <div class="rel-stat">
                            <div class="rel-stat-value{% if model_stats.bidir_count > 3 %} warning{% endif %}">{{ model_stats.bidir_count }}</div>
                            <div class="rel-stat-label">Bidirectional</div>
                        </div>
                        {% if model_stats.inactive_count %}
                        <div class="rel-stat">
                            <div class="rel-stat-value{% if model_stats.inactive_unused > 0 %} error{% endif %}">{{ model_stats.inactive_count }}</div>
                            <div class="rel-stat-label">Inactive</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="mermaid-container">
                    <pre class="mermaid">{{ relationships_mermaid }}</pre>
                </div>
            </div>
        </section>
        {% endif %}

        <!-- TABLES HEALTH -->
        {% if table_sizes %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">üìã Table Health</span>
                <span class="section-badge">{{ table_sizes | length }} tables</span>
            </div>
            <div class="table-grid-container">
                <table class="table-grid">
                    <thead>
                        <tr>
                            <th>Table</th>
                            <th class="right">Rows</th>
                            <th class="right">Size</th>
                            <th class="right">% Model</th>
                            <th>Health</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for table in table_sizes %}
                        <tr>
                            <td>
                                <span class="table-name{% if table.warning %} warning{% endif %}{% if table.hidden %} hidden{% endif %}">
                                    {% if table.hidden %}üîí {% endif %}{{ table.name }}
                                </span>
                            </td>
                            <td class="numeric">{{ table.rows | number_format }}</td>
                            <td class="numeric">{{ table.size_mb }} MB</td>
                            <td class="numeric">{{ table.pct_of_model }}%</td>
                            <td>
                                {% if table.pct_of_model > 40 %}
                                <span class="health-indicator critical">‚ö†Ô∏è Large</span>
                                {% elif table.pct_of_model > 25 %}
                                <span class="health-indicator warning">üìä Monitor</span>
                                {% else %}
                                <span class="health-indicator good">‚úì OK</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
        {% endif %}

        <!-- HIGH CARDINALITY COLUMNS -->
        {% if high_cardinality_columns %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">‚ö†Ô∏è High Cardinality Columns</span>
                <span class="section-badge">{{ high_cardinality_columns | length }} columns</span>
            </div>
            <div class="cardinality-grid">
                {% for col in high_cardinality_columns %}
                <div class="cardinality-card{% if col.cardinality > 1000000 %} critical{% endif %}">
                    <div class="cardinality-info">
                        <div class="cardinality-table">{{ col.table }}</div>
                        <div class="cardinality-column">{{ col.column }}</div>
                    </div>
                    <div class="cardinality-value{% if col.cardinality > 1000000 %} critical{% endif %}">
                        {{ col.cardinality | number_format }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- ISSUES BY CATEGORY -->
        {% if measure_issues or architecture_issues or calc_group_issues %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">üîç Issues</span>
                <span class="section-badge">{{ (measure_issues | length) + (architecture_issues | length) + (calc_group_issues | default([]) | length) }} total</span>
            </div>

            <!-- Tabs -->
            <div class="issue-tabs">
                {% if dax_issues %}
                <button class="tab active" data-tab="dax" onclick="switchTab('dax')">
                    DAX Issues <span class="badge">{{ dax_issues | length }}</span>
                </button>
                {% endif %}
                {% if model_issues %}
                <button class="tab{% if not dax_issues %} active{% endif %}" data-tab="model" onclick="switchTab('model')">
                    Model Issues <span class="badge">{{ model_issues | length }}</span>
                </button>
                {% endif %}
                {% if calc_group_issues %}
                <button class="tab" data-tab="calcgroups" onclick="switchTab('calcgroups')">
                    Calc Groups <span class="badge">{{ calc_group_issues | length }}</span>
                </button>
                {% endif %}
            </div>

            <!-- DAX Issues Tab -->
            {% if dax_issues %}
            <div class="tab-content active" id="tab-dax">
                {% for issue in dax_issues %}
                <div class="issue-card{% if loop.first %} expanded{% endif %}" data-severity="{{ issue.severity }}">
                    <div class="issue-header" onclick="toggleIssue(this)">
                        <div class="issue-badges">
                            <span class="severity-badge {{ issue.severity }}">{{ issue.severity[:4] | upper }}</span>
                            {% if issue.rule_id %}
                            <span class="rule-badge">{{ issue.rule_id }}</span>
                            {% endif %}
                            {% if issue.penalty %}
                            <span class="penalty-badge">-{{ issue.penalty }} pts</span>
                            {% endif %}
                        </div>
                        <div class="issue-main">
                            <div class="issue-title">{{ issue.title or issue.name }}</div>
                            <div class="issue-subtitle">{{ issue.table }}{% if issue.table %}.{% endif %}{{ issue.name }}</div>
                        </div>
                        <span class="issue-toggle">‚ñº</span>
                    </div>
                    <div class="issue-body">
                        {% if issue.expression %}
                        <div class="issue-section">
                            <div class="issue-label">Current Expression</div>
                            <div class="dax-block">{{ issue.expression }}</div>
                        </div>
                        {% endif %}

                        <div class="issue-section">
                            <div class="issue-label">Problem</div>
                            <div class="issue-text">
                                {% for i in issue.issues %}
                                <p>{{ i.explanation }}</p>
                                {% endfor %}
                            </div>
                        </div>

                        {% if issue.pattern %}
                        <div class="issue-section">
                            <div class="fix-box">
                                <div class="fix-header">üí° Recommended Fix</div>
                                <div class="issue-text" style="margin-bottom: 0.75rem;">{{ issue.pattern.description }}</div>
                                {% if issue.pattern.example %}
                                <div class="dax-block">{{ issue.pattern.example }}</div>
                                {% endif %}
                                {% if issue.pattern.note %}
                                <div class="fix-explanation">{{ issue.pattern.note }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        {% if issue.llm_suggestion %}
                        <div class="issue-section">
                            <div class="llm-box">
                                <div class="llm-header">
                                    ü§ñ AI-Generated Fix
                                    <span class="confidence-badge {{ issue.llm_suggestion.confidence_class }}">{{ issue.llm_suggestion.confidence }}%</span>
                                </div>
                                <div class="dax-block">{{ issue.llm_suggestion.code }}</div>
                                {% if issue.llm_suggestion.explanation %}
                                <div class="fix-explanation">{{ issue.llm_suggestion.explanation }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="issue-footer">
                            {% if issue.estimates %}
                            <span>Est. Improvement: <strong>{{ issue.estimates.improvement }}</strong></span>
                            <span>Effort: <strong>{{ issue.estimates.effort }}</strong></span>
                            {% endif %}
                            {% if issue.reference_link %}
                            <a href="{{ issue.reference_link }}" target="_blank" class="reference-link">üìö Learn More ‚Üí</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Model Issues Tab -->
            {% if model_issues %}
            <div class="tab-content{% if not dax_issues %} active{% endif %}" id="tab-model">
                {% for issue in model_issues %}
                <div class="issue-card{% if loop.first and not dax_issues %} expanded{% endif %}" data-severity="{{ issue.severity }}">
                    <div class="issue-header" onclick="toggleIssue(this)">
                        <div class="issue-badges">
                            <span class="severity-badge {{ issue.severity }}">{{ issue.severity[:4] | upper }}</span>
                            {% if issue.rule_id %}
                            <span class="rule-badge">{{ issue.rule_id }}</span>
                            {% endif %}
                        </div>
                        <div class="issue-main">
                            <div class="issue-title">{{ issue.title }}{% if issue.count > 1 %} <span style="font-weight: 400; color: var(--fg-muted);">({{ issue.count }} instances)</span>{% endif %}</div>
                            <div class="issue-subtitle">{{ issue.description | truncate(80) }}</div>
                        </div>
                        <span class="issue-toggle">‚ñº</span>
                    </div>
                    <div class="issue-body">
                        <div class="issue-section">
                            <div class="issue-label">Description</div>
                            <div class="issue-text">{{ issue.description }}</div>
                        </div>

                        {% if issue.recommendation %}
                        <div class="issue-section">
                            <div class="fix-box">
                                <div class="fix-header">üí° Recommendation</div>
                                <div class="issue-text">{{ issue.recommendation }}</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if issue.affected_objects and issue.affected_objects | length > 0 %}
                        <div class="issue-section">
                            <div class="issue-label">Affected Objects</div>
                            <div class="issue-text">
                                {{ issue.affected_objects[:10] | join(', ') }}
                                {% if issue.affected_objects | length > 10 %}
                                <em style="color: var(--fg-muted);">and {{ issue.affected_objects | length - 10 }} more...</em>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="issue-footer">
                            {% if issue.impact %}
                            <span>Impact: <strong>{{ issue.impact }}</strong></span>
                            {% endif %}
                            {% if issue.reference_link %}
                            <a href="{{ issue.reference_link }}" target="_blank" class="reference-link">üìö Learn More ‚Üí</a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Calc Groups Tab -->
            {% if calc_group_issues %}
            <div class="tab-content" id="tab-calcgroups">
                {% for issue in calc_group_issues %}
                <div class="issue-card" data-severity="{{ issue.severity }}">
                    <div class="issue-header" onclick="toggleIssue(this)">
                        <div class="issue-badges">
                            <span class="severity-badge {{ issue.severity }}">{{ issue.severity[:4] | upper }}</span>
                            {% if issue.rule_id %}
                            <span class="rule-badge">{{ issue.rule_id }}</span>
                            {% endif %}
                        </div>
                        <div class="issue-main">
                            <div class="issue-title">{{ issue.title }}</div>
                            <div class="issue-subtitle">{{ issue.object_name }}</div>
                        </div>
                        <span class="issue-toggle">‚ñº</span>
                    </div>
                    <div class="issue-body">
                        <div class="issue-section">
                            <div class="issue-label">Description</div>
                            <div class="issue-text">{{ issue.description }}</div>
                        </div>

                        {% if issue.code_snippet %}
                        <div class="issue-section">
                            <div class="issue-label">Expression</div>
                            <div class="dax-block">{{ issue.code_snippet }}</div>
                        </div>
                        {% endif %}

                        {% if issue.recommendation %}
                        <div class="issue-section">
                            <div class="fix-box">
                                <div class="fix-header">üí° Recommendation</div>
                                <div class="issue-text">{{ issue.recommendation }}</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </section>
        {% endif %}

        <!-- REMEDIATION TASKS -->
        {% if tasks %}
        <section class="section">
            <div class="section-header">
                <span class="section-title">‚úÖ Remediation Checklist</span>
                <span class="section-badge">{{ tasks | length }} tasks</span>
            </div>
            <div class="task-list">
                {% for task in tasks %}
                <div class="task-item">
                    <div class="task-header" onclick="toggleTask(this)">
                        <div class="task-number">{{ loop.index }}</div>
                        <div class="task-main">
                            <div class="task-title">{{ task.title }}{% if task.count > 1 %} <span style="font-weight: 400; color: var(--fg-muted);">({{ task.count }}√ó)</span>{% endif %}</div>
                            <div class="task-meta">
                                {% if task.rule_id %}
                                <span class="task-tag rule">{{ task.rule_id }}</span>
                                {% endif %}
                                {% if task.effort %}
                                <span class="task-tag">{{ task.effort }}</span>
                                {% endif %}
                                <span class="task-tag {{ task.severity }}">{{ task.severity }}</span>
                            </div>
                        </div>
                        <span class="task-toggle">‚ñº</span>
                    </div>
                    <div class="task-body">
                        {% if task.detail %}
                        <div class="task-detail">{{ task.detail }}</div>
                        {% endif %}
                        {% if task.affected_objects and task.affected_objects | length > 0 %}
                        <div class="affected-list">
                            <strong>Affected objects:</strong>
                            <ul>
                                {% for obj in task.affected_objects %}
                                <li><code>{{ obj }}</code></li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <!-- LLM RESPONSE SECTION -->
        {% if llm_payload %}
        <section class="response-section">
            <div class="response-header">
                <span class="response-title">Paste LLM Response</span>
                <button class="btn btn-secondary" onclick="pasteFromClipboard()">Paste from Clipboard</button>
            </div>
            <div class="response-hint">
                After copying the optimization payload and getting a response from your AI tool, paste the optimized DAX or fix suggestions here.
            </div>
            <textarea id="llm-response" class="response-textarea" placeholder="Paste LLM response here...

Expected format:

Optimized DAX measure:
[Measure Name] =
VAR _result = ...
RETURN _result

Or structured fixes with explanations."></textarea>
            <div class="response-actions">
                <button class="btn btn-success" onclick="validateResponse()">Validate Response</button>
                <button class="btn btn-secondary" onclick="clearResponse()">Clear</button>
            </div>
        </section>
        {% endif %}

        <!-- FOOTER -->
        <footer class="footer">
            <div class="footer-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 3v18M3 12h18M5.6 5.6l12.8 12.8M18.4 5.6L5.6 18.4"/>
                </svg>
                <span>Query Torque</span>
                <span style="font-weight: 400; color: var(--fg-muted);">by Dialect Labs</span>
            </div>
            <p class="footer-note">
                Analysis based on VPAX model export.
                For detailed Server Timings (SE/FE breakdown), run queries in DAX Studio with Server Timings enabled.
                Estimates assume typical Power BI workloads. Verify improvements with actual query testing.
            </p>
        </footer>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'neutral',
            securityLevel: 'loose',
            flowchart: { curve: 'basis' }
        });

        // Tab switching
        function switchTab(tabId) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            const targetContent = document.getElementById('tab-' + tabId);
            if (targetContent) {
                targetContent.classList.add('active');
            }
        }

        // Issue card toggle
        function toggleIssue(el) {
            el.closest('.issue-card').classList.toggle('expanded');
        }

        // Task toggle
        function toggleTask(el) {
            el.closest('.task-item').classList.toggle('expanded');
        }

        // Expand all issues for printing
        window.addEventListener('beforeprint', function() {
            document.querySelectorAll('.issue-card, .task-item').forEach(el => {
                el.classList.add('expanded');
            });
        });

        // Toast notification
        function showToast(msg) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.className = 'toast';
                document.body.appendChild(toast);
            }
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Response handling for LLM paste workflow
        function pasteFromClipboard() {
            navigator.clipboard.readText().then(text => {
                document.getElementById('llm-response').value = text;
                showToast('Pasted!');
            }).catch(() => showToast('Clipboard access denied'));
        }

        function clearResponse() {
            document.getElementById('llm-response').value = '';
        }

        function validateResponse() {
            const response = document.getElementById('llm-response').value;
            if (!response.trim()) {
                showToast('Please paste a response first');
                return;
            }
            // Send response to parent window (web UI) for validation
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'qt-dax-response',
                    response: response
                }, '*');
                showToast('Sending to validator...');
            } else {
                // Standalone mode
                showToast('Response captured! Use web UI for full validation.');
                console.log('DAX LLM Response:', response);
            }
        }
    </script>
</body>
</html>
