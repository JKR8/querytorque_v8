┌─────────────────────────────────────────────────────────────────────────────────┐
│                            qt-dax CLI Operations                                │
│                      Power BI / DAX Analysis & Optimization                     │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌──────────────┐
                              │  qt-dax CLI  │
                              └──────┬───────┘
                                     │
       ┌─────────────────────────────┼─────────────────────────────┐
       │                │            │             │               │
       ▼                ▼            ▼             ▼               ▼
┌─────────────┐  ┌───────────┐ ┌───────────┐ ┌───────────┐  ┌───────────┐
│    audit    │  │ optimize  │ │  connect  │ │   diff    │  │   help    │
└──────┬──────┘  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘  └───────────┘
       │               │             │             │
       ▼               │             │             ▼
┌─────────────┐        │             │      ┌─────────────┐
│  VPAX       │        │             │      │ VPAXDiffer  │
│  Analyzer   │        │             │      │             │
│             │        │             │      │ Compare 2   │
│ - Unzip     │        │             │      │ VPAX files  │
│ - Parse XML │        │             │      │ Show deltas │
│ - Extract   │        │             │      └─────────────┘
│   model     │        │             │
└──────┬──────┘        │             │
       │               │             │
       ▼               │             │
┌─────────────┐        │             │
│  DAX/Model  │        │             │
│  Rule Engine│        │             │
│             │        │             │
│ ~50+ rules: │        │             │
│ - Measure   │        │             │
│   patterns  │        │             │
│ - Model     │        │             │
│   issues    │        │             │
│ - Relation- │        │             │
│   ship probs│        │             │
└──────┬──────┘        │             │
       │               │             │
       ▼               │             ▼
┌─────────────┐        │      ┌───────────────────────────────┐
│ Torque Score│        │      │     PBI DESKTOP CONNECTION    │
│  0-100      │        │      │  ┌─────────────────────────┐  │
│             │        │      │  │ Find running instances  │  │
│ Gate:       │        │      │  │ (process scan for MSMDSRV│  │
│ ≥90 Peak    │        │      │  └────────────┬────────────┘  │
│ ≥70 Power   │        │      │               ▼               │
│ ≥50 Stall   │        │      │  ┌─────────────────────────┐  │
│ <50 Redline │        │      │  │ XMLA/ADOMD Connection   │  │
└─────────────┘        │      │  │ (via pyadomd on Windows)│  │
                       │      │  └────────────┬────────────┘  │
                       │      │               │               │
                       │      │               ▼               │
                       │      │  ┌─────────────────────────┐  │
                       │      │  │ --list   List instances │  │
                       │      │  │ --query  Execute DAX    │  │
                       │      │  │ --valid  Validate expr  │  │
                       │      │  └─────────────────────────┘  │
                       │      └───────────────────────────────┘
                       │
       ┌───────────────┴───────────────┐
       │                               │
       ▼                               ▼
┌───────────────┐              ┌───────────────┐
│   --dry-run   │              │   LLM Mode    │
│               │              │               │
│ Show issues   │              │ Per-measure   │
│ that would be │              │ optimization  │
│ addressed,    │              │ with LLM      │
│ no LLM call   │              │               │
└───────────────┘              └───────┬───────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────┐
│                    LLM OPTIMIZATION LOOP                          │
│  ┌────────────────────────────────────────────────────────────┐  │
│  │ For each measure with detected issues:                      │  │
│  │                                                             │  │
│  │   1. Extract measure definition from VPAX                   │  │
│  │                                                             │  │
│  │   2. Build prompt with:                                     │  │
│  │      - Original DAX expression                              │  │
│  │      - Detected anti-patterns                               │  │
│  │      - Model context (tables, relationships)                │  │
│  │                                                             │  │
│  │   3. Call LLM (via qt_shared.llm)                          │  │
│  │      - deepseek | openrouter                               │  │
│  │                                                             │  │
│  │   4. Extract optimized DAX from response                    │  │
│  │                                                             │  │
│  │   5. (Optional) Validate against PBI Desktop               │  │
│  │                                                             │  │
│  └────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
                        ┌──────────────────────────────┐
                        │         OUTPUT               │
                        │  ┌────────────────────────┐  │
                        │  │ -o file.dax → Save     │  │
                        │  │ -o file.json → JSON    │  │
                        │  │ (no -o)    → Display   │  │
                        │  └────────────────────────┘  │
                        └──────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           VPAX ANALYSIS PIPELINE                                │
└─────────────────────────────────────────────────────────────────────────────────┘

   model.vpax ──┬──► Unzip archive
                │
                ├──► Parse DaxModel.json
                │    ├── Tables, Columns
                │    ├── Measures (DAX expressions)
                │    ├── Relationships
                │    └── Calculated columns
                │
                ├──► Parse DaxVpaStatistics.json
                │    ├── Table sizes (bytes, rows)
                │    ├── Column cardinality
                │    └── Memory usage
                │
                └──► Run Rule Engine
                     │
                     ├── DAX Anti-Pattern Rules
                     │   ├── Avoid FILTER with ALL
                     │   ├── Use DIVIDE instead of /
                     │   ├── Replace COUNTROWS(FILTER...) with CALCULATE
                     │   ├── Avoid nested CALCULATE
                     │   └── ... (~25 DAX rules)
                     │
                     ├── Model Rules
                     │   ├── Missing relationships
                     │   ├── Bidirectional relationships
                     │   ├── High cardinality columns
                     │   ├── Unused tables/columns
                     │   └── ... (~15 model rules)
                     │
                     └── Schema Rules
                         ├── Large tables without aggregations
                         ├── Star schema violations
                         ├── Missing date table
                         └── ... (~10 schema rules)


┌─────────────────────────────────────────────────────────────────────────────────┐
│                         DAX VALIDATION (via PBI Desktop)                        │
└─────────────────────────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────────┐
   │                 PBI Desktop Connection Flow                      │
   │                                                                 │
   │   1. find_pbi_instances()                                       │
   │      └─► Scan processes for msmdsrv.exe                        │
   │          └─► Extract port from command line                     │
   │                                                                 │
   │   2. PBIDesktopConnection(port)                                 │
   │      └─► Connect via XMLA: localhost:{port}                    │
   │                                                                 │
   │   3. execute_dax(query)                                         │
   │      └─► Run EVALUATE statement                                │
   │      └─► Return result set                                      │
   │                                                                 │
   │   4. validate_dax_against_desktop(expression)                   │
   │      └─► Wrap in EVALUATE ROW('test', {expression})            │
   │      └─► If succeeds → Valid                                   │
   │      └─► If fails → Return error message                       │
   └─────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              MODULE STRUCTURE                                   │
└─────────────────────────────────────────────────────────────────────────────────┘

   qt_dax/
   ├── analyzers/
   │   ├── vpax_analyzer.py      # Main VPAX parser & report generator
   │   ├── dax_remediation_engine.py  # Rule engine for DAX patterns
   │   ├── measure_dependencies.py    # DAX measure dependency graph
   │   └── vpax_differ.py        # Compare two VPAX files
   │
   ├── parsers/
   │   └── dax_parser.py         # DAX expression tokenizer/parser
   │
   ├── validation/
   │   ├── dax_validator.py           # Syntax validation
   │   └── dax_equivalence_validator.py  # Semantic equivalence
   │
   ├── connections/
   │   └── pbi_desktop.py        # PBI Desktop XMLA connection
   │
   ├── renderers/
   │   └── dax_renderer.py       # HTML report generator
   │
   ├── templates/
   │   └── dax_report.html.j2    # Jinja2 report template
   │
   └── knowledge/
       └── rules/                # Rule definitions (YAML/JSON)


┌─────────────────────────────────────────────────────────────────────────────────┐
│                           COMMAND EXAMPLES                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  # Static analysis only
  qt-dax audit model.vpax

  # Verbose output with issue details
  qt-dax audit model.vpax -v

  # Output as JSON
  qt-dax audit model.vpax --json

  # Generate HTML report
  qt-dax audit model.vpax -o report.html

  # LLM-powered optimization (dry run)
  qt-dax optimize model.vpax --dry-run

  # Optimize with specific provider
  qt-dax optimize model.vpax --provider openrouter

  # Optimize specific measures only
  qt-dax optimize model.vpax -m "Total Sales" -m "Profit %"

  # Save optimized measures
  qt-dax optimize model.vpax -o optimized.dax

  # List running PBI Desktop instances
  qt-dax connect --list

  # Execute DAX query against PBI Desktop
  qt-dax connect -q "EVALUATE ROW('Test', 1+1)"

  # Validate DAX expression
  qt-dax connect --validate "SUM('Sales'[Amount])"

  # Compare two VPAX files
  qt-dax diff model_v1.vpax model_v2.vpax

  # Generate diff report
  qt-dax diff before.vpax after.vpax -o diff_report.html


┌─────────────────────────────────────────────────────────────────────────────────┐
│                              SCORE CALCULATION                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

   Torque Score = 100 - Σ(issue penalties)

   ┌────────────┬─────────┬─────────────────────────────────┐
   │  Severity  │ Penalty │ Example Issues                  │
   ├────────────┼─────────┼─────────────────────────────────┤
   │ Critical   │  10-15  │ Circular dependencies           │
   │            │         │ Missing key relationships       │
   │ High       │   5-10  │ FILTER with ALL anti-pattern    │
   │            │         │ Bidirectional relationships     │
   │ Medium     │   2-5   │ Nested CALCULATE                │
   │            │         │ High cardinality columns        │
   │ Low        │   1-2   │ Missing descriptions            │
   │            │         │ Unused columns                  │
   │ Info       │    0    │ Informational findings          │
   └────────────┴─────────┴─────────────────────────────────┘

   Quality Gates:
   ≥90  Peak Torque  - Excellent, ready for production
   ≥70  Power Band   - Good, minor optimizations recommended
   ≥50  Stall Zone   - Fair, review before deployment
   <50  Redline      - Critical, requires remediation


┌─────────────────────────────────────────────────────────────────────────────────┐
│                        ENVIRONMENT VARIABLES                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

  # LLM Provider (required for optimize command)
  QT_LLM_PROVIDER=deepseek
  DEEPSEEK_API_KEY=xxx
  OPENROUTER_API_KEY=xxx

  # Note: PBI Desktop connection requires Windows + pyadomd package
