{"measure_name": "Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM", "original_measure_ref": "ESG Trucost Climate[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM]", "optimized_measure_ref": "ESG Trucost Climate[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM]", "original_time": "14s", "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM] = CALCULATE( [Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n             \n\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n", "optimized_dax": "DEFINE\n    // ---------------------------------------------------------\n    // OPTIMIZED MEASURE 1: PORTFOLIO SPECIFIC\n    // ---------------------------------------------------------\n    MEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM] = \n        VAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\n        VAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1) // 1=MC, 2=EVIC\n\n        // 1) Carbon Table (Calculated once per ISIN)\n        VAR CarbonByAsset = \n            ADDCOLUMNS(\n                VALUES('GS Asset'[ISIN]),\n                \"@Carbon\",\n                VAR _Base = CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n                VAR _Down = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))\n                VAR _Up   = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))\n                RETURN\n                    SWITCH( _ScopeSelect,\n                        1, _Base,\n                        2, _Base + _Down,\n                        3, _Base + _Up,\n                        4, _Base + _Down + _Up,\n                        _Base\n                    )\n            )\n\n        // 2) Portfolio Ownership Table (Filtered strictly for Portfolio)\n        VAR OwnershipByAsset = \n            CALCULATETABLE(\n                ADDCOLUMNS(\n                    VALUES('GS Asset'[ISIN]),\n                    \"@Ownership\",\n                    VAR _MVSum      = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))\n                    VAR _OwnSum     = CALCULATE(SUM('Daily Position'[MV_OWNERSHIP]))\n                    VAR _FundCount  = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]))\n                    \n                    // Fallback GS Ownership\n                    VAR _QtySum     = CALCULATE(SUM('Daily Position'[QUANTITY]))\n                    VAR _SharesOut  = CALCULATE(SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]))\n                    VAR _GSOwn      = DIVIDE(_QtySum, _SharesOut, 0)\n\n                    // Market Cap Logic (Sum vs Max depending on Fund Count)\n                    VAR _MC_Raw     = IF(_MarketCapMode = 2, CALCULATE(SUM('Daily Position'[EVIC_Base])), CALCULATE(SUM('Daily Position'[Market_Cap_Base])))\n                    VAR _MC_Max     = IF(_MarketCapMode = 2, CALCULATE(MAX('Daily Position'[EVIC_Base])), CALCULATE(MAX('Daily Position'[Market_Cap_Base])))\n                    VAR _FinalMC    = IF(_FundCount > 1, _MC_Max, _MC_Raw)\n                    \n                    // Derived Ownership Calculation\n                    VAR _Derived    = IF(_FinalMC = 0, 0, (_MVSum / _FinalMC) * 1000000000)\n                    \n                    // Primary Logic\n                    VAR _MainOwn    = DIVIDE( IF(_MarketCapMode = 1, _OwnSum, _Derived), 1000000000)\n\n                    RETURN\n                        IF( (ISBLANK(_MainOwn) || _MainOwn = 0) && _MVSum > 0, _GSOwn, _MainOwn )\n                ),\n                KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n            )\n\n        // 3) Join & Aggregation\n        VAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)\n        \n        RETURN SUMX(Joined, [@Ownership] * [@Carbon])", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": "\n// DAX Query\nDEFINE\n    VAR __DS0FilterTable =\n        TREATAS({ DATE(2025, 1, 31) }, 'Benchmark Portfolio Mapping'[Valuation_Date])\n\n    VAR __DS0FilterTable2 =\n        TREATAS({ \"Listed Equities\" }, 'Benchmark Portfolio Mapping'[Sector])\n\n    VAR __DS0FilterTable3 =\n        TREATAS({ \"Y\" }, 'Benchmark Portfolio Mapping'[TAA_Benchmark])\n\n    VAR __DS0FilterTable4 =\n        TREATAS({ \"EVIC\" }, 'Market Cap Type'[Market_Cap_Name])\n\n    VAR __DS0FilterTable5 =\n        TREATAS({ \"Scope 1 + 2 + 3 Downstream+ 3 Upstream\" }, 'Scope Emission Types'[Scope_Type_Desc])\n\n    VAR __DS0FilterTable6 =\n        FILTER(\n            KEEPFILTERS(VALUES('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE])),\n            NOT(\n                'GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE]\n                    IN {\n                        \"Cash\",\n                        \"Equity Index Futures\",\n                        \"Fee Accruals\",\n                        \"Money Market Fund\",\n                        \"Recoverable Taxes\",\n                        \"Rights Issue\",\n                        \"Variation Margin\"\n                    }\n            )\n        )\n\n    VAR __DS0FilterTable7 =\n        TREATAS({ \"Collective Investment\", \"Equity\" }, 'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE])\n\n    VAR __DS0FilterTable8 =\n        TREATAS(\n            { (\"LGIM\", \"LGIM DM ex US ex AU Index Plus\", \"FFB146\") },\n            'Benchmark Portfolio Mapping'[Portfolio_Manager],\n            'Benchmark Portfolio Mapping'[Portfolio_Name],\n            'Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]\n        )\n\n    VAR __Core =\n        SUMMARIZECOLUMNS(\n            'GS Asset'[ISIN],\n            __DS0FilterTable,\n            __DS0FilterTable2,\n            __DS0FilterTable3,\n            __DS0FilterTable4,\n            __DS0FilterTable5,\n            __DS0FilterTable6,\n            __DS0FilterTable7,\n            __DS0FilterTable8,\n            \"Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM\",\n                'ESG Trucost Climate'[Portfolio_Asset_Matrix MV CR Intensity Switch_BM NEW]\n        )\n\n    VAR __Windowed =\n        TOPN(\n            501,\n            __Core,\n            [Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM], 0,   // 0 = DESC\n            'GS Asset'[ISIN], 1                                       // 1 = ASC\n        )\n\nEVALUATE\n    __Windowed\n\nORDER BY\n    [Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM] DESC,\n    'GS Asset'[ISIN]"}
{"measure_name": "Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM", "original_measure_ref": "ESG Trucost Climate[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM]", "optimized_measure_ref": "ESG Trucost Climate[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM]", "original_time": "9s", "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM] = CALCULATE( [Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n             \n\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM] = \n    VAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\n    VAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1) // 1=MC, 2=EVIC\n\n    // ------------------------------------------------------------------\n    // 1) Calculate Total Benchmark MV (SCALAR) - OUTSIDE THE LOOP\n    // ------------------------------------------------------------------\n    // This represents the Total AUM of the Benchmark for the selected Date.\n    // We use ALLEXCEPT to remove asset-level filters but keep the Benchmark ID and Date.\n    VAR _TotalBenchmarkMV_Raw = \n        CALCULATE(\n            SUM('Daily Position'[MARKET VALUE BASE]),\n            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),\n            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n        )\n\n    // ------------------------------------------------------------------\n    // 2) Carbon Table (Calculated once per ISIN)\n    // ------------------------------------------------------------------\n    VAR CarbonByAsset = \n        ADDCOLUMNS(\n            VALUES('GS Asset'[ISIN]),\n            \"@Carbon\",\n            VAR _Base = CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n            VAR _Down = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))\n            VAR _Up   = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))\n            RETURN\n                SWITCH( _ScopeSelect,\n                    1, _Base,\n                    2, _Base + _Down,\n                    3, _Base + _Up,\n                    4, _Base + _Down + _Up,\n                    _Base\n                )\n        )\n\n    // ------------------------------------------------------------------\n    // 3) Benchmark Ownership Table\n    // ------------------------------------------------------------------\n    VAR OwnershipByAsset = \n        CALCULATETABLE(\n            ADDCOLUMNS(\n                VALUES('GS Asset'[ISIN]),\n                \"@Ownership\",\n                // Gather inputs for Ownership Calc per Asset\n                VAR _Weight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))\n                \n                // MC Calculation (Raw Sum, Switch handled here)\n                VAR _MC_Raw = IF(_MarketCapMode = 2, CALCULATE(SUM('Daily Position'[EVIC_Base])), CALCULATE(SUM('Daily Position'[Market_Cap_Base])))\n                \n                // Denominator for MC (Replicating 'Accounts_owning_asset' logic)\n                VAR _Count  = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) \n                VAR _MC_Avg = DIVIDE(_MC_Raw, _Count) \n\n                // Primary Calculation: \n                // Original Logic: ((Weight / 100) * (TotalBM_Millions)) / AssetMC_Millions\n                // Simplified:     ((Weight / 100) * _TotalBenchmarkMV_Raw) / _MC_Avg\n                VAR _AllocatedValue = (_Weight / 100) * _TotalBenchmarkMV_Raw\n                VAR _BloombergOwn   = DIVIDE(_AllocatedValue, _MC_Avg, 0)\n\n                // Fallback to GS Ownership if Bloomberg calc is 0/Blank but Benchmark has value\n                VAR _QtySum     = CALCULATE(SUM('Daily Position'[QUANTITY]))\n                VAR _SharesOut  = CALCULATE(SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]))\n                VAR _GSOwn      = DIVIDE(_QtySum, _SharesOut, 0)\n\n                RETURN\n                    IF( (_BloombergOwn = 0 || ISBLANK(_BloombergOwn)) && _TotalBenchmarkMV_Raw > 0, \n                        _GSOwn, \n                        _BloombergOwn \n                    )\n            ),\n            KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\"),\n            // Performance Optimization: Exclude rows with no weight/qty\n            ('Daily Position'[BENCHMARK_WEIGHT_EOD] > 0 || 'Daily Position'[QUANTITY] <> 0)\n        )\n\n    // ------------------------------------------------------------------\n    // 4) Join & Aggregation\n    // ------------------------------------------------------------------\n    VAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)\n    \n    RETURN SUMX(Joined, [@Ownership] * [@Carbon])", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Matrix MV_BM", "original_measure_ref": "Daily Position[Matrix MV_BM]", "optimized_measure_ref": "Daily Position[Matrix MV_BM]", "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'Daily Position'[Matrix MV_BM] = [MARKET_VALUE_BASE_SUM] / 1000000\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'Daily Position'[Matrix MV_BM] = \n    DIVIDE([MARKET_VALUE_BASE_SUM], 1000000)", "helper1_dax": "MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = \n    SUM('Daily Position'[MARKET VALUE BASE])", "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Benchmark_Asset_weight_BM", "original_measure_ref": "Daily Position[Benchmark_Asset_weight_BM]", "optimized_measure_ref": "Daily Position[Benchmark_Asset_weight_BM]", "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'Daily Position'[Benchmark_Asset_weight_BM] = --CALCULATE([Portfolio_weight_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =\"Benchmark\")\n\n            var Benchmark_Total =  CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),\n                                            ALLEXCEPT('Daily Position','Daily Position'[Position_Type])) \n                                       \n\n        Var Asset_level =    sum('Daily Position'[BENCHMARK_WEIGHT_EOD])\n \n\n        RETURN IFERROR( Asset_level/Benchmark_Total ,BLANK())\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'Daily Position'[Benchmark_Asset_weight_BM] = \n    \n    VAR _Asset_level = SUM('Daily Position'[BENCHMARK_WEIGHT_EOD])\n\n    // Optimize: Calculate Total Weight for the specific Benchmark on the specific Date only.\n    // We add Investment Object and Valuation Date to ALLEXCEPT to stop it from summing the whole history.\n    VAR _Benchmark_Total =  \n        CALCULATE(\n            SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]),\n            ALLEXCEPT(\n                'Daily Position',\n                'Daily Position'[Position_Type],\n                'Daily Position'[INVESTMENT OBJECT CODE],\n                'Daily Position'[Valuation Date]\n            )\n        )\n    \n    // Use DIVIDE for better performance and automatic divide-by-zero handling\n    RETURN \n        DIVIDE( _Asset_level, _Benchmark_Total )", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Portfolio_Asset_Matrix MV CR Intensity Switch_BM", "original_measure_ref": "ESG Trucost Climate[Portfolio_Asset_Matrix MV CR Intensity Switch_BM]", "optimized_measure_ref": "Portfolio_Asset_Matrix MV CR Intensity Switch_BM New", "original_time": "60s", "optimized_time": "0.4s", "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV CR Intensity Switch_BM] = CALCULATE( [Matrix MV CR Intensity Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV CR Intensity (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV CR Intensity (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])\n\nReturn Result\n\n\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2)_BM] = \n\nDIVIDE([Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM], SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM]))\n\n\n\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])\n\n Return Result    \nMEASURE 'ESG Trucost Climate'[Apportioned Revenue Sub_Sector_BM] = SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]), [Apportioned MV Revenue AUD mn_BM])\n\n              \n              \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Apportioned MV Revenue AUD mn_BM] = \n\nVar Benchmark = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = \"Benchmark\")\nVar Portfolio = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n\n\n", "optimized_dax": "Portfolio_Asset_Matrix MV CR Intensity Switch_BM New = \nVAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\nVAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1)  // 1=MC, 2=EVIC\n\n// 1) Ownership by Asset (ISIN), restricted to Portfolio positions\nVAR OwnershipByAsset =\n    CALCULATETABLE(\n        ADDCOLUMNS(\n            SUMMARIZE('Daily Position', 'GS Asset'[ISIN]),\n            \"@Ownership\",\n                IF(\n                    _MarketCapMode = 2,\n                    SUM('Daily Position'[Ownership_Factor_EVIC]),\n                    SUM('Daily Position'[Ownership_Factor_MC])\n                )\n        ),\n        KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n    )\n\n// 2) Carbon + Revenue by Asset (compute once per ISIN using VARs to avoid repeated SUMs)\nVAR CarbonRevByAsset =\n    ADDCOLUMNS(\n        VALUES('GS Asset'[ISIN]),\n        \"@Revenue\", \n            CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn])),\n        \"@Carbon\",\n            VAR _Base =\n                CALCULATE(\n                    SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) +\n                    SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])\n                )\n            VAR _Down =\n                CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))\n            VAR _Up   =\n                CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))\n            RETURN\n                SWITCH(\n                    _ScopeSelect,\n                    1, _Base,\n                    2, _Base + _Down,\n                    3, _Base + _Up,\n                    4, _Base + _Down + _Up,\n                    _Base\n                )\n    )\n\n// 3) Join once, then compute ratio of sums\nVAR Joined =\n    NATURALINNERJOIN(OwnershipByAsset, CarbonRevByAsset)\n\nVAR Numerator =\n    SUMX(\n        Joined,\n        VAR own = COALESCE([@Ownership], 0)\n        RETURN IF(own > 0, own * COALESCE([@Carbon], 0))\n    )\n\nVAR Denominator =\n    SUMX(\n        Joined,\n        VAR own = COALESCE([@Ownership], 0)\n        RETURN IF(own > 0, own * COALESCE([@Revenue], 0))\n    )\n\nRETURN\n    DIVIDE(Numerator, Denominator)", "helper1_dax": "Ownership_Factor_MC = \nVAR _MC = 'Daily Position'[Market_Cap_Base]\nVAR _Shares = RELATED('GS Asset'[SHARES_OUTSTANDING_QUANTITY])\nRETURN\n    IF( _MC > 0, \n        DIVIDE('Daily Position'[MARKET VALUE BASE], _MC),\n        // Fallback logic from original code:\n        IF('Daily Position'[MARKET VALUE BASE] > 0 && _Shares > 0, \n            DIVIDE('Daily Position'[QUANTITY], _Shares), \n            0\n        )\n    )", "helper2_dax": "Ownership_Factor_EVIC = \nVAR _EVIC = 'Daily Position'[EVIC_Base]\nVAR _Shares = RELATED('GS Asset'[SHARES_OUTSTANDING_QUANTITY])\nRETURN\n    IF( _EVIC > 0, \n        DIVIDE('Daily Position'[MARKET VALUE BASE], _EVIC),\n        IF('Daily Position'[MARKET VALUE BASE] > 0 && _Shares > 0, \n            DIVIDE('Daily Position'[QUANTITY], _Shares), \n            0\n        )\n    ", "single_measure_dax": null}
{"measure_name": "Portfolio_Asset_weight_BM", "original_measure_ref": "Daily Position[Portfolio_Asset_weight_BM]", "optimized_measure_ref": "Daily Position[Portfolio_Asset_weight_BM]", "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'Daily Position'[Portfolio_Asset_weight_BM] = --CALCULATE([Portfolio_weight_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =\"Portfolio\")\n\n\nVAR port_MV_base = [MARKET_VALUE_BASE_SUM]\nRETURN \n     DIVIDE( port_MV_base,  [Total Portfolio MV BASE],0)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[Total Portfolio MV BASE] = \nVAR Portfolio_MV_Base = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), \n                            ALLEXCEPT('Daily Position', \n                            'Fund Hierarchy'[SUBSECTOR],\n                            'Daily Position'[NT_Manager], \n                            'Daily Position'[Investment Object], \n                            'Daily Position'[Valuation Date]),\n                            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n                            )\n\nVAR Benchmark_MV_Base =  CALCULATE(CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), \n                            ALLEXCEPT('Daily Position', \n                            'Fund Hierarchy'[SUBSECTOR],\n                            'Daily Position'[NT_Manager], \n                            'Daily Position'[Investment Object], \n                            'Daily Position'[Valuation Date]),\n                            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n                            ),\n                            ALLSELECTED('Daily Position'[NT_Manager], 'Daily Position'[Investment Object]), 'Daily Position'[SK ASSET], \n                            ALLSELECTED('Fund Hierarchy'[SUBSECTOR])\n                            ) // Taking Portfolio_MV_Base and using that value for benchmarks\n                            \n                            // CROSSFILTER ( 'Daily Position'[SK ASSET], 'GS Asset'[SK_ASSET], None)) // Disabling filtering with Asset table so that Details table populates for benchmarks\n\nRETURN\nIF( SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\",\n    Portfolio_MV_Base,\n    Benchmark_MV_Base\n)\n\n//Total Portfolio MV BASE test = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), ALLSELECTED())\n\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'Daily Position'[Portfolio_Asset_weight_BM] = \n    DIVIDE([MARKET_VALUE_BASE_SUM], [Total Portfolio MV BASE], 0)", "helper1_dax": "MEASURE 'Daily Position'[Total Portfolio MV BASE] = \n    CALCULATE(\n        SUM('Daily Position'[MARKET VALUE BASE]),\n        // 1. Clear Asset Level Granularity\n        REMOVEFILTERS('GS Asset'),\n        REMOVEFILTERS('Daily Position'[SK ASSET]),\n        \n        // 2. Force Context to Portfolio (So we get the Portfolio Total, even on Benchmark rows)\n        'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\",\n        \n        // 3. Apply Investment Universe Filters (Hardcoded exclusions)\n        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n        NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\n            \"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \n            \"Money Market fund\", \"Recoverable Taxes\", \n            \"Rights Issue\", \"Variation Margin\"\n        })\n    )", "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Coverage Rate %_BM", "original_measure_ref": "ESG Trucost Climate[Coverage Rate %_BM]", "optimized_measure_ref": "ESG Trucost Climate[Coverage Rate %_BM_Optimized]", "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Coverage Rate %_BM] = DIVIDE([No. of Companies Analyzed_BM], [No. of Companies_BM],0)\nMEASURE 'ESG Trucost Climate'[No. of Companies Analyzed_BM] = \nVar Benchmark = CALCULATE (DISTINCTCOUNT ( 'Daily Position'[SK ASSET]),'Daily Position'[Trucost_Mapping_Status] = \"Match\",'Daily Position'[Position_Type]=\"Benchmark\")\nVar Portfolio = CALCULATE (DISTINCTCOUNT ( 'Daily Position'[SK ASSET]),'Daily Position'[Trucost_Mapping_Status] = \"Match\",'Daily Position'[Position_Type]=\"Portfolio\")\n\nRETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\n\nMEASURE 'ESG Trucost Climate'[No. of Companies_BM] = \nVar Benchmark = CALCULATE ( DISTINCTCOUNT ( 'GS Asset'[ASSET_ID] ), REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status] ),'Daily Position'[Position_Type] =\"Benchmark\")\nVar Portfolio = CALCULATE ( DISTINCTCOUNT ( 'GS Asset'[ASSET_ID] ), REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status] ),'Daily Position'[Position_Type] =\"Portfolio\")\n\n\nRETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Coverage Rate %_BM_Optimized] = \nVAR _SelectedPosition = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type])\n\n-- Determine the filter to apply ONCE\nVAR _TargetPositionType = IF(_SelectedPosition = \"Benchmark\", \"Benchmark\", \"Portfolio\")\n\n-- Numerator: Companies with \"Match\" status\nVAR _AnalyzedCount = \n    CALCULATE(\n        DISTINCTCOUNT('Daily Position'[SK ASSET]),\n        'Daily Position'[Trucost_Mapping_Status] = \"Match\",\n        'Daily Position'[Position_Type] = _TargetPositionType\n    )\n\n-- Denominator: All Companies (Ignoring Match status)\nVAR _TotalCount = \n    CALCULATE(\n        DISTINCTCOUNT('GS Asset'[ASSET_ID]),\n        REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status]),\n        'Daily Position'[Position_Type] = _TargetPositionType\n    )\n\nRETURN \n    DIVIDE(_AnalyzedCount, _TotalCount, 0)", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Matrix MV_BM", "original_measure_ref": "Daily Position[Matrix MV_BM]", "optimized_measure_ref": null, "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'Daily Position'[Matrix MV_BM] = [MARKET_VALUE_BASE_SUM] / 1000000\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\n---- MODEL MEASURES END ----\n", "optimized_dax": null, "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Matrix MV Apportioned Carbon Switch_BM", "original_measure_ref": "ESG Trucost Climate[Matrix MV Apportioned Carbon Switch_BM]", "optimized_measure_ref": "ESG Trucost Climate[Matrix MV Apportioned Carbon Switch_BM_Optimized]", "original_time": null, "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n             \n\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM_Optimized] = \nVAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\nVAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\nVAR _MarketCapSwitch = [Market_Cap_Switch]\n\n-- 1. PRE-CALCULATE GLOBAL CONSTANTS\n-- This avoids recalculating the total pot size 2000+ times\nVAR _GlobalBenchmarkMV = \n    IF( _IsBenchmark,\n        CALCULATE(\n            SUM('Daily Position'[MARKET VALUE BASE]),\n            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),\n            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n        ) / 1000000\n    )\n\nVAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = \"Portfolio\"))\n\n-- 2. SINGLE PASS ITERATION\nVAR Result = \n    SUMX(\n        'GS Asset',\n        \n        -- A. FETCH CARBON DATA (Based on Scope Selection)\n        VAR _CarbonValue = \n            SWITCH( _CurrentScope,\n                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),\n                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),\n                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n            )\n\n        -- Optimization: If Carbon is 0 or Blank, stop here. Don't waste time calculating ownership.\n        RETURN \n        IF( _CarbonValue = 0 || ISBLANK(_CarbonValue), \n            BLANK(),\n            \n            -- B. CALCULATE OWNERSHIP (Inline Logic)\n            VAR _OwnershipFactor = \n                IF( _IsBenchmark,\n                    -- BENCHMARK OWNERSHIP LOGIC\n                    VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))\n                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                    VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]))\n                    \n                    -- Denominator: Asset Level Market Cap (adjusted for EVIC switch)\n                    VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)\n                    \n                    -- Numerator: Implied Benchmark Value\n                    VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV\n                    VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)\n                    \n                    -- Fallback: Use GS Ownership (Quantity/Shares) if Bloomberg ownership fails\n                    VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))\n                    VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]\n                    \n                    RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, \n                               DIVIDE(_QuantitySum, _SharesOutstanding), \n                               _BBOwnership )\n                ,\n                    -- PORTFOLIO OWNERSHIP LOGIC\n                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                    \n                    -- Determine the specific Market Cap / EVIC denominator based on fund counts\n                    VAR _PortOwnershipRaw = \n                        SWITCH(TRUE(),\n                             _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,\n                             _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),\n                             _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,\n                             _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),\n                             0 \n                        )\n                    \n                     VAR _CalcOwnership = \n                        IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,\n                            CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),\n                            IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )\n                        )\n                     RETURN _CalcOwnership / 1000000000\n                )\n            \n            -- C. FINAL ROW CALCULATION\n            RETURN _OwnershipFactor * _CarbonValue\n        )\n    )\n\nRETURN Result", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Matrix MV WACI Switch_BM", "original_measure_ref": "ESG Trucost Climate[Matrix MV WACI Switch_BM]", "optimized_measure_ref": "ESG Trucost Climate[Matrix MV WACI Switch_BM_Optimized]", "original_time": "25s", "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Matrix MV WACI Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV WACI (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV WACI (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV WACI (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV WACI (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV WACI (Scope 1 & 2)_BM])\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Matrix MV WACI Switch_BM_Optimized] = \nVAR _PositionType = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type])\nVAR _Scope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\n\n-- 1. PRE-CALCULATE TOTAL MARKET VALUE (The Denominator for Weighting)\nVAR _TotalMarketValue = \n    IF( _PositionType = \"Benchmark\",\n        -- Benchmark: Apply specific filters (Collective Inv, Equity, exclude Cash/Futures)\n        CALCULATE(\n            SUM('Daily Position'[MARKET VALUE BASE]),\n            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),\n            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n        ),\n        -- Portfolio: Simple Sum\n        CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))\n    )\n\n-- 2. ITERATE AND CALCULATE (Asset MV * Carbon / Revenue)\nVAR _WeightedIntensitySum = \n    SUMX(\n        'GS Asset',\n        VAR _Revenue = CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn]))\n        \n        -- Optimization: If Revenue is 0 or Blank, WACI is undefined for this asset, skip it.\n        RETURN IF( _Revenue > 0,\n            VAR _AssetMV = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))\n            \n            -- Only proceed if Asset has Value\n            RETURN IF( _AssetMV > 0,\n                VAR _Carbon = \n                    SWITCH( _Scope,\n                        1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),\n                        2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),\n                        3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                        4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                        CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n                    )\n                \n                -- The Calculation: (AssetMV * Carbon) / Revenue\n                -- Note: We divide by TotalMV at the very end\n                RETURN DIVIDE(_AssetMV * _Carbon, _Revenue)\n            )\n        )\n    )\n\n-- 3. FINAL CALCULATION\nRETURN \n    DIVIDE(_WeightedIntensitySum, _TotalMarketValue)", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Position_Relative_Difference_Apportioned_Carbon", "original_measure_ref": "ESG Trucost Climate[Position_Relative_Difference_Apportioned_Carbon]", "optimized_measure_ref": "ESG Trucost Climate[Matrix MV Apportioned Carbon Total_Optimized]", "original_time": "25s", "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Position_Relative_Difference_Apportioned_Carbon] = \n --[Benchmark_Apportioned_Carbon_Matrix]- [Portfolio_Apportioned_Carbon_Matrix]\n\n    Var Benchmark = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =\"Benchmark\")\n    Var Portfolio = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =\"Portfolio\")\n\n    Var Benchmark_BM = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] ,\n                        'Benchmark Portfolio Mapping'[Position_Type] =\"Benchmark\" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object]) )\n\n    Return if(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                || ( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object]))\n                    , BLANK(), ( 1+ Portfolio ) / (1+ Benchmark) - 1)\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n             \n\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n\n//For Benchmark and portfolio top level aggregate sum of sub-sector levels     \n            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   \n\n    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         \n            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\n                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\"),\n               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Total_Optimized] = \nVAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\nVAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\nVAR _MarketCapSwitch = [Market_Cap_Switch]\n\n-- 1. PRE-CALCULATE CONSTANTS\n-- Calculate Total Benchmark Market Value once, not per row\nVAR _GlobalBenchmarkMV = \n    IF( _IsBenchmark,\n        CALCULATE(\n            SUM('Daily Position'[MARKET VALUE BASE]),\n            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),\n            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n        ) / 1000000\n    )\n\nVAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = \"Portfolio\"))\n\n-- 2. SINGLE EFFICIENT ITERATION\nVAR Result = \n    SUMX(\n        'GS Asset',\n        -- A. GET RAW CARBON (Based on Scope Selection)\n        VAR _RawCarbon = \n            SWITCH( _CurrentScope,\n                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),\n                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),\n                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))\n            )\n\n        -- Only proceed with Ownership calc if there is Carbon data (Optimization)\n        RETURN \n        IF( _RawCarbon = 0 || ISBLANK(_RawCarbon), \n            BLANK(),\n            \n            -- B. CALCULATE OWNERSHIP\n            VAR _OwnershipFactor = \n                IF( _IsBenchmark,\n                    -- Benchmark Ownership Logic\n                    VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))\n                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                    VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]))\n                    \n                    -- Denominator: Asset Level Market Cap\n                    VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)\n                    \n                    -- Numerator: Benchmark Ownership Value\n                    VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV\n                    \n                    VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)\n                    \n                    -- Fallback Check\n                    VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))\n                    VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]\n                    \n                    RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, \n                               DIVIDE(_QuantitySum, _SharesOutstanding), \n                               _BBOwnership )\n                ,\n                    -- Portfolio Ownership Logic\n                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                    \n                    VAR _PortOwnershipRaw = \n                        SWITCH(TRUE(),\n                             _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,\n                             _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),\n                             _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,\n                             _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),\n                             0 \n                        )\n                    \n                     VAR _CalcOwnership = \n                        IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,\n                            CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),\n                            IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )\n                        )\n                     RETURN _CalcOwnership / 1000000000\n                )\n            \n            RETURN _OwnershipFactor * _RawCarbon\n        )\n    )\n\nRETURN Result", "helper1_dax": "MEASURE 'ESG Trucost Climate'[Position_Relative_Difference_Apportioned_Carbon_Optimized] = \nVAR _IsBenchmarkSelection = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\nVAR _IsPortfolioInScope = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object])\n\n-- If specific conditions are met, return Blank (logic preserved from original)\nVAR _ShouldReturnBlank = _IsBenchmarkSelection || _IsPortfolioInScope\n\nRETURN\n    IF(\n        _ShouldReturnBlank,\n        BLANK(),\n        VAR _BenchmarkVal = CALCULATE([Matrix MV Apportioned Carbon Total_Optimized], 'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")\n        VAR _PortfolioVal = CALCULATE([Matrix MV Apportioned Carbon Total_Optimized], 'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n        \n        RETURN DIVIDE(1 + _PortfolioVal, 1 + _BenchmarkVal) - 1\n    )", "helper2_dax": null, "single_measure_dax": null}
{"measure_name": "Matrix MV CR Intensity Switch_BM", "original_measure_ref": "ESG Trucost Climate[Matrix MV CR Intensity Switch_BM]", "optimized_measure_ref": "ESG Trucost Climate[Matrix MV CR Intensity Switch_BM_Optimized]", "original_time": "94s", "optimized_time": null, "original_dax": "DEFINE \n---- MODEL MEASURES BEGIN ----\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM] = \n          \n            SWITCH  (TRUE()  , \n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV CR Intensity (Scope 1 & 2)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM],\n                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM],\n                    [Matrix MV CR Intensity (Scope 1 & 2)_BM])\n  \nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])\n\nReturn Result\n\n\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]\n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])\n\nReturn Result\nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2)_BM] = \n\nDIVIDE([Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM], SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM]))\n\n\n\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])\n\n Return Result    \nMEASURE 'ESG Trucost Climate'[Apportioned Revenue Sub_Sector_BM] = SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]), [Apportioned MV Revenue AUD mn_BM])\n\n              \n              \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM] = \n           \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nVAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM]\nVAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])\n\nRETURN\nDIVIDE(numerator, denominator)\nMEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM] = \n\n         //For Benchmark and portfolio top level aggregate sum of sub-sector levels\n            Var Result  = \n            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,\n                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),\n                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\n                         \n         \n         //Else part below -use normal aggregations\n              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])\n\n Return Result   \nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])\n        \nMEASURE 'ESG Trucost Climate'[Apportioned MV Revenue AUD mn_BM] = \n\nVar Benchmark = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = \"Benchmark\")\nVar Portfolio = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])\n            )\n        ) \nMEASURE 'Daily Position'[MV Ownership_BM] = \n\nVAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = \"Benchmark\")\n\nVAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)\n\nVAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),\n                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))\n\n\n--SUM('Daily Position'[MV_OWNERSHIP]) \nVAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]\n\n\n--VAR Ownership_bench_denom = asset_level_market_cap\n\nVAR Bloomberg_ownership = IF (\n    SELECTEDVALUE('Daily Position'[Position_Type] )= \"Portfolio\", // if position_type = portfolio\n    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark\n    )\n\nRETURN \nIF (\n    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), \n    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0\n    Bloomberg_ownership\n    ) \n\nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])\n            )\n        ) \nMEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = \n\nCALCULATE( [MV Ownership_BM]\n            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])\n            )\n        ) \nMEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table\n\nMEASURE 'Daily Position'[GS Ownership] = \nVAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)\n\nRETURN\nIF (\n    SELECTEDVALUE('Daily Position'[Position_Type]) = \"Portfolio\", \n    Ownership_port \n    )\n\n\nMEASURE 'Daily Position'[Market_Cap_BM] = \n        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n            SWITCH(TRUE,\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,\n\n                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" \n                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,\n\n                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Portfolio\" \n                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )\n                        \n            \nMEASURE 'Daily Position'[Market_Value_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),\n                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),\n                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"}))\n\n       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Benchmark\")                 \n\n        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark/1000000,Portfolio/1000000)\nMEASURE 'Daily Position'[Benchmark_Weight_BM] = \n        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = \n        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= \"Benchmark\" )\n        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = \"Portfolio\")\n\n        RETURN\n\n        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\" ,Benchmark,Portfolio)\nMEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table\nMEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table\n\nMEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)\nMEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =\"Portfolio\")\n---- MODEL MEASURES END ----\n", "optimized_dax": "MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM_Optimized] = \nVAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = \"Benchmark\"\nVAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)\n\n-- 1. PRE-CALCULATE GLOBAL CONSTANTS (Avoid doing this per row)\nVAR _GlobalBenchmarkMV = \n    IF( _IsBenchmark,\n        CALCULATE(\n            SUM('Daily Position'[MARKET VALUE BASE]),\n            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),\n            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {\"Collective Investment\", \"Equity\"},\n            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {\"Cash\", \"Equity Index Futures\", \"Fee Accruals\", \"Money Market fund\", \"Recoverable Taxes\", \"Rights Issue\", \"Variation Margin\"})\n        ) / 1000000\n    )\n\nVAR _MarketCapSwitch = [Market_Cap_Switch]\nVAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = \"Portfolio\"))\n\n-- 2. DEFINE THE ITERATION LOGIC\nVAR _Numerator = \n    SUMX(\n        'GS Asset', \n        -- A. Calculate Ownership for this specific Asset\n        VAR _AssetID = 'GS Asset'[SK ASSET]\n        VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n        VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n        VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]\n        VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))\n        \n        VAR _OwnershipFactor = \n            IF( _IsBenchmark,\n                -- Benchmark Ownership Logic\n                VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))\n                VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) -- Optimization: Ensure this isn't scanning full table unnecessarily\n                VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)\n                VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV\n                \n                VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)\n                \n                -- Fallback logic from original measure\n                RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, \n                           DIVIDE(_QuantitySum, _SharesOutstanding), -- Fallback to GS Ownership\n                           _BBOwnership )\n            ,\n                -- Portfolio Ownership Logic\n                VAR _PortOwnershipRaw = \n                    SWITCH(TRUE(),\n                         _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,\n                         _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),\n                         _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,\n                         _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),\n                         0 -- Default\n                    )\n                \n                 -- Logic derived from original measure \"MV Ownership_BM\" for Portfolio\n                 VAR _CalcOwnership = \n                    IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,\n                        CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),\n                        IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )\n                    )\n                 RETURN _CalcOwnership / 1000000000\n            )\n\n        -- B. Calculate Carbon based on Scope Selection\n        -- Using CALCULATE(SUM) to handle 1:Many relationship between Asset and ESG table\n        VAR _RawCarbon = \n            SWITCH( _CurrentScope,\n                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),\n                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),\n                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),\n                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])) -- Default Scope 1&2\n            )\n\n        RETURN _OwnershipFactor * _RawCarbon\n    )\n\nVAR _Denominator = \n    SUMX(\n        'GS Asset',\n        -- Recalculate Ownership Factor (or copy logic from above if variables not supported in your Power BI version across steps)\n        -- Ideally, use a separate measure for Ownership if you want to reuse code, but keeping it inline here for performance isolation.\n        VAR _OwnershipFactor_Rep = \n             IF( _IsBenchmark,\n                VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))\n                VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) \n                VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)\n                VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV\n                VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)\n                VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))\n                VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]\n\n                RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, \n                           DIVIDE(_QuantitySum, _SharesOutstanding), \n                           _BBOwnership )\n            ,\n                VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))\n                VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))\n                VAR _PortOwnershipRaw = \n                    SWITCH(TRUE(),\n                         _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,\n                         _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),\n                         _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,\n                         _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),\n                         0\n                    )\n                 VAR _CalcOwnership = \n                    IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,\n                        CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),\n                        IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )\n                    )\n                 RETURN _CalcOwnership / 1000000000\n            )\n\n        VAR _Revenue = CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn]))\n        \n        RETURN _OwnershipFactor_Rep * _Revenue\n    )\n\nRETURN \n    DIVIDE(_Numerator, _Denominator)", "helper1_dax": null, "helper2_dax": null, "single_measure_dax": null}
