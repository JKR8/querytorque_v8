measure_name,original_measure_ref,optimized_measure_ref,original_time,optimized_time,original_dax,optimized_dax,helper1_dax,helper2_dax,single_measure_dax
Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM,ESG Trucost Climate[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM],ESG Trucost Climate[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM],14s,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM] = CALCULATE( [Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = 

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
             

MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----
","DEFINE
    // ---------------------------------------------------------
    // OPTIMIZED MEASURE 1: PORTFOLIO SPECIFIC
    // ---------------------------------------------------------
    MEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV Apportioned Carbon Switch_BM] = 
        VAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)
        VAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1) // 1=MC, 2=EVIC

        // 1) Carbon Table (Calculated once per ISIN)
        VAR CarbonByAsset = 
            ADDCOLUMNS(
                VALUES('GS Asset'[ISIN]),
                ""@Carbon"",
                VAR _Base = CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))
                VAR _Down = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))
                VAR _Up   = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))
                RETURN
                    SWITCH( _ScopeSelect,
                        1, _Base,
                        2, _Base + _Down,
                        3, _Base + _Up,
                        4, _Base + _Down + _Up,
                        _Base
                    )
            )

        // 2) Portfolio Ownership Table (Filtered strictly for Portfolio)
        VAR OwnershipByAsset = 
            CALCULATETABLE(
                ADDCOLUMNS(
                    VALUES('GS Asset'[ISIN]),
                    ""@Ownership"",
                    VAR _MVSum      = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))
                    VAR _OwnSum     = CALCULATE(SUM('Daily Position'[MV_OWNERSHIP]))
                    VAR _FundCount  = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]))
                    
                    // Fallback GS Ownership
                    VAR _QtySum     = CALCULATE(SUM('Daily Position'[QUANTITY]))
                    VAR _SharesOut  = CALCULATE(SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]))
                    VAR _GSOwn      = DIVIDE(_QtySum, _SharesOut, 0)

                    // Market Cap Logic (Sum vs Max depending on Fund Count)
                    VAR _MC_Raw     = IF(_MarketCapMode = 2, CALCULATE(SUM('Daily Position'[EVIC_Base])), CALCULATE(SUM('Daily Position'[Market_Cap_Base])))
                    VAR _MC_Max     = IF(_MarketCapMode = 2, CALCULATE(MAX('Daily Position'[EVIC_Base])), CALCULATE(MAX('Daily Position'[Market_Cap_Base])))
                    VAR _FinalMC    = IF(_FundCount > 1, _MC_Max, _MC_Raw)
                    
                    // Derived Ownership Calculation
                    VAR _Derived    = IF(_FinalMC = 0, 0, (_MVSum / _FinalMC) * 1000000000)
                    
                    // Primary Logic
                    VAR _MainOwn    = DIVIDE( IF(_MarketCapMode = 1, _OwnSum, _Derived), 1000000000)

                    RETURN
                        IF( (ISBLANK(_MainOwn) || _MainOwn = 0) && _MVSum > 0, _GSOwn, _MainOwn )
                ),
                KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")
            )

        // 3) Join & Aggregation
        VAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)
        
        RETURN SUMX(Joined, [@Ownership] * [@Carbon])",,,"
// DAX Query
DEFINE
    VAR __DS0FilterTable =
        TREATAS({ DATE(2025, 1, 31) }, 'Benchmark Portfolio Mapping'[Valuation_Date])

    VAR __DS0FilterTable2 =
        TREATAS({ ""Listed Equities"" }, 'Benchmark Portfolio Mapping'[Sector])

    VAR __DS0FilterTable3 =
        TREATAS({ ""Y"" }, 'Benchmark Portfolio Mapping'[TAA_Benchmark])

    VAR __DS0FilterTable4 =
        TREATAS({ ""EVIC"" }, 'Market Cap Type'[Market_Cap_Name])

    VAR __DS0FilterTable5 =
        TREATAS({ ""Scope 1 + 2 + 3 Downstream+ 3 Upstream"" }, 'Scope Emission Types'[Scope_Type_Desc])

    VAR __DS0FilterTable6 =
        FILTER(
            KEEPFILTERS(VALUES('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE])),
            NOT(
                'GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE]
                    IN {
                        ""Cash"",
                        ""Equity Index Futures"",
                        ""Fee Accruals"",
                        ""Money Market Fund"",
                        ""Recoverable Taxes"",
                        ""Rights Issue"",
                        ""Variation Margin""
                    }
            )
        )

    VAR __DS0FilterTable7 =
        TREATAS({ ""Collective Investment"", ""Equity"" }, 'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE])

    VAR __DS0FilterTable8 =
        TREATAS(
            { (""LGIM"", ""LGIM DM ex US ex AU Index Plus"", ""FFB146"") },
            'Benchmark Portfolio Mapping'[Portfolio_Manager],
            'Benchmark Portfolio Mapping'[Portfolio_Name],
            'Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]
        )

    VAR __Core =
        SUMMARIZECOLUMNS(
            'GS Asset'[ISIN],
            __DS0FilterTable,
            __DS0FilterTable2,
            __DS0FilterTable3,
            __DS0FilterTable4,
            __DS0FilterTable5,
            __DS0FilterTable6,
            __DS0FilterTable7,
            __DS0FilterTable8,
            ""Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM"",
                'ESG Trucost Climate'[Portfolio_Asset_Matrix MV CR Intensity Switch_BM NEW]
        )

    VAR __Windowed =
        TOPN(
            501,
            __Core,
            [Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM], 0,   // 0 = DESC
            'GS Asset'[ISIN], 1                                       // 1 = ASC
        )

EVALUATE
    __Windowed

ORDER BY
    [Portfolio_Asset_Matrix_MV_CR_Intensity_Switch_BM] DESC,
    'GS Asset'[ISIN]"
Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM,ESG Trucost Climate[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM],ESG Trucost Climate[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM],9s,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM] = CALCULATE( [Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = 

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
             

MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Benchmark_Asset_Matrix MV Apportioned Carbon Switch_BM] = 
    VAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)
    VAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1) // 1=MC, 2=EVIC

    // ------------------------------------------------------------------
    // 1) Calculate Total Benchmark MV (SCALAR) - OUTSIDE THE LOOP
    // ------------------------------------------------------------------
    // This represents the Total AUM of the Benchmark for the selected Date.
    // We use ALLEXCEPT to remove asset-level filters but keep the Benchmark ID and Date.
    VAR _TotalBenchmarkMV_Raw = 
        CALCULATE(
            SUM('Daily Position'[MARKET VALUE BASE]),
            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),
            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
        )

    // ------------------------------------------------------------------
    // 2) Carbon Table (Calculated once per ISIN)
    // ------------------------------------------------------------------
    VAR CarbonByAsset = 
        ADDCOLUMNS(
            VALUES('GS Asset'[ISIN]),
            ""@Carbon"",
            VAR _Base = CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))
            VAR _Down = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))
            VAR _Up   = CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))
            RETURN
                SWITCH( _ScopeSelect,
                    1, _Base,
                    2, _Base + _Down,
                    3, _Base + _Up,
                    4, _Base + _Down + _Up,
                    _Base
                )
        )

    // ------------------------------------------------------------------
    // 3) Benchmark Ownership Table
    // ------------------------------------------------------------------
    VAR OwnershipByAsset = 
        CALCULATETABLE(
            ADDCOLUMNS(
                VALUES('GS Asset'[ISIN]),
                ""@Ownership"",
                // Gather inputs for Ownership Calc per Asset
                VAR _Weight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))
                
                // MC Calculation (Raw Sum, Switch handled here)
                VAR _MC_Raw = IF(_MarketCapMode = 2, CALCULATE(SUM('Daily Position'[EVIC_Base])), CALCULATE(SUM('Daily Position'[Market_Cap_Base])))
                
                // Denominator for MC (Replicating 'Accounts_owning_asset' logic)
                VAR _Count  = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) 
                VAR _MC_Avg = DIVIDE(_MC_Raw, _Count) 

                // Primary Calculation: 
                // Original Logic: ((Weight / 100) * (TotalBM_Millions)) / AssetMC_Millions
                // Simplified:     ((Weight / 100) * _TotalBenchmarkMV_Raw) / _MC_Avg
                VAR _AllocatedValue = (_Weight / 100) * _TotalBenchmarkMV_Raw
                VAR _BloombergOwn   = DIVIDE(_AllocatedValue, _MC_Avg, 0)

                // Fallback to GS Ownership if Bloomberg calc is 0/Blank but Benchmark has value
                VAR _QtySum     = CALCULATE(SUM('Daily Position'[QUANTITY]))
                VAR _SharesOut  = CALCULATE(SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]))
                VAR _GSOwn      = DIVIDE(_QtySum, _SharesOut, 0)

                RETURN
                    IF( (_BloombergOwn = 0 || ISBLANK(_BloombergOwn)) && _TotalBenchmarkMV_Raw > 0, 
                        _GSOwn, 
                        _BloombergOwn 
                    )
            ),
            KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark""),
            // Performance Optimization: Exclude rows with no weight/qty
            ('Daily Position'[BENCHMARK_WEIGHT_EOD] > 0 || 'Daily Position'[QUANTITY] <> 0)
        )

    // ------------------------------------------------------------------
    // 4) Join & Aggregation
    // ------------------------------------------------------------------
    VAR Joined = NATURALINNERJOIN(OwnershipByAsset, CarbonByAsset)
    
    RETURN SUMX(Joined, [@Ownership] * [@Carbon])",,,
Matrix MV_BM,Daily Position[Matrix MV_BM],Daily Position[Matrix MV_BM],,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'Daily Position'[Matrix MV_BM] = [MARKET_VALUE_BASE_SUM] / 1000000
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

---- MODEL MEASURES END ----
","MEASURE 'Daily Position'[Matrix MV_BM] = 
    DIVIDE([MARKET_VALUE_BASE_SUM], 1000000)","MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = 
    SUM('Daily Position'[MARKET VALUE BASE])",,
Benchmark_Asset_weight_BM,Daily Position[Benchmark_Asset_weight_BM],Daily Position[Benchmark_Asset_weight_BM],,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'Daily Position'[Benchmark_Asset_weight_BM] = --CALCULATE([Portfolio_weight_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =""Benchmark"")

            var Benchmark_Total =  CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),
                                            ALLEXCEPT('Daily Position','Daily Position'[Position_Type])) 
                                       

        Var Asset_level =    sum('Daily Position'[BENCHMARK_WEIGHT_EOD])
 

        RETURN IFERROR( Asset_level/Benchmark_Total ,BLANK())
---- MODEL MEASURES END ----
","MEASURE 'Daily Position'[Benchmark_Asset_weight_BM] = 
    
    VAR _Asset_level = SUM('Daily Position'[BENCHMARK_WEIGHT_EOD])

    // Optimize: Calculate Total Weight for the specific Benchmark on the specific Date only.
    // We add Investment Object and Valuation Date to ALLEXCEPT to stop it from summing the whole history.
    VAR _Benchmark_Total =  
        CALCULATE(
            SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]),
            ALLEXCEPT(
                'Daily Position',
                'Daily Position'[Position_Type],
                'Daily Position'[INVESTMENT OBJECT CODE],
                'Daily Position'[Valuation Date]
            )
        )
    
    // Use DIVIDE for better performance and automatic divide-by-zero handling
    RETURN 
        DIVIDE( _Asset_level, _Benchmark_Total )",,,
Portfolio_Asset_Matrix MV CR Intensity Switch_BM,ESG Trucost Climate[Portfolio_Asset_Matrix MV CR Intensity Switch_BM],Portfolio_Asset_Matrix MV CR Intensity Switch_BM New,60s,0.4s,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Portfolio_Asset_Matrix MV CR Intensity Switch_BM] = CALCULATE( [Matrix MV CR Intensity Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV CR Intensity (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV CR Intensity (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])

Return Result


MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2)_BM] = 

DIVIDE([Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM], SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM]))



MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])

 Return Result    
MEASURE 'ESG Trucost Climate'[Apportioned Revenue Sub_Sector_BM] = SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]), [Apportioned MV Revenue AUD mn_BM])

              
              
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Apportioned MV Revenue AUD mn_BM] = 

Var Benchmark = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = ""Benchmark"")
Var Portfolio = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----


","Portfolio_Asset_Matrix MV CR Intensity Switch_BM New = 
VAR _ScopeSelect   = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)
VAR _MarketCapMode = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code], 1)  // 1=MC, 2=EVIC

// 1) Ownership by Asset (ISIN), restricted to Portfolio positions
VAR OwnershipByAsset =
    CALCULATETABLE(
        ADDCOLUMNS(
            SUMMARIZE('Daily Position', 'GS Asset'[ISIN]),
            ""@Ownership"",
                IF(
                    _MarketCapMode = 2,
                    SUM('Daily Position'[Ownership_Factor_EVIC]),
                    SUM('Daily Position'[Ownership_Factor_MC])
                )
        ),
        KEEPFILTERS('Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")
    )

// 2) Carbon + Revenue by Asset (compute once per ISIN using VARs to avoid repeated SUMs)
VAR CarbonRevByAsset =
    ADDCOLUMNS(
        VALUES('GS Asset'[ISIN]),
        ""@Revenue"", 
            CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn])),
        ""@Carbon"",
            VAR _Base =
                CALCULATE(
                    SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) +
                    SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])
                )
            VAR _Down =
                CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]))
            VAR _Up   =
                CALCULATE(SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]))
            RETURN
                SWITCH(
                    _ScopeSelect,
                    1, _Base,
                    2, _Base + _Down,
                    3, _Base + _Up,
                    4, _Base + _Down + _Up,
                    _Base
                )
    )

// 3) Join once, then compute ratio of sums
VAR Joined =
    NATURALINNERJOIN(OwnershipByAsset, CarbonRevByAsset)

VAR Numerator =
    SUMX(
        Joined,
        VAR own = COALESCE([@Ownership], 0)
        RETURN IF(own > 0, own * COALESCE([@Carbon], 0))
    )

VAR Denominator =
    SUMX(
        Joined,
        VAR own = COALESCE([@Ownership], 0)
        RETURN IF(own > 0, own * COALESCE([@Revenue], 0))
    )

RETURN
    DIVIDE(Numerator, Denominator)","Ownership_Factor_MC = 
VAR _MC = 'Daily Position'[Market_Cap_Base]
VAR _Shares = RELATED('GS Asset'[SHARES_OUTSTANDING_QUANTITY])
RETURN
    IF( _MC > 0, 
        DIVIDE('Daily Position'[MARKET VALUE BASE], _MC),
        // Fallback logic from original code:
        IF('Daily Position'[MARKET VALUE BASE] > 0 && _Shares > 0, 
            DIVIDE('Daily Position'[QUANTITY], _Shares), 
            0
        )
    )","Ownership_Factor_EVIC = 
VAR _EVIC = 'Daily Position'[EVIC_Base]
VAR _Shares = RELATED('GS Asset'[SHARES_OUTSTANDING_QUANTITY])
RETURN
    IF( _EVIC > 0, 
        DIVIDE('Daily Position'[MARKET VALUE BASE], _EVIC),
        IF('Daily Position'[MARKET VALUE BASE] > 0 && _Shares > 0, 
            DIVIDE('Daily Position'[QUANTITY], _Shares), 
            0
        )
    ",
Portfolio_Asset_weight_BM,Daily Position[Portfolio_Asset_weight_BM],Daily Position[Portfolio_Asset_weight_BM],,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'Daily Position'[Portfolio_Asset_weight_BM] = --CALCULATE([Portfolio_weight_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =""Portfolio"")


VAR port_MV_base = [MARKET_VALUE_BASE_SUM]
RETURN 
     DIVIDE( port_MV_base,  [Total Portfolio MV BASE],0)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[Total Portfolio MV BASE] = 
VAR Portfolio_MV_Base = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), 
                            ALLEXCEPT('Daily Position', 
                            'Fund Hierarchy'[SUBSECTOR],
                            'Daily Position'[NT_Manager], 
                            'Daily Position'[Investment Object], 
                            'Daily Position'[Valuation Date]),
                            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
                            )

VAR Benchmark_MV_Base =  CALCULATE(CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), 
                            ALLEXCEPT('Daily Position', 
                            'Fund Hierarchy'[SUBSECTOR],
                            'Daily Position'[NT_Manager], 
                            'Daily Position'[Investment Object], 
                            'Daily Position'[Valuation Date]),
                            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
                            ),
                            ALLSELECTED('Daily Position'[NT_Manager], 'Daily Position'[Investment Object]), 'Daily Position'[SK ASSET], 
                            ALLSELECTED('Fund Hierarchy'[SUBSECTOR])
                            ) // Taking Portfolio_MV_Base and using that value for benchmarks
                            
                            // CROSSFILTER ( 'Daily Position'[SK ASSET], 'GS Asset'[SK_ASSET], None)) // Disabling filtering with Asset table so that Details table populates for benchmarks

RETURN
IF( SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"",
    Portfolio_MV_Base,
    Benchmark_MV_Base
)

//Total Portfolio MV BASE test = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]), ALLSELECTED())

---- MODEL MEASURES END ----
","MEASURE 'Daily Position'[Portfolio_Asset_weight_BM] = 
    DIVIDE([MARKET_VALUE_BASE_SUM], [Total Portfolio MV BASE], 0)","MEASURE 'Daily Position'[Total Portfolio MV BASE] = 
    CALCULATE(
        SUM('Daily Position'[MARKET VALUE BASE]),
        // 1. Clear Asset Level Granularity
        REMOVEFILTERS('GS Asset'),
        REMOVEFILTERS('Daily Position'[SK ASSET]),
        
        // 2. Force Context to Portfolio (So we get the Portfolio Total, even on Benchmark rows)
        'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"",
        
        // 3. Apply Investment Universe Filters (Hardcoded exclusions)
        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
        NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {
            ""Cash"", ""Equity Index Futures"", ""Fee Accruals"", 
            ""Money Market fund"", ""Recoverable Taxes"", 
            ""Rights Issue"", ""Variation Margin""
        })
    )",,
Coverage Rate %_BM,ESG Trucost Climate[Coverage Rate %_BM],ESG Trucost Climate[Coverage Rate %_BM_Optimized],,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Coverage Rate %_BM] = DIVIDE([No. of Companies Analyzed_BM], [No. of Companies_BM],0)
MEASURE 'ESG Trucost Climate'[No. of Companies Analyzed_BM] = 
Var Benchmark = CALCULATE (DISTINCTCOUNT ( 'Daily Position'[SK ASSET]),'Daily Position'[Trucost_Mapping_Status] = ""Match"",'Daily Position'[Position_Type]=""Benchmark"")
Var Portfolio = CALCULATE (DISTINCTCOUNT ( 'Daily Position'[SK ASSET]),'Daily Position'[Trucost_Mapping_Status] = ""Match"",'Daily Position'[Position_Type]=""Portfolio"")

RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)

MEASURE 'ESG Trucost Climate'[No. of Companies_BM] = 
Var Benchmark = CALCULATE ( DISTINCTCOUNT ( 'GS Asset'[ASSET_ID] ), REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status] ),'Daily Position'[Position_Type] =""Benchmark"")
Var Portfolio = CALCULATE ( DISTINCTCOUNT ( 'GS Asset'[ASSET_ID] ), REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status] ),'Daily Position'[Position_Type] =""Portfolio"")


RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Coverage Rate %_BM_Optimized] = 
VAR _SelectedPosition = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type])

-- Determine the filter to apply ONCE
VAR _TargetPositionType = IF(_SelectedPosition = ""Benchmark"", ""Benchmark"", ""Portfolio"")

-- Numerator: Companies with ""Match"" status
VAR _AnalyzedCount = 
    CALCULATE(
        DISTINCTCOUNT('Daily Position'[SK ASSET]),
        'Daily Position'[Trucost_Mapping_Status] = ""Match"",
        'Daily Position'[Position_Type] = _TargetPositionType
    )

-- Denominator: All Companies (Ignoring Match status)
VAR _TotalCount = 
    CALCULATE(
        DISTINCTCOUNT('GS Asset'[ASSET_ID]),
        REMOVEFILTERS('Daily Position'[Trucost_Mapping_Status]),
        'Daily Position'[Position_Type] = _TargetPositionType
    )

RETURN 
    DIVIDE(_AnalyzedCount, _TotalCount, 0)",,,
Matrix MV_BM,Daily Position[Matrix MV_BM],,,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'Daily Position'[Matrix MV_BM] = [MARKET_VALUE_BASE_SUM] / 1000000
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

---- MODEL MEASURES END ----
",,,,
Matrix MV Apportioned Carbon Switch_BM,ESG Trucost Climate[Matrix MV Apportioned Carbon Switch_BM],ESG Trucost Climate[Matrix MV Apportioned Carbon Switch_BM_Optimized],,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = 

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
             

MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM_Optimized] = 
VAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
VAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)
VAR _MarketCapSwitch = [Market_Cap_Switch]

-- 1. PRE-CALCULATE GLOBAL CONSTANTS
-- This avoids recalculating the total pot size 2000+ times
VAR _GlobalBenchmarkMV = 
    IF( _IsBenchmark,
        CALCULATE(
            SUM('Daily Position'[MARKET VALUE BASE]),
            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),
            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
        ) / 1000000
    )

VAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = ""Portfolio""))

-- 2. SINGLE PASS ITERATION
VAR Result = 
    SUMX(
        'GS Asset',
        
        -- A. FETCH CARBON DATA (Based on Scope Selection)
        VAR _CarbonValue = 
            SWITCH( _CurrentScope,
                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),
                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),
                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))
            )

        -- Optimization: If Carbon is 0 or Blank, stop here. Don't waste time calculating ownership.
        RETURN 
        IF( _CarbonValue = 0 || ISBLANK(_CarbonValue), 
            BLANK(),
            
            -- B. CALCULATE OWNERSHIP (Inline Logic)
            VAR _OwnershipFactor = 
                IF( _IsBenchmark,
                    -- BENCHMARK OWNERSHIP LOGIC
                    VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))
                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                    VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]))
                    
                    -- Denominator: Asset Level Market Cap (adjusted for EVIC switch)
                    VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)
                    
                    -- Numerator: Implied Benchmark Value
                    VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV
                    VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)
                    
                    -- Fallback: Use GS Ownership (Quantity/Shares) if Bloomberg ownership fails
                    VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))
                    VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]
                    
                    RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, 
                               DIVIDE(_QuantitySum, _SharesOutstanding), 
                               _BBOwnership )
                ,
                    -- PORTFOLIO OWNERSHIP LOGIC
                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                    
                    -- Determine the specific Market Cap / EVIC denominator based on fund counts
                    VAR _PortOwnershipRaw = 
                        SWITCH(TRUE(),
                             _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,
                             _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),
                             _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,
                             _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),
                             0 
                        )
                    
                     VAR _CalcOwnership = 
                        IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,
                            CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),
                            IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )
                        )
                     RETURN _CalcOwnership / 1000000000
                )
            
            -- C. FINAL ROW CALCULATION
            RETURN _OwnershipFactor * _CarbonValue
        )
    )

RETURN Result",,,
Matrix MV WACI Switch_BM,ESG Trucost Climate[Matrix MV WACI Switch_BM],ESG Trucost Climate[Matrix MV WACI Switch_BM_Optimized],25s,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Matrix MV WACI Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV WACI (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV WACI (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV WACI (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV WACI (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV WACI (Scope 1 & 2)_BM])
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Matrix MV WACI Switch_BM_Optimized] = 
VAR _PositionType = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type])
VAR _Scope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)

-- 1. PRE-CALCULATE TOTAL MARKET VALUE (The Denominator for Weighting)
VAR _TotalMarketValue = 
    IF( _PositionType = ""Benchmark"",
        -- Benchmark: Apply specific filters (Collective Inv, Equity, exclude Cash/Futures)
        CALCULATE(
            SUM('Daily Position'[MARKET VALUE BASE]),
            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),
            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
        ),
        -- Portfolio: Simple Sum
        CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))
    )

-- 2. ITERATE AND CALCULATE (Asset MV * Carbon / Revenue)
VAR _WeightedIntensitySum = 
    SUMX(
        'GS Asset',
        VAR _Revenue = CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn]))
        
        -- Optimization: If Revenue is 0 or Blank, WACI is undefined for this asset, skip it.
        RETURN IF( _Revenue > 0,
            VAR _AssetMV = CALCULATE(SUM('Daily Position'[MARKET VALUE BASE]))
            
            -- Only proceed if Asset has Value
            RETURN IF( _AssetMV > 0,
                VAR _Carbon = 
                    SWITCH( _Scope,
                        1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),
                        2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),
                        3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                        4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                        CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))
                    )
                
                -- The Calculation: (AssetMV * Carbon) / Revenue
                -- Note: We divide by TotalMV at the very end
                RETURN DIVIDE(_AssetMV * _Carbon, _Revenue)
            )
        )
    )

-- 3. FINAL CALCULATION
RETURN 
    DIVIDE(_WeightedIntensitySum, _TotalMarketValue)",,,
Position_Relative_Difference_Apportioned_Carbon,ESG Trucost Climate[Position_Relative_Difference_Apportioned_Carbon],ESG Trucost Climate[Matrix MV Apportioned Carbon Total_Optimized],25s,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Position_Relative_Difference_Apportioned_Carbon] = 
 --[Benchmark_Apportioned_Carbon_Matrix]- [Portfolio_Apportioned_Carbon_Matrix]

    Var Benchmark = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =""Benchmark"")
    Var Portfolio = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] , 'Benchmark Portfolio Mapping'[Position_Type] =""Portfolio"")

    Var Benchmark_BM = CALCULATE([Matrix MV Apportioned Carbon Switch_BM] ,
                        'Benchmark Portfolio Mapping'[Position_Type] =""Benchmark"" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object]) )

    Return if(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                || ( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object]))
                    , BLANK(), ( 1+ Portfolio ) / (1+ Benchmark) - 1)
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV Apportioned Carbon (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2)_BM] = 

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
             

MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 


//For Benchmark and portfolio top level aggregate sum of sub-sector levels     
            //For Benchmark and portfolio top level aggregate sum of sub-sector levels   

    //For Benchmark and portfolio top level aggregate sum of sub-sector levels         
            IF( OR(SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
                  ,SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio""),
               SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Portfolio_Inv_Obj_Code]),[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
         
         //Else part below -use normal aggregations
              ,[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Matrix MV Apportioned Carbon Total_Optimized] = 
VAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
VAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)
VAR _MarketCapSwitch = [Market_Cap_Switch]

-- 1. PRE-CALCULATE CONSTANTS
-- Calculate Total Benchmark Market Value once, not per row
VAR _GlobalBenchmarkMV = 
    IF( _IsBenchmark,
        CALCULATE(
            SUM('Daily Position'[MARKET VALUE BASE]),
            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),
            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
        ) / 1000000
    )

VAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = ""Portfolio""))

-- 2. SINGLE EFFICIENT ITERATION
VAR Result = 
    SUMX(
        'GS Asset',
        -- A. GET RAW CARBON (Based on Scope Selection)
        VAR _RawCarbon = 
            SWITCH( _CurrentScope,
                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),
                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),
                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]))
            )

        -- Only proceed with Ownership calc if there is Carbon data (Optimization)
        RETURN 
        IF( _RawCarbon = 0 || ISBLANK(_RawCarbon), 
            BLANK(),
            
            -- B. CALCULATE OWNERSHIP
            VAR _OwnershipFactor = 
                IF( _IsBenchmark,
                    -- Benchmark Ownership Logic
                    VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))
                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                    VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]))
                    
                    -- Denominator: Asset Level Market Cap
                    VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)
                    
                    -- Numerator: Benchmark Ownership Value
                    VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV
                    
                    VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)
                    
                    -- Fallback Check
                    VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))
                    VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]
                    
                    RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, 
                               DIVIDE(_QuantitySum, _SharesOutstanding), 
                               _BBOwnership )
                ,
                    -- Portfolio Ownership Logic
                    VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                    VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                    
                    VAR _PortOwnershipRaw = 
                        SWITCH(TRUE(),
                             _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,
                             _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),
                             _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,
                             _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),
                             0 
                        )
                    
                     VAR _CalcOwnership = 
                        IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,
                            CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),
                            IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )
                        )
                     RETURN _CalcOwnership / 1000000000
                )
            
            RETURN _OwnershipFactor * _RawCarbon
        )
    )

RETURN Result","MEASURE 'ESG Trucost Climate'[Position_Relative_Difference_Apportioned_Carbon_Optimized] = 
VAR _IsBenchmarkSelection = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
VAR _IsPortfolioInScope = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" && ISINSCOPE('Benchmark Portfolio Mapping'[Investment_Object])

-- If specific conditions are met, return Blank (logic preserved from original)
VAR _ShouldReturnBlank = _IsBenchmarkSelection || _IsPortfolioInScope

RETURN
    IF(
        _ShouldReturnBlank,
        BLANK(),
        VAR _BenchmarkVal = CALCULATE([Matrix MV Apportioned Carbon Total_Optimized], 'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")
        VAR _PortfolioVal = CALCULATE([Matrix MV Apportioned Carbon Total_Optimized], 'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")
        
        RETURN DIVIDE(1 + _PortfolioVal, 1 + _BenchmarkVal) - 1
    )",,
Matrix MV CR Intensity Switch_BM,ESG Trucost Climate[Matrix MV CR Intensity Switch_BM],ESG Trucost Climate[Matrix MV CR Intensity Switch_BM_Optimized],94s,,"DEFINE 
---- MODEL MEASURES BEGIN ----
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM] = 
          
            SWITCH  (TRUE()  , 
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  1 , [Matrix MV CR Intensity (Scope 1 & 2)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  2 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  3 , [Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM],
                    SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code]) =  4 , [Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM],
                    [Matrix MV CR Intensity (Scope 1 & 2)_BM])
  
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])

Return Result


MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3US)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM]/[Apportioned Revenue Sub_Sector_BM]
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])

Return Result
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2)_BM] = 

DIVIDE([Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM], SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM]))



MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2)_BM])

 Return Result    
MEASURE 'ESG Trucost Climate'[Apportioned Revenue Sub_Sector_BM] = SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]), [Apportioned MV Revenue AUD mn_BM])

              
              
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3US) Sub_Sector_BM] = 
           

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3US)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM] = 

VAR numerator = [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM]
VAR denominator = SUMX('GS Asset', [Apportioned MV Revenue AUD mn_BM])

RETURN
DIVIDE(numerator, denominator)
MEASURE 'ESG Trucost Climate'[Apportioned Carbon/CR (Scope 1 & 2 & 3DS & 3US) Sub_Sector_BM] = 

         //For Benchmark and portfolio top level aggregate sum of sub-sector levels
            Var Result  = 
            IF( SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,
                   SUMX(GROUPBY('Benchmark Portfolio Mapping','Benchmark Portfolio Mapping'[Sub_Sector]),
                                [Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
                         
         
         //Else part below -use normal aggregations
              ,[Aggregate MV CR Intensity (Scope 1 & 2 & 3DS & 3US)_BM])

 Return Result   
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2)_BM])
        
MEASURE 'ESG Trucost Climate'[Apportioned MV Revenue AUD mn_BM] = 

Var Benchmark = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = ""Benchmark"")
Var Portfolio = CALCULATE ( SUMX('ESG Trucost Climate', [MV Ownership_BM]*'ESG Trucost Climate'[Revenue_AUD_mn] ),'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM])
MEASURE 'ESG Trucost Climate'[Aggregate MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = SUMX('GS Asset',[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM])
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM])
            )
        ) 
MEASURE 'Daily Position'[MV Ownership_BM] = 

VAR Accounts_owning_asset = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET]), 'Daily Position'[Position_Type] = ""Benchmark"")

VAR asset_level_market_cap = DIVIDE([Market_Cap_BM], Accounts_owning_asset)

VAR Ownership_port = if (SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,  SUM('Daily Position'[MV_OWNERSHIP]),
                                        if ( [Market_Cap_BM] = BLANK() || [Market_Cap_BM] = 0 ,0,([MARKET_VALUE_BASE_SUM] / [Market_Cap_BM]) * 1000000000   ))


--SUM('Daily Position'[MV_OWNERSHIP]) 
VAR Ownership_bench_num = DIVIDE ([Benchmark_Weight_BM],100,0)*[Market_Value_BM]


--VAR Ownership_bench_denom = asset_level_market_cap

VAR Bloomberg_ownership = IF (
    SELECTEDVALUE('Daily Position'[Position_Type] )= ""Portfolio"", // if position_type = portfolio
    Ownership_port  / 1000000000  ,     DIVIDE( Ownership_bench_num, asset_level_market_cap,0) // else if position_type = benchmark
    )

RETURN 
IF (
    AND( Bloomberg_ownership = 0 || ISBLANK(Bloomberg_ownership), [Market_Value_BM] > 0), 
    [GS Ownership], // Taking GS ownership if bloomberg ownership is 0% AND MV is not 0
    Bloomberg_ownership
    ) 

MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM])
            )
        ) 
MEASURE 'ESG Trucost Climate'[MV Apportioned Carbon (Scope 1 & 2 & 3DS & 3US)_BM] = 

CALCULATE( [MV Ownership_BM]
            *(SUMX('ESG Trucost Climate', [Carbon_Scope_1_tonnes_CO2e_BM]+ [Carbon_Scope_2_tonnes_CO2e_BM] + [Carbon_Scope_3_tonnes_CO2e_Upstream_BM] + [Carbon_Scope_3_tonnes_CO2e_Downstream_BM])
            )
        ) 
MEASURE 'Daily Position'[Carbon_Scope_1_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[Carbon_Scope_2_tonnes_CO2e_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[MARKET_VALUE_BASE_SUM] = SUM('Daily Position'[MARKET VALUE BASE]) // Explicit measure to used in Excel Pivot Table

MEASURE 'Daily Position'[GS Ownership] = 
VAR Ownership_port = DIVIDE([QUANTITY_SUM], [SHARES_OUTSTANDING_SUM],0)

RETURN
IF (
    SELECTEDVALUE('Daily Position'[Position_Type]) = ""Portfolio"", 
    Ownership_port 
    )


MEASURE 'Daily Position'[Market_Cap_BM] = 
        Var MC_Benchmark = CALCULATE(sum('Daily Position'[Market_Cap_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var MC_Portfolio = CALCULATE(sum('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[Market_Cap_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        Var EVIC_MC_Benchmark = CALCULATE(sum('Daily Position'[EVIC_Base]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var EVIC_MC_Portfolio = CALCULATE(sum('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")
        Var EVIC_MC_Portfolio_MF = CALCULATE(MAX('Daily Position'[EVIC_Base]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

            SWITCH(TRUE,
                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] =1 , MC_Benchmark/1000000,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] = 1 ,MC_Portfolio,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch] = 1 && [Market_Cap_BM_Fund_Count] > 1 ,MC_Portfolio_MF,

                     SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" 
                        && [Market_Cap_Switch] = 2  , EVIC_MC_Benchmark/1000000,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] = 1, EVIC_MC_Portfolio,

                    SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Portfolio"" 
                        && [Market_Cap_Switch]= 2  && [Market_Cap_BM_Fund_Count] > 1, EVIC_MC_Portfolio_MF   )
                        
            
MEASURE 'Daily Position'[Market_Value_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),
                        ALLEXCEPT('Daily Position','Daily Position'[INVESTMENT OBJECT CODE],'Daily Position'[Valuation Date]),
                        'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
                         NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""}))

       -- Var Benchmark = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Benchmark"")                 

        Var Portfolio = CALCULATE(sum('Daily Position'[MARKET VALUE BASE]),'Benchmark Portfolio Mapping'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark/1000000,Portfolio/1000000)
MEASURE 'Daily Position'[Benchmark_Weight_BM] = 
        Var Benchmark = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('Daily Position'[BENCHMARK_WEIGHT_EOD]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Downstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'ESG Trucost Climate'[Carbon_Scope_3_tonnes_CO2e_Upstream_BM] = 
        Var Benchmark = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]),'Daily Position'[Position_Type]= ""Benchmark"" )
        Var Portfolio = CALCULATE(sum('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total]), 'Daily Position'[Position_Type] = ""Portfolio"")

        RETURN

        if (SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark"" ,Benchmark,Portfolio)
MEASURE 'Daily Position'[QUANTITY_SUM] = SUM('Daily Position'[QUANTITY]) // Explicit measure to be used in Excel Pivot Table
MEASURE 'GS Asset'[SHARES_OUTSTANDING_SUM] = SUM('GS Asset'[SHARES_OUTSTANDING_QUANTITY]) // Explicit measure to be used in Excel Pivot Table

MEASURE 'Market Cap Type'[Market_Cap_Switch] = SELECTEDVALUE('Market Cap Type'[Market_Cap_Code],1)
MEASURE 'Daily Position'[Market_Cap_BM_Fund_Count] = CALCULATE(DISTINCTCOUNT('Daily Position'[FUND] ),'Daily Position'[Position_Type] =""Portfolio"")
---- MODEL MEASURES END ----
","MEASURE 'ESG Trucost Climate'[Matrix MV CR Intensity Switch_BM_Optimized] = 
VAR _IsBenchmark = SELECTEDVALUE('Benchmark Portfolio Mapping'[Position_Type]) = ""Benchmark""
VAR _CurrentScope = SELECTEDVALUE('Scope Emission Types'[Scope_Type_Code], 1)

-- 1. PRE-CALCULATE GLOBAL CONSTANTS (Avoid doing this per row)
VAR _GlobalBenchmarkMV = 
    IF( _IsBenchmark,
        CALCULATE(
            SUM('Daily Position'[MARKET VALUE BASE]),
            ALLEXCEPT('Daily Position', 'Daily Position'[INVESTMENT OBJECT CODE], 'Daily Position'[Valuation Date]),
            'GS Asset'[CLIENT_INSTRUMENT_MAJOR_TYPE] IN {""Collective Investment"", ""Equity""},
            NOT('GS Asset'[CLIENT_INSTRUMENT_ISSUE_TYPE] IN {""Cash"", ""Equity Index Futures"", ""Fee Accruals"", ""Money Market fund"", ""Recoverable Taxes"", ""Rights Issue"", ""Variation Margin""})
        ) / 1000000
    )

VAR _MarketCapSwitch = [Market_Cap_Switch]
VAR _PortfolioFundCount = IF(NOT(_IsBenchmark), CALCULATE(DISTINCTCOUNT('Daily Position'[FUND]), 'Daily Position'[Position_Type] = ""Portfolio""))

-- 2. DEFINE THE ITERATION LOGIC
VAR _Numerator = 
    SUMX(
        'GS Asset', 
        -- A. Calculate Ownership for this specific Asset
        VAR _AssetID = 'GS Asset'[SK ASSET]
        VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
        VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
        VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]
        VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))
        
        VAR _OwnershipFactor = 
            IF( _IsBenchmark,
                -- Benchmark Ownership Logic
                VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))
                VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) -- Optimization: Ensure this isn't scanning full table unnecessarily
                VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)
                VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV
                
                VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)
                
                -- Fallback logic from original measure
                RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, 
                           DIVIDE(_QuantitySum, _SharesOutstanding), -- Fallback to GS Ownership
                           _BBOwnership )
            ,
                -- Portfolio Ownership Logic
                VAR _PortOwnershipRaw = 
                    SWITCH(TRUE(),
                         _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,
                         _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),
                         _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,
                         _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),
                         0 -- Default
                    )
                
                 -- Logic derived from original measure ""MV Ownership_BM"" for Portfolio
                 VAR _CalcOwnership = 
                    IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,
                        CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),
                        IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )
                    )
                 RETURN _CalcOwnership / 1000000000
            )

        -- B. Calculate Carbon based on Scope Selection
        -- Using CALCULATE(SUM) to handle 1:Many relationship between Asset and ESG table
        VAR _RawCarbon = 
            SWITCH( _CurrentScope,
                1, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])),
                2, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total])),
                3, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                4, CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Downstream_Total]) + SUM('ESG Trucost Climate'[Absolute_GHG_Scope_3_Upstream_Total])),
                CALCULATE(SUM('ESG Trucost Climate'[Carbon_Scope_1_tonnes_CO2e]) + SUM('ESG Trucost Climate'[Carbon_Scope_2_tonnes_CO2e])) -- Default Scope 1&2
            )

        RETURN _OwnershipFactor * _RawCarbon
    )

VAR _Denominator = 
    SUMX(
        'GS Asset',
        -- Recalculate Ownership Factor (or copy logic from above if variables not supported in your Power BI version across steps)
        -- Ideally, use a separate measure for Ownership if you want to reuse code, but keeping it inline here for performance isolation.
        VAR _OwnershipFactor_Rep = 
             IF( _IsBenchmark,
                VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                VAR _BenchWeight = CALCULATE(SUM('Daily Position'[BENCHMARK_WEIGHT_EOD]))
                VAR _AccountsOwning = CALCULATE(DISTINCTCOUNT('Daily Position'[SK ASSET])) 
                VAR _AssetLevelMC = DIVIDE(IF(_MarketCapSwitch=2, _EVICBase/1000000, _MarketCapBase/1000000), _AccountsOwning)
                VAR _BenchOwnershipNum = DIVIDE(_BenchWeight, 100) * _GlobalBenchmarkMV
                VAR _BBOwnership = DIVIDE(_BenchOwnershipNum, _AssetLevelMC)
                VAR _QuantitySum = CALCULATE(SUM('Daily Position'[QUANTITY]))
                VAR _SharesOutstanding = 'GS Asset'[SHARES_OUTSTANDING_QUANTITY]

                RETURN IF( (_BBOwnership = 0 || ISBLANK(_BBOwnership)) && _GlobalBenchmarkMV > 0, 
                           DIVIDE(_QuantitySum, _SharesOutstanding), 
                           _BBOwnership )
            ,
                VAR _MarketCapBase = CALCULATE(SUM('Daily Position'[Market_Cap_Base]))
                VAR _EVICBase = CALCULATE(SUM('Daily Position'[EVIC_Base]))
                VAR _PortOwnershipRaw = 
                    SWITCH(TRUE(),
                         _MarketCapSwitch = 1 && _PortfolioFundCount = 1, _MarketCapBase,
                         _MarketCapSwitch = 1 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[Market_Cap_Base])),
                         _MarketCapSwitch = 2 && _PortfolioFundCount = 1, _EVICBase,
                         _MarketCapSwitch = 2 && _PortfolioFundCount > 1, CALCULATE(MAX('Daily Position'[EVIC_Base])),
                         0
                    )
                 VAR _CalcOwnership = 
                    IF( SELECTEDVALUE('Market Cap Type'[Market_Cap_Code]) = 1,
                        CALCULATE(SUM('Daily Position'[MV_OWNERSHIP])),
                        IF( _PortOwnershipRaw = 0, 0, (CALCULATE(SUM('Daily Position'[MARKET VALUE BASE])) / _PortOwnershipRaw) * 1000000000 )
                    )
                 RETURN _CalcOwnership / 1000000000
            )

        VAR _Revenue = CALCULATE(SUM('ESG Trucost Climate'[Revenue_AUD_mn]))
        
        RETURN _OwnershipFactor_Rep * _Revenue
    )

RETURN 
    DIVIDE(_Numerator, _Denominator)",,,
