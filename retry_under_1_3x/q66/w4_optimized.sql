WITH filtered_dimensions AS (SELECT d_date_sk, d_moy FROM date_dim WHERE d_year = 2001), filtered_time AS (SELECT t_time_sk FROM time_dim WHERE t_time BETWEEN 30838 AND 30838 + 28800), filtered_ship_mode AS (SELECT sm_ship_mode_sk FROM ship_mode WHERE sm_carrier IN ('DHL', 'BARIAN')), unified_sales AS (SELECT 'web' AS sales_type, ws_warehouse_sk, ws_ext_sales_price, ws_quantity, ws_net_paid, ws_sold_date_sk, ws_sold_time_sk, ws_ship_mode_sk FROM web_sales UNION ALL SELECT 'catalog' AS sales_type, cs_warehouse_sk, cs_sales_price, cs_quantity, cs_net_paid_inc_tax, cs_sold_date_sk, cs_sold_time_sk, cs_ship_mode_sk FROM catalog_sales), joined_data AS (SELECT sales_type, w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, d_moy, CASE WHEN sales_type = 'web' THEN ws_ext_sales_price * ws_quantity ELSE cs_sales_price * cs_quantity END AS sales_amount, CASE WHEN sales_type = 'web' THEN ws_net_paid * ws_quantity ELSE cs_net_paid_inc_tax * cs_quantity END AS net_amount FROM unified_sales AS s JOIN filtered_dimensions AS d ON s.ws_sold_date_sk = d.d_date_sk OR s.cs_sold_date_sk = d.d_date_sk JOIN filtered_time AS t ON s.ws_sold_time_sk = t.t_time_sk OR s.cs_sold_time_sk = t.t_time_sk JOIN filtered_ship_mode AS sm ON s.ws_ship_mode_sk = sm.sm_ship_mode_sk OR s.cs_ship_mode_sk = sm.sm_ship_mode_sk JOIN warehouse AS w ON s.ws_warehouse_sk = w.w_warehouse_sk OR s.cs_warehouse_sk = w.w_warehouse_sk)
SELECT w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country, 'DHL,BARIAN' AS ship_carriers, 2001 AS year_, SUM(CASE WHEN d_moy = 1 THEN sales_amount ELSE 0 END) AS jan_sales, SUM(CASE WHEN d_moy = 2 THEN sales_amount ELSE 0 END) AS feb_sales, SUM(CASE WHEN d_moy = 3 THEN sales_amount ELSE 0 END) AS mar_sales, SUM(CASE WHEN d_moy = 4 THEN sales_amount ELSE 0 END) AS apr_sales, SUM(CASE WHEN d_moy = 5 THEN sales_amount ELSE 0 END) AS may_sales, SUM(CASE WHEN d_moy = 6 THEN sales_amount ELSE 0 END) AS jun_sales, SUM(CASE WHEN d_moy = 7 THEN sales_amount ELSE 0 END) AS jul_sales, SUM(CASE WHEN d_moy = 8 THEN sales_amount ELSE 0 END) AS aug_sales, SUM(CASE WHEN d_moy = 9 THEN sales_amount ELSE 0 END) AS sep_sales, SUM(CASE WHEN d_moy = 10 THEN sales_amount ELSE 0 END) AS oct_sales, SUM(CASE WHEN d_moy = 11 THEN sales_amount ELSE 0 END) AS nov_sales, SUM(CASE WHEN d_moy = 12 THEN sales_amount ELSE 0 END) AS dec_sales, SUM(CASE WHEN d_moy = 1 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS jan_sales_per_sq_foot, SUM(CASE WHEN d_moy = 2 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS feb_sales_per_sq_foot, SUM(CASE WHEN d_moy = 3 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS mar_sales_per_sq_foot, SUM(CASE WHEN d_moy = 4 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS apr_sales_per_sq_foot, SUM(CASE WHEN d_moy = 5 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS may_sales_per_sq_foot, SUM(CASE WHEN d_moy = 6 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS jun_sales_per_sq_foot, SUM(CASE WHEN d_moy = 7 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS jul_sales_per_sq_foot, SUM(CASE WHEN d_moy = 8 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS aug_sales_per_sq_foot, SUM(CASE WHEN d_moy = 9 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS sep_sales_per_sq_foot, SUM(CASE WHEN d_moy = 10 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS oct_sales_per_sq_foot, SUM(CASE WHEN d_moy = 11 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS nov_sales_per_sq_foot, SUM(CASE WHEN d_moy = 12 THEN sales_amount / w_warehouse_sq_ft ELSE 0 END) AS dec_sales_per_sq_foot, SUM(CASE WHEN d_moy = 1 THEN net_amount ELSE 0 END) AS jan_net, SUM(CASE WHEN d_moy = 2 THEN net_amount ELSE 0 END) AS feb_net, SUM(CASE WHEN d_moy = 3 THEN net_amount ELSE 0 END) AS mar_net, SUM(CASE WHEN d_moy = 4 THEN net_amount ELSE 0 END) AS apr_net, SUM(CASE WHEN d_moy = 5 THEN net_amount ELSE 0 END) AS may_net, SUM(CASE WHEN d_moy = 6 THEN net_amount ELSE 0 END) AS jun_net, SUM(CASE WHEN d_moy = 7 THEN net_amount ELSE 0 END) AS jul_net, SUM(CASE WHEN d_moy = 8 THEN net_amount ELSE 0 END) AS aug_net, SUM(CASE WHEN d_moy = 9 THEN net_amount ELSE 0 END) AS sep_net, SUM(CASE WHEN d_moy = 10 THEN net_amount ELSE 0 END) AS oct_net, SUM(CASE WHEN d_moy = 11 THEN net_amount ELSE 0 END) AS nov_net, SUM(CASE WHEN d_moy = 12 THEN net_amount ELSE 0 END) AS dec_net FROM joined_data GROUP BY w_warehouse_name, w_warehouse_sq_ft, w_city, w_county, w_state, w_country ORDER BY w_warehouse_name NULLS FIRST LIMIT 100