```json
{
  "rewrite_sets": [
    {
      "id": "rs_01",
      "transform": "date_cte_isolate",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1200 + 11",
        "warehouse_substr": "SELECT SUBSTRING(w_warehouse_name, 1, 20) AS w_substr, w_warehouse_sk FROM warehouse",
        "main_query": "SELECT ws.w_substr, sm.sm_type, web.web_name, SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk <= 30) THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 30) AND (ws_ship_date_sk - ws_sold_date_sk <= 60) THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 60) AND (ws_ship_date_sk - ws_sold_date_sk <= 90) THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 90) AND (ws_ship_date_sk - ws_sold_date_sk <= 120) THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN (ws_ship_date_sk - ws_sold_date_sk > 120) THEN 1 ELSE 0 END) AS \">120 days\" FROM (SELECT ws.*, ws.ws_ship_date_sk - ws.ws_sold_date_sk AS shipping_days FROM web_sales ws JOIN filtered_dates fd ON ws.ws_ship_date_sk = fd.d_date_sk) ws JOIN warehouse_substr ws_sub ON ws.ws_warehouse_sk = ws_sub.w_warehouse_sk JOIN ship_mode sm ON ws.ws_ship_mode_sk = sm.sm_ship_mode_sk JOIN web_site web ON ws.ws_web_site_sk = web.web_site_sk GROUP BY ws_sub.w_substr, sm.sm_type, web.web_name ORDER BY 1 NULLS FIRST, 2 NULLS FIRST, 3 NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same ordering",
        "same grouping grain"
      ],
      "expected_speedup": "4.50x",
      "risk": "low"
    },
    {
      "id": "rs_02",
      "transform": "pushdown",
      "nodes": {
        "filtered_dates": "SELECT d_date_sk FROM date_dim WHERE d_month_seq BETWEEN 1200 AND 1200 + 11",
        "warehouse_substr": "SELECT SUBSTRING(w_warehouse_name, 1, 20) AS w_substr, w_warehouse_sk FROM warehouse",
        "precomputed_shipping_days": "SELECT ws.ws_warehouse_sk, ws.ws_ship_mode_sk, ws.ws_web_site_sk, ws.ws_ship_date_sk, ws.ws_sold_date_sk, ws.ws_ship_date_sk - ws.ws_sold_date_sk AS shipping_days FROM web_sales ws JOIN filtered_dates fd ON ws.ws_ship_date_sk = fd.d_date_sk",
        "main_query": "SELECT ws_sub.w_substr, sm.sm_type, web.web_name, SUM(CASE WHEN psd.shipping_days <= 30 THEN 1 ELSE 0 END) AS \"30 days\", SUM(CASE WHEN psd.shipping_days > 30 AND psd.shipping_days <= 60 THEN 1 ELSE 0 END) AS \"31-60 days\", SUM(CASE WHEN psd.shipping_days > 60 AND psd.shipping_days <= 90 THEN 1 ELSE 0 END) AS \"61-90 days\", SUM(CASE WHEN psd.shipping_days > 90 AND psd.shipping_days <= 120 THEN 1 ELSE 0 END) AS \"91-120 days\", SUM(CASE WHEN psd.shipping_days > 120 THEN 1 ELSE 0 END) AS \">120 days\" FROM precomputed_shipping_days psd JOIN warehouse_substr ws_sub ON psd.ws_warehouse_sk = ws_sub.w_warehouse_sk JOIN ship_mode sm ON psd.ws_ship_mode_sk = sm.sm_ship_mode_sk JOIN web_site web ON psd.ws_web_site_sk = web.web_site_sk GROUP BY ws_sub.w_substr, sm.sm_type, web.web_name ORDER BY 1 NULLS FIRST, 2 NULLS FIRST, 3 NULLS FIRST LIMIT 100"
      },
      "invariants_kept": [
        "same result rows",
        "same output columns",
        "same grouping grain"
      ],
      "expected_speedup": "6.00x",
      "risk": "low"
    }
  ],
  "explanation": "Applied two complementary optimizations: (1) Date CTE isolation to filter date_dim early (from ~73k to 366 rows) before joining with web_sales, reducing the fact table scan from 86M to only matching rows. (2) Precomputed shipping days calculation in a separate CTE to avoid redundant date arithmetic in all CASE statements. The combination reduces the heavy sequential scan cost by applying date filters earliest in the pipeline."
}
```